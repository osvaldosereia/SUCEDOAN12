<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lançamento de Pedidos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
            padding-bottom: 100px; /* Espaço para o botão flutuante */
        }

        .tap-highlight-transparent {
            -webkit-tap-highlight-color: transparent;
        }

        /* Animação suave ao selecionar */
        .item-card {
            transition: all 0.2s ease-in-out;
        }
        
        .item-selected {
            border-left: 5px solid #16a34a; /* Green-600 */
            background-color: #f0fdf4; /* Green-50 */
        }

        /* Modal overlay */
        .modal {
            transition: opacity 0.25s ease;
        }
        body.modal-active {
            overflow: hidden;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Cabeçalho -->
    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-md mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center">
                <div class="bg-green-600 text-white p-2 rounded-lg mr-3">
                    <i class="fas fa-box-open"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-800">Meus Pedidos</h1>
                    <p class="text-xs text-gray-500">Selecione as cestas abaixo</p>
                </div>
            </div>
            <button onclick="resetCart()" class="text-gray-400 hover:text-red-500 text-sm">
                <i class="fas fa-trash-alt"></i> Limpar
            </button>
        </div>
    </header>

    <!-- Lista de Produtos -->
    <main class="max-w-md mx-auto p-4 space-y-6">
        
        <!-- Grupo Koblenz -->
        <div>
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1">Linha Koblenz</h2>
            <div id="list-koblenz" class="space-y-3"></div>
        </div>

        <!-- Grupo Alvino -->
        <div>
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1">Linha Alvino</h2>
            <div id="list-alvino" class="space-y-3"></div>
        </div>

        <!-- Outros -->
        <div>
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1">Outros</h2>
            <div id="list-outros" class="space-y-3"></div>
        </div>

    </main>

    <!-- Botão Flutuante WhatsApp -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-600">Total de volumes:</span>
                <span id="total-count" class="font-bold text-lg text-gray-800">0</span>
            </div>
            <button onclick="sendToWhatsapp()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-lg flex items-center justify-center transition tap-highlight-transparent active:scale-95">
                <i class="fab fa-whatsapp text-2xl mr-2"></i>
                Enviar Pedido
            </button>
        </div>
    </div>

    <!-- Modal de Observação -->
    <div id="note-modal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 opacity-0 pointer-events-none">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        
        <div class="modal-container bg-white w-11/12 max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto transform scale-95 transition-transform duration-200" id="modal-content">
            
            <div class="modal-content py-4 text-left px-6">
                <!--Title-->
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-lg font-bold text-gray-800" id="modal-title">Adicionar Observação</p>
                    <div class="modal-close cursor-pointer z-50" onclick="closeModal()">
                        <i class="fas fa-times text-gray-500"></i>
                    </div>
                </div>

                <!--Body-->
                <div class="my-5">
                    <p class="text-sm text-gray-500 mb-2">Detalhes para: <span id="modal-product-name" class="font-semibold text-gray-700"></span></p>
                    <textarea id="note-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 h-32 resize-none" placeholder="Ex: Entregar sem etiqueta, separar em duas caixas, etc..."></textarea>
                </div>

                <!--Footer-->
                <div class="flex justify-end pt-2">
                    <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 p-3 rounded-lg text-gray-600 hover:bg-gray-300 mr-2 font-medium">Cancelar</button>
                    <button onclick="saveNote()" class="px-4 py-2 bg-green-600 p-3 rounded-lg text-white hover:bg-green-700 font-medium">Salvar Nota</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Dados dos Produtos ---
        const productsData = [
            { id: 'gk', name: 'Cesta Grande Koblenz', category: 'koblenz' },
            { id: 'mk', name: 'Cesta Média Koblenz', category: 'koblenz' },
            { id: 'pk', name: 'Cesta Pequena Koblenz', category: 'koblenz' },
            { id: 'minik', name: 'Cesta Mini Koblenz', category: 'koblenz' },
            
            { id: 'ga', name: 'Cesta Grande Alvino', category: 'alvino' },
            { id: 'ma', name: 'Cesta Média Alvino', category: 'alvino' },
            { id: 'pa', name: 'Cesta Pequena Alvino', category: 'alvino' },
            { id: 'minia', name: 'Cesta Mini Alvino', category: 'alvino' },
            
            { id: 'eco', name: 'Cesta Econômica', category: 'outros' }
        ];

        // --- Estado da Aplicação ---
        let cart = {}; // { 'gk': { qty: 0, note: '' } }
        let currentEditingId = null;

        // --- Inicialização ---
        function init() {
            renderList('koblenz');
            renderList('alvino');
            renderList('outros');
        }

        // --- Renderização ---
        function renderList(category) {
            const container = document.getElementById(`list-${category}`);
            const items = productsData.filter(p => p.category === category);
            
            container.innerHTML = items.map(product => {
                const qty = cart[product.id]?.qty || 0;
                const note = cart[product.id]?.note || '';
                const isSelected = qty > 0;
                const noteBtnColor = note.trim().length > 0 ? 'text-yellow-600 bg-yellow-100' : 'text-gray-400 hover:text-gray-600';

                return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 item-card ${isSelected ? 'item-selected' : ''}" id="card-${product.id}">
                    <div class="flex items-center justify-between">
                        <div class="flex-1 cursor-pointer" onclick="toggleSelection('${product.id}')">
                            <h3 class="font-medium text-gray-800">${product.name}</h3>
                            ${note ? `<p class="text-xs text-gray-500 mt-1 truncate max-w-[200px]"><i class="fas fa-sticky-note text-yellow-500 mr-1"></i>${note}</p>` : ''}
                        </div>

                        ${!isSelected ? 
                            `<button onclick="increment('${product.id}')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center transition">
                                <i class="fas fa-plus text-sm"></i>
                            </button>` 
                            : 
                            `<div class="flex items-center space-x-2 animate-fade-in">
                                <button onclick="openNoteModal('${product.id}')" class="rounded-full w-8 h-8 flex items-center justify-center transition ${noteBtnColor}">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                                
                                <div class="flex items-center bg-gray-50 rounded-lg border border-gray-200">
                                    <button onclick="decrement('${product.id}')" class="w-9 h-9 flex items-center justify-center text-red-500 active:bg-gray-200 rounded-l-lg tap-highlight-transparent">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <span class="w-8 text-center font-bold text-gray-800">${qty}</span>
                                    <button onclick="increment('${product.id}')" class="w-9 h-9 flex items-center justify-center text-green-600 active:bg-gray-200 rounded-r-lg tap-highlight-transparent">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>`
                        }
                    </div>
                </div>
                `;
            }).join('');
            
            updateTotal();
        }

        // --- Lógica do Carrinho ---
        function toggleSelection(id) {
            if (!cart[id] || cart[id].qty === 0) {
                increment(id);
            }
        }

        function increment(id) {
            if (!cart[id]) cart[id] = { qty: 0, note: '' };
            cart[id].qty++;
            refreshProductCategory(id);
        }

        function decrement(id) {
            if (cart[id] && cart[id].qty > 0) {
                cart[id].qty--;
                if (cart[id].qty === 0 && cart[id].note === '') {
                    delete cart[id]; // Limpa se zerar e não tiver nota
                }
                refreshProductCategory(id);
            }
        }

        function refreshProductCategory(id) {
            const product = productsData.find(p => p.id === id);
            renderList(product.category);
        }

        function updateTotal() {
            let total = 0;
            for (let id in cart) {
                total += cart[id].qty;
            }
            document.getElementById('total-count').innerText = total;
        }

        function resetCart() {
            if(confirm("Deseja limpar todos os itens selecionados?")) {
                cart = {};
                init();
            }
        }

        // --- Lógica do Modal ---
        const modal = document.getElementById('note-modal');
        const modalContent = document.getElementById('modal-content');
        const noteInput = document.getElementById('note-input');
        const modalProductName = document.getElementById('modal-product-name');

        function openNoteModal(id) {
            currentEditingId = id;
            const product = productsData.find(p => p.id === id);
            
            modalProductName.innerText = product.name;
            noteInput.value = cart[id]?.note || '';
            
            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            
            // Pequena animação de entrada
            setTimeout(() => modalContent.classList.remove('scale-95'), 10);
            
            // Focar no final do texto
            noteInput.focus();
        }

        function closeModal() {
            modal.classList.add('opacity-0', 'pointer-events-none');
            document.body.classList.remove('modal-active');
            modalContent.classList.add('scale-95');
            currentEditingId = null;
        }

        function saveNote() {
            if (currentEditingId) {
                if (!cart[currentEditingId]) cart[currentEditingId] = { qty: 1, note: '' }; // Garante existência
                cart[currentEditingId].note = noteInput.value;
                refreshProductCategory(currentEditingId);
                closeModal();
            }
        }

        // --- Envio para WhatsApp ---
        function sendToWhatsapp() {
            const items = [];
            let totalQty = 0;

            // Percorre a ordem original para manter a lista organizada
            productsData.forEach(p => {
                if (cart[p.id] && cart[p.id].qty > 0) {
                    const item = cart[p.id];
                    let itemString = `*${item.qty}x* ${p.name}`;
                    if (item.note.trim()) {
                        itemString += `\n   _Obs: ${item.note.trim()}_`;
                    }
                    items.push(itemString);
                    totalQty += item.qty;
                }
            });

            if (items.length === 0) {
                alert("Selecione pelo menos um item para enviar.");
                return;
            }

            // Construção da mensagem
            const now = new Date();
            const dateStr = now.toLocaleDateString('pt-BR');
            const timeStr = now.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});

            const message = 
`*NOVO PEDIDO - ${dateStr} ${timeStr}*
--------------------------------
${items.join('\n\n')}
--------------------------------
*Total de Itens: ${totalQty}*`;

            const phoneNumber = "996884599";
            const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
            
            window.open(url, '_blank');
        }

        // Inicializar app
        init();

    </script>
</body>
</html>
