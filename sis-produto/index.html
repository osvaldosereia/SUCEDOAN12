<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V14 | Perfect Mirror</title>
    
    <style>
        /* --- CORE STYLES --- */
        :root { --bg: #f1f5f9; --surface: #ffffff; --border: #cbd5e1; --text: #0f172a; --primary: #2563eb; --success: #16a34a; --danger: #dc2626; --warning: #ca8a04; }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* LAYOUT */
        header { background: var(--surface); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h1 { font-size: 1.1rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        main { max-width: 1600px; margin: 20px auto; padding: 0 20px; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1200px) { main { grid-template-columns: 500px 1fr; align-items: start; } }

        /* CARDS & FORMS */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        .card-head { background: #f8fafc; padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; color: #64748b; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }

        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        label { display: block; font-size: 0.7rem; font-weight: 700; color: #64748b; margin-bottom: 3px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; background: #fff; transition: 0.15s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        input[readonly] { background: #f1f5f9; cursor: not-allowed; }
        textarea { resize: vertical; min-height: 60px; font-family: monospace; }

        .divider { margin: 15px 0 10px 0; border-bottom: 1px dashed var(--border); padding-bottom: 5px; color: var(--primary); font-size: 0.7rem; font-weight: 800; text-transform: uppercase; display: flex; align-items: center; justify-content: space-between; }

        /* BUTTONS */
        .btn { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; padding: 8px 12px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-radius: 4px; border: none; transition: 0.2s; }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: #64748b; }
        .btn-ghost:hover { background: #f8fafc; color: var(--text); border-color: #94a3b8; }
        .btn-danger { color: var(--danger); background: #fee2e2; }
        .btn-icon { width: 30px; height: 30px; padding: 0; }

        /* TABLE */
        .table-wrap { overflow-x: auto; max-height: 75vh; border-top: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; white-space: nowrap; }
        th { text-align: left; padding: 10px; background: #f8fafc; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; color: #64748b; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        tr:hover { background: #f8fafc; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; }
        .bg-gray { background: #e2e8f0; color: #475569; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }

        /* FEATURES */
        .combo-area { background: #eff6ff; padding: 10px; border: 1px dashed #bfdbfe; border-radius: 6px; margin-top: 5px; display: none; }
        .search-drop { position: absolute; background: white; width: 100%; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: none; }
        .search-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        .search-item:hover { background: #f1f5f9; color: var(--primary); }

        /* MODAL */
        dialog { margin: auto; border: none; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); width: 90%; max-width: 900px; padding: 0; }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-foot { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        
        .tree-node { border: 1px solid var(--border); margin-bottom: 5px; border-radius: 4px; overflow: hidden; background: #fff; }
        .tree-head { padding: 8px 10px; background: #f8fafc; display: flex; justify-content: space-between; align-items: center; }
        .tree-sub { padding: 5px 0 5px 20px; border-top: 1px solid var(--border); display: none; }
        .tree-sub.open { display: block; }
        .sub-item { display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px dashed #e2e8f0; font-size: 0.85rem; }
    </style>
</head>
<body>

<header>
    <h1>üì¶ PRO V14 <span style="font-size:0.7rem; font-weight:400; color:#64748b; margin-left:10px;">Perfect Mirror</span></h1>
    <div style="display:flex; gap:5px;">
        <button onclick="CatManager.open()" class="btn btn-ghost">Categorias</button>
        <button onclick="Importer.open()" class="btn btn-ghost">Importar</button>
        <button onclick="App.exportData()" class="btn btn-primary">Exportar JSON (Final)</button>
    </div>
</header>

<main>
    <section class="card">
        <div class="card-head">
            <span id="form-title">Novo Produto</span>
            <button onclick="App.resetForm()" class="btn btn-ghost btn-icon">‚Üª</button>
        </div>
        <div class="card-body">
            <form id="form-prod" onsubmit="App.save(event)">
                <input type="hidden" id="p-id">
                <input type="hidden" id="p-dataCadastro">
                
                <div class="row-3">
                    <div><label>C√≥digo Interno</label><input type="text" id="p-codigo" readonly placeholder="Auto (P001)" style="font-weight:700; color:var(--primary); background:#eff6ff;"></div>
                    <div style="grid-column: span 2"><label>EAN (C√≥digo de Barras)</label><input type="text" id="p-ean"></div>
                </div>

                <div style="margin-bottom:10px;"><label>Nome do Produto</label><input type="text" id="p-nome" required style="font-weight:700;"></div>

                <div class="row-2">
                    <div><label>Fornecedor</label><input type="text" id="p-fornecedor" list="dl-fornecedores"><datalist id="dl-fornecedores"></datalist></div>
                    <div><label>Categoria</label><select id="p-categoria"><option value="">Sem Categoria</option></select></div>
                </div>

                <div class="row-2">
                    <div><label>Unidade</label><input type="text" id="p-unidade" placeholder="UN, CX, KG"></div>
                    <div><label>Nome do Arquivo de Imagem</label><input type="text" id="p-imagem" placeholder="ex: arroz.jpg"></div>
                </div>

                <div style="margin-top:10px;"><label>Caracter√≠sticas (Markdown/Texto)</label><textarea id="p-caracteristicas" placeholder="* Marca: X&#10;* Peso: Y"></textarea></div>

                <div class="divider"><span>üí∞ Precifica√ß√£o</span></div>
                <div class="row-3">
                    <div><label>Custo (R$)</label><input type="number" id="p-custo" step="0.0001" oninput="App.calcMargin()"></div>
                    <div><label>Margem</label><input type="text" id="p-margem" readonly style="text-align:center;"></div>
                    <div><label style="color:var(--primary)">Venda (R$)</label><input type="number" id="p-valor" step="0.01" oninput="App.calcMargin()" required></div>
                </div>
                
                <div style="background:#fff7ed; border:1px solid #ffedd5; padding:8px; border-radius:4px; margin-top:8px; display:flex; align-items:center; gap:10px;">
                    <div style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="p-isOffer" style="width:auto;"><label for="p-isOffer" style="margin:0; color:var(--warning); cursor:pointer;">EM OFERTA</label></div>
                    <div style="flex:1"><input type="number" id="p-offerPrice" placeholder="Pre√ßo Oferta" step="0.01"></div>
                </div>

                <div class="divider"><span>üì¶ Estoque & Log√≠stica</span></div>
                <div class="row-2">
                    <div><label>Estoque F√≠sico</label><input type="number" id="p-estoque" required></div>
                    <div><label>Estoque Fiscal</label><input type="number" id="p-estoqueFiscal"></div>
                </div>
                <div class="row-3">
                    <div><label>Estoque M√≠n.</label><input type="number" id="p-limit"></div>
                    <div><label>Peso Bruto</label><input type="number" id="p-peso" step="0.001"></div>
                    <div><label>Fator Conv.</label><input type="number" id="p-fator" placeholder="Ex: 1"></div>
                </div>
                <div style="margin-top:8px; border:1px solid var(--border); padding:8px; border-radius:4px; background:#f8fafc;">
                    <label style="margin-bottom:5px;">Lotes (Validade | Qtd)</label>
                    <div id="batch-container"></div>
                </div>

                <div class="divider"><span>‚öñÔ∏è Fiscal & Detalhes</span></div>
                <div class="row-4">
                    <div><label>NCM</label><input type="text" id="p-ncm"></div>
                    <div><label>CEST</label><input type="text" id="p-cest"></div>
                    <div><label>CFOP</label><input type="text" id="p-cfop"></div>
                    <div><label>CSOSN</label><input type="text" id="p-csosn"></div>
                </div>
                <div class="row-2" style="margin-top:10px;">
                    <div><label>N¬∫ Nota Fiscal</label><input type="text" id="p-nota"></div>
                    <div><label>ID Refer√™ncia (NFe)</label><input type="text" id="p-refId"></div>
                </div>
                <div style="display:flex; gap:15px; margin-top:10px; align-items:center;">
                    <div style="display:flex;align-items:center;gap:5px;"><input type="checkbox" id="p-isBestSeller" style="width:auto;"><label for="p-isBestSeller" style="margin:0;cursor:pointer;">Mais Vendido?</label></div>
                </div>

                <div class="divider">
                    <span>üîó Kit / Combo</span>
                    <div style="display:flex;align-items:center;gap:5px;"><input type="checkbox" id="p-isCombo" style="width:auto;" onchange="ComboManager.toggle(this.checked)"><label for="p-isCombo" style="margin:0;cursor:pointer;">Ativar</label></div>
                </div>
                <div id="combo-area" class="combo-area">
                    <label>Colar Lista (1x Nome)</label>
                    <textarea id="combo-paste" style="height:60px;" placeholder="1x Arroz..."></textarea>
                    <button type="button" onclick="ComboManager.processPaste()" class="btn btn-primary btn-block" style="margin:5px 0;">Processar</button>
                    <div style="position:relative;">
                        <input type="text" id="combo-search" placeholder="Busca manual..." oninput="ComboManager.search(this.value)">
                        <div id="combo-res" class="search-drop"></div>
                    </div>
                    <div id="combo-list" style="margin-top:10px;"></div>
                </div>

                <div class="divider"><span>üîÄ Varia√ß√µes & V√≠nculos</span></div>
                <div class="row-2">
                    <div><label>EANs Extras ( | )</label><textarea id="p-variacoesEan" style="height:40px;"></textarea></div>
                    <div><label>Nomes Extras ( | )</label><textarea id="p-variacoesNome" style="height:40px;"></textarea></div>
                </div>
                <div class="row-2" style="align-items:end; margin-top:10px;">
                    <div style="position:relative;">
                        <label>Vincular a Pai (Busca)</label>
                        <input type="hidden" id="p-linkedId">
                        <input type="text" id="p-linkedName" placeholder="Buscar..." oninput="LinkedManager.search(this.value)">
                        <div id="linked-res" class="search-drop"></div>
                    </div>
                    <button type="button" onclick="LinkedManager.clear()" class="btn btn-ghost">Limpar</button>
                </div>

                <div style="margin-top:20px;">
                    <button type="submit" class="btn btn-primary btn-block" style="padding:12px; font-size:0.9rem;">üíæ SALVAR CADASTRO COMPLETO</button>
                </div>
            </form>
        </div>
    </section>

    <section class="card" style="height:fit-content; min-height:600px;">
        <div class="card-head">
            <span>Produtos (<span id="total-count">0</span>)</span>
        </div>
        <div style="padding:10px; background:#f1f5f9; display:grid; grid-template-columns:1fr 150px 150px 100px; gap:8px;">
            <input type="text" id="f-search" oninput="App.renderList()" placeholder="üîç Buscar...">
            <select id="f-cat" onchange="App.renderList()"><option value="">Categorias</option></select>
            <select id="f-forn" onchange="App.renderList()"><option value="">Fornecedores</option></select>
            <input type="number" id="f-stock" oninput="App.renderList()" placeholder="Estoque <">
        </div>
        <div class="table-wrap">
            <table>
                <thead><tr><th>C√≥d</th><th>Produto</th><th>Categ</th><th>Pre√ßo</th><th>Estoque</th><th style="text-align:right;">A√ß√µes</th></tr></thead>
                <tbody id="prod-list"></tbody>
            </table>
        </div>
    </section>
</main>

<dialog id="modal-cat">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;"><b>Categorias</b><button onclick="document.getElementById('modal-cat').close()" style="border:none;background:none;cursor:pointer;">‚úï</button></div>
    <div class="modal-body">
        <div style="display:flex;gap:5px;margin-bottom:10px;"><input type="text" id="new-cat-root" placeholder="Nova Principal"><button onclick="CatManager.addRoot()" class="btn btn-primary">Add</button></div>
        <div id="cat-tree"></div>
    </div>
</dialog>

<dialog id="modal-import">
    <div style="padding:15px; border-bottom:1px solid #ddd; display:flex; justify-content:space-between;"><b>Auditoria de Importa√ß√£o</b><button onclick="document.getElementById('modal-import').close()" style="border:none;background:none;cursor:pointer;">‚úï</button></div>
    <div class="modal-body">
        <div style="margin-bottom:10px;"><button onclick="Importer.toggleAll(true)" class="btn btn-ghost">Marcar Todos</button> <button onclick="Importer.toggleAll(false)" class="btn btn-ghost">Desmarcar Todos</button></div>
        <table style="width:100%; font-size:0.8rem;">
            <thead><tr><th style="width:30px;">#</th><th>C√≥d</th><th>Nome</th><th>Estoque</th><th>A√ß√£o</th></tr></thead>
            <tbody id="import-list"></tbody>
        </table>
    </div>
    <div class="modal-foot">
        <span id="import-stats" style="margin-right:auto;font-weight:bold;"></span>
        <button onclick="Importer.commit()" class="btn btn-success">Confirmar</button>
    </div>
</dialog>

<input type="file" id="file-input" accept=".json" style="display:none;" onchange="Importer.run(this)">

<script>
/**
 * SISTEMA V14 - ESPELHO PERFEITO & GAP FILLER
 */

const DB = {
    key: 'sys_v14_data',
    get: () => {
        const raw = localStorage.getItem(DB.key);
        const d = raw ? JSON.parse(raw) : { produto: [], categorias: [] };
        if(!Array.isArray(d.produto)) d.produto=[];
        if(!Array.isArray(d.categorias)) d.categorias=[];
        d.categorias.forEach(c => { if(!Array.isArray(c.subs)) c.subs=[]; });
        return d;
    },
    save: (d) => localStorage.setItem(DB.key, JSON.stringify(d)),
    
    // --- GAP FILLER ALGORITHM ---
    nextCode: () => {
        const db = DB.get();
        // Extrai n√∫meros: P001 -> 1, P020 -> 20
        const nums = db.produto.map(p => parseInt((p.codigo||'').replace(/\D/g,''))).filter(n => !isNaN(n)).sort((a,b)=>a-b);
        let next = 1;
        for(let n of nums) {
            if(n === next) next++;
            else if(n > next) break; // Achou buraco
        }
        return `P${String(next).padStart(3,'0')}`; // Formato P001
    }
};

const App = {
    init: () => {
        App.sanitize();
        App.renderBatches();
        CatManager.refresh();
        App.renderList();
    },

    sanitize: () => {
        const db = DB.get();
        let fix = false;
        db.produto.forEach(p => {
            if(!p.nome) { p.nome = "SEM NOME"; fix=true; }
            if(!p.codigo) { p.codigo = DB.nextCode(); fix=true; }
        });
        if(fix) DB.save(db);
    },

    save: (e) => {
        e.preventDefault();
        const db = DB.get();
        const id = document.getElementById('p-id').value;
        let codigo = document.getElementById('p-codigo').value;
        
        // Se novo, usa c√≥digo do gap filler. Se edi√ß√£o, mant√©m.
        if(!id && !codigo) codigo = DB.nextCode();

        let batches = [];
        for(let i=0; i<3; i++){
            let d = document.getElementById(`batch-d-${i}`).value;
            let q = Number(document.getElementById(`batch-q-${i}`).value);
            if(d && q > 0) batches.push({date: d, qty: q});
        }

        const rawImg = document.getElementById('p-imageName').value || document.getElementById('p-imagem').value;
        // Caminho padr√£o se n√£o come√ßar com ..
        const finalImg = (rawImg && !rawImg.startsWith('..')) ? `../site/img/produtos/${rawImg}` : rawImg;

        const prod = {
            id: id || Date.now().toString(),
            dataCadastro: document.getElementById('p-dataCadastro').value || new Date().toISOString(),
            ultimaAtualizacao: new Date().toISOString(),
            codigo: codigo,
            ean: (document.getElementById('p-ean').value || '').trim(),
            nome: (document.getElementById('p-nome').value || '').toUpperCase(),
            fornecedor: (document.getElementById('p-fornecedor').value || '').toUpperCase(),
            categoria: document.getElementById('p-categoria').value || '',
            unidade: document.getElementById('p-unidade').value || 'UN',
            imagem: finalImg,
            imageName: rawImg, // Mant√©m nome limpo tamb√©m
            caracteristicas: document.getElementById('p-caracteristicas').value,
            
            custo: Number(document.getElementById('p-custo').value)||0,
            valor: Number(document.getElementById('p-valor').value)||0,
            isOffer: document.getElementById('p-isOffer').checked,
            offerPrice: Number(document.getElementById('p-offerPrice').value)||0,
            isBestSeller: document.getElementById('p-isBestSeller').checked,
            
            estoque: Number(document.getElementById('p-estoque').value)||0,
            estoqueFiscal: Number(document.getElementById('p-estoqueFiscal').value)||0,
            limit: Number(document.getElementById('p-limit').value)||0,
            peso: Number(document.getElementById('p-peso').value)||0,
            fator: document.getElementById('p-fator').value,
            batches: batches,
            
            ncm: document.getElementById('p-ncm').value,
            cest: document.getElementById('p-cest').value,
            cfop: document.getElementById('p-cfop').value,
            csosn: document.getElementById('p-csosn').value,
            nota: document.getElementById('p-nota').value,
            refId: document.getElementById('p-refId').value,
            
            isCombo: document.getElementById('p-isCombo').checked,
            items: ComboManager.currentItems,
            
            variacoesEan: document.getElementById('p-variacoesEan').value.split('|').map(s=>s.trim()).filter(Boolean),
            variacoesNome: document.getElementById('p-variacoesNome').value.split('|').map(s=>s.trim()).filter(Boolean),
            linkedProdId: document.getElementById('p-linkedId').value,
            linkedProdCode: document.getElementById('p-linkedName').value,
            
            personalized: false // Default do JSON
        };

        if(id) {
            const idx = db.produto.findIndex(p => p.id === id);
            if(idx > -1) db.produto[idx] = prod;
        } else {
            db.produto.push(prod);
        }

        DB.save(db);
        App.resetForm();
        App.renderList();
        alert(`Produto salvo: ${prod.codigo}`);
    },

    edit: (id) => {
        const db = DB.get();
        const p = db.produto.find(x => x.id === id);
        if(!p) return;

        const set = (eid, val) => document.getElementById(eid).value = val || '';
        
        set('p-id', p.id);
        set('p-dataCadastro', p.dataCadastro);
        set('p-codigo', p.codigo);
        set('p-ean', p.ean);
        set('p-nome', p.nome);
        set('p-fornecedor', p.fornecedor);
        set('p-categoria', p.categoria);
        set('p-unidade', p.unidade);
        set('p-imagem', p.imagem);
        set('p-imageName', p.imageName); // Campo auxiliar
        set('p-caracteristicas', p.caracteristicas);
        
        set('p-custo', p.custo);
        set('p-valor', p.valor);
        set('p-offerPrice', p.offerPrice);
        
        set('p-estoque', p.estoque);
        set('p-estoqueFiscal', p.estoqueFiscal);
        set('p-limit', p.limit);
        set('p-peso', p.peso);
        set('p-fator', p.fator);
        
        set('p-ncm', p.ncm);
        set('p-cest', p.cest);
        set('p-cfop', p.cfop);
        set('p-csosn', p.csosn);
        set('p-nota', p.nota);
        set('p-refId', p.refId);
        
        set('p-variacoesEan', (p.variacoesEan||[]).join(' | '));
        set('p-variacoesNome', (p.variacoesNome||[]).join(' | '));
        set('p-linkedId', p.linkedProdId);
        set('p-linkedName', p.linkedProdCode);

        document.getElementById('p-isOffer').checked = !!p.isOffer;
        document.getElementById('p-isBestSeller').checked = !!p.isBestSeller;
        document.getElementById('p-isCombo').checked = !!p.isCombo;
        
        App.renderBatches(p.batches || []);
        ComboManager.currentItems = p.items || [];
        ComboManager.toggle(p.isCombo);
        App.calcMargin();
        window.scrollTo({top:0, behavior:'smooth'});
        document.getElementById('form-title').innerText = `Editando ${p.codigo}`;
    },

    delete: (id) => {
        if(!confirm('Excluir?')) return;
        const db = DB.get();
        db.produto = db.produto.filter(p => p.id !== id);
        DB.save(db);
        App.renderList();
    },

    resetForm: () => {
        document.getElementById('form-prod').reset();
        document.getElementById('p-id').value = '';
        document.getElementById('p-codigo').value = '';
        document.getElementById('p-margem').value = '';
        document.getElementById('form-title').innerText = 'Novo Produto';
        ComboManager.currentItems = [];
        ComboManager.toggle(false);
        App.renderBatches();
    },

    renderBatches: (list = []) => {
        let h = '';
        for(let i=0; i<3; i++) {
            let b = list[i] || {date:'', qty:''};
            h += `<div style="display:flex;gap:5px;margin-bottom:5px;"><input type="date" id="batch-d-${i}" value="${b.date}"><input type="number" id="batch-q-${i}" value="${b.qty}" placeholder="Qtd"></div>`;
        }
        document.getElementById('batch-container').innerHTML = h;
    },

    calcMargin: () => {
        const c = Number(document.getElementById('p-custo').value);
        const v = Number(document.getElementById('p-valor').value);
        const m = (c > 0 && v > 0) ? (((v-c)/c)*100).toFixed(1) + '%' : '-';
        const el = document.getElementById('p-margem');
        el.value = m;
        el.style.color = m.includes('-') ? 'black' : (parseFloat(m)<0 ? 'red' : 'green');
    },

    renderList: () => {
        const db = DB.get();
        // Filters
        const s = document.getElementById('f-search').value.toLowerCase();
        const c = document.getElementById('f-cat').value;
        const f = document.getElementById('f-forn').value;
        const st = document.getElementById('f-stock').value;

        // Populate selects
        const sForn = document.getElementById('f-forn');
        if(sForn.options.length<=1) {
            const listF = [...new Set(db.produto.map(p=>p.fornecedor).filter(Boolean))].sort();
            listF.forEach(x => {
                sForn.innerHTML += `<option value="${x}">${x}</option>`;
                document.getElementById('dl-fornecedores').innerHTML += `<option value="${x}">`;
            });
        }

        const list = db.produto.filter(p => {
            const txt = [p.nome, p.codigo, p.ean].join(' ').toLowerCase();
            if(s && !txt.includes(s)) return false;
            if(c && p.categoria !== c) return false;
            if(f && p.fornecedor !== f) return false;
            if(st && p.estoque > Number(st)) return false;
            return true;
        });

        document.getElementById('total-count').innerText = list.length;
        document.getElementById('prod-list').innerHTML = list.slice(0,50).map(p => `
            <tr>
                <td>${p.codigo}</td>
                <td><b>${p.nome}</b><br><small>${p.ean||''}</small></td>
                <td><span class="badge bg-gray">${p.categoria ? p.categoria.split('>').pop() : '-'}</span></td>
                <td>${p.isOffer ? `<b style="color:red">R$ ${p.offerPrice}</b>` : `R$ ${p.valor}`}</td>
                <td><span class="badge ${p.estoque<=0?'bg-red':'bg-green'}">${p.estoque}</span></td>
                <td style="text-align:right;">
                    <button onclick="App.edit('${p.id}')" class="btn btn-ghost btn-icon">‚úé</button>
                    <button onclick="App.delete('${p.id}')" class="btn btn-danger btn-icon">‚úï</button>
                </td>
            </tr>
        `).join('');
    },

    // --- EXPORTA√á√ÉO ID√äNTICA AO MODELO ---
    exportData: () => {
        const db = DB.get();
        
        // Mapeia para o formato EXATO solicitado
        const exportList = db.produto.map(p => {
            // Separa Categoria e Subcategoria
            let catRoot = "MERCEARIA E ALIMENTOS"; // Default ou l√≥gica
            let catSub = "";
            if(p.categoria) {
                const parts = p.categoria.split(' > ');
                if(parts.length > 0) catRoot = parts[0].trim();
                if(parts.length > 1) catSub = parts[1].trim();
            }

            return {
                id: p.id,
                codigo: p.codigo,
                nome: p.nome,
                ean: p.ean,
                categoria: p.categoria,
                fornecedor: p.fornecedor,
                caracteristicas: p.caracteristicas || "",
                custo: p.custo,
                valor: p.valor,
                batches: p.batches,
                estoque: p.estoque,
                estoqueFiscal: p.estoqueFiscal,
                peso: p.peso,
                limit: p.limit, // matches "limit"
                Limit: p.limit, // matches "Limit" (redund√¢ncia pedida)
                imagem: p.imagem,
                items: p.items,
                personalized: p.personalized || false,
                isOffer: p.isOffer,
                offerPrice: p.offerPrice,
                variacoesNome: p.variacoesNome,
                variacoesEan: p.variacoesEan,
                ncm: p.ncm,
                cest: p.cest,
                cfop: p.cfop,
                csosn: p.csosn,
                obs: p.obs || "",
                subcategoria: catSub, // Campo redundante pedido
                nota: p.nota || "",
                refId: p.refId || "",
                fator: p.fator || "1",
                unidade: p.unidade,
                isCombo: p.isCombo,
                isBestSeller: p.isBestSeller || false,
                
                // Campos redundantes / Traduzidos exigidos no JSON
                Oferta: p.isOffer ? "Sim" : "N√£o",
                Valor_Oferta: p.offerPrice,
                Categoria: catRoot,
                Subcategoria: catSub,
                Mais_Vendido: p.isBestSeller ? "Sim" : "N√£o",
                Tem_Ligacao: p.linkedProdId ? "Sim" : "N√£o",
                Codigo_Produto_Ligado: p.linkedProdCode || "",
                linkedProdId: p.linkedProdId || "",
                linkedProdCode: p.linkedProdCode || ""
            };
        });

        const now = new Date();
        const fname = `produtos_export_${now.getDate()}_${now.getMonth()+1}.json`;
        const blob = new Blob([JSON.stringify(exportList, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fname;
        a.click();
    }
};

/* --- IMPORTADOR --- */
const Importer = {
    staged: [],
    open: () => document.getElementById('file-input').click(),
    run: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // Normaliza entrada (pode ser lista direta ou obj {produto:[]})
                const raw = Array.isArray(json) ? json : (json.produto || []);
                if(!raw.length) throw new Error("JSON Vazio");
                
                Importer.staged = raw.map(x => ({
                    ...x,
                    // Garante mapeamento reverso na importa√ß√£o
                    nome: x.nome || x.xProd || x.description || "SEM NOME",
                    estoque: Number(x.estoque || x.Quantidade_Total_Unidades || 0),
                    selected: true
                }));
                
                Importer.render();
                document.getElementById('modal-import').showModal();
            } catch(err) { alert("Erro JSON: " + err.message); }
        };
        reader.readAsText(file);
        input.value = '';
    },
    render: () => {
        document.getElementById('import-list').innerHTML = Importer.staged.map((p,i) => `
            <tr>
                <td><input type="checkbox" ${p.selected?'checked':''} onclick="Importer.toggle(${i})"></td>
                <td>${p.codigo||'-'}</td>
                <td>${p.nome}</td>
                <td>${p.estoque}</td>
                <td>${p.id && DB.get().produto.find(x=>x.id==p.id)?'Atualizar':'Novo'}</td>
            </tr>
        `).join('');
        document.getElementById('import-stats').innerText = `${Importer.staged.filter(x=>x.selected).length} selecionados`;
    },
    toggle: (i) => { Importer.staged[i].selected = !Importer.staged[i].selected; Importer.render(); },
    toggleAll: (v) => { Importer.staged.forEach(x=>x.selected=v); Importer.render(); },
    commit: () => {
        const db = DB.get();
        const list = Importer.staged.filter(x=>x.selected);
        list.forEach(item => {
            const clean = { ...item };
            delete clean.selected;
            if(!clean.id) clean.id = Date.now() + Math.random().toString();
            // Se n√£o tem c√≥digo, gera. Se tem, respeita.
            if(!clean.codigo) clean.codigo = DB.nextCode(); 
            
            const idx = db.produto.findIndex(p => p.id === clean.id || (p.codigo && p.codigo === clean.codigo));
            if(idx > -1) db.produto[idx] = { ...db.produto[idx], ...clean };
            else db.produto.push(clean);
        });
        DB.save(db);
        document.getElementById('modal-import').close();
        App.init();
        alert('Importado com sucesso!');
    }
};

/* --- CATEGORIAS --- */
const CatManager = {
    open: () => { CatManager.render(); document.getElementById('modal-cat').showModal(); },
    refresh: () => {
        const db = DB.get();
        let h = '<option value="">Sem Categoria</option>';
        let f = '<option value="">Todas Categorias</option>';
        db.categorias.forEach(c => {
            h += `<option value="${c.nome}">${c.nome}</option>`;
            f += `<option value="${c.nome}">${c.nome}</option>`;
            (c.subs||[]).forEach(s => {
                h += `<option value="${c.nome} > ${s.nome}">&nbsp;&nbsp;‚Ü≥ ${s.nome}</option>`;
                f += `<option value="${c.nome} > ${s.nome}">&nbsp;&nbsp;‚Ü≥ ${s.nome}</option>`;
            });
        });
        const el = document.getElementById('p-categoria'); if(el) el.innerHTML = h;
        const el2 = document.getElementById('f-cat'); if(el2) el2.innerHTML = f;
    },
    addRoot: () => {
        const val = document.getElementById('new-cat-root').value.trim().toUpperCase();
        if(!val) return;
        const db = DB.get();
        if(!db.categorias.some(c=>c.nome===val)) { db.categorias.push({id:Date.now(), nome:val, subs:[]}); DB.save(db); }
        document.getElementById('new-cat-root').value=''; CatManager.refresh(); CatManager.render();
    },
    delete: (id, pid) => {
        if(!confirm('Apagar?')) return;
        const db = DB.get();
        if(pid) { const p = db.categorias.find(c=>c.id==pid); p.subs = p.subs.filter(s=>s.id!=id); }
        else { db.categorias = db.categorias.filter(c=>c.id!=id); }
        DB.save(db); CatManager.refresh(); CatManager.render();
    },
    render: () => {
        const db = DB.get();
        document.getElementById('cat-tree').innerHTML = db.categorias.map(c => `
            <div class="tree-node">
                <div class="tree-head"><b>${c.nome}</b><button onclick="CatManager.delete(${c.id})" style="color:red;border:none;">‚úï</button></div>
            </div>
        `).join('');
    }
};

/* --- COMBO & LINKED --- */
const ComboManager = {
    currentItems: [],
    toggle: (v) => { document.getElementById('combo-area').style.display = v ? 'block' : 'none'; if(v) ComboManager.render(); },
    search: (v) => {
        if(v.length<2) { document.getElementById('combo-res').style.display='none'; return; }
        const db = DB.get();
        const m = db.produto.filter(p=>p.nome.toLowerCase().includes(v.toLowerCase())).slice(0,5);
        document.getElementById('combo-res').innerHTML = m.map(p=>`<div class="search-item" onclick="ComboManager.add('${p.id}','${p.nome}')">${p.nome}</div>`).join('');
        document.getElementById('combo-res').style.display='block';
    },
    add: (id, nome, qtd=1) => {
        if(!ComboManager.currentItems.find(x=>x.id==id)) ComboManager.currentItems.push({id,nome,qty:qtd});
        ComboManager.render(); document.getElementById('combo-res').style.display='none'; document.getElementById('combo-search').value='';
    },
    remove: (i) => { ComboManager.currentItems.splice(i,1); ComboManager.render(); },
    processPaste: () => {
        const txt = document.getElementById('combo-paste').value;
        const db = DB.get();
        txt.split('\n').forEach(l => {
            const m = l.trim().match(/^(\d+)[xX]\s+(.+)$/);
            if(m) {
                const p = db.produto.find(x=>x.nome==m[2].trim().toUpperCase());
                if(p) ComboManager.add(p.id, p.nome, parseInt(m[1]));
            }
        });
        document.getElementById('combo-paste').value='';
    },
    render: () => {
        document.getElementById('combo-list').innerHTML = ComboManager.currentItems.map((x,i) => `
            <div style="background:#fff;padding:5px;margin-bottom:5px;display:flex;justify-content:space-between;">
                ${x.nome} (Qtd: ${x.qty}) <button onclick="ComboManager.remove(${i})" class="btn-danger btn-icon">x</button>
            </div>
        `).join('');
    }
};

const LinkedManager = {
    search: (v) => {
        if(v.length<2) { document.getElementById('linked-res').style.display='none'; return; }
        const m = DB.get().produto.filter(p=>p.nome.toLowerCase().includes(v.toLowerCase())).slice(0,5);
        document.getElementById('linked-res').innerHTML = m.map(p=>`<div class="search-item" onclick="LinkedManager.sel('${p.id}','${p.codigo}')">${p.nome}</div>`).join('');
        document.getElementById('linked-res').style.display='block';
    },
    sel: (id, cod) => { document.getElementById('p-linkedId').value=id; document.getElementById('p-linkedName').value=cod; document.getElementById('linked-res').style.display='none'; },
    clear: () => { document.getElementById('p-linkedId').value=''; document.getElementById('p-linkedName').value=''; }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
