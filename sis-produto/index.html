<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V9 | Auditoria de Importa√ß√£o</title>
    
    <style>
        /* --- 1. CORE STYLES --- */
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --radius: 6px;
            --font-sys: system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: var(--font-sys);
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.4;
            padding-bottom: 80px;
        }

        /* --- 2. LAYOUT --- */
        header {
            background: var(--surface);
            padding: 0.8rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        h1 { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 10px; color: var(--primary); }

        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1200px) {
            main { grid-template-columns: 450px 1fr; align-items: start; }
        }

        /* --- 3. COMPONENTS --- */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { background: #f1f5f9; padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }
        .card-body { padding: 15px; }

        /* Forms */
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .form-group { margin-bottom: 10px; }

        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 8px 10px; font-size: 0.9rem; border: 1px solid #cbd5e1; border-radius: var(--radius); background: #fff; transition: 0.15s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        input[readonly] { background: #f1f5f9; color: var(--text-muted); cursor: not-allowed; }
        textarea { resize: vertical; min-height: 60px; font-family: monospace; font-size: 0.8rem; }

        .section-divider {
            margin: 15px 0 10px 0;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 5px;
            color: var(--primary);
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 14px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-radius: var(--radius); border: none; cursor: pointer; transition: 0.2s; }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: #f8fafc; border-color: #cbd5e1; color: var(--text-main); }
        .btn-danger { color: var(--danger); background: transparent; border: 1px solid transparent; }
        .btn-danger:hover { background: #fef2f2; }
        .btn-icon { padding: 6px; width: 32px; height: 32px; }

        /* Table & Badges */
        .table-container { overflow-x: auto; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; white-space: nowrap; }
        th { text-align: left; padding: 10px; background: #f8fafc; color: var(--text-muted); border-bottom: 2px solid var(--border); font-weight: 700; position: sticky; top: 0; z-index: 10; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: #f1f5f9; }
        tr.selected { background: #eff6ff; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-gray { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }

        /* Specific Modules */
        .combo-box { background: #eff6ff; padding: 10px; border: 1px dashed #bfdbfe; border-radius: 6px; margin-top: 5px; display: none; }
        .search-results { position: absolute; background: white; width: 100%; max-height: 180px; overflow-y: auto; border: 1px solid var(--border); z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px; display: none; }
        .search-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        .search-item:hover { background: #f8fafc; color: var(--primary); }
        .paste-area { width: 100%; height: 100px; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px; font-family: monospace; font-size: 0.8rem; margin-bottom: 5px; }

        /* Modal */
        dialog { margin: auto; border: none; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 90%; max-width: 900px; padding: 0; }
        dialog::backdrop { background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px); }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        /* Category Tree */
        .tree-node { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 5px; overflow: hidden; background: white; }
        .tree-head { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; cursor: default; }
        .tree-subs { padding: 5px 0 5px 20px; border-top: 1px solid var(--border); display: none; }
        .tree-subs.open { display: block; }
        .sub-node { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px dashed #e2e8f0; font-size: 0.85rem; }

        /* Filters */
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; padding: 10px; background: #f1f5f9; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body>

<header>
    <h1>üìã CAT√ÅLOGO PRO V9</h1>
    <div style="display:flex; gap:8px;">
        <button onclick="CatManager.open()" class="btn btn-ghost">üìÇ Categorias</button>
        <button onclick="Importer.open()" class="btn btn-primary">üì• Importar (Auditoria)</button>
        <button onclick="App.exportData()" class="btn btn-ghost">üíæ Exportar</button>
    </div>
</header>

<main>
    <section class="card">
        <div class="card-header">
            <span id="form-title">Novo Produto</span>
            <button onclick="App.resetForm()" class="btn btn-ghost btn-icon" title="Limpar">‚Üª</button>
        </div>
        <div class="card-body">
            <form id="form-prod" onsubmit="App.save(event)">
                <input type="hidden" id="p-id">
                <input type="hidden" id="p-dataCadastro">
                
                <div class="form-grid-3">
                    <div><label>C√≥digo</label><input type="text" id="p-codigo" readonly placeholder="Auto" style="font-weight:700;"></div>
                    <div style="grid-column: span 2;"><label>EAN / GTIN</label><input type="text" id="p-ean"></div>
                </div>
                <div class="form-group"><label>Nome do Produto</label><input type="text" id="p-nome" required style="font-weight:600;"></div>
                
                <div class="form-grid-2">
                    <div><label>Fornecedor</label><input type="text" id="p-fornecedor" list="dl-fornecedores"><datalist id="dl-fornecedores"></datalist></div>
                    <div><label>Categoria</label><select id="p-categoria"><option value="">Sem Categoria</option></select></div>
                </div>
                
                <div class="form-grid-2">
                    <div><label>Unidade</label><input type="text" id="p-unidade" placeholder="UN, CX, KG"></div>
                    <div><label>Imagem</label><input type="text" id="p-imageName" placeholder="foto.jpg"></div>
                </div>

                <div class="section-divider"><span>üí∞ Custos & Pre√ßos</span></div>
                <div class="form-grid-3">
                    <div><label>Custo (R$)</label><input type="number" id="p-custo" step="0.01" oninput="App.calcMargin()"></div>
                    <div><label>Margem</label><input type="text" id="p-margem" readonly style="text-align:center;"></div>
                    <div><label style="color:var(--primary)">Venda (R$)</label><input type="number" id="p-valor" step="0.01" oninput="App.calcMargin()" required></div>
                </div>
                <div style="background:#fff7ed; padding:10px; border:1px solid #ffedd5; border-radius:6px; margin-top:8px; display:flex; gap:10px; align-items:center;">
                    <div style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="p-isOffer" style="width:auto;"><label for="p-isOffer" style="margin:0; color:var(--warning); cursor:pointer;">EM OFERTA</label></div>
                    <div style="flex:1"><input type="number" id="p-offerPrice" placeholder="Pre√ßo Promocional (R$)" step="0.01"></div>
                </div>

                <div class="section-divider"><span>üì¶ Log√≠stica</span></div>
                <div class="form-grid-2">
                    <div><label>Estoque F√≠sico</label><input type="number" id="p-estoque" required style="font-weight:700;"></div>
                    <div><label>Estoque Fiscal</label><input type="number" id="p-estoqueFiscal"></div>
                </div>
                <div class="form-grid-3">
                    <div><label>Min√≠mo</label><input type="number" id="p-limit"></div>
                    <div><label>Peso Bruto</label><input type="number" id="p-peso" step="0.001"></div>
                    <div><label>Peso L√≠q.</label><input type="number" id="p-pesoLiq" step="0.001"></div>
                </div>
                <div style="margin-top:10px; border:1px solid var(--border); padding:10px; border-radius:6px; background:#f8fafc;">
                    <label style="margin-bottom:5px;">Lotes (Validade | Quantidade)</label>
                    <div id="batch-container"></div>
                </div>

                <div class="section-divider"><span>‚öñÔ∏è Fiscal</span></div>
                <div class="form-grid-3">
                    <div><label>NCM</label><input type="text" id="p-ncm"></div>
                    <div><label>CEST</label><input type="text" id="p-cest"></div>
                    <div><label>CFOP</label><input type="text" id="p-cfop"></div>
                </div>

                <div class="section-divider">
                    <span>üîó Kit / Combo</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="p-isCombo" style="width:auto;" onchange="ComboManager.toggle(this.checked)">
                        <label for="p-isCombo" style="margin:0; cursor:pointer;">Ativar</label>
                    </div>
                </div>
                
                <div id="combo-area" class="combo-box">
                    <div style="margin-bottom:15px; border-bottom:1px dashed #bfdbfe; padding-bottom:10px;">
                        <label style="color:var(--primary);">üìã Colar Lista (1x Nome)</label>
                        <textarea id="combo-paste" class="paste-area" placeholder="Ex:&#10;1x Arroz 5kg"></textarea>
                        <button type="button" onclick="ComboManager.processPaste()" class="btn btn-primary btn-block">Processar Lista</button>
                    </div>
                    <div style="position:relative;">
                        <input type="text" id="combo-search" placeholder="Buscar manual..." oninput="ComboManager.search(this.value)">
                        <div id="combo-results" class="search-results"></div>
                    </div>
                    <div id="combo-list" style="margin-top:10px;"></div>
                </div>

                <div class="section-divider"><span>üîÄ Varia√ß√µes</span></div>
                <div class="form-group"><label>EANs Extras ( | )</label><textarea id="p-variacoesEan" style="height:40px;"></textarea></div>
                <div class="form-group"><label>Nomes Alternativos ( | )</label><textarea id="p-variacoesNome" style="height:40px;"></textarea></div>

                <div class="form-grid-2" style="align-items:end;">
                    <div style="position:relative;">
                        <label>Vincular a Produto Pai</label>
                        <input type="hidden" id="p-linkedId">
                        <input type="text" id="p-linkedName" placeholder="Buscar pai..." oninput="LinkedManager.search(this.value)">
                        <div id="linked-results" class="search-results"></div>
                    </div>
                    <button type="button" onclick="LinkedManager.clear()" class="btn btn-ghost">Desvincular</button>
                </div>

                <div style="margin-top:25px;">
                    <button type="submit" class="btn btn-primary btn-block" style="padding:12px;">üíæ SALVAR PRODUTO</button>
                </div>
            </form>
        </div>
    </section>

    <section class="card" style="height:fit-content; min-height:600px;">
        <div class="card-header">
            <span>Listagem Global</span>
            <span class="badge bg-gray" id="total-count">0 PRODUTOS</span>
        </div>
        <div class="filters">
            <input type="text" id="f-search" oninput="App.renderList()" placeholder="üîç Buscar...">
            <select id="f-cat" onchange="App.renderList()"><option value="">Todas Categorias</option></select>
            <select id="f-forn" onchange="App.renderList()"><option value="">Todos Fornecedores</option></select>
            <input type="number" id="f-stock" oninput="App.renderList()" placeholder="üìâ Estoque Teto">
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Produto / C√≥d.</th>
                        <th>Categoria</th>
                        <th>Pre√ßo</th>
                        <th>Estoque</th>
                        <th style="text-align:right;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="prod-list"></tbody>
            </table>
        </div>
    </section>
</main>

<dialog id="modal-cat">
    <div style="padding:15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; background:#f8fafc;">
        <span style="font-weight:700;">Gerenciar Categorias</span>
        <button onclick="document.getElementById('modal-cat').close()" class="btn btn-ghost btn-icon">‚úï</button>
    </div>
    <div class="modal-body">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="new-cat-root" placeholder="Nova Categoria Principal...">
            <button onclick="CatManager.addRoot()" class="btn btn-primary">Adicionar</button>
        </div>
        <div id="cat-tree"></div>
    </div>
</dialog>

<dialog id="modal-import-preview">
    <div style="padding:15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; background:#f8fafc;">
        <span style="font-weight:700; color:var(--primary);">üì• Auditoria de Importa√ß√£o</span>
        <button onclick="document.getElementById('modal-import-preview').close()" class="btn btn-ghost btn-icon">‚úï</button>
    </div>
    <div class="modal-body">
        <p style="margin-bottom:10px; font-size:0.9rem; color:var(--text-muted);">
            Verifique os produtos encontrados antes de confirmar. Use as caixas de sele√ß√£o.
        </p>
        <div style="margin-bottom:10px; display:flex; gap:10px;">
            <button onclick="Importer.toggleAll(true)" class="btn btn-ghost">Marcar Todos</button>
            <button onclick="Importer.toggleAll(false)" class="btn btn-ghost">Desmarcar Todos</button>
        </div>
        <table style="font-size:0.8rem;">
            <thead>
                <tr>
                    <th style="width:30px;">#</th>
                    <th>C√≥d.</th>
                    <th>Nome Detectado</th>
                    <th>Estoque</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="import-preview-list"></tbody>
        </table>
    </div>
    <div class="modal-footer">
        <span id="import-stats" style="margin-right:auto; font-size:0.8rem; font-weight:bold;"></span>
        <button onclick="document.getElementById('modal-import-preview').close()" class="btn btn-ghost">Cancelar</button>
        <button onclick="Importer.commit()" class="btn btn-success">‚úÖ Confirmar e Lan√ßar</button>
    </div>
</dialog>

<input type="file" id="file-input" accept=".json" style="display:none;" onchange="Importer.run(this)">

<script>
/**
 * SISTEMA V9 - AUDITORIA DE IMPORTA√á√ÉO
 */

const DB = {
    key: 'sys_master_v9',
    get: () => {
        const raw = localStorage.getItem(DB.key);
        const data = raw ? JSON.parse(raw) : { produto: [], categorias: [] };
        if(!Array.isArray(data.produto)) data.produto = [];
        if(!Array.isArray(data.categorias)) data.categorias = [];
        data.categorias.forEach(c => { if(!Array.isArray(c.subs)) c.subs = []; });
        return data;
    },
    save: (data) => localStorage.setItem(DB.key, JSON.stringify(data)),
    nextCode: () => {
        const db = DB.get();
        const max = db.produto.reduce((acc, p) => Math.max(acc, parseInt((p.codigo||'').replace(/\D/g,'')||0)), 0);
        return `P${String(max + 1).padStart(4, '0')}`;
    }
};

const App = {
    init: () => {
        // Inicializa√ß√£o robusta
        App.renderBatches();
        CatManager.refreshSelects();
        App.renderList();
        console.log("Sistema V9 Iniciado. Produtos carregados:", DB.get().produto.length);
    },

    save: (e) => {
        e.preventDefault();
        const db = DB.get();
        const id = document.getElementById('p-id').value;
        const now = new Date().toISOString();
        let codigo = document.getElementById('p-codigo').value || (id ? '' : DB.nextCode());

        let batches = [];
        for(let i=0; i<3; i++){
            let d = document.getElementById(`batch-d-${i}`).value;
            let q = Number(document.getElementById(`batch-q-${i}`).value);
            if(d && q > 0) batches.push({date: d, qty: q});
        }

        const prod = {
            id: id || Date.now().toString(),
            dataCadastro: document.getElementById('p-dataCadastro').value || now,
            ultimaAtualizacao: now,
            codigo,
            ean: document.getElementById('p-ean').value.trim(),
            nome: document.getElementById('p-nome').value.trim().toUpperCase(),
            fornecedor: document.getElementById('p-fornecedor').value.toUpperCase(),
            categoria: document.getElementById('p-categoria').value,
            unidade: document.getElementById('p-unidade').value,
            imageName: document.getElementById('p-imageName').value,
            custo: Number(document.getElementById('p-custo').value)||0,
            valor: Number(document.getElementById('p-valor').value)||0,
            isOffer: document.getElementById('p-isOffer').checked,
            offerPrice: Number(document.getElementById('p-offerPrice').value)||0,
            estoque: Number(document.getElementById('p-estoque').value)||0,
            estoqueFiscal: Number(document.getElementById('p-estoqueFiscal').value)||0,
            limit: Number(document.getElementById('p-limit').value)||0,
            peso: Number(document.getElementById('p-peso').value)||0,
            pesoLiq: Number(document.getElementById('p-pesoLiq').value)||0,
            batches,
            isCombo: document.getElementById('p-isCombo').checked,
            items: ComboManager.currentItems,
            variacoesEan: document.getElementById('p-variacoesEan').value.split('|').map(s=>s.trim()).filter(Boolean),
            variacoesNome: document.getElementById('p-variacoesNome').value.split('|').map(s=>s.trim()).filter(Boolean),
            linkedProdId: document.getElementById('p-linkedId').value,
            linkedProdCode: document.getElementById('p-linkedName').value,
            ncm: document.getElementById('p-ncm').value,
            cest: document.getElementById('p-cest').value,
            cfop: document.getElementById('p-cfop').value
        };

        if(id) {
            const idx = db.produto.findIndex(p => p.id === id);
            if(idx > -1) db.produto[idx] = prod;
        } else {
            db.produto.unshift(prod);
        }

        DB.save(db);
        App.resetForm();
        App.renderList();
        alert('Produto Salvo!');
    },

    edit: (id) => {
        const db = DB.get();
        const p = db.produto.find(x => x.id === id);
        if(!p) return;

        document.getElementById('p-id').value = p.id;
        document.getElementById('p-dataCadastro').value = p.dataCadastro || '';
        document.getElementById('p-codigo').value = p.codigo;
        document.getElementById('p-ean').value = p.ean || '';
        document.getElementById('p-nome').value = p.nome;
        document.getElementById('p-fornecedor').value = p.fornecedor || '';
        document.getElementById('p-categoria').value = p.categoria || '';
        document.getElementById('p-unidade').value = p.unidade || '';
        document.getElementById('p-imageName').value = p.imageName || '';
        document.getElementById('p-custo').value = p.custo;
        document.getElementById('p-valor').value = p.valor;
        document.getElementById('p-isOffer').checked = p.isOffer || false;
        document.getElementById('p-offerPrice').value = p.offerPrice || '';
        document.getElementById('p-estoque').value = p.estoque;
        document.getElementById('p-estoqueFiscal').value = p.estoqueFiscal || '';
        document.getElementById('p-limit').value = p.limit || '';
        document.getElementById('p-peso').value = p.peso || '';
        document.getElementById('p-pesoLiq').value = p.pesoLiq || '';
        document.getElementById('p-ncm').value = p.ncm || '';
        document.getElementById('p-cest').value = p.cest || '';
        document.getElementById('p-cfop').value = p.cfop || '';
        
        document.getElementById('p-variacoesEan').value = (p.variacoesEan || []).join(' | ');
        document.getElementById('p-variacoesNome').value = (p.variacoesNome || []).join(' | ');
        document.getElementById('p-linkedId').value = p.linkedProdId || '';
        document.getElementById('p-linkedName').value = p.linkedProdCode || '';

        App.renderBatches(p.batches || []);
        document.getElementById('p-isCombo').checked = p.isCombo || false;
        ComboManager.currentItems = p.items || [];
        ComboManager.toggle(p.isCombo || false);

        App.calcMargin();
        document.getElementById('form-title').innerText = `Editando: ${p.codigo}`;
        window.scrollTo({top: 0, behavior: 'smooth'});
    },

    delete: (id) => {
        if(!confirm('Excluir?')) return;
        const db = DB.get();
        db.produto = db.produto.filter(p => p.id !== id);
        DB.save(db);
        App.renderList();
    },

    resetForm: () => {
        document.getElementById('form-prod').reset();
        document.getElementById('p-id').value = '';
        document.getElementById('p-codigo').value = '';
        document.getElementById('p-margem').value = '';
        document.getElementById('form-title').innerText = 'Novo Produto';
        ComboManager.currentItems = [];
        ComboManager.toggle(false);
        App.renderBatches();
    },

    renderBatches: (existing = []) => {
        let html = '';
        for(let i=0; i<3; i++){
            let b = existing[i] || {date:'', qty:''};
            html += `<div style="display:flex; gap:5px; margin-bottom:4px;"><input type="date" id="batch-d-${i}" value="${b.date}" style="flex:2"><input type="number" id="batch-q-${i}" value="${b.qty}" placeholder="Qtd" style="flex:1"></div>`;
        }
        document.getElementById('batch-container').innerHTML = html;
    },

    calcMargin: () => {
        const c = Number(document.getElementById('p-custo').value);
        const v = Number(document.getElementById('p-valor').value);
        if(c>0 && v>0) {
            const m = ((v-c)/c)*100;
            const el = document.getElementById('p-margem');
            el.value = m.toFixed(1)+'%';
            el.style.color = m<0?'red':'green';
            el.style.fontWeight = 'bold';
        } else {
            document.getElementById('p-margem').value = '-';
        }
    },

    renderList: () => {
        const db = DB.get();
        const selForn = document.getElementById('f-forn');
        
        // Populate Suppliers if empty
        if(selForn.options.length === 1) {
            const forns = [...new Set(db.produto.map(p => p.fornecedor).filter(Boolean))].sort();
            forns.forEach(f => {
                selForn.innerHTML += `<option value="${f}">${f}</option>`;
                document.getElementById('dl-fornecedores').innerHTML += `<option value="${f}">`;
            });
        }

        const term = document.getElementById('f-search').value.toLowerCase();
        const cat = document.getElementById('f-cat').value;
        const forn = document.getElementById('f-forn').value;
        const stockTeto = document.getElementById('f-stock').value;

        let list = db.produto.filter(p => {
            const txt = [p.nome, p.codigo, p.ean].join(' ').toLowerCase();
            if(term && !txt.includes(term)) return false;
            if(cat && p.categoria !== cat) return false;
            if(forn && p.fornecedor !== forn) return false;
            if(stockTeto !== '' && p.estoque > Number(stockTeto)) return false;
            return true;
        });

        document.getElementById('total-count').innerText = `${list.length} PRODUTOS`;

        document.getElementById('prod-list').innerHTML = list.slice(0, 50).map(p => {
            const stockClass = p.estoque <= 0 ? 'bg-red' : (p.estoque <= (p.limit||5) ? 'bg-gray' : 'bg-green');
            return `
            <tr>
                <td>
                    <div style="font-weight:700;">${p.nome}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">${p.codigo} ${p.ean ? '| '+p.ean : ''}</div>
                </td>
                <td><span class="badge bg-gray">${p.categoria ? p.categoria.split('>').pop().trim() : '-'}</span></td>
                <td>${p.isOffer ? `<span style="color:red; font-weight:bold;">R$ ${p.offerPrice.toFixed(2)}</span>` : `R$ ${p.valor.toFixed(2)}`}</td>
                <td><span class="badge ${stockClass}">${p.estoque}</span></td>
                <td style="text-align:right;">
                    <button onclick="App.edit('${p.id}')" class="btn btn-ghost btn-icon">‚úé</button>
                    <button onclick="App.delete('${p.id}')" class="btn btn-danger btn-icon">‚úï</button>
                </td>
            </tr>`;
        }).join('');
    },

    exportData: () => {
        const db = DB.get();
        const now = new Date();
        const day = String(now.getDate()).padStart(2,'0');
        const month = String(now.getMonth()+1).padStart(2,'0');
        const fileName = `produtos-${day}-${month}-${now.getFullYear()}.json`;
        const blob = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
    }
};

/* --- M√ìDULOS DE IMPORTA√á√ÉO E AUDITORIA (V9) --- */
const Importer = {
    stagedProducts: [],
    stagedCats: [],
    
    open: () => document.getElementById('file-input').click(),
    
    run: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // NORMALIZA√á√ÉO DE DADOS
                let rawList = [];
                if(Array.isArray(json)) rawList = json;
                else if(json.produto) rawList = json.produto;
                else if(json.produtos) rawList = json.produtos;
                
                if(json.categorias) Importer.stagedCats = json.categorias;

                // PREPARA LISTA PARA AUDITORIA (Detecta campos comuns mesmo se chave mudar)
                Importer.stagedProducts = rawList.map(item => {
                    const nome = item.nome || item.xProd || item.description || "SEM NOME DETECTADO";
                    const estoque = item.estoque || item.qCom || item.quantity || 0;
                    return {
                        ...item,
                        _tempName: nome,
                        _tempStock: estoque,
                        _selected: true // Padr√£o: marcado
                    };
                });

                Importer.renderPreview();
                document.getElementById('modal-import-preview').showModal();

            } catch(err) { alert("Erro ao ler JSON: " + err.message); }
        };
        reader.readAsText(file);
        input.value = '';
    },

    renderPreview: () => {
        const tbody = document.getElementById('import-preview-list');
        const db = DB.get();
        
        tbody.innerHTML = Importer.stagedProducts.map((p, idx) => {
            const exists = db.produto.some(ex => ex.id === p.id || (ex.codigo && ex.codigo === p.codigo));
            const status = exists 
                ? '<span class="badge bg-gray">Atualizar</span>' 
                : '<span class="badge bg-green">Novo</span>';
            
            return `
            <tr class="${p._selected ? 'selected' : ''}" onclick="Importer.toggle(${idx})">
                <td><input type="checkbox" ${p._selected ? 'checked' : ''} onclick="event.stopPropagation(); Importer.toggle(${idx})"></td>
                <td>${p.codigo || '-'}</td>
                <td>${p._tempName}</td>
                <td>${p._tempStock}</td>
                <td>${status}</td>
            </tr>`;
        }).join('');

        const selectedCount = Importer.stagedProducts.filter(p => p._selected).length;
        document.getElementById('import-stats').innerText = `${selectedCount} produtos selecionados de ${Importer.stagedProducts.length}.`;
    },

    toggle: (idx) => {
        Importer.stagedProducts[idx]._selected = !Importer.stagedProducts[idx]._selected;
        Importer.renderPreview();
    },

    toggleAll: (val) => {
        Importer.stagedProducts.forEach(p => p._selected = val);
        Importer.renderPreview();
    },

    commit: () => {
        const toImport = Importer.stagedProducts.filter(p => p._selected);
        if(toImport.length === 0) return alert("Nenhum item selecionado.");

        const db = DB.get();
        let added = 0, updated = 0;

        toImport.forEach(raw => {
            // Garante campos m√≠nimos usando a normaliza√ß√£o feita na leitura
            const cleanProd = {
                ...raw,
                nome: raw.nome || raw._tempName,
                estoque: Number(raw.estoque || raw._tempStock),
                id: raw.id || Date.now() + Math.random().toString()
            };
            
            // Remove as chaves tempor√°rias
            delete cleanProd._tempName;
            delete cleanProd._tempStock;
            delete cleanProd._selected;

            const idx = db.produto.findIndex(ex => ex.id === cleanProd.id || (ex.codigo && ex.codigo === cleanProd.codigo));
            
            if(idx > -1) {
                db.produto[idx] = { ...db.produto[idx], ...cleanProd };
                updated++;
            } else {
                db.produto.push(cleanProd);
                added++;
            }
        });

        // Importa Categorias se existirem
        let catsAdded = 0;
        Importer.stagedCats.forEach(c => {
            if(!db.categorias.some(ex => ex.id === c.id || ex.nome === c.nome)) {
                db.categorias.push(c);
                catsAdded++;
            }
        });

        DB.save(db);
        document.getElementById('modal-import-preview').close();
        App.renderList(); // Atualiza a lista principal IMEDIATAMENTE
        CatManager.refreshSelects();
        
        alert(`Processo Conclu√≠do!\n\n+ ${added} Novos\n~ ${updated} Atualizados\n+ ${catsAdded} Categorias`);
    }
};

/* --- M√ìDULOS AUXILIARES --- */
const ComboManager = {
    currentItems: [],
    toggle: (checked) => {
        document.getElementById('combo-area').style.display = checked ? 'block' : 'none';
        if(checked) ComboManager.render();
    },
    processPaste: () => {
        const text = document.getElementById('combo-paste').value;
        const db = DB.get();
        const lines = text.split('\n');
        let count=0;
        lines.forEach(l => {
            const m = l.trim().match(/^(\d+)[xX]\s+(.+)$/);
            if(m) {
                const p = db.produto.find(x => x.nome === m[2].trim().toUpperCase());
                if(p) { ComboManager.add(p.id, p.codigo, p.nome, parseInt(m[1])); count++; }
            }
        });
        document.getElementById('combo-paste').value = '';
        ComboManager.render();
        alert(`${count} itens processados.`);
    },
    search: (val) => {
        const res = document.getElementById('combo-results');
        if(val.length < 2) { res.style.display='none'; return; }
        const db = DB.get();
        const matches = db.produto.filter(p => p.nome.toLowerCase().includes(val.toLowerCase())).slice(0,5);
        res.innerHTML = matches.map(p => `<div class="search-item" onclick="ComboManager.add('${p.id}', '${p.codigo}', '${p.nome}', 1)">${p.nome}</div>`).join('');
        res.style.display = 'block';
    },
    add: (id, code, name, qty) => {
        const idx = ComboManager.currentItems.findIndex(i => i.id === id);
        if(idx > -1) ComboManager.currentItems[idx].qty += qty;
        else ComboManager.currentItems.push({id, code, nome: name, qty});
        ComboManager.render();
        document.getElementById('combo-search').value = '';
        document.getElementById('combo-results').style.display = 'none';
    },
    remove: (idx) => { ComboManager.currentItems.splice(idx,1); ComboManager.render(); },
    render: () => {
        document.getElementById('combo-list').innerHTML = ComboManager.currentItems.map((item, i) => `
            <div style="display:flex; justify-content:space-between; margin-bottom:4px; padding:5px; background:white; border:1px solid #ddd;">
                <span>${item.nome}</span>
                <span>Qtd: ${item.qty} <button onclick="ComboManager.remove(${i})" class="btn-danger btn-icon" style="height:20px; width:20px;">x</button></span>
            </div>
        `).join('');
    }
};

const LinkedManager = {
    search: (val) => {
        const res = document.getElementById('linked-results');
        if(val.length < 2) { res.style.display='none'; return; }
        const db = DB.get();
        const matches = db.produto.filter(p => p.nome.toLowerCase().includes(val.toLowerCase())).slice(0,5);
        res.innerHTML = matches.map(p => `<div class="search-item" onclick="LinkedManager.select('${p.id}', '${p.codigo} - ${p.nome}')">${p.codigo} - ${p.nome}</div>`).join('');
        res.style.display = 'block';
    },
    select: (id, name) => {
        document.getElementById('p-linkedId').value = id;
        document.getElementById('p-linkedName').value = name;
        document.getElementById('linked-results').style.display = 'none';
    },
    clear: () => { document.getElementById('p-linkedId').value=''; document.getElementById('p-linkedName').value=''; }
};

const CatManager = {
    open: () => { CatManager.render(); document.getElementById('modal-cat').showModal(); },
    refreshSelects: () => {
        const db = DB.get();
        let html = '<option value="">Sem Categoria</option>';
        let filter = '<option value="">Todas Categorias</option>';
        db.categorias.forEach(c => {
            html += `<option value="${c.nome}">${c.nome}</option>`;
            filter += `<option value="${c.nome}">${c.nome}</option>`;
            (c.subs||[]).forEach(s => {
                html += `<option value="${c.nome} > ${s.nome}">&nbsp;&nbsp;‚Ü≥ ${s.nome}</option>`;
                filter += `<option value="${c.nome} > ${s.nome}">&nbsp;&nbsp;‚Ü≥ ${s.nome}</option>`;
            });
        });
        const s1 = document.getElementById('p-categoria'); if(s1) s1.innerHTML = html;
        const s2 = document.getElementById('f-cat'); if(s2) s2.innerHTML = filter;
    },
    addRoot: () => {
        const val = document.getElementById('new-cat-root').value.trim().toUpperCase();
        if(!val) return;
        const db = DB.get();
        if(db.categorias.some(c=>c.nome===val)) return alert('Existe');
        db.categorias.push({id:Date.now(), nome:val, subs:[]});
        DB.save(db); document.getElementById('new-cat-root').value=''; CatManager.refreshAll();
    },
    delete: (id, pid) => {
        if(!confirm('Excluir?')) return;
        const db = DB.get();
        if(pid) {
            const p = db.categorias.find(c=>c.id==pid);
            p.subs = p.subs.filter(s=>s.id!=id);
        } else {
            db.categorias = db.categorias.filter(c=>c.id!=id);
        }
        DB.save(db); CatManager.refreshAll();
    },
    refreshAll: () => { CatManager.render(); CatManager.refreshSelects(); },
    render: () => {
        const db = DB.get();
        document.getElementById('cat-tree').innerHTML = db.categorias.map(c => `
            <div class="tree-node">
                <div class="tree-head"><b>${c.nome}</b> <button onclick="CatManager.delete(${c.id})" style="color:red; border:none; background:none; cursor:pointer;">‚úï</button></div>
            </div>`).join('');
    }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
