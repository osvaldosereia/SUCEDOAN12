<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAS V4 | Definitivo</title>
    
    <style>
        /* --- CSS OTIMIZADO --- */
        :root {
            --bg: #f1f5f9;
            --surface: #ffffff;
            --border: #cbd5e1;
            --text: #0f172a;
            --primary: #2563eb;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #ca8a04;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); padding-bottom: 80px; }

        /* Layout */
        header { background: var(--surface); padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 20; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h1 { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }

        main { max-width: 1400px; margin: 1rem auto; padding: 0 1rem; display: grid; gap: 1.5rem; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { main { grid-template-columns: 400px 1fr; align-items: start; } }

        /* Cards */
        .card { background: var(--surface); border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { background: #f8fafc; padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 0.8rem; text-transform: uppercase; color: #64748b; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }

        /* Inputs & Buttons */
        input, select, button { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 10px; font-size: 0.9rem; }
        input:focus, select:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        .btn { cursor: pointer; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; display: inline-flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-ghost { background: transparent; border: 1px solid transparent; color: #64748b; margin: 0; width: auto; }
        .btn-ghost:hover { background: #e2e8f0; color: var(--text); }
        .btn-icon { width: 32px; padding: 0; }

        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        label { font-size: 0.7rem; font-weight: 700; color: #64748b; display: block; margin-bottom: 3px; }

        /* Filter Bar */
        .filter-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; padding: 10px; background: #e2e8f0; border-bottom: 1px solid var(--border); }
        .filter-bar input, .filter-bar select { margin: 0; border: 1px solid #cbd5e1; }

        /* Table */
        .table-wrap { overflow-x: auto; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }
        th { text-align: left; background: #f1f5f9; padding: 10px; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--border); }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
        tr:hover { background: #f8fafc; }

        /* Badges */
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-gray { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }

        /* Modal */
        dialog { margin: auto; border: none; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 90%; max-width: 600px; padding: 0; }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }

        /* Tree View */
        .tree-node { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 5px; overflow: hidden; }
        .tree-header { padding: 8px 10px; background: #fff; display: flex; justify-content: space-between; align-items: center; }
        .tree-subs { background: #f8fafc; padding: 5px 10px 10px 20px; border-top: 1px solid var(--border); }
        .sub-node { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem; }
    </style>
</head>
<body>

<header>
    <h1>CAT√ÅLOGO V4</h1>
    <div style="display:flex; gap:5px;">
        <button onclick="CatManager.open()" class="btn btn-ghost" style="border:1px solid #cbd5e1;">üìÇ Categorias</button>
        <button onclick="App.exportData()" class="btn btn-ghost" style="border:1px solid #cbd5e1;">üíæ Backup</button>
        <button onclick="Importer.open()" class="btn btn-ghost" style="border:1px solid #cbd5e1;">üì• Importar</button>
    </div>
</header>

<main>
    <section class="card">
        <div class="card-header">
            <span>Cadastro / Edi√ß√£o</span>
            <button onclick="App.reset()" class="btn btn-ghost btn-icon">‚Üª</button>
        </div>
        <div class="card-body">
            <form id="form" onsubmit="App.save(event)">
                <input type="hidden" id="id">
                
                <div class="row-3">
                    <div><label>C√≥digo</label><input type="text" id="codigo" readonly style="background:#f1f5f9; font-weight:700;"></div>
                    <div style="grid-column: span 2"><label>EAN (C√≥digo de Barras)</label><input type="text" id="ean"></div>
                </div>

                <label>Nome do Produto</label>
                <input type="text" id="nome" required style="font-weight:700;">

                <div class="row-2">
                    <div>
                        <label>Categoria</label>
                        <select id="categoria"><option value="">Sem Categoria</option></select>
                    </div>
                    <div>
                        <label>Fornecedor</label>
                        <input type="text" id="fornecedor" list="dl-fornecedor">
                        <datalist id="dl-fornecedor"></datalist>
                    </div>
                </div>

                <div class="row-3" style="margin-top:10px; border-top:1px dashed var(--border); padding-top:10px;">
                    <div><label>Custo (R$)</label><input type="number" id="custo" step="0.01"></div>
                    <div><label>Venda (R$)</label><input type="number" id="valor" step="0.01" required></div>
                    <div><label>Estoque</label><input type="number" id="estoque" required></div>
                </div>

                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px; padding:12px;">SALVAR PRODUTO</button>
            </form>
        </div>
    </section>

    <section class="card" style="height:fit-content;">
        <div class="card-header">
            <span>Produtos (<span id="count">0</span>)</span>
        </div>
        
        <div class="filter-bar">
            <input type="text" id="f-busca" placeholder="Buscar Nome/EAN..." onkeyup="App.renderList()">
            <select id="f-cat" onchange="App.renderList()"><option value="">Todas Categorias</option></select>
            <select id="f-forn" onchange="App.renderList()"><option value="">Todos Fornecedores</option></select>
            <input type="number" id="f-est" placeholder="Estoque M√°x (ex: 5)" onkeyup="App.renderList()" title="Mostra produtos com estoque IGUAL ou MENOR que este valor">
        </div>

        <div class="table-wrap">
            <table id="table">
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Categoria</th>
                        <th>Pre√ßo</th>
                        <th>Estoque</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>
            </table>
        </div>
    </section>
</main>

<dialog id="modal-cat">
    <div style="padding:15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between;">
        <b>Gerenciar Categorias</b>
        <button onclick="document.getElementById('modal-cat').close()" class="btn btn-ghost btn-icon">‚úï</button>
    </div>
    <div class="modal-body">
        <div style="display:flex; gap:5px; margin-bottom:15px;">
            <input type="text" id="new-cat" placeholder="Nova Categoria Principal...">
            <button onclick="CatManager.addRoot()" class="btn btn-primary" style="width:auto;">Adicionar</button>
        </div>
        <div id="cat-list"></div>
    </div>
</dialog>

<input type="file" id="import-file" style="display:none" onchange="Importer.run(this)">

<script>
/* --- SISTEMA CENTRAL --- */
const DB = {
    key: 'db_v4_final',
    load: () => {
        const data = JSON.parse(localStorage.getItem(DB.key) || '{"produtos":[], "categorias":[]}');
        // GARANTIA DE INTEGRIDADE: Se categorias n√£o tiverem array de subs, cria agora.
        data.categorias.forEach(c => { if(!c.subs) c.subs = []; });
        return data;
    },
    save: (data) => localStorage.setItem(DB.key, JSON.stringify(data))
};

const App = {
    init: () => {
        App.renderList();
        CatManager.refresh();
    },

    save: (e) => {
        e.preventDefault();
        const db = DB.load();
        const id = document.getElementById('id').value;
        
        // Gerar c√≥digo sequencial se for novo
        let codigo = document.getElementById('codigo').value;
        if(!id) {
            const max = db.produtos.reduce((acc, p) => Math.max(acc, parseInt(p.codigo.replace(/\D/g,'')||0)), 0);
            codigo = `P${String(max+1).padStart(4,'0')}`;
        }

        const produto = {
            id: id || Date.now().toString(),
            codigo,
            ean: document.getElementById('ean').value,
            nome: document.getElementById('nome').value.toUpperCase(),
            categoria: document.getElementById('categoria').value,
            fornecedor: document.getElementById('fornecedor').value.toUpperCase(),
            custo: Number(document.getElementById('custo').value),
            valor: Number(document.getElementById('valor').value),
            estoque: Number(document.getElementById('estoque').value)
        };

        if(id) {
            const idx = db.produtos.findIndex(p => p.id === id);
            if(idx > -1) db.produtos[idx] = produto;
        } else {
            db.produtos.unshift(produto);
        }

        DB.save(db);
        App.reset();
        App.renderList();
        alert('Salvo!');
    },

    edit: (id) => {
        const p = DB.load().produtos.find(x => x.id === id);
        if(!p) return;
        document.getElementById('id').value = p.id;
        document.getElementById('codigo').value = p.codigo;
        document.getElementById('ean').value = p.ean;
        document.getElementById('nome').value = p.nome;
        document.getElementById('categoria').value = p.categoria;
        document.getElementById('fornecedor').value = p.fornecedor;
        document.getElementById('custo').value = p.custo;
        document.getElementById('valor').value = p.valor;
        document.getElementById('estoque').value = p.estoque;
        document.getElementById('nome').focus();
    },

    delete: (id) => {
        if(!confirm('Excluir este produto?')) return;
        const db = DB.load();
        db.produtos = db.produtos.filter(p => p.id !== id);
        DB.save(db);
        App.renderList();
    },

    reset: () => {
        document.getElementById('form').reset();
        document.getElementById('id').value = '';
        document.getElementById('codigo').value = '';
    },

    renderList: () => {
        const db = DB.load();
        
        // Filtros
        const termo = document.getElementById('f-busca').value.toLowerCase();
        const cat = document.getElementById('f-cat').value;
        const forn = document.getElementById('f-forn').value;
        const estTeto = document.getElementById('f-est').value;

        // Atualiza selects de filtro
        const forns = [...new Set(db.produtos.map(p => p.fornecedor).filter(Boolean))].sort();
        const selForn = document.getElementById('f-forn');
        if(selForn.options.length === 1) { // S√≥ preenche se estiver vazio para n√£o resetar sele√ß√£o
            forns.forEach(f => selForn.innerHTML += `<option value="${f}">${f}</option>`);
            // Atualiza datalist do form tamb√©m
            document.getElementById('dl-fornecedor').innerHTML = forns.map(f => `<option value="${f}">`).join('');
        }

        const lista = db.produtos.filter(p => {
            if(termo && !p.nome.toLowerCase().includes(termo) && !p.ean.includes(termo)) return false;
            if(cat && p.categoria !== cat) return false;
            if(forn && p.fornecedor !== forn) return false;
            if(estTeto !== '' && p.estoque > Number(estTeto)) return false; // L√≥gica: Estoque <= Filtro
            return true;
        });

        document.getElementById('count').innerText = lista.length;
        
        document.getElementById('tbody').innerHTML = lista.slice(0, 100).map(p => `
            <tr>
                <td>
                    <b>${p.nome}</b><br>
                    <span style="font-size:0.75rem; color:#64748b;">${p.codigo} | ${p.ean}</span>
                </td>
                <td><span class="badge bg-gray">${p.categoria || '-'}</span></td>
                <td>R$ ${p.valor.toFixed(2)}</td>
                <td><span class="badge ${p.estoque <= 0 ? 'bg-red' : 'bg-green'}">${p.estoque}</span></td>
                <td>
                    <button onclick="App.edit('${p.id}')" class="btn btn-ghost btn-icon">‚úé</button>
                    <button onclick="App.delete('${p.id}')" class="btn btn-ghost btn-icon" style="color:var(--danger)">‚úï</button>
                </td>
            </tr>
        `).join('');
    },

    exportData: () => {
        const now = new Date();
        const d = String(now.getDate()).padStart(2, '0');
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const y = now.getFullYear();
        const fileName = `produtos-${d}-${m}-${y}.json`;

        const dataStr = JSON.stringify(DB.load(), null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = fileName;
        a.click();
    }
};

/* --- GERENCIADOR DE CATEGORIAS (CORRIGIDO) --- */
const CatManager = {
    open: () => {
        CatManager.render();
        document.getElementById('modal-cat').showModal();
    },

    refresh: () => {
        const db = DB.load();
        const sel = document.getElementById('categoria');
        const selFiltro = document.getElementById('f-cat');
        
        // Guarda sele√ß√£o atual
        const currentVal = sel.value;
        const currentFiltro = selFiltro.value;

        let html = '<option value="">Sem Categoria</option>';
        let htmlFiltro = '<option value="">Todas Categorias</option>';

        db.categorias.forEach(c => {
            html += `<option value="${c.nome}">${c.nome}</option>`;
            htmlFiltro += `<option value="${c.nome}">${c.nome}</option>`;
            (c.subs || []).forEach(s => {
                const val = `${c.nome} > ${s.nome}`;
                html += `<option value="${val}"> -- ${s.nome}</option>`;
                htmlFiltro += `<option value="${val}"> -- ${s.nome}</option>`;
            });
        });

        sel.innerHTML = html;
        sel.value = currentVal; // Restaura
        
        selFiltro.innerHTML = htmlFiltro;
        selFiltro.value = currentFiltro;
    },

    addRoot: () => {
        const input = document.getElementById('new-cat');
        const nome = input.value.trim().toUpperCase();
        if(!nome) return;

        const db = DB.load();
        if(db.categorias.some(c => c.nome === nome)) return alert('J√° existe!');

        db.categorias.push({ id: Date.now(), nome, subs: [] }); // CRIA ARRAY DE SUBS VAZIO SEMPRE
        DB.save(db);
        
        input.value = '';
        CatManager.render();
        CatManager.refresh();
    },

    addSub: (parentId) => {
        const nome = prompt("Nome da Subcategoria:")?.trim().toUpperCase();
        if(!nome) return;

        const db = DB.load();
        const parent = db.categorias.find(c => c.id == parentId);
        
        if(parent) {
            if(!parent.subs) parent.subs = []; // GARANTIA EXTRA
            if(parent.subs.some(s => s.nome === nome)) return alert('J√° existe!');
            
            parent.subs.push({ id: Date.now(), nome });
            DB.save(db);
            CatManager.render();
            CatManager.refresh();
        }
    },

    delete: (id, parentId = null) => {
        const db = DB.load();
        
        // Verifica se tem produtos usando antes de apagar
        let nomeParaChecar = '';
        if(parentId) {
            const p = db.categorias.find(c => c.id == parentId);
            const s = p.subs.find(sub => sub.id == id);
            nomeParaChecar = `${p.nome} > ${s.nome}`;
        } else {
            const c = db.categorias.find(c => c.id == id);
            nomeParaChecar = c.nome;
            if(c.subs && c.subs.length > 0) return alert('Delete as subcategorias primeiro!');
        }

        const emUso = db.produtos.some(p => p.categoria && p.categoria.includes(nomeParaChecar));
        if(emUso) return alert(`Erro: Existem produtos na categoria "${nomeParaChecar}".`);

        if(!confirm('Tem certeza?')) return;

        if(parentId) {
            const p = db.categorias.find(c => c.id == parentId);
            p.subs = p.subs.filter(s => s.id != id);
        } else {
            db.categorias = db.categorias.filter(c => c.id != id);
        }

        DB.save(db);
        CatManager.render();
        CatManager.refresh();
    },

    rename: (id, currentName, parentId = null) => {
        const newName = prompt("Novo nome:", currentName)?.trim().toUpperCase();
        if(!newName || newName === currentName) return;

        const db = DB.load();
        let oldString = "";
        let newString = "";

        if(parentId) {
            const p = db.categorias.find(c => c.id == parentId);
            const s = p.subs.find(sub => sub.id == id);
            oldString = `${p.nome} > ${s.nome}`;
            s.nome = newName;
            newString = `${p.nome} > ${newName}`;
        } else {
            const c = db.categorias.find(c => c.id == id);
            oldString = c.nome;
            c.nome = newName;
            newString = newName;
        }

        // ATUALIZA√á√ÉO EM CASCATA NOS PRODUTOS
        let count = 0;
        db.produtos.forEach(prod => {
            if(prod.categoria === oldString) {
                prod.categoria = newString;
                count++;
            } else if (prod.categoria.startsWith(oldString + " >")) {
                prod.categoria = prod.categoria.replace(oldString, newString);
                count++;
            }
        });

        DB.save(db);
        CatManager.render();
        CatManager.refresh();
        App.renderList(); // Atualiza tabela de fundo
        alert(`Categoria renomeada. ${count} produtos atualizados.`);
    },

    render: () => {
        const db = DB.load();
        const div = document.getElementById('cat-list');
        
        if(db.categorias.length === 0) {
            div.innerHTML = '<p style="color:#94a3b8; text-align:center;">Nenhuma categoria.</p>';
            return;
        }

        div.innerHTML = db.categorias.map(c => `
            <div class="tree-node">
                <div class="tree-header">
                    <span>${c.nome}</span>
                    <div style="display:flex; gap:5px;">
                        <button onclick="CatManager.addSub(${c.id})" class="btn btn-ghost btn-icon" title="Adicionar Sub" style="color:var(--success)">Ôºã</button>
                        <button onclick="CatManager.rename(${c.id}, '${c.nome}')" class="btn btn-ghost btn-icon">‚úé</button>
                        <button onclick="CatManager.delete(${c.id})" class="btn btn-ghost btn-icon" style="color:var(--danger)">‚úï</button>
                    </div>
                </div>
                ${(c.subs && c.subs.length > 0) ? `
                    <div class="tree-subs">
                        ${c.subs.map(s => `
                            <div class="sub-node">
                                <span>‚Ü≥ ${s.nome}</span>
                                <div>
                                    <button onclick="CatManager.rename(${s.id}, '${s.nome}', ${c.id})" class="btn btn-ghost btn-icon">‚úé</button>
                                    <button onclick="CatManager.delete(${s.id}, ${c.id})" class="btn btn-ghost btn-icon" style="color:var(--danger)">‚úï</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }
};

const Importer = {
    open: () => document.getElementById('import-file').click(),
    run: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                // Valida√ß√£o b√°sica
                if(!json.produtos) throw new Error("Formato inv√°lido");
                
                if(confirm(`Importar ${json.produtos.length} produtos e ${json.categorias.length} categorias? Isso substituir√° o banco atual.`)) {
                    DB.save(json);
                    location.reload();
                }
            } catch(err) { alert('Erro ao ler arquivo: ' + err.message); }
        };
        reader.readAsText(file);
        input.value = '';
    }
};

// Iniciar
App.init();
</script>
</body>
</html>
