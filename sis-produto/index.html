<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAS V3 | Catálogo Pro V5</title>
    
    <style>
        /* --- 1. CORE & RESET (Classless Approach) --- */
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --purple: #7c3aed;
            --radius: 8px;
            --shadow: 0 1px 3px 0 rgba(0,0,0,0.1);
            --font-sys: system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-sys);
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.5;
            padding-bottom: 80px; /* Space for mobile scroll */
        }

        /* --- 2. LAYOUT --- */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 30;
            height: 60px;
        }

        h1 { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        
        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1100px) {
            main { grid-template-columns: 450px 1fr; align-items: start; }
        }

        /* --- 3. COMPONENTS --- */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { padding: 0.8rem 1rem; border-bottom: 1px solid var(--border); background: #f8fafc; display: flex; justify-content: space-between; align-items: center; min-height: 50px; }
        .card-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.5px; }
        .card-body { padding: 1rem; }

        /* Forms */
        .form-group { margin-bottom: 0.8rem; }
        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.8rem; }

        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 0.25rem; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 0.6rem; font-size: 0.9rem; border: 1px solid #cbd5e1; border-radius: 6px; background: var(--surface); transition: all 0.15s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        textarea { resize: vertical; min-height: 60px; }

        .section-header {
            font-size: 0.7rem; font-weight: 800; color: var(--primary);
            margin: 1.2rem 0 0.5rem 0; padding-bottom: 4px; border-bottom: 1px dashed var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Buttons & Badges */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.6rem 1rem; font-weight: 600; font-size: 0.75rem; border-radius: 6px; border: none; cursor: pointer; text-transform: uppercase; transition: 0.2s; min-height: 38px; }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-success { background: var(--success); color: white; }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid transparent; }
        .btn-ghost:hover { background: var(--bg); color: var(--text-main); border-color: #cbd5e1; }
        .btn-icon { padding: 8px; width: 36px; height: 36px; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .badge-green { background: #dcfce7; color: #15803d; }
        .badge-red { background: #fee2e2; color: #b91c1c; }
        .badge-purple { background: #f3e8ff; color: #7e22ce; }
        .badge-gray { background: #f1f5f9; color: var(--text-muted); border: 1px solid #e2e8f0; }

        /* Table */
        .table-wrapper { overflow-x: auto; max-height: 75vh; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; white-space: nowrap; }
        th { text-align: left; padding: 0.75rem; background: #f8fafc; color: var(--text-muted); font-weight: 700; text-transform: uppercase; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
        td { padding: 0.75rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background-color: #f1f5f9; }

        /* Advanced Components */
        .combo-box { background: #eff6ff; border: 1px dashed #bfdbfe; padding: 10px; border-radius: 6px; margin-top: 5px; }
        .combo-item { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 4px 8px; border: 1px solid #dbeafe; border-radius: 4px; margin-bottom: 4px; font-size: 0.8rem; }
        
        .search-dropdown { position: absolute; background: white; border: 1px solid var(--border); width: 100%; max-height: 200px; overflow-y: auto; z-index: 50; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px; display: none; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        .search-item:hover { background: #f8fafc; color: var(--primary); }

        /* Modals (Native <dialog>) */
        dialog { border: none; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 95vw; max-width: 800px; padding: 0; animation: fadeUp 0.2s ease; margin: auto; }
        dialog::backdrop { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(2px); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
        .modal-body { padding: 1.5rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #f8fafc; }

        /* Category Tree Specifics */
        .cat-item { background: #fff; border: 1px solid var(--border); border-radius: 6px; margin-bottom: 8px; overflow: hidden; }
        .cat-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f8fafc; }
        .cat-actions { display: flex; gap: 4px; }
        .cat-subs { padding: 0 12px 8px 24px; border-top: 1px dashed var(--border); background: #fff; }
        .sub-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        .sub-item:last-child { border-bottom: none; }
    </style>
</head>
<body>

<header>
    <h1>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
        CATÁLOGO PRO V5
    </h1>
    <div style="display:flex; gap:8px;">
        <button onclick="CatManager.open()" class="btn-ghost" title="Gerenciar Categorias">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"></path><path d="M3 12h18"></path><path d="M3 18h18"></path></svg>
            <span style="display:none; @media(min-width:600px){display:inline;}"> Categorias</span>
        </button>
        <button onclick="Importer.open()" class="btn-ghost" title="Importar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
        </button>
        <button onclick="App.exportAll()" class="btn-ghost" title="Backup">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
        </button>
    </div>
</header>

<main>
    <section class="card">
        <div class="card-header">
            <span class="card-title" id="form-title">Novo Produto</span>
            <button onclick="App.resetForm()" class="btn-ghost btn-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg></button>
        </div>
        <div class="card-body">
            <form id="form-prod" onsubmit="App.save(event)">
                <input type="hidden" id="p-id">
                
                <div class="row-3">
                    <div><label>Código</label><input type="text" id="p-codigo" readonly placeholder="Auto" style="font-weight:700;"></div>
                    <div style="grid-column: span 2;"><label>EAN (Principal)</label><input type="text" id="p-ean"></div>
                </div>

                <div class="form-group"><label>Nome Principal</label><input type="text" id="p-nome" required style="font-weight:600;"></div>
                <div class="form-group"><label>Fornecedor</label><input type="text" id="p-fornecedor"></div>

                <div class="row-2">
                    <div><label>Categoria</label><select id="p-categoria"><option value="">Sem Categoria</option></select></div>
                    <div><label>Unidade</label><input type="text" id="p-unidade" placeholder="UN, CX, KG"></div>
                </div>

                <div class="section-header"><span>COMERCIAL & PREÇO</span></div>
                <div class="row-3">
                    <div><label>Custo (R$)</label><input type="number" id="p-custo" step="0.01" oninput="App.calcMargin()"></div>
                    <div><label>Margem (%)</label><input type="text" id="p-margem" readonly style="background:#f1f5f9; text-align:center;"></div>
                    <div><label style="color:var(--primary)">Venda (R$)</label><input type="number" id="p-valor" step="0.01" oninput="App.calcMargin()" style="font-weight:700; border-color:var(--primary);"></div>
                </div>
                
                <div style="background:#fff7ed; padding:8px; border:1px solid #ffedd5; border-radius:6px; margin-top:8px; display:flex; gap:10px; align-items:center;">
                    <div style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="p-isOffer" style="width:auto;"><label for="p-isOffer" style="margin:0; color:var(--warning); cursor:pointer;">OFERTA</label></div>
                    <div style="flex:1"><input type="number" id="p-offerPrice" placeholder="Preço Oferta (R$)" step="0.01"></div>
                </div>

                <div class="section-header"><span>LOGÍSTICA & ESTOQUE</span></div>
                <div class="row-2">
                    <div><label>Estoque Físico</label><input type="number" id="p-estoque" required style="font-weight:700;"></div>
                    <div><label>Estoque Fiscal</label><input type="number" id="p-estoqueFiscal"></div>
                </div>
                <div class="row-3">
                    <div><label>Peso (kg)</label><input type="number" id="p-peso" step="0.001"></div>
                    <div><label>Lim. Mín.</label><input type="number" id="p-limit"></div>
                    <div><label>Imagem</label><input type="text" id="p-imageName" placeholder="Nome arq."></div>
                </div>
                
                <div style="margin-top:5px; border:1px solid var(--border); border-radius:6px; padding:5px;">
                    <label style="font-size:0.65rem;">Lotes (Validade | Qtd)</label>
                    <div id="batch-container"></div>
                </div>

                <div class="section-header">
                    <span>KIT / COMBO</span>
                    <div style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="p-isCombo" style="width:auto;" onchange="ComboManager.toggle(this.checked)"><label for="p-isCombo" style="margin:0; cursor:pointer;">É Combo?</label></div>
                </div>
                <div id="combo-area" class="combo-box" style="display:none;">
                    <div style="position:relative;">
                        <input type="text" id="combo-search" placeholder="Buscar produto..." oninput="ComboManager.search(this.value)">
                        <div id="combo-results" class="search-dropdown"></div>
                    </div>
                    <div id="combo-list" style="margin-top:8px;"></div>
                </div>

                <div class="section-header"><span>VARIAÇÕES & ALIAS</span></div>
                <div class="form-group">
                    <label>EANs Adicionais (Separar por | )</label>
                    <textarea id="p-variacoesEan" placeholder="789... | 789..."></textarea>
                </div>
                <div class="form-group">
                    <label>Nomes Alternativos (Busca)</label>
                    <textarea id="p-variacoesNome" placeholder="Nome 1 | Nome 2"></textarea>
                </div>

                <div class="row-2" style="align-items:end;">
                    <div style="position:relative;">
                        <label>Vincular a Produto (Pai)</label>
                        <input type="hidden" id="p-linkedId">
                        <input type="text" id="p-linkedName" placeholder="Buscar pai..." oninput="LinkedManager.search(this.value)">
                        <div id="linked-results" class="search-dropdown"></div>
                    </div>
                    <button type="button" onclick="LinkedManager.clear()" class="btn-ghost">Limpar Vínculo</button>
                </div>

                <div class="section-header"><span>FISCAL</span></div>
                <div class="row-3">
                    <div><label>NCM</label><input type="text" id="p-ncm"></div>
                    <div><label>CEST</label><input type="text" id="p-cest"></div>
                    <div><label>CFOP</label><input type="text" id="p-cfop"></div>
                </div>

                <div style="margin-top:1.5rem;">
                    <button type="submit" class="btn btn-primary btn-block">SALVAR DADOS</button>
                </div>
            </form>
        </div>
    </section>

    <section class="card" style="height:fit-content; min-height:600px;">
        <div class="card-header">
            <div style="flex:1; max-width:300px; position:relative;">
                <input type="text" oninput="App.filter(this.value)" placeholder="Buscar produtos..." style="padding-left:2rem;">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--text-muted);"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
            <span class="badge badge-gray" id="total-count">0 REGISTROS</span>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th>Categ.</th>
                        <th>Preço</th>
                        <th>Estoque</th>
                        <th style="text-align:right;">Ações</th>
                    </tr>
                </thead>
                <tbody id="prod-list"></tbody>
            </table>
        </div>
    </section>
</main>

<dialog id="modal-cat">
    <div class="modal-header">
        <span class="card-title">Gerenciar Categorias</span>
        <button onclick="document.getElementById('modal-cat').close()" class="btn-ghost btn-icon">✕</button>
    </div>
    <div class="modal-body">
        <div style="display:flex; gap:10px; margin-bottom:1.5rem; padding-bottom:1rem; border-bottom:1px solid var(--border);">
            <input type="text" id="new-cat-root" placeholder="Nova Categoria Principal..." onkeypress="if(event.key==='Enter') CatManager.addRoot()">
            <button onclick="CatManager.addRoot()" class="btn btn-primary" style="white-space:nowrap;">+ Adicionar</button>
        </div>
        <div id="cat-tree" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
</dialog>

<dialog id="modal-import">
    <div class="modal-header">
        <span class="card-title">Conferência de Importação</span>
        <button onclick="document.getElementById('modal-import').close()" class="btn-ghost btn-icon">✕</button>
    </div>
    <div class="modal-body">
        <div style="background:#fff7ed; border:1px solid #ffedd5; padding:10px; border-radius:6px; margin-bottom:1rem; font-size:0.8rem; color:#9a3412;">
            <b>Regra Anti-Conflito:</b> Busca por <b>EAN Exato</b> ou <b>Nome Exato</b>. Novos códigos serão sequenciais.
        </div>
        <table style="font-size:0.75rem;">
            <thead>
                <tr>
                    <th style="width:30px;"><input type="checkbox" checked onchange="Importer.toggleAll(this.checked)"></th>
                    <th>Status</th>
                    <th>Produto</th>
                    <th>Ref. Sistema</th>
                    <th>Qtd</th>
                </tr>
            </thead>
            <tbody id="import-preview-list"></tbody>
        </table>
    </div>
    <div class="modal-footer">
        <button onclick="document.getElementById('modal-import').close()" class="btn-ghost">Cancelar</button>
        <button onclick="Importer.confirm()" class="btn btn-success">Confirmar Importação</button>
    </div>
</dialog>

<input type="file" id="file-input" accept=".json" style="display:none;" onchange="Importer.process(this)">

<script>
/**
 * SISTEMA V3 - CATALOG MASTER V5 (Refactored)
 * Architecture: Vanilla JS, LocalStorage, Single Object State
 */

const DB = {
    key: 'sys_v3_standalone_db',
    get: () => {
        const raw = localStorage.getItem(DB.key);
        const data = raw ? JSON.parse(raw) : {};
        if (!data.produto) data.produto = [];
        if (!data.categorias) data.categorias = [];
        return data;
    },
    save: (data) => localStorage.setItem(DB.key, JSON.stringify(data)),
    getMaxIdValue: (list) => {
        let max = 0;
        list.forEach(p => {
            const n = parseInt((p.codigo || '').replace(/\D/g, '') || 0);
            if(n > max) max = n;
        });
        return max;
    },
    nextCode: () => {
        const db = DB.get();
        const max = DB.getMaxIdValue(db.produto);
        return `P${String(max + 1).padStart(4, '0')}`;
    }
};

const App = {
    init: () => {
        App.renderList();
        CatManager.populateSelect();
        App.renderBatches();
    },

    renderList: (filter = '') => {
        const db = DB.get();
        const tbody = document.getElementById('prod-list');
        const term = filter.toLowerCase();
        
        let list = db.produto.filter(p => {
            if(!term) return true;
            const names = [p.nome, ...(p.variacoesNome || [])].join(' ').toLowerCase();
            const eans = [p.ean, ...(p.variacoesEan || [])].join(' ');
            return names.includes(term) || eans.includes(term) || p.codigo.toLowerCase().includes(term);
        });

        document.getElementById('total-count').innerText = `${list.length} REGS`;
        list = list.slice(0, 50);

        tbody.innerHTML = list.map(p => {
            const stockClass = p.estoque <= 0 ? 'badge-red' : (p.estoque < (p.limit||0) ? 'badge-gray' : 'badge-green');
            return `
            <tr>
                <td>
                    <div style="font-weight:700; color:var(--text-main);">${p.nome}</div>
                    <div style="font-size:0.7rem; color:var(--text-muted);">${p.codigo} ${p.ean ? '| '+p.ean : ''}</div>
                </td>
                <td><span class="badge badge-gray">${p.categoria ? p.categoria.split('>').pop().trim() : '-'}</span></td>
                <td>
                    ${p.isOffer ? `<div style="text-decoration:line-through; font-size:0.7rem; color:var(--text-muted);">R$ ${p.valor.toFixed(2)}</div><div style="font-weight:700; color:var(--danger);">R$ ${p.offerPrice.toFixed(2)}</div>` : `<div style="font-weight:700;">R$ ${p.valor.toFixed(2)}</div>`}
                </td>
                <td><span class="badge ${stockClass}">${p.estoque} ${p.unidade||'UN'}</span></td>
                <td style="text-align:right;">
                    <button onclick="App.edit('${p.id}')" class="btn-ghost btn-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                    <button onclick="App.delete('${p.id}')" class="btn-ghost btn-icon" style="color:var(--danger)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                </td>
            </tr>
            `;
        }).join('');
    },

    save: (e) => {
        e.preventDefault();
        const db = DB.get();
        const id = document.getElementById('p-id').value;
        
        let batches = [];
        for(let i=0; i<3; i++){
            let d = document.getElementById(`batch-d-${i}`).value;
            let q = Number(document.getElementById(`batch-q-${i}`).value);
            if(d && q > 0) batches.push({date: d, qty: q});
        }

        const codigo = id ? document.getElementById('p-codigo').value : DB.nextCode();

        const prod = {
            id: id || Date.now().toString(),
            codigo: codigo,
            nome: document.getElementById('p-nome').value.trim(),
            ean: document.getElementById('p-ean').value,
            fornecedor: document.getElementById('p-fornecedor').value,
            categoria: document.getElementById('p-categoria').value,
            unidade: document.getElementById('p-unidade').value,
            custo: Number(document.getElementById('p-custo').value)||0,
            valor: Number(document.getElementById('p-valor').value)||0,
            isOffer: document.getElementById('p-isOffer').checked,
            offerPrice: Number(document.getElementById('p-offerPrice').value)||0,
            estoque: Number(document.getElementById('p-estoque').value)||0,
            estoqueFiscal: Number(document.getElementById('p-estoqueFiscal').value)||0,
            peso: Number(document.getElementById('p-peso').value)||0,
            limit: Number(document.getElementById('p-limit').value)||0,
            imageName: document.getElementById('p-imageName').value,
            batches: batches,
            isCombo: document.getElementById('p-isCombo').checked,
            items: ComboManager.currentItems,
            variacoesEan: document.getElementById('p-variacoesEan').value.split('|').map(s=>s.trim()).filter(Boolean),
            variacoesNome: document.getElementById('p-variacoesNome').value.split('|').map(s=>s.trim()).filter(Boolean),
            linkedProdId: document.getElementById('p-linkedId').value,
            linkedProdCode: document.getElementById('p-linkedName').value,
            ncm: document.getElementById('p-ncm').value,
            cest: document.getElementById('p-cest').value,
            cfop: document.getElementById('p-cfop').value
        };

        if(id) {
            const idx = db.produto.findIndex(p => p.id === id);
            if(idx > -1) db.produto[idx] = prod;
        } else {
            db.produto.unshift(prod);
        }

        DB.save(db);
        App.resetForm();
        App.renderList();
        alert('Produto Salvo!');
    },

    edit: (id) => {
        const db = DB.get();
        const p = db.produto.find(x => x.id === id);
        if(!p) return;

        document.getElementById('p-id').value = p.id;
        document.getElementById('p-codigo').value = p.codigo;
        document.getElementById('p-ean').value = p.ean || '';
        document.getElementById('p-nome').value = p.nome;
        document.getElementById('p-fornecedor').value = p.fornecedor || '';
        document.getElementById('p-categoria').value = p.categoria || '';
        document.getElementById('p-unidade').value = p.unidade || '';
        document.getElementById('p-custo').value = p.custo;
        document.getElementById('p-valor').value = p.valor;
        document.getElementById('p-isOffer').checked = p.isOffer || false;
        document.getElementById('p-offerPrice').value = p.offerPrice || '';
        document.getElementById('p-estoque').value = p.estoque;
        document.getElementById('p-estoqueFiscal').value = p.estoqueFiscal || '';
        document.getElementById('p-peso').value = p.peso || '';
        document.getElementById('p-limit').value = p.limit || '';
        document.getElementById('p-imageName').value = p.imageName || '';
        
        document.getElementById('p-isCombo').checked = p.isCombo || false;
        ComboManager.currentItems = p.items || [];
        ComboManager.toggle(p.isCombo || false);
        ComboManager.render();

        document.getElementById('p-variacoesEan').value = (p.variacoesEan || []).join(' | ');
        document.getElementById('p-variacoesNome').value = (p.variacoesNome || []).join(' | ');

        document.getElementById('p-linkedId').value = p.linkedProdId || '';
        document.getElementById('p-linkedName').value = p.linkedProdCode || '';

        document.getElementById('p-ncm').value = p.ncm || '';
        document.getElementById('p-cest').value = p.cest || '';
        document.getElementById('p-cfop').value = p.cfop || '';

        App.renderBatches(p.batches || []);
        App.calcMargin();
        document.getElementById('form-title').innerText = `Editando: ${p.codigo}`;
        window.scrollTo({top:0, behavior:'smooth'});
    },

    delete: (id) => {
        if(!confirm('Excluir permanentemente?')) return;
        const db = DB.get();
        db.produto = db.produto.filter(p => p.id !== id);
        DB.save(db);
        App.renderList();
    },

    resetForm: () => {
        document.getElementById('form-prod').reset();
        document.getElementById('p-id').value = '';
        document.getElementById('p-codigo').value = '';
        document.getElementById('p-margem').value = '';
        document.getElementById('p-linkedId').value = '';
        document.getElementById('form-title').innerText = 'Novo Produto';
        ComboManager.currentItems = [];
        ComboManager.toggle(false);
        App.renderBatches();
    },

    renderBatches: (existing = []) => {
        let html = '';
        for(let i=0; i<3; i++){
            let b = existing[i] || {date:'', qty:''};
            html += `<div style="display:flex; gap:5px; margin-bottom:4px;"><input type="date" id="batch-d-${i}" value="${b.date}" style="flex:2"><input type="number" id="batch-q-${i}" value="${b.qty}" placeholder="Qtd" style="flex:1"></div>`;
        }
        document.getElementById('batch-container').innerHTML = html;
    },

    calcMargin: () => {
        const c = Number(document.getElementById('p-custo').value);
        const v = Number(document.getElementById('p-valor').value);
        const el = document.getElementById('p-margem');
        if(c>0 && v>0) {
            const m = ((v-c)/c)*100;
            el.value = m.toFixed(1)+'%';
            el.style.color = m<0 ? 'red' : 'green';
        } else el.value = '-';
    },

    filter: (v) => App.renderList(v),

    exportAll: () => {
        const db = DB.get();
        const blob = new Blob([JSON.stringify(db.produto, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_produtos_${Date.now()}.json`;
        a.click();
    }
};

const ComboManager = {
    currentItems: [],
    toggle: (checked) => {
        document.getElementById('combo-area').style.display = checked ? 'block' : 'none';
        if(checked) ComboManager.render();
    },
    search: (val) => {
        const res = document.getElementById('combo-results');
        if(val.length < 2) { res.style.display='none'; return; }
        const db = DB.get();
        const matches = db.produto.filter(p => p.nome.toLowerCase().includes(val.toLowerCase())).slice(0,10);
        res.innerHTML = matches.map(p => `<div class="search-item" onclick="ComboManager.add('${p.id}', '${p.codigo}', '${p.nome}')">${p.nome}</div>`).join('');
        res.style.display = 'block';
    },
    add: (id, code, name) => {
        if(ComboManager.currentItems.some(i => i.id === id)) return;
        ComboManager.currentItems.push({id, code, nome: name, qty: 1});
        ComboManager.render();
        document.getElementById('combo-search').value = '';
        document.getElementById('combo-results').style.display = 'none';
    },
    remove: (idx) => {
        ComboManager.currentItems.splice(idx, 1);
        ComboManager.render();
    },
    updateQty: (idx, val) => {
        ComboManager.currentItems[idx].qty = Number(val);
    },
    render: () => {
        const el = document.getElementById('combo-list');
        el.innerHTML = ComboManager.currentItems.map((item, i) => `
            <div class="combo-item">
                <span style="flex:1"><b>${item.code}</b> ${item.nome}</span>
                <input type="number" value="${item.qty}" min="1" onchange="ComboManager.updateQty(${i}, this.value)" style="width:60px; height:24px; text-align:center;">
                <button onclick="ComboManager.remove(${i})" class="btn-ghost" style="color:red; border:none;">✕</button>
            </div>
        `).join('');
    }
};

const LinkedManager = {
    search: (val) => {
        const res = document.getElementById('linked-results');
        if(val.length < 2) { res.style.display='none'; return; }
        const db = DB.get();
        const matches = db.produto.filter(p => p.nome.toLowerCase().includes(val.toLowerCase()) && p.id !== document.getElementById('p-id').value).slice(0,10);
        res.innerHTML = matches.map(p => `<div class="search-item" onclick="LinkedManager.select('${p.id}', '${p.codigo} - ${p.nome}')">${p.codigo} - ${p.nome}</div>`).join('');
        res.style.display = 'block';
    },
    select: (id, name) => {
        document.getElementById('p-linkedId').value = id;
        document.getElementById('p-linkedName').value = name;
        document.getElementById('linked-results').style.display = 'none';
    },
    clear: () => {
        document.getElementById('p-linkedId').value = '';
        document.getElementById('p-linkedName').value = '';
    }
};

/**
 * CATEGORY MANAGER REVISED (CRUD COMPLETION + SAFETY)
 */
const CatManager = {
    open: () => {
        CatManager.render();
        document.getElementById('modal-cat').showModal();
    },
    
    // --- 1. CREATE ---
    addRoot: () => {
        const input = document.getElementById('new-cat-root');
        const name = input.value.trim();
        if(!name) return;
        const db = DB.get();
        if(db.categorias.some(c => c.nome.toLowerCase() === name.toLowerCase())) {
            alert('Categoria já existe!'); return;
        }
        db.categorias.push({id: Date.now().toString(), nome, subs: []});
        DB.save(db);
        input.value = '';
        CatManager.refreshAll();
    },
    
    addSub: (parentId) => {
        const name = prompt("Nome da Subcategoria:");
        if(!name || !name.trim()) return;
        const db = DB.get();
        const parent = db.categorias.find(c => c.id === parentId);
        if(parent) {
            if(parent.subs.some(s => s.nome.toLowerCase() === name.toLowerCase())) {
                alert('Subcategoria já existe!'); return;
            }
            parent.subs.push({id: Date.now().toString(), nome: name.trim()});
            DB.save(db);
            CatManager.refreshAll();
        }
    },

    // --- 2. UPDATE (New Feature) ---
    rename: (id, oldName, parentId = null) => {
        const newName = prompt("Renomear para:", oldName);
        if(!newName || newName.trim() === '' || newName === oldName) return;

        const db = DB.get();
        let changed = false;

        if(parentId) {
            // Rename Sub
            const parent = db.categorias.find(c => c.id === parentId);
            if(parent) {
                const sub = parent.subs.find(s => s.id === id);
                if(sub) { sub.nome = newName.trim(); changed = true; }
            }
        } else {
            // Rename Root
            const cat = db.categorias.find(c => c.id === id);
            if(cat) { cat.nome = newName.trim(); changed = true; }
        }

        if(changed) {
            DB.save(db);
            CatManager.refreshAll();
            // Optional: Update products using this category string? 
            // Currently products store the string "Root > Sub". 
            // If strict normalization is needed, we would update all products here.
            // For this simpler version, we assume user manages products manually or re-selects.
        }
    },

    // --- 3. DELETE (With Integrity Check) ---
    delete: (id, parentId = null) => {
        const db = DB.get();
        let nameToCheck = '';

        // Integrity Check
        if(parentId) {
            const parent = db.categorias.find(c => c.id === parentId);
            const sub = parent.subs.find(s => s.id === id);
            nameToCheck = sub ? sub.nome : '';
        } else {
            const cat = db.categorias.find(c => c.id === id);
            if(cat && cat.subs.length > 0) {
                alert("Não é possível excluir categoria que possui subcategorias. Exclua as filhas primeiro.");
                return;
            }
            nameToCheck = cat ? cat.nome : '';
        }

        // Check if any product uses this string
        const isUsed = db.produto.some(p => p.categoria && p.categoria.includes(nameToCheck));
        if(isUsed) {
            alert(`Impossível excluir: Existem produtos vinculados à categoria "${nameToCheck}".`);
            return;
        }

        if(!confirm(`Excluir "${nameToCheck}"?`)) return;

        if(parentId) {
            const parent = db.categorias.find(c => c.id === parentId);
            if(parent) parent.subs = parent.subs.filter(s => s.id !== id);
        } else {
            db.categorias = db.categorias.filter(c => c.id !== id);
        }
        
        DB.save(db);
        CatManager.refreshAll();
    },

    // --- UTILS ---
    refreshAll: () => {
        CatManager.render();
        CatManager.populateSelect();
    },

    render: () => {
        const db = DB.get();
        const el = document.getElementById('cat-tree');
        
        if(db.categorias.length === 0) {
            el.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-muted);">Nenhuma categoria cadastrada.</div>';
            return;
        }

        el.innerHTML = db.categorias.map(c => `
            <div class="cat-item">
                <div class="cat-header">
                    <span style="font-weight:700; color:var(--text-main); font-size:0.9rem;">${c.nome}</span>
                    <div class="cat-actions">
                        <button onclick="CatManager.addSub('${c.id}')" class="btn-ghost" title="Nova Sub" style="color:var(--success);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                        </button>
                        <button onclick="CatManager.rename('${c.id}', '${c.nome}')" class="btn-ghost" title="Editar" style="color:var(--primary);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        </button>
                        <button onclick="CatManager.delete('${c.id}')" class="btn-ghost" title="Excluir" style="color:var(--danger);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                        </button>
                    </div>
                </div>
                ${(c.subs && c.subs.length > 0) ? `
                <div class="cat-subs">
                    ${c.subs.map(s => `
                        <div class="sub-item">
                            <span>${s.nome}</span>
                            <div class="cat-actions">
                                <button onclick="CatManager.rename('${s.id}', '${s.nome}', '${c.id}')" class="btn-ghost" style="padding:4px; color:var(--primary);">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button onclick="CatManager.delete('${s.id}', '${c.id}')" class="btn-ghost" style="padding:4px; color:var(--danger);">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>` : ''}
            </div>
        `).join('');
    },
    populateSelect: () => {
        const db = DB.get();
        let html = '<option value="">Sem Categoria</option>';
        db.categorias.forEach(c => {
            html += `<option value="${c.nome}">${c.nome}</option>`;
            (c.subs||[]).forEach(s => {
                html += `<option value="${c.nome} > ${s.nome}">&nbsp;&nbsp;↳ ${s.nome}</option>`;
            });
        });
        const sel = document.getElementById('p-categoria');
        if(sel) sel.innerHTML = html;
    }
};

const Importer = {
    staged: [],
    open: () => document.getElementById('file-input').click(),
    process: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(!Array.isArray(json)) throw new Error("JSON Inválido");
                Importer.analyze(json);
            } catch(err) { alert("Erro: " + err.message); }
        };
        reader.readAsText(file);
        input.value = '';
    },
    analyze: (json) => {
        const db = DB.get();
        Importer.staged = json.map((item, idx) => {
            const ean = (item.cEAN || item.ean || '').trim();
            const nome = (item.xProd || item.nome || '').trim().toUpperCase();
            
            let match = null;

            if(ean && ean !== 'SEM GTIN' && ean !== '') {
                match = db.produto.find(p => {
                    const mainEan = (p.ean||'').trim();
                    const vars = (p.variacoesEan||[]).map(e => e.trim());
                    return mainEan === ean || vars.includes(ean);
                });
            }

            if(!match && nome) {
                match = db.produto.find(p => {
                    const mainName = (p.nome||'').toUpperCase().trim();
                    const vars = (p.variacoesNome||[]).map(n => n.toUpperCase().trim());
                    return mainName === nome || vars.includes(nome);
                });
            }

            return {
                _id: idx,
                importData: item,
                match: match,
                selected: true
            };
        });
        Importer.renderPreview();
        document.getElementById('modal-import').showModal();
    },
    renderPreview: () => {
        const tbody = document.getElementById('import-preview-list');
        tbody.innerHTML = Importer.staged.map(i => {
            const nome = i.importData.xProd || i.importData.nome || '???';
            const status = i.match 
                ? `<span class="badge badge-purple">ATUALIZAR</span>` 
                : `<span class="badge badge-green">NOVO</span>`;
            const ref = i.match ? `${i.match.codigo} - ${i.match.nome}` : '-';
            const qtd = i.importData.Quantidade_Total_Unidades || i.importData.estoque || 0;

            return `
            <tr>
                <td><input type="checkbox" ${i.selected?'checked':''} onchange="Importer.toggleItem(${i._id}, this.checked)"></td>
                <td>${status}</td>
                <td title="${nome}"><div style="width:160px; overflow:hidden; text-overflow:ellipsis;">${nome}</div></td>
                <td><div style="width:120px; overflow:hidden; text-overflow:ellipsis; font-size:0.7rem; color:var(--text-muted);">${ref}</div></td>
                <td><b>${qtd}</b></td>
            </tr>`;
        }).join('');
    },
    toggleItem: (id, val) => {
        const item = Importer.staged.find(x => x._id === id);
        if(item) item.selected = val;
    },
    toggleAll: (val) => {
        Importer.staged.forEach(i => i.selected = val);
        Importer.renderPreview();
    },
    confirm: () => {
        const db = DB.get();
        let countNew = 0, countUpd = 0;
        let currentMaxCode = DB.getMaxIdValue(db.produto);

        Importer.staged.filter(i => i.selected).forEach(i => {
            const data = i.importData;
            const qtd = Number(data.Quantidade_Total_Unidades || data.estoque || 0);
            const custo = Number(data.Custo_Unitario || data.custo || 0);
            const venda = Number(data.Venda || data.valor || 0);
            
            if(i.match) {
                const p = db.produto.find(x => x.id === i.match.id);
                p.estoque += qtd;
                if(custo > 0) p.custo = custo;
                if(venda > 0) p.valor = venda;
                if(data.NCM) p.ncm = data.NCM;
                if(data.CEST) p.cest = data.CEST;
                countUpd++;
            } else {
                currentMaxCode++; 
                const nextCode = `P${String(currentMaxCode).padStart(4, '0')}`;

                const novo = {
                    id: Date.now().toString() + Math.random(),
                    codigo: nextCode,
                    nome: (data.xProd || data.nome || 'NOVO').toUpperCase(),
                    ean: (data.cEAN !== 'SEM GTIN' ? data.cEAN : '') || data.ean || '',
                    fornecedor: '',
                    categoria: data.categoria || '',
                    estoque: qtd,
                    estoqueFiscal: qtd,
                    custo: custo,
                    valor: venda,
                    ncm: data.NCM || '',
                    cest: data.CEST || '',
                    cfop: data.CFOP_SAIDA || '',
                    unidade: data.uCom || data.unidade || 'UN',
                    variacoesEan: [], variacoesNome: [], batches: [], items: [], isCombo: false, isOffer: false
                };
                db.produto.push(novo);
                countNew++;
            }
        });

        DB.save(db);
        document.getElementById('modal-import').close();
        App.renderList();
        alert(`Sucesso!\nNovos: ${countNew}\nAtualizados: ${countUpd}`);
    }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
