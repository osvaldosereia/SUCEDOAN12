<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V7 | Smart Combo</title>
    
    <style>
        /* --- 1. CORE STYLES --- */
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --radius: 6px;
            --font-sys: system-ui, -apple-system, sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body {
            font-family: var(--font-sys);
            background-color: var(--bg);
            color: var(--text-main);
            line-height: 1.4;
            padding-bottom: 80px;
        }

        /* --- 2. LAYOUT --- */
        header {
            background: var(--surface);
            padding: 0.8rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 40;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        h1 { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 10px; color: var(--primary); }

        main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1200px) {
            main { grid-template-columns: 450px 1fr; align-items: start; }
        }

        /* --- 3. COMPONENTS --- */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: 0 1px 3px rgba(0,0,0,0.05); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { background: #f1f5f9; padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; }
        .card-body { padding: 15px; }

        /* Forms */
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .form-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .form-group { margin-bottom: 10px; }

        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 8px 10px; font-size: 0.9rem; border: 1px solid #cbd5e1; border-radius: var(--radius); background: #fff; transition: 0.15s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        input[readonly] { background: #f1f5f9; color: var(--text-muted); cursor: not-allowed; }
        textarea { resize: vertical; min-height: 60px; font-family: monospace; font-size: 0.8rem; }

        .section-divider {
            margin: 15px 0 10px 0;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 5px;
            color: var(--primary);
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 14px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; border-radius: var(--radius); border: none; cursor: pointer; transition: 0.2s; }
        .btn-block { width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: #f8fafc; border-color: #cbd5e1; color: var(--text-main); }
        .btn-danger { color: var(--danger); background: transparent; border: 1px solid transparent; }
        .btn-danger:hover { background: #fef2f2; }
        .btn-icon { padding: 6px; width: 32px; height: 32px; }

        /* Table & Badges */
        .table-container { overflow-x: auto; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; white-space: nowrap; }
        th { text-align: left; padding: 10px; background: #f8fafc; color: var(--text-muted); border-bottom: 2px solid var(--border); font-weight: 700; position: sticky; top: 0; z-index: 10; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: #f1f5f9; }

        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-gray { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }

        /* Combo Specifics */
        .combo-box { background: #eff6ff; padding: 10px; border: 1px dashed #bfdbfe; border-radius: 6px; margin-top: 5px; display: none; }
        .search-results { position: absolute; background: white; width: 100%; max-height: 180px; overflow-y: auto; border: 1px solid var(--border); z-index: 50; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px; display: none; }
        .search-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        .search-item:hover { background: #f8fafc; color: var(--primary); }
        
        .paste-area {
            width: 100%; height: 100px; 
            border: 1px solid #cbd5e1; border-radius: 4px; 
            padding: 8px; font-family: monospace; font-size: 0.8rem;
            margin-bottom: 5px;
        }

        /* Modal */
        dialog { margin: auto; border: none; border-radius: 8px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); width: 90%; max-width: 700px; padding: 0; }
        dialog::backdrop { background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px); }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }

        /* Category Tree */
        .tree-node { border: 1px solid var(--border); border-radius: 4px; margin-bottom: 5px; overflow: hidden; background: white; }
        .tree-head { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; cursor: default; }
        .tree-subs { padding: 5px 0 5px 20px; border-top: 1px solid var(--border); display: none; }
        .tree-subs.open { display: block; }
        .sub-node { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px dashed #e2e8f0; font-size: 0.85rem; }

        /* Filters */
        .filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 8px; padding: 10px; background: #f1f5f9; border-bottom: 1px solid var(--border); }
    </style>
</head>
<body>

<header>
    <h1>üìã CAT√ÅLOGO PRO V7</h1>
    <div style="display:flex; gap:8px;">
        <button onclick="CatManager.open()" class="btn btn-ghost">üìÇ Categorias</button>
        <button onclick="Importer.open()" class="btn btn-ghost">üì• Importar JSON</button>
        <button onclick="App.exportData()" class="btn btn-primary">üíæ Exportar JSON</button>
    </div>
</header>

<main>
    <section class="card">
        <div class="card-header">
            <span id="form-title">Novo Produto</span>
            <button onclick="App.resetForm()" class="btn btn-ghost btn-icon" title="Limpar">‚Üª</button>
        </div>
        <div class="card-body">
            <form id="form-prod" onsubmit="App.save(event)">
                <input type="hidden" id="p-id">
                <input type="hidden" id="p-dataCadastro">
                
                <div class="form-grid-3">
                    <div><label>C√≥digo</label><input type="text" id="p-codigo" readonly placeholder="Auto" style="font-weight:700;"></div>
                    <div style="grid-column: span 2;"><label>EAN / GTIN</label><input type="text" id="p-ean"></div>
                </div>
                <div class="form-group"><label>Nome do Produto</label><input type="text" id="p-nome" required style="font-weight:600;"></div>
                <div class="form-grid-2">
                    <div><label>Fornecedor</label><input type="text" id="p-fornecedor" list="dl-fornecedores"><datalist id="dl-fornecedores"></datalist></div>
                    <div><label>Categoria</label><select id="p-categoria"><option value="">Sem Categoria</option></select></div>
                </div>
                <div class="form-grid-2">
                    <div><label>Unidade</label><input type="text" id="p-unidade" placeholder="UN, CX, KG"></div>
                    <div><label>Imagem</label><input type="text" id="p-imageName" placeholder="foto.jpg"></div>
                </div>

                <div class="section-divider"><span>üí∞ Custos & Pre√ßos</span></div>
                <div class="form-grid-3">
                    <div><label>Custo (R$)</label><input type="number" id="p-custo" step="0.01" oninput="App.calcMargin()"></div>
                    <div><label>Margem</label><input type="text" id="p-margem" readonly style="text-align:center;"></div>
                    <div><label style="color:var(--primary)">Venda (R$)</label><input type="number" id="p-valor" step="0.01" oninput="App.calcMargin()" required></div>
                </div>
                <div style="background:#fff7ed; padding:10px; border:1px solid #ffedd5; border-radius:6px; margin-top:8px; display:flex; gap:10px; align-items:center;">
                    <div style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="p-isOffer" style="width:auto;"><label for="p-isOffer" style="margin:0; color:var(--warning); cursor:pointer;">EM OFERTA</label></div>
                    <div style="flex:1"><input type="number" id="p-offerPrice" placeholder="Pre√ßo Promocional (R$)" step="0.01"></div>
                </div>

                <div class="section-divider"><span>üì¶ Log√≠stica</span></div>
                <div class="form-grid-2">
                    <div><label>Estoque F√≠sico</label><input type="number" id="p-estoque" required style="font-weight:700;"></div>
                    <div><label>Estoque Fiscal</label><input type="number" id="p-estoqueFiscal"></div>
                </div>
                <div class="form-grid-3">
                    <div><label>Estoque M√≠n.</label><input type="number" id="p-limit"></div>
                    <div><label>Peso Bruto</label><input type="number" id="p-peso" step="0.001"></div>
                    <div><label>Peso L√≠q.</label><input type="number" id="p-pesoLiq" step="0.001"></div>
                </div>
                <div style="margin-top:10px; border:1px solid var(--border); padding:10px; border-radius:6px; background:#f8fafc;">
                    <label style="margin-bottom:5px;">Lotes (Validade | Quantidade)</label>
                    <div id="batch-container"></div>
                </div>

                <div class="section-divider"><span>‚öñÔ∏è Fiscal</span></div>
                <div class="form-grid-3">
                    <div><label>NCM</label><input type="text" id="p-ncm"></div>
                    <div><label>CEST</label><input type="text" id="p-cest"></div>
                    <div><label>CFOP</label><input type="text" id="p-cfop"></div>
                </div>

                <div class="section-divider">
                    <span>üîó Kit / Combo</span>
                    <div style="display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="p-isCombo" style="width:auto;" onchange="ComboManager.toggle(this.checked)">
                        <label for="p-isCombo" style="margin:0; cursor:pointer;">Ativar</label>
                    </div>
                </div>
                
                <div id="combo-area" class="combo-box">
                    <div style="margin-bottom:15px; border-bottom:1px dashed #bfdbfe; padding-bottom:10px;">
                        <label style="color:var(--primary);">üìã Colar Lista (Formato: 1x Nome do Produto)</label>
                        <textarea id="combo-paste" class="paste-area" placeholder="Exemplo:&#10;1x Arroz Tio Jo√£o 5kg&#10;2x Feij√£o Carioca 1kg"></textarea>
                        <button type="button" onclick="ComboManager.processPaste()" class="btn btn-primary btn-block">Processar Lista</button>
                    </div>

                    <div style="position:relative;">
                        <input type="text" id="combo-search" placeholder="Ou busque manualmente..." oninput="ComboManager.search(this.value)">
                        <div id="combo-results" class="search-results"></div>
                    </div>
                    
                    <div id="combo-list" style="margin-top:10px;"></div>
                </div>

                <div class="section-divider"><span>üîÄ Varia√ß√µes & V√≠nculos</span></div>
                <div class="form-group"><label>EANs Extras ( | )</label><textarea id="p-variacoesEan" style="height:40px;"></textarea></div>
                <div class="form-group"><label>Nomes Alternativos ( | )</label><textarea id="p-variacoesNome" style="height:40px;"></textarea></div>

                <div class="form-grid-2" style="align-items:end;">
                    <div style="position:relative;">
                        <label>Vincular a Produto Pai</label>
                        <input type="hidden" id="p-linkedId">
                        <input type="text" id="p-linkedName" placeholder="Buscar pai..." oninput="LinkedManager.search(this.value)">
                        <div id="linked-results" class="search-results"></div>
                    </div>
                    <button type="button" onclick="LinkedManager.clear()" class="btn btn-ghost">Desvincular</button>
                </div>

                <div style="margin-top:25px;">
                    <button type="submit" class="btn btn-primary btn-block" style="padding:12px;">üíæ SALVAR PRODUTO</button>
                </div>
            </form>
        </div>
    </section>

    <section class="card" style="height:fit-content; min-height:600px;">
        <div class="card-header">
            <span>Listagem Global</span>
            <span class="badge bg-gray" id="total-count">0 PRODUTOS</span>
        </div>
        <div class="filters">
            <input type="text" id="f-search" oninput="App.renderList()" placeholder="üîç Buscar...">
            <select id="f-cat" onchange="App.renderList()"><option value="">Todas Categorias</option></select>
            <select id="f-forn" onchange="App.renderList()"><option value="">Todos Fornecedores</option></select>
            <input type="number" id="f-stock" oninput="App.renderList()" placeholder="üìâ Estoque Teto">
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Produto / C√≥d.</th>
                        <th>Categoria</th>
                        <th>Pre√ßo</th>
                        <th>Estoque</th>
                        <th style="text-align:right;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="prod-list"></tbody>
            </table>
        </div>
    </section>
</main>

<dialog id="modal-cat">
    <div style="padding:15px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center; background:#f8fafc;">
        <span style="font-weight:700;">Gerenciar Categorias</span>
        <button onclick="document.getElementById('modal-cat').close()" class="btn btn-ghost btn-icon">‚úï</button>
    </div>
    <div class="modal-body">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <input type="text" id="new-cat-root" placeholder="Nova Categoria Principal...">
            <button onclick="CatManager.addRoot()" class="btn btn-primary">Adicionar</button>
        </div>
        <div id="cat-tree"></div>
    </div>
</dialog>

<input type="file" id="file-input" accept=".json" style="display:none;" onchange="Importer.run(this)">

<script>
/**
 * SISTEMA V7 - SMART COMBO
 */

const DB = {
    key: 'sys_v7_combo',
    get: () => {
        const raw = localStorage.getItem(DB.key);
        const data = raw ? JSON.parse(raw) : { produto: [], categorias: [] };
        if(data.categorias) data.categorias.forEach(c => { if(!Array.isArray(c.subs)) c.subs = []; });
        return data;
    },
    save: (data) => localStorage.setItem(DB.key, JSON.stringify(data)),
    nextCode: () => {
        const db = DB.get();
        const max = db.produto.reduce((acc, p) => Math.max(acc, parseInt((p.codigo||'').replace(/\D/g,'')||0)), 0);
        return `P${String(max + 1).padStart(4, '0')}`;
    }
};

const App = {
    init: () => {
        App.renderBatches();
        CatManager.refreshSelects();
        App.renderList();
    },

    save: (e) => {
        e.preventDefault();
        const db = DB.get();
        const id = document.getElementById('p-id').value;
        const now = new Date().toISOString();

        let codigo = document.getElementById('p-codigo').value;
        if(!id && !codigo) codigo = DB.nextCode();

        let batches = [];
        for(let i=0; i<3; i++){
            let d = document.getElementById(`batch-d-${i}`).value;
            let q = Number(document.getElementById(`batch-q-${i}`).value);
            if(d && q > 0) batches.push({date: d, qty: q});
        }

        const prod = {
            id: id || Date.now().toString(),
            dataCadastro: document.getElementById('p-dataCadastro').value || now,
            ultimaAtualizacao: now,
            codigo: codigo,
            ean: document.getElementById('p-ean').value.trim(),
            nome: document.getElementById('p-nome').value.trim().toUpperCase(),
            fornecedor: document.getElementById('p-fornecedor').value.toUpperCase(),
            categoria: document.getElementById('p-categoria').value,
            unidade: document.getElementById('p-unidade').value,
            imageName: document.getElementById('p-imageName').value,
            custo: Number(document.getElementById('p-custo').value)||0,
            valor: Number(document.getElementById('p-valor').value)||0,
            isOffer: document.getElementById('p-isOffer').checked,
            offerPrice: Number(document.getElementById('p-offerPrice').value)||0,
            estoque: Number(document.getElementById('p-estoque').value)||0,
            estoqueFiscal: Number(document.getElementById('p-estoqueFiscal').value)||0,
            limit: Number(document.getElementById('p-limit').value)||0,
            peso: Number(document.getElementById('p-peso').value)||0,
            pesoLiq: Number(document.getElementById('p-pesoLiq').value)||0,
            batches: batches,
            isCombo: document.getElementById('p-isCombo').checked,
            items: ComboManager.currentItems,
            variacoesEan: document.getElementById('p-variacoesEan').value.split('|').map(s=>s.trim()).filter(Boolean),
            variacoesNome: document.getElementById('p-variacoesNome').value.split('|').map(s=>s.trim()).filter(Boolean),
            linkedProdId: document.getElementById('p-linkedId').value,
            linkedProdCode: document.getElementById('p-linkedName').value,
            ncm: document.getElementById('p-ncm').value,
            cest: document.getElementById('p-cest').value,
            cfop: document.getElementById('p-cfop').value
        };

        if(id) {
            const idx = db.produto.findIndex(p => p.id === id);
            if(idx > -1) db.produto[idx] = prod;
        } else {
            db.produto.unshift(prod);
        }

        DB.save(db);
        App.resetForm();
        App.renderList();
        alert('Salvo!');
    },

    edit: (id) => {
        const db = DB.get();
        const p = db.produto.find(x => x.id === id);
        if(!p) return;

        document.getElementById('p-id').value = p.id;
        document.getElementById('p-dataCadastro').value = p.dataCadastro || '';
        document.getElementById('p-codigo').value = p.codigo;
        document.getElementById('p-ean').value = p.ean || '';
        document.getElementById('p-nome').value = p.nome;
        document.getElementById('p-fornecedor').value = p.fornecedor || '';
        document.getElementById('p-categoria').value = p.categoria || '';
        document.getElementById('p-unidade').value = p.unidade || '';
        document.getElementById('p-imageName').value = p.imageName || '';
        
        document.getElementById('p-custo').value = p.custo;
        document.getElementById('p-valor').value = p.valor;
        document.getElementById('p-isOffer').checked = p.isOffer || false;
        document.getElementById('p-offerPrice').value = p.offerPrice || '';
        
        document.getElementById('p-estoque').value = p.estoque;
        document.getElementById('p-estoqueFiscal').value = p.estoqueFiscal || '';
        document.getElementById('p-limit').value = p.limit || '';
        document.getElementById('p-peso').value = p.peso || '';
        document.getElementById('p-pesoLiq').value = p.pesoLiq || '';
        
        document.getElementById('p-ncm').value = p.ncm || '';
        document.getElementById('p-cest').value = p.cest || '';
        document.getElementById('p-cfop').value = p.cfop || '';
        
        document.getElementById('p-variacoesEan').value = (p.variacoesEan || []).join(' | ');
        document.getElementById('p-variacoesNome').value = (p.variacoesNome || []).join(' | ');
        document.getElementById('p-linkedId').value = p.linkedProdId || '';
        document.getElementById('p-linkedName').value = p.linkedProdCode || '';

        App.renderBatches(p.batches || []);
        
        document.getElementById('p-isCombo').checked = p.isCombo || false;
        ComboManager.currentItems = p.items || [];
        ComboManager.toggle(p.isCombo || false);

        App.calcMargin();
        document.getElementById('form-title').innerText = `Editando: ${p.codigo}`;
        window.scrollTo({top: 0, behavior: 'smooth'});
    },

    delete: (id) => {
        if(!confirm('Excluir?')) return;
        const db = DB.get();
        db.produto = db.produto.filter(p => p.id !== id);
        DB.save(db);
        App.renderList();
    },

    resetForm: () => {
        document.getElementById('form-prod').reset();
        document.getElementById('p-id').value = '';
        document.getElementById('p-codigo').value = '';
        document.getElementById('p-dataCadastro').value = '';
        document.getElementById('p-margem').value = '';
        document.getElementById('form-title').innerText = 'Novo Produto';
        ComboManager.currentItems = [];
        ComboManager.toggle(false);
        App.renderBatches();
    },

    renderBatches: (existing = []) => {
        let html = '';
        for(let i=0; i<3; i++){
            let b = existing[i] || {date:'', qty:''};
            html += `<div style="display:flex; gap:5px; margin-bottom:4px;"><input type="date" id="batch-d-${i}" value="${b.date}" style="flex:2"><input type="number" id="batch-q-${i}" value="${b.qty}" placeholder="Qtd" style="flex:1"></div>`;
        }
        document.getElementById('batch-container').innerHTML = html;
    },

    calcMargin: () => {
        const c = Number(document.getElementById('p-custo').value);
        const v = Number(document.getElementById('p-valor').value);
        if(c > 0 && v > 0) {
            const m = ((v - c) / c) * 100;
            const el = document.getElementById('p-margem');
            el.value = m.toFixed(1) + '%';
            el.style.color = m < 0 ? 'red' : 'green';
            el.style.fontWeight = 'bold';
        } else {
            document.getElementById('p-margem').value = '-';
        }
    },

    renderList: () => {
        const db = DB.get();
        
        const selForn = document.getElementById('f-forn');
        if(selForn.options.length === 1) {
            const forns = [...new Set(db.produto.map(p => p.fornecedor).filter(Boolean))].sort();
            forns.forEach(f => {
                selForn.innerHTML += `<option value="${f}">${f}</option>`;
                document.getElementById('dl-fornecedores').innerHTML += `<option value="${f}">`;
            });
        }

        const term = document.getElementById('f-search').value.toLowerCase();
        const cat = document.getElementById('f-cat').value;
        const forn = document.getElementById('f-forn').value;
        const stockTeto = document.getElementById('f-stock').value;

        let list = db.produto.filter(p => {
            const txt = [p.nome, p.codigo, p.ean].join(' ').toLowerCase();
            if(term && !txt.includes(term)) return false;
            if(cat && p.categoria !== cat) return false;
            if(forn && p.fornecedor !== forn) return false;
            if(stockTeto !== '' && p.estoque > Number(stockTeto)) return false;
            return true;
        });

        document.getElementById('total-count').innerText = `${list.length} PRODUTOS`;

        document.getElementById('prod-list').innerHTML = list.slice(0, 50).map(p => {
            const stockClass = p.estoque <= 0 ? 'bg-red' : (p.estoque <= (p.limit||5) ? 'bg-gray' : 'bg-green');
            return `
            <tr>
                <td>
                    <div style="font-weight:700;">${p.nome}</div>
                    <div style="font-size:0.75rem; color:var(--text-muted);">${p.codigo} ${p.ean ? '| '+p.ean : ''}</div>
                </td>
                <td><span class="badge bg-gray">${p.categoria ? p.categoria.split('>').pop().trim() : '-'}</span></td>
                <td>${p.isOffer ? `<span style="color:red; font-weight:bold;">R$ ${p.offerPrice.toFixed(2)}</span>` : `R$ ${p.valor.toFixed(2)}`}</td>
                <td><span class="badge ${stockClass}">${p.estoque}</span></td>
                <td style="text-align:right;">
                    <button onclick="App.edit('${p.id}')" class="btn btn-ghost btn-icon">‚úé</button>
                    <button onclick="App.delete('${p.id}')" class="btn btn-danger btn-icon">‚úï</button>
                </td>
            </tr>`;
        }).join('');
    },

    exportData: () => {
        const db = DB.get();
        const now = new Date();
        const day = String(now.getDate()).padStart(2,'0');
        const month = String(now.getMonth()+1).padStart(2,'0');
        const year = now.getFullYear();
        const fileName = `produtos-${day}-${month}-${year}.json`;
        const blobFull = new Blob([JSON.stringify(db, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blobFull);
        a.download = fileName;
        a.click();
    }
};

/* --- COMBO INTELIGENTE --- */
const ComboManager = {
    currentItems: [],
    toggle: (checked) => {
        document.getElementById('combo-area').style.display = checked ? 'block' : 'none';
        if(checked) ComboManager.render();
    },
    // LOGICA DE PROCESSAMENTO DE LISTA COLADA
    processPaste: () => {
        const text = document.getElementById('combo-paste').value;
        if(!text.trim()) return;

        const db = DB.get();
        const lines = text.split('\n');
        let addedCount = 0;
        let notFound = [];

        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            // Regex para capturar "1x Nome do Produto" ou "1X Nome"
            // Grupo 1: Quantidade (digitos)
            // Grupo 2: Nome (resto da linha)
            const match = line.match(/^(\d+)[xX]\s+(.+)$/);

            if(match) {
                const qty = parseInt(match[1]);
                const name = match[2].trim().toUpperCase();

                // Busca exata pelo nome
                const product = db.produto.find(p => p.nome === name);

                if(product) {
                    ComboManager.add(product.id, product.codigo, product.nome, qty);
                    addedCount++;
                } else {
                    notFound.push(name);
                }
            }
        });

        document.getElementById('combo-paste').value = ''; // Limpa
        
        let msg = `Processado! ${addedCount} itens adicionados.`;
        if(notFound.length > 0) {
            msg += `\n\nN√ÉO ENCONTRADOS:\n- ${notFound.join('\n- ')}`;
        }
        alert(msg);
    },
    search: (val) => {
        const res = document.getElementById('combo-results');
        if(val.length < 2) { res.style.display='none'; return; }
        const db = DB.get();
        const matches = db.produto.filter(p => p.nome.toLowerCase().includes(val.toLowerCase())).slice(0,5);
        res.innerHTML = matches.map(p => `<div class="search-item" onclick="ComboManager.add('${p.id}', '${p.codigo}', '${p.nome}', 1)">${p.nome}</div>`).join('');
        res.style.display = 'block';
    },
    add: (id, code, name, qty) => {
        const idx = ComboManager.currentItems.findIndex(i => i.id === id);
        if(idx > -1) {
            ComboManager.currentItems[idx].qty += qty;
        } else {
            ComboManager.currentItems.push({id, code, nome: name, qty: qty});
        }
        ComboManager.render();
        document.getElementById('combo-search').value = '';
        document.getElementById('combo-results').style.display = 'none';
    },
    remove: (idx) => {
        ComboManager.currentItems.splice(idx, 1);
        ComboManager.render();
    },
    render: () => {
        document.getElementById('combo-list').innerHTML = ComboManager.currentItems.map((item, i) => `
            <div style="display:flex; justify-content:space-between; align-items:center; background:#fff; padding:6px; border:1px solid #e2e8f0; border-radius:4px; margin-bottom:4px; font-size:0.8rem;">
                <span>${item.nome}</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <input type="number" value="${item.qty}" min="1" style="width:50px; padding:2px; height:24px;" onchange="ComboManager.currentItems[${i}].qty=Number(this.value)">
                    <button onclick="ComboManager.remove(${i})" class="btn btn-danger btn-icon" style="width:24px; height:24px; padding:0;">‚úï</button>
                </div>
            </div>
        `).join('');
    }
};

const LinkedManager = {
    search: (val) => {
        const res = document.getElementById('linked-results');
        if(val.length < 2) { res.style.display='none'; return; }
        const db = DB.get();
        const matches = db.produto.filter(p => p.nome.toLowerCase().includes(val.toLowerCase())).slice(0,5);
        res.innerHTML = matches.map(p => `<div class="search-item" onclick="LinkedManager.select('${p.id}', '${p.codigo} - ${p.nome}')">${p.codigo} - ${p.nome}</div>`).join('');
        res.style.display = 'block';
    },
    select: (id, name) => {
        document.getElementById('p-linkedId').value = id;
        document.getElementById('p-linkedName').value = name;
        document.getElementById('linked-results').style.display = 'none';
    },
    clear: () => {
        document.getElementById('p-linkedId').value = '';
        document.getElementById('p-linkedName').value = '';
    }
};

/* --- CATEGORIAS --- */
const CatManager = {
    open: () => {
        CatManager.render();
        document.getElementById('modal-cat').showModal();
    },
    refreshSelects: () => {
        const db = DB.get();
        let html = '<option value="">Sem Categoria</option>';
        let filterHtml = '<option value="">Todas Categorias</option>';
        db.categorias.forEach(c => {
            html += `<option value="${c.nome}">${c.nome}</option>`;
            filterHtml += `<option value="${c.nome}">${c.nome}</option>`;
            (c.subs || []).forEach(s => {
                const val = `${c.nome} > ${s.nome}`;
                html += `<option value="${val}">&nbsp;&nbsp;‚Ü≥ ${s.nome}</option>`;
                filterHtml += `<option value="${val}">&nbsp;&nbsp;‚Ü≥ ${s.nome}</option>`;
            });
        });
        const sel = document.getElementById('p-categoria');
        const selFiltro = document.getElementById('f-cat');
        if(sel) { const old = sel.value; sel.innerHTML = html; sel.value = old; }
        if(selFiltro) { const old = selFiltro.value; selFiltro.innerHTML = filterHtml; selFiltro.value = old; }
    },
    addRoot: () => {
        const input = document.getElementById('new-cat-root');
        const name = input.value.trim().toUpperCase();
        if(!name) return;
        const db = DB.get();
        if(db.categorias.some(c => c.nome === name)) return alert('Existe!');
        db.categorias.push({ id: Date.now(), nome: name, subs: [] });
        DB.save(db);
        input.value = '';
        CatManager.refreshAll();
    },
    addSub: (parentId) => {
        const name = prompt("Nome da Subcategoria:");
        if(!name) return;
        const db = DB.get();
        const parent = db.categorias.find(c => c.id == parentId);
        if(parent) {
            if(!Array.isArray(parent.subs)) parent.subs = [];
            parent.subs.push({ id: Date.now(), nome: name.trim().toUpperCase() });
            DB.save(db);
            CatManager.refreshAll();
        }
    },
    delete: (id, parentId) => {
        const db = DB.get();
        let checkName = '';
        if(parentId) {
            const p = db.categorias.find(c => c.id == parentId);
            const s = p.subs.find(x => x.id == id);
            if(s) checkName = `${p.nome} > ${s.nome}`;
        } else {
            const c = db.categorias.find(c => c.id == id);
            if(c) {
                if(c.subs.length > 0) return alert('Exclua subs primeiro.');
                checkName = c.nome;
            }
        }
        if(db.produto.some(p => p.categoria && p.categoria.includes(checkName))) return alert('Categoria em uso.');
        if(!confirm('Excluir?')) return;
        if(parentId) {
            const p = db.categorias.find(c => c.id == parentId);
            p.subs = p.subs.filter(x => x.id != id);
        } else {
            db.categorias = db.categorias.filter(x => x.id != id);
        }
        DB.save(db);
        CatManager.refreshAll();
    },
    rename: (id, oldName, parentId) => {
        const newName = prompt("Novo nome:", oldName);
        if(!newName || newName === oldName) return;
        const upper = newName.trim().toUpperCase();
        const db = DB.get();
        let oldStr = '', newStr = '';
        if(parentId) {
            const p = db.categorias.find(c => c.id == parentId);
            const s = p.subs.find(x => x.id == id);
            oldStr = `${p.nome} > ${s.nome}`;
            s.nome = upper;
            newStr = `${p.nome} > ${upper}`;
        } else {
            const c = db.categorias.find(c => c.id == id);
            oldStr = c.nome;
            c.nome = upper;
            newStr = upper;
        }
        db.produto.forEach(p => {
            if(p.categoria === oldStr) p.categoria = newStr;
            else if(p.categoria.startsWith(oldStr + ' >')) p.categoria = p.categoria.replace(oldStr, newStr);
        });
        DB.save(db);
        CatManager.refreshAll();
        App.renderList();
    },
    refreshAll: () => { CatManager.render(); CatManager.refreshSelects(); },
    render: () => {
        const db = DB.get();
        const div = document.getElementById('cat-tree');
        if(!db.categorias.length) { div.innerHTML='<div style="text-align:center;color:#ccc">Vazio</div>'; return; }
        div.innerHTML = db.categorias.map(c => `
            <div class="tree-node">
                <div class="tree-head">
                    <b>${c.nome}</b>
                    <div style="display:flex;gap:5px;">
                        <button onclick="CatManager.addSub(${c.id})" class="btn btn-ghost btn-icon" style="color:green;">Ôºã</button>
                        <button onclick="CatManager.rename(${c.id}, '${c.nome}')" class="btn btn-ghost btn-icon">‚úé</button>
                        <button onclick="CatManager.delete(${c.id})" class="btn btn-ghost btn-icon" style="color:red;">‚úï</button>
                    </div>
                </div>
                <div class="tree-subs ${(c.subs&&c.subs.length>0)?'open':''}">
                    ${(c.subs||[]).map(s => `
                        <div class="sub-node">
                            <span>‚Ü≥ ${s.nome}</span>
                            <div style="display:flex;gap:5px;">
                                <button onclick="CatManager.rename(${s.id}, '${s.nome}', ${c.id})" class="btn btn-ghost btn-icon">‚úé</button>
                                <button onclick="CatManager.delete(${s.id}, ${c.id})" class="btn btn-ghost btn-icon" style="color:red;">‚úï</button>
                            </div>
                        </div>`).join('')}
                </div>
            </div>`).join('');
    }
};

const Importer = {
    open: () => document.getElementById('file-input').click(),
    run: (input) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                let newData = { produto: [], categorias: [] };
                if(Array.isArray(json)) { newData.produto = json; newData.categorias = DB.get().categorias; }
                else if (json.produto || json.categorias) { newData = json; if(!newData.produto) newData.produto=[]; if(!newData.categorias) newData.categorias=[]; }
                if(confirm(`Importar ${newData.produto.length} produtos? Substituir√° dados atuais.`)) {
                    DB.save(newData); location.reload();
                }
            } catch(err) { alert("Erro JSON: " + err.message); }
        };
        reader.readAsText(file);
        input.value = '';
    }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
