<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V1 - CRM & Estrat√©gia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilo Base & Scroll */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { max-width: 1800px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        
        /* Scrollbars finas */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .btn-zap { transition: all 0.2s; }
        .btn-zap:hover { transform: scale(1.1); }
        
        /* Tabela de An√°lise */
        .table-strategy th { position: sticky; top: 0; background: #f9fafb; z-index: 10; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; padding: 8px; border-bottom: 2px solid #e5e7eb; }
        .table-strategy td { padding: 8px; font-size: 0.85rem; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .table-strategy tr:hover { background-color: #f8fafc; }

        /* Anima√ß√£o para os Paineis Expans√≠veis */
        .panel-expand { animation: slideDown 0.2s ease-out forwards; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="app-container p-4">
        
        <!-- 1. Cabe√ßalho (Navega√ß√£o) -->
        <header class="bg-white shadow-sm rounded-lg p-2 mb-3 flex justify-between items-center border border-gray-200 shrink-0">
            <div class="flex items-center gap-4">
                <div class="bg-purple-600 text-white p-2 rounded">
                    <i class="fa-solid fa-chart-pie"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-gray-700 leading-tight">M√≥dulo 3: Intelig√™ncia</h1>
                    <p class="text-[10px] text-gray-500">Gest√£o Estrat√©gica de Carteira</p>
                </div>
            </div>
            
            <nav class="flex gap-2">
                <button onclick="window.location.href='https://donaantonia.com.br/cadastro'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-medium transition">
                    1. Cadastro
                </button>
                <button onclick="window.location.href='https://donaantonia.com.br/vendas'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-medium transition">
                    2. Vendas
                </button>
                <button onclick="window.location.href='https://donaantonia.com.br/crm'" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-medium shadow-sm">
                    3. CRM
                </button>
            </nav>

            <div class="flex gap-2">
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importarDadosExternos(this)" multiple>
                <button onclick="document.getElementById('importInput').click()" class="border border-gray-300 text-gray-600 px-3 py-1 rounded text-xs hover:bg-gray-50" title="Importar JSON">
                    <i class="fa-solid fa-upload mr-1"></i>
                </button>
                <button onclick="atualizarDados()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 shadow-sm">
                    <i class="fa-solid fa-sync mr-1"></i> Atualizar
                </button>
            </div>
        </header>

        <!-- 2. Barra de Filtros (Controla Coluna 1 e 4) -->
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-3 flex items-center gap-4 shrink-0">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-filter text-gray-400"></i>
                <span class="text-xs font-bold text-gray-700 uppercase">Per√≠odo de An√°lise:</span>
            </div>
            <div class="flex items-center gap-2">
                <input type="date" id="dataInicio" class="border border-gray-300 rounded px-2 py-1 text-xs" onchange="aplicarFiltros()">
                <span class="text-gray-400 text-xs">at√©</span>
                <input type="date" id="dataFim" class="border border-gray-300 rounded px-2 py-1 text-xs" onchange="aplicarFiltros()">
            </div>
            <button onclick="definirMesAtual()" class="text-xs text-blue-600 hover:underline font-medium">Este M√™s</button>
            
            <div class="ml-auto flex gap-6 text-sm">
                <div class="flex flex-col items-end leading-tight">
                    <span class="text-[10px] text-gray-500 uppercase">Faturamento Filtrado</span>
                    <span id="resumoTotal" class="font-bold text-gray-800 text-lg">R$ 0,00</span>
                </div>
                <div class="flex flex-col items-end leading-tight border-l pl-4 border-gray-200">
                    <span class="text-[10px] text-gray-500 uppercase">Volume Vendas</span>
                    <span id="resumoQtd" class="font-bold text-gray-800 text-lg">0</span>
                </div>
            </div>
        </div>

        <!-- 3. √ÅREA PRINCIPAL (GRID 4 COLUNAS) -->
        <div class="grid grid-cols-12 gap-3 flex-1 overflow-hidden min-h-0">
            
            <!-- COLUNA 1: VENDAS (3/12) -->
            <div class="col-span-3 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-gray-100 bg-blue-50 flex justify-between items-center shrink-0">
                    <div>
                        <h2 class="font-bold text-blue-800 text-sm uppercase"><i class="fa-solid fa-receipt mr-2"></i>Vendas</h2>
                        <p class="text-[10px] text-blue-600">Listagem do per√≠odo selecionado</p>
                    </div>
                    <span class="bg-blue-200 text-blue-800 text-xs font-bold px-2 py-1 rounded-full" id="countPosVenda">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 bg-gray-50 custom-scroll">
                    <div id="listaPosVenda" class="flex flex-col gap-2">
                        <!-- Itens inseridos via JS -->
                    </div>
                </div>
            </div>

            <!-- COLUNA 2: RADAR DE INATIVOS (3/12) -->
            <div class="col-span-3 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-gray-100 bg-red-50 flex flex-col gap-2 shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="font-bold text-red-800 text-sm uppercase"><i class="fa-solid fa-heart-crack mr-2"></i>Radar Inativos</h2>
                        <div class="flex items-center bg-white rounded border border-red-200 px-2 py-1">
                            <span class="text-[10px] text-red-400 mr-2">Dias ></span>
                            <input type="number" id="diasInativo" value="30" class="w-10 text-center text-xs font-bold text-red-700 outline-none" onchange="renderizarRadar()">
                        </div>
                    </div>
                    <p class="text-[10px] text-red-600">Clientes sem comprar baseados na data de hoje.</p>
                </div>
                <div class="flex-1 overflow-y-auto p-0 bg-white custom-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-[10px] sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-2 border-b">Cliente</th>
                                <th class="p-2 text-center border-b">Dias Off</th>
                                <th class="p-2 text-center border-b">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="listaRadar" class="text-xs divide-y divide-gray-100">
                            <!-- Inserido via JS -->
                        </tbody>
                    </table>
                    <div id="emptyRadar" class="hidden text-center text-gray-400 p-8">
                        <i class="fa-regular fa-thumbs-up text-2xl mb-2"></i>
                        <p class="text-xs">Todos clientes ativos!</p>
                    </div>
                </div>
            </div>

            <!-- COLUNA 3: CUPONS ATIVOS (NOVA - 2/12) -->
            <div class="col-span-2 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-2 border-b border-gray-100 bg-yellow-50 flex flex-col gap-1 shrink-0">
                    <div class="flex items-center justify-between">
                        <h2 class="font-bold text-yellow-800 text-sm uppercase"><i class="fa-solid fa-ticket mr-2"></i>Cupons</h2>
                        <span id="countCupons" class="bg-yellow-200 text-yellow-800 text-[10px] px-2 rounded-full font-bold">0</span>
                    </div>
                    
                    <!-- Filtros de Vencimento -->
                    <div class="flex gap-1 mt-1">
                        <button onclick="renderizarCupons('hoje')" class="flex-1 bg-white border border-yellow-200 hover:bg-yellow-100 text-[9px] py-1 rounded text-yellow-800 font-bold transition">HOJE</button>
                        <button onclick="renderizarCupons('amanha')" class="flex-1 bg-white border border-yellow-200 hover:bg-yellow-100 text-[9px] py-1 rounded text-yellow-800 font-bold transition">AMANH√É</button>
                        <button onclick="renderizarCupons('semana')" class="flex-1 bg-white border border-yellow-200 hover:bg-yellow-100 text-[9px] py-1 rounded text-yellow-800 font-bold transition">7 DIAS</button>
                    </div>
                </div>
                
                <div class="flex-1 overflow-y-auto p-2 bg-gray-50 custom-scroll">
                    <div id="listaCupons" class="flex flex-col gap-2">
                        <!-- Cupons listados aqui -->
                    </div>
                </div>
            </div>

            <!-- COLUNA 4: AN√ÅLISE ESTRAT√âGICA (4/12) -->
            <div class="col-span-4 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-gray-100 bg-purple-50 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="bg-purple-100 p-1.5 rounded-full text-purple-600">
                            <i class="fa-solid fa-magnifying-glass-chart text-xs"></i>
                        </div>
                        <div>
                            <h2 class="font-bold text-purple-900 text-sm uppercase">Estrat√©gia</h2>
                        </div>
                    </div>
                    
                    <!-- SELETOR DE VIS√ÉO -->
                    <div class="relative">
                        <select id="seletorAnalise" onchange="renderizarAnaliseEstrategica()" 
                            class="appearance-none bg-white border border-purple-300 text-purple-900 text-[10px] font-bold rounded pl-2 pr-6 py-1 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer shadow-sm hover:bg-purple-50 transition w-32">
                            <option value="tipo_cesta">üì¶ Cestas</option>
                            <option value="status_cesta">‚ú® Status</option>
                            <option value="pagamento">üí≥ Pagto</option>
                            <option value="cidade">city Cidade</option>
                            <option value="bairro">üìç Bairro</option>
                            <option value="rota">üöö Rota</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1 text-purple-700">
                            <i class="fa-solid fa-chevron-down text-[10px]"></i>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll">
                    <table class="w-full text-left table-strategy border-collapse">
                        <thead>
                            <tr>
                                <th class="pl-2">Segmento</th>
                                <th class="text-center">Qtd</th>
                                <th class="text-right pr-2">Total</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaAnalise">
                            <!-- Inserido dinamicamente -->
                        </tbody>
                        <tfoot class="bg-gray-50 font-bold text-xs border-t border-gray-200">
                            <tr>
                                <td class="pl-2 py-2">TOTAIS</td>
                                <td class="text-center" id="footerQtd">0</td>
                                <td class="text-right pr-2" id="footerValor">R$ 0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Script L√≥gico -->
    <script>
        // --- 1. CONFIGURA√á√ÉO E DADOS ---
        const KEY_CLIENTES = 'sistema_empresarial_clientes';
        const KEY_PEDIDOS = 'sistema_empresarial_vendas';
        const KEY_CUPONS = 'sistema_empresarial_cupons';
        
        let clientes = [];
        let vendas = [];
        let vendasFiltradas = [];
        let cupons = []; // { telefone, nome, valor, expiracao, dataGeracao }

        const TEMPLATES = {
            agradecimento: "Ol√° {nome}! Tudo bem? Passando para agradecer pela prefer√™ncia na sua compra do dia {data}. Espero que tenha gostado dos produtos! Qualquer coisa estou √† disposi√ß√£o. üõí",
            insta: "Oie {nome}! üòÉ Gostaria de te convidar para seguir nosso Instagram. Postamos promo√ß√µes rel√¢mpago por l√°! Segue o link: [SEU_INSTA_AQUI]",
            avaliacao: "Ol√° {nome}, tudo joia? Poderia nos dar uma forcinha? üôè Avalie nossa empresa no Google, ajuda muito! Segue o link: [SEU_LINK_GOOGLE_AQUI]",
            resgate: "Ol√° {nome}! Sumiu hein? üòâ Faz {dias} dias que n√£o te vemos. Temos cestas fresquinhas chegando. Que tal aproveitar um desconto especial de retorno? Me chama aqui!",
            feedback: "Oi {nome}, queria saber se deu tudo certo com a entrega da cesta no dia {data}? O arroz estava ok?",
            sorteio: "Ol√° {nome}! üçÄ Voc√™ est√° participando do nosso sorteio mensal! Confira seu n√∫mero da sorte e o regulamento aqui: [LINK_SORTEIO]",
            cupom: "Ol√° {nome}! üéÅ Como agradecimento, geramos um cupom de R$ {valor} para sua pr√≥xima compra! V√°lido at√© {validade}. Aproveite! üõí",
            cupom_resgate: "Ol√° {nome}! üéÅ Sentimos sua falta! Aqui est√° um cupom especial de R$ {valor} para voc√™ fazer um pedido nos pr√≥ximos 10 dias. V√°lido at√© {validade}. Vamos aproveitar? ü•ó",
            lembrete_cupom: "Oi {nome}! ‚è∞ Passando s√≥ pra lembrar que seu cupom de desconto de R$ {valor} vence {vencimento}. N√£o vai perder, hein? üòâ"
        };

        window.onload = () => {
            atualizarDados();
            definirMesAtual();
        };

        function definirMesAtual() {
            const date = new Date();
            const primeiroDia = new Date(date.getFullYear(), date.getMonth(), 1);
            const ultimoDia = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            
            document.getElementById('dataInicio').valueAsDate = primeiroDia;
            document.getElementById('dataFim').valueAsDate = ultimoDia;
            aplicarFiltros();
        }

        function atualizarDados() {
            const cLocal = localStorage.getItem(KEY_CLIENTES);
            const vLocal = localStorage.getItem(KEY_PEDIDOS);
            const cpLocal = localStorage.getItem(KEY_CUPONS);

            if (cLocal) clientes = JSON.parse(cLocal);
            if (vLocal) vendas = JSON.parse(vLocal);
            if (cpLocal) cupons = JSON.parse(cpLocal);

            vendas.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            // Limpa cupons vencidos h√° mais de 30 dias para n√£o sujar o banco
            const hoje = new Date();
            cupons = cupons.filter(c => {
                const dataExp = new Date(c.expiracao);
                const diff = (hoje - dataExp) / (1000 * 60 * 60 * 24);
                return diff < 30; 
            });
            localStorage.setItem(KEY_CUPONS, JSON.stringify(cupons));

            aplicarFiltros();
            renderizarRadar();
            renderizarCupons('semana'); // Default view
        }

        function importarDadosExternos(input) {
            const files = input.files;
            if (files.length === 0) return;

            let carregados = 0;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.length > 0) {
                            if (json[0].hasOwnProperty('financeiro')) {
                                vendas = json;
                                localStorage.setItem(KEY_PEDIDOS, JSON.stringify(vendas));
                            } else if (json[0].hasOwnProperty('nome')) {
                                clientes = json;
                                localStorage.setItem(KEY_CLIENTES, JSON.stringify(clientes));
                            }
                        }
                        carregados++;
                        if(carregados === files.length) {
                            atualizarDados();
                            alert('Dados atualizados com sucesso!');
                        }
                    } catch (error) { console.error(error); }
                };
                reader.readAsText(file);
            });
        }

        // --- SISTEMA DE CUPONS ---

        function gerarCupomZap(telefone, nome, valor, diasValidade, tipoTemplate) {
            // 1. Calcula Data
            const dataValidade = new Date();
            dataValidade.setDate(dataValidade.getDate() + parseInt(diasValidade));
            const validadeStr = dataValidade.toLocaleDateString('pt-BR');
            const validadeISO = dataValidade.toISOString().split('T')[0];

            // 2. Registra no "Banco" (Array)
            const novoCupom = {
                telefone: telefone.replace(/\D/g, ''),
                nome: nome,
                valor: valor,
                expiracao: validadeISO,
                dataGeracao: new Date().toISOString()
            };

            // Remove cupom anterior do mesmo cliente se existir para substituir
            cupons = cupons.filter(c => c.telefone !== novoCupom.telefone);
            cupons.push(novoCupom);
            localStorage.setItem(KEY_CUPONS, JSON.stringify(cupons));

            // 3. Atualiza Telas
            renderizarRadar();
            renderizarCupons('semana');

            // 4. Envia Zap
            enviarZap(telefone, tipoTemplate, nome, null, null, valor, validadeStr);
        }

        function renderizarCupons(filtro) {
            const container = document.getElementById('listaCupons');
            container.innerHTML = '';
            
            const hoje = new Date();
            hoje.setHours(0,0,0,0);
            
            // Filtra cupons ativos
            let listaFiltrada = cupons.filter(c => {
                const dataExp = new Date(c.expiracao + 'T00:00:00'); // Garante hora zerada para comparar
                return dataExp >= hoje; // Apenas v√°lidos
            });

            // Aplica filtro de per√≠odo
            listaFiltrada = listaFiltrada.filter(c => {
                const dataExp = new Date(c.expiracao + 'T00:00:00');
                const diffDias = Math.floor((dataExp - hoje) / (1000 * 60 * 60 * 24));
                
                if (filtro === 'hoje') return diffDias === 0;
                if (filtro === 'amanha') return diffDias === 1;
                if (filtro === 'semana') return diffDias >= 0 && diffDias <= 7;
                return true;
            });

            // Ordena por vencimento (mais urgente primeiro)
            listaFiltrada.sort((a, b) => new Date(a.expiracao) - new Date(b.expiracao));

            document.getElementById('countCupons').innerText = listaFiltrada.length;

            listaFiltrada.forEach(c => {
                const dataExp = new Date(c.expiracao + 'T00:00:00');
                const diffDias = Math.floor((dataExp - hoje) / (1000 * 60 * 60 * 24));
                
                let textoVencimento = "";
                let corTexto = "";
                let textoZap = "";

                if (diffDias === 0) { textoVencimento = "Vence HOJE!"; corTexto = "text-red-600 font-bold"; textoZap = "hoje"; }
                else if (diffDias === 1) { textoVencimento = "Vence Amanh√£"; corTexto = "text-orange-600"; textoZap = "amanh√£"; }
                else { textoVencimento = `Vence em ${diffDias} dias`; corTexto = "text-yellow-700"; textoZap = `dia ${dataExp.toLocaleDateString('pt-BR')}`; }

                const card = document.createElement('div');
                card.className = "bg-white p-2 rounded border border-yellow-200 shadow-sm flex flex-col gap-1";
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-xs text-gray-800 truncate w-24" title="${c.nome}">${c.nome}</div>
                            <div class="text-[10px] ${corTexto}">${textoVencimento}</div>
                        </div>
                        <div class="text-right">
                            <span class="bg-green-100 text-green-700 font-bold text-xs px-1 rounded">R$ ${c.valor}</span>
                        </div>
                    </div>
                    <button onclick="enviarZap('${c.telefone}', 'lembrete_cupom', '${c.nome}', null, null, '${c.valor}', '${textoZap}')" 
                        class="mt-1 w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 text-[10px] font-bold py-1 rounded flex items-center justify-center gap-1 transition">
                        <i class="fa-regular fa-bell"></i> Lembrar
                    </button>
                `;
                container.appendChild(card);
            });

            if (listaFiltrada.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-[10px] py-4">Nenhum cupom neste per√≠odo.</div>';
            }
        }

        // --- L√ìGICA DE FILTROS ---

        function aplicarFiltros() {
            const inicio = document.getElementById('dataInicio').value;
            const fim = document.getElementById('dataFim').value;
            
            if (inicio && fim) {
                vendasFiltradas = vendas.filter(v => {
                    const dataVenda = v.data.split('T')[0];
                    return dataVenda >= inicio && dataVenda <= fim;
                });
            } else {
                vendasFiltradas = [...vendas];
            }

            atualizarKPIsDashboard();
            renderizarPosVendaCompacto(); // Coluna 1
            renderizarAnaliseEstrategica(); // Coluna 4
        }

        function atualizarKPIsDashboard() {
            const total = vendasFiltradas.reduce((acc, v) => acc + v.financeiro.total, 0);
            document.getElementById('resumoTotal').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('resumoQtd').innerText = vendasFiltradas.length;
            document.getElementById('countPosVenda').innerText = vendasFiltradas.length;
        }

        // --- COLUNA 1: VENDAS ---

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const isHidden = panel.classList.contains('hidden');
            if (isHidden) { panel.classList.remove('hidden'); panel.classList.add('panel-expand'); } 
            else { panel.classList.add('hidden'); panel.classList.remove('panel-expand'); }
        }

        function calcularValorCupom(itens) {
            if (!itens || itens.length === 0) return 5;
            const tipo = itens[0].tipo.toLowerCase();
            if (tipo.includes('empresarial') || tipo.includes('familia') || tipo.includes('premium')) return 25;
            if (tipo.includes('grande')) return 20;
            if (tipo.includes('media') || tipo.includes('m√©dia')) return 15;
            if (tipo.includes('pequena') || tipo.includes('individual')) return 10;
            return 5;
        }

        function renderizarPosVendaCompacto() {
            const container = document.getElementById('listaPosVenda');
            container.innerHTML = '';
            const listaExibicao = vendasFiltradas.slice(0, 50);

            listaExibicao.forEach((v, index) => {
                const cardId = `venda-${index}`;
                const card = document.createElement('div');
                card.className = "bg-white p-2 rounded border border-gray-200 shadow-sm flex flex-col gap-1 hover:border-blue-300 transition group";
                
                const dataObj = new Date(v.data);
                const dataStr = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                const primeiroNome = v.cliente.nome.split(' ')[0];
                const valorCupom = calcularValorCupom(v.itens);
                
                const dataValidade = new Date();
                dataValidade.setDate(dataValidade.getDate() + 30); // 30 dias para vendas normais
                // const validadeStr = dataValidade.toLocaleDateString('pt-BR');

                const itensHtml = v.itens.map(i => `<div class="flex justify-between text-[10px] text-gray-600 border-b border-gray-100 py-1"><span>${i.tipo} (${i.marca || 'Padr√£o'})</span><span class="font-mono">x1</span></div>`).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="overflow-hidden">
                            <div class="font-bold text-xs text-gray-800 truncate" title="${v.cliente.nome}">${v.cliente.nome}</div>
                            <div class="text-[10px] text-gray-500 font-mono">#${index + 1} ‚Ä¢ ${v.pagamento.metodo}</div>
                        </div>
                        <div class="text-right whitespace-nowrap ml-2">
                            <div class="font-bold text-xs text-blue-600">R$ ${v.financeiro.total.toFixed(0)}</div>
                            <div class="text-[9px] text-gray-400">${dataStr}</div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-1 mt-2">
                        <button onclick="togglePanel('${cardId}-pedido')" class="bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-600 text-[10px] py-1 rounded transition"><i class="fa-solid fa-basket-shopping mr-1"></i> Pedido</button>
                        <button onclick="togglePanel('${cardId}-cliente')" class="bg-gray-50 hover:bg-gray-100 border border-gray-200 text-gray-600 text-[10px] py-1 rounded transition"><i class="fa-regular fa-user mr-1"></i> Cliente</button>
                        <button onclick="togglePanel('${cardId}-posvenda')" class="bg-blue-50 hover:bg-blue-100 border border-blue-200 text-blue-700 font-bold text-[10px] py-1 rounded transition"><i class="fa-brands fa-whatsapp mr-1"></i> P√≥s Venda</button>
                    </div>

                    <div id="${cardId}-pedido" class="hidden bg-gray-50 rounded p-2 mt-1 border border-gray-100">
                        <h4 class="text-[10px] font-bold text-gray-500 uppercase mb-1">Itens do Pedido</h4>
                        ${itensHtml}
                        <div class="flex justify-between text-[10px] font-bold text-gray-700 mt-1 pt-1"><span>Total</span><span>R$ ${v.financeiro.total.toFixed(2)}</span></div>
                    </div>

                    <div id="${cardId}-cliente" class="hidden bg-gray-50 rounded p-2 mt-1 border border-gray-100 text-[10px] text-gray-600 space-y-1">
                        <h4 class="text-[10px] font-bold text-gray-500 uppercase mb-1">Dados Cadastrais</h4>
                        <div><i class="fa-solid fa-phone w-4"></i> ${v.cliente.telefone}</div>
                        <div><i class="fa-solid fa-map-pin w-4"></i> ${v.cliente.endereco || 'Endere√ßo n√£o inf.'}</div>
                        <div><i class="fa-solid fa-city w-4"></i> ${v.cliente.bairro} - ${v.cliente.cidade}</div>
                    </div>

                    <div id="${cardId}-posvenda" class="hidden bg-blue-50 rounded p-2 mt-1 border border-blue-100">
                        <h4 class="text-[10px] font-bold text-blue-800 uppercase mb-2 text-center">A√ß√µes R√°pidas WhatsApp</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="enviarZap('${v.cliente.telefone}', 'agradecimento', '${primeiroNome}', '${dataStr}')" class="flex items-center justify-center gap-1 bg-white border border-green-200 text-green-700 hover:bg-green-50 rounded p-1 text-[10px] shadow-sm transition"><i class="fa-regular fa-thumbs-up"></i> Obrigado</button>
                            <button onclick="enviarZap('${v.cliente.telefone}', 'insta', '${primeiroNome}')" class="flex items-center justify-center gap-1 bg-white border border-pink-200 text-pink-700 hover:bg-pink-50 rounded p-1 text-[10px] shadow-sm transition"><i class="fa-brands fa-instagram"></i> Instagram</button>
                            <button onclick="enviarZap('${v.cliente.telefone}', 'avaliacao', '${primeiroNome}')" class="flex items-center justify-center gap-1 bg-white border border-yellow-200 text-yellow-700 hover:bg-yellow-50 rounded p-1 text-[10px] shadow-sm transition"><i class="fa-solid fa-star"></i> Google</button>
                            <button onclick="enviarZap('${v.cliente.telefone}', 'sorteio', '${primeiroNome}')" class="flex items-center justify-center gap-1 bg-white border border-purple-200 text-purple-700 hover:bg-purple-50 rounded p-1 text-[10px] shadow-sm transition"><i class="fa-solid fa-ticket"></i> Sorteio</button>
                            <!-- Gera e Salva Cupom -->
                            <button onclick="gerarCupomZap('${v.cliente.telefone}', '${v.cliente.nome}', '${valorCupom}', '30', 'cupom')" class="col-span-2 flex items-center justify-center gap-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:opacity-90 rounded p-1 text-[10px] shadow-sm transition font-bold"><i class="fa-solid fa-tag"></i> Cupom R$ ${valorCupom},00</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            if (listaExibicao.length === 0) container.innerHTML = '<div class="text-center text-gray-400 text-xs py-10">Nenhuma venda encontrada.</div>';
        }

        // --- COLUNA 2: RADAR ---

        function renderizarRadar() {
            const diasCorte = parseInt(document.getElementById('diasInativo').value) || 30;
            const tbody = document.getElementById('listaRadar');
            const empty = document.getElementById('emptyRadar');
            tbody.innerHTML = '';
            
            const mapaUltimaCompra = {};
            vendas.forEach(v => {
                const dataVenda = new Date(v.data);
                if (!mapaUltimaCompra[v.cliente.id] || dataVenda > mapaUltimaCompra[v.cliente.id]) {
                    mapaUltimaCompra[v.cliente.id] = dataVenda;
                }
            });

            const hoje = new Date();
            const hojeStr = hoje.toISOString().split('T')[0];
            
            const listaInativos = clientes.filter(c => {
                const ultimaData = mapaUltimaCompra[c.id];
                if (!ultimaData) return false; 
                const diffTime = Math.abs(hoje - ultimaData);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                c.diasSemComprar = diffDays;
                return diffDays >= diasCorte;
            });

            listaInativos.sort((a, b) => b.diasSemComprar - a.diasSemComprar);

            if (listaInativos.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                listaInativos.slice(0, 100).forEach(c => {
                    // Verifica se cliente J√Å tem cupom ativo (data expiracao >= hoje)
                    const telLimpo = c.telefone.replace(/\D/g, '');
                    const cupomAtivo = cupons.find(cupom => {
                        const cupomTel = cupom.telefone; 
                        return cupomTel === telLimpo && cupom.expiracao >= hojeStr;
                    });
                    
                    const btnClass = cupomAtivo 
                        ? "bg-gray-100 text-gray-400 cursor-not-allowed border border-gray-200"
                        : "bg-green-100 hover:bg-green-200 text-green-700 border border-green-200 hover:scale-110";
                    
                    const btnClick = cupomAtivo 
                        ? ""
                        : `onclick="gerarCupomZap('${c.telefone}', '${c.nome}', '10', '10', 'cupom_resgate')"`;
                    
                    const icone = cupomAtivo ? '<i class="fa-solid fa-check"></i>' : '<i class="fa-solid fa-tag"></i>';
                    const title = cupomAtivo ? "Cupom j√° ativo" : "Enviar Cupom Resgate (10d)";

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-red-50 transition border-b border-gray-50 group";
                    tr.innerHTML = `
                        <td class="p-2">
                            <div class="font-bold text-gray-800 truncate max-w-[120px]" title="${c.nome}">${c.nome}</div>
                            <div class="text-[9px] text-gray-400">${c.telefone || 'Sem tel'}</div>
                        </td>
                        <td class="p-2 text-center">
                            <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-0.5 rounded-full border border-red-200">${c.diasSemComprar}d</span>
                        </td>
                        <td class="p-2 text-center flex gap-1 justify-center">
                            <!-- Bot√£o Padr√£o Resgate (Texto Gen√©rico) -->
                            <button onclick="enviarZap('${c.telefone}', 'resgate', '${c.nome}', null, '${c.diasSemComprar}')" 
                                class="bg-white hover:bg-gray-50 text-gray-600 border border-gray-200 rounded p-1 shadow-sm transition" title="Msg Gen√©rica">
                                <i class="fa-regular fa-comment"></i>
                            </button>
                            <!-- Bot√£o Cupom (Condicional) -->
                            <button ${btnClick} 
                                class="${btnClass} rounded p-1 shadow-sm transition transform" title="${title}">
                                ${icone}
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- COLUNA 4: AN√ÅLISE ---

        function renderizarAnaliseEstrategica() {
            const view = document.getElementById('seletorAnalise').value;
            const tbody = document.getElementById('tabelaAnalise');
            tbody.innerHTML = '';
            
            const aggregations = {};
            let grandTotal = 0;
            let grandQtd = 0;

            vendasFiltradas.forEach(v => {
                grandTotal += v.financeiro.total;
                grandQtd++;
                let keys = []; 
                let value = v.financeiro.total;

                switch(view) {
                    case 'tipo_cesta':
                        if (v.itens.length > 1) keys = ['Mix']; else if (v.itens.length > 0) keys = [v.itens[0].tipo]; else keys = ['Indefinido'];
                        break;
                    case 'status_cesta':
                        const temAlteracao = v.itens.some(i => i.marca && i.marca !== 'Padr√£o');
                        keys.push(temAlteracao ? 'Alterada' : 'Padr√£o');
                        break;
                    case 'pagamento': keys.push(v.pagamento.metodo || 'N/A'); break;
                    case 'cidade': keys.push(v.cliente.cidade || 'N/A'); break;
                    case 'bairro': keys.push(v.cliente.bairro || 'N/A'); break;
                    case 'rota':
                        const b = (v.cliente.bairro || '').toLowerCase();
                        if (b.includes('centro') || b.includes('comercial')) keys.push('Central');
                        else if (b.includes('jardim') || b.includes('parque')) keys.push('Sul/Jardins');
                        else if (b.includes('vila') || b.includes('nossa')) keys.push('Norte/Vilas');
                        else keys.push('Outras');
                        break;
                }
                keys.forEach(k => {
                    if (!aggregations[k]) aggregations[k] = { qtd: 0, valor: 0 };
                    aggregations[k].qtd += 1;
                    aggregations[k].valor += value;
                });
            });

            const lista = Object.entries(aggregations).map(([k, val]) => ({ segmento: k, qtd: val.qtd, valor: val.valor }));
            lista.sort((a, b) => b.valor - a.valor);

            lista.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="pl-2 py-1 text-xs text-gray-700 truncate max-w-[100px]" title="${item.segmento}">${item.segmento}</td>
                    <td class="text-center text-xs font-mono text-gray-600">${item.qtd}</td>
                    <td class="text-right text-xs pr-2 text-gray-800">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 0})}</td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('footerQtd').innerText = grandQtd;
            document.getElementById('footerValor').innerText = grandTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            if (lista.length === 0) tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-400 text-xs">Sem dados.</td></tr>';
        }

        // --- UTILIT√ÅRIOS ---
        function enviarZap(telefone, tipo, nome, dataVenda = '', dias = '', valorCupom = '', validade = '') {
            if (!telefone) return alert("Cliente sem telefone.");
            let phone = telefone.replace(/\D/g, '');
            if (phone.length < 10) return alert("Telefone inv√°lido");
            if (!phone.startsWith('55')) phone = '55' + phone;

            let msg = TEMPLATES[tipo];
            msg = msg.replace('{nome}', nome.split(' ')[0]);
            if (dataVenda) msg = msg.replace('{data}', dataVenda);
            if (dias) msg = msg.replace('{dias}', dias);
            if (valorCupom) msg = msg.replace('{valor}', valorCupom);
            if (validade) msg = msg.replace('{validade}', validade);

            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
