<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema V1 - CRM & Estrat√©gia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Estilo Base & Scroll */
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .app-container { max-width: 1600px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; }
        
        /* Scrollbars finas */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        .btn-zap { transition: all 0.2s; }
        .btn-zap:hover { transform: scale(1.1); }
        
        /* Tabela de An√°lise */
        .table-strategy th { position: sticky; top: 0; background: #f9fafb; z-index: 10; font-size: 0.75rem; text-transform: uppercase; color: #6b7280; padding: 8px; border-bottom: 2px solid #e5e7eb; }
        .table-strategy td { padding: 8px; font-size: 0.85rem; border-bottom: 1px solid #f3f4f6; color: #374151; }
        .table-strategy tr:hover { background-color: #f8fafc; }
    </style>
</head>
<body class="text-gray-800">

    <div class="app-container p-4">
        
        <!-- 1. Cabe√ßalho (Navega√ß√£o) -->
        <header class="bg-white shadow-sm rounded-lg p-2 mb-3 flex justify-between items-center border border-gray-200 shrink-0">
            <div class="flex items-center gap-4">
                <div class="bg-purple-600 text-white p-2 rounded">
                    <i class="fa-solid fa-chart-pie"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg text-gray-700 leading-tight">M√≥dulo 3: Intelig√™ncia</h1>
                    <p class="text-[10px] text-gray-500">Gest√£o Estrat√©gica de Carteira</p>
                </div>
            </div>
            
            <nav class="flex gap-2">
                <button onclick="window.location.href='https://donaantonia.com.br/cadastro'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-medium transition">
                    1. Cadastro
                </button>
                <button onclick="window.location.href='https://donaantonia.com.br/vendas'" class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-3 py-1 rounded text-xs font-medium transition">
                    2. Vendas
                </button>
                <button onclick="window.location.href='https://donaantonia.com.br/crm'" class="bg-purple-600 text-white px-3 py-1 rounded text-xs font-medium shadow-sm">
                    3. CRM
                </button>
            </nav>

            <div class="flex gap-2">
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importarDadosExternos(this)" multiple>
                <button onclick="document.getElementById('importInput').click()" class="border border-gray-300 text-gray-600 px-3 py-1 rounded text-xs hover:bg-gray-50" title="Importar JSON">
                    <i class="fa-solid fa-upload mr-1"></i>
                </button>
                <button onclick="atualizarDados()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 shadow-sm">
                    <i class="fa-solid fa-sync mr-1"></i> Atualizar
                </button>
            </div>
        </header>

        <!-- 2. Barra de Filtros (Controla Coluna 1 e 3) -->
        <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-200 mb-3 flex items-center gap-4 shrink-0">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-filter text-gray-400"></i>
                <span class="text-xs font-bold text-gray-700 uppercase">Per√≠odo de An√°lise:</span>
            </div>
            <div class="flex items-center gap-2">
                <input type="date" id="dataInicio" class="border border-gray-300 rounded px-2 py-1 text-xs" onchange="aplicarFiltros()">
                <span class="text-gray-400 text-xs">at√©</span>
                <input type="date" id="dataFim" class="border border-gray-300 rounded px-2 py-1 text-xs" onchange="aplicarFiltros()">
            </div>
            <button onclick="definirMesAtual()" class="text-xs text-blue-600 hover:underline font-medium">Este M√™s</button>
            
            <div class="ml-auto flex gap-6 text-sm">
                <div class="flex flex-col items-end leading-tight">
                    <span class="text-[10px] text-gray-500 uppercase">Faturamento Filtrado</span>
                    <span id="resumoTotal" class="font-bold text-gray-800 text-lg">R$ 0,00</span>
                </div>
                <div class="flex flex-col items-end leading-tight border-l pl-4 border-gray-200">
                    <span class="text-[10px] text-gray-500 uppercase">Volume Vendas</span>
                    <span id="resumoQtd" class="font-bold text-gray-800 text-lg">0</span>
                </div>
            </div>
        </div>

        <!-- 3. √ÅREA PRINCIPAL (GRID 3 COLUNAS) -->
        <div class="grid grid-cols-12 gap-4 flex-1 overflow-hidden min-h-0">
            
            <!-- COLUNA 1: VENDAS DO PER√çODO (Operacional) -->
            <div class="col-span-3 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-gray-100 bg-blue-50 flex justify-between items-center shrink-0">
                    <div>
                        <h2 class="font-bold text-blue-800 text-sm uppercase"><i class="fa-solid fa-receipt mr-2"></i>Vendas</h2>
                        <p class="text-[10px] text-blue-600">Listagem do per√≠odo selecionado</p>
                    </div>
                    <span class="bg-blue-200 text-blue-800 text-xs font-bold px-2 py-1 rounded-full" id="countPosVenda">0</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 bg-gray-50 custom-scroll">
                    <div id="listaPosVenda" class="flex flex-col gap-2">
                        <!-- Itens inseridos via JS -->
                    </div>
                </div>
            </div>

            <!-- COLUNA 2: RADAR DE INATIVOS (Reten√ß√£o) -->
            <div class="col-span-3 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-gray-100 bg-red-50 flex flex-col gap-2 shrink-0">
                    <div class="flex justify-between items-center">
                        <h2 class="font-bold text-red-800 text-sm uppercase"><i class="fa-solid fa-heart-crack mr-2"></i>Radar Inativos</h2>
                        <div class="flex items-center bg-white rounded border border-red-200 px-2 py-1">
                            <span class="text-[10px] text-red-400 mr-2">Dias ></span>
                            <input type="number" id="diasInativo" value="30" class="w-10 text-center text-xs font-bold text-red-700 outline-none" onchange="renderizarRadar()">
                        </div>
                    </div>
                    <p class="text-[10px] text-red-600">Clientes sem comprar baseados na data de hoje.</p>
                </div>
                <div class="flex-1 overflow-y-auto p-0 bg-white custom-scroll">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50 text-gray-500 text-[10px] sticky top-0 shadow-sm z-10">
                            <tr>
                                <th class="p-2 border-b">Cliente</th>
                                <th class="p-2 text-center border-b">Dias Off</th>
                                <th class="p-2 text-center border-b">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="listaRadar" class="text-xs divide-y divide-gray-100">
                            <!-- Inserido via JS -->
                        </tbody>
                    </table>
                    <div id="emptyRadar" class="hidden text-center text-gray-400 p-8">
                        <i class="fa-regular fa-thumbs-up text-2xl mb-2"></i>
                        <p class="text-xs">Todos clientes ativos!</p>
                    </div>
                </div>
            </div>

            <!-- COLUNA 3: AN√ÅLISE ESTRAT√âGICA (Intelig√™ncia) - Mais Larga -->
            <div class="col-span-6 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                <div class="p-3 border-b border-gray-100 bg-purple-50 flex justify-between items-center shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="bg-purple-100 p-2 rounded-full text-purple-600">
                            <i class="fa-solid fa-magnifying-glass-chart"></i>
                        </div>
                        <div>
                            <h2 class="font-bold text-purple-900 text-sm uppercase">An√°lise Estrat√©gica</h2>
                            <p class="text-[10px] text-purple-600">Detalhamento segmentado dos dados filtrados</p>
                        </div>
                    </div>
                    
                    <!-- SELETOR DE VIS√ÉO -->
                    <div class="relative">
                        <select id="seletorAnalise" onchange="renderizarAnaliseEstrategica()" 
                            class="appearance-none bg-white border border-purple-300 text-purple-900 text-xs font-bold rounded pl-3 pr-8 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer shadow-sm hover:bg-purple-50 transition">
                            <option value="tipo_cesta">üì¶ Por Tipo de Cesta</option>
                            <option value="status_cesta">‚ú® Normal vs Alterada</option>
                            <option value="pagamento">üí≥ Meios de Pagamento</option>
                            <option value="cidade">city Por Cidade</option>
                            <option value="bairro">üìç Por Bairro</option>
                            <option value="rota">üöö Por Rota (Estimada)</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-purple-700">
                            <i class="fa-solid fa-chevron-down text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto custom-scroll">
                    <table class="w-full text-left table-strategy border-collapse">
                        <thead>
                            <tr>
                                <th class="w-5/12 pl-4">Segmento</th>
                                <th class="w-2/12 text-center">Qtd. Vendas</th>
                                <th class="w-2/12 text-right">Valor Total</th>
                                <th class="w-3/12 text-right pr-4">Participa√ß√£o (%)</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaAnalise">
                            <!-- Inserido dinamicamente -->
                        </tbody>
                        <tfoot class="bg-gray-50 font-bold text-xs border-t border-gray-200">
                            <tr>
                                <td class="pl-4 py-3">TOTAIS</td>
                                <td class="text-center" id="footerQtd">0</td>
                                <td class="text-right" id="footerValor">R$ 0,00</td>
                                <td class="text-right pr-4">100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- Script L√≥gico -->
    <script>
        // --- 1. CONFIGURA√á√ÉO E DADOS ---
        const KEY_CLIENTES = 'sistema_empresarial_clientes';
        const KEY_PEDIDOS = 'sistema_empresarial_vendas';
        
        let clientes = [];
        let vendas = [];
        let vendasFiltradas = [];

        const TEMPLATES = {
            agradecimento: "Ol√° {nome}! Tudo bem? Passando para agradecer pela prefer√™ncia na sua compra do dia {data}. Espero que tenha gostado dos produtos! Qualquer coisa estou √† disposi√ß√£o. üõí",
            insta: "Oie {nome}! üòÉ Gostaria de te convidar para seguir nosso Instagram. Postamos promo√ß√µes rel√¢mpago por l√°! Segue o link: [SEU_INSTA_AQUI]",
            avaliacao: "Ol√° {nome}, tudo joia? Poderia nos dar uma forcinha? üôè Avalie nossa empresa no Google, ajuda muito! Segue o link: [SEU_LINK_GOOGLE_AQUI]",
            resgate: "Ol√° {nome}! Sumiu hein? üòâ Faz {dias} dias que n√£o te vemos. Temos cestas fresquinhas chegando. Que tal aproveitar um desconto especial de retorno? Me chama aqui!",
            feedback: "Oi {nome}, queria saber se deu tudo certo com a entrega da cesta no dia {data}? O arroz estava ok?"
        };

        window.onload = () => {
            atualizarDados();
            definirMesAtual();
        };

        function definirMesAtual() {
            const date = new Date();
            const primeiroDia = new Date(date.getFullYear(), date.getMonth(), 1);
            const ultimoDia = new Date(date.getFullYear(), date.getMonth() + 1, 0);
            
            document.getElementById('dataInicio').valueAsDate = primeiroDia;
            document.getElementById('dataFim').valueAsDate = ultimoDia;
            aplicarFiltros();
        }

        function atualizarDados() {
            const cLocal = localStorage.getItem(KEY_CLIENTES);
            const vLocal = localStorage.getItem(KEY_PEDIDOS);

            if (cLocal) clientes = JSON.parse(cLocal);
            if (vLocal) vendas = JSON.parse(vLocal);

            vendas.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            aplicarFiltros();
            renderizarRadar(); // Independente do filtro de data
        }

        function importarDadosExternos(input) {
            const files = input.files;
            if (files.length === 0) return;

            let carregados = 0;
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.length > 0) {
                            if (json[0].hasOwnProperty('financeiro')) {
                                vendas = json;
                                localStorage.setItem(KEY_PEDIDOS, JSON.stringify(vendas));
                            } else if (json[0].hasOwnProperty('nome')) {
                                clientes = json;
                                localStorage.setItem(KEY_CLIENTES, JSON.stringify(clientes));
                            }
                        }
                        carregados++;
                        if(carregados === files.length) {
                            atualizarDados();
                            alert('Dados atualizados com sucesso!');
                        }
                    } catch (error) { console.error(error); }
                };
                reader.readAsText(file);
            });
        }

        // --- L√ìGICA DE FILTROS ---

        function aplicarFiltros() {
            const inicio = document.getElementById('dataInicio').value;
            const fim = document.getElementById('dataFim').value;
            
            if (inicio && fim) {
                vendasFiltradas = vendas.filter(v => {
                    const dataVenda = v.data.split('T')[0];
                    return dataVenda >= inicio && dataVenda <= fim;
                });
            } else {
                vendasFiltradas = [...vendas];
            }

            atualizarKPIsDashboard();
            renderizarPosVendaCompacto(); // Coluna 1
            renderizarAnaliseEstrategica(); // Coluna 3
        }

        function atualizarKPIsDashboard() {
            const total = vendasFiltradas.reduce((acc, v) => acc + v.financeiro.total, 0);
            document.getElementById('resumoTotal').innerText = total.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});
            document.getElementById('resumoQtd').innerText = vendasFiltradas.length;
            document.getElementById('countPosVenda').innerText = vendasFiltradas.length;
        }

        // --- COLUNA 1: VENDAS (Lista) ---

        function renderizarPosVendaCompacto() {
            const container = document.getElementById('listaPosVenda');
            container.innerHTML = '';
            const listaExibicao = vendasFiltradas.slice(0, 50); // Mostra as 50 mais recentes para performance

            listaExibicao.forEach(v => {
                const card = document.createElement('div');
                card.className = "bg-white p-2 rounded border border-gray-200 shadow-sm flex flex-col gap-1 hover:border-blue-300 transition group";
                
                const dataObj = new Date(v.data);
                const dataStr = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                const primeiroNome = v.cliente.nome.split(' ')[0];
                const descItens = v.itens.map(i => i.tipo).join(', ');

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="overflow-hidden">
                            <div class="font-bold text-xs text-gray-800 truncate" title="${v.cliente.nome}">${v.cliente.nome}</div>
                            <div class="text-[10px] text-gray-500 truncate">${descItens}</div>
                        </div>
                        <div class="text-right whitespace-nowrap ml-2">
                            <div class="font-bold text-xs text-blue-600">R$ ${v.financeiro.total.toFixed(0)}</div>
                            <div class="text-[9px] text-gray-400">${dataStr}</div>
                        </div>
                    </div>
                    
                    <!-- Bot√µes aparecem ao passar o mouse ou sempre visiveis -->
                    <div class="flex gap-2 mt-1 pt-1 border-t border-gray-50 opacity-100 sm:opacity-60 group-hover:opacity-100 transition-opacity justify-between">
                        <button onclick="enviarZap('${v.cliente.telefone}', 'agradecimento', '${primeiroNome}', '${dataStr}')" class="text-green-600 hover:text-green-800 text-[10px] flex items-center gap-1"><i class="fa-brands fa-whatsapp"></i> Obrigado</button>
                        <button onclick="enviarZap('${v.cliente.telefone}', 'feedback', '${primeiroNome}', '${dataStr}')" class="text-blue-600 hover:text-blue-800 text-[10px] flex items-center gap-1"><i class="fa-regular fa-comment-dots"></i> Feedback</button>
                    </div>
                `;
                container.appendChild(card);
            });

            if (listaExibicao.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs py-10">Nenhuma venda encontrada no per√≠odo.</div>';
            }
        }

        // --- COLUNA 2: RADAR (Inativos) ---

        function renderizarRadar() {
            const diasCorte = parseInt(document.getElementById('diasInativo').value) || 30;
            const tbody = document.getElementById('listaRadar');
            const empty = document.getElementById('emptyRadar');
            tbody.innerHTML = '';
            
            const mapaUltimaCompra = {};
            vendas.forEach(v => {
                const dataVenda = new Date(v.data);
                if (!mapaUltimaCompra[v.cliente.id] || dataVenda > mapaUltimaCompra[v.cliente.id]) {
                    mapaUltimaCompra[v.cliente.id] = dataVenda;
                }
            });

            const hoje = new Date();
            const listaInativos = clientes.filter(c => {
                const ultimaData = mapaUltimaCompra[c.id];
                if (!ultimaData) return false; 
                const diffTime = Math.abs(hoje - ultimaData);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                c.diasSemComprar = diffDays;
                return diffDays >= diasCorte;
            });

            listaInativos.sort((a, b) => b.diasSemComprar - a.diasSemComprar);

            if (listaInativos.length === 0) {
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                listaInativos.slice(0, 100).forEach(c => { // Limite de exibi√ß√£o para radar
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-red-50 transition border-b border-gray-50 group";
                    tr.innerHTML = `
                        <td class="p-2">
                            <div class="font-bold text-gray-800 truncate max-w-[120px]" title="${c.nome}">${c.nome}</div>
                            <div class="text-[9px] text-gray-400">${c.telefone || 'Sem tel'}</div>
                        </td>
                        <td class="p-2 text-center">
                            <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-0.5 rounded-full border border-red-200">${c.diasSemComprar}d</span>
                        </td>
                        <td class="p-2 text-center">
                            <button onclick="enviarZap('${c.telefone}', 'resgate', '${c.nome}', null, '${c.diasSemComprar}')" 
                                class="bg-green-100 hover:bg-green-200 text-green-700 border border-green-200 rounded p-1 shadow-sm transition transform hover:scale-110" title="Resgatar">
                                <i class="fa-brands fa-whatsapp"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- COLUNA 3: AN√ÅLISE ESTRAT√âGICA (O C√âREBRO) ---

        function renderizarAnaliseEstrategica() {
            const view = document.getElementById('seletorAnalise').value;
            const tbody = document.getElementById('tabelaAnalise');
            tbody.innerHTML = '';

            // 1. Agregar Dados
            const aggregations = {};
            let grandTotal = 0;
            let grandQtd = 0;

            vendasFiltradas.forEach(v => {
                grandTotal += v.financeiro.total;
                grandQtd++;

                let keys = []; // Uma venda pode gerar m√∫ltiplas chaves (ex: m√∫ltiplos produtos)
                let value = v.financeiro.total; // Valor a atribuir (pode ser dividido se necess√°rio, mas simplificaremos por venda)

                switch(view) {
                    case 'tipo_cesta':
                        // Para produtos, iteramos sobre os itens
                        v.itens.forEach(item => {
                            // Marca produtos simples vs produtos compostos se necess√°rio
                            keys.push(item.tipo);
                        });
                        // Ajuste: O valor financeiro da venda √© unico. 
                        // Se quisermos valor por produto, precisariamos do pre√ßo unit√°rio. 
                        // Como o JSON pode variar, vamos contar ocorr√™ncia e somar valor proporcional ou total da venda.
                        // Simplifica√ß√£o: Contagem + Valor Total da Venda (Atribu√≠do ao produto principal ou dividido? Vamos usar contagem pura e valor estimado m√©dio se n√£o tiver detalhe).
                        // MELHOR: Usar apenas contagem para itens, ou valor total da venda categorizado pelo "tipo principal" se houver apenas 1.
                        // Se houver mix, duplicar o valor total distorce. Vamos assumir Valor = 0 para itens individuais se n√£o tivermos pre√ßo, 
                        // mas para simplificar a visualiza√ß√£o financeira, vamos somar o total da venda na chave do PRIMEIRO item ou dividir.
                        // Solu√ß√£o Robusta: Somar Valor Total na chave "Mix" se > 1 item, ou na chave do item √∫nico.
                        if (v.itens.length > 1) {
                            keys = ['Mix de Produtos'];
                        } else if (v.itens.length > 0) {
                            keys = [v.itens[0].tipo];
                        } else {
                            keys = ['Indefinido'];
                        }
                        break;
                    
                    case 'status_cesta':
                        // Verifica se tem alguma marca√ß√£o diferente de Padr√£o
                        const temAlteracao = v.itens.some(i => i.marca && i.marca !== 'Padr√£o');
                        keys.push(temAlteracao ? 'Alterada / Personalizada' : 'Normal / Padr√£o');
                        break;

                    case 'pagamento':
                        keys.push(v.pagamento.metodo || 'N√£o Informado');
                        break;

                    case 'cidade':
                        keys.push(v.cliente.cidade || 'N√£o Informado');
                        break;
                    
                    case 'bairro':
                        keys.push(v.cliente.bairro || 'N√£o Informado');
                        break;

                    case 'rota':
                        // L√≥gica de infer√™ncia de Rota
                        // Se bairro contiver "Centro", Rota 1. Se "Jardim", Rota 2. 
                        // Isso √© um exemplo, idealmente viria do JSON.
                        const b = (v.cliente.bairro || '').toLowerCase();
                        if (b.includes('centro') || b.includes('comercial')) keys.push('Rota Central');
                        else if (b.includes('jardim') || b.includes('parque')) keys.push('Rota Sul/Jardins');
                        else if (b.includes('vila') || b.includes('nossa')) keys.push('Rota Norte/Vilas');
                        else keys.push('Rota Padr√£o / Outras');
                        break;
                }

                // Processar Agrega√ß√£o
                keys.forEach(k => {
                    if (!aggregations[k]) aggregations[k] = { qtd: 0, valor: 0 };
                    aggregations[k].qtd += 1;
                    aggregations[k].valor += value; // Aten√ß√£o: Em 'tipo_cesta' mix, soma valor cheio.
                });
            });

            // 2. Converter para Array e Ordenar
            const lista = Object.entries(aggregations).map(([k, val]) => ({
                segmento: k,
                qtd: val.qtd,
                valor: val.valor,
                perc: (grandTotal > 0) ? (val.valor / grandTotal) * 100 : 0
            }));

            // Ordenar por Valor Financeiro (decrescente)
            lista.sort((a, b) => b.valor - a.valor);

            // 3. Renderizar Tabela
            lista.forEach(item => {
                const tr = document.createElement('tr');
                
                // Barra de progresso visual para %
                const barraLargura = Math.max(item.perc, 1); 
                const barraCor = item.perc > 20 ? 'bg-purple-500' : 'bg-purple-300';

                tr.innerHTML = `
                    <td class="pl-4 py-2 relative">
                        <div class="font-medium text-gray-700 relative z-10">${item.segmento}</div>
                    </td>
                    <td class="text-center font-mono text-gray-600">${item.qtd}</td>
                    <td class="text-right font-medium text-gray-800">R$ ${item.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td class="pr-4 py-2 align-middle">
                        <div class="flex items-center justify-end gap-2">
                            <span class="text-xs text-gray-500 font-bold w-8 text-right">${item.perc.toFixed(1)}%</span>
                            <div class="h-2 w-16 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full ${barraCor}" style="width: ${barraLargura}%"></div>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Atualizar Rodap√© da Tabela
            document.getElementById('footerQtd').innerText = grandQtd;
            document.getElementById('footerValor').innerText = grandTotal.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400">Sem dados para este filtro.</td></tr>';
            }
        }

        // --- UTILIT√ÅRIOS ---
        function enviarZap(telefone, tipo, nome, dataVenda = '', dias = '') {
            if (!telefone) return alert("Cliente sem telefone.");
            let phone = telefone.replace(/\D/g, '');
            if (phone.length < 10) return alert("Telefone inv√°lido");
            if (!phone.startsWith('55')) phone = '55' + phone;

            let msg = TEMPLATES[tipo];
            msg = msg.replace('{nome}', nome.split(' ')[0]);
            if (dataVenda) msg = msg.replace('{data}', dataVenda);
            if (dias) msg = msg.replace('{dias}', dias);

            window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
        }
    </script>
</body>
</html>
