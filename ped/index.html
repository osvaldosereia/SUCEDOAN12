<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Lan√ßador de Pedidos - Dona Ant√¥nia</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background: #f4f4f4; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 200px; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; font-family: monospace; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; }
        button { background: #28a745; color: white; border: none; padding: 15px 30px; font-size: 16px; cursor: pointer; border-radius: 5px; width: 100%; }
        button:hover { background: #218838; }
        #status { margin-top: 20px; padding: 10px; border-radius: 4px; }
        .aviso { font-size: 0.9em; color: #666; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üöÄ Lan√ßador R√°pido de WhatsApp</h2>
    
    <label>Access Token (Pegue no Painel Dev do Bling):</label>
    <input type="text" id="token" placeholder="Cole seu Token de Acesso aqui...">

    <label>Cole a lista do WhatsApp aqui:</label>
    <div class="aviso">Formato esperado: <b>COD_CLIENTE</b> na primeira linha. Depois: <b>1x CODIGO_PRODUTO</b></div>
    <textarea id="inputTexto" placeholder="Exemplo:
78945612300 (CPF ou ID do Cliente)
2x 1001 (Arroz)
1x 2005 (Feij√£o)"></textarea>

    <button onclick="processarPedido()">Gerar Venda no Bling</button>

    <div id="status"></div>
</div>

<script>
    // Fun√ß√£o principal
    async function processarPedido() {
        const token = document.getElementById('token').value;
        const texto = document.getElementById('inputTexto').value;
        const statusDiv = document.getElementById('status');

        if (!token) { alert('Precisa do Token!'); return; }

        statusDiv.innerHTML = 'Processando...';
        statusDiv.style.background = '#e2e3e5';

        // 1. Quebrar o texto em linhas
        const linhas = texto.split('\n').filter(linha => linha.trim() !== '');
        
        // 2. Tentar pegar o cliente (assumindo que √© a primeira linha)
        // Se for CPF ou CNPJ, o Bling busca sozinho.
        const clienteIdentificador = linhas[0].replace(/[^0-9]/g, ''); // Pega s√≥ n√∫meros da primeira linha
        
        let itensParaEnvio = [];

        // 3. Varrer as linhas de produtos (a partir da segunda linha)
        for (let i = 1; i < linhas.length; i++) {
            const linha = linhas[i];
            
            // REGEX: Procura por "Numero + x + Espa√ßo + Codigo"
            // Ex: "2x 1001" captura Qtd: 2 e Codigo: 1001
            const regex = /^(\d+)[xX]\s+([0-9A-Za-z-]+)/;
            const match = linha.match(regex);

            if (match) {
                itensParaEnvio.push({
                    "codigo": match[2], // C√≥digo do produto (SKU)
                    "quantidade": parseFloat(match[1]),
                    "unidade": "UN", // Padr√£o
                    "valor": 0 // Se deixar 0, o Bling puxa o pre√ßo do cadastro!
                });
            }
        }

        if (itensParaEnvio.length === 0) {
            statusDiv.innerHTML = '‚ùå Nenhum produto identificado! Verifique o formato.';
            statusDiv.style.background = '#f8d7da';
            return;
        }

        // 4. Montar o JSON final para a API v3
        const payload = {
            "contato": {
                "numeroDocumento": clienteIdentificador // CPF ou CNPJ busca o cliente
            },
            "itens": itensParaEnvio,
            "numeroLoja": "Loja F√≠sica" // Opcional
        };

        // 5. Enviar para o Bling
        try {
            const response = await fetch('https://www.bling.com.br/Api/v3/pedidos/vendas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                statusDiv.innerHTML = `‚úÖ Sucesso! Pedido criado. ID: ${data.data.id}`;
                statusDiv.style.background = '#d4edda';
            } else {
                console.log(data); // Veja o erro no Console (F12)
                statusDiv.innerHTML = `‚ùå Erro: ${data.error ? data.error.message : 'Veja o console (F12)'}`;
                statusDiv.style.background = '#f8d7da';
            }

        } catch (error) {
            statusDiv.innerHTML = `‚ùå Erro de conex√£o: ${error.message}`;
        }
    }
</script>

</body>
</html>
