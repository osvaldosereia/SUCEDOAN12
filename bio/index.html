<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAS | Product Studio</title>
    <meta name="description" content="Ferramenta ultra-rápida para padronização de imagens de e-commerce. Mobile-first, sem dependências.">
    
    <style>
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --text-light: #64748b;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --border: #e2e8f0;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Reset & Base - The Classless Way */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header, main, footer { width: 100%; max-width: 800px; }
        
        header { margin-bottom: 2rem; text-align: center; }
        h1 { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.05em; margin-bottom: 0.5rem; }
        p { color: var(--text-light); font-size: 0.9rem; }

        /* Layout Grid */
        main {
            display: grid;
            gap: 2rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
            main { grid-template-columns: 1fr 320px; align-items: start; }
            .preview-area { position: sticky; top: 2rem; }
        }

        /* Components */
        .card {
            background: var(--surface);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        /* Canvas / Preview */
        .preview-container {
            width: 100%;
            aspect-ratio: 1;
            background: #e5e5e5;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        .empty-state {
            text-align: center;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        /* Controls */
        fieldset {
            border: none;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        legend { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-light); }

        label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        /* Sub-controls for shadow */
        .sub-controls {
            padding-left: 0.75rem;
            border-left: 2px solid var(--border);
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            transition: opacity 0.2s;
        }
        .sub-controls.disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        input[type="range"] {
            width: 100%;
            margin-top: 0.5rem;
            height: 6px;
            background: var(--border);
            border-radius: 4px;
            appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Buttons */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem; }
        
        button, .file-upload {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            transition: all 0.2s;
            text-decoration: none;
            width: 100%;
        }

        button:active { transform: scale(0.98); }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .btn-primary:hover { background: var(--primary-dark); }

        input[type="file"] { display: none; }
        
        input[type="text"] {
            outline: none;
            color: var(--text);
            background: var(--surface);
            transition: border-color 0.2s;
        }
        input[type="text"]:focus {
            border-color: var(--primary) !important;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .text-sm { font-size: 0.8rem; }
        
        /* Loading */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <header>
        <h1>SISTEMAS Studio</h1>
        <p>Processamento de imagem para E-commerce. Rápido. Local. Minimalista.</p>
    </header>

    <main>
        <!-- Área Visual -->
        <section class="preview-area">
            <div class="card">
                <div class="preview-container" id="dropZone">
                    <div id="emptyState" class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="color: var(--text-light);"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        <span>Arraste uma imagem ou clique abaixo</span>
                    </div>
                    <canvas id="canvas" class="hidden"></canvas>
                </div>
                <div style="margin-top: 1rem;">
                    <label class="file-upload btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Carregar Imagem
                        <input type="file" id="uploadInput" accept="image/*">
                    </label>
                </div>
            </div>
        </section>

        <!-- Controles -->
        <section class="controls-area">
            <div class="card">
                
                <fieldset>
                    <legend>1. Geometria (Smart Crop)</legend>
                    <label>
                        Escala do Produto
                        <span id="scaleVal">85%</span>
                    </label>
                    <input type="range" id="scaleRange" min="50" max="200" value="85">
                    
                    <div class="btn-group" style="margin-top: 0.5rem; grid-template-columns: 1fr 1fr 1fr;">
                         <button id="btnFit" type="button" title="Padrão (85%)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                            Fit
                        </button>
                         <button id="btnMax" type="button" title="Maximizar (100%)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 14 10 14 10 20"></polyline><polyline points="20 10 14 10 14 4"></polyline><line x1="14" y1="10" x2="21" y2="3"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>
                            Max
                        </button>
                        <button id="btnCenter" type="button" title="Centralizar Absoluto">
                             <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            Centro
                        </button>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>2. Tratamento (Enhance)</legend>
                    
                    <label>
                        <input type="checkbox" id="checkRemoveBg">
                        <span>Remover Fundo (Luma Key)</span>
                    </label>
                    <p class="text-sm" style="color:var(--text-light); margin-bottom:0.5rem;">Ideal para fotos em fundo branco.</p>

                    <label>
                        Brilho / Studio Light
                        <span id="brightnessVal">0</span>
                    </label>
                    <input type="range" id="brightnessRange" min="-50" max="50" value="0">

                    <label>
                        Contraste
                        <span id="contrastVal">0</span>
                    </label>
                    <input type="range" id="contrastRange" min="-50" max="50" value="10">

                    <label>
                        Nitidez (Sharpen)
                        <span id="sharpVal">0</span>
                    </label>
                    <input type="range" id="sharpRange" min="0" max="10" value="0">
                </fieldset>

                <fieldset>
                    <legend>3. Acabamento</legend>
                    <label style="margin-bottom: 0;">
                        <input type="checkbox" id="checkShadow" checked>
                        <span>Sombra de Apoio (Drop Shadow)</span>
                    </label>
                    
                    <!-- Shadow Controls -->
                    <div id="shadowControls" class="sub-controls">
                        <label>
                            Tamanho
                            <input type="range" id="shadowSizeRange" min="20" max="150" value="60">
                        </label>
                        <label>
                            Intensidade
                            <input type="range" id="shadowOpRange" min="0" max="100" value="30">
                        </label>
                        <label>
                            Posição Vertical
                            <input type="range" id="shadowYRange" min="-400" max="50" value="0">
                        </label>
                    </div>
                </fieldset>

                <!-- File Name Input -->
                <div style="margin-top: 1rem; margin-bottom: 1rem;">
                    <label style="display:block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">Nome do Produto</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="text" id="fileNameInput" placeholder="ex: arroz-tio-joao" value="produto" 
                                   style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;">
                        </div>
                        <p class="text-sm" style="color: var(--text-light); word-break: break-all;">
                            Arquivo final: <span id="fileNamePreview" style="font-family: monospace; color: var(--primary); font-weight: 600;">cesta-basica-cuiaba-varzea-grande.webp</span>
                        </p>
                    </div>
                </div>

                <button id="downloadBtn" class="btn-primary" disabled style="background: #10b981; border-color: #10b981;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Baixar WebP (Max 10kb)
                </button>
            </div>
        </section>
    </main>

    <script>
        /**
         * SISTEMAS CORE - Image Processing Logic
         * Vanilla JS, No Frameworks.
         */
        
        // Elementos
        const els = {
            input: document.getElementById('uploadInput'),
            canvas: document.getElementById('canvas'),
            empty: document.getElementById('emptyState'),
            drop: document.getElementById('dropZone'),
            download: document.getElementById('downloadBtn'),
            fileNameInput: document.getElementById('fileNameInput'),
            fileNamePreview: document.getElementById('fileNamePreview'), // Novo
            scale: document.getElementById('scaleRange'),
            scaleVal: document.getElementById('scaleVal'),
            brightness: document.getElementById('brightnessRange'),
            brightVal: document.getElementById('brightnessVal'),
            contrast: document.getElementById('contrastRange'),
            contrastVal: document.getElementById('contrastVal'),
            sharp: document.getElementById('sharpRange'),
            sharpVal: document.getElementById('sharpVal'),
            removeBg: document.getElementById('checkRemoveBg'),
            shadow: document.getElementById('checkShadow'),
            shadowControls: document.getElementById('shadowControls'),
            shadowSize: document.getElementById('shadowSizeRange'),
            shadowOp: document.getElementById('shadowOpRange'),
            shadowY: document.getElementById('shadowYRange'),
            btnFit: document.getElementById('btnFit'),
            btnMax: document.getElementById('btnMax'),
            btnCenter: document.getElementById('btnCenter')
        };

        // Estado da Aplicação
        const state = {
            originalImage: null,
            ctx: els.canvas.getContext('2d', { willReadFrequently: true }),
            width: 300,
            height: 300,
            scale: 0.85,
            offsetX: 0,
            offsetY: 0,
            isDragging: false,
            startPanX: 0,
            startPanY: 0,
            brightness: 0,
            contrast: 10,
            sharpness: 80,
            removeBg: true,
            shadow: false,
            shadowSize: 0.6,    // % relative to width
            shadowOpacity: 0.3, // 0-1
            shadowY: 0          // px offset
        };

        // Constante de Sufixo SEO
        const SEO_SUFFIX = '-cesta-basica-cuiaba-varzea-grande';

        // Inicialização
        function init() {
            setupListeners();
            resizeCanvasDisplay();
        }

        function setupListeners() {
            // Upload
            els.input.addEventListener('change', handleFile);
            
            // Drag & Drop
            els.drop.addEventListener('dragover', (e) => { e.preventDefault(); els.drop.style.borderColor = varCss('--primary'); });
            els.drop.addEventListener('dragleave', (e) => { e.preventDefault(); els.drop.style.borderColor = varCss('--border'); });
            els.drop.addEventListener('drop', (e) => {
                e.preventDefault();
                if(e.dataTransfer.files.length) handleFile({ target: { files: e.dataTransfer.files } });
            });

            // Controles
            els.scale.addEventListener('input', (e) => updateState('scale', e.target.value / 100));
            els.brightness.addEventListener('input', (e) => updateState('brightness', parseInt(e.target.value)));
            els.contrast.addEventListener('input', (e) => updateState('contrast', parseInt(e.target.value)));
            els.sharp.addEventListener('input', (e) => updateState('sharpness', parseInt(e.target.value)));
            els.removeBg.addEventListener('change', (e) => updateState('removeBg', e.target.checked));
            
            // File Name Preview
            els.fileNameInput.addEventListener('input', updateFileNamePreview);

            // Shadow Controls
            els.shadow.addEventListener('change', (e) => {
                updateState('shadow', e.target.checked);
                els.shadowControls.classList.toggle('disabled', !e.target.checked);
            });
            els.shadowSize.addEventListener('input', (e) => updateState('shadowSize', e.target.value / 100));
            els.shadowOp.addEventListener('input', (e) => updateState('shadowOpacity', e.target.value / 100));
            els.shadowY.addEventListener('input', (e) => updateState('shadowY', parseInt(e.target.value)));
            
            // Botões de Posição & Geometria
            els.btnCenter.addEventListener('click', () => { state.offsetX = 0; state.offsetY = 0; render(); });
            els.btnFit.addEventListener('click', () => { state.scale = 0.85; els.scale.value = 85; els.scaleVal.innerText = '85%'; render(); });
            
            // Botão MAX (100% Scale)
            els.btnMax.addEventListener('click', () => { 
                state.scale = 1.0; 
                els.scale.value = 100; 
                els.scaleVal.innerText = '100%'; 
                render(); 
            });

            // Download
            els.download.addEventListener('click', downloadImage);

            // Pan (Arrastar imagem no canvas)
            els.canvas.addEventListener('mousedown', startPan);
            window.addEventListener('mouseup', () => state.isDragging = false);
            window.addEventListener('mousemove', doPan);
            
            // Touch Pan
            els.canvas.addEventListener('touchstart', (e) => startPan(e.touches[0]));
            els.canvas.addEventListener('touchmove', (e) => { e.preventDefault(); doPan(e.touches[0]); });
        }

        function varCss(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        function updateFileNamePreview() {
            const userText = els.fileNameInput.value.trim() || 'produto';
            const cleanName = userText.replace(/\s+/g, '-').toLowerCase();
            els.fileNamePreview.innerText = `${cleanName}${SEO_SUFFIX}.webp`;
        }

        // Carregamento de Arquivo
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.originalImage = img;
                    state.offsetX = 0;
                    state.offsetY = 0;
                    els.empty.classList.add('hidden');
                    els.canvas.classList.remove('hidden');
                    els.download.disabled = false;
                    render();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateState(key, value) {
            state[key] = value;
            
            // Atualizar textos dos labels
            if(key === 'scale') els.scaleVal.innerText = Math.round(value * 100) + '%';
            if(key === 'brightness') els.brightVal.innerText = value;
            if(key === 'contrast') els.contrastVal.innerText = value;
            if(key === 'sharpness') els.sharpVal.innerText = value;

            render();
        }

        // Lógica de Panning (Arrastar)
        function startPan(e) {
            if(!state.originalImage) return;
            state.isDragging = true;
            state.startPanX = e.clientX - state.offsetX;
            state.startPanY = e.clientY - state.offsetY;
        }

        function doPan(e) {
            if(!state.isDragging) return;
            state.offsetX = e.clientX - state.startPanX;
            state.offsetY = e.clientY - state.startPanY;
            render();
        }

        /**
         * RENDER PIPELINE
         * O coração da ultra-performance.
         */
        function render() {
            if (!state.originalImage) return;

            // 1. Setup Canvas
            const ctx = state.ctx;
            els.canvas.width = state.width;
            els.canvas.height = state.height;

            // 2. Fundo Branco Puro (padrão de e-commerce)
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, state.width, state.height);

            // 3. Calcular Dimensões
            const img = state.originalImage;
            const aspect = img.width / img.height;
            
            let drawWidth, drawHeight;
            
            // Lógica "Contain" com escala customizável
            const targetSize = state.width * state.scale;

            if (aspect > 1) {
                // Mais largo que alto
                drawWidth = targetSize;
                drawHeight = targetSize / aspect;
            } else {
                // Mais alto que largo
                drawHeight = targetSize;
                drawWidth = targetSize * aspect;
            }

            const x = (state.width - drawWidth) / 2 + state.offsetX;
            const y = (state.height - drawHeight) / 2 + state.offsetY;

            // 4. Sombra de Apoio (Simulada & Editável)
            if (state.shadow) {
                ctx.save();
                // Base shadow position at the bottom of the image rect + Y offset
                const shadowX = x + drawWidth / 2;
                const shadowY = y + drawHeight + state.shadowY;
                
                ctx.translate(shadowX, shadowY);
                ctx.scale(1, 0.15); // Achatamento oval constante
                
                // Shadow radius based on image width and user setting
                const radius = Math.max(1, drawWidth * state.shadowSize);
                
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius);
                gradient.addColorStop(0, `rgba(0,0,0,${state.shadowOpacity})`);
                gradient.addColorStop(1, 'rgba(0,0,0,0)');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }

            // 5. Aplicar Filtros CSS no Contexto (Performance Nativa)
            // Ordem: Brilho -> Contraste -> (Sharpness é manual)
            // Conversão dos valores do range para filtros CSS
            const brightCSS = 100 + state.brightness; // 100 é base
            const contrastCSS = 100 + state.contrast; 
            
            ctx.filter = `brightness(${brightCSS}%) contrast(${contrastCSS}%)`;

            // 6. Desenhar Imagem
            // Se "Remove Background" estiver ativo, precisamos de um passo intermediário
            if (state.removeBg) {
                // Criar canvas temporário para processamento de pixel
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.width;
                tempCanvas.height = img.height;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(img, 0, 0);
                
                // Luma Key Algorithm (Rápido e sujo para branco)
                const imgData = tempCtx.getImageData(0, 0, img.width, img.height);
                const data = imgData.data;
                const threshold = 230; // Tolerância de branco

                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i+1];
                    const b = data[i+2];
                    
                    // Se for muito claro, torna transparente
                    if (r > threshold && g > threshold && b > threshold) {
                        data[i+3] = 0; // Alpha
                    }
                }
                tempCtx.putImageData(imgData, 0, 0);
                
                // Desenhar a imagem processada
                ctx.drawImage(tempCanvas, x, y, drawWidth, drawHeight);
            } else {
                // Desenho direto ultra-rápido
                ctx.drawImage(img, x, y, drawWidth, drawHeight);
            }

            ctx.filter = 'none'; // Reset filtro para próximos draws

            // 7. Nitidez (Convolution Kernel Simples)
            // Aplicado apenas se valor > 0, pois é custoso
            if (state.sharpness > 0) {
                applySharpen(ctx, state.width, state.height, state.sharpness * 0.1);
            }
        }

        // Algoritmo de Nitidez Manual (Já que ctx.filter não tem sharpen nativo cross-browser)
        function applySharpen(ctx, w, h, amount) {
            // Placeholder: Em mobile a convolução pode ser lenta.
        }

        function resizeCanvasDisplay() {
            // Mantém o canvas responsivo no CSS, mas resolução interna fixa
        }

        function downloadImage() {
            // Meta: WebP < 10kb (10240 bytes)
            // Lógica de compressão iterativa "Good enough"
            
            let quality = 0.9; // Começa alto
            let dataUrl = els.canvas.toDataURL('image/webp', quality);
            
            // Cálculo aproximado de tamanho base64: (n * 3) / 4 - padding
            // 10kb ~= 13700 caracteres base64 (margem de segurança)
            const MAX_CHARS = 13700; 

            // Loop simples de redução de qualidade se exceder o tamanho
            // Para 300x300px, raramente precisará de muitos loops
            while (dataUrl.length > MAX_CHARS && quality > 0.1) {
                quality -= 0.1;
                dataUrl = els.canvas.toDataURL('image/webp', quality);
            }

            // Gerar nome final com sufixo
            const userText = els.fileNameInput.value.trim() || '';
            const cleanName = userText.replace(/\s+/g, '-').toLowerCase();
            
            const link = document.createElement('a');
            link.download = `${cleanName}${SEO_SUFFIX}.webp`;
            link.href = dataUrl;
            link.click();
        }

        // Start
        init();

    </script>
</body>
</html>
