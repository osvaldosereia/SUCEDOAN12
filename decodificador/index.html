<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Feed de Produtos</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { background-color: #f0f2f5; padding-bottom: 100px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .header-section { 
            background-color: #fff; 
            padding: 25px; 
            border-bottom: 1px solid #ddd;
            margin-bottom: 25px; 
        }

        .table-container { 
            background-color: #fff; 
            border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            overflow-x: auto; 
            padding: 0;
            border: 1px solid #e0e0e0;
        }
        
        table thead th { 
            background-color: #2c3e50 !important; 
            color: #ffffff !important;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 15px 10px !important;
            border-bottom: 3px solid #1abc9c; 
            white-space: nowrap;
            vertical-align: middle;
        }

        table td { 
            vertical-align: middle; 
            white-space: nowrap; 
            padding: 12px 10px !important;
            font-size: 0.9rem;
        }
        
        .price-input { width: 110px; font-weight: bold; }
        
        .blocked-field { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 6px 10px; 
            border-radius: 4px; 
            color: #6c757d; 
            display: inline-block; 
            min-width: 50px;
        }
        
        .action-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: #212529; color: white; 
            padding: 15px 25px; 
            text-align: right; 
            z-index: 1000; 
            display: none; 
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .row-selected { background-color: #e3f2fd !important; }
        
        input[type=file]::file-selector-button {
            margin-right: 20px;
            border: none;
            background: #0d6efd;
            padding: 10px 20px;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: background .2s ease-in-out;
        }
        input[type=file]::file-selector-button:hover { background: #0b5ed7; }
    </style>
</head>
<body>

    <div class="header-section container-fluid">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h3 class="mb-1 fw-bold text-dark">üì¶ Painel de Produtos</h3>
                <p class="text-muted mb-0">Importe o CSV, selecione os itens e gere o JSON.</p>
            </div>
            <div class="col-md-6 text-end">
                <input type="file" id="csvFileInput" accept=".csv" class="form-control w-auto d-inline-block shadow-sm">
            </div>
        </div>
    </div>

    <div class="container-fluid px-4">
        <div id="loading" class="text-center py-5 d-none">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
            <p class="mt-3 text-muted">Processando e limpando dados...</p>
        </div>

        <div id="tableArea" class="table-container d-none">
            <div class="p-3 bg-light border-bottom d-flex justify-content-between">
                <strong>Lista de Produtos</strong>
                <span class="badge bg-secondary"><span id="totalCount">0</span> itens carregados</span>
            </div>
            <table class="table table-hover mb-0" id="productTable">
                <thead>
                    <tr id="tableHeader">
                        </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="action-bar" id="actionBar">
        <span class="me-4 fs-5">Itens selecionados: <strong id="selectedCount" class="text-warning">0</strong></span>
        <button onclick="exportJSON()" class="btn btn-success btn-lg px-5 fw-bold shadow">
            ‚¨á Baixar JSON
        </button>
    </div>

    <script>
        const TARGET_INDICES = [0, 1, 2, 3, 4, 6, 9, 10, 11, 13, 19, 57];
        
        let allData = []; 
        let headers = []; 
        let descriptionKey = ""; 

        const fileInput = document.getElementById('csvFileInput');
        const loadingDiv = document.getElementById('loading');
        const tableArea = document.getElementById('tableArea');
        const actionBar = document.getElementById('actionBar');

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            loadingDiv.classList.remove('d-none');
            tableArea.classList.add('d-none');
            actionBar.style.display = 'none';

            Papa.parse(file, {
                header: false, 
                encoding: "UTF-8", 
                skipEmptyLines: true,
                delimiter: ";", 
                complete: function(results) {
                    processCSVData(results.data);
                }
            });
        });

        function processCSVData(data) {
            if (data.length < 2) {
                alert("Arquivo vazio.");
                loadingDiv.classList.add('d-none');
                return;
            }

            const originalHeaders = data[0];
            
            // Limpa os nomes das colunas tamb√©m
            headers = TARGET_INDICES.map(i => {
                const rawHeader = originalHeaders[i] || `Coluna ${i}`;
                return rawHeader.trim();
            });
            
            descriptionKey = headers[2]; 

            allData = data.slice(1).map((row, index) => {
                let cleanRow = {};
                TARGET_INDICES.forEach((colIndex, i) => {
                    // --- CORRE√á√ÉO DO EAN E DADOS SUJOS ---
                    // Pegamos o valor cru, convertemos para string e usamos .trim()
                    // Isso remove o \t e espa√ßos em branco das pontas
                    let rawValue = row[colIndex];
                    if (rawValue === undefined || rawValue === null) rawValue = "";
                    
                    cleanRow[headers[i]] = String(rawValue).trim();
                });
                
                return {
                    _id: index,
                    originalData: cleanRow,
                    selected: false,
                    isOffer: false,
                    offerPrice: ""
                };
            });

            renderTable();
            loadingDiv.classList.add('d-none');
            tableArea.classList.remove('d-none');
            actionBar.style.display = 'block';
            document.getElementById('totalCount').innerText = allData.length;
        }

        function renderTable() {
            const thead = document.getElementById('tableHeader');
            const tbody = document.getElementById('tableBody');

            // --- Checkbox "Selecionar Todos" no cabe√ßalho ---
            let headerHTML = `
                <th class="text-center" width="50">
                    <input type="checkbox" class="form-check-input" 
                           style="cursor:pointer; transform: scale(1.2); border: 2px solid #fff;"
                           id="selectAllCheckbox"
                           onchange="toggleSelectAll(this.checked)"
                           title="Selecionar Todos">
                </th>
                <th width="180">Oferta?</th>
            `;
            headers.forEach(h => {
                headerHTML += `<th>${h}</th>`;
            });
            thead.innerHTML = headerHTML;

            let bodyHTML = '';
            
            // Mantendo limite visual de 500 para performance
            const displayData = allData.length > 500 ? allData.slice(0, 500) : allData;

            displayData.forEach((item, idx) => {
                bodyHTML += `
                <tr class="${item.selected ? 'row-selected' : ''}" id="row-${idx}">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input row-checkbox" 
                               style="cursor:pointer; transform: scale(1.2);"
                               onchange="toggleSelect(${idx}, this.checked)" 
                               ${item.selected ? 'checked' : ''}>
                    </td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" style="cursor:pointer;"
                                       id="offer-check-${idx}"
                                       onchange="toggleOffer(${idx}, this.checked)"
                                       ${item.isOffer ? 'checked' : ''}>
                            </div>
                            <input type="number" step="0.01" class="form-control form-control-sm price-input" 
                                   placeholder="R$ Novo"
                                   id="offer-price-${idx}"
                                   value="${item.offerPrice}"
                                   oninput="updatePrice(${idx}, this.value)"
                                   ${!item.isOffer ? 'disabled' : ''}>
                        </div>
                    </td>
                    ${headers.map(h => `
                        <td>
                            <span class="blocked-field" title="${item.originalData[h]}">${item.originalData[h]}</span>
                        </td>
                    `).join('')}
                </tr>
                `;
            });
            
            if(allData.length > 500) {
                bodyHTML += `<tr><td colspan="${headers.length + 2}" class="text-center text-muted p-3">Exibindo os primeiros 500 itens. O "Selecionar Todos" afeta todos os ${allData.length} itens.</td></tr>`;
            }

            tbody.innerHTML = bodyHTML;
            updateCounter();
        }

        // --- L√≥gica de Neg√≥cio ---

        // Fun√ß√£o Nova: Selecionar Todos
        function toggleSelectAll(isChecked) {
            // Atualiza o estado de todos os dados na mem√≥ria
            allData.forEach(item => {
                item.selected = isChecked;
            });
            
            // Re-renderiza a tabela para mostrar as mudan√ßas visuais
            renderTable();
            
            // Mant√©m o estado do checkbox mestre (pois o renderTable reseta o HTML)
            setTimeout(() => {
                const masterCheck = document.getElementById('selectAllCheckbox');
                if(masterCheck) masterCheck.checked = isChecked;
            }, 0);
        }

        function toggleSelect(index, isChecked) {
            allData[index].selected = isChecked;
            const row = document.getElementById(`row-${index}`);
            if(row) {
                if(isChecked) row.classList.add('row-selected');
                else row.classList.remove('row-selected');
            }
            updateCounter();
            checkMasterCheckboxState();
        }

        function toggleOffer(index, isChecked) {
            allData[index].isOffer = isChecked;
            const input = document.getElementById(`offer-price-${index}`);
            if(input) {
                input.disabled = !isChecked;
                if (isChecked) {
                    toggleSelect(index, true); 
                    document.getElementById(`row-${index}`).querySelector('.row-checkbox').checked = true;
                    input.focus();
                }
            }
        }

        function updatePrice(index, value) {
            allData[index].offerPrice = value;
        }

        function updateCounter() {
            const count = allData.filter(i => i.selected).length;
            document.getElementById('selectedCount').innerText = count;
        }

        // Verifica se todos est√£o selecionados para marcar o checkbox mestre visualmente
        function checkMasterCheckboxState() {
            const allSelected = allData.length > 0 && allData.every(i => i.selected);
            const masterCheck = document.getElementById('selectAllCheckbox');
            if(masterCheck) masterCheck.checked = allSelected;
        }

        function generateImageSlug(productName) {
            if (!productName) return "produto-sem-nome";
            return productName
                .toString()
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, "") 
                .replace(/\s+/g, '-')     
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-')   
                .replace(/^-+/, '')       
                .replace(/-+$/, '');      
        }

        function exportJSON() {
            const selectedItems = allData.filter(i => i.selected);

            if (selectedItems.length === 0) {
                alert("Nenhum produto selecionado!");
                return;
            }

            const imgPrefix = "../site/img/produtos/";
            const imgSuffix = "-cesta-basica-cuiaba-varzea-grande.webp";

            const finalData = selectedItems.map(item => {
                let exportObj = { ...item.originalData };
                
                exportObj["Em_Oferta"] = item.isOffer;
                exportObj["Preco_Oferta"] = item.isOffer ? item.offerPrice : null;
                
                const rawName = exportObj[descriptionKey] || "";
                const slug = generateImageSlug(rawName);
                exportObj["imagem"] = `${imgPrefix}${slug}${imgSuffix}`;
                
                return exportObj;
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "produtos_exportados.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>
