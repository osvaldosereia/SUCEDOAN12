<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Feed Otimizado</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { background-color: #f4f6f9; padding-bottom: 120px; font-family: 'Segoe UI', sans-serif; }
        
        .header-section { 
            background-color: #fff; 
            padding: 20px; 
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px; 
        }

        /* Tabela Limpa e Fixa */
        .table-container {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow: hidden; /* Remove scroll duplo */
        }

        table { width: 100%; border-collapse: collapse; }

        /* Cabeçalho Sticky (Fixo no topo ao rolar a página) */
        table thead th { 
            background-color: #34495e !important; 
            color: #fff !important;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 15px 10px !important;
            cursor: pointer; /* Indica que é clicável para ordenar */
            user-select: none;
        }

        table thead th:hover { background-color: #2c3e50 !important; }

        table td { 
            vertical-align: middle; 
            padding: 10px 12px !important;
            border-bottom: 1px solid #eee;
        }

        /* Coluna de Ação Fixa na esquerda (opcional, mas ajuda em mobile) */
        .col-action { width: 60px; text-align: center; }
        .col-offer { width: 180px; }

        .price-input { width: 100%; max-width: 100px; font-weight: bold; border: 1px solid #ccc; }
        .price-input:focus { border-color: #1abc9c; box-shadow: 0 0 0 0.2rem rgba(26, 188, 156, 0.25); }

        .row-selected { background-color: #e8f6f3 !important; }
        
        .action-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: #2c3e50; color: white; 
            padding: 15px 30px; 
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000; 
            box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
            transform: translateY(100%); transition: transform 0.3s ease;
        }
        .action-bar.visible { transform: translateY(0); }

        /* Estilo do Search */
        .search-box { position: relative; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .search-box input { padding-left: 40px; border-radius: 20px; }

        .hidden-col { display: none; }
    </style>
</head>
<body>

    <div class="header-section sticky-top container-fluid">
        <div class="row align-items-center g-3">
            <div class="col-md-3">
                <h4 class="mb-0 fw-bold text-dark"><i class="bi bi-box-seam"></i> Gestor de Feed</h4>
            </div>
            
            <div class="col-md-5">
                <div class="search-box d-none" id="searchContainer">
                    <i class="bi bi-search"></i>
                    <input type="text" id="searchInput" class="form-control" placeholder="Buscar por Nome ou EAN..." onkeyup="filterTable()">
                </div>
            </div>

            <div class="col-md-4 text-end">
                <input type="file" id="csvFileInput" accept=".csv" class="form-control d-inline-block w-auto">
            </div>
        </div>
    </div>

    <div class="container-fluid px-4">
        <div id="loading" class="text-center py-5 d-none">
            <div class="spinner-border text-success" role="status"></div>
            <p class="mt-2 text-muted">Processando dados...</p>
        </div>

        <div id="tableArea" class="table-container d-none">
            <div class="p-2 bg-light border-bottom d-flex justify-content-between align-items-center">
                <small class="text-muted ms-2">Clique nos títulos das colunas para ordenar.</small>
                <span class="badge bg-secondary me-2"><span id="totalVisible">0</span> produtos listados</span>
            </div>
            <table class="table table-hover mb-0" id="productTable">
                <thead>
                    <tr id="tableHeader"></tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div class="action-bar" id="actionBar">
        <div>
            <span class="fs-5">Selecionados: <strong id="selectedCount" class="text-warning">0</strong></span>
        </div>
        <button onclick="exportJSON()" class="btn btn-success fw-bold px-4 shadow">
            <i class="bi bi-filetype-json"></i> Baixar JSON
        </button>
    </div>

    <script>
        // --- CONFIGURAÇÃO ---
        // Indices baseados no seu CSV
        // 0:Empresa, 1:Forn, 2:Desc, 3:Unid, 4:Emb, 6:Ref, 9:NCM, 10:EAN, 13:Estoque, 19:Preco, 57:Cod
        const TARGET_INDICES = [0, 1, 2, 3, 4, 6, 9, 10, 11, 13, 19, 57];
        
        // Colunas que QUEREMOS VER na tabela (Indices relativos ao TARGET_INDICES acima)
        // Mapeamento:
        // 2 (Original CSV) -> Descrição é o item de indice 2 no array TARGET_INDICES
        // Para simplificar, vamos usar os nomes das colunas identificadas.
        
        // Definição do que é visível (Keywords parciais para identificar colunas)
        // Se a coluna contiver estes termos, ela APARECE. O resto fica oculto.
        const VISIBLE_KEYWORDS = ["descri", "nome", "preço", "valor", "estoque", "emb"]; 
        
        // Campos onde a busca vai atuar (Indice real do CSV)
        const SEARCH_FIELDS_INDICES = [2, 10, 6]; // 2=Nome, 10=EAN, 6=Codigo

        let allData = []; // Dados completos
        let displayedData = []; // Dados filtrados/ordenados atuais
        let headers = []; 
        let descriptionKey = ""; 
        let sortDirection = 1; // 1 = ASC, -1 = DESC
        let currentSortColumn = null;

        const fileInput = document.getElementById('csvFileInput');
        const loadingDiv = document.getElementById('loading');
        const tableArea = document.getElementById('tableArea');
        const actionBar = document.getElementById('actionBar');
        const searchContainer = document.getElementById('searchContainer');

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            loadingDiv.classList.remove('d-none');
            tableArea.classList.add('d-none');
            searchContainer.classList.add('d-none');
            actionBar.classList.remove('visible');

            Papa.parse(file, {
                header: false, 
                encoding: "UTF-8", 
                skipEmptyLines: true,
                delimiter: ";", 
                complete: function(results) {
                    processCSVData(results.data);
                }
            });
        });

        function processCSVData(data) {
            if (data.length < 2) {
                alert("Arquivo vazio.");
                loadingDiv.classList.add('d-none');
                return;
            }

            const originalHeaders = data[0];
            
            // Mapeia os nomes das colunas baseados nos indices alvo
            headers = TARGET_INDICES.map(i => {
                const rawHeader = originalHeaders[i] || `Col_${i}`;
                return rawHeader.trim();
            });
            
            descriptionKey = headers[2]; // Assumindo que o índice 2 do TARGET é a descrição

            // Processa linhas
            allData = data.slice(1).map((row, index) => {
                let cleanRow = {};
                let searchString = "";

                TARGET_INDICES.forEach((colIndex, i) => {
                    let rawValue = row[colIndex];
                    if (rawValue === undefined || rawValue === null) rawValue = "";
                    let strValue = String(rawValue).trim();
                    
                    cleanRow[headers[i]] = strValue;

                    // Constrói string de busca (Nome + EAN + Codigo)
                    if (SEARCH_FIELDS_INDICES.includes(colIndex)) {
                        searchString += " " + strValue.toLowerCase();
                    }
                });
                
                return {
                    _id: index,
                    originalData: cleanRow,
                    searchStr: searchString, // Cache para busca rápida
                    selected: false,
                    isOffer: false,
                    offerPrice: ""
                };
            });

            displayedData = [...allData]; // Inicialmente exibe tudo
            
            renderHeader(); // Renderiza o cabeçalho apenas uma vez
            renderTableBody(); // Renderiza o corpo
            
            loadingDiv.classList.add('d-none');
            tableArea.classList.remove('d-none');
            searchContainer.classList.remove('d-none');
            actionBar.classList.add('visible');
            
            document.getElementById('totalVisible').innerText = allData.length;
        }

        // --- SISTEMA DE VISIBILIDADE DE COLUNAS ---
        function isColumnVisible(headerName) {
            const h = headerName.toLowerCase();
            // Verifica se o cabeçalho contém alguma das palavras chave permitidas
            return VISIBLE_KEYWORDS.some(key => h.includes(key));
        }

        // --- RENDERIZAÇÃO ---
        function renderHeader() {
            const thead = document.getElementById('tableHeader');
            
            let headerHTML = `
                <th class="col-action text-center">
                    <input type="checkbox" class="form-check-input" 
                           id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
                </th>
                <th class="col-offer">Oferta / Preço</th>
            `;

            headers.forEach((h, index) => {
                if (isColumnVisible(h)) {
                    headerHTML += `<th onclick="sortTable('${h}')">
                        ${h} <i class="bi bi-arrow-down-up ms-1" style="font-size:0.8em; opacity:0.5"></i>
                    </th>`;
                }
            });
            thead.innerHTML = headerHTML;
        }

        function renderTableBody() {
            const tbody = document.getElementById('tableBody');
            
            // Limite visual para performance se não estiver filtrando
            const limit = (displayedData.length > 500 && document.getElementById('searchInput').value === "") ? 500 : displayedData.length;
            const dataToRender = displayedData.slice(0, limit);

            let bodyHTML = '';

            dataToRender.forEach((item) => {
                // Monta as colunas dinâmicas visíveis
                let columnsHTML = '';
                headers.forEach(h => {
                    if (isColumnVisible(h)) {
                        columnsHTML += `<td>${item.originalData[h]}</td>`;
                    }
                });

                bodyHTML += `
                <tr class="${item.selected ? 'row-selected' : ''}" id="row-${item._id}">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input row-checkbox" 
                               onchange="toggleSelect(${item._id}, this.checked)" 
                               ${item.selected ? 'checked' : ''}>
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <div class="input-group-text">
                                <input class="form-check-input mt-0" type="checkbox" 
                                       onchange="toggleOffer(${item._id}, this.checked)"
                                       ${item.isOffer ? 'checked' : ''}>
                            </div>
                            <input type="number" step="0.01" class="form-control price-input" 
                                   placeholder="R$"
                                   id="price-${item._id}"
                                   value="${item.offerPrice}"
                                   oninput="updatePrice(${item._id}, this.value)"
                                   ${!item.isOffer ? 'disabled' : ''}>
                        </div>
                    </td>
                    ${columnsHTML}
                </tr>
                `;
            });

            if (displayedData.length > limit) {
                bodyHTML += `<tr><td colspan="10" class="text-center text-muted p-3">
                    Exibindo ${limit} de ${displayedData.length} itens. Use a busca para encontrar itens específicos.
                </td></tr>`;
            } else if (displayedData.length === 0) {
                 bodyHTML += `<tr><td colspan="10" class="text-center text-muted p-5">
                    Nenhum produto encontrado.
                </td></tr>`;
            }

            tbody.innerHTML = bodyHTML;
            document.getElementById('totalVisible').innerText = displayedData.length;
            updateCounter();
        }

        // --- FILTRO (PESQUISA) ---
        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (term === "") {
                displayedData = [...allData];
            } else {
                // Busca na string pré-processada (Nome + EAN + Cod)
                displayedData = allData.filter(item => item.searchStr.includes(term));
            }
            
            // Mantém a ordenação atual se houver
            if (currentSortColumn) {
                applySort();
            }
            
            renderTableBody();
        }

        // --- ORDENAÇÃO ---
        function sortTable(columnName) {
            if (currentSortColumn === columnName) {
                sortDirection *= -1; // Inverte
            } else {
                currentSortColumn = columnName;
                sortDirection = 1; // Reset para ASC
            }
            applySort();
            renderTableBody();
        }

        function applySort() {
            if (!currentSortColumn) return;

            displayedData.sort((a, b) => {
                let valA = a.originalData[currentSortColumn];
                let valB = b.originalData[currentSortColumn];

                // Tenta converter para número para ordenar corretamente preços e estoques
                // Remove R$, pontos de milhar e troca vírgula por ponto
                const numA = parseFloat(valA.replace(/[^\d,-]/g, '').replace(',', '.'));
                const numB = parseFloat(valB.replace(/[^\d,-]/g, '').replace(',', '.'));

                if (!isNaN(numA) && !isNaN(numB)) {
                    return (numA - numB) * sortDirection;
                }

                return valA.localeCompare(valB) * sortDirection;
            });
        }

        // --- LÓGICA DE SELEÇÃO E DADOS ---

        function toggleSelectAll(isChecked) {
            // Aplica APENAS aos itens visíveis no filtro atual
            displayedData.forEach(item => {
                // Precisamos atualizar o objeto original no allData também
                const originalItem = allData.find(x => x._id === item._id);
                if(originalItem) originalItem.selected = isChecked;
            });
            renderTableBody();
        }

        function toggleSelect(id, isChecked) {
            const item = allData.find(i => i._id === id);
            if (item) {
                item.selected = isChecked;
                const row = document.getElementById(`row-${id}`);
                if (row) {
                    if (isChecked) row.classList.add('row-selected');
                    else row.classList.remove('row-selected');
                }
                updateCounter();
            }
        }

        function toggleOffer(id, isChecked) {
            const item = allData.find(i => i._id === id);
            if (item) {
                item.isOffer = isChecked;
                const input = document.getElementById(`price-${id}`);
                if (input) {
                    input.disabled = !isChecked;
                    if (isChecked) {
                        toggleSelect(id, true);
                        document.getElementById(`row-${id}`).querySelector('.row-checkbox').checked = true;
                        input.focus();
                    }
                }
            }
        }

        function updatePrice(id, value) {
            const item = allData.find(i => i._id === id);
            if(item) item.offerPrice = value;
        }

        function updateCounter() {
            const count = allData.filter(i => i.selected).length;
            document.getElementById('selectedCount').innerText = count;
        }

        function generateImageSlug(productName) {
            if (!productName) return "produto-sem-nome";
            return productName
                .toString()
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, "") 
                .replace(/\s+/g, '-')     
                .replace(/[^\w\-]+/g, '') 
                .replace(/\-\-+/g, '-')   
                .replace(/^-+/, '')       
                .replace(/-+$/, '');      
        }

        function exportJSON() {
            const selectedItems = allData.filter(i => i.selected);

            if (selectedItems.length === 0) {
                alert("Nenhum produto selecionado!");
                return;
            }

            const imgPrefix = "../site/img/produtos/";
            const imgSuffix = "-cesta-basica-cuiaba-varzea-grande.webp";

            const finalData = selectedItems.map(item => {
                let exportObj = { ...item.originalData };
                
                exportObj["Em_Oferta"] = item.isOffer;
                exportObj["Preco_Oferta"] = item.isOffer ? item.offerPrice : null;
                
                const rawName = exportObj[descriptionKey] || "";
                const slug = generateImageSlug(rawName);
                exportObj["imagem"] = `${imgPrefix}${slug}${imgSuffix}`;
                
                return exportObj;
            });

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(finalData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "produtos_exportados.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>
</html>
