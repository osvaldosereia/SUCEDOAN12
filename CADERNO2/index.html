<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite Log√≠stica - Painel do Entregador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .btn-transition { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-transition:active { transform: scale(0.95); }
        input:focus, select:focus, textarea:focus { outline: none; ring: 2px; ring-color: #6366f1; border-color: #6366f1; }
        @media print { 
            .no-print { display: none !important; } 
            .print-page { page-break-after: always; padding: 15mm; }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-10">

    <header class="bg-indigo-700 text-white shadow-lg no-print sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-2xl">üöö</span>
                <h1 class="text-xl font-bold tracking-tight uppercase">Elite<span class="font-light">Log√≠stica</span></h1>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="dbExport()" class="bg-white/10 hover:bg-white/20 btn-transition px-4 py-2 rounded-lg text-xs font-bold border border-white/20">
                    üì• Backup
                </button>
                <label class="bg-white text-indigo-700 hover:bg-slate-100 btn-transition px-4 py-2 rounded-lg text-xs font-black cursor-pointer shadow-sm">
                    üì§ Importar
                    <input type="file" class="hidden" onchange="dbImport(event)">
                </label>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-6 no-print">
        
        <nav class="flex bg-slate-200/50 p-1.5 rounded-xl w-fit mx-auto md:mx-0">
            <button onclick="switchTab('c')" id="tab-c" class="py-2.5 px-6 rounded-lg font-bold text-sm btn-transition bg-white text-indigo-600 shadow-sm">
                Base de Clientes
            </button>
            <button onclick="switchTab('l')" id="tab-l" class="py-2.5 px-6 rounded-lg font-bold text-sm btn-transition text-slate-600">
                Log√≠stica (Roteiriza√ß√£o)
            </button>
        </nav>

        <!-- ABA CADASTRO DE CLIENTES -->
        <section id="section-c" class="space-y-6 animate-in fade-in duration-500">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold flex items-center gap-2 text-slate-800">
                        <span class="w-2 h-6 bg-indigo-600 rounded-full"></span>
                        Cadastro T√°tico de Cliente
                    </h2>
                    <button onclick="resetForm()" class="text-xs font-semibold text-indigo-600 hover:text-indigo-800 bg-indigo-50 px-3 py-1.5 rounded-full transition">Limpar</button>
                </div>
                
                <form id="client-form" class="grid grid-cols-1 md:grid-cols-12 gap-4" onsubmit="saveClient(event)">
                    <input type="hidden" id="edit-idx" value="-1">
                    
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">C√≥d. Interno</label>
                        <input type="text" id="c-code" readonly class="w-full bg-slate-100 border-slate-200 border-2 p-3 rounded-xl font-mono text-indigo-600 font-bold">
                    </div>
                    
                    <div class="md:col-span-6">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Nome / Raz√£o Social</label>
                        <input type="text" id="c-name" placeholder="Nome do cliente" required class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50 focus:bg-white transition-all">
                    </div>

                    <div class="md:col-span-4">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">WhatsApp (Apenas N√∫meros)</label>
                        <input type="text" id="c-wa" placeholder="6599999999" class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50 focus:bg-white transition-all">
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Cidade</label>
                        <select id="c-city" class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50 h-[52px]">
                            <option value="Cuiab√°">Cuiab√°</option>
                            <option value="V√°rzea Grande">V√°rzea Grande</option>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Bairro</label>
                        <input type="text" id="c-neighborhood" placeholder="Bairro" required class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50">
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Setor / Rota</label>
                        <select id="c-route" class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50 h-[52px] font-black text-indigo-600">
                            <option value="COXIPO">COXIP√ì</option>
                            <option value="VG">V√ÅRZEA GRANDE</option>
                            <option value="CBA">CENTRO / NORTE</option>
                            <option value="CPA">CPA / ARREDORES</option>
                        </select>
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Link Google Maps</label>
                        <input type="url" id="c-map" placeholder="https://maps..." class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50">
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1">Endere√ßo Completo</label>
                        <input type="text" id="c-address" placeholder="Rua, N√∫mero, Ponto de Refer√™ncia..." required class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50">
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 ml-1 text-orange-600">Observa√ß√µes Fixas de Entrega (Ex: Port√£o azul, interfone 202...)</label>
                        <textarea id="c-obs" rows="2" placeholder="Informa√ß√µes que o entregador precisa saber sempre que for a este local..." class="w-full border-slate-200 border-2 p-3 rounded-xl bg-slate-50 focus:bg-white"></textarea>
                    </div>

                    <div class="md:col-span-12 flex justify-end">
                        <button type="submit" id="btn-save" class="w-full md:w-64 bg-indigo-600 hover:bg-indigo-700 text-white font-black py-4 rounded-2xl shadow-lg btn-transition text-lg">
                            Salvar Cadastro
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b border-slate-200 flex flex-wrap gap-4 justify-between items-center">
                    <h3 class="font-bold text-slate-700 uppercase text-xs tracking-widest">Base de Dados</h3>
                    <input type="text" id="search-client" oninput="renderClients()" placeholder="Procurar cliente..." class="text-sm border-2 border-slate-200 p-2.5 rounded-xl w-full md:w-80">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-400 text-[10px] uppercase font-black">
                                <th class="p-4">C√≥d</th>
                                <th class="p-4">Cliente</th>
                                <th class="p-4">Local / Rota</th>
                                <th class="p-4 text-center">Gest√£o</th>
                            </tr>
                        </thead>
                        <tbody id="client-table-body" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- ABA LOG√çSTICA / ROTEIRIZA√á√ÉO -->
        <section id="section-l" class="hidden space-y-6 animate-in slide-in-from-bottom-4 duration-500">
            <div class="bg-white p-10 rounded-3xl shadow-sm border border-slate-200 text-center space-y-4 border-dashed border-4 border-indigo-100">
                <div class="w-20 h-20 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mx-auto text-4xl">üßæ</div>
                <h2 class="text-2xl font-black text-slate-800">Processar Entregas do Dia</h2>
                <p class="text-slate-500 max-w-sm mx-auto text-sm">Carregue o arquivo de pedidos para mapear os endere√ßos e dividir as tarefas dos entregadores.</p>
                
                <div class="pt-4">
                    <label class="bg-indigo-600 text-white px-10 py-5 rounded-2xl font-black text-xl cursor-pointer hover:bg-indigo-700 btn-transition shadow-xl inline-flex items-center gap-3">
                        <span>üìÇ Carregar JSON</span>
                        <input type="file" class="hidden" accept=".json" onchange="importOrders(event)">
                    </label>
                </div>
            </div>

            <div id="route-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Cards de Entrega Injetados Aqui -->
            </div>
        </section>
    </main>

    <script>
        let clients = [];
        let importedOrders = [];
        const $ = i => document.getElementById(i);

        window.onload = () => {
            const stored = localStorage.getItem('elite_clients');
            if(stored) clients = JSON.parse(stored);
            updateAutoCode();
            renderClients();
        };

        const updateAutoCode = () => {
            if($('edit-idx').value == -1) {
                const next = clients.reduce((max, c) => Math.max(max, parseInt(c.code) || 0), 0) + 1;
                $('c-code').value = String(next).padStart(3, '0');
            }
        };

        const switchTab = t => {
            $('section-c').classList.toggle('hidden', t === 'l');
            $('section-l').classList.toggle('hidden', t === 'c');
            const active = "py-2.5 px-6 rounded-lg font-bold text-sm btn-transition bg-white text-indigo-600 shadow-sm";
            const inactive = "py-2.5 px-6 rounded-lg font-bold text-sm btn-transition text-slate-600";
            $('tab-c').className = t === 'c' ? active : inactive;
            $('tab-l').className = t === 'l' ? active : inactive;
        };

        const saveClient = e => {
            e.preventDefault();
            const idx = parseInt($('edit-idx').value);
            const data = {
                code: $('c-code').value,
                name: $('c-name').value,
                wa: $('c-wa').value.replace(/\D/g, ''),
                city: $('c-city').value,
                neighborhood: $('c-neighborhood').value,
                route: $('c-route').value,
                address: $('c-address').value,
                map: $('c-map').value,
                obs: $('c-obs').value
            };

            if(idx === -1) clients.push(data);
            else clients[idx] = data;

            localStorage.setItem('elite_clients', JSON.stringify(clients));
            resetForm();
            renderClients();
        };

        const resetForm = () => {
            $('client-form').reset();
            $('edit-idx').value = -1;
            $('btn-save').innerText = "Salvar Cadastro";
            updateAutoCode();
        };

        const renderClients = () => {
            const query = $('search-client').value.toLowerCase();
            const filtered = clients.filter(c => c.name.toLowerCase().includes(query) || c.code.includes(query));

            $('client-table-body').innerHTML = filtered.map((c, i) => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="p-4 font-mono font-bold text-indigo-600">#${c.code}</td>
                    <td class="p-4">
                        <div class="font-bold text-slate-800 uppercase">${c.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold">${c.wa || '---'}</div>
                    </td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <span class="text-[9px] bg-slate-900 text-white px-1.5 rounded font-black">${c.route}</span>
                            <span class="text-[10px] text-slate-500 font-bold italic">${c.neighborhood}</span>
                        </div>
                    </td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-1">
                            <button onclick="editClient(${clients.indexOf(c)})" class="p-2 hover:bg-indigo-50 rounded-lg transition">‚úèÔ∏è</button>
                            <button onclick="deleteClient(${clients.indexOf(c)})" class="p-2 hover:bg-red-50 text-red-400 rounded-lg transition">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        };

        const editClient = i => {
            const c = clients[i];
            $('edit-idx').value = i;
            $('c-code').value = c.code;
            $('c-name').value = c.name;
            $('c-wa').value = c.wa;
            $('c-city').value = c.city;
            $('c-neighborhood').value = c.neighborhood;
            $('c-route').value = c.route;
            $('c-address').value = c.address;
            $('c-map').value = c.map;
            $('c-obs').value = c.obs || '';
            $('btn-save').innerText = "Atualizar Cadastro";
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        const deleteClient = i => { if(confirm('Excluir?')) { clients.splice(i, 1); localStorage.setItem('elite_clients', JSON.stringify(clients)); renderClients(); } };

        const importOrders = e => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = x => {
                try {
                    const data = JSON.parse(x.target.result);
                    importedOrders = Array.isArray(data) ? data : (data.ords || []);
                    processLogistics();
                } catch(err) { alert("Arquivo inv√°lido"); }
            };
            reader.readAsText(file);
        };

        const processLogistics = () => {
            const container = $('route-container');
            container.innerHTML = '';
            const routes = { "COXIPO": [], "VG": [], "CBA": [], "CPA": [], "DESCONHECIDO": [] };

            importedOrders.forEach(order => {
                const client = clients.find(c => c.code === order.clientCode);
                const routeKey = client ? client.route : "DESCONHECIDO";
                routes[routeKey].push({ order, client });
            });

            Object.keys(routes).forEach(key => {
                if(routes[key].length === 0) return;
                const card = document.createElement('div');
                card.className = "bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden flex flex-col h-fit";
                card.innerHTML = `
                    <div class="p-5 bg-indigo-900 text-white flex justify-between items-center">
                        <h4 class="font-black text-lg">ROTA: ${key}</h4>
                        <span class="bg-indigo-500/50 px-3 py-1 rounded-full text-xs font-black">${routes[key].length} ENTREGAS</span>
                    </div>
                    <div class="p-4 space-y-4 bg-slate-100/50">
                        ${routes[key].map(item => {
                            const c = item.client;
                            const o = item.order;
                            return `
                            <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-3">
                                <div class="flex justify-between items-start">
                                    <div class="leading-tight">
                                        <div class="text-[10px] font-black text-indigo-500 uppercase tracking-widest mb-1">Pedido #${o.code}</div>
                                        <div class="text-lg font-black text-slate-800 uppercase">${c ? c.name : 'CLIENTE N√ÉO CADASTRADO'}</div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-xl font-black text-slate-900">R$ ${o.total.toFixed(2)}</div>
                                    </div>
                                </div>

                                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                                    <div class="text-[10px] font-black text-indigo-400 uppercase mb-1">Endere√ßo de Entrega</div>
                                    <div class="text-sm font-bold text-indigo-900 leading-tight">${c ? c.address : '<span class="text-red-500">Endere√ßo n√£o encontrado. Cadastre o cliente!</span>'}</div>
                                    <div class="text-xs font-black text-indigo-700 mt-1 uppercase">${c ? `${c.neighborhood} - ${c.city}` : '---'}</div>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    ${c && c.wa ? `<a href="https://wa.me/55${c.wa}" target="_blank" class="bg-green-500 text-white p-3 rounded-xl flex items-center justify-center gap-2 font-black text-xs btn-transition shadow-sm">WHATSAPP</a>` : ''}
                                    ${c && c.map ? `<a href="${c.map}" target="_blank" class="bg-slate-900 text-white p-3 rounded-xl flex items-center justify-center gap-2 font-black text-xs btn-transition shadow-sm">ABRIR MAPA</a>` : ''}
                                </div>

                                ${c && c.obs ? `
                                <div class="bg-orange-50 p-3 rounded-xl border border-orange-100">
                                    <div class="text-[9px] font-black text-orange-600 uppercase mb-1">Instru√ß√£o Fixa do Cliente</div>
                                    <div class="text-[11px] font-bold text-orange-800 leading-tight">${c.obs}</div>
                                </div>` : ''}

                                ${o.obs ? `
                                <div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
                                    <div class="text-[9px] font-black text-blue-600 uppercase mb-1">Anota√ß√£o deste Pedido</div>
                                    <div class="text-[11px] font-bold text-blue-800 leading-tight italic">"${o.obs}"</div>
                                </div>` : ''}

                                <div class="border-t pt-3">
                                    <div class="text-[9px] font-black text-slate-400 uppercase mb-2">Itens para Conferir:</div>
                                    <div class="flex flex-wrap gap-2">
                                        ${o.items.map(i => `<span class="bg-slate-100 text-slate-700 text-[10px] px-2 py-1 rounded-md font-bold">${i.qty}x ${i.name}</span>`).join('')}
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <button onclick="printRoute('${key}', ${JSON.stringify(routes[key]).replace(/"/g, '&quot;')})" class="w-full bg-slate-900 text-white p-5 font-black uppercase text-sm hover:bg-slate-800 btn-transition">Imprimir Romaneio ${key}</button>
                `;
                container.appendChild(card);
            });
        };

        const printRoute = (routeName, items) => {
            const w = window.open('', '', 'width=900,height=600');
            const html = `
                <html><head><style>
                    body{font-family:sans-serif; padding:10mm; line-height:1.2; color:#000}
                    .h{text-align:center; border-bottom:4px solid #000; padding-bottom:5mm; margin-bottom:8mm}
                    .route{font-size:32px; font-weight:900; text-transform:uppercase}
                    .box{border:2px solid #000; padding:6mm; margin-bottom:8mm; page-break-inside:avoid; border-radius:5mm}
                    .addr{font-size:20px; font-weight:800; background:#eee; padding:2mm; margin:3mm 0}
                    .b{font-weight:bold} .u{text-transform:uppercase}
                    .obs-box{border:1px solid #000; padding:3mm; margin-top:3mm; background:#fff}
                    .items{font-size:14px; margin-top:4mm; border-top:1px dashed #000; padding-top:2mm}
                </style></head><body>
                    <div class="h">
                        <div class="route">ROTA: ${routeName}</div>
                        <div class="b">ROMANEIO T√ÅTICO DE ENTREGA | ${new Date().toLocaleDateString('pt-BR')}</div>
                    </div>
                    ${items.map((it, idx) => `
                        <div class="box">
                            <div style="display:flex; justify-between; align-items:center">
                                <span style="font-size:24px; font-weight:900">#${idx+1} [Pedido ${it.order.code}]</span>
                                <span style="margin-left:auto; font-size:20px; font-weight:900">VALOR: R$ ${it.order.total.toFixed(2)}</span>
                            </div>
                            <div style="font-size:18px; margin-top:2mm" class="b u">CLIENTE: ${it.client ? it.client.name : 'N√ÉO CADASTRADO'}</div>
                            <div class="addr u">END: ${it.client ? it.client.address : '---'}</div>
                            <div style="font-size:16px" class="b u">BAIRRO: ${it.client ? it.client.neighborhood : '---'} | FONE: ${it.client ? it.client.wa : '---'}</div>
                            
                            ${it.client?.obs ? `<div class="obs-box b">REFER√äNCIA: ${it.client.obs}</div>` : ''}
                            ${it.order.obs ? `<div class="obs-box">OBS DO PEDIDO: ${it.order.obs}</div>` : ''}
                            
                            <div class="items">
                                <div class="b">CONFER√äNCIA DE ITENS:</div>
                                ${it.order.items.map(i => `<div>[ ] ${i.qty}x ${i.name}</div>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                    <script>setTimeout(() => { window.print(); window.close(); }, 500);<\/script>
                </body></html>
            `;
            w.document.write(html);
            w.document.close();
        };

        const dbExport = () => {
            const dl = document.createElement('a');
            dl.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(clients));
            dl.download = `backup_clientes_${new Date().toISOString().slice(0,10)}.json`;
            dl.click();
        };

        const dbImport = e => {
            const r = new FileReader();
            r.onload = x => { try { clients = JSON.parse(x.target.result); localStorage.setItem('elite_clients', JSON.stringify(clients)); renderClients(); alert("Importado!"); } catch(e){alert("Erro!");} };
            r.readAsText(e.target.files[0]);
        };
    </script>
</body>
</html>
