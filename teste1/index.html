<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V15 | NFe Import Core</title>
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --radius: 6px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; font-size: 14px; padding-bottom: 60px; }
        
        /* --- 2. LAYOUT UTILS --- */
        .flex { display: flex; align-items: center; gap: 8px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; }
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        
        /* --- 3. COMPONENTS --- */
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 20px; position: sticky; top: 0; z-index: 50; box-shadow: var(--shadow); }
        h1 { font-size: 1.1rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; }

        main { max-width: 1400px; margin: 20px auto; padding: 0 15px; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { main { grid-template-columns: 420px 1fr; align-items: start; } }

        .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; }
        .card-head { background: #f1f5f9; padding: 10px 15px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--text-sec); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .card-body { padding: 15px; }

        label { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-sec); margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 9px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; background: #fff; transition: border 0.15s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        input[readonly] { background: #f8fafc; color: var(--text-sec); cursor: not-allowed; }

        .divider { border-bottom: 1px dashed var(--border); margin: 15px 0 10px; padding-bottom: 5px; color: var(--primary); font-weight: 800; font-size: 0.7rem; text-transform: uppercase; }

        /* --- 4. BUTTONS --- */
        .btn { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px; font-weight: 600; font-size: 0.8rem; border-radius: var(--radius); border: 1px solid transparent; transition: 0.2s; min-height: 38px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-ghost { background: transparent; border-color: var(--border); color: var(--text-sec); }
        .btn-ghost:hover { background: #f1f5f9; color: var(--text-main); }
        .btn-danger { background: #fee2e2; color: #b91c1c; border-color: #fecaca; }
        .btn-success { background: #dcfce7; color: #15803d; border-color: #bbf7d0; }
        .btn-icon { width: 34px; padding: 0; }

        /* --- 5. TABLE --- */
        .table-wrap { overflow-x: auto; max-height: 75vh; border-top: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; white-space: nowrap; }
        th { text-align: left; padding: 10px; background: #f8fafc; border-bottom: 2px solid var(--border); color: var(--text-sec); position: sticky; top: 0; z-index: 10; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 8px 10px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover { background: #f8fafc; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
        .bg-ok { background: #dcfce7; color: #166534; }
        .bg-low { background: #fee2e2; color: #991b1b; }

        /* --- 6. MODAL --- */
        dialog { margin: auto; border: none; border-radius: 8px; box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25); width: 95%; max-width: 1000px; padding: 0; }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .modal-foot { padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        /* Util for search suggestions */
        .suggestions { position: absolute; background: white; width: 100%; max-height: 150px; overflow-y: auto; border: 1px solid var(--border); z-index: 50; box-shadow: var(--shadow); display: none; margin-top: 2px; }
        .s-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
        .s-item:hover { background: #eff6ff; color: var(--primary); }
    </style>
</head>
<body>

<header class="flex-between">
    <div class="flex">
        <h1>ðŸ“¦ SISTEMA V15 <span style="font-weight:400; color:var(--text-sec); font-size:0.8rem; margin-left:5px;">Titanium NFe</span></h1>
    </div>
    <div class="flex">
        <button onclick="document.getElementById('file-xml').click()" class="btn btn-primary" title="Importar NFe XML">ðŸ“‚ Importar XML</button>
        <button onclick="App.exportJSON()" class="btn btn-ghost">Exportar</button>
    </div>
</header>

<main>
    <section class="card">
        <div class="card-head flex-between">
            <span id="form-mode">Novo Produto</span>
            <button onclick="App.reset()" class="btn btn-ghost btn-icon" title="Limpar">â†º</button>
        </div>
        <div class="card-body">
            <form id="form-prod" onsubmit="App.save(event)">
                <input type="hidden" id="p-id">
                
                <div class="grid-3">
                    <div>
                        <label>CÃ³digo Interno</label>
                        <input type="text" id="p-codigo" readonly placeholder="Auto" style="font-weight:700; color:var(--primary); background:#eff6ff;">
                    </div>
                    <div style="grid-column: span 2">
                        <label>EAN / GTIN</label>
                        <input type="text" id="p-ean" placeholder="CÃ³digo de Barras">
                    </div>
                </div>

                <div style="margin-top:10px;">
                    <label>DescriÃ§Ã£o do Produto</label>
                    <input type="text" id="p-nome" required style="font-weight:700;">
                </div>

                <div class="grid-2" style="margin-top:10px;">
                    <div><label>Fornecedor</label><input type="text" id="p-fornecedor" list="dl-fornecedores"></div>
                    <div><label>Categoria</label><input type="text" id="p-categoria" list="dl-categorias"></div>
                </div>

                <div class="divider">ðŸ’° Custos & PrecificaÃ§Ã£o</div>
                <div class="grid-3">
                    <div><label>Custo (R$)</label><input type="number" id="p-custo" step="0.0001" oninput="App.calcMargin()"></div>
                    <div><label>Margem (%)</label><input type="text" id="p-margem" readonly style="text-align:center;"></div>
                    <div><label style="color:var(--primary)">Venda (R$)</label><input type="number" id="p-valor" step="0.01" oninput="App.calcMargin()" required></div>
                </div>

                <div class="divider">ðŸ“¦ Estoque & Fiscal</div>
                <div class="grid-3">
                    <div><label>Estoque</label><input type="number" id="p-estoque" required></div>
                    <div><label>MÃ­nimo</label><input type="number" id="p-minimo"></div>
                    <div><label>Unidade</label><input type="text" id="p-unidade" placeholder="UN"></div>
                </div>
                <div class="grid-4" style="margin-top:10px;">
                    <div><label>NCM</label><input type="text" id="p-ncm"></div>
                    <div><label>CEST</label><input type="text" id="p-cest"></div>
                    <div><label>CFOP</label><input type="text" id="p-cfop"></div>
                    <div><label>Ref. NFe</label><input type="text" id="p-refNFe" placeholder="Chave/ID"></div>
                </div>

                <div class="divider">ðŸ”— Detalhes</div>
                <div class="grid-2">
                    <div><label>Imagem (Arquivo)</label><input type="text" id="p-imagem"></div>
                    <div><label>Peso (Kg)</label><input type="number" id="p-peso" step="0.001"></div>
                </div>
                <div style="margin-top:10px;">
                    <label>VariaÃ§Ãµes de Nome (Separar por | )</label>
                    <input type="text" id="p-tags" placeholder="Ex: Arroz Branco | Arroz Tio JoÃ£o">
                </div>

                <button type="submit" class="btn btn-primary w-full" style="margin-top:20px; padding:12px;">ðŸ’¾ SALVAR PRODUTO</button>
            </form>
        </div>
    </section>

    <section class="card" style="min-height: 600px;">
        <div class="card-head flex-between">
            <span>Base de Dados (<span id="total-count">0</span>)</span>
        </div>
        <div style="padding:10px; background:#f8fafc; border-bottom:1px solid var(--border);" class="grid-4">
            <input type="text" id="s-term" placeholder="ðŸ” Buscar..." oninput="App.render()" style="grid-column: span 2;">
            <select id="s-forn" onchange="App.render()"><option value="">Fornecedor</option></select>
            <select id="s-status" onchange="App.render()">
                <option value="">Status</option>
                <option value="ok">Estoque OK</option>
                <option value="low">Estoque Baixo</option>
            </select>
        </div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th width="80">CÃ³d</th>
                        <th>Produto</th>
                        <th width="100">Custo</th>
                        <th width="100">Venda</th>
                        <th width="80">Estoque</th>
                        <th width="80" style="text-align:right">AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody id="tbl-body"></tbody>
            </table>
        </div>
    </section>
</main>

<dialog id="modal-xml">
    <div class="card-head flex-between" style="background: white; font-size: 0.9rem;">
        <b>ðŸ“¡ ConferÃªncia de NFe (XML)</b>
        <button onclick="document.getElementById('modal-xml').close()" class="btn btn-ghost btn-icon">âœ•</button>
    </div>
    <div style="padding:10px; background:#eff6ff; border-bottom:1px solid var(--border); font-size:0.85rem;">
        <div id="xml-info" style="font-weight:bold; color:var(--primary-dark);"></div>
    </div>
    <div class="modal-body" style="padding:0;">
        <table style="width:100%; font-size:0.8rem;">
            <thead style="background:#f1f5f9;">
                <tr>
                    <th style="width:30px;"><input type="checkbox" checked onclick="Importer.toggleAll(this.checked)"></th>
                    <th>CÃ³d. Forn.</th>
                    <th>Produto (XML)</th>
                    <th>NCM</th>
                    <th>Qtd</th>
                    <th>Custo Un.</th>
                    <th>AÃ§Ã£o Prevista</th>
                </tr>
            </thead>
            <tbody id="xml-list"></tbody>
        </table>
    </div>
    <div class="modal-foot">
        <span id="xml-stats" style="margin-right:auto; font-weight:700; color:var(--text-sec);"></span>
        <button onclick="Importer.commit()" class="btn btn-success">âœ… Processar ImportaÃ§Ã£o</button>
    </div>
</dialog>

<datalist id="dl-fornecedores"></datalist>
<datalist id="dl-categorias"></datalist>

<input type="file" id="file-xml" accept=".xml" class="hidden" onchange="Importer.parse(this)">

<script>
/**
 * SISTEMA V15 - TITANIUM
 * Focado em ImportaÃ§Ã£o de XML e Integridade de Dados
 */

const DB = {
    key: 'sys_v15_db',
    data: { produtos: [] },
    
    init: () => {
        const raw = localStorage.getItem(DB.key);
        if (raw) DB.data = JSON.parse(raw);
        // Garantir integridade
        if (!Array.isArray(DB.data.produtos)) DB.data.produtos = [];
    },
    
    save: () => localStorage.setItem(DB.key, JSON.stringify(DB.data)),
    
    // Algoritmo GAP FILLER: Encontra o menor ID numÃ©rico disponÃ­vel (P001, P003 -> retorna P002)
    nextCode: () => {
        const nums = DB.data.produtos
            .map(p => parseInt(p.codigo.replace(/\D/g, '')))
            .filter(n => !isNaN(n))
            .sort((a, b) => a - b);
        
        let next = 1;
        for (let n of nums) {
            if (n === next) next++;
            else if (n > next) break;
        }
        return `P${String(next).padStart(3, '0')}`;
    },

    find: (id) => DB.data.produtos.find(p => p.id === id),
    findByCode: (code) => DB.data.produtos.find(p => p.codigo === code),
    
    // Tenta encontrar produto existente pelo cÃ³digo do fornecedor (referÃªncia cruzada) ou EAN
    findMatch: (ean, refForn) => {
        return DB.data.produtos.find(p => 
            (ean && p.ean === ean) || 
            (p.refForn && p.refForn === refForn)
        );
    }
};

const App = {
    init: () => {
        DB.init();
        App.render();
        App.updateDatalists();
    },

    reset: () => {
        document.getElementById('form-prod').reset();
        document.getElementById('p-id').value = '';
        document.getElementById('p-codigo').value = '';
        document.getElementById('p-margem').value = '';
        document.getElementById('form-mode').innerText = 'Novo Produto';
    },

    save: (e) => {
        e.preventDefault();
        const id = document.getElementById('p-id').value;
        const codigo = document.getElementById('p-codigo').value || DB.nextCode();
        
        const prod = {
            id: id || Date.now().toString(36),
            codigo: codigo,
            ean: document.getElementById('p-ean').value.trim(),
            nome: document.getElementById('p-nome').value.trim().toUpperCase(),
            fornecedor: document.getElementById('p-fornecedor').value.trim().toUpperCase(),
            categoria: document.getElementById('p-categoria').value.trim().toUpperCase(),
            custo: Number(document.getElementById('p-custo').value) || 0,
            valor: Number(document.getElementById('p-valor').value) || 0,
            estoque: Number(document.getElementById('p-estoque').value) || 0,
            minimo: Number(document.getElementById('p-minimo').value) || 0,
            unidade: document.getElementById('p-unidade').value.trim().toUpperCase(),
            ncm: document.getElementById('p-ncm').value,
            cest: document.getElementById('p-cest').value,
            cfop: document.getElementById('p-cfop').value,
            refNFe: document.getElementById('p-refNFe').value,
            imagem: document.getElementById('p-imagem').value,
            peso: Number(document.getElementById('p-peso').value),
            tags: document.getElementById('p-tags').value,
            lastUpdate: new Date().toISOString()
        };

        if (id) {
            const idx = DB.data.produtos.findIndex(p => p.id === id);
            if (idx > -1) DB.data.produtos[idx] = prod;
        } else {
            DB.data.produtos.push(prod);
        }

        DB.save();
        App.reset();
        App.render();
        App.updateDatalists();
    },

    edit: (id) => {
        const p = DB.find(id);
        if (!p) return;
        
        document.getElementById('p-id').value = p.id;
        document.getElementById('p-codigo').value = p.codigo;
        document.getElementById('p-ean').value = p.ean || '';
        document.getElementById('p-nome').value = p.nome;
        document.getElementById('p-fornecedor').value = p.fornecedor || '';
        document.getElementById('p-categoria').value = p.categoria || '';
        document.getElementById('p-custo').value = p.custo;
        document.getElementById('p-valor').value = p.valor;
        document.getElementById('p-estoque').value = p.estoque;
        document.getElementById('p-minimo').value = p.minimo || '';
        document.getElementById('p-unidade').value = p.unidade || '';
        document.getElementById('p-ncm').value = p.ncm || '';
        document.getElementById('p-cest').value = p.cest || '';
        document.getElementById('p-cfop').value = p.cfop || '';
        document.getElementById('p-refNFe').value = p.refNFe || '';
        document.getElementById('p-imagem').value = p.imagem || '';
        document.getElementById('p-peso').value = p.peso || '';
        document.getElementById('p-tags').value = p.tags || '';
        
        App.calcMargin();
        document.getElementById('form-mode').innerText = `Editando ${p.codigo}`;
        window.scrollTo({top: 0, behavior: 'smooth'});
    },

    delete: (id) => {
        if(!confirm('Deseja realmente excluir este produto?')) return;
        DB.data.produtos = DB.data.produtos.filter(p => p.id !== id);
        DB.save();
        App.render();
    },

    calcMargin: () => {
        const custo = Number(document.getElementById('p-custo').value);
        const venda = Number(document.getElementById('p-valor').value);
        const el = document.getElementById('p-margem');
        if (custo > 0 && venda > 0) {
            const mg = ((venda - custo) / custo) * 100;
            el.value = mg.toFixed(1) + '%';
            el.style.color = mg < 0 ? 'red' : 'green';
        } else {
            el.value = '-';
        }
    },

    render: () => {
        const term = document.getElementById('s-term').value.toLowerCase();
        const forn = document.getElementById('s-forn').value;
        const status = document.getElementById('s-status').value;

        const list = DB.data.produtos.filter(p => {
            if (term && !p.nome.toLowerCase().includes(term) && !p.codigo.toLowerCase().includes(term) && !p.ean.includes(term)) return false;
            if (forn && p.fornecedor !== forn) return false;
            if (status === 'low' && p.estoque >= (p.minimo || 1)) return false;
            if (status === 'ok' && p.estoque < (p.minimo || 1)) return false;
            return true;
        });

        document.getElementById('total-count').innerText = list.length;
        document.getElementById('tbl-body').innerHTML = list.slice(0, 50).map(p => `
            <tr>
                <td><b>${p.codigo}</b></td>
                <td>
                    <div style="font-weight:600;">${p.nome}</div>
                    <div style="font-size:0.7rem; color:var(--text-sec);">${p.categoria} | ${p.fornecedor}</div>
                </td>
                <td>R$ ${p.custo.toFixed(2)}</td>
                <td>R$ ${p.valor.toFixed(2)}</td>
                <td>
                    <span class="badge ${p.estoque <= (p.minimo||0) ? 'bg-low' : 'bg-ok'}">${p.estoque} ${p.unidade}</span>
                </td>
                <td style="text-align:right">
                    <button onclick="App.edit('${p.id}')" class="btn btn-ghost btn-icon">âœŽ</button>
                    <button onclick="App.delete('${p.id}')" class="btn btn-danger btn-icon">âœ•</button>
                </td>
            </tr>
        `).join('');
    },

    updateDatalists: () => {
        const forns = [...new Set(DB.data.produtos.map(p => p.fornecedor).filter(Boolean))].sort();
        const cats = [...new Set(DB.data.produtos.map(p => p.categoria).filter(Boolean))].sort();

        document.getElementById('dl-fornecedores').innerHTML = forns.map(x => `<option value="${x}">`).join('');
        document.getElementById('dl-categorias').innerHTML = cats.map(x => `<option value="${x}">`).join('');
        
        const selForn = document.getElementById('s-forn');
        selForn.innerHTML = '<option value="">Todos Fornecedores</option>' + forns.map(x => `<option value="${x}">${x}</option>`).join('');
    },

    exportJSON: () => {
        const blob = new Blob([JSON.stringify(DB.data.produtos, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_sistema_v15_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }
};

/* --- MÃ“DULO DE IMPORTAÃ‡ÃƒO XML (NFe) --- */
const Importer = {
    staging: [],
    
    parse: (input) => {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                
                // Dados da Nota
                const emitente = Importer.getTag(xmlDoc, 'emit', 'xNome');
                const nNFe = Importer.getTag(xmlDoc, 'ide', 'nNF');
                const chNFe = Importer.getTag(xmlDoc, 'infNFe', 'Id')?.replace('NFe', '') || '';

                document.getElementById('xml-info').innerHTML = `Fornecedor: ${emitente} | Nota: ${nNFe}`;

                // Processar Produtos
                const dets = xmlDoc.getElementsByTagName('det');
                Importer.staging = [];

                for (let i = 0; i < dets.length; i++) {
                    const prod = dets[i].getElementsByTagName('prod')[0];
                    const imposto = dets[i].getElementsByTagName('imposto')[0];
                    
                    const cProd = Importer.getVal(prod, 'cProd');
                    const xProd = Importer.getVal(prod, 'xProd');
                    const ncm = Importer.getVal(prod, 'NCM');
                    const cest = Importer.getVal(prod, 'CEST');
                    const cfop = Importer.getVal(prod, 'CFOP');
                    const uCom = Importer.getVal(prod, 'uCom');
                    const qCom = parseFloat(Importer.getVal(prod, 'qCom'));
                    const vUnCom = parseFloat(Importer.getVal(prod, 'vUnCom'));
                    const vProd = parseFloat(Importer.getVal(prod, 'vProd'));

                    // Tenta achar match existente
                    const match = DB.findMatch(Importer.getVal(prod, 'cEAN'), cProd);

                    Importer.staging.push({
                        selected: true,
                        matchId: match ? match.id : null,
                        raw: {
                            fornecedor: emitente,
                            refNFe: chNFe,
                            codForn: cProd,
                            nome: xProd,
                            ncm, cest, cfop,
                            unidade: uCom,
                            qtd: qCom,
                            custo: vUnCom
                        }
                    });
                }
                Importer.renderTable();
                document.getElementById('modal-xml').showModal();
            } catch (err) {
                alert("Erro ao ler XML: " + err.message);
                console.error(err);
            }
        };
        reader.readAsText(file);
        input.value = ''; // Reset input
    },

    getVal: (el, tag) => {
        const node = el.getElementsByTagName(tag)[0];
        return node ? node.textContent : '';
    },
    
    getTag: (doc, parentTag, childTag) => {
        const p = doc.getElementsByTagName(parentTag)[0];
        return p ? Importer.getVal(p, childTag) : 'Desc.';
    },

    renderTable: () => {
        const tbody = document.getElementById('xml-list');
        tbody.innerHTML = Importer.staging.map((item, idx) => `
            <tr style="${item.matchId ? 'background:#dcfce7' : ''}">
                <td><input type="checkbox" ${item.selected ? 'checked' : ''} onchange="Importer.toggle(${idx})"></td>
                <td>${item.raw.codForn}</td>
                <td style="white-space:normal; min-width:200px;">${item.raw.nome}</td>
                <td>${item.raw.ncm}</td>
                <td>${item.raw.qtd}</td>
                <td>R$ ${item.raw.custo.toFixed(2)}</td>
                <td><span class="badge ${item.matchId ? 'bg-ok' : 'bg-low'}">${item.matchId ? 'Atualizar Estoque/Custo' : 'Novo Produto'}</span></td>
            </tr>
        `).join('');
        
        const sel = Importer.staging.filter(x => x.selected).length;
        document.getElementById('xml-stats').innerText = `${sel} itens selecionados`;
    },

    toggle: (idx) => {
        Importer.staging[idx].selected = !Importer.staging[idx].selected;
        Importer.renderTable();
    },

    toggleAll: (val) => {
        Importer.staging.forEach(x => x.selected = val);
        Importer.renderTable();
    },

    commit: () => {
        const toProcess = Importer.staging.filter(x => x.selected);
        let novos = 0, atualizados = 0;

        toProcess.forEach(item => {
            const dados = item.raw;
            
            if (item.matchId) {
                // Atualizar Existente
                const p = DB.find(item.matchId);
                p.estoque += dados.qtd; // Soma Estoque
                p.custo = dados.custo; // Atualiza Custo
                p.refNFe = dados.refNFe; // Atualiza Ref NFe
                p.lastUpdate = new Date().toISOString();
                atualizados++;
            } else {
                // Criar Novo
                const newCode = DB.nextCode();
                const newProd = {
                    id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                    codigo: newCode,
                    ean: '',
                    nome: dados.nome.toUpperCase(),
                    fornecedor: dados.fornecedor.toUpperCase(),
                    categoria: 'IMPORTADO XML',
                    custo: dados.custo,
                    valor: dados.custo * 1.5, // SugestÃ£o Margem 50%
                    estoque: dados.qtd,
                    minimo: 5,
                    unidade: dados.unidade,
                    ncm: dados.ncm,
                    cest: dados.cest,
                    cfop: dados.cfop,
                    refNFe: dados.refNFe,
                    refForn: dados.codForn, // Salva cÃ³digo do fornecedor para link futuro
                    imagem: '',
                    peso: 0,
                    tags: '',
                    lastUpdate: new Date().toISOString()
                };
                DB.data.produtos.push(newProd);
                novos++;
            }
        });

        DB.save();
        document.getElementById('modal-xml').close();
        App.init();
        alert(`Processamento ConcluÃ­do!\nðŸ†• Novos: ${novos}\nðŸ”„ Atualizados: ${atualizados}`);
    }
};

// Start
document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
