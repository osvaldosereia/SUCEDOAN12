<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estoque Pro | Minimalist</title>
    <style>
        /* --- CORE: RESET & VARIABLES --- */
        :root {
            --bg: #f4f4f9; --surface: #ffffff; --text: #1a1a1a; --text-sec: #666;
            --primary: #2563eb; --accent: #10b981; --danger: #ef4444; --warn: #f59e0b;
            --border: #e5e7eb; --radius: 8px; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --font-stack: system-ui, -apple-system, sans-serif;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a; --surface: #1e293b; --text: #f1f5f9; --text-sec: #94a3b8;
                --primary: #3b82f6; --border: #334155;
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: var(--font-stack); background: var(--bg); color: var(--text); -webkit-font-smoothing: antialiased; padding-bottom: 80px; }
        
        /* --- LAYOUT --- */
        header { 
            position: sticky; top: 0; z-index: 10; background: var(--surface); 
            padding: 1rem; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { font-size: 1.25rem; font-weight: 700; letter-spacing: -0.5px; }
        .controls { display: flex; gap: 0.5rem; }
        
        main { max-width: 1100px; margin: 0 auto; padding: 1rem; }
        
        /* --- COMPONENTS: BUTTONS --- */
        button {
            cursor: pointer; padding: 0.5rem 1rem; border: none; border-radius: var(--radius);
            font-weight: 600; font-size: 0.9rem; transition: opacity 0.2s;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            min-height: 44px; /* Touch target */
        }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { min-height: 32px; padding: 0.25rem 0.75rem; font-size: 0.8rem; }

        /* --- PRODUCT LIST (GRID) --- */
        .product-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;
            margin-top: 1rem;
        }
        .card {
            background: var(--surface); padding: 1rem; border-radius: var(--radius);
            border: 1px solid var(--border); box-shadow: var(--shadow);
            display: flex; flex-direction: column; gap: 0.5rem; position: relative;
        }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-title { font-weight: 600; font-size: 1rem; line-height: 1.3; }
        .card-meta { font-size: 0.8rem; color: var(--text-sec); display: flex; gap: 0.5rem; }
        .tag { 
            padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; 
        }
        .tag-st { background: var(--warn); color: #000; }
        .tag-combo { background: var(--accent); color: white; }
        
        .card-price { font-size: 1.2rem; font-weight: 700; color: var(--primary); margin-top: auto; }
        .stock-badge { 
            font-size: 0.8rem; padding: 4px 8px; background: var(--bg); border-radius: 4px;
            display: flex; justify-content: space-between;
        }

        /* --- MODAL (DIALOG) --- */
        dialog {
            background: var(--surface); color: var(--text); border: none; border-radius: var(--radius);
            width: 95%; max-width: 600px; padding: 0; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            margin: auto;
        }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 1rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; }

        /* --- FORMS --- */
        .form-grid { display: grid; gap: 1rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 0.8rem; font-weight: 600; color: var(--text-sec); }
        input, select, textarea {
            padding: 0.75rem; background: var(--bg); border: 1px solid var(--border);
            border-radius: var(--radius); color: var(--text); font-size: 1rem; width: 100%;
        }
        input:focus { border-color: var(--primary); }

        /* --- TABS --- */
        .tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 1rem; overflow-x: auto; }
        .tab-btn {
            background: none; border: none; padding: 0.75rem 1rem; color: var(--text-sec);
            font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap;
        }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .file-input-wrapper { position: relative; overflow: hidden; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; height: 100%; width: 100%; }
        
        /* Combo & Batches List */
        .mini-list { list-style: none; margin-top: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); }
        .mini-list li { padding: 0.5rem; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .mini-list li:last-child { border-bottom: none; }

    </style>
</head>
<body>

<header>
    <h1>Estoque<span style="color:var(--primary)">Pro</span></h1>
    <div class="controls">
        <div class="file-input-wrapper">
            <button class="btn-outline">üìÇ Importar CSV</button>
            <input type="file" id="csvInput" accept=".csv">
        </div>
        <button class="btn-primary" onclick="app.openModal()">+ Novo</button>
    </div>
</header>

<main>
    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem;">
        <input type="text" id="searchBox" placeholder="Buscar por nome, EAN ou c√≥digo..." onkeyup="app.render()">
        <button class="btn-outline" onclick="app.clearDB()">üóë Limpar</button>
    </div>
    <div id="grid" class="product-grid"></div>
</main>

<dialog id="productDialog">
    <div class="modal-header">
        <h3 id="modalTitle">Editar Produto</h3>
        <button class="btn-sm btn-outline" onclick="document.getElementById('productDialog').close()">‚úï</button>
    </div>
    <div class="modal-body">
        <div class="tabs">
            <button class="tab-btn active" onclick="app.switchTab('tab-geral')">Geral</button>
            <button class="tab-btn" onclick="app.switchTab('tab-preco')">Precifica√ß√£o</button>
            <button class="tab-btn" onclick="app.switchTab('tab-fiscal')">Fiscal</button>
            <button class="tab-btn" onclick="app.switchTab('tab-estoque')">Estoque/Lotes</button>
        </div>

        <form id="productForm" onsubmit="event.preventDefault(); app.saveProduct();">
            <input type="hidden" id="id">
            
            <div id="tab-geral" class="tab-content active form-grid">
                <div class="form-row">
                    <div class="form-group"><label>C√≥d. Interno</label><input type="text" id="code" required></div>
                    <div class="form-group"><label>EAN (Barras)</label><input type="text" id="ean"></div>
                </div>
                <div class="form-group"><label>Nome do Produto</label><input type="text" id="name" required></div>
                <div class="form-row">
                    <div class="form-group"><label>Grupo/Categoria</label><input type="text" id="category"></div>
                    <div class="form-group"><label>Unidade</label><input type="text" id="unit" placeholder="UN, KG..."></div>
                </div>
                <div class="form-group">
                    <label><input type="checkbox" id="isCombo" onchange="app.toggleCombo(this.checked)"> √â um Combo/Kit?</label>
                </div>
                <div class="form-group"><label>Imagem (Nome Arq)</label><input type="text" id="image"></div>
            </div>

            <div id="tab-preco" class="tab-content form-grid">
                <div class="form-row">
                    <div class="form-group">
                        <label>Custo (R$)</label>
                        <input type="number" step="0.01" id="cost" oninput="app.calcMargin()">
                    </div>
                    <div class="form-group">
                        <label>Venda (R$)</label>
                        <input type="number" step="0.01" id="price" oninput="app.calcMargin()" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Margem (%)</label><input type="text" id="margin" readonly tabindex="-1"></div>
                    <div class="form-group" style="justify-content:center"><label><input type="checkbox" id="offer"> Em Oferta?</label></div>
                </div>
            </div>

            <div id="tab-fiscal" class="tab-content form-grid">
                <div class="form-row">
                    <div class="form-group"><label>NCM</label><input type="text" id="ncm"></div>
                    <div class="form-group"><label>CEST</label><input type="text" id="cest"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>CFOP</label><input type="text" id="cfop" oninput="app.checkST()"></div>
                    <div class="form-group"><label>CSOSN/CST</label><input type="text" id="cst"></div>
                </div>
                <div class="form-group">
                    <label style="color:var(--warn); font-weight:700;">
                        <input type="checkbox" id="isST"> Produto √© Substituto Tribut√°rio (ST)?
                    </label>
                </div>
            </div>

            <div id="tab-estoque" class="tab-content form-grid">
                
                <div id="stock-normal">
                    <div class="form-row">
                        <div class="form-group"><label>Estoque Atual</label><input type="number" id="qty" readonly></div>
                        <div class="form-group"><label>Estoque M√≠nimo</label><input type="number" id="minQty"></div>
                    </div>
                    
                    <hr style="margin: 1rem 0; border:0; border-top:1px solid var(--border)">
                    <h4>Lotes & Validade</h4>
                    <div class="form-row">
                        <div class="form-group"><input type="date" id="batchDate"></div>
                        <div class="form-group" style="display:flex; flex-direction:row; gap:5px; align-items: flex-end;">
                            <input type="number" id="batchQty" placeholder="Qtd">
                            <button type="button" class="btn-primary btn-sm" onclick="app.addBatch()">Add</button>
                        </div>
                    </div>
                    <ul id="batchList" class="mini-list"></ul>
                </div>

                <div id="stock-combo" class="hidden">
                    <h4>Itens do Combo</h4>
                    <div class="form-group">
                        <label>Adicionar ID do Produto</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="comboPartId" placeholder="ID Interno">
                            <input type="number" id="comboPartQty" placeholder="Qtd" style="width:80px">
                            <button type="button" class="btn-primary btn-sm" onclick="app.addComboItem()">Add</button>
                        </div>
                    </div>
                    <ul id="comboList" class="mini-list"></ul>
                </div>

            </div>

        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn-danger" id="btnDelete" onclick="app.deleteProduct()">Excluir</button>
        <button type="submit" form="productForm" class="btn-primary">Salvar Altera√ß√µes</button>
    </div>
</dialog>

<script>
/**
 * SISTEMA ESTOQUE PRO - SINGLE FILE ARCHITECTURE
 * Filosofia: Pure JS, No Deps, Ultra Performance.
 */

const app = {
    data: [],
    currentId: null,

    init() {
        // Carrega do LocalStorage ou inicia vazio
        const saved = localStorage.getItem('sys_stock_db');
        if (saved) this.data = JSON.parse(saved);
        this.render();

        // Listener Importa√ß√£o CSV
        document.getElementById('csvInput').addEventListener('change', (e) => this.importCSV(e));
    },

    save() {
        localStorage.setItem('sys_stock_db', JSON.stringify(this.data));
        this.render();
    },

    // --- CSV PARSER ENGINE ---
    importCSV(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (evt) => {
            const text = evt.target.result;
            // Quebra linhas e remove vazias
            const lines = text.split('\n').filter(l => l.trim());
            const headers = lines[0].split(';'); // Assume CSV pt-BR
            
            // Mapeamento simples de colunas (baseado no CSV fornecido)
            // CSV: Internal Code;Status;Grupo;Nome;NCM;CFOP;CST;CEST...Pre√ßo
            
            let newCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(';');
                if (row.length < 5) continue;

                // Helper para limpar formato excel ="001"
                const clean = (val) => val ? val.replace(/="/g, '').replace(/"/g, '').trim() : '';
                const num = (val) => val ? parseFloat(val.replace('.', '').replace(',', '.')) || 0 : 0;

                const product = {
                    id: clean(row[0]),
                    active: clean(row[1]) === 'Habilitado',
                    category: clean(row[2]),
                    name: clean(row[3]),
                    ncm: clean(row[4]),
                    cfop: clean(row[5]),
                    cst: clean(row[6]),
                    cest: clean(row[7]),
                    price: num(row[row.length - 1]), // Pre√ßo costuma ser o √∫ltimo
                    cost: 0,
                    qty: 0,
                    isCombo: false,
                    isST: false,
                    batches: [], // [{date: '2025-01-01', qty: 10}]
                    comboItems: []
                };

                // Detec√ß√£o Autom√°tica de ST
                if (['5405', '5403'].includes(product.cfop) || ['010', '030', '060', '070', '201', '202', '203', '500'].includes(product.cst)) {
                    product.isST = true;
                }

                // Upsert (Atualiza se existe, cria se n√£o)
                const idx = this.data.findIndex(p => p.id === product.id);
                if (idx >= 0) {
                    // Mant√©m dados sens√≠veis que n√£o est√£o no CSV (estoque, custo)
                    this.data[idx] = { ...this.data[idx], ...product, qty: this.data[idx].qty, cost: this.data[idx].cost }; 
                } else {
                    this.data.push(product);
                    newCount++;
                }
            }
            
            alert(`Importa√ß√£o conclu√≠da! ${newCount} novos produtos.`);
            this.save();
            e.target.value = ''; // Reset input
        };
        reader.readAsText(file, 'ISO-8859-1');
    },

    // --- UI RENDERING ---
    render() {
        const grid = document.getElementById('grid');
        const term = document.getElementById('searchBox').value.toLowerCase();
        
        grid.innerHTML = '';
        
        // Filtro
        const filtered = this.data.filter(p => 
            p.name.toLowerCase().includes(term) || 
            p.id.toLowerCase().includes(term) || 
            (p.ean && p.ean.includes(term))
        ).slice(0, 50); // Limite de renderiza√ß√£o para performance (Lazy Load simulado)

        filtered.forEach(p => {
            const card = document.createElement('div');
            card.className = `card ${!p.active ? 'opacity-50' : ''}`;
            card.onclick = (e) => this.openModal(p.id);

            // Calcula Estoque Total (Soma Lotes)
            const stockTotal = p.batches?.length > 0 
                ? p.batches.reduce((acc, b) => acc + b.qty, 0) 
                : (p.qty || 0);

            // Tags
            let tagsHtml = '';
            if (p.isST) tagsHtml += `<span class="tag tag-st">ST</span>`;
            if (p.isCombo) tagsHtml += `<span class="tag tag-combo">KIT</span>`;

            card.innerHTML = `
                <div class="card-header">
                    <span class="card-meta">#${p.id} ‚Ä¢ ${p.category || 'Geral'}</span>
                    ${p.offer ? '<span class="tag" style="background:var(--danger);color:white">OFERTA</span>' : ''}
                </div>
                <div class="card-title">${p.name}</div>
                <div style="display:flex; gap:5px; margin-top:5px;">${tagsHtml}</div>
                <div class="card-price">R$ ${p.price.toFixed(2)}</div>
                <div class="stock-badge">
                    <span>Estoque: <b>${stockTotal}</b></span>
                    <span>${p.ncm ? 'Fisc: OK' : '‚ö†Ô∏è'}</span>
                </div>
            `;
            grid.appendChild(card);
        });
    },

    // --- MODAL LOGIC ---
    openModal(id = null) {
        this.currentId = id;
        const dialog = document.getElementById('productDialog');
        const form = document.getElementById('productForm');
        
        form.reset();
        document.getElementById('batchList').innerHTML = '';
        document.getElementById('comboList').innerHTML = '';
        
        // Reset Tabs
        this.switchTab('tab-geral');

        if (id) {
            const p = this.data.find(x => x.id === id);
            if (!p) return;

            // Preenche campos
            ['id', 'code', 'ean', 'name', 'category', 'unit', 'image', 'ncm', 'cest', 'cfop', 'cst', 'price', 'cost', 'minQty'].forEach(field => {
                if(document.getElementById(field)) {
                    document.getElementById(field).value = p[field] === 'undefined' ? '' : (field === 'code' ? p.id : p[field] || '');
                }
            });
            
            // Checkboxes
            document.getElementById('isCombo').checked = p.isCombo || false;
            document.getElementById('isST').checked = p.isST || false;
            document.getElementById('offer').checked = p.offer || false;

            // Render Lotes
            if (p.batches) p.batches.forEach(b => this.renderBatchRow(b));
            // Render Combos
            if (p.comboItems) p.comboItems.forEach(c => this.renderComboRow(c));
            
            // Atualiza Estoque Total no input
            const total = p.batches?.reduce((a,b)=>a+b.qty,0) || p.qty || 0;
            document.getElementById('qty').value = total;

            this.toggleCombo(p.isCombo);
            this.calcMargin();
            
            document.getElementById('btnDelete').classList.remove('hidden');
            document.getElementById('modalTitle').innerText = 'Editar Produto';
        } else {
            // Novo Produto
            document.getElementById('code').value = Date.now().toString().slice(-6); // ID Auto Simples
            document.getElementById('qty').value = 0;
            document.getElementById('btnDelete').classList.add('hidden');
            document.getElementById('modalTitle').innerText = 'Novo Produto';
            this.toggleCombo(false);
        }

        dialog.showModal();
    },

    saveProduct() {
        const getVal = (id) => document.getElementById(id).value;
        const getBool = (id) => document.getElementById(id).checked;
        const getNum = (id) => parseFloat(getVal(id)) || 0;

        const product = {
            id: getVal('code'),
            ean: getVal('ean'),
            name: getVal('name'),
            category: getVal('category'),
            unit: getVal('unit'),
            image: getVal('image'),
            
            price: getNum('price'),
            cost: getNum('cost'),
            offer: getBool('offer'),
            
            ncm: getVal('ncm'),
            cest: getVal('cest'),
            cfop: getVal('cfop'),
            cst: getVal('cst'),
            isST: getBool('isST'),
            
            isCombo: getBool('isCombo'),
            active: true,
            minQty: getNum('minQty'),
            
            // Coleta Lotes da UI
            batches: Array.from(document.querySelectorAll('#batchList li')).map(li => ({
                date: li.dataset.date,
                qty: parseFloat(li.dataset.qty)
            })),
            
            // Coleta Combo Items da UI
            comboItems: Array.from(document.querySelectorAll('#comboList li')).map(li => ({
                id: li.dataset.pid,
                qty: parseFloat(li.dataset.qty)
            }))
        };
        
        // Se n√£o tiver lotes, usa o qty calculado ou 0
        product.qty = product.batches.reduce((a, b) => a + b.qty, 0);

        if (this.currentId) {
            const idx = this.data.findIndex(p => p.id === this.currentId);
            this.data[idx] = product;
        } else {
            this.data.push(product);
        }

        this.save();
        document.getElementById('productDialog').close();
    },

    deleteProduct() {
        if(confirm('Tem certeza?')) {
            this.data = this.data.filter(p => p.id !== this.currentId);
            this.save();
            document.getElementById('productDialog').close();
        }
    },

    clearDB() {
        if(confirm('Isso apagar√° TODOS os produtos. Confirma?')) {
            localStorage.removeItem('sys_stock_db');
            this.data = [];
            this.render();
        }
    },

    // --- LOGIC HELPERS ---

    switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        // Acha o bot√£o correspondente (hack simples)
        const btns = document.querySelectorAll('.tab-btn');
        if(tabId === 'tab-geral') btns[0].classList.add('active');
        if(tabId === 'tab-preco') btns[1].classList.add('active');
        if(tabId === 'tab-fiscal') btns[2].classList.add('active');
        if(tabId === 'tab-estoque') btns[3].classList.add('active');
    },

    calcMargin() {
        const cost = parseFloat(document.getElementById('cost').value) || 0;
        const sell = parseFloat(document.getElementById('price').value) || 0;
        const margin = document.getElementById('margin');
        
        if (sell > 0 && cost >= 0) {
            const mg = ((sell - cost) / sell) * 100;
            margin.value = mg.toFixed(1) + '%';
        } else {
            margin.value = '-';
        }
    },

    checkST() {
        // L√≥gica simples de sugest√£o
        const cfop = document.getElementById('cfop').value;
        const isStBox = document.getElementById('isST');
        if (cfop.startsWith('54') || cfop === '5405') {
            isStBox.checked = true;
        }
    },

    toggleCombo(isCombo) {
        const norm = document.getElementById('stock-normal');
        const combo = document.getElementById('stock-combo');
        if (isCombo) {
            norm.classList.add('hidden');
            combo.classList.remove('hidden');
        } else {
            norm.classList.remove('hidden');
            combo.classList.add('hidden');
        }
    },

    // --- BATCHES & COMBO UI ---

    addBatch() {
        const date = document.getElementById('batchDate').value;
        const qty = document.getElementById('batchQty').value;
        if (!date || !qty) return;
        
        this.renderBatchRow({date, qty});
        document.getElementById('batchQty').value = '';
    },

    renderBatchRow(batch) {
        const ul = document.getElementById('batchList');
        const li = document.createElement('li');
        li.dataset.date = batch.date;
        li.dataset.qty = batch.qty;
        
        // Verifica validade
        const isExpired = new Date(batch.date) < new Date();
        const color = isExpired ? 'color:var(--danger)' : '';
        
        li.innerHTML = `
            <span style="${color}">${batch.date} ${isExpired ? '(Vencido)' : ''}</span>
            <span>Qtd: ${batch.qty} <button class="btn-sm btn-outline" style="margin-left:5px" onclick="this.parentElement.parentElement.remove()">X</button></span>
        `;
        ul.appendChild(li);
    },

    addComboItem() {
        const id = document.getElementById('comboPartId').value;
        const qty = document.getElementById('comboPartQty').value;
        if(!id || !qty) return;

        // Tenta achar nome
        const prod = this.data.find(p => p.id === id);
        const name = prod ? prod.name : 'ID Desconhecido';

        this.renderComboRow({id, qty, name});
        document.getElementById('comboPartId').value = '';
        document.getElementById('comboPartQty').value = '';
    },

    renderComboRow(item) {
        // Se o nome n√£o veio no objeto (carregamento), busca
        let name = item.name;
        if (!name) {
            const p = this.data.find(x => x.id === item.id);
            name = p ? p.name : 'Desconhecido';
        }

        const ul = document.getElementById('comboList');
        const li = document.createElement('li');
        li.dataset.pid = item.id;
        li.dataset.qty = item.qty;
        li.innerHTML = `
            <span>${name} (${item.id})</span>
            <span>x${item.qty} <button class="btn-sm btn-outline" onclick="this.parentElement.parentElement.remove()">X</button></span>
        `;
        ul.appendChild(li);
    }
};

// Start
app.init();
</script>
</body>
</html>
