<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V21 | Titanium Perfect</title>
    
    <style>
        /* --- 1. CORE & HIGH CONTRAST --- */
        :root {
            --bg: #e2e8f0; 
            --surface: #ffffff;
            --border: #64748b; 
            --focus: #2563eb;
            --text: #0f172a;
            --sec: #475569;
            
            --btn-primary: #1d4ed8;
            --btn-success: #15803d;
            --btn-danger: #b91c1c;
            --btn-warning: #d97706;
            
            --input-h: 48px; 
            --btn-h: 48px;
            --font-base: 15px;
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 60px; font-size: var(--font-base); }

        /* --- 2. COMPONENTS --- */
        header { 
            background: #1e293b; 
            padding: 15px 25px; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 50; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        h1 { color: #fff; font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }

        .btn { 
            cursor: pointer; padding: 0 20px; border-radius: var(--radius); border: 2px solid transparent; 
            font-weight: 700; font-size: 0.95rem; text-transform: uppercase; letter-spacing: 0.5px;
            display: inline-flex; align-items: center; gap: 8px; transition: 0.1s; height: var(--btn-h);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); white-space: nowrap;
        }
        .btn:active { transform: translateY(2px); }
        .btn-primary { background: var(--btn-primary); color: white; border-color: #1e40af; }
        .btn-ghost { background: #f8fafc; border: 2px solid #cbd5e1; color: #334155; }
        .btn-ghost:hover { background: #e2e8f0; border-color: #94a3b8; color: #000; }
        .btn-success { background: var(--btn-success); color: white; }
        .btn-danger { background: var(--btn-danger); color: white; }
        .btn-warning { background: var(--btn-warning); color: white; }
        .btn-sm { height: 34px; padding: 0 12px; font-size: 0.8rem; }

        label { display: block; font-size: 0.85rem; font-weight: 800; color: #334155; margin-bottom: 6px; text-transform: uppercase; }
        input, select, textarea { 
            width: 100%; height: var(--input-h); padding: 0 12px; 
            border: 2px solid #cbd5e1; border-radius: var(--radius); 
            font-size: 1.05rem; background: #fff; color: #000; font-weight: 600;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--focus); 
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2); 
        }
        input[readonly] { background: #f1f5f9; color: #64748b; border-color: #e2e8f0; }
        textarea { height: auto; padding: 10px; }

        /* --- 3. LAYOUT --- */
        main { max-width: 95%; margin: 25px auto; }
        .card { background: var(--surface); border-radius: 12px; border: 1px solid #cbd5e1; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .toolbar { padding: 20px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { text-align: left; padding: 15px; background: #1e293b; color: #fff; font-size: 0.85rem; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
        td { padding: 12px 15px; border-bottom: 1px solid #cbd5e1; font-size: 1rem; color: #333; font-weight: 500; }
        tr:nth-child(even) { background: #f8fafc; }
        tr:hover { background: #eff6ff; }
        
        .badge-box { background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 4px; border: 1px solid #fca5a5; font-weight: bold; font-size: 0.8rem; }
        .badge-unit { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; border: 1px solid #86efac; font-weight: bold; font-size: 0.8rem; }

        /* --- 4. MODAL --- */
        dialog { margin: auto; border: none; border-radius: 12px; width: 95%; max-width: 1300px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        dialog::backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); }
        .modal-head { padding: 20px 25px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; background: #fff; position: sticky; top: 0; z-index: 20; align-items: center; }
        .modal-head b { font-size: 1.3rem; color: #1e293b; }
        .modal-body { padding: 25px; max-height: 80vh; overflow-y: auto; background: #f1f5f9; }

        .layout-grid { display: grid; grid-template-columns: 2fr 1.2fr; gap: 20px; }
        .panel { background: white; padding: 20px; border-radius: 10px; border: 1px solid #cbd5e1; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .panel-title { font-size: 0.95rem; font-weight: 900; color: var(--focus); text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 8px; display: flex; align-items: center; gap: 8px; }

        .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .row-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; }
        .panel-fiscal { background: #f8fafc; border: 1px dashed #94a3b8; }
        .big-money { font-size: 1.4rem; color: #15803d; font-weight: bold; text-align: right; }
        .big-stock { font-size: 1.4rem; color: #1d4ed8; font-weight: bold; text-align: center; }

        /* --- 5. PRINT (100mm) --- */
        @media print {
            @page { size: 100mm auto; margin: 0; }
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { 
                position: absolute; left: 0; top: 0; 
                width: 100mm; 
                padding: 0 3mm; /* Margem lateral 3mm */
                color: black; background: white; 
                font-family: 'Courier New', monospace;
            }
            .receipt-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
            .client-code { font-size: 32px; font-weight: 900; text-align: center; display: block; margin-bottom: 5px; }
            .receipt-line { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; border-bottom: 1px dashed #ccc; }
            .receipt-total { font-size: 24px; font-weight: 900; text-align: right; margin-top: 15px; border-top: 3px solid #000; padding-top: 5px; }
        }
    </style>
</head>
<body>

<header>
    <h1>üì¶ TITANIUM <span style="color:#fbbf24;">V21</span></h1>
    <div style="display:flex; gap:10px;">
        <button onclick="QuickCombo.open()" class="btn btn-primary" style="background:#4f46e5;">‚ö° COMBO R√ÅPIDO</button>
        <button onclick="CatManager.open()" class="btn btn-ghost">üìÇ CATEGORIAS</button>
        <button onclick="App.openModal()" class="btn btn-ghost" style="border:2px solid #fff; background:#334155; color:#fff;">+ NOVO PRODUTO</button>
        <button onclick="document.getElementById('xml-file').click()" class="btn btn-success">üì• IMPORTAR XML</button>
        <button onclick="App.exportBackup()" class="btn btn-warning">üíæ EXPORTAR BACKUP</button>
    </div>
</header>

<main>
    <div class="card">
        <div class="toolbar">
            <input type="text" id="search" placeholder="üîç DIGITE NOME, EAN OU C√ìDIGO..." oninput="App.render()" style="max-width: 450px; border-color: #94a3b8;">
            <div style="flex:1"></div>
            <div style="font-size:1.2rem; font-weight:bold; color:#334155;">TOTAL ITENS: <span id="total-rows" style="color:var(--focus)">0</span></div>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th width="100">C√ìDIGO</th>
                        <th>DESCRI√á√ÉO DO PRODUTO</th>
                        <th width="150">CATEGORIA</th>
                        <th width="120" style="text-align:center">ESTOQUE</th>
                        <th width="120" style="text-align:right">CUSTO</th>
                        <th width="120" style="text-align:right">VENDA</th>
                        <th width="100" style="text-align:right">A√á√ÉO</th>
                    </tr>
                </thead>
                <tbody id="tbl-body"></tbody>
            </table>
        </div>
    </div>
</main>

<dialog id="modal-prod">
    <div class="modal-head">
        <b>FICHA DO PRODUTO</b>
        <div style="display:flex; gap:10px;">
            <button onclick="App.save()" class="btn btn-primary" style="padding:0 30px;">üíæ SALVAR DADOS</button>
            <button onclick="document.getElementById('modal-prod').close()" class="btn btn-danger">‚úï</button>
        </div>
    </div>
    <div class="modal-body">
        <form id="form-prod">
            <input type="hidden" id="p-id">
            
            <div class="layout-grid">
                <div>
                    <div class="panel">
                        <div class="panel-title">üÜî IDENTIFICA√á√ÉO</div>
                        <div class="row-3">
                            <div><label>C√ìDIGO INTERNO</label><input type="text" id="p-codigo" readonly style="font-weight:900; color:var(--focus);"></div>
                            <div style="grid-column: span 2"><label>C√ìD. BARRAS (EAN)</label><input type="text" id="p-ean" placeholder="789..."></div>
                        </div>
                        <div style="margin-top:15px;"><label>NOME COMPLETO</label><input type="text" id="p-nome" style="font-weight:800; text-transform:uppercase;"></div>
                        <div class="row-2" style="margin-top:15px;">
                            <div><label>CATEGORIA</label><input type="text" id="p-categoria" list="dl-cats"></div>
                            <div><label>VARIA√á√ïES NOME</label><input type="text" id="p-varNome" placeholder="Nomes alternativos do XML"></div>
                        </div>
                        <div style="margin-top:15px;"><label>VARIA√á√ïES EAN</label><input type="text" id="p-varEan" placeholder="Outros c√≥digos de barras (separar por |)"></div>
                    </div>

                    <div class="panel panel-fiscal">
                        <div class="panel-title">‚öñÔ∏è DADOS FISCAIS</div>
                        <div class="row-4">
                            <div><label>NCM</label><input type="text" id="p-ncm"></div>
                            <div><label>CEST</label><input type="text" id="p-cest"></div>
                            <div><label>CFOP</label><input type="text" id="p-cfop"></div>
                            <div><label>UN. FISCAL</label><input type="text" id="p-unidade" placeholder="UN"></div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="panel" style="border-color:#86efac; background:#f0fdf4;">
                        <div class="panel-title" style="color:#15803d;">üí∞ PRE√áOS & OFERTA</div>
                        <div><label>PRE√áO DE VENDA (R$)</label><input type="number" id="p-valor" step="0.01" class="big-money"></div>
                        <div class="row-2" style="margin-top:10px;">
                            <div><label>CUSTO (R$)</label><input type="number" id="p-custo" step="0.01"></div>
                            <div style="display:flex; align-items:end;"><label style="cursor:pointer; color:#b91c1c;"><input type="checkbox" id="p-isOffer" onchange="App.toggleOffer(this.checked)" style="width:20px; height:20px; vertical-align:middle;"> EM OFERTA?</label></div>
                        </div>
                        <div id="offer-area" style="display:none; margin-top:10px; background:#fee2e2; padding:10px; border-radius:6px;">
                            <label style="color:#b91c1c;">PRE√áO PROMOCIONAL</label>
                            <input type="number" id="p-offerPrice" class="big-money" style="color:#b91c1c;">
                        </div>
                    </div>

                    <div class="panel">
                        <div class="panel-title">üì¶ ESTOQUE & KIT</div>
                        <div><label>QUANTIDADE ATUAL</label><input type="number" id="p-estoque" class="big-stock"></div>
                        
                        <div style="margin-top:20px; border-top:2px dashed #cbd5e1; padding-top:15px;">
                            <label style="cursor:pointer; color:var(--focus);"><input type="checkbox" id="p-isCombo" onchange="Combo.toggle(this.checked)" style="width:20px; height:20px; vertical-align:middle;"> ESTE PRODUTO √â UM KIT/COMBO?</label>
                        </div>
                        
                        <div id="combo-area" style="display:none; background:#eff6ff; padding:10px; border-radius:6px; margin-top:10px; border:1px solid #93c5fd;">
                            
                            <div style="background:#fff; padding:10px; border:1px solid #cbd5e1; margin-bottom:10px; border-radius:6px;">
                                <label>BUSCAR E INCLUIR MANUALMENTE</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="text" id="combo-manual-search" list="dl-prods" placeholder="Nome do produto..." style="font-size:0.9rem;">
                                    <input type="number" id="combo-manual-qty" value="1" style="width:60px; text-align:center;">
                                    <button type="button" onclick="Combo.addManual()" class="btn btn-primary btn-sm">ADD</button>
                                </div>
                            </div>

                            <label>OU COLE UMA LISTA (1x ITEM)</label>
                            <textarea id="combo-paste" style="height:60px; font-size:0.8rem;"></textarea>
                            <button type="button" onclick="Combo.processPaste()" class="btn btn-ghost btn-sm" style="width:100%; margin-top:5px;">PROCESSAR LISTA</button>
                            
                            <div id="combo-list" style="margin-top:10px; background:white; max-height:150px; overflow-y:auto; border:1px solid #ccc;"></div>

                            <div style="margin-top:15px; border-top:1px solid #ccc; padding-top:10px;">
                                <label>REALIZAR VENDA DO KIT</label>
                                <div style="display:flex; gap:5px;">
                                    <input type="number" id="combo-sell-qty" value="1" style="width:70px; text-align:center;">
                                    <button type="button" onclick="Combo.sell()" class="btn btn-success" style="flex:1;">üí≤ VENDER</button>
                                    <button type="button" onclick="Printer.printCurrent()" class="btn btn-primary btn-icon">üñ®Ô∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</dialog>

<dialog id="modal-quick-combo" style="max-width:600px;">
    <div class="modal-head">
        <b>‚ö° NOVO COMBO R√ÅPIDO</b>
        <button onclick="document.getElementById('modal-quick-combo').close()" class="btn btn-ghost">‚úï</button>
    </div>
    <div class="modal-body">
        <label>NOME DO COMBO</label><input type="text" id="qc-nome" style="font-weight:bold; margin-bottom:15px;">
        <div class="row-2" style="margin-bottom:15px;">
            <div><label>PRE√áO VENDA</label><input type="number" id="qc-valor" step="0.01" class="big-money"></div>
            <div><label>CATEGORIA</label><input type="text" id="qc-cat" list="dl-cats"></div>
        </div>
        <label>ITENS DO COMBO (COLE AQUI: "1x Coca...")</label>
        <textarea id="qc-paste" style="height:120px; font-family:monospace; margin-bottom:15px;"></textarea>
        <button onclick="QuickCombo.save()" class="btn btn-primary" style="width:100%; height:55px; font-size:1.1rem;">üöÄ CRIAR E SALVAR COMBO</button>
    </div>
</dialog>

<dialog id="modal-cats" style="max-width:700px;">
    <div class="modal-head"><b>GERENCIAR CATEGORIAS</b><button onclick="document.getElementById('modal-cats').close()" class="btn btn-ghost">‚úï</button></div>
    <div class="modal-body">
        <div style="display:flex; gap:10px; margin-bottom:20px; background:#fff; padding:15px; border-radius:8px;">
            <input type="text" id="new-cat-root" placeholder="NOVA CATEGORIA PAI">
            <button onclick="CatManager.addRoot()" class="btn btn-primary">ADICIONAR</button>
        </div>
        <div id="cat-tree-view"></div>
    </div>
</dialog>

<dialog id="modal-import">
    <div class="modal-head"><b>üì• IMPORTA√á√ÉO INTELIGENTE XML</b><button onclick="document.getElementById('modal-import').close()" class="btn btn-ghost">‚úï</button></div>
    <div class="modal-body">
        <div style="background:#fff7ed; border-left:5px solid #f97316; padding:15px; margin-bottom:20px;">
            <p style="color:#c2410c; font-weight:bold;">ü§ñ INTELIG√äNCIA ATIVA:</p>
            <p style="font-size:0.9rem; color:#ea580c;">Convers√µes de embalagem sugeridas automaticamente.</p>
        </div>
        <table style="font-size:0.9rem;">
            <thead>
                <tr><th>PRODUTO (XML)</th><th>EMB</th><th>QTD XML</th><th>FATOR</th><th>FINAL</th><th>CUSTO UN.</th></tr>
            </thead>
            <tbody id="import-rows"></tbody>
        </table>
        <div style="text-align:right; margin-top:20px;"><button onclick="Importer.commit()" class="btn btn-success" style="padding:0 40px;">‚úÖ CONFIRMAR IMPORTA√á√ÉO</button></div>
    </div>
</dialog>

<datalist id="dl-cats"></datalist>
<datalist id="dl-prods"></datalist>
<div id="receipt-area"></div>
<input type="file" id="xml-file" accept=".xml" hidden onchange="Importer.parse(this)">

<script>
/**
 * SISTEMA V21 - TITANIUM PERFECT
 */

const DB = {
    key: 'sys_v21_titan',
    data: { produtos: [], categorias: [] },
    init: () => {
        const raw = localStorage.getItem(DB.key);
        if(raw) DB.data = JSON.parse(raw);
        if(!Array.isArray(DB.data.categorias)) DB.data.categorias = [];
    },
    save: () => localStorage.setItem(DB.key, JSON.stringify(DB.data)),
    nextCode: () => {
        const nums = DB.data.produtos.map(p => parseInt(p.codigo.replace(/\D/g,''))).filter(n => !isNaN(n)).sort((a,b)=>a-b);
        let next = 1;
        for(let n of nums) { if(n===next) next++; else if(n>next) break; }
        return `P${String(next).padStart(4,'0')}`;
    }
};

const App = {
    init: () => { DB.init(); App.render(); CatManager.refreshDatalist(); },
    render: () => {
        const s = document.getElementById('search').value.toLowerCase();
        const tbody = document.getElementById('tbl-body');
        // Popula datalist de produtos para busca manual do combo
        document.getElementById('dl-prods').innerHTML = DB.data.produtos.map(p => `<option value="${p.nome}">`).join('');

        const list = DB.data.produtos.filter(p => p.nome.toLowerCase().includes(s) || p.codigo.toLowerCase().includes(s));
        document.getElementById('total-rows').innerText = list.length;
        
        tbody.innerHTML = list.map(p => `
            <tr>
                <td style="font-weight:900; color:var(--focus);">${p.codigo}</td>
                <td>
                    <div style="font-weight:700; font-size:1.05rem;">${p.nome}</div>
                    <small style="color:#64748b;">EAN: ${p.ean||'SEM GTIN'}</small>
                </td>
                <td><span style="background:#f1f5f9; padding:4px 8px; border-radius:4px; font-weight:600;">${p.categoria||'-'}</span></td>
                <td style="text-align:center; font-weight:bold; color:#1d4ed8; font-size:1.1rem;">${p.estoque} <span style="font-size:0.8rem; color:#64748b;">${p.unidade}</span></td>
                <td style="text-align:right">${parseFloat(p.custo).toFixed(2)}</td>
                <td style="text-align:right">
                    <b style="color:${p.isOffer?'#b91c1c':'#15803d'}; font-size:1.1rem;">
                        ${p.isOffer ? parseFloat(p.offerPrice).toFixed(2) : parseFloat(p.valor).toFixed(2)}
                    </b>
                    ${p.isOffer ? '<br><small style="color:#b91c1c; font-weight:bold;">OFERTA</small>' : ''}
                </td>
                <td style="text-align:right"><button onclick="App.openModal('${p.id}')" class="btn btn-ghost btn-sm">EDITAR</button></td>
            </tr>
        `).join('');
    },
    openModal: (id) => {
        const f = document.getElementById('form-prod'); f.reset();
        Combo.items = []; Combo.toggle(false); App.toggleOffer(false);
        if(id) {
            const p = DB.data.produtos.find(x=>x.id===id);
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-codigo').value = p.codigo;
            document.getElementById('p-ean').value = p.ean||'';
            document.getElementById('p-nome').value = p.nome;
            document.getElementById('p-varNome').value = (p.varNome||[]).join(' | ');
            document.getElementById('p-varEan').value = (p.varEan||[]).join(' | ');
            document.getElementById('p-categoria').value = p.categoria||'';
            document.getElementById('p-ncm').value = p.ncm||'';
            document.getElementById('p-cest').value = p.cest||'';
            document.getElementById('p-cfop').value = p.cfop||'';
            document.getElementById('p-custo').value = p.custo;
            document.getElementById('p-valor').value = p.valor;
            document.getElementById('p-estoque').value = p.estoque;
            document.getElementById('p-unidade').value = p.unidade||'UN';
            
            document.getElementById('p-isOffer').checked = p.isOffer;
            if(p.isOffer) { App.toggleOffer(true); document.getElementById('p-offerPrice').value = p.offerPrice; }
            
            document.getElementById('p-isCombo').checked = p.isCombo;
            if(p.isCombo) { Combo.toggle(true); Combo.items = p.comboItems||[]; Combo.renderList(); }
        } else {
            document.getElementById('p-id').value = '';
            document.getElementById('p-codigo').value = DB.nextCode();
        }
        document.getElementById('modal-prod').showModal();
    },
    save: () => {
        const id = document.getElementById('p-id').value;
        const prod = {
            id: id || Date.now().toString(36),
            codigo: document.getElementById('p-codigo').value,
            ean: document.getElementById('p-ean').value,
            nome: document.getElementById('p-nome').value.toUpperCase(),
            varNome: document.getElementById('p-varNome').value.split('|').filter(Boolean),
            varEan: document.getElementById('p-varEan').value.split('|').filter(Boolean),
            categoria: document.getElementById('p-categoria').value,
            ncm: document.getElementById('p-ncm').value,
            cest: document.getElementById('p-cest').value,
            cfop: document.getElementById('p-cfop').value,
            custo: parseFloat(document.getElementById('p-custo').value)||0,
            valor: parseFloat(document.getElementById('p-valor').value)||0,
            isOffer: document.getElementById('p-isOffer').checked,
            offerPrice: parseFloat(document.getElementById('p-offerPrice').value)||0,
            estoque: parseFloat(document.getElementById('p-estoque').value)||0,
            unidade: document.getElementById('p-unidade').value,
            isCombo: document.getElementById('p-isCombo').checked,
            comboItems: Combo.items
        };
        if(id) { const idx = DB.data.produtos.findIndex(x=>x.id===id); if(idx>-1) DB.data.produtos[idx] = prod; }
        else { DB.data.produtos.push(prod); }
        DB.save(); App.render(); document.getElementById('modal-prod').close();
    },
    toggleOffer: (v) => document.getElementById('offer-area').style.display = v ? 'block' : 'none',
    exportBackup: () => {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(DB.data, null, 2));
        const dl = document.createElement('a');
        dl.setAttribute("href", dataStr);
        dl.setAttribute("download", "backup_titanium_completo.json");
        dl.click();
    }
};

/* --- COMBO LOGIC (MANUAL ADD) --- */
const Combo = {
    items: [],
    toggle: (v) => { document.getElementById('combo-area').style.display = v?'block':'none'; if(v) Combo.renderList(); },
    addManual: () => {
        const nome = document.getElementById('combo-manual-search').value.toUpperCase();
        const qty = parseInt(document.getElementById('combo-manual-qty').value);
        if(!nome || qty<=0) return;
        const dbP = DB.data.produtos.find(p=>p.nome===nome);
        Combo.items.push({ id: dbP?dbP.id:null, nome: nome, qty: qty });
        Combo.renderList();
        document.getElementById('combo-manual-search').value = '';
    },
    processPaste: () => {
        const lines = document.getElementById('combo-paste').value.split('\n');
        lines.forEach(l => {
            const m = l.trim().match(/^(\d+)[\sxX-]+\s*(.+)$/);
            if(m) {
                const n = m[2].trim().toUpperCase();
                const p = DB.data.produtos.find(x=>x.nome===n);
                Combo.items.push({id:p?p.id:null, nome:n, qty:parseInt(m[1])});
            }
        });
        Combo.renderList(); document.getElementById('combo-paste').value = '';
    },
    renderList: () => {
        document.getElementById('combo-list').innerHTML = Combo.items.map((i,idx)=>`
            <div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:8px;font-size:0.9rem;">
                <b>${i.qty}x</b> <span>${i.nome} ${i.id?'‚úÖ':'‚ö†Ô∏è'}</span>
                <span style="color:red;cursor:pointer;font-weight:bold;" onclick="Combo.items.splice(${idx},1);Combo.renderList()">REMOVER</span>
            </div>
        `).join('');
    },
    sell: () => {
        const q = parseInt(document.getElementById('combo-sell-qty').value)||1;
        Combo.items.forEach(i => { if(i.id) { const p = DB.data.produtos.find(x=>x.id===i.id); if(p) p.estoque -= (i.qty*q); }});
        DB.save(); App.render(); alert(`VENDA REALIZADA! BAIXA EM ${Combo.items.length} ITENS.`);
    }
};

/* --- QUICK COMBO WITH PROMPT --- */
const QuickCombo = {
    open: () => {
        document.getElementById('qc-nome').value = ''; document.getElementById('qc-valor').value = '';
        document.getElementById('qc-cat').value = ''; document.getElementById('qc-paste').value = '';
        document.getElementById('modal-quick-combo').showModal();
    },
    save: () => {
        const nome = document.getElementById('qc-nome').value.toUpperCase();
        const val = parseFloat(document.getElementById('qc-valor').value);
        if(!nome || !val) return alert("PREENCHA NOME E VALOR!");
        
        const lines = document.getElementById('qc-paste').value.split('\n');
        let items = [];
        lines.forEach(l => {
            const m = l.trim().match(/^(\d+)[\sxX-]+\s*(.+)$/);
            if(m) {
                const nRaw = m[2].trim().toUpperCase();
                const dbP = DB.data.produtos.find(p=>p.nome===nRaw);
                items.push({ id: dbP?dbP.id:null, nome: nRaw, qty: parseInt(m[1]) });
            }
        });

        // Criar produto Combo
        const comboProd = {
            id: Date.now().toString(36), codigo: DB.nextCode(), ean: '', nome: nome, categoria: document.getElementById('qc-cat').value,
            ncm: '', cest: '', cfop: '5102', custo: 0, valor: val, isOffer: false, offerPrice: 0, estoque: 999, unidade: 'UN', isCombo: true, comboItems: items
        };
        DB.data.produtos.push(comboProd);
        DB.save(); App.render(); document.getElementById('modal-quick-combo').close();
        
        // Pergunta final
        if(confirm("COMBO CRIADO! DESEJA VENDER UMA UNIDADE E IMPRIMIR O CUPOM AGORA?")) {
            // Baixa estoque dos itens
            items.forEach(i => { if(i.id) { const p = DB.data.produtos.find(x=>x.id===i.id); if(p) p.estoque -= i.qty; } });
            DB.save(); App.render();
            // Prepara para impress√£o (simula que campos do modal principal est√£o preenchidos para usar Printer.printCurrent, ou cria l√≥gica ad-hoc)
            // L√≥gica Ad-Hoc para impress√£o direta:
            const clientCode = prompt("C√ìDIGO DO CLIENTE:", "001");
            let cupomHtml = `<div class="client-code">${clientCode}</div>
                <div class="receipt-header">CUPOM VENDA</div>
                <div class="receipt-line"><span>${nome}</span></div>
                <div class="receipt-line"><span>1 x R$${val.toFixed(2)}</span><span>R$${val.toFixed(2)}</span></div>
                <div class="receipt-total">TOTAL: R$ ${val.toFixed(2)}</div>`;
            document.getElementById('receipt-area').innerHTML = cupomHtml;
            window.print();
        }
    }
};

/* --- CATEGORY MANAGER (CORRIGIDO SUBCATEGORIAS) --- */
const CatManager = {
    open: () => { CatManager.render(); document.getElementById('modal-cats').showModal(); },
    refreshDatalist: () => {
        let html = '';
        DB.data.categorias.forEach(c => {
            html += `<option value="${c.nome}">`;
            (c.subs||[]).forEach(s => html += `<option value="${c.nome} > ${s}">`);
        });
        document.getElementById('dl-cats').innerHTML = html;
    },
    addRoot: () => {
        const v = document.getElementById('new-cat-root').value.trim().toUpperCase();
        if(v && !DB.data.categorias.find(c=>c.nome===v)) {
            DB.data.categorias.push({id: Date.now(), nome: v, subs:[]});
            DB.save(); CatManager.render(); CatManager.refreshDatalist(); document.getElementById('new-cat-root').value='';
        }
    },
    addSub: (idx) => {
        const s = prompt("NOME DA SUBCATEGORIA:");
        if(s) {
            if(!DB.data.categorias[idx].subs) DB.data.categorias[idx].subs = [];
            DB.data.categorias[idx].subs.push(s.toUpperCase());
            DB.save(); CatManager.render(); CatManager.refreshDatalist();
        }
    },
    removeSub: (idx, subIdx) => {
        if(confirm("REMOVER SUBCATEGORIA?")) {
            DB.data.categorias[idx].subs.splice(subIdx, 1);
            DB.save(); CatManager.render(); CatManager.refreshDatalist();
        }
    },
    render: () => {
        document.getElementById('cat-tree-view').innerHTML = DB.data.categorias.map((c, i) => `
            <div style="margin-bottom:10px; border:1px solid #ccc; background:#f8fafc; border-radius:6px; overflow:hidden;">
                <div style="padding:10px; font-weight:bold; display:flex; justify-content:space-between; background:#e2e8f0;">
                    ${c.nome} 
                    <div>
                        <button onclick="CatManager.addSub(${i})" class="btn btn-primary btn-sm" style="margin-right:5px;">+ SUB</button>
                        <button onclick="DB.data.categorias.splice(${i},1);DB.save();CatManager.render();" class="btn btn-danger btn-sm">X</button>
                    </div>
                </div>
                <div style="padding:5px 10px;">
                    ${(c.subs||[]).map((sub, si) => `
                        <div style="padding:5px; border-bottom:1px dashed #ccc; display:flex; justify-content:space-between;">
                            ‚Ü≥ ${sub}
                            <button onclick="CatManager.removeSub(${i}, ${si})" class="btn btn-ghost btn-sm" style="height:24px; padding:0 5px; color:red;">x</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
};

/* --- IMPORTER --- */
const Importer = {
    staged: [],
    parse: (inp) => {
        const r = new FileReader();
        r.onload = (e) => {
            const x = new DOMParser().parseFromString(e.target.result, "text/xml");
            const d = x.getElementsByTagName('det');
            Importer.staged = [];
            for(let i=0; i<d.length; i++) {
                const p = d[i].getElementsByTagName('prod')[0];
                const uXml = p.getElementsByTagName('uCom')[0].textContent.toUpperCase();
                const nome = p.getElementsByTagName('xProd')[0].textContent.toUpperCase();
                const qXml = parseFloat(p.getElementsByTagName('qCom')[0].textContent);
                const vXml = parseFloat(p.getElementsByTagName('vUnCom')[0].textContent);

                let factor = 1;
                let isPackage = /CX|CAIXA|FD|FARDO|SC|SACO|DZ|PCT/.test(uXml);
                const match = nome.match(/\b(\d+)\s*[xX]/i);
                if (match) factor = parseInt(match[1]);
                else if (uXml === 'DZ') factor = 12;

                Importer.staged.push({
                    nome: nome, ean: p.getElementsByTagName('cEAN')[0]?.textContent||'',
                    ncm: p.getElementsByTagName('NCM')[0]?.textContent||'', cest: p.getElementsByTagName('CEST')[0]?.textContent||'',
                    cfop: p.getElementsByTagName('CFOP')[0]?.textContent||'5102',
                    qXml: qXml, vXml: vXml, uXml: uXml, isPackage: isPackage, factor: factor
                });
            }
            Importer.render(); document.getElementById('modal-import').showModal();
        };
        if(inp.files[0]) r.readAsText(inp.files[0]);
        inp.value='';
    },
    render: () => {
        document.getElementById('import-rows').innerHTML = Importer.staged.map((r,i)=>`
            <tr>
                <td>${r.nome}</td>
                <td style="text-align:center;">${r.isPackage ? `<span class="badge-box">${r.uXml}</span>` : `<span class="badge-unit">${r.uXml}</span>`}</td>
                <td style="text-align:center;">${r.qXml}</td>
                <td style="text-align:center;"><input type="number" style="width:70px; text-align:center; font-weight:bold;" value="${r.factor}" onchange="Importer.staged[${i}].factor=this.value;Importer.render()"></td>
                <td style="text-align:center; font-weight:bold;">${r.qXml * r.factor}</td>
                <td style="text-align:right;">R$ ${(r.vXml / r.factor).toFixed(2)}</td>
            </tr>`).join('');
    },
    commit: () => {
        Importer.staged.forEach(r => {
            const f = parseFloat(r.factor)||1;
            const finalQ = r.qXml * f;
            const finalC = r.vXml / f;
            const p = DB.data.produtos.find(x => x.ean===r.ean || x.nome===r.nome);
            if(p) { 
                p.estoque+=finalQ; p.custo=finalC;
                if(!p.varNome) p.varNome = []; if(p.nome !== r.nome && !p.varNome.includes(r.nome)) p.varNome.push(r.nome);
            } else { 
                DB.data.produtos.push({
                    id: Date.now().toString(36)+Math.random(), codigo: DB.nextCode(), ean: r.ean !== 'SEM GTIN' ? r.ean : '', nome: r.nome,
                    custo: finalC, valor: finalC*1.6, estoque: finalQ, unidade: r.isPackage ? 'UN' : r.uXml,
                    ncm:r.ncm, cest:r.cest, cfop:r.cfop, isCombo:false, isOffer:false, varNome: [], varEan: []
                });
            }
        });
        DB.save(); App.render(); document.getElementById('modal-import').close(); alert("IMPORTA√á√ÉO CONCLU√çDA!");
    }
};

/* PRINTER 100mm WITH CLIENT CODE */
const Printer = {
    printCurrent: () => {
        const clientCode = prompt("C√ìDIGO DO CLIENTE:", "000");
        const n = document.getElementById('p-nome').value;
        const v = parseFloat(document.getElementById('p-isOffer').checked ? document.getElementById('p-offerPrice').value : document.getElementById('p-valor').value);
        const q = parseInt(document.getElementById('combo-sell-qty').value);
        
        document.getElementById('receipt-area').innerHTML = `
            <div class="client-code">${clientCode}</div>
            <div class="receipt-header">CUPOM N√ÉO FISCAL</div>
            <div class="receipt-line"><span>${n}</span></div>
            <div class="receipt-line"><span>${q} x R$${v.toFixed(2)}</span><span>R$${(q*v).toFixed(2)}</span></div>
            <div class="receipt-total">TOTAL: R$ ${(q*v).toFixed(2)}</div>
        `;
        window.print();
    }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
