<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V17 | XML Master Integration</title>
    
    <style>
        /* --- 1. CORE & RESET --- */
        :root {
            --bg: #f3f4f6;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text-main: #111827;
            --text-sec: #6b7280;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --radius: 6px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; font-size: 13px; padding-bottom: 40px; }
        
        /* --- 2. COMPONENTS --- */
        .btn { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px; font-weight: 600; border-radius: var(--radius); border: 1px solid transparent; transition: all 0.2s; font-size: 0.85rem; height: 36px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-ghost { background: white; border: 1px solid var(--border); color: var(--text-sec); }
        .btn-ghost:hover { background: #f9fafb; color: var(--text-main); border-color: #d1d5db; }
        .btn-success { background: var(--success); color: white; }
        .btn-sm { padding: 4px 8px; height: 28px; font-size: 0.75rem; }

        input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; background: #fff; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        input[readonly] { background: #f3f4f6; color: var(--text-sec); }
        
        /* --- 3. LAYOUT --- */
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 40; }
        h1 { font-size: 1.25rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        
        main { width: 98%; max-width: 1920px; margin: 20px auto; }

        /* --- 4. TABLE FULL WIDTH --- */
        .table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .table-toolbar { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; background: #f9fafb; align-items: center; }
        .table-wrapper { overflow-x: auto; max-height: calc(100vh - 140px); }
        
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { text-align: left; padding: 12px 16px; background: #f9fafb; border-bottom: 2px solid var(--border); font-size: 0.7rem; text-transform: uppercase; color: var(--text-sec); font-weight: 700; position: sticky; top: 0; z-index: 10; }
        td { padding: 8px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); font-size: 0.9rem; }
        tr:hover { background: #f8fafc; }
        
        .inp-clean { border: 1px solid transparent; background: transparent; padding: 4px; font-weight: 600; text-align: center; width: 100%; }
        .inp-clean:hover, .inp-clean:focus { border-color: var(--border); background: white; }

        /* --- 5. MODAL --- */
        dialog { margin: auto; border: none; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 95%; max-width: 1100px; padding: 0; }
        dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
        
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; position: sticky; top: 0; z-index: 20; }
        .modal-content { padding: 24px; background: #f9fafb; max-height: 80vh; overflow-y: auto; }
        
        .form-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
        .section-title { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary); margin-bottom: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }
        
        .g-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .g-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        
        label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-sec); margin-bottom: 4px; }

        /* Import Review Table */
        .review-table { width: 100%; font-size: 0.8rem; }
        .review-table th { background: #eff6ff; padding: 8px; text-align: left; }
        .review-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .tag-new { background: #dbeafe; color: #1e40af; }
        .tag-upd { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<header>
    <h1>üì¶ SYSTEM V17 <span style="font-weight:400; font-size:0.8rem; color:#9ca3af;">Integrador NFe</span></h1>
    <div style="display:flex; gap:10px;">
        <button onclick="App.openModal()" class="btn btn-primary">+ Novo Produto</button>
        <button onclick="document.getElementById('file-xml').click()" class="btn btn-ghost">üìÇ Importar XML</button>
    </div>
</header>

<main>
    <div class="table-container">
        <div class="table-toolbar">
            <input type="text" id="search-input" placeholder="üîç Buscar Nome, EAN, C√≥digo..." oninput="App.render()" style="max-width: 400px;">
            <div style="flex:1;"></div>
            <span style="font-size:0.85rem; color:var(--text-sec);">Produtos: <b id="total-rows" style="color:var(--text-main);">0</b></span>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="80">C√≥d</th>
                        <th width="120">EAN</th>
                        <th>Produto</th>
                        <th width="100" style="text-align:center;">Estoque</th>
                        <th width="100" style="text-align:center;">Custo (R$)</th>
                        <th width="100" style="text-align:center;">Venda (R$)</th>
                        <th width="80" style="text-align:center;">Margem</th>
                        <th width="100" style="text-align:right;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</main>

<dialog id="prod-modal">
    <div class="modal-header">
        <span style="font-weight:bold; font-size:1.1rem;">Detalhes do Produto</span>
        <div style="display:flex; gap:10px;">
            <button onclick="App.save()" class="btn btn-primary">üíæ Salvar</button>
            <button onclick="document.getElementById('prod-modal').close()" class="btn btn-ghost">‚úï</button>
        </div>
    </div>
    <div class="modal-content">
        <form id="form-prod">
            <input type="hidden" id="p-id">
            
            <div class="form-section">
                <div class="section-title">üÜî Dados Principais</div>
                <div class="g-3" style="margin-bottom:15px;">
                    <div><label>C√≥digo</label><input type="text" id="p-codigo" readonly style="font-weight:bold; color:var(--primary);"></div>
                    <div><label>EAN (Auto)</label><input type="text" id="p-ean" placeholder="Preenchimento Auto"></div>
                    <div><label>Ref. Forn.</label><input type="text" id="p-refForn"></div>
                </div>
                <div><label>Nome do Produto</label><input type="text" id="p-nome" style="font-weight:700;"></div>
                
                <div class="g-2" style="margin-top:10px;">
                    <div><label>Varia√ß√µes de Nome (Match XML)</label><textarea id="p-var-nome" style="height:50px; font-size:0.8rem;" placeholder="Nomes alternativos do XML aparecem aqui..."></textarea></div>
                    <div><label>Varia√ß√µes de EAN</label><textarea id="p-var-ean" style="height:50px; font-size:0.8rem;" placeholder="EANs secund√°rios..."></textarea></div>
                </div>
            </div>

            <div class="g-2">
                <div class="form-section">
                    <div class="section-title">üí∞ Valores</div>
                    <div class="g-2">
                        <div><label>Custo</label><input type="number" id="p-custo" step="0.01" oninput="Utils.calcMargin()"></div>
                        <div><label>Venda</label><input type="number" id="p-valor" step="0.01" oninput="Utils.calcMargin()"></div>
                    </div>
                    <div style="margin-top:10px;"><label>Margem</label><input type="text" id="p-margem" readonly style="text-align:center;"></div>
                </div>
                <div class="form-section">
                    <div class="section-title">üì¶ Estoque</div>
                    <div class="g-3">
                        <div><label>Atual</label><input type="number" id="p-estoque"></div>
                        <div><label>M√≠n</label><input type="number" id="p-min"></div>
                        <div><label>Un</label><input type="text" id="p-unidade"></div>
                    </div>
                    <div style="margin-top:10px; display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="p-isCombo" style="width:auto;" onchange="Combo.toggle(this.checked)">
                        <label for="p-isCombo" style="margin:0; font-weight:bold; cursor:pointer;">Ativar Combo/Kit</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">üöö Hist√≥rico de Entradas (√öltimas 3)</div>
                <div id="batch-container">
                    </div>
            </div>

            <div id="combo-area" style="display:none; margin-top:10px; padding:15px; border:1px dashed #2563eb; background:#eff6ff; border-radius:8px;">
                <div class="g-2" style="align-items:start;">
                    <div>
                        <label>Colar Lista (Ex: "1x Coca Cola")</label>
                        <textarea id="combo-paste" style="height:60px;"></textarea>
                        <button type="button" onclick="Combo.processPaste()" class="btn btn-primary btn-sm" style="width:100%; margin-top:5px;">Processar Lista</button>
                    </div>
                    <div>
                        <label>Itens no Combo</label>
                        <div id="combo-list-render" style="background:white; border:1px solid #ddd; padding:5px; min-height:60px;"></div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</dialog>

<dialog id="import-modal">
    <div class="modal-header">
        <span style="font-weight:bold;">Confer√™ncia de XML</span>
        <button onclick="document.getElementById('import-modal').close()" class="btn btn-ghost">‚úï</button>
    </div>
    <div class="modal-content">
        <div id="xml-info" style="margin-bottom:10px; font-weight:bold; color:var(--text-sec);"></div>
        <table class="review-table">
            <thead><tr><th>C√≥d XML</th><th>Nome XML</th><th>Qtd</th><th>Custo</th><th>A√ß√£o Sistema</th></tr></thead>
            <tbody id="import-list"></tbody>
        </table>
        <div style="margin-top:20px; text-align:right;">
            <button onclick="Importer.commit()" class="btn btn-success">‚úÖ Confirmar Importa√ß√£o</button>
        </div>
    </div>
</dialog>

<input type="file" id="file-xml" accept=".xml" style="display:none;" onchange="Importer.parse(this)">

<script>
/* SISTEMA V17 - CORE JS */

const DB = {
    key: 'sys_v17_db',
    data: { produtos: [] },
    init: () => {
        const raw = localStorage.getItem(DB.key);
        if(raw) DB.data = JSON.parse(raw);
    },
    save: () => localStorage.setItem(DB.key, JSON.stringify(DB.data)),
    nextCode: () => {
        const nums = DB.data.produtos.map(p => parseInt(p.codigo.replace(/\D/g,''))).filter(n => !isNaN(n)).sort((a,b)=>a-b);
        let next = 1;
        for(let n of nums) { if(n===next) next++; else if(n>next) break; }
        return `P${String(next).padStart(4,'0')}`;
    },
    // Busca inteligente: EAN, Codigo Interno ou Varia√ß√µes de Nome
    findSmart: (ean, name) => {
        // 1. Tenta EAN Exato
        let p = DB.data.produtos.find(x => x.ean && x.ean === ean);
        if(p) return p;
        // 2. Tenta Nome Exato
        p = DB.data.produtos.find(x => x.nome === name.toUpperCase());
        if(p) return p;
        // 3. Tenta Varia√ß√£o de Nome
        return DB.data.produtos.find(x => (x.varNome||[]).includes(name.toUpperCase()));
    }
};

const Utils = {
    fmtMoeda: (v) => parseFloat(v||0).toFixed(2),
    calcMargin: () => {
        const c = parseFloat(document.getElementById('p-custo').value)||0;
        const v = parseFloat(document.getElementById('p-valor').value)||0;
        const m = (c>0 && v>0) ? (((v-c)/c)*100).toFixed(0)+'%' : '-';
        document.getElementById('p-margem').value = m;
    }
};

const App = {
    init: () => {
        DB.init();
        App.render();
        App.renderBatchInputs();
    },
    renderBatchInputs: () => {
        let h = '<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-bottom:5px; font-weight:bold; font-size:0.75rem;"><span>Data Entrada</span><span>Qtd</span><span>Validade</span></div>';
        for(let i=0; i<3; i++) {
            h += `<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; margin-bottom:5px;">
                <input type="date" id="b-date-${i}">
                <input type="number" id="b-qtd-${i}" placeholder="Qtd">
                <input type="date" id="b-valid-${i}">
            </div>`;
        }
        document.getElementById('batch-container').innerHTML = h;
    },
    render: () => {
        const term = document.getElementById('search-input').value.toLowerCase();
        const tbody = document.getElementById('table-body');
        const list = DB.data.produtos.filter(p => 
            p.nome.toLowerCase().includes(term) || 
            p.codigo.toLowerCase().includes(term) ||
            (p.ean||'').includes(term)
        );
        document.getElementById('total-rows').innerText = list.length;
        
        tbody.innerHTML = list.map(p => {
            const mg = (p.custo>0 && p.valor>0) ? (((p.valor-p.custo)/p.custo)*100).toFixed(0) : 0;
            return `<tr>
                <td style="font-weight:bold; color:var(--primary);">${p.codigo}</td>
                <td style="color:#666;">${p.ean || '-'}</td>
                <td>${p.nome}</td>
                <td><input class="inp-clean" type="number" value="${p.estoque}" onchange="App.quickUpdate('${p.id}','estoque',this.value)"></td>
                <td><input class="inp-clean" type="number" step="0.01" value="${Utils.fmtMoeda(p.custo)}" onchange="App.quickUpdate('${p.id}','custo',this.value)"></td>
                <td><input class="inp-clean" type="number" step="0.01" value="${Utils.fmtMoeda(p.valor)}" onchange="App.quickUpdate('${p.id}','valor',this.value)"></td>
                <td style="text-align:center; color:${mg<0?'red':'green'}">${mg}%</td>
                <td style="text-align:right;"><button onclick="App.openModal('${p.id}')" class="btn btn-primary btn-sm">Editar</button></td>
            </tr>`;
        }).join('');
    },
    quickUpdate: (id, field, val) => {
        const p = DB.data.produtos.find(x=>x.id===id);
        if(p) { p[field] = parseFloat(val); DB.save(); App.render(); }
    },
    openModal: (id=null) => {
        const form = document.getElementById('form-prod');
        form.reset();
        Combo.items = [];
        
        if(id) {
            const p = DB.data.produtos.find(x=>x.id===id);
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-codigo').value = p.codigo;
            document.getElementById('p-ean').value = p.ean;
            document.getElementById('p-refForn').value = p.refForn||'';
            document.getElementById('p-nome').value = p.nome;
            document.getElementById('p-var-nome').value = (p.varNome||[]).join(' | ');
            document.getElementById('p-var-ean').value = (p.varEan||[]).join(' | ');
            document.getElementById('p-custo').value = p.custo;
            document.getElementById('p-valor').value = p.valor;
            document.getElementById('p-estoque').value = p.estoque;
            document.getElementById('p-min').value = p.min||'';
            document.getElementById('p-unidade').value = p.unidade||'UN';
            document.getElementById('p-isCombo').checked = p.isCombo||false;
            
            // Batches
            (p.batches||[]).forEach((b,i) => {
                if(i<3) {
                    document.getElementById(`b-date-${i}`).value = b.date;
                    document.getElementById(`b-qtd-${i}`).value = b.qtd;
                    document.getElementById(`b-valid-${i}`).value = b.valid;
                }
            });
            Combo.items = p.comboItems||[];
        } else {
            document.getElementById('p-id').value = '';
            document.getElementById('p-codigo').value = DB.nextCode();
        }
        
        Utils.calcMargin();
        Combo.toggle(document.getElementById('p-isCombo').checked);
        document.getElementById('prod-modal').showModal();
    },
    save: () => {
        const id = document.getElementById('p-id').value;
        const eanVal = document.getElementById('p-ean').value.trim();
        // EAN AUTO
        const finalEan = eanVal || ("789"+Date.now().toString().slice(-9)); 
        
        let batches = [];
        for(let i=0; i<3; i++) {
            const d = document.getElementById(`b-date-${i}`).value;
            const q = document.getElementById(`b-qtd-${i}`).value;
            const v = document.getElementById(`b-valid-${i}`).value;
            if(d || q) batches.push({date:d, qtd:q, valid:v});
        }

        const prod = {
            id: id || Date.now().toString(36),
            codigo: document.getElementById('p-codigo').value,
            ean: finalEan,
            refForn: document.getElementById('p-refForn').value,
            nome: document.getElementById('p-nome').value.toUpperCase(),
            varNome: document.getElementById('p-var-nome').value.split('|').map(s=>s.trim()).filter(Boolean),
            varEan: document.getElementById('p-var-ean').value.split('|').map(s=>s.trim()).filter(Boolean),
            custo: parseFloat(document.getElementById('p-custo').value)||0,
            valor: parseFloat(document.getElementById('p-valor').value)||0,
            estoque: parseFloat(document.getElementById('p-estoque').value)||0,
            min: parseFloat(document.getElementById('p-min').value)||0,
            unidade: document.getElementById('p-unidade').value,
            isCombo: document.getElementById('p-isCombo').checked,
            batches: batches,
            comboItems: Combo.items
        };

        if(id) {
            const idx = DB.data.produtos.findIndex(x=>x.id===id);
            if(idx>-1) DB.data.produtos[idx] = prod;
        } else {
            DB.data.produtos.push(prod);
        }
        DB.save();
        App.render();
        document.getElementById('prod-modal').close();
    }
};

/* --- LOGICA XML / IMPORTADOR --- */
const Importer = {
    staged: [],
    parse: (input) => {
        const file = input.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(e.target.result, "text/xml");
            
            const dhEmi = xml.getElementsByTagName('dhEmi')[0]?.textContent?.split('T')[0] || new Date().toISOString().split('T')[0];
            const dets = xml.getElementsByTagName('det');
            
            Importer.staged = [];
            
            for(let i=0; i<dets.length; i++) {
                const prod = dets[i].getElementsByTagName('prod')[0];
                const cEAN = prod.getElementsByTagName('cEAN')[0]?.textContent || '';
                const xProd = prod.getElementsByTagName('xProd')[0]?.textContent || 'SEM NOME';
                const qCom = parseFloat(prod.getElementsByTagName('qCom')[0]?.textContent || 0);
                const vUnCom = parseFloat(prod.getElementsByTagName('vUnCom')[0]?.textContent || 0);
                const cProd = prod.getElementsByTagName('cProd')[0]?.textContent || '';
                
                // Tenta achar produto existente
                const match = DB.findSmart(cEAN, xProd);
                
                Importer.staged.push({
                    xmlName: xProd.toUpperCase(),
                    xmlEan: cEAN,
                    xmlCode: cProd,
                    qty: qCom,
                    custo: vUnCom,
                    date: dhEmi,
                    match: match
                });
            }
            Importer.renderReview();
            document.getElementById('import-modal').showModal();
        };
        reader.readAsText(file);
        input.value = '';
    },
    renderReview: () => {
        document.getElementById('import-list').innerHTML = Importer.staged.map(item => `
            <tr>
                <td>${item.xmlCode}</td>
                <td>${item.xmlName}<br><small>${item.xmlEan}</small></td>
                <td>${item.qty}</td>
                <td>R$ ${item.custo}</td>
                <td>
                    ${item.match 
                        ? `<span class="tag tag-upd">ATUALIZAR (${item.match.codigo})</span>` 
                        : `<span class="tag tag-new">CADASTRAR NOVO</span>`}
                </td>
            </tr>
        `).join('');
    },
    commit: () => {
        Importer.staged.forEach(item => {
            if(item.match) {
                // ATUALIZAR
                const p = item.match;
                p.estoque += item.qty;
                p.custo = item.custo;
                
                // L√≥gica de Batches (Entradas)
                if(!p.batches) p.batches = [];
                p.batches.unshift({ date: item.date, qtd: item.qty, valid: '' });
                p.batches = p.batches.slice(0, 3); // Manter ultimos 3
                
                // L√≥gica de Varia√ß√£o de Nome
                if(p.nome !== item.xmlName) {
                    if(!p.varNome) p.varNome = [];
                    if(!p.varNome.includes(item.xmlName)) p.varNome.push(item.xmlName);
                }
            } else {
                // NOVO
                const newCode = DB.nextCode();
                const newEan = item.xmlEan && item.xmlEan !== 'SEM GTIN' ? item.xmlEan : ("789"+Date.now().toString().slice(-9));
                
                DB.data.produtos.push({
                    id: Date.now().toString(36) + Math.random(),
                    codigo: newCode,
                    ean: newEan,
                    refForn: item.xmlCode,
                    nome: item.xmlName,
                    custo: item.custo,
                    valor: item.custo * 1.5, // Sugest√£o 50%
                    estoque: item.qty,
                    min: 5,
                    unidade: 'UN',
                    batches: [{ date: item.date, qtd: item.qty, valid: '' }],
                    varNome: [],
                    varEan: []
                });
            }
        });
        DB.save();
        App.render();
        document.getElementById('import-modal').close();
        alert('Importa√ß√£o processada!');
    }
};

const Combo = {
    items: [],
    toggle: (v) => { 
        document.getElementById('combo-area').style.display = v ? 'block' : 'none'; 
        if(v) Combo.render();
    },
    processPaste: () => {
        const lines = document.getElementById('combo-paste').value.split('\n');
        // Regex para "1x - Nome" ou "10 - Nome"
        const rgx = /^(\d+)[\sxX-]+\s*(.+)$/;
        lines.forEach(l => {
            const m = l.trim().match(rgx);
            if(m) {
                const qtd = parseInt(m[1]);
                const nameRaw = m[2].trim().toUpperCase();
                // Tenta achar produto no sistema para pegar ID
                const dbP = DB.data.produtos.find(x => x.nome === nameRaw || (x.varNome||[]).includes(nameRaw));
                Combo.items.push({ id: dbP?dbP.id:null, nome: dbP?dbP.nome:nameRaw, qtd });
            }
        });
        Combo.render();
        document.getElementById('combo-paste').value = '';
    },
    render: () => {
        document.getElementById('combo-list-render').innerHTML = Combo.items.map((i, idx) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px; font-size:0.8rem;">
                <b>${i.qtd}x</b> <span>${i.nome} ${i.id?'‚úÖ':'‚ö†Ô∏è'}</span>
                <span style="color:red; cursor:pointer;" onclick="Combo.items.splice(${idx},1); Combo.render()">‚úï</span>
            </div>
        `).join('');
    }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
