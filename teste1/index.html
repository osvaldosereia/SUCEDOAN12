<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V16 | Full Grid Titanium</title>
    
    <style>
        /* --- 1. CORE & RESET --- */
        :root {
            --bg: #f3f4f6;
            --surface: #ffffff;
            --border: #e5e7eb;
            --text-main: #111827;
            --text-sec: #6b7280;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --radius: 6px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); font-family: system-ui, -apple-system, sans-serif; font-size: 13px; padding-bottom: 40px; }
        
        /* --- 2. LAYOUT --- */
        header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 40; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); }
        h1 { font-size: 1.25rem; font-weight: 800; color: var(--primary); letter-spacing: -0.025em; display: flex; align-items: center; gap: 8px; }
        
        main { width: 98%; max-width: 1920px; margin: 20px auto; }

        /* --- 3. COMPONENTS --- */
        .btn { cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px; font-weight: 600; border-radius: var(--radius); border: 1px solid transparent; transition: all 0.2s; font-size: 0.85rem; height: 36px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-ghost { background: transparent; border-color: var(--border); color: var(--text-sec); }
        .btn-ghost:hover { background: #f9fafb; color: var(--text-main); border-color: #d1d5db; }
        .btn-icon { padding: 0; width: 32px; height: 32px; }
        .btn-sm { padding: 4px 8px; height: 28px; font-size: 0.75rem; }

        input, select, textarea { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: var(--radius); font-size: 0.9rem; transition: border 0.15s, box-shadow 0.15s; background: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        input[readonly] { background: #f3f4f6; color: var(--text-sec); cursor: default; }
        
        /* Inline Edit Inputs in Table */
        .inp-clean { border: 1px solid transparent; background: transparent; padding: 4px; font-weight: 600; text-align: center; }
        .inp-clean:hover { border-color: var(--border); background: white; }
        .inp-clean:focus { border-color: var(--primary); background: white; }

        /* --- 4. DATA TABLE (FULL WIDTH) --- */
        .table-container { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow); overflow: hidden; }
        .table-toolbar { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; background: #f9fafb; align-items: center; }
        .table-wrapper { overflow-x: auto; max-height: calc(100vh - 140px); }
        
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { text-align: left; padding: 12px 16px; background: #f9fafb; border-bottom: 2px solid var(--border); font-size: 0.7rem; text-transform: uppercase; color: var(--text-sec); font-weight: 700; position: sticky; top: 0; z-index: 10; }
        td { padding: 8px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; color: var(--text-main); font-size: 0.9rem; }
        tr:hover { background: #f8fafc; }
        
        /* --- 5. MODAL (DIALOG) --- */
        dialog { margin: auto; border: none; border-radius: 12px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 95%; max-width: 1100px; padding: 0; animation: fadeIn 0.2s ease-out; }
        dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); }
        
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; position: sticky; top: 0; z-index: 20; }
        .modal-title { font-size: 1.1rem; font-weight: 700; color: var(--text-main); }
        
        .modal-content { padding: 24px; background: #f9fafb; max-height: 80vh; overflow-y: auto; }
        
        /* Form Grid Layout */
        .form-section { background: white; padding: 20px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .section-title { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; color: var(--primary); margin-bottom: 15px; letter-spacing: 0.5px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }
        
        .g-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .g-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .g-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; }
        
        label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-sec); margin-bottom: 4px; }
        
        /* Batches Table inside Modal */
        .batch-table { width: 100%; font-size: 0.8rem; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
        .batch-table th { background: #f3f4f6; padding: 6px; }
        .batch-table td { padding: 0; border-bottom: 1px solid var(--border); }
        .batch-table input { border: none; border-radius: 0; background: transparent; }
        
        /* Combo Area */
        .combo-box { background: #eff6ff; border: 1px dashed #bfdbfe; padding: 15px; border-radius: 8px; display: none; }
        .combo-item { display: flex; justify-content: space-between; background: white; padding: 8px; margin-bottom: 5px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.85rem; align-items: center; }
        
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<header>
    <h1>üì¶ TITANIUM <span style="font-weight:400; font-size:0.8rem; color:#9ca3af; margin-left:8px;">V16 Full Grid</span></h1>
    <div style="display:flex; gap:10px;">
        <button onclick="App.openModal()" class="btn btn-primary">+ Novo Produto</button>
        <button onclick="Importer.open()" class="btn btn-ghost">Importar XML</button>
    </div>
</header>

<main>
    <div class="table-container">
        <div class="table-toolbar">
            <input type="text" id="search-input" placeholder="üîç Buscar por Nome, EAN ou C√≥digo..." oninput="App.render()" style="max-width: 400px;">
            <div style="flex:1;"></div>
            <span style="font-size:0.85rem; color:var(--text-sec);">Total: <b id="total-rows" style="color:var(--text-main);">0</b></span>
        </div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th width="80">C√≥d</th>
                        <th width="120">EAN</th>
                        <th>Produto</th>
                        <th width="100" style="text-align:center;">Estoque</th>
                        <th width="100" style="text-align:center;">Custo (R$)</th>
                        <th width="100" style="text-align:center;">Venda (R$)</th>
                        <th width="80" style="text-align:center;">Margem</th>
                        <th width="100" style="text-align:right;">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>
</main>

<dialog id="prod-modal">
    <div class="modal-header">
        <span class="modal-title" id="modal-title">Cadastro de Produto</span>
        <div style="display:flex; gap:10px;">
            <button onclick="App.save()" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
            <button onclick="document.getElementById('prod-modal').close()" class="btn btn-ghost">‚úï</button>
        </div>
    </div>
    <div class="modal-content">
        <form id="form-prod" onsubmit="return false;">
            <input type="hidden" id="p-id">
            
            <div class="form-section">
                <div class="section-title">üÜî Identifica√ß√£o</div>
                <div class="g-3" style="margin-bottom:15px;">
                    <div><label>C√≥digo Interno</label><input type="text" id="p-codigo" readonly style="font-weight:bold; color:var(--primary);"></div>
                    <div>
                        <label>EAN (Autom√°tico se vazio)</label>
                        <div style="display:flex; gap:5px;">
                            <input type="text" id="p-ean" placeholder="789..." maxlength="13">
                            <button onclick="Utils.genEAN()" class="btn btn-ghost btn-icon" title="Gerar EAN">üé≤</button>
                        </div>
                    </div>
                    <div><label>Refer√™ncia Fornecedor</label><input type="text" id="p-refForn"></div>
                </div>
                <div><label>Nome do Produto</label><input type="text" id="p-nome" style="font-weight:700; font-size:1rem;"></div>
                <div class="g-2" style="margin-top:10px;">
                    <div><label>Varia√ß√µes de Nome (Match Importa√ß√£o)</label><input type="text" id="p-var-nome" placeholder="Nome A | Nome B..."></div>
                    <div><label>Varia√ß√µes de EAN</label><input type="text" id="p-var-ean" placeholder="EAN1 | EAN2..."></div>
                </div>
            </div>

            <div class="g-2">
                <div class="form-section">
                    <div class="section-title">üí∞ Precifica√ß√£o</div>
                    <div class="g-2">
                        <div><label>Custo (R$)</label><input type="number" id="p-custo" step="0.01" oninput="Utils.calcMargin()"></div>
                        <div><label>Venda (R$)</label><input type="number" id="p-valor" step="0.01" oninput="Utils.calcMargin()"></div>
                    </div>
                    <div style="margin-top:10px;">
                        <label>Margem Prevista</label>
                        <input type="text" id="p-margem" readonly style="text-align:center; background:#f0fdf4; color:#15803d; font-weight:bold;">
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">üì¶ Estoque & Controle</div>
                    <div class="g-3">
                        <div><label>Atual</label><input type="number" id="p-estoque"></div>
                        <div><label>M√≠nimo</label><input type="number" id="p-min"></div>
                        <div><label>Unidade</label><input type="text" id="p-unidade" placeholder="UN"></div>
                    </div>
                    <div style="margin-top:10px; display:flex; align-items:center; gap:10px; height:40px;">
                        <input type="checkbox" id="p-isCombo" style="width:20px; height:20px;" onchange="Combo.toggle(this.checked)">
                        <label for="p-isCombo" style="margin:0; cursor:pointer; font-weight:bold; color:var(--primary);">√â UM KIT / COMBO?</label>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="section-title">üöö √öltimas 3 Entradas (Rastreabilidade)</div>
                <table class="batch-table">
                    <thead><tr><th>Data Entrada</th><th>Qtd Chegada</th><th>Validade Lote</th></tr></thead>
                    <tbody id="batch-rows">
                        </tbody>
                </table>
            </div>

            <div id="combo-area" class="combo-box">
                <div class="section-title">üçï Configura√ß√£o do Combo</div>
                <div class="g-2" style="align-items:start;">
                    <div>
                        <label>Adicionar Manualmente</label>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input type="text" id="combo-search" placeholder="Buscar produto..." onkeyup="Combo.search(this.value)">
                            <input type="number" id="combo-qtd-add" value="1" style="width:60px;">
                            <button onclick="Combo.addManual()" class="btn btn-primary btn-sm">Add</button>
                        </div>
                        <div id="combo-res" style="background:white; border:1px solid #ddd; position:absolute; width:300px; display:none; max-height:150px; overflow:auto;"></div>
                        
                        <label>Colar Lista (Formato: "1x - Nome")</label>
                        <textarea id="combo-paste" style="height:80px;" placeholder="1x - Coca Cola&#10;2x - Batata Frita"></textarea>
                        <button onclick="Combo.processPaste()" class="btn btn-primary btn-sm" style="width:100%; margin-top:5px;">Processar Lista</button>
                    </div>
                    <div>
                        <label>Itens do Combo</label>
                        <div id="combo-list-render" style="min-height:100px; background:white; border:1px solid #ddd; padding:10px;"></div>
                    </div>
                </div>
            </div>

        </form>
    </div>
</dialog>

<input type="file" id="file-xml" accept=".xml" style="display:none;" onchange="Importer.run(this)">

<script>
/**
 * SISTEMA V16 TITANIUM
 * Arquitetura Centralizada no DB e Eventos
 */

const DB = {
    key: 'sys_v16_data',
    data: { produtos: [] },
    init: () => {
        const raw = localStorage.getItem(DB.key);
        if(raw) DB.data = JSON.parse(raw);
    },
    save: () => localStorage.setItem(DB.key, JSON.stringify(DB.data)),
    
    // Algoritmo GAP FILLER
    nextCode: () => {
        const nums = DB.data.produtos.map(p => parseInt(p.codigo.replace(/\D/g,''))).filter(n => !isNaN(n)).sort((a,b)=>a-b);
        let next = 1;
        for(let n of nums) { if(n===next) next++; else if(n>next) break; }
        return `P${String(next).padStart(4,'0')}`;
    }
};

const Utils = {
    fmtMoeda: (v) => parseFloat(v||0).toFixed(2),
    calcMargin: () => {
        const c = parseFloat(document.getElementById('p-custo').value) || 0;
        const v = parseFloat(document.getElementById('p-valor').value) || 0;
        const m = (c > 0 && v > 0) ? (((v-c)/c)*100).toFixed(1) + '%' : '-';
        const el = document.getElementById('p-margem');
        el.value = m;
        el.style.color = m.includes('-') ? '#999' : (parseFloat(m)<0 ? 'red' : 'green');
    },
    genEAN: () => {
        // Gera EAN-13 v√°lido (apenas d√≠gitos aleat√≥rios + checksum)
        let prefix = "789" + Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
        let sum = 0;
        for(let i=0; i<12; i++) sum += parseInt(prefix[i]) * (i % 2 === 0 ? 1 : 3);
        let check = (10 - (sum % 10)) % 10;
        document.getElementById('p-ean').value = prefix + check;
    }
};

const App = {
    init: () => {
        DB.init();
        App.render();
        // Render Batch Inputs no Modal
        let html = '';
        for(let i=0; i<3; i++) {
            html += `<tr>
                <td><input type="date" id="b-date-${i}"></td>
                <td><input type="number" id="b-qtd-${i}" placeholder="0"></td>
                <td><input type="date" id="b-valid-${i}"></td>
            </tr>`;
        }
        document.getElementById('batch-rows').innerHTML = html;
    },

    render: () => {
        const term = document.getElementById('search-input').value.toLowerCase();
        const tbody = document.getElementById('table-body');
        
        const list = DB.data.produtos.filter(p => 
            p.nome.toLowerCase().includes(term) || 
            p.codigo.toLowerCase().includes(term) ||
            p.ean.includes(term)
        );

        document.getElementById('total-rows').innerText = list.length;

        tbody.innerHTML = list.map(p => {
            // Calcula margem on-the-fly para a tabela
            const mg = (p.custo > 0) ? (((p.valor - p.custo)/p.custo)*100).toFixed(0) : 0;
            const color = mg < 0 ? 'red' : 'green';

            return `<tr>
                <td style="font-weight:bold; color:var(--primary);">${p.codigo}</td>
                <td style="color:#666;">${p.ean || '-'}</td>
                <td>${p.nome}</td>
                
                <td><input type="number" class="inp-clean" value="${p.estoque}" onchange="App.updateInline('${p.id}', 'estoque', this.value)"></td>
                <td><input type="number" class="inp-clean" value="${Utils.fmtMoeda(p.custo)}" step="0.01" onchange="App.updateInline('${p.id}', 'custo', this.value)"></td>
                <td><input type="number" class="inp-clean" value="${Utils.fmtMoeda(p.valor)}" step="0.01" onchange="App.updateInline('${p.id}', 'valor', this.value)"></td>
                
                <td style="text-align:center; color:${color}; font-weight:bold;">${mg}%</td>
                <td style="text-align:right;">
                    <button onclick="App.openModal('${p.id}')" class="btn btn-primary btn-sm">ABRIR</button>
                </td>
            </tr>`;
        }).join('');
    },

    updateInline: (id, field, val) => {
        const p = DB.data.produtos.find(x => x.id === id);
        if(p) {
            p[field] = parseFloat(val);
            DB.save();
            App.render(); // Re-render para atualizar margens
        }
    },

    openModal: (id = null) => {
        const form = document.getElementById('form-prod');
        form.reset();
        Combo.items = [];
        
        if(id) {
            const p = DB.data.produtos.find(x => x.id === id);
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-codigo').value = p.codigo;
            document.getElementById('p-ean').value = p.ean;
            document.getElementById('p-refForn').value = p.refForn || '';
            document.getElementById('p-nome').value = p.nome;
            document.getElementById('p-var-nome').value = (p.varNome || []).join(' | ');
            document.getElementById('p-var-ean').value = (p.varEan || []).join(' | ');
            document.getElementById('p-custo').value = p.custo;
            document.getElementById('p-valor').value = p.valor;
            document.getElementById('p-estoque').value = p.estoque;
            document.getElementById('p-min').value = p.min || '';
            document.getElementById('p-unidade').value = p.unidade || 'UN';
            document.getElementById('p-isCombo').checked = p.isCombo || false;
            
            // Batches
            const batches = p.batches || [];
            for(let i=0; i<3; i++) {
                const b = batches[i] || {};
                document.getElementById(`b-date-${i}`).value = b.date || '';
                document.getElementById(`b-qtd-${i}`).value = b.qtd || '';
                document.getElementById(`b-valid-${i}`).value = b.valid || '';
            }

            // Combo
            Combo.items = p.comboItems || [];
            
            document.getElementById('modal-title').innerText = `Editando ${p.nome}`;
        } else {
            document.getElementById('p-id').value = '';
            document.getElementById('p-codigo').value = DB.nextCode();
            document.getElementById('modal-title').innerText = 'Novo Produto';
        }

        Utils.calcMargin();
        Combo.toggle(document.getElementById('p-isCombo').checked);
        document.getElementById('prod-modal').showModal();
    },

    save: () => {
        const id = document.getElementById('p-id').value;
        const eanInput = document.getElementById('p-ean').value.trim();
        
        // Auto EAN se vazio
        const finalEan = eanInput || ("789" + Math.floor(Math.random() * 1000000000).toString().padStart(9, '0')); 

        // Coleta Batches
        let batches = [];
        for(let i=0; i<3; i++) {
            let d = document.getElementById(`b-date-${i}`).value;
            let q = document.getElementById(`b-qtd-${i}`).value;
            let v = document.getElementById(`b-valid-${i}`).value;
            if(d || q || v) batches.push({date:d, qtd:q, valid:v});
        }

        const prod = {
            id: id || Date.now().toString(36),
            codigo: document.getElementById('p-codigo').value,
            ean: finalEan,
            refForn: document.getElementById('p-refForn').value,
            nome: document.getElementById('p-nome').value.toUpperCase(),
            varNome: document.getElementById('p-var-nome').value.split('|').map(s=>s.trim()).filter(Boolean),
            varEan: document.getElementById('p-var-ean').value.split('|').map(s=>s.trim()).filter(Boolean),
            custo: parseFloat(document.getElementById('p-custo').value) || 0,
            valor: parseFloat(document.getElementById('p-valor').value) || 0,
            estoque: parseFloat(document.getElementById('p-estoque').value) || 0,
            min: parseFloat(document.getElementById('p-min').value) || 0,
            unidade: document.getElementById('p-unidade').value,
            isCombo: document.getElementById('p-isCombo').checked,
            batches: batches,
            comboItems: Combo.items
        };

        if(id) {
            const idx = DB.data.produtos.findIndex(x => x.id === id);
            if(idx > -1) DB.data.produtos[idx] = prod;
        } else {
            DB.data.produtos.push(prod);
        }
        
        DB.save();
        App.render();
        document.getElementById('prod-modal').close();
    }
};

/* --- M√ìDULO COMBO --- */
const Combo = {
    items: [],
    toggle: (active) => {
        document.getElementById('combo-area').style.display = active ? 'block' : 'none';
        if(active) Combo.renderList();
    },
    search: (val) => {
        const res = document.getElementById('combo-res');
        if(val.length < 2) { res.style.display='none'; return; }
        const matches = DB.data.produtos.filter(p => p.nome.includes(val.toUpperCase())).slice(0,5);
        res.innerHTML = matches.map(p => 
            `<div style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;" onclick="Combo.selectSearch('${p.id}', '${p.nome}')">${p.nome}</div>`
        ).join('');
        res.style.display = 'block';
    },
    selectSearch: (id, nome) => {
        document.getElementById('combo-search').value = nome;
        document.getElementById('combo-search').dataset.selId = id;
        document.getElementById('combo-res').style.display = 'none';
    },
    addManual: () => {
        const input = document.getElementById('combo-search');
        const id = input.dataset.selId;
        const nome = input.value;
        const qtd = parseInt(document.getElementById('combo-qtd-add').value);
        
        if(nome && qtd > 0) {
            Combo.items.push({ id: id || null, nome: nome, qtd: qtd });
            Combo.renderList();
            input.value = '';
            delete input.dataset.selId;
        }
    },
    processPaste: () => {
        const txt = document.getElementById('combo-paste').value;
        const lines = txt.split('\n');
        // Regex para capturar "1x - Nome" ou "10 - Nome" ou "1x Nome"
        const regex = /^(\d+)[\sxX-]+\s*(.+)$/; 
        
        lines.forEach(line => {
            const match = line.trim().match(regex);
            if(match) {
                const qtd = parseInt(match[1]);
                const nomeRaw = match[2].trim();
                
                // Tentar achar ID pelo nome exato no DB
                const dbProd = DB.data.produtos.find(p => p.nome === nomeRaw.toUpperCase());
                
                Combo.items.push({
                    id: dbProd ? dbProd.id : null,
                    nome: dbProd ? dbProd.nome : nomeRaw, // Usa nome do DB se achou
                    qtd: qtd
                });
            }
        });
        Combo.renderList();
        document.getElementById('combo-paste').value = '';
    },
    renderList: () => {
        const el = document.getElementById('combo-list-render');
        el.innerHTML = Combo.items.map((it, idx) => `
            <div class="combo-item">
                <span style="font-weight:bold; color:var(--primary);">${it.qtd}x</span>
                <span style="flex:1; margin-left:10px;">${it.nome} ${it.id ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                <button onclick="Combo.items.splice(${idx},1); Combo.renderList()" class="btn btn-ghost btn-icon" style="color:red;">‚úï</button>
            </div>
        `).join('');
    }
};

/* --- M√ìDULO DE IMPORTA√á√ÉO (Simples) --- */
const Importer = {
    open: () => document.getElementById('file-xml').click(),
    run: (input) => {
        alert("Simula√ß√£o de Importa√ß√£o XML iniciada. O sistema compararia EANs e adicionaria nomes novos em 'Varia√ß√µes de Nome'.");
        input.value = '';
    }
};

// Start
document.addEventListener('DOMContentLoaded', App.init);

</script>
</body>
</html>
