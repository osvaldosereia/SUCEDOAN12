<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V19 | Titanium Omni</title>
    
    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg: #f3f4f6; --surface: #ffffff; --border: #d1d5db;
            --text: #111827; --sec: #6b7280;
            --primary: #2563eb; --primary-dark: #1e40af;
            --danger: #ef4444; --success: #16a34a; --warning: #f59e0b;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); padding-bottom: 50px; font-size: 14px; }

        /* --- UI COMPONENTS --- */
        header { background: var(--surface); padding: 12px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 50; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); font-size: 1.1rem; font-weight: 900; display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: -0.5px; }

        .btn { cursor: pointer; padding: 8px 14px; border-radius: 6px; border: none; font-weight: 600; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-ghost { background: white; border: 1px solid var(--border); color: var(--sec); }
        .btn-ghost:hover { border-color: var(--sec); color: var(--text); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-icon { padding: 5px; width: 30px; height: 30px; justify-content: center; }
        .btn-sm { padding: 4px 8px; font-size: 0.75rem; }

        input, select, textarea { width: 100%; padding: 9px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.9rem; background: #fff; }
        input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        input[readonly] { background: #f9fafb; color: var(--sec); }

        /* --- LAYOUT --- */
        main { max-width: 1800px; margin: 20px auto; padding: 0 15px; }
        .card { background: var(--surface); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .toolbar { padding: 15px; background: #f9fafb; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { text-align: left; padding: 12px; background: #f3f4f6; border-bottom: 2px solid var(--border); font-size: 0.75rem; text-transform: uppercase; color: var(--sec); position: sticky; top: 0; z-index: 10; }
        td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
        tr:hover { background: #f9fafb; }

        /* --- MODAL --- */
        dialog { margin: auto; border: none; border-radius: 10px; width: 95%; max-width: 1100px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-head { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; background: #fff; position: sticky; top: 0; z-index: 20; align-items: center; }
        .modal-body { padding: 20px; max-height: 80vh; overflow-y: auto; background: #f9fafb; }
        
        .section { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; }
        .sec-title { font-size: 0.8rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; }

        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--sec); margin-bottom: 4px; }

        /* --- CATEGORY TREE STYLE --- */
        .cat-node { margin-bottom: 5px; border: 1px solid var(--border); border-radius: 6px; background: white; overflow: hidden; }
        .cat-head { padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; background: #f8fafc; font-weight: 700; cursor: pointer; }
        .cat-subs { padding: 5px 0 5px 20px; display: none; border-top: 1px solid var(--border); }
        .cat-subs.open { display: block; }
        .sub-item { padding: 6px 12px; border-bottom: 1px dashed #eee; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .sub-item:last-child { border-bottom: none; }

        /* --- PRINT --- */
        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 100mm; padding: 5px; color: black; background: white; }
            .receipt-line { display: flex; justify-content: space-between; font-size: 16px; font-family: 'Courier New', monospace; margin-bottom: 5px; border-bottom: 1px dashed #000; }
            .receipt-header { text-align: center; font-size: 20px; font-weight: 900; margin-bottom: 15px; border-bottom: 2px solid #000; }
            .receipt-total { font-size: 22px; font-weight: 900; text-align: right; margin-top: 10px; border-top: 2px solid #000; }
        }
    </style>
</head>
<body>

<header>
    <h1>üöÄ V19 <small style="font-weight:400; font-size:0.8rem; margin-left:10px; color:var(--sec);">Omni</small></h1>
    <div style="display:flex; gap:8px;">
        <button onclick="QuickCombo.open()" class="btn btn-primary" style="background:#4f46e5;">‚ö° Combo R√°pido</button>
        <button onclick="CatManager.open()" class="btn btn-ghost">üìÇ Categorias</button>
        <button onclick="App.openModal()" class="btn btn-ghost">+ Produto</button>
        <button onclick="document.getElementById('xml-file').click()" class="btn btn-ghost">üì• Importar XML</button>
    </div>
</header>

<main>
    <div class="card">
        <div class="toolbar">
            <input type="text" id="search" placeholder="üîç Buscar..." oninput="App.render()" style="max-width: 300px;">
            <div style="flex:1"></div>
            <span style="font-weight:bold; color:var(--sec);">Itens: <span id="total-rows">0</span></span>
        </div>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>C√≥d</th>
                        <th>Produto</th>
                        <th>Categ</th>
                        <th style="text-align:center">Estoque</th>
                        <th style="text-align:right">Custo</th>
                        <th style="text-align:right">Venda</th>
                        <th style="text-align:right">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tbl-body"></tbody>
            </table>
        </div>
    </div>
</main>

<dialog id="modal-prod">
    <div class="modal-head">
        <b>Ficha T√©cnica</b>
        <div style="display:flex; gap:10px;">
            <button onclick="App.save()" class="btn btn-primary">üíæ Salvar</button>
            <button onclick="document.getElementById('modal-prod').close()" class="btn btn-ghost">‚úï</button>
        </div>
    </div>
    <div class="modal-body">
        <form id="form-prod">
            <input type="hidden" id="p-id">
            <div class="grid-2">
                <div>
                    <div class="section">
                        <div class="sec-title">Identifica√ß√£o</div>
                        <div class="grid-2">
                            <div><label>C√≥digo</label><input type="text" id="p-codigo" readonly style="font-weight:bold;"></div>
                            <div><label>EAN</label><input type="text" id="p-ean"></div>
                        </div>
                        <div style="margin-top:10px;"><label>Nome</label><input type="text" id="p-nome" style="font-weight:800;"></div>
                        <div style="margin-top:10px;">
                            <label>Categoria</label>
                            <input type="text" id="p-categoria" list="dl-cats" placeholder="Selecione...">
                        </div>
                    </div>
                    <div class="section">
                        <div class="sec-title">Fiscal</div>
                        <div class="grid-3">
                            <div><label>NCM</label><input type="text" id="p-ncm"></div>
                            <div><label>CEST</label><input type="text" id="p-cest"></div>
                            <div><label>CFOP</label><input type="text" id="p-cfop" placeholder="5102"></div>
                        </div>
                    </div>
                </div>
                <div>
                    <div class="section">
                        <div class="sec-title">Valores</div>
                        <div class="grid-2">
                            <div><label>Custo</label><input type="number" id="p-custo" step="0.01"></div>
                            <div><label>Venda</label><input type="number" id="p-valor" step="0.01"></div>
                        </div>
                        <div style="margin-top:10px; display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="p-isOffer" onchange="App.toggleOffer(this.checked)">
                            <label for="p-isOffer" style="margin:0; color:var(--danger); font-weight:bold; cursor:pointer;">EM OFERTA?</label>
                        </div>
                        <div id="offer-area" style="display:none; margin-top:5px;">
                            <input type="number" id="p-offerPrice" placeholder="Pre√ßo Oferta" style="border-color:var(--danger);">
                        </div>
                    </div>
                    <div class="section">
                        <div class="sec-title">Estoque & Combo</div>
                        <div class="grid-2">
                            <div><label>Qtd</label><input type="number" id="p-estoque"></div>
                            <div><label>Un</label><input type="text" id="p-unidade"></div>
                        </div>
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <input type="checkbox" id="p-isCombo" onchange="Combo.toggle(this.checked)">
                                <label for="p-isCombo" style="margin:0; color:var(--primary); font-weight:bold; cursor:pointer;">√â COMBO?</label>
                            </div>
                        </div>
                        <div id="combo-area" style="display:none; background:#eff6ff; padding:10px; border-radius:6px; margin-top:10px;">
                            <div style="display:flex; gap:5px; margin-bottom:10px;">
                                <input type="number" id="combo-sell-qty" value="1" style="width:60px;">
                                <button type="button" onclick="Combo.sell()" class="btn btn-success" style="flex:1;">üí≤ VENDER</button>
                                <button type="button" onclick="Printer.printCurrent()" class="btn btn-primary btn-icon">üñ®Ô∏è</button>
                            </div>
                            <label>Colar Lista (1x Item)</label>
                            <textarea id="combo-paste" style="height:50px;"></textarea>
                            <button type="button" onclick="Combo.processPaste()" class="btn btn-ghost btn-sm" style="width:100%; margin-top:5px;">Processar</button>
                            <div id="combo-list" style="margin-top:5px; background:white;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</dialog>

<dialog id="modal-quick-combo" style="max-width:500px;">
    <div class="modal-head">
        <b>‚ö° Criar Combo R√°pido</b>
        <button onclick="document.getElementById('modal-quick-combo').close()" class="btn btn-ghost">‚úï</button>
    </div>
    <div class="modal-body">
        <div style="margin-bottom:10px;"><label>Nome do Combo</label><input type="text" id="qc-nome" style="font-weight:bold;"></div>
        <div class="grid-2" style="margin-bottom:10px;">
            <div><label>Pre√ßo Venda</label><input type="number" id="qc-valor" step="0.01"></div>
            <div><label>Categoria</label><input type="text" id="qc-cat" list="dl-cats"></div>
        </div>
        <div style="margin-bottom:15px;">
            <label>Conte√∫do (Cole a lista: 1x Coca...)</label>
            <textarea id="qc-paste" style="height:100px; font-family:monospace;" placeholder="1x Coca Cola&#10;2x Pastel Carne"></textarea>
        </div>
        <button onclick="QuickCombo.save()" class="btn btn-primary" style="width:100%; padding:12px;">üöÄ CRIAR E SALVAR COMBO</button>
    </div>
</dialog>

<dialog id="modal-cats" style="max-width:600px;">
    <div class="modal-head">
        <b>Gerenciar Categorias</b>
        <button onclick="document.getElementById('modal-cats').close()" class="btn btn-ghost">‚úï</button>
    </div>
    <div class="modal-body">
        <div style="display:flex; gap:5px; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:15px;">
            <input type="text" id="new-cat-root" placeholder="Nova Categoria Pai">
            <button onclick="CatManager.addRoot()" class="btn btn-primary">Adicionar</button>
        </div>
        <div id="cat-tree-view"></div>
    </div>
</dialog>

<dialog id="modal-import">
    <div class="modal-head"><b>Importa√ß√£o XML</b><button onclick="document.getElementById('modal-import').close()" class="btn btn-ghost">‚úï</button></div>
    <div class="modal-body">
        <div style="margin-bottom:10px; color:var(--sec);">Itens <b>CX/CAIXA</b> precisam de fator de convers√£o.</div>
        <table style="font-size:0.8rem;">
            <thead><tr><th>Nome</th><th>Un</th><th>Qtd</th><th>Fator</th><th>Final</th></tr></thead>
            <tbody id="import-rows"></tbody>
        </table>
        <div style="text-align:right; margin-top:15px;"><button onclick="Importer.commit()" class="btn btn-success">Confirmar</button></div>
    </div>
</dialog>

<datalist id="dl-cats"></datalist>
<div id="receipt-area"></div>
<input type="file" id="xml-file" accept=".xml" hidden onchange="Importer.parse(this)">

<script>
const DB = {
    key: 'sys_v19_omni',
    data: { produtos: [], categorias: [] },
    init: () => {
        const raw = localStorage.getItem(DB.key);
        if(raw) DB.data = JSON.parse(raw);
        if(!Array.isArray(DB.data.categorias)) DB.data.categorias = [];
    },
    save: () => localStorage.setItem(DB.key, JSON.stringify(DB.data)),
    nextCode: () => {
        const nums = DB.data.produtos.map(p => parseInt(p.codigo.replace(/\D/g,''))).filter(n => !isNaN(n)).sort((a,b)=>a-b);
        let next = 1;
        for(let n of nums) { if(n===next) next++; else if(n>next) break; }
        return `P${String(next).padStart(4,'0')}`;
    }
};

const App = {
    init: () => { DB.init(); App.render(); CatManager.refreshDatalist(); },
    render: () => {
        const s = document.getElementById('search').value.toLowerCase();
        const tbody = document.getElementById('tbl-body');
        const list = DB.data.produtos.filter(p => p.nome.toLowerCase().includes(s) || p.codigo.toLowerCase().includes(s));
        document.getElementById('total-rows').innerText = list.length;
        
        tbody.innerHTML = list.map(p => `
            <tr>
                <td><b>${p.codigo}</b></td>
                <td>${p.nome}<br><small style="color:#666">${p.ean||''}</small></td>
                <td><small>${p.categoria||'-'}</small></td>
                <td style="text-align:center">${p.estoque} ${p.unidade}</td>
                <td style="text-align:right">${parseFloat(p.custo).toFixed(2)}</td>
                <td style="text-align:right">
                    <b style="color:${p.isOffer?'red':'#2563eb'}">${p.isOffer ? parseFloat(p.offerPrice).toFixed(2) : parseFloat(p.valor).toFixed(2)}</b>
                </td>
                <td style="text-align:right"><button onclick="App.openModal('${p.id}')" class="btn btn-ghost btn-sm">Editar</button></td>
            </tr>
        `).join('');
    },
    openModal: (id) => {
        const f = document.getElementById('form-prod'); f.reset();
        Combo.items = []; Combo.toggle(false); App.toggleOffer(false);
        if(id) {
            const p = DB.data.produtos.find(x=>x.id===id);
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-codigo').value = p.codigo;
            document.getElementById('p-ean').value = p.ean||'';
            document.getElementById('p-nome').value = p.nome;
            document.getElementById('p-categoria').value = p.categoria||'';
            document.getElementById('p-ncm').value = p.ncm||'';
            document.getElementById('p-cest').value = p.cest||'';
            document.getElementById('p-cfop').value = p.cfop||'';
            document.getElementById('p-custo').value = p.custo;
            document.getElementById('p-valor').value = p.valor;
            document.getElementById('p-estoque').value = p.estoque;
            document.getElementById('p-unidade').value = p.unidade||'UN';
            
            document.getElementById('p-isOffer').checked = p.isOffer;
            if(p.isOffer) { App.toggleOffer(true); document.getElementById('p-offerPrice').value = p.offerPrice; }
            
            document.getElementById('p-isCombo').checked = p.isCombo;
            if(p.isCombo) { Combo.toggle(true); Combo.items = p.comboItems||[]; Combo.renderList(); }
        } else {
            document.getElementById('p-id').value = '';
            document.getElementById('p-codigo').value = DB.nextCode();
        }
        document.getElementById('modal-prod').showModal();
    },
    save: () => {
        const id = document.getElementById('p-id').value;
        const prod = {
            id: id || Date.now().toString(36),
            codigo: document.getElementById('p-codigo').value,
            ean: document.getElementById('p-ean').value,
            nome: document.getElementById('p-nome').value.toUpperCase(),
            categoria: document.getElementById('p-categoria').value,
            ncm: document.getElementById('p-ncm').value,
            cest: document.getElementById('p-cest').value,
            cfop: document.getElementById('p-cfop').value,
            custo: parseFloat(document.getElementById('p-custo').value)||0,
            valor: parseFloat(document.getElementById('p-valor').value)||0,
            isOffer: document.getElementById('p-isOffer').checked,
            offerPrice: parseFloat(document.getElementById('p-offerPrice').value)||0,
            estoque: parseFloat(document.getElementById('p-estoque').value)||0,
            unidade: document.getElementById('p-unidade').value,
            isCombo: document.getElementById('p-isCombo').checked,
            comboItems: Combo.items
        };
        if(id) { const idx = DB.data.produtos.findIndex(x=>x.id===id); if(idx>-1) DB.data.produtos[idx] = prod; }
        else { DB.data.produtos.push(prod); }
        DB.save(); App.render(); document.getElementById('modal-prod').close();
    },
    toggleOffer: (v) => document.getElementById('offer-area').style.display = v ? 'block' : 'none'
};

/* --- CATEGORY MANAGER --- */
const CatManager = {
    open: () => { CatManager.render(); document.getElementById('modal-cats').showModal(); },
    refreshDatalist: () => {
        let html = '';
        DB.data.categorias.forEach(c => {
            html += `<option value="${c.nome}">`;
            (c.subs||[]).forEach(s => html += `<option value="${c.nome} > ${s}">`);
        });
        document.getElementById('dl-cats').innerHTML = html;
    },
    addRoot: () => {
        const v = document.getElementById('new-cat-root').value.trim().toUpperCase();
        if(v && !DB.data.categorias.find(c=>c.nome===v)) {
            DB.data.categorias.push({id: Date.now(), nome: v, subs:[]});
            DB.save(); CatManager.render(); CatManager.refreshDatalist(); document.getElementById('new-cat-root').value='';
        }
    },
    addSub: (idx) => {
        const sub = prompt("Nome da Subcategoria:");
        if(sub) {
            DB.data.categorias[idx].subs.push(sub.toUpperCase());
            DB.save(); CatManager.render(); CatManager.refreshDatalist();
        }
    },
    remove: (idx, subIdx=null) => {
        if(!confirm('Excluir?')) return;
        if(subIdx!==null) DB.data.categorias[idx].subs.splice(subIdx, 1);
        else DB.data.categorias.splice(idx, 1);
        DB.save(); CatManager.render(); CatManager.refreshDatalist();
    },
    toggleSubs: (el) => {
        const sub = el.nextElementSibling;
        sub.style.display = sub.style.display === 'block' ? 'none' : 'block';
    },
    render: () => {
        document.getElementById('cat-tree-view').innerHTML = DB.data.categorias.map((c, i) => `
            <div class="cat-node">
                <div class="cat-head">
                    <span onclick="CatManager.toggleSubs(this.parentNode)">${c.nome}</span>
                    <div style="display:flex; gap:5px;">
                        <button onclick="CatManager.addSub(${i})" class="btn btn-ghost btn-sm">+ Sub</button>
                        <button onclick="CatManager.remove(${i})" class="btn btn-danger btn-sm">X</button>
                    </div>
                </div>
                <div class="cat-subs">
                    ${(c.subs||[]).map((s, si) => `
                        <div class="sub-item">
                            <span>‚Ü≥ ${s}</span>
                            <button onclick="CatManager.remove(${i}, ${si})" class="btn btn-danger btn-sm" style="padding:0 5px;">x</button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }
};

/* --- QUICK COMBO --- */
const QuickCombo = {
    open: () => {
        document.getElementById('qc-nome').value = '';
        document.getElementById('qc-valor').value = '';
        document.getElementById('qc-cat').value = '';
        document.getElementById('qc-paste').value = '';
        document.getElementById('modal-quick-combo').showModal();
    },
    save: () => {
        const nome = document.getElementById('qc-nome').value.toUpperCase();
        const val = parseFloat(document.getElementById('qc-valor').value);
        if(!nome || !val) return alert("Preencha Nome e Valor");
        
        // Parse Items
        const lines = document.getElementById('qc-paste').value.split('\n');
        let items = [];
        lines.forEach(l => {
            const m = l.trim().match(/^(\d+)[\sxX-]+\s*(.+)$/);
            if(m) {
                const nRaw = m[2].trim().toUpperCase();
                const dbP = DB.data.produtos.find(p=>p.nome===nRaw);
                items.push({ id: dbP?dbP.id:null, nome: nRaw, qty: parseInt(m[1]) });
            }
        });

        const prod = {
            id: Date.now().toString(36),
            codigo: DB.nextCode(),
            ean: '',
            nome: nome,
            categoria: document.getElementById('qc-cat').value,
            ncm: '', cest: '', cfop: '5102',
            custo: 0,
            valor: val,
            isOffer: false, offerPrice: 0,
            estoque: 999, // Combo virtual
            unidade: 'UN',
            isCombo: true,
            comboItems: items
        };
        DB.data.produtos.push(prod);
        DB.save();
        App.render();
        document.getElementById('modal-quick-combo').close();
        alert("Combo R√°pido Criado!");
    }
};

/* --- COMBO LOGIC --- */
const Combo = {
    items: [],
    toggle: (v) => { document.getElementById('combo-area').style.display = v?'block':'none'; if(v) Combo.renderList(); },
    processPaste: () => {
        const lines = document.getElementById('combo-paste').value.split('\n');
        lines.forEach(l => {
            const m = l.trim().match(/^(\d+)[\sxX-]+\s*(.+)$/);
            if(m) {
                const n = m[2].trim().toUpperCase();
                const p = DB.data.produtos.find(x=>x.nome===n);
                Combo.items.push({id:p?p.id:null, nome:n, qty:parseInt(m[1])});
            }
        });
        Combo.renderList();
        document.getElementById('combo-paste').value = '';
    },
    renderList: () => {
        document.getElementById('combo-list').innerHTML = Combo.items.map((i,idx)=>`
            <div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:4px;font-size:0.85rem;">
                <b>${i.qty}x</b> <span>${i.nome} ${i.id?'‚úÖ':'‚ö†Ô∏è'}</span>
                <span style="color:red;cursor:pointer" onclick="Combo.items.splice(${idx},1);Combo.renderList()">‚úï</span>
            </div>
        `).join('');
    },
    sell: () => {
        const q = parseInt(document.getElementById('combo-sell-qty').value)||1;
        let log = [];
        Combo.items.forEach(i => {
            if(i.id) {
                const p = DB.data.produtos.find(x=>x.id===i.id);
                if(p) { p.estoque -= (i.qty*q); log.push(`${p.nome}: -${i.qty*q}`); }
            }
        });
        DB.save(); App.render();
        alert(`Baixa realizada:\n${log.join('\n')}`);
    }
};

/* --- PRINTER --- */
const Printer = {
    printCurrent: () => {
        const n = document.getElementById('p-nome').value;
        const v = parseFloat(document.getElementById('p-isOffer').checked ? document.getElementById('p-offerPrice').value : document.getElementById('p-valor').value);
        const q = parseInt(document.getElementById('combo-sell-qty').value);
        const t = v*q;
        document.getElementById('receipt-area').innerHTML = `
            <div class="receipt-header">CUPOM VENDA</div>
            <div class="receipt-line"><span>${n}</span></div>
            <div class="receipt-line"><span>${q}x ${v.toFixed(2)}</span><span>${t.toFixed(2)}</span></div>
            <hr><div style="font-size:12px;">BAIXA ESTOQUE:</div>
            ${Combo.items.map(i=>`<div>${i.qty*q}x ${i.nome}</div>`).join('')}
            <div class="receipt-total">TOTAL: R$ ${t.toFixed(2)}</div>
        `;
        window.print();
    }
};

/* --- IMPORTER --- */
const Importer = {
    staged: [],
    parse: (inp) => {
        const r = new FileReader();
        r.onload = (e) => {
            const x = new DOMParser().parseFromString(e.target.result, "text/xml");
            const d = x.getElementsByTagName('det');
            Importer.staged = [];
            for(let i=0; i<d.length; i++) {
                const p = d[i].getElementsByTagName('prod')[0];
                const u = p.getElementsByTagName('uCom')[0].textContent;
                const isBox = /CX|CAIXA|DZ/.test(u.toUpperCase());
                Importer.staged.push({
                    nome: p.getElementsByTagName('xProd')[0].textContent,
                    ean: p.getElementsByTagName('cEAN')[0]?.textContent||'',
                    ncm: p.getElementsByTagName('NCM')[0]?.textContent||'',
                    cest: p.getElementsByTagName('CEST')[0]?.textContent||'',
                    cfop: p.getElementsByTagName('CFOP')[0]?.textContent||'5102',
                    q: parseFloat(p.getElementsByTagName('qCom')[0].textContent),
                    c: parseFloat(p.getElementsByTagName('vUnCom')[0].textContent),
                    isBox, f: isBox?'':1
                });
            }
            Importer.render(); document.getElementById('modal-import').showModal();
        };
        if(inp.files[0]) r.readAsText(inp.files[0]);
        inp.value='';
    },
    render: () => document.getElementById('import-rows').innerHTML = Importer.staged.map((r,i)=>`
        <tr><td>${r.nome}</td><td>${r.isBox?`<b style="color:red">${r.un}</b>`:r.un}</td><td>${r.q}</td>
        <td><input type="number" style="width:60px" value="${r.f}" onchange="Importer.staged[${i}].f=this.value;Importer.render()"></td>
        <td>${r.f?r.q*r.f:'-'}</td></tr>`).join(''),
    commit: () => {
        Importer.staged.forEach(r => {
            const f = parseFloat(r.f)||1;
            const finalQ = r.q * f;
            const finalC = r.c / f;
            const p = DB.data.produtos.find(x => x.ean===r.ean || x.nome===r.nome.toUpperCase());
            if(p) { p.estoque+=finalQ; p.custo=finalC; }
            else DB.data.produtos.push({
                id: Date.now().toString(36)+Math.random(), codigo: DB.nextCode(), ean: r.ean, nome: r.nome.toUpperCase(),
                custo: finalC, valor: finalC*1.6, estoque: finalQ, unidade: r.isBox?'UN':r.un,
                ncm:r.ncm, cest:r.cest, cfop:r.cfop, isCombo:false, isOffer:false
            });
        });
        DB.save(); App.render(); document.getElementById('modal-import').close();
    }
};

document.addEventListener('DOMContentLoaded', App.init);
</script>
</body>
</html>
