<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMAS - Rota de Entrega</title>
    <!-- CSS Minimalista para Mobile -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #64748b;
            --success: #16a34a;
            --whatsapp: #25d366;
            --card-bg: #ffffff;
        }
        
        body { background-color: #f1f5f9; font-family: system-ui, -apple-system, sans-serif; padding-bottom: 50px; }
        .container { max-width: 500px; padding-top: 10px; }
        
        /* Dashboard de Status */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 10px; border-radius: 12px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-card small { display: block; color: var(--secondary); font-size: 0.7rem; text-transform: uppercase; }
        .stat-card strong { font-size: 1.2rem; }

        /* Seletor de Pedidos */
        .selector-box { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        select { margin-bottom: 0; }

        /* Card de Entrega Ativa */
        #activeDelivery { min-height: 200px; }
        .delivery-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 4px 15px -1px rgba(0,0,0,0.1);
            border-top: 6px solid var(--primary);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .delivery-card.completed { border-top-color: var(--success); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .badge { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; background: #e2e8f0; color: #475569; font-weight: bold; }
        .client-name { font-size: 1.3rem; font-weight: 800; color: #1e293b; margin: 0; }
        .address { font-size: 0.95rem; color: #475569; margin: 8px 0; line-height: 1.5; }

        /* WhatsApp e A√ß√µes */
        .wa-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-wa { background-color: var(--whatsapp); border: none; font-size: 0.75rem; padding: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 5px; }
        
        .main-actions { margin-top: 20px; border-top: 1px dashed #cbd5e1; padding-top: 20px; }
        .btn-action { width: 100%; margin-bottom: 10px; font-weight: bold; }
        .btn-gps { background-color: #ef4444; border: none; }
        .btn-check { background-color: var(--success); border: none; }

        /* Modal Customizado */
        #paymentModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
        }
        .modal-content { background: white; padding: 20px; border-radius: 16px; width: 100%; max-width: 400px; }

        .upload-screen { text-align: center; padding: 40px 20px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <main class="container">
        <!-- Ecr√£ de Upload -->
        <section id="uploadSection" class="upload-screen">
            <span style="font-size: 4rem">üöö</span>
            <h2>Log√≠stica Express</h2>
            <p>Carregue o JSON para iniciar as entregas.</p>
            <input type="file" id="jsonInput" accept=".json" hidden>
            <button onclick="document.getElementById('jsonInput').click()">Abrir Relat√≥rio</button>
        </section>

        <!-- Painel Principal -->
        <section id="mainSection" class="hidden">
            <div class="stats-grid">
                <div class="stat-card"><small>Total</small><strong id="totalCount">0</strong></div>
                <div class="stat-card"><small>Pendente</small><strong id="pendingCount" style="color: var(--primary)">0</strong></div>
                <div class="stat-card"><small>Feito</small><strong id="doneCount" style="color: var(--success)">0</strong></div>
            </div>

            <div class="selector-box">
                <label for="orderSelector">Selecione o Pr√≥ximo Pedido:</label>
                <select id="orderSelector" onchange="loadOrder(this.value)">
                    <option value="">-- Escolha um pedido --</option>
                </select>
            </div>

            <div id="activeDelivery">
                <!-- Card do pedido selecionado -->
                <div id="emptyState" style="text-align: center; color: var(--secondary); margin-top: 40px;">
                    <p>Selecione um pedido acima para ver os detalhes e iniciar a navega√ß√£o.</p>
                </div>
            </div>

            <div style="margin-top: 40px; text-align: center;">
                <button class="outline contrast" onclick="resetApp()">Limpar Tudo / Novo Arquivo</button>
            </div>
        </section>
    </main>

    <!-- Modal de Pagamento -->
    <div id="paymentModal" class="hidden">
        <div class="modal-content">
            <h4>Confirmar Entrega</h4>
            <p>Como o cliente pagou?</p>
            <select id="paymentMethodSelect">
                <option value="Dinheiro">Dinheiro</option>
                <option value="Pix">Pix</option>
                <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                <option value="Pago no Site/App">J√° estava pago</option>
            </select>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                <button class="secondary" onclick="closeModal()">Cancelar</button>
                <button onclick="confirmDeliveryFinal()">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'sistemas_rota_v1';
        const ADMIN_WA = '5565998150974'; // Formato internacional
        let state = {
            entregas: [],
            selectedId: null
        };

        window.addEventListener('load', () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                state.entregas = JSON.parse(saved);
                initApp();
            }
        });

        document.getElementById('jsonInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const rawData = JSON.parse(event.target.result);
                    state.entregas = rawData.map(item => ({
                        id: item.codigo || item.id,
                        db_id: item.id,
                        nome: item.detalhes_cliente.nome,
                        primeiroNome: item.detalhes_cliente.nome.split(' ')[0],
                        tel: item.detalhes_cliente.tel,
                        morada: item.detalhes_cliente.endereco,
                        bairro: item.detalhes_cliente.bairro,
                        cidade: item.detalhes_cliente.cidade,
                        rota: item.rota,
                        produto: item.detalhes_produto.nome,
                        qtd: item.qty,
                        total: item.total,
                        concluido: false,
                        formaPagamento: ''
                    }));
                    saveState();
                    initApp();
                } catch (err) { alert("Erro no JSON"); }
            };
            reader.readAsText(e.target.files[0]);
        });

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state.entregas));
        }

        function initApp() {
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
            updateStats();
            populateSelector();
        }

        function updateStats() {
            document.getElementById('totalCount').innerText = state.entregas.length;
            document.getElementById('pendingCount').innerText = state.entregas.filter(i => !i.concluido).length;
            document.getElementById('doneCount').innerText = state.entregas.filter(i => i.concluido).length;
        }

        function populateSelector() {
            const sel = document.getElementById('orderSelector');
            sel.innerHTML = '<option value="">-- Escolha um pedido --</option>';
            state.entregas.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.db_id;
                opt.textContent = `${item.concluido ? '‚úÖ' : 'üì¶'} ${item.id} - ${item.nome}`;
                sel.appendChild(opt);
            });
        }

        function loadOrder(dbId) {
            if (!dbId) {
                document.getElementById('activeDelivery').innerHTML = '<div id="emptyState" style="text-align: center; color: var(--secondary); margin-top: 40px;"><p>Selecione um pedido acima.</p></div>';
                return;
            }
            state.selectedId = dbId;
            const item = state.entregas.find(i => i.db_id === dbId);
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.morada + ', ' + item.bairro + ', ' + item.cidade)}`;
            
            const waPreMsg = encodeURIComponent(`Ol√° ${item.primeiroNome}! Aqui √© do setor de entregas. Sua encomenda √© a pr√≥xima da rota e j√° estou a caminho! üöö`);
            const waArrivedMsg = encodeURIComponent(`Ol√° ${item.primeiroNome}! Acabei de chegar no seu endere√ßo para a entrega. üîî`);

            document.getElementById('activeDelivery').innerHTML = `
                <div class="delivery-card ${item.concluido ? 'completed' : ''}">
                    <div class="card-header">
                        <span class="badge">PEDIDO: ${item.id}</span>
                        <span class="badge" style="background:${item.concluido ? '#dcfce7' : '#fef3c7'}">${item.concluido ? 'CONCLU√çDO' : 'ROTA: ' + item.rota}</span>
                    </div>
                    <h3 class="client-name">${item.nome}</h3>
                    <p class="address">üìç ${item.morada}<br>üèòÔ∏è ${item.bairro} - ${item.cidade}</p>
                    
                    <div class="wa-actions">
                        <a href="https://wa.me/55${item.tel}?text=${waPreMsg}" target="_blank" class="btn-wa"><span>üí¨</span> A caminho</a>
                        <a href="https://wa.me/55${item.tel}?text=${waArrivedMsg}" target="_blank" class="btn-wa"><span>üîî</span> Cheguei</a>
                    </div>

                    <div class="main-actions">
                        <a href="${mapsUrl}" target="_blank" class="btn-action btn-gps" role="button">Abrir Rota no GPS</a>
                        ${!item.concluido ? 
                            `<button class="btn-action btn-check" onclick="openModal()">Confirmar Entrega</button>` : 
                            `<p style="text-align:center; color:var(--success); font-weight:bold">‚úì Pedido Finalizado</p>`
                        }
                    </div>
                </div>
            `;
        }

        function openModal() { document.getElementById('paymentModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('paymentModal').classList.add('hidden'); }

        function confirmDeliveryFinal() {
            const method = document.getElementById('paymentMethodSelect').value;
            const item = state.entregas.find(i => i.db_id === state.selectedId);
            
            item.concluido = true;
            item.formaPagamento = method;
            
            saveState();
            closeModal();
            updateStats();
            populateSelector();
            loadOrder(state.selectedId);

            // Relat√≥rio para o Admin via WhatsApp
            const adminMsg = encodeURIComponent(
                `üèÅ *ENTREGA CONCLU√çDA*\n\n` +
                `üÜî Pedido: ${item.id}\n` +
                `üë§ Cliente: ${item.nome}\n` +
                `üöö Rota: ${item.rota}\n` +
                `üìç Local: ${item.cidade} / ${item.bairro}\n` +
                `üí∞ Valor: R$ ${item.total.toFixed(2)}\n` +
                `üí≥ Pago via: ${method}`
            );
            
            window.open(`https://wa.me/${ADMIN_WA}?text=${adminMsg}`, '_blank');
        }

        function resetApp() {
            if(confirm("Deseja resetar todos os dados?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }
    </script>
</body>
</html>
