<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rota Dona Antonia | Gest√£o de Pedidos</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f8fafc', 100: '#f1f5f9', 500: '#64748b', 600: '#475569', 700: '#334155', 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #f8fafc; }
        
        /* Scrollbar Fina e Elegante */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Anima√ß√µes Suaves */
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilo Compacto para Desktop */
        .input-compact {
            @apply text-sm border-gray-300 rounded shadow-sm focus:border-brand-600 focus:ring focus:ring-brand-200 focus:ring-opacity-50 w-full transition-all;
        }
        
        .btn-action {
            @apply px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wide transition-colors duration-200 border;
        }

        /* Modal Transitions */
        .modal-backdrop { transition: opacity 0.2s ease; }
        .modal-panel { transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.2s ease; }
    </style>
</head>
<body class="text-slate-800 antialiased h-screen flex flex-col overflow-hidden">

    <!-- Toast Container (Notifica√ß√µes) -->
    <div id="toast-container" class="fixed top-5 right-5 z-[60] flex flex-col gap-2"></div>

    <!-- HEADER / TOPBAR -->
    <header class="bg-white border-b border-slate-200 h-16 flex-none flex items-center justify-between px-6 shadow-sm z-30">
        <div class="flex items-center gap-4">
            <div class="bg-brand-800 text-white p-2 rounded-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7" /></svg>
            </div>
            <div>
                <h1 class="text-lg font-bold text-slate-800 leading-none">Rota Dona Antonia</h1>
                <p class="text-xs text-slate-500 font-medium" id="header-date">Carregando...</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- Barra de Filtros de Regi√£o (Compacta) -->
            <div class="bg-slate-100 p-1 rounded-lg flex gap-1" id="filtros-regiao">
                <!-- Preenchido via JS -->
            </div>

            <div class="h-8 w-px bg-slate-200 mx-2"></div>

            <button onclick="App.controllers.iniciarNovoLancamento()" class="bg-brand-800 hover:bg-brand-900 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm hover:shadow transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                Novo Pedido
            </button>
            
            <button onclick="App.controllers.resetarRota()" class="text-red-500 hover:bg-red-50 p-2 rounded-lg text-xs font-bold transition-colors" title="Limpar Rota Atual">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 flex overflow-hidden bg-slate-50 relative">
        
        <!-- Sidebar KPI (Opcional, ou manter stats no topo) -->
        <aside class="w-64 bg-white border-r border-slate-200 hidden xl:flex flex-col p-6 gap-6 overflow-y-auto">
            <div id="kpi-container" class="space-y-4">
                <!-- KPIs renderizados aqui -->
            </div>
            
            <div class="border-t border-slate-100 pt-4">
                <h3 class="text-xs font-bold text-slate-400 uppercase mb-3">Acesso R√°pido</h3>
                <nav class="space-y-1">
                    <a href="#" class="block px-3 py-2 bg-brand-50 text-brand-700 rounded-md text-sm font-bold">üì¶ Pedidos Ativos</a>
                    <a href="#" onclick="alert('Funcionalidade simplificada para esta demo')" class="block px-3 py-2 text-slate-600 hover:bg-slate-50 rounded-md text-sm font-medium">üë• Base de Clientes</a>
                    <a href="#" onclick="App.controllers.exportarRota()" class="block px-3 py-2 text-slate-600 hover:bg-slate-50 rounded-md text-sm font-medium">üíæ Exportar JSON</a>
                </nav>
            </div>
        </aside>

        <!-- Grid de Pedidos -->
        <div class="flex-1 overflow-y-auto p-6 scroll-smooth">
            
            <!-- Barra de Busca R√°pida -->
            <div class="mb-6 max-w-md">
                <div class="relative">
                    <input type="text" id="search-pedidos" onkeyup="App.ui.filterCards()" placeholder="üîç Filtrar pedidos por nome, endere√ßo ou item..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </div>
                </div>
            </div>

            <div id="lista-entregas" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4 gap-4 pb-20">
                <!-- CARDS renderizados via JS -->
            </div>

            <!-- Empty State -->
            <div id="lista-vazia" class="hidden flex-col items-center justify-center h-full text-slate-400 opacity-60">
                <svg class="w-20 h-20 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" /></svg>
                <p class="text-lg font-medium">Nenhum pedido nesta regi√£o.</p>
            </div>
        </div>
    </main>

    <!-- ================= MODAIS DESKTOP ================= -->

    <!-- Modal Lan√ßamento (Largo para Desktop) -->
    <div id="modal-lancamento" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm modal-backdrop transition-opacity" onclick="App.ui.modalLancamento.close()"></div>
        
        <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-auto max-h-[90vh] flex flex-col pointer-events-auto modal-panel transform transition-all">
                
                <!-- Modal Header -->
                <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50 rounded-t-xl">
                    <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                        <span class="bg-brand-600 text-white w-6 h-6 rounded flex items-center justify-center text-xs">P</span>
                        <span id="modal-lancamento-title">Novo Pedido</span>
                    </h3>
                    <button onclick="App.ui.modalLancamento.close()" class="text-slate-400 hover:text-slate-600 p-1 rounded-md hover:bg-slate-200 transition-colors">
                        <span class="sr-only">Fechar</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <!-- Modal Body (Grid Layout) -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        <!-- Coluna Esquerda: Cliente e Localiza√ß√£o -->
                        <div class="lg:col-span-5 space-y-5 border-r border-slate-100 pr-4">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Dados do Cliente</h4>
                            
                            <div class="relative group">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Nome / Busca</label>
                                <input type="text" id="input-cliente" class="input-compact" placeholder="Digite para buscar..." autocomplete="off">
                                <div id="dropdown-clientes" class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl max-h-48 overflow-y-auto"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Bairro</label>
                                    <input type="text" id="input-bairro" class="input-compact bg-slate-50" placeholder="Bairro">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700 mb-1">Cidade</label>
                                    <select id="input-cidade" class="input-compact bg-slate-50">
                                        <option value="Cuiab√°">Cuiab√°</option>
                                        <option value="V√°rzea Grande">V√°rzea Grande</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Regi√£o de Entrega</label>
                                <div class="grid grid-cols-4 gap-2 text-sm" id="container-radio-regiao">
                                    <!-- JS Generated -->
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Observa√ß√µes Gerais</label>
                                <textarea id="input-obs-geral" rows="3" class="input-compact resize-none" placeholder="Ponto de refer√™ncia, cor do port√£o..."></textarea>
                            </div>
                        </div>

                        <!-- Coluna Direita: Itens do Pedido -->
                        <div class="lg:col-span-7 flex flex-col h-full">
                            <h4 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Montagem do Pedido</h4>
                            
                            <!-- Adicionar Item Box -->
                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200 mb-4 shadow-sm">
                                <div class="flex gap-2 mb-3">
                                    <div class="flex-1 relative">
                                        <select id="select-cesta" class="input-compact h-10 font-medium text-slate-700">
                                            <option value="">Selecione a Cesta...</option>
                                            <!-- JS Generated -->
                                        </select>
                                    </div>
                                    <input type="number" id="qtd-cesta" value="1" min="1" class="input-compact w-20 text-center font-bold h-10">
                                </div>

                                <div class="flex items-center gap-4 mb-3">
                                    <label class="inline-flex items-center cursor-pointer text-sm select-none">
                                        <input type="checkbox" id="check-alterada" class="form-checkbox h-4 w-4 text-brand-600 rounded border-gray-300 focus:ring-brand-500">
                                        <span class="ml-2 text-slate-600 font-medium">Personalizar/Alterar?</span>
                                    </label>
                                </div>

                                <!-- Box Detalhes Alterada -->
                                <div id="box-detalhes-alterada" class="hidden bg-white p-3 rounded border border-amber-200 mb-3 space-y-2 animate-in fade-in">
                                    <p class="text-[10px] font-bold text-amber-600 uppercase">Ajustar Itens:</p>
                                    <div id="lista-produtos-edicao" class="max-h-32 overflow-y-auto space-y-1 pr-1 custom-scrollbar">
                                        <!-- JS Generated -->
                                    </div>
                                </div>

                                <div class="flex items-center gap-3 mb-3">
                                    <span class="text-xs font-bold text-slate-400 uppercase">Brindes:</span>
                                    <label class="inline-flex items-center text-xs bg-white px-2 py-1 rounded border hover:bg-slate-50 cursor-pointer"><input type="checkbox" name="brindes" value="Ovo" class="mr-1">Ovo</label>
                                    <label class="inline-flex items-center text-xs bg-white px-2 py-1 rounded border hover:bg-slate-50 cursor-pointer"><input type="checkbox" name="brindes" value="Amaciante" class="mr-1">Amaciante</label>
                                    <label class="inline-flex items-center text-xs bg-white px-2 py-1 rounded border hover:bg-slate-50 cursor-pointer"><input type="checkbox" name="brindes" value="Cafe" class="mr-1">Caf√©</label>
                                </div>

                                <button onclick="App.controllers.adicionarItemAoCarrinho()" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-2 rounded-lg text-sm font-bold shadow transition-transform active:scale-95 flex justify-center items-center gap-2">
                                    <span>Adicionar ao Carrinho</span>
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                                </button>
                            </div>

                            <!-- Lista Carrinho -->
                            <div class="flex-1 overflow-y-auto bg-white border border-slate-200 rounded-lg p-0 mb-4 min-h-[150px]">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-slate-500 font-semibold text-xs uppercase sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2">Qtd</th>
                                            <th class="px-4 py-2">Item</th>
                                            <th class="px-4 py-2 text-right">Valor</th>
                                            <th class="px-2 py-2 w-10"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="carrinho-visual" class="divide-y divide-slate-100">
                                        <!-- JS Generated -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="flex justify-between items-center bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <span class="font-bold text-slate-600">Total do Pedido:</span>
                                <div class="flex items-center gap-1">
                                    <span class="text-sm text-slate-400">R$</span>
                                    <input type="number" id="input-valor-final" step="0.01" class="bg-transparent border-none text-right font-black text-xl text-slate-800 w-32 focus:ring-0 p-0" placeholder="0.00">
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-3 rounded-b-xl">
                    <button onclick="App.ui.modalLancamento.close()" class="px-6 py-2.5 rounded-lg border border-slate-300 text-slate-600 font-bold hover:bg-white transition-colors">Cancelar</button>
                    <button onclick="App.controllers.salvarEntrega()" id="btn-submit-lancamento" class="px-8 py-2.5 rounded-lg bg-brand-600 text-white font-bold hover:bg-brand-700 shadow-md transition-all active:scale-95">Confirmar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Pagamento (Compacto) -->
    <div id="modal-pagamento" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden animate-in fade-in zoom-in duration-200">
            <div class="bg-green-600 p-4 text-white text-center">
                <h3 class="text-lg font-bold">Concluir Entrega</h3>
                <p class="text-green-100 text-sm mt-1" id="pag-cliente-nome">Cliente</p>
                <p class="text-3xl font-black mt-2" id="pag-valor-total">R$ 0,00</p>
            </div>
            <div class="p-6">
                <p class="text-xs text-slate-500 font-bold uppercase mb-3">Forma de Pagamento</p>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <label class="cursor-pointer border p-3 rounded-lg hover:bg-green-50 hover:border-green-200 transition-all text-center has-[:checked]:bg-green-50 has-[:checked]:border-green-500">
                        <input type="checkbox" name="pagamento" value="DINHEIRO" class="hidden">
                        <span class="block font-bold text-slate-700 text-sm">üíµ Dinheiro</span>
                    </label>
                    <label class="cursor-pointer border p-3 rounded-lg hover:bg-green-50 hover:border-green-200 transition-all text-center has-[:checked]:bg-green-50 has-[:checked]:border-green-500">
                        <input type="checkbox" name="pagamento" value="PIX" class="hidden">
                        <span class="block font-bold text-slate-700 text-sm">üí† PIX</span>
                    </label>
                    <label class="cursor-pointer border p-3 rounded-lg hover:bg-green-50 hover:border-green-200 transition-all text-center has-[:checked]:bg-green-50 has-[:checked]:border-green-500">
                        <input type="checkbox" name="pagamento" value="CART√ÉO" class="hidden">
                        <span class="block font-bold text-slate-700 text-sm">üí≥ Cart√£o</span>
                    </label>
                    <label class="cursor-pointer border p-3 rounded-lg hover:bg-green-50 hover:border-green-200 transition-all text-center has-[:checked]:bg-green-50 has-[:checked]:border-green-500">
                        <input type="checkbox" name="pagamento" value="S√ì ENTREGAR" class="hidden">
                        <span class="block font-bold text-slate-700 text-sm">üì¶ S√≥ Entregar</span>
                    </label>
                </div>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('modal-pagamento').classList.add('hidden')" class="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-bold text-sm">Cancelar</button>
                    <button onclick="App.controllers.confirmarPagamento()" class="flex-1 py-2.5 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 text-sm">Confirmar Baixa</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- CONSTANTS & CONFIG ---
        const CONSTANTS = {
            REGIOES: ["VG", "CUIABA", "COXIPO", "CPA"],
            STORAGE_KEY: "rotaflow_v2_db",
            CLIENTS_DB_KEY: "rotaflow_clientes_db",
            CESTAS: [
                { value: "ECONOMICA", label: "ECONOMICA", price: 85.00 },
                { value: "Mini Bonini", label: "Mini Bonini", price: 165.00 },
                { value: "Pequena Bonini", label: "Pequena Bonini", price: 215.00 },
                { value: "M√©dia Bonini", label: "M√©dia Bonini", price: 320.00 },
                { value: "Grande Bonini", label: "Grande Bonini", price: 380.00 },
                { value: "Grande Koblenz", label: "Grande Koblenz", price: 390.00 }
            ],
            // Simplified Items for "Personalization" logic
            ITENS_BASE: [
                { nome: 'Arroz 5kg', qtd: 1 }, { nome: 'A√ß√∫car 2kg', qtd: 1 }, { nome: '√ìleo', qtd: 2 }, 
                { nome: 'Feij√£o 1kg', qtd: 2 }, { nome: 'Caf√©', qtd: 1 }, { nome: 'Macarr√£o', qtd: 2 },
                { nome: 'Trigo 1kg', qtd: 1 }, { nome: 'Sal', qtd: 1 }, { nome: 'Extrato', qtd: 1 },
                { nome: 'Bolacha', qtd: 2 }, { nome: 'Sab√£o P√≥', qtd: 1 }, { nome: 'Qboa', qtd: 1 }
            ]
        };

        const Utils = {
            formatMoeda: (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0),
            formatData: (iso) => new Date(iso).toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' }),
            toast: (msg, type = 'success') => {
                const c = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `px-4 py-3 rounded shadow-lg text-sm font-bold flex items-center gap-2 animate-in slide-in-from-right duration-300 ${type === 'error' ? 'bg-red-500 text-white' : 'bg-brand-800 text-white'}`;
                el.innerHTML = type === 'error' ? `<span>‚ö†Ô∏è</span> ${msg}` : `<span>‚úÖ</span> ${msg}`;
                c.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            }
        };

        const Store = {
            data: { rotaAtiva: null, regiaoFiltro: 'VG', carrinhoTemp: [], editingId: null, tempBasketItems: [] },
            init() {
                const saved = localStorage.getItem(CONSTANTS.STORAGE_KEY);
                this.data.rotaAtiva = saved ? JSON.parse(saved) : { id: Date.now(), dataCriacao: new Date().toISOString(), entregas: [] };
                
                const savedClients = localStorage.getItem(CONSTANTS.CLIENTS_DB_KEY);
                window.CLIENTES_DB = savedClients ? JSON.parse(savedClients) : [];
            },
            save() {
                localStorage.setItem(CONSTANTS.STORAGE_KEY, JSON.stringify(this.data.rotaAtiva));
                App.ui.render();
            },
            addEntrega(ent) { this.data.rotaAtiva.entregas.push(ent); this.save(); },
            updateEntrega(id, updates) {
                const idx = this.data.rotaAtiva.entregas.findIndex(e => e.id == id);
                if (idx !== -1) {
                    this.data.rotaAtiva.entregas[idx] = { ...this.data.rotaAtiva.entregas[idx], ...updates, updatedAt: new Date().toISOString() };
                    this.save();
                }
            },
            getEntregas() {
                return this.data.rotaAtiva.entregas
                    .filter(e => e.regiao === this.data.regiaoFiltro)
                    .sort((a,b) => (a.status === 'Pendente' ? -1 : 1));
            }
        };

        const App = {
            ui: {
                modalLancamento: {
                    open: () => document.getElementById('modal-lancamento').classList.remove('hidden'),
                    close: () => document.getElementById('modal-lancamento').classList.add('hidden')
                },
                renderCarrinho: () => {
                    const tbody = document.getElementById('carrinho-visual');
                    const totalInput = document.getElementById('input-valor-final');
                    let total = 0;
                    
                    if(Store.data.carrinhoTemp.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400 text-xs italic">Carrinho vazio</td></tr>';
                        if(!Store.data.editingId) totalInput.value = '';
                        return;
                    }

                    tbody.innerHTML = Store.data.carrinhoTemp.map((item, i) => {
                        total += (item.valor * item.qtd);
                        return `
                            <tr class="group hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-2 font-bold text-slate-600">${item.qtd}x</td>
                                <td class="px-4 py-2">
                                    <div class="font-medium text-slate-800">${item.nome}</div>
                                    ${item.tipo === 'Alterada' ? '<div class="text-[10px] text-amber-600 font-bold uppercase">Personalizada</div>' : ''}
                                    ${item.brindes && item.brindes.length ? `<div class="text-[10px] text-brand-500">+ ${item.brindes.join(', ')}</div>` : ''}
                                </td>
                                <td class="px-4 py-2 text-right font-mono text-slate-600">${Utils.formatMoeda(item.valor * item.qtd)}</td>
                                <td class="px-2 py-2 text-center">
                                    <button onclick="App.controllers.removerItemCarrinho(${i})" class="text-red-300 hover:text-red-500 p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                                </td>
                            </tr>
                        `;
                    }).join('');

                    // S√≥ atualiza input se for calculado ou se estiver vazio
                    if(!totalInput.value || Store.data.editingId === null) totalInput.value = total.toFixed(2);
                },
                render: () => {
                    document.getElementById('header-date').innerText = Utils.formatData(Store.data.rotaAtiva.dataCriacao);
                    
                    // Render Regiao Filters
                    const filtrosEl = document.getElementById('filtros-regiao');
                    filtrosEl.innerHTML = CONSTANTS.REGIOES.map(r => {
                        const count = Store.data.rotaAtiva.entregas.filter(e => e.regiao === r && e.status === 'Pendente').length;
                        const active = Store.data.regiaoFiltro === r;
                        return `<button onclick="App.controllers.mudarFiltro('${r}')" class="px-3 py-1.5 rounded-md text-xs font-bold transition-all ${active ? 'bg-white shadow text-brand-800' : 'text-slate-500 hover:bg-slate-200'}">${r} ${count > 0 ? `<span class="bg-brand-100 text-brand-700 ml-1 px-1.5 py-0.5 rounded-full text-[10px]">${count}</span>` : ''}</button>`;
                    }).join('');

                    // Render Cards
                    const entregas = Store.getEntregas();
                    const container = document.getElementById('lista-entregas');
                    const empty = document.getElementById('lista-vazia');
                    
                    if(entregas.length === 0) { container.innerHTML = ''; empty.classList.remove('hidden'); empty.classList.add('flex'); return; }
                    empty.classList.add('hidden'); empty.classList.remove('flex');

                    // Update KPI Summary in Sidebar
                    const total = Store.data.rotaAtiva.entregas.length;
                    const done = Store.data.rotaAtiva.entregas.filter(e => e.status === 'Entregue').length;
                    const pending = total - done;
                    document.getElementById('kpi-container').innerHTML = `
                        <div class="bg-white rounded-lg border border-slate-100 p-4 shadow-sm">
                            <p class="text-xs text-slate-400 font-bold uppercase mb-1">Total Pedidos</p>
                            <p class="text-2xl font-black text-slate-800">${total}</p>
                        </div>
                        <div class="bg-green-50 rounded-lg border border-green-100 p-4 shadow-sm">
                            <p class="text-xs text-green-600 font-bold uppercase mb-1">Entregues</p>
                            <p class="text-2xl font-black text-green-700">${done}</p>
                        </div>
                        <div class="bg-brand-50 rounded-lg border border-brand-100 p-4 shadow-sm">
                            <p class="text-xs text-brand-600 font-bold uppercase mb-1">Pendentes</p>
                            <p class="text-2xl font-black text-brand-700">${pending}</p>
                        </div>
                    `;

                    container.innerHTML = entregas.map((e, idx) => {
                        const isDone = e.status === 'Entregue';
                        const isCanceled = e.status === 'Cancelada';
                        let opacityClass = isDone || isCanceled ? 'opacity-60 bg-slate-50 border-slate-200' : 'bg-white border-slate-200 hover:border-brand-300 hover:shadow-md';
                        
                        const itemsHtml = e.cestas.map(c => 
                            `<div class="flex justify-between text-xs py-1 border-b border-slate-50 last:border-0">
                                <span class="font-medium text-slate-700 truncate w-2/3" title="${c.nome}">${c.qtd}x ${c.nome}</span>
                                <span class="text-slate-500">${Utils.formatMoeda(c.valor * c.qtd)}</span>
                             </div>`
                        ).join('');

                        return `
                        <div class="card rounded-xl border p-4 transition-all flex flex-col h-full ${opacityClass} relative overflow-hidden group">
                            ${isDone ? '<div class="absolute right-0 top-0 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg z-10">ENTREGUE</div>' : ''}
                            ${isCanceled ? '<div class="absolute right-0 top-0 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg z-10">CANCELADA</div>' : ''}
                            
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-bold text-slate-800 text-sm leading-tight mb-1">${e.cliente.nome}</h4>
                                    <p class="text-xs text-slate-500 truncate max-w-[180px]" title="${e.cliente.endereco}">${e.cliente.endereco || 'Retirar'}</p>
                                    ${e.cliente.bairro ? `<p class="text-[10px] text-slate-400 font-medium uppercase tracking-wide mt-1">${e.cliente.bairro}</p>` : ''}
                                </div>
                                <div class="text-right">
                                    <div class="font-black text-brand-700 text-sm">${Utils.formatMoeda(e.valorTotalAjustado)}</div>
                                    <div class="text-[10px] text-slate-400 mt-0.5">#${e.displayId || (idx+1)}</div>
                                </div>
                            </div>
                            
                            <div class="bg-slate-50 rounded p-2 mb-3 flex-1 overflow-y-auto max-h-[80px] custom-scrollbar">
                                ${itemsHtml}
                            </div>
                            
                            ${e.observacao ? `<div class="bg-amber-50 text-amber-700 text-[10px] p-2 rounded mb-3 border border-amber-100 font-medium">‚ö†Ô∏è ${e.observacao}</div>` : ''}

                            <div class="grid grid-cols-4 gap-2 mt-auto pt-2 border-t border-slate-100">
                                <a href="${e.cliente.celular ? 'tel:'+e.cliente.celular.replace(/\D/g,'') : '#'}" class="btn-action flex items-center justify-center text-slate-500 hover:bg-slate-100 hover:text-slate-800" title="Ligar">
                                    üìû
                                </a>
                                <button onclick="App.controllers.abrirZap('${e.cliente.celular}')" class="btn-action flex items-center justify-center text-green-600 hover:bg-green-50 border-green-100" title="WhatsApp">
                                    üí¨
                                </button>
                                
                                ${!isDone && !isCanceled ? `
                                    <button onclick="App.controllers.editarEntrega(${e.id})" class="btn-action flex items-center justify-center text-amber-600 hover:bg-amber-50 border-amber-100" title="Editar">
                                        ‚úèÔ∏è
                                    </button>
                                    <button onclick="App.controllers.iniciarPagamento(${e.id})" class="btn-action flex items-center justify-center bg-slate-800 text-white hover:bg-slate-900 border-slate-800" title="Concluir">
                                        ‚úî
                                    </button>
                                ` : `
                                    <button class="col-span-2 btn-action bg-gray-100 text-gray-400 cursor-not-allowed">Conclu√≠do</button>
                                `}
                            </div>
                        </div>`;
                    }).join('');
                },
                filterCards: () => {
                    const term = document.getElementById('search-pedidos').value.toLowerCase();
                    const cards = document.querySelectorAll('#lista-entregas > div');
                    cards.forEach(card => {
                        card.style.display = card.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
                    });
                }
            },
            controllers: {
                mudarFiltro: (r) => { Store.data.regiaoFiltro = r; App.ui.render(); },
                resetarRota: () => { if(confirm('Zerar rota e iniciar novo dia?')) { Store.data.rotaAtiva = {id: Date.now(), dataCriacao:new Date().toISOString(), entregas:[]}; Store.save(); } },
                
                iniciarNovoLancamento: () => {
                    Store.data.editingId = null;
                    Store.data.carrinhoTemp = [];
                    // Reset fields
                    document.getElementById('input-cliente').value = '';
                    document.getElementById('input-bairro').value = '';
                    document.getElementById('input-cidade').value = 'Cuiab√°';
                    document.getElementById('input-obs-geral').value = '';
                    document.getElementById('input-valor-final').value = '';
                    document.getElementById('qtd-cesta').value = 1;
                    document.getElementById('modal-lancamento-title').innerText = "Novo Pedido";
                    document.getElementById('btn-submit-lancamento').innerText = "Confirmar Pedido";
                    
                    const padrao = document.querySelector(`input[name="regiao"][value="VG"]`);
                    if(padrao) padrao.checked = true;
                    
                    App.ui.renderCarrinho();
                    App.ui.modalLancamento.open();
                },
                editarEntrega: (id) => {
                    const e = Store.data.rotaAtiva.entregas.find(x => x.id == id);
                    if(!e) return;
                    Store.data.editingId = id;
                    Store.data.carrinhoTemp = JSON.parse(JSON.stringify(e.cestas));
                    
                    document.getElementById('input-cliente').value = e.cliente.nome;
                    document.getElementById('input-bairro').value = e.cliente.bairro || '';
                    document.getElementById('input-cidade').value = e.cliente.cidade || 'Cuiab√°';
                    document.getElementById('input-obs-geral').value = e.observacao || '';
                    document.getElementById('input-valor-final').value = e.valorTotalAjustado;
                    
                    const radio = document.querySelector(`input[name="regiao"][value="${e.regiao}"]`);
                    if(radio) radio.checked = true;
                    
                    document.getElementById('modal-lancamento-title').innerText = `Editando Pedido #${e.displayId || ''}`;
                    document.getElementById('btn-submit-lancamento').innerText = "Salvar Altera√ß√µes";
                    
                    App.ui.renderCarrinho();
                    App.ui.modalLancamento.open();
                },
                adicionarItemAoCarrinho: () => {
                    const select = document.getElementById('select-cesta');
                    const nome = select.value;
                    if(!nome) return Utils.toast('Selecione uma cesta', 'error');
                    
                    const price = parseFloat(select.options[select.selectedIndex].getAttribute('data-price'));
                    const qtd = parseInt(document.getElementById('qtd-cesta').value);
                    const isAlt = document.getElementById('check-alterada').checked;
                    const brindes = Array.from(document.querySelectorAll('input[name="brindes"]:checked')).map(el => el.value);
                    
                    Store.data.carrinhoTemp.push({
                        nome, valor: price, qtd, tipo: isAlt ? 'Alterada' : 'Normal', brindes
                    });
                    
                    // Reset item inputs
                    document.getElementById('check-alterada').checked = false;
                    document.getElementById('box-detalhes-alterada').classList.add('hidden');
                    document.getElementById('qtd-cesta').value = 1;
                    document.querySelectorAll('input[name="brindes"]').forEach(el => el.checked = false);
                    App.ui.renderCarrinho();
                },
                removerItemCarrinho: (idx) => {
                    Store.data.carrinhoTemp.splice(idx, 1);
                    App.ui.renderCarrinho();
                },
                salvarEntrega: () => {
                    const nome = document.getElementById('input-cliente').value;
                    const regiaoEl = document.querySelector('input[name="regiao"]:checked');
                    
                    if(!nome || !regiaoEl) return Utils.toast('Dados incompletos', 'error');
                    if(Store.data.carrinhoTemp.length === 0) return Utils.toast('Carrinho vazio', 'error');

                    const clienteData = {
                        nome,
                        bairro: document.getElementById('input-bairro').value,
                        cidade: document.getElementById('input-cidade').value,
                        celular: '' // Poderia buscar do DB se existir
                    };
                    
                    // Tenta achar celular no DB
                    const existing = window.CLIENTES_DB.find(c => c.nome.toLowerCase() === nome.toLowerCase());
                    if(existing) { 
                        clienteData.celular = existing.celular; 
                        clienteData.endereco = existing.endereco;
                    }

                    const valFinal = parseFloat(document.getElementById('input-valor-final').value) || 0;
                    
                    if(Store.data.editingId) {
                        Store.updateEntrega(Store.data.editingId, {
                            cliente: clienteData,
                            regiao: regiaoEl.value,
                            cestas: Store.data.carrinhoTemp,
                            valorTotalAjustado: valFinal,
                            observacao: document.getElementById('input-obs-geral').value
                        });
                        Utils.toast('Pedido atualizado!');
                    } else {
                        // Generate Display ID (Day sequence)
                        const today = new Date().toLocaleDateString('pt-BR');
                        const countToday = Store.data.rotaAtiva.entregas.filter(e => new Date(e.dataCriacao).toLocaleDateString('pt-BR') === today).length;
                        
                        Store.addEntrega({
                            id: Date.now(),
                            displayId: (countToday + 1).toString().padStart(2, '0'),
                            cliente: clienteData,
                            regiao: regiaoEl.value,
                            cestas: Store.data.carrinhoTemp,
                            valorTotalAjustado: valFinal,
                            observacao: document.getElementById('input-obs-geral').value,
                            status: 'Pendente',
                            dataCriacao: new Date().toISOString()
                        });
                        Utils.toast('Novo pedido lan√ßado!');
                    }
                    App.ui.modalLancamento.close();
                },
                iniciarPagamento: (id) => {
                    Store.data.editingId = id; // reuses logic
                    const e = Store.data.rotaAtiva.entregas.find(x => x.id == id);
                    document.getElementById('pag-cliente-nome').innerText = e.cliente.nome;
                    document.getElementById('pag-valor-total').innerText = Utils.formatMoeda(e.valorTotalAjustado);
                    document.getElementById('modal-pagamento').classList.remove('hidden');
                },
                confirmarPagamento: () => {
                    const pags = Array.from(document.querySelectorAll('input[name="pagamento"]:checked')).map(el => el.value);
                    if(pags.length === 0) return Utils.toast('Informe o pagamento', 'error');
                    Store.updateEntrega(Store.data.editingId, { status: 'Entregue', formaPagamento: pags });
                    document.getElementById('modal-pagamento').classList.add('hidden');
                    Utils.toast('Entrega conclu√≠da!');
                },
                abrirZap: (cel) => {
                    if(!cel) return Utils.toast('Sem n√∫mero', 'error');
                    window.open(`https://api.whatsapp.com/send?phone=55${cel.replace(/\D/g,'')}`, '_blank');
                },
                exportarRota: () => {
                    const link = document.createElement("a");
                    link.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(Store.data.rotaAtiva));
                    link.download = `Rota_${new Date().toLocaleDateString('pt-BR')}.json`;
                    link.click();
                },
                // Helper para o checkbox "Alterada"
                toggleEditList: () => {
                    const box = document.getElementById('box-detalhes-alterada');
                    const list = document.getElementById('lista-produtos-edicao');
                    if(document.getElementById('check-alterada').checked) {
                        box.classList.remove('hidden');
                        // Preenche lista com itens padr√£o para edi√ß√£o
                        list.innerHTML = CONSTANTS.ITENS_BASE.map(item => `
                            <div class="flex justify-between items-center text-xs border-b border-amber-100 py-1">
                                <span>${item.nome}</span>
                                <div class="flex items-center gap-2">
                                    <button class="w-5 h-5 bg-slate-100 rounded hover:bg-slate-200">-</button>
                                    <span class="font-bold w-4 text-center">${item.qtd}</span>
                                    <button class="w-5 h-5 bg-slate-100 rounded hover:bg-slate-200">+</button>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        box.classList.add('hidden');
                    }
                }
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            Store.init();
            
            // Render Radios for Region
            document.getElementById('container-radio-regiao').innerHTML = CONSTANTS.REGIOES.map(r => `
                <label class="cursor-pointer">
                    <input type="radio" name="regiao" value="${r}" class="peer sr-only">
                    <div class="border rounded py-1.5 text-center text-slate-500 peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 transition-all font-bold hover:bg-slate-50">${r}</div>
                </label>
            `).join('');

            // Render Basket Options
            const selectCesta = document.getElementById('select-cesta');
            CONSTANTS.CESTAS.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt.value;
                el.innerText = `${opt.label} - ${Utils.formatMoeda(opt.price)}`;
                el.setAttribute('data-price', opt.price);
                selectCesta.appendChild(el);
            });

            // Listeners
            document.getElementById('check-alterada').addEventListener('change', App.controllers.toggleEditList);
            
            // Client Search Autocomplete
            document.getElementById('input-cliente').addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                const dd = document.getElementById('dropdown-clientes');
                if(val.length > 1) {
                    const matches = window.CLIENTES_DB.filter(c => c.nome.toLowerCase().includes(val)).slice(0, 10);
                    if(matches.length) {
                        dd.classList.remove('hidden');
                        dd.innerHTML = matches.map(c => `
                            <div class="p-2 hover:bg-slate-50 cursor-pointer border-b text-sm" onclick="selectClient('${c.nome}', '${c.bairro}', '${c.cidade}')">
                                <div class="font-bold text-slate-700">${c.nome}</div>
                                <div class="text-xs text-slate-500">${c.bairro || '-'}</div>
                            </div>
                        `).join('');
                    } else dd.classList.add('hidden');
                } else dd.classList.add('hidden');
            });

            // Global helper for onclick inside HTML string
            window.selectClient = (nome, bairro, cidade) => {
                document.getElementById('input-cliente').value = nome;
                if(bairro) document.getElementById('input-bairro').value = bairro;
                if(cidade) document.getElementById('input-cidade').value = cidade;
                document.getElementById('dropdown-clientes').classList.add('hidden');
            };

            App.ui.render();
        });
    </script>
</body>
</html>
