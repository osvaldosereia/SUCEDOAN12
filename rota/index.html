import React, { useState, useEffect, useMemo } from 'react';
import { 
  Phone, 
  MapPin, 
  MessageCircle, 
  Navigation, 
  CheckCircle, 
  XCircle, 
  Package, 
  List, 
  Settings, 
  Truck,
  DollarSign,
  Info,
  ChevronDown,
  ChevronUp
} from 'lucide-react';

// --- DADOS INICIAIS (Do seu JSON) ---
const initialData = [
  {
    "id": "1766675984779",
    "data": "2025-12-25T15:19:44.779Z",
    "cliente": {
      "id": "1766675932268",
      "nome": "Osvaldo sereia junior",
      "endereco": "Rua Alexandre de Barros, 440, Cond. Jardim Apoena, Ch√°cara dos Pinheiros",
      "cidade": "Cuiab√°",
      "telefone": "65984491018",
      "maps": "9W4X+GX - Jardim Nossa Sra. Aparecida, Cuiab√° - MT"
    },
    "rota": "Coxip√≥",
    "pagamento": {
      "metodo": "dinheiro",
      "status": "pendente"
    },
    "financeiro": {
      "subtotal": 170,
      "desconto": 5,
      "total": 165
    },
    "brinde": "Amaciante",
    "obs": "",
    "itens": [
      {
        "id": 1766675970140,
        "tipo": "Cesta Mini",
        "marca": "Koblenz",
        "preco": 170,
        "modo": "alterada",
        "conteudo": [
          "1 Arroz de 5kg", "1 A√ß√∫car Cristal de 2kg", "3 √ìleo de Soja de 900ml", "..."
        ]
      }
    ],
    "ordem": 0,
    "status_entrega": "pendente" // Adicionado para controle local
  },
  {
    "id": "1766691263531",
    "data": "2025-12-25T19:34:23.531Z",
    "cliente": {
      "id": "1766675932268",
      "nome": "Osvaldo sereia junior",
      "apelido": "Sereia",
      "telefone": "65984491018",
      "cidade": "Cuiab√°",
      "bairro": "Ch√°cara dos Pinheiros",
      "endereco": "Rua Alexandre de Barros, 440, Cond. Jardim Apoena",
      "desc_casa": "",
      "maps": "9W4X+GX - Jardim Nossa Sra. Aparecida, Cuiab√° - MT"
    },
    "rota": "VG",
    "pagamento": {
      "metodo": "cartao",
      "status": "pago"
    },
    "financeiro": {
      "subtotal": 220,
      "desconto": 15,
      "total": 205
    },
    "brinde": "Sabao Po",
    "obs": "",
    "itens": [
      {
        "id": 1766691248136,
        "tipo": "Cesta Pequena",
        "marca": "Koblenz",
        "preco": 220,
        "modo": "alterada",
        "identificacao": "45",
        "conteudo": ["2 Arroz de 5kg", "..."]
      }
    ],
    "ordem": 10,
    "status_entrega": "pendente"
  },
  {
    "id": "1766686037788",
    "data": "2025-12-25T18:07:17.788Z",
    "cliente": {
      "id": "1766675932268",
      "nome": "Osvaldo sereia junior",
      "endereco": "Rua Alexandre de Barros, 440, Cond. Jardim Apoena, Ch√°cara dos Pinheiros",
      "cidade": "Cuiab√°",
      "telefone": "65984491018",
      "maps": "9W4X+GX - Jardim Nossa Sra. Aparecida, Cuiab√° - MT"
    },
    "rota": "Coxip√≥",
    "pagamento": {
      "metodo": "dinheiro",
      "status": "pendente"
    },
    "financeiro": {
      "subtotal": 215,
      "desconto": 0,
      "total": 215
    },
    "brinde": "Amaciante",
    "obs": "casa azul",
    "itens": [
      {
        "id": 1766686022859,
        "tipo": "Cesta Pequena",
        "marca": "Tio Alvino",
        "preco": 215,
        "modo": "normal",
        "identificacao": null,
        "conteudo": ["2 Arroz de 5kg", "..."]
      }
    ],
    "ordem": 20,
    "status_entrega": "pendente"
  }
];

// Configura√ß√µes
const ADMIN_PHONE = "5565998150975";

export default function DeliveryApp() {
  const [orders, setOrders] = useState(initialData);
  const [activeRoutes, setActiveRoutes] = useState([]);
  const [showLoadList, setShowLoadList] = useState(false);
  const [showRouteFilter, setShowRouteFilter] = useState(false);
  
  // Modal de Confirma√ß√£o de Entrega
  const [deliveryModal, setDeliveryModal] = useState({ open: false, orderId: null, paymentMethod: '' });
  
  // Modal de Detalhes do Pedido
  const [detailsModal, setDetailsModal] = useState({ open: false, order: null });

  // Extrair rotas √∫nicas
  const availableRoutes = useMemo(() => {
    const routes = new Set(initialData.map(o => o.rota));
    return Array.from(routes);
  }, []);

  // Inicializar rotas ativas
  useEffect(() => {
    setActiveRoutes(availableRoutes);
  }, [availableRoutes]);

  // Filtrar e Ordenar Pedidos
  const displayedOrders = useMemo(() => {
    let filtered = orders.filter(o => activeRoutes.includes(o.rota));
    
    // Ordenar: Pendentes primeiro, depois entregues/cancelados
    // Mant√©m a ordem original dentro dos grupos
    return filtered.sort((a, b) => {
      const scoreA = a.status_entrega === 'pendente' ? 0 : 1;
      const scoreB = b.status_entrega === 'pendente' ? 0 : 1;
      return scoreA - scoreB || a.ordem - b.ordem;
    });
  }, [orders, activeRoutes]);

  // Estat√≠sticas
  const stats = useMemo(() => {
    const total = displayedOrders.length;
    const pending = displayedOrders.filter(o => o.status_entrega === 'pendente').length;
    return { total, pending, completed: total - pending };
  }, [displayedOrders]);

  // Lista de Carga (Resumo)
  const loadList = useMemo(() => {
    const list = {};
    orders.filter(o => activeRoutes.includes(o.rota) && o.status_entrega === 'pendente').forEach(order => {
      order.itens.forEach(item => {
        const key = `${item.tipo} - ${item.marca}`;
        list[key] = (list[key] || 0) + 1;
      });
    });
    return Object.entries(list);
  }, [orders, activeRoutes]);

  // --- A√á√ïES ---

  const handleWhatsApp = (phone, message) => {
    const cleanPhone = phone.replace(/\D/g, '');
    const finalPhone = cleanPhone.startsWith('55') ? cleanPhone : `55${cleanPhone}`;
    const url = `https://wa.me/${finalPhone}?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
  };

  const openMap = (address, mapsLink) => {
    if (mapsLink) {
        // Tenta usar o link do Google Maps se existir e for uma URL
        if(mapsLink.includes('http')) {
             window.open(mapsLink, '_blank');
        } else {
             // Se for texto (ex: c√≥digo plus), pesquisa
             window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(mapsLink)}`, '_blank');
        }
    } else {
      window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`, '_blank');
    }
  };

  const handleCancel = (order) => {
    if (!window.confirm("Confirmar cancelamento deste pedido?")) return;

    const newOrders = orders.map(o => 
      o.id === order.id ? { ...o, status_entrega: 'cancelado' } : o
    );
    setOrders(newOrders);

    // Notificar Admin
    const msg = `‚ö†Ô∏è *Pedido Cancelado*\nCliente: ${order.cliente.nome}\nRota: ${order.rota}\nMotivo: Entrega cancelada pelo entregador.`;
    handleWhatsApp(ADMIN_PHONE, msg);
  };

  const openDeliveryModal = (order) => {
    setDeliveryModal({ 
      open: true, 
      orderId: order.id, 
      paymentMethod: order.pagamento.metodo,
      currentOrder: order 
    });
  };

  const confirmDelivery = () => {
    const { orderId, paymentMethod, currentOrder } = deliveryModal;
    
    const newOrders = orders.map(o => 
      o.id === orderId ? { ...o, status_entrega: 'entregue', pagamento: { ...o.pagamento, metodo: paymentMethod, status: 'pago' } } : o
    );
    setOrders(newOrders);
    setDeliveryModal({ open: false, orderId: null, paymentMethod: '' });

    // Notificar Admin
    const msg = `‚úÖ *Entrega Realizada*\nCliente: ${currentOrder.cliente.nome}\nPagamento: ${paymentMethod.toUpperCase()}\nValor: R$ ${currentOrder.financeiro.total}`;
    handleWhatsApp(ADMIN_PHONE, msg);
  };

  const toggleRoute = (route) => {
    if (activeRoutes.includes(route)) {
      setActiveRoutes(activeRoutes.filter(r => r !== route));
    } else {
      setActiveRoutes([...activeRoutes, route]);
    }
  };

  // --- RENDERIZA√á√ÉO ---

  return (
    <div className="min-h-screen bg-gray-100 font-sans pb-20">
      
      {/* HEADER FIXO */}
      <header className="bg-blue-600 text-white sticky top-0 z-30 shadow-md">
        <div className="px-4 py-3 flex justify-between items-center">
          <div>
            <h1 className="text-xl font-bold flex items-center gap-2">
              <Truck size={24} /> Rota Entrega
            </h1>
            <p className="text-sm opacity-90">
              Restam <b>{stats.pending}</b> de {stats.total}
            </p>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => setShowRouteFilter(!showRouteFilter)}
              className={`p-2 rounded-lg ${showRouteFilter ? 'bg-blue-800' : 'bg-blue-500'}`}
            >
              <Settings size={20} />
            </button>
            <button 
              onClick={() => setShowLoadList(true)}
              className="p-2 bg-green-500 rounded-lg font-bold flex items-center gap-1"
            >
              <List size={20} /> Carga
            </button>
          </div>
        </div>

        {/* FILTRO DE ROTAS EXPANDIDO */}
        {showRouteFilter && (
          <div className="bg-blue-700 px-4 py-2 flex flex-wrap gap-2">
            <span className="text-xs text-blue-200 w-full">Toque para ativar/desativar rotas:</span>
            {availableRoutes.map(route => (
              <button
                key={route}
                onClick={() => toggleRoute(route)}
                className={`px-3 py-1 rounded-full text-sm font-semibold transition-colors ${
                  activeRoutes.includes(route) 
                    ? 'bg-white text-blue-700' 
                    : 'bg-blue-900 text-blue-300 border border-blue-500'
                }`}
              >
                {route}
              </button>
            ))}
          </div>
        )}
      </header>

      {/* LISTA DE PEDIDOS */}
      <main className="p-4 space-y-4">
        {displayedOrders.length === 0 && (
          <div className="text-center text-gray-500 py-10">
            Nenhum pedido nesta rota.
          </div>
        )}

        {displayedOrders.map((order) => {
          const isPending = order.status_entrega === 'pendente';
          const isCancelled = order.status_entrega === 'cancelado';
          
          return (
            <div 
              key={order.id} 
              className={`rounded-xl shadow-lg overflow-hidden border-2 ${
                isPending ? 'bg-white border-transparent' : 
                isCancelled ? 'bg-red-50 border-red-200 opacity-60' : 'bg-green-50 border-green-200 opacity-60'
              }`}
            >
              {/* CABE√áALHO DO CARD */}
              <div className="bg-gray-50 px-4 py-3 flex justify-between items-start border-b border-gray-100">
                <div>
                  <div className="flex items-center gap-2">
                    <h2 className="text-lg font-bold text-gray-800">{order.cliente.nome}</h2>
                    {order.cliente.apelido && <span className="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600">{order.cliente.apelido}</span>}
                  </div>
                  <span className="inline-block mt-1 text-xs font-bold px-2 py-1 bg-blue-100 text-blue-800 rounded">
                    {order.rota}
                  </span>
                </div>
                <div className="text-right">
                  <span className={`block font-bold text-lg ${order.pagamento.status === 'pago' ? 'text-green-600' : 'text-orange-600'}`}>
                    R$ {order.financeiro.total}
                  </span>
                  <span className="text-xs text-gray-500 uppercase">{order.pagamento.metodo}</span>
                </div>
              </div>

              {/* CORPO DO CARD */}
              <div className="p-4">
                <div className="mb-4">
                    <p className="text-gray-700 leading-snug flex items-start gap-2">
                        <MapPin className="text-red-500 shrink-0 mt-1" size={18} />
                        {order.cliente.endereco}
                    </p>
                    {order.obs && (
                        <p className="mt-2 text-sm bg-yellow-50 text-yellow-800 p-2 rounded border border-yellow-200 flex items-center gap-2">
                            <Info size={16} /> <b>Obs:</b> {order.obs}
                        </p>
                    )}
                </div>

                {/* BOT√ïES DE A√á√ÉO - APENAS SE PENDENTE */}
                {isPending && (
                  <div className="space-y-3">
                    
                    {/* A√á√ïES R√ÅPIDAS (ZAP + MAPA) */}
                    <div className="grid grid-cols-5 gap-2">
                        <button 
                            onClick={() => handleWhatsApp(order.cliente.telefone, `Ol√° ${order.cliente.nome}, entregador chegando com sua cesta!`)}
                            className="col-span-1 bg-green-100 text-green-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-green-200"
                        >
                            <Truck size={20} />
                            <span className="text-[10px] font-bold">Chegando</span>
                        </button>
                        <button 
                            onClick={() => handleWhatsApp(order.cliente.telefone, `Ol√° ${order.cliente.nome}, o entregador chegou! pode receber?`)}
                            className="col-span-1 bg-green-100 text-green-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-green-200"
                        >
                            <CheckCircle size={20} />
                            <span className="text-[10px] font-bold">Cheguei</span>
                        </button>
                         <button 
                            onClick={() => handleWhatsApp(order.cliente.telefone, "")}
                            className="col-span-1 bg-green-500 text-white py-2 rounded-lg flex flex-col items-center justify-center active:bg-green-600 shadow-sm"
                        >
                            <MessageCircle size={20} />
                            <span className="text-[10px] font-bold">Zap</span>
                        </button>
                        <a 
                            href={`tel:${order.cliente.telefone}`}
                            className="col-span-1 bg-gray-100 text-gray-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-gray-200"
                        >
                            <Phone size={20} />
                            <span className="text-[10px] font-bold">Ligar</span>
                        </a>
                        <button 
                            onClick={() => openMap(order.cliente.endereco, order.cliente.maps)}
                            className="col-span-1 bg-blue-100 text-blue-700 py-2 rounded-lg flex flex-col items-center justify-center active:bg-blue-200"
                        >
                            <Navigation size={20} />
                            <span className="text-[10px] font-bold">Mapa</span>
                        </button>
                    </div>

                    <div className="flex gap-2">
                        <button 
                            onClick={() => setDetailsModal({ open: true, order })}
                            className="flex-1 bg-indigo-50 text-indigo-700 py-3 rounded-lg font-semibold text-sm flex items-center justify-center gap-2 border border-indigo-100"
                        >
                            <Package size={18} /> Ver Detalhes
                        </button>
                    </div>

                    <hr className="border-gray-100 my-2" />

                    {/* A√á√ïES PRINCIPAIS (ENTREGUE / CANCELADO) */}
                    <div className="grid grid-cols-2 gap-3">
                        <button 
                            onClick={() => handleCancel(order)}
                            className="bg-red-50 text-red-600 py-4 rounded-lg font-bold text-lg border border-red-200 active:bg-red-100 flex items-center justify-center gap-2"
                        >
                            <XCircle size={24} /> Cancelar
                        </button>
                        <button 
                            onClick={() => openDeliveryModal(order)}
                            className="bg-green-600 text-white py-4 rounded-lg font-bold text-lg shadow-md active:bg-green-700 flex items-center justify-center gap-2"
                        >
                            <CheckCircle size={24} /> ENTREGUE
                        </button>
                    </div>
                  </div>
                )}

                {/* STATUS FINALIZADO */}
                {!isPending && (
                  <div className={`p-3 rounded-lg text-center font-bold flex items-center justify-center gap-2 ${isCancelled ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`}>
                    {isCancelled ? <XCircle /> : <CheckCircle />}
                    {isCancelled ? 'PEDIDO CANCELADO' : 'PEDIDO ENTREGUE'}
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </main>

      {/* --- MODAL LISTA DE CARGA --- */}
      {showLoadList && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center p-4">
          <div className="bg-white w-full max-w-md rounded-2xl p-6 relative">
             <button 
                onClick={() => setShowLoadList(false)}
                className="absolute top-4 right-4 text-gray-500 p-2"
            >
                <XCircle size={28} />
            </button>
            <h2 className="text-2xl font-bold mb-4 flex items-center gap-2 text-gray-800">
                <Package className="text-blue-600"/> Carga Necess√°ria
            </h2>
            <p className="text-gray-500 mb-4 text-sm">Itens para as rotas ativas ({activeRoutes.join(', ')}):</p>
            
            <div className="max-h-[60vh] overflow-y-auto space-y-2">
                {loadList.length === 0 ? (
                    <p>Tudo entregue ou sem pedidos!</p>
                ) : (
                    loadList.map(([name, count]) => (
                        <div key={name} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <span className="font-medium text-gray-700">{name}</span>
                            <span className="bg-blue-600 text-white font-bold px-3 py-1 rounded-full">{count}</span>
                        </div>
                    ))
                )}
            </div>
            <button 
                onClick={() => setShowLoadList(false)}
                className="w-full mt-6 bg-blue-600 text-white py-3 rounded-xl font-bold text-lg"
            >
                Fechar
            </button>
          </div>
        </div>
      )}

      {/* --- MODAL CONFIRMAR ENTREGA --- */}
      {deliveryModal.open && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div className="bg-white w-full max-w-sm rounded-2xl p-6">
            <h2 className="text-xl font-bold mb-4 text-center">Confirmar Pagamento</h2>
            <p className="text-center text-gray-600 mb-6">Como o cliente pagou?</p>
            
            <div className="space-y-3">
                {['dinheiro', 'cartao', 'pix'].map(method => (
                    <button
                        key={method}
                        onClick={() => setDeliveryModal(prev => ({ ...prev, paymentMethod: method }))}
                        className={`w-full py-3 px-4 rounded-xl border-2 flex items-center justify-between transition-all ${
                            deliveryModal.paymentMethod === method 
                            ? 'border-green-500 bg-green-50 text-green-700 font-bold' 
                            : 'border-gray-200 text-gray-600'
                        }`}
                    >
                        <span className="capitalize flex items-center gap-2">
                            {method === 'dinheiro' && <DollarSign size={20}/>}
                            {method === 'cartao' && <Settings size={20}/>}
                            {method === 'pix' && <ZapIcon />} 
                            {method}
                        </span>
                        {deliveryModal.paymentMethod === method && <CheckCircle size={20} />}
                    </button>
                ))}
            </div>

            <div className="grid grid-cols-2 gap-3 mt-6">
                <button 
                    onClick={() => setDeliveryModal({ open: false, orderId: null, paymentMethod: '' })}
                    className="py-3 rounded-xl font-bold text-gray-600 bg-gray-100"
                >
                    Voltar
                </button>
                <button 
                    onClick={confirmDelivery}
                    className="py-3 rounded-xl font-bold text-white bg-green-600 shadow-lg active:scale-95 transition-transform"
                >
                    Confirmar
                </button>
            </div>
          </div>
        </div>
      )}

       {/* --- MODAL DETALHES --- */}
       {detailsModal.open && detailsModal.order && (
        <div className="fixed inset-0 bg-black/80 z-50 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
          <div className="bg-white w-full max-w-md rounded-2xl p-6 relative max-h-[85vh] overflow-y-auto">
             <button 
                onClick={() => setDetailsModal({ open: false, order: null })}
                className="absolute top-4 right-4 text-gray-500 bg-gray-100 rounded-full p-1"
            >
                <XCircle size={24} />
            </button>
            
            <div className="mb-4">
                <span className="text-xs font-bold text-blue-600 uppercase tracking-wider">Pedido</span>
                <h2 className="text-2xl font-bold text-gray-800">
                    {detailsModal.order.itens[0]?.tipo || 'Cesta'}
                </h2>
                <p className="text-gray-500">{detailsModal.order.itens[0]?.marca}</p>
            </div>

            <div className="bg-gray-50 p-4 rounded-xl mb-4 border border-gray-100">
                <div className="flex justify-between mb-2">
                    <span className="text-gray-600">Subtotal</span>
                    <span className="font-semibold">R$ {detailsModal.order.financeiro.subtotal}</span>
                </div>
                <div className="flex justify-between mb-2 text-red-500">
                    <span className="">Desconto</span>
                    <span className="font-semibold">- R$ {detailsModal.order.financeiro.desconto}</span>
                </div>
                <div className="flex justify-between pt-2 border-t border-gray-200 text-lg font-bold text-gray-800">
                    <span>Total</span>
                    <span>R$ {detailsModal.order.financeiro.total}</span>
                </div>
            </div>

             <div className="mb-6">
                <h3 className="font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <List size={18} /> Itens da Cesta
                </h3>
                <ul className="text-sm text-gray-600 space-y-1 list-disc pl-5">
                    {detailsModal.order.itens[0]?.conteudo.map((item, idx) => {
                        // Limpa tags HTML b√°sicas se vierem do JSON
                        const cleanItem = item.replace(/<[^>]*>?/gm, '');
                        if (!cleanItem) return null;
                        return <li key={idx}>{cleanItem}</li>
                    })}
                </ul>
            </div>

            {detailsModal.order.brinde && (
                <div className="bg-purple-50 text-purple-800 p-3 rounded-lg font-bold text-center mb-6 border border-purple-100">
                    üéÅ Brinde: {detailsModal.order.brinde}
                </div>
            )}

            <button 
                onClick={() => setDetailsModal({ open: false, order: null })}
                className="w-full bg-gray-800 text-white py-3 rounded-xl font-bold"
            >
                Fechar
            </button>
          </div>
        </div>
      )}

    </div>
  );
}

// Icone Pix simples SVG
const ZapIcon = () => (
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-zap">
    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
  </svg>
);
