<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Cestas Dona Ant√¥nia | Log√≠stica</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            main: '#c2185b', // Rosa Dona Ant√¥nia
                            dark: '#8c1141',
                            light: '#fce4ec',
                            surface: '#fff1f2', // Superf√≠cie levemente rosada
                            accent: '#2e7d32', // Verde Carvalima
                            whatsapp: '#25D366'
                        }
                    },
                    screens: {
                        'xs': '480px',
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <style>
        /* Otimiza√ß√µes Mobile */
        body { -webkit-tap-highlight-color: transparent; }
        
        /* Tabela Profissional */
        .spreadsheet-container { 
            max-height: calc(100vh - 220px); /* Altura din√¢mica */
            overflow: auto; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.75rem;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .spreadsheet-table th { 
            background-color: #f8fafc; 
            color: #64748b;
            position: sticky; 
            top: 0; 
            z-index: 10; 
            white-space: nowrap; 
            font-size: 0.7rem; 
            padding: 12px; 
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            border-bottom: 1px solid #e2e8f0;
        }
        .spreadsheet-table td { 
            white-space: nowrap; 
            font-size: 0.85rem; 
            padding: 12px; 
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }
        
        /* Scrollbar Fina */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }

        /* Imagens */
        .mobile-house-photo { width: 100%; height: 200px; object-fit: cover; border-radius: 12px 12px 0 0; }
        
        /* Estados de Linha */
        .row-cancelled td { color: #94a3b8; text-decoration: line-through; background-color: #f8fafc; }
        .row-cancelled .no-strike { text-decoration: none; }
        .row-failed td { background-color: #fef2f2; color: #991b1b; } 
        
        /* Sidebar Transition */
        .sidebar-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans text-sm h-screen flex flex-col overflow-hidden">

    <!-- OVERLAY MOBILE (Backdrop) -->
    <div id="sidebar-overlay" onclick="App.toggleSidebar()" class="fixed inset-0 z-40 hidden sidebar-backdrop backdrop-blur-sm md:hidden"></div>

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 shadow-sm z-30 flex-none h-16">
        <div class="px-4 h-full flex justify-between items-center w-full">
            <div class="flex items-center gap-3">
                <!-- Bot√£o Hamburger (Mobile Only) -->
                <button onclick="App.toggleSidebar()" class="md:hidden text-gray-600 hover:text-brand-main focus:outline-none p-1 -ml-1">
                    <i class="fa-solid fa-bars text-xl"></i>
                </button>

                <div class="bg-brand-main text-white p-1.5 rounded-lg shadow-sm shrink-0 flex items-center justify-center w-8 h-8">
                    <i class="fa-solid fa-basket-shopping text-sm"></i>
                </div>
                <div class="leading-tight flex flex-col justify-center">
                    <h1 class="font-bold text-sm text-gray-800 tracking-tight">Super Cestas</h1>
                    <span class="text-[10px] text-brand-main font-semibold bg-brand-light px-1.5 py-0.5 rounded-md w-fit">Dona Ant√¥nia</span>
                </div>
            </div>
            
            <div class="flex items-center">
                <select id="userRole" onchange="App.switchRole(this.value)" class="bg-gray-50 border border-gray-200 text-gray-700 text-xs font-bold rounded-lg focus:ring-2 focus:ring-brand-main block py-2 px-3 shadow-sm outline-none transition-all hover:bg-gray-100">
                    <option value="admin">üëë Admin</option>
                    <optgroup label="Motoristas" id="driverSelectOptions"></optgroup>
                </select>
            </div>
        </div>
    </header>

    <!-- LAYOUT PRINCIPAL -->
    <div class="flex flex-1 overflow-hidden relative">
        
        <!-- SIDEBAR (H√≠brida: Drawer no Mobile / Fixa no Desktop) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-white border-r border-gray-200 transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:flex md:flex-col shadow-2xl md:shadow-none h-full">
            
            <!-- Mobile Header Inside Sidebar -->
            <div class="flex items-center justify-between p-4 border-b border-gray-100 md:hidden">
                <span class="font-bold text-gray-700 text-lg">Menu</span>
                <button onclick="App.toggleSidebar()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <nav class="p-4 space-y-1 flex-1 overflow-y-auto">
                <div class="mb-6">
                    <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Vis√£o Geral</p>
                    <button onclick="App.setTab('dashboard')" id="btn-dashboard" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-all text-gray-600 font-medium group">
                        <div class="w-8 h-8 rounded-md bg-gray-100 group-hover:bg-white flex items-center justify-center text-gray-500 group-hover:text-brand-main transition-colors shadow-sm"><i class="fa-solid fa-chart-pie"></i></div>
                        <span>Dashboard</span>
                    </button>
                </div>
                
                <div class="mb-6">
                    <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Operacional</p>
                    <button onclick="App.setTab('entregas')" id="btn-entregas" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-all text-gray-600 font-medium group mb-1">
                        <div class="w-8 h-8 rounded-md bg-gray-100 group-hover:bg-white flex items-center justify-center text-gray-500 group-hover:text-brand-main transition-colors shadow-sm"><i class="fa-solid fa-truck-ramp-box"></i></div>
                        <span>Entregas do M√™s</span>
                    </button>
                    <button onclick="App.setTab('funcionarios')" id="btn-funcionarios" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-brand-light hover:text-brand-dark flex items-center gap-3 transition-all text-gray-600 font-medium group">
                        <div class="w-8 h-8 rounded-md bg-gray-100 group-hover:bg-white flex items-center justify-center text-gray-500 group-hover:text-brand-main transition-colors shadow-sm"><i class="fa-solid fa-users"></i></div>
                        <span>Base Funcion√°rios</span>
                    </button>
                </div>

                <div>
                    <p class="px-3 text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-2">Sistema</p>
                    <button onclick="App.setTab('configuracoes')" id="btn-configuracoes" class="nav-btn w-full text-left px-3 py-3 rounded-lg hover:bg-gray-100 hover:text-gray-800 flex items-center gap-3 transition-all text-gray-600 font-medium group">
                        <div class="w-8 h-8 rounded-md bg-gray-100 group-hover:bg-white flex items-center justify-center text-gray-500 group-hover:text-gray-800 transition-colors shadow-sm"><i class="fa-solid fa-gears"></i></div>
                        <span>Configura√ß√µes</span>
                    </button>
                </div>
            </nav>
            
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <span class="text-xs text-gray-500 font-semibold">Sistema Online</span>
                </div>
                <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Zap Admin</label>
                <input type="tel" id="adminPhoneConfig" onchange="App.setAdminPhone(this.value)" class="w-full text-xs border border-gray-300 rounded-md p-2 focus:ring-1 focus:ring-brand-main outline-none" placeholder="Definir n√∫mero...">
            </div>
        </aside>

        <!-- AREA DE CONTEUDO -->
        <main class="flex-1 overflow-y-auto overflow-x-hidden bg-gray-50 p-4 md:p-6 w-full relative">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="hidden max-w-6xl mx-auto fade-in pb-10">
                <h2 class="text-xl font-bold text-gray-800 mb-6">Vis√£o Geral</h2>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6 mb-8">
                    <!-- KPI Cards com Design Refinado -->
                    <div class="bg-white p-4 rounded-xl shadow-soft border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-box text-4xl text-blue-600"></i></div>
                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Total</p>
                        <p class="text-2xl font-bold text-gray-800 mt-1" id="dashTotal">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-soft border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-clock text-4xl text-yellow-600"></i></div>
                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Pendentes</p>
                        <p class="text-2xl font-bold text-yellow-600 mt-1" id="dashPending">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-soft border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-check-circle text-4xl text-green-600"></i></div>
                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Entregues</p>
                        <p class="text-2xl font-bold text-green-600 mt-1" id="dashDone">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-soft border border-gray-100 relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-ban text-4xl text-red-600"></i></div>
                        <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Falhas</p>
                        <p class="text-2xl font-bold text-red-500 mt-1" id="dashCancelled">0</p>
                    </div>
                </div>
                
                <h3 class="text-sm font-bold text-gray-700 mb-4 uppercase tracking-wider text-[10px] text-gray-400">Progresso das Rotas</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="dashRoutesList"></div>
            </div>

            <!-- VIEW: ENTREGAS -->
            <div id="view-entregas" class="hidden h-full flex flex-col fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">Entregas do M√™s</h2>
                    <div class="grid grid-cols-2 gap-3 w-full md:w-auto">
                        <button onclick="App.generateReportCarvalima()" class="bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 px-4 py-2.5 rounded-lg shadow-sm text-xs font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">
                            <i class="fa-brands fa-whatsapp text-green-600 text-base"></i> Relat√≥rio
                        </button>
                        <button onclick="App.openModal('modalEntrega')" class="bg-brand-main hover:bg-brand-dark text-white px-4 py-2.5 rounded-lg shadow-md text-xs font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">
                            <i class="fa-solid fa-plus"></i> Lan√ßar Avulso
                        </button>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-t-xl border border-gray-200 flex flex-col md:flex-row gap-4 items-center text-xs shadow-sm">
                    <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 no-scrollbar">
                        <select id="filterRoute" onchange="App.renderDeliveriesTable()" class="border border-gray-300 rounded-lg p-2.5 bg-white text-gray-700 font-medium min-w-[130px] flex-1 outline-none focus:border-brand-main">
                            <option value="">Todas Rotas</option>
                        </select>
                        <select id="filterStatus" onchange="App.renderDeliveriesTable()" class="border border-gray-300 rounded-lg p-2.5 bg-white text-gray-700 font-medium min-w-[130px] flex-1 outline-none focus:border-brand-main">
                            <option value="">Todos Status</option>
                            <option value="pendente">Pendentes</option>
                            <option value="entregue">Entregues</option>
                            <option value="nao-entregue">Falhas</option>
                            <option value="cancelada">Suspensas</option>
                        </select>
                    </div>
                    <div class="relative w-full md:w-64 ml-auto">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="searchTable" onkeyup="App.renderDeliveriesTable()" placeholder="Buscar nome ou c√≥digo..." class="border border-gray-300 rounded-lg pl-9 p-2.5 w-full outline-none focus:border-brand-main focus:ring-1 focus:ring-brand-main transition-shadow">
                    </div>
                </div>

                <div class="spreadsheet-container flex-1 w-full">
                    <table class="w-full text-left border-collapse spreadsheet-table">
                        <thead>
                            <tr>
                                <th class="text-center w-12">#</th>
                                <th>C√≥d.</th>
                                <th>Nome</th>
                                <th>Rota</th>
                                <th class="text-center">Status</th>
                                <th>Data/Hora</th>
                                <th>Obs/Recebedor</th>
                                <th class="text-center">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyEntregas"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: BASE FUNCION√ÅRIOS -->
            <div id="view-funcionarios" class="hidden h-full flex flex-col fade-in">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold text-gray-800">Base de Funcion√°rios</h2>
                    <div class="grid grid-cols-2 gap-3 w-full md:w-auto">
                         <button onclick="App.openModal('modalImportFunc')" class="bg-white border border-gray-200 text-blue-600 hover:bg-blue-50 px-4 py-2.5 rounded-lg shadow-sm text-xs font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">
                            <i class="fa-solid fa-file-import"></i> Importar
                        </button>
                        <button onclick="App.openEmployeeModal()" class="bg-brand-main hover:bg-brand-dark text-white px-4 py-2.5 rounded-lg shadow-md text-xs font-bold flex items-center justify-center gap-2 active:scale-95 transition-all">
                            <i class="fa-solid fa-user-plus"></i> Novo Cadastro
                        </button>
                    </div>
                </div>
                
                <div class="bg-white p-4 rounded-t-xl border border-gray-200 flex items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-search text-gray-400 ml-1"></i>
                    <input type="text" id="searchFunc" onkeyup="App.renderEmployeesTable()" placeholder="Buscar funcion√°rio por nome, c√≥digo ou endere√ßo..." class="w-full text-sm outline-none bg-transparent p-1">
                </div>
                
                <div class="spreadsheet-container flex-1 w-full">
                    <table class="w-full text-left border-collapse spreadsheet-table">
                        <thead>
                            <tr>
                                <th class="w-12 text-center">Foto</th>
                                <th>C√≥d.</th>
                                <th>Nome</th>
                                <th>Endere√ßo</th>
                                <th>Celular</th>
                                <th>Vizinhos</th>
                                <th class="text-center w-24">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tableBodyFuncionarios"></tbody>
                    </table>
                </div>
            </div>

            <!-- VIEW: CONFIGURA√á√ïES -->
            <div id="view-configuracoes" class="hidden max-w-5xl mx-auto space-y-6 fade-in pb-10">
                <!-- ROTAS -->
                <div class="bg-white rounded-xl shadow-soft border border-gray-100 p-5">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2">
                        <h3 class="font-bold text-gray-700">üó∫Ô∏è Rotas de Entrega</h3>
                        <button onclick="App.openModal('modalRota')" class="text-brand-main bg-brand-light px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-brand-main hover:text-white transition-colors">+ Nova</button>
                    </div>
                    <div class="grid grid-cols-1 gap-3" id="gridRotas"></div>
                </div>

                <!-- MOTORISTAS -->
                <div class="bg-white rounded-xl shadow-soft border border-gray-100 p-5">
                    <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2">
                        <h3 class="font-bold text-gray-700">üöö Motoristas</h3>
                        <button onclick="App.openModal('modalMotorista')" class="text-brand-main bg-brand-light px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-brand-main hover:text-white transition-colors">+ Novo</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-xs uppercase text-gray-500 rounded-lg">
                                <tr><th class="px-4 py-2 rounded-l-lg">Nome</th><th class="px-4 py-2">Tel</th><th class="px-4 py-2 rounded-r-lg text-right"></th></tr>
                            </thead>
                            <tbody id="listMotoristas" class="divide-y divide-gray-50"></tbody>
                        </table>
                    </div>
                </div>

                <!-- DADOS -->
                <div class="bg-white rounded-xl shadow-soft border border-gray-100 p-5">
                    <h3 class="font-bold text-gray-700 mb-3">üíæ Opera√ß√µes de Dados</h3>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                        <p class="text-xs text-blue-800 mb-2 font-bold">Gerar Entregas do M√™s</p>
                        <p class="text-[10px] text-blue-600 mb-2">Cole os <strong>C√ìDIGOS</strong> dos funcion√°rios (JSON) para criar os pendentes na rota.</p>
                        <textarea id="jsonInputCodes" class="w-full border border-blue-200 p-2 text-xs h-20 rounded-lg font-mono bg-white focus:ring-1 focus:ring-blue-500 outline-none" placeholder='["1001", "1002"]'></textarea>
                        <button onclick="App.importByCodes()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold w-full shadow-sm active:scale-95 transition-transform">Processar C√≥digos</button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="App.exportData()" class="bg-gray-800 text-white px-4 py-3 rounded-lg text-xs font-bold flex items-center justify-center gap-2 shadow-md active:scale-95 transition-transform"><i class="fa-solid fa-download"></i> Backup</button>
                        <button onclick="if(confirm('RESETAR SISTEMA? Dados perdidos n√£o podem ser recuperados.')){localStorage.clear();location.reload();}" class="bg-red-50 text-red-600 border border-red-100 px-4 py-3 rounded-lg text-xs font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform">Resetar F√°brica</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: MOBILE (MOTORISTA) -->
            <div id="view-driver-mobile" class="hidden pb-24 fade-in">
                <div class="bg-brand-main text-white p-5 rounded-b-3xl shadow-lg mb-6 sticky top-0 z-40">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h2 class="font-bold text-xl" id="driverWelcome">Ol√°, Motorista</h2>
                            <p class="text-xs opacity-90 font-medium">Vamos √†s entregas!</p>
                        </div>
                        <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                            <i class="fa-solid fa-truck-fast text-xl"></i>
                        </div>
                    </div>
                    <div class="bg-white/10 p-1.5 rounded-xl border border-white/10 backdrop-blur-md">
                        <select id="driverRouteFilter" onchange="App.renderDriverView()" class="w-full bg-transparent text-white text-sm font-bold p-1 outline-none border-none cursor-pointer appearance-none text-center">
                            <!-- Rotas do motorista -->
                        </select>
                    </div>
                </div>
                
                <div id="driverDeliveriesList" class="px-4 space-y-5 max-w-lg mx-auto">
                    <!-- Cards Mobile -->
                </div>
            </div>

        </main>
    </div>

    <!-- MODAIS OTIMIZADOS PARA MOBILE -->
    
    <!-- Modal Cadastro Funcion√°rio -->
    <div id="modalFuncionario" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm transition-opacity">
        <form id="formFuncionario" onsubmit="App.saveEmployee(event)" class="bg-white w-full sm:w-full sm:max-w-lg flex flex-col h-[90vh] sm:h-auto sm:max-h-[90vh] rounded-t-2xl sm:rounded-2xl shadow-2xl animate-[fadeIn_0.3s_ease-out]">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-2xl shrink-0">
                <h3 class="text-lg font-bold text-gray-800">Funcion√°rio</h3>
                <button type="button" onclick="App.closeModal('modalFuncionario')" class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center text-gray-500 hover:bg-gray-100"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-5 overflow-y-auto custom-scrollbar space-y-4">
                <input type="hidden" name="id" id="empId"> 
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">C√≥digo</label><input type="text" name="codigo" id="empCodigo" required class="w-full border border-gray-300 rounded-lg p-3 text-sm outline-none focus:border-brand-main bg-gray-50 focus:bg-white transition-colors"></div>
                    <div class="col-span-2"><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Nome</label><input type="text" name="nome" id="empNome" required class="w-full border border-gray-300 rounded-lg p-3 text-sm outline-none focus:border-brand-main bg-gray-50 focus:bg-white transition-colors"></div>
                </div>
                <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Endere√ßo</label><input type="text" name="endereco" id="empEndereco" required class="w-full border border-gray-300 rounded-lg p-3 text-sm outline-none focus:border-brand-main bg-gray-50 focus:bg-white transition-colors"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Bairro</label><input type="text" name="bairro" id="empBairro" class="w-full border border-gray-300 rounded-lg p-3 text-sm outline-none focus:border-brand-main bg-gray-50 focus:bg-white transition-colors"></div>
                    <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Cidade</label><input type="text" name="cidade" id="empCidade" value="Cuiab√°" class="w-full border border-gray-300 rounded-lg p-3 text-sm outline-none focus:border-brand-main bg-gray-50 focus:bg-white transition-colors"></div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h4 class="text-xs font-bold text-brand-main uppercase mb-3 flex items-center gap-2"><i class="fa-brands fa-whatsapp text-green-500"></i> Contatos</h4>
                    <div class="mb-3"><label class="text-[10px] font-bold text-gray-400 block mb-1">CELULAR FUNCION√ÅRIO</label><input type="tel" name="tel1" id="empTel1" class="w-full border border-gray-300 rounded-lg p-2.5 text-sm bg-white focus:ring-1 focus:ring-brand-main outline-none" placeholder="(65) 9..."></div>
                    
                    <label class="text-[10px] font-bold text-gray-400 mt-2 block border-t border-gray-200 pt-2 mb-1">VIZINHO 1</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="empNomeViz1" class="w-full border rounded-lg p-2.5 text-sm bg-white outline-none focus:border-gray-400" placeholder="Nome">
                        <input type="tel" id="empTelViz1" class="w-full border rounded-lg p-2.5 text-sm bg-white outline-none focus:border-gray-400" placeholder="Zap">
                    </div>
                    
                    <label class="text-[10px] font-bold text-gray-400 mt-2 block border-t border-gray-200 pt-2 mb-1">VIZINHO 2</label>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="empNomeViz2" class="w-full border rounded-lg p-2.5 text-sm bg-white outline-none focus:border-gray-400" placeholder="Nome">
                        <input type="tel" id="empTelViz2" class="w-full border rounded-lg p-2.5 text-sm bg-white outline-none focus:border-gray-400" placeholder="Zap">
                    </div>
                </div>
                <div><label class="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Foto (Link)</label><input type="url" name="fotoCasa" id="empFoto" class="w-full border border-gray-300 rounded-lg p-3 text-sm outline-none focus:border-brand-main bg-gray-50 focus:bg-white transition-colors"></div>
            </div>
            <div class="p-4 border-t border-gray-100 bg-gray-50 rounded-b-2xl flex justify-end gap-3 shrink-0 pb-safe">
                <button type="button" onclick="App.closeModal('modalFuncionario')" class="px-5 py-3 rounded-xl border border-gray-300 text-gray-600 font-bold text-sm w-full sm:w-auto">Cancelar</button>
                <button type="submit" class="px-5 py-3 rounded-xl bg-brand-main text-white font-bold text-sm shadow w-full sm:w-auto">Salvar</button>
            </div>
        </form>
    </div>

    <!-- Outros Modais (Padronizados) -->
    <div id="modalImportFunc" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6"><h3 class="font-bold text-lg mb-4 text-brand-main">Importar JSON</h3><textarea id="jsonImportFunc" class="w-full border border-gray-300 p-3 text-xs h-40 rounded-lg font-mono bg-gray-50 mb-4 outline-none focus:ring-1 focus:ring-brand-main"></textarea><div class="flex justify-end gap-3"><button onclick="App.closeModal('modalImportFunc')" class="border px-4 py-2 rounded-lg text-sm font-bold text-gray-600">Cancelar</button><button onclick="App.importEmployees()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow">Importar</button></div></div></div>

    <div id="modalEntrega" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm"><form onsubmit="App.saveDelivery(event)" class="bg-white w-full sm:w-full sm:max-w-md flex flex-col h-auto max-h-[90vh] rounded-t-2xl sm:rounded-2xl shadow-xl"><div class="p-5 border-b border-gray-100"><h3 class="text-lg font-bold text-gray-800">Lan√ßar Entrega</h3></div><div class="p-6 overflow-y-auto"><div class="mb-5"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Buscar</label><select id="selectEmployeeDelivery" onchange="App.fillDeliveryForm(this.value)" class="w-full border p-3 rounded-lg text-sm bg-white outline-none focus:border-brand-main"></select></div><div class="grid grid-cols-4 gap-3 mb-4"><div class="col-span-1"><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">C√≥d.</label><input type="text" name="codigo" id="delCodigo" required class="w-full border p-2 rounded-lg bg-gray-100 text-gray-500" readonly></div><div class="col-span-3"><label class="block text-[10px] font-bold text-gray-400 uppercase mb-1">Nome</label><input type="text" name="nome" id="delNome" required class="w-full border p-2 rounded-lg bg-gray-100 text-gray-500" readonly></div></div><div class="mb-2"><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rota</label><select name="rotaId" id="selectRouteModal" class="w-full border p-3 rounded-lg text-sm bg-white outline-none focus:border-brand-main"></select></div></div><div class="p-5 border-t border-gray-100 flex justify-end gap-3 pb-safe"><button type="button" onclick="App.closeModal('modalEntrega')" class="px-4 py-2 border rounded-lg text-sm font-bold text-gray-600 w-full sm:w-auto">Cancelar</button><button type="submit" class="px-4 py-2 bg-brand-main text-white rounded-lg text-sm font-bold shadow w-full sm:w-auto">Lan√ßar</button></div></form></div>

    <div id="modalRota" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><form onsubmit="App.saveRoute(event)" class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6"><h3 class="font-bold text-lg mb-4 text-gray-800">Nova Rota</h3><input type="text" name="nome" placeholder="Nome" class="w-full border p-3 rounded-lg mb-3 text-sm focus:border-brand-main outline-none"><select name="motoristaId" id="selectDriverModal" class="w-full border p-3 rounded-lg mb-3 text-sm bg-white focus:border-brand-main outline-none"></select><input type="date" name="dataPrevisao" class="w-full border p-3 rounded-lg mb-6 text-sm focus:border-brand-main outline-none"><div class="flex justify-end gap-3"><button type="button" onclick="App.closeModal('modalRota')" class="border px-4 py-2 rounded-lg text-sm font-bold text-gray-600">Cancelar</button><button class="bg-brand-main text-white px-4 py-2 rounded-lg text-sm font-bold shadow">Salvar</button></div></form></div>
    
    <div id="modalMotorista" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm"><form onsubmit="App.saveDriver(event)" class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6"><h3 class="font-bold text-lg mb-4 text-gray-800">Novo Motorista</h3><input type="text" name="nome" placeholder="Nome" class="w-full border p-3 rounded-lg mb-3 text-sm focus:border-brand-main outline-none"><input type="tel" name="telefone" placeholder="Tel" class="w-full border p-3 rounded-lg mb-6 text-sm focus:border-brand-main outline-none"><div class="flex justify-end gap-3"><button type="button" onclick="App.closeModal('modalMotorista')" class="border px-4 py-2 rounded-lg text-sm font-bold text-gray-600">Cancelar</button><button class="bg-brand-main text-white px-4 py-2 rounded-lg text-sm font-bold shadow">Salvar</button></div></form></div>

    <!-- Modal Confirma√ß√£o (Entregador) -->
    <div id="modalConfirmMobile" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full sm:w-full sm:max-w-sm p-6 rounded-t-3xl sm:rounded-3xl shadow-2xl animate-[fadeIn_0.3s_ease-out]">
            <div class="text-center mb-5">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold text-gray-400 border-4 border-gray-200" id="statusIcon"><i class="fa-solid fa-question"></i></div>
                <h3 class="text-xl font-bold text-gray-800">Finalizar?</h3>
                <p class="text-sm text-gray-500 mt-1 truncate px-2">Func: <span id="confMobName" class="font-bold text-gray-800"></span></p>
            </div>
            
            <div class="flex p-1 bg-gray-100 rounded-xl mb-6">
                <button type="button" onclick="App.setDeliveryStatus('success')" id="tabSuccess" class="flex-1 py-3 rounded-lg text-sm font-bold text-green-700 bg-white shadow-sm transition-all"><i class="fa-solid fa-check mr-1"></i> Entregue</button>
                <button type="button" onclick="App.setDeliveryStatus('fail')" id="tabFail" class="flex-1 py-3 rounded-lg text-sm font-bold text-gray-500 hover:text-red-600 transition-all"><i class="fa-solid fa-xmark mr-1"></i> N√£o Entregue</button>
            </div>
            
            <div id="sectionSuccess" class="mb-6">
                <label class="block text-xs font-bold mb-2 text-green-700 uppercase">Quem recebeu?</label>
                <div class="flex gap-2"><input type="text" id="receiverNameInput" placeholder="Nome (Ex: Esposa, Porteiro)" class="flex-1 border border-gray-300 rounded-xl p-3 text-sm outline-none focus:border-green-500 focus:ring-1 focus:ring-green-500"><button type="button" onclick="App.fillReceiverSelf()" class="bg-gray-100 border border-gray-200 text-gray-600 text-xs px-4 py-2 rounded-xl font-bold active:bg-gray-200 whitespace-nowrap">O Pr√≥prio</button></div>
            </div>
            
            <div id="sectionFail" class="mb-6 hidden">
                <label class="block text-xs font-bold mb-2 text-red-600 uppercase">Qual o motivo?</label>
                <select id="failReasonInput" class="w-full border border-gray-300 rounded-xl p-3 text-sm outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 bg-white"><option value="Ningu√©m em casa">Ningu√©m em casa</option><option value="Mudou de endere√ßo">Mudou de endere√ßo</option><option value="Recusou recebimento">Recusou recebimento</option><option value="Endere√ßo n√£o localizado">Endere√ßo n√£o localizado</option><option value="Outro">Outro</option></select>
            </div>
            
            <div class="flex gap-3 pb-safe">
                <button onclick="document.getElementById('modalConfirmMobile').classList.add('hidden')" class="flex-1 py-3.5 border border-gray-300 rounded-xl text-gray-600 font-bold hover:bg-gray-50 transition-colors">Cancelar</button>
                <button onclick="App.confirmDeliveryMobile()" id="btnConfirmAction" class="flex-1 py-3.5 bg-brand-accent text-white rounded-xl font-bold hover:bg-green-700 shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">Confirmar</button>
            </div>
        </div>
    </div>

<script>
/**
 * SISTEMAS - Core Application Logic
 * Vers√£o 13.0 - Mobile Layout & Drawer Integration
 */
const App = {
    key: 'dona_antonia_db_v13',
    db: { employees: [], deliveries: [], routes: [], drivers: [], adminPhone: '' },
    currentUser: 'admin',
    currentTab: 'dashboard',
    tempId: null,
    tempName: null,
    currentDeliveryStatus: 'success',
    genericHouse: 'https://cdn-icons-png.flaticon.com/512/619/619032.png',

    init() {
        try {
            this.load();
            if (this.db.employees.length === 0) this.seedData();
            this.updateSelectors();
            if(this.db.adminPhone) document.getElementById('adminPhoneConfig').value = this.db.adminPhone;
            this.switchRole('admin');
        } catch (e) {
            console.error("Erro init:", e);
            localStorage.removeItem(this.key);
            location.reload();
        }
    },

    load() {
        const stored = localStorage.getItem(this.key);
        if (stored) {
            try { 
                const parsed = JSON.parse(stored);
                this.db = {
                    employees: parsed.employees || [],
                    deliveries: parsed.deliveries || [],
                    routes: parsed.routes || [],
                    drivers: parsed.drivers || [],
                    adminPhone: parsed.adminPhone || ''
                };
            } catch (e) { console.error("Erro load", e); }
        }
    },

    save() {
        localStorage.setItem(this.key, JSON.stringify(this.db));
        this.updateSelectors();
        if(this.currentUser === 'admin') this.setTab(this.currentTab);
        else this.renderDriverView();
    },

    seedData() {
        this.db.drivers = [ { id: 'd1', nome: 'Carlos (Sul)', telefone: '65999991111' }, { id: 'd2', nome: 'Marcos (Norte)', telefone: '65999992222' } ];
        this.db.routes = [ { id: 'r1', nome: 'Rota 01 - Pedra 90', motoristaId: 'd1', dataPrevisao: '2026-01-15' }, { id: 'r2', nome: 'Rota 02 - CPA', motoristaId: 'd2', dataPrevisao: '2026-01-16' } ];
        this.db.employees = [
            { id: 101, codigo: '1001', nome: 'Jo√£o da Silva', endereco: 'Rua 30, Qd 15, Casa 02', bairro: 'Pedra 90', cidade: 'Cuiab√°', tel1: '65992001001', nomeViz1: 'Dona Maria', telViz1: '65992002002', nomeViz2: '', telViz2: '', fotoCasa: this.genericHouse },
            { id: 102, codigo: '1002', nome: 'Maria Aparecida', endereco: 'Rua Pernambuco, 550', bairro: 'CPA 2', cidade: 'Cuiab√°', tel1: '65992003003', nomeViz1: 'Cl√°udia', telViz1: '65992004004', nomeViz2: '', telViz2: '', fotoCasa: this.genericHouse },
            { id: 103, codigo: '1003', nome: 'Pedro Henrique', endereco: 'Av. Brasil, 1200', bairro: 'Santa Rosa', cidade: 'Cuiab√°', tel1: '65992005005', nomeViz1: 'Portaria', telViz1: '65992005006', nomeViz2: '', telViz2: '', fotoCasa: this.genericHouse },
            { id: 104, codigo: '1004', nome: 'Ana Clara', endereco: 'Rua dos L√≠rios, 88', bairro: 'Tijucal', cidade: 'Cuiab√°', tel1: '65992006006', nomeViz1: 'S√¥nia', telViz1: '65992007007', nomeViz2: 'Bia', telViz2: '65992008008', fotoCasa: this.genericHouse },
            { id: 105, codigo: '1005', nome: 'Lucas Mendes', endereco: 'Rua C√¢ndido Mariano, 400', bairro: 'Centro', cidade: 'Cuiab√°', tel1: '65992009009', nomeViz1: '', telViz1: '', nomeViz2: '', telViz2: '', fotoCasa: this.genericHouse }
        ];
        this.db.deliveries = [
            { id: 1, employeeId: 101, codigo: '1001', nome: 'Jo√£o da Silva', rotaId: 'r1', status: 'pendente', entregueEm: null, recebidoPor: '' },
            { id: 2, employeeId: 102, codigo: '1002', nome: 'Maria Aparecida', rotaId: 'r2', status: 'entregue', entregueEm: '06/01/2026 09:30', recebidoPor: 'Pr√≥pria' },
            { id: 3, employeeId: 103, codigo: '1003', nome: 'Pedro Henrique', rotaId: 'r2', status: 'nao-entregue', entregueEm: '06/01/2026 10:15', recebidoPor: 'Ningu√©m em casa' },
            { id: 4, employeeId: 104, codigo: '1004', nome: 'Ana Clara', rotaId: 'r1', status: 'entregue', entregueEm: '06/01/2026 11:00', recebidoPor: 'Vizinha S√¥nia' },
            { id: 5, employeeId: 105, codigo: '1005', nome: 'Lucas Mendes', rotaId: 'r2', status: 'nao-entregue', entregueEm: '06/01/2026 13:45', recebidoPor: 'Mudou de endere√ßo' }
        ];
        this.save();
    },

    // --- NAVIGATION & SIDEBAR ---
    toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isOpen = !sidebar.classList.contains('-translate-x-full');
        
        if (isOpen) {
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            overlay.classList.remove('hidden');
        }
    },

    switchRole(role) { 
        this.currentUser = role;
        // Reset sidebar state on role change
        document.getElementById('sidebar').classList.add('-translate-x-full'); 
        document.getElementById('sidebar-overlay').classList.add('hidden');

        if(role === 'admin') {
            document.getElementById('view-driver-mobile').classList.add('hidden');
            this.setTab('dashboard');
        } else {
            document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden'));
            document.getElementById('view-driver-mobile').classList.remove('hidden');
            const d = this.db.drivers.find(x => x.id == role);
            document.getElementById('driverWelcome').innerText = `Ol√°, ${d ? d.nome.split(' ')[0] : ''}`;
            this.renderDriverView();
        } 
    },

    setTab(tab) {
        if(this.currentUser !== 'admin') return; 
        this.currentTab = tab;
        
        // Visual Active State for Sidebar Buttons
        document.querySelectorAll('.nav-btn').forEach(b => { 
            b.classList.remove('bg-brand-light', 'text-brand-dark'); 
            b.classList.add('text-gray-600'); 
            b.querySelector('div').classList.remove('bg-white', 'text-brand-main');
            b.querySelector('div').classList.add('bg-gray-100', 'text-gray-500');
        });
        
        const activeBtn = document.getElementById(`btn-${tab}`);
        if(activeBtn) {
            activeBtn.classList.remove('text-gray-600');
            activeBtn.classList.add('bg-brand-light', 'text-brand-dark');
            activeBtn.querySelector('div').classList.remove('bg-gray-100', 'text-gray-500');
            activeBtn.querySelector('div').classList.add('bg-white', 'text-brand-main');
        }

        // Close sidebar on mobile after selection
        if(window.innerWidth < 768) {
            this.toggleSidebar();
        }

        document.querySelectorAll('[id^="view-"]').forEach(e => e.classList.add('hidden')); 
        document.getElementById(`view-${tab}`).classList.remove('hidden');
        
        if(tab === 'dashboard') this.renderDashboard(); 
        if(tab === 'funcionarios') this.renderEmployeesTable(); 
        if(tab === 'entregas') this.renderDeliveriesTable(); 
        if(tab === 'configuracoes') { this.renderRoutesGrid(); this.renderDriversList(); }
    },

    // --- DATA LOGIC ---
    openEmployeeModal(id = null) {
        document.getElementById('empId').value = '';
        document.getElementById('formFuncionario').reset();
        if (id) {
            const emp = this.db.employees.find(e => e.id === id);
            if (emp) {
                document.getElementById('empId').value = emp.id;
                document.getElementById('empCodigo').value = emp.codigo;
                document.getElementById('empNome').value = emp.nome;
                document.getElementById('empEndereco').value = emp.endereco;
                document.getElementById('empBairro').value = emp.bairro;
                document.getElementById('empCidade').value = emp.cidade;
                document.getElementById('empTel1').value = emp.tel1;
                document.getElementById('empNomeViz1').value = emp.nomeViz1 || '';
                document.getElementById('empTelViz1').value = emp.telViz1 || '';
                document.getElementById('empNomeViz2').value = emp.nomeViz2 || '';
                document.getElementById('empTelViz2').value = emp.telViz2 || '';
                document.getElementById('empFoto').value = emp.fotoCasa;
            }
        }
        this.openModal('modalFuncionario');
    },

    saveEmployee(e) {
        e.preventDefault();
        const id = document.getElementById('empId').value;
        const empData = {
            codigo: document.getElementById('empCodigo').value,
            nome: document.getElementById('empNome').value,
            endereco: document.getElementById('empEndereco').value,
            bairro: document.getElementById('empBairro').value,
            cidade: document.getElementById('empCidade').value,
            tel1: document.getElementById('empTel1').value,
            nomeViz1: document.getElementById('empNomeViz1').value,
            telViz1: document.getElementById('empTelViz1').value,
            nomeViz2: document.getElementById('empNomeViz2').value,
            telViz2: document.getElementById('empTelViz2').value,
            fotoCasa: document.getElementById('empFoto').value
        };
        const numId = id ? parseInt(id) : Date.now();
        if (id) {
            const index = this.db.employees.findIndex(e => e.id == id);
            if (index !== -1) this.db.employees[index] = { ...this.db.employees[index], ...empData };
        } else {
            this.db.employees.push({ id: numId, ...empData });
        }
        this.save();
        this.closeModal('modalFuncionario');
        document.getElementById('formFuncionario').reset();
    },

    importEmployees() {
        const raw = document.getElementById('jsonImportFunc').value;
        if(!raw) return alert("Cole o JSON.");
        try {
            const list = JSON.parse(raw);
            let count = 0;
            list.forEach(emp => {
                if(!this.db.employees.find(e => e.codigo == emp.codigo)) {
                    this.db.employees.push({
                        id: Date.now() + Math.random(), codigo: emp.codigo, nome: emp.nome,
                        endereco: emp.endereco || '', bairro: emp.bairro || '', cidade: emp.cidade || 'Cuiab√°',
                        tel1: emp.tel1 || '', nomeViz1: emp.nomeViz1 || '', telViz1: emp.telViz1 || '', fotoCasa: emp.fotoCasa || this.genericHouse
                    });
                    count++;
                }
            });
            alert(`${count} importados!`);
            this.save();
            this.closeModal('modalImportFunc');
            this.renderEmployeesTable();
        } catch(e) { alert("Erro JSON: " + e.message); }
    },

    renderEmployeesTable() {
        const tbody = document.getElementById('tableBodyFuncionarios'); if(!tbody) return;
        tbody.innerHTML = '';
        const search = document.getElementById('searchFunc').value.toLowerCase();
        this.db.employees.filter(e => e.nome.toLowerCase().includes(search) || e.codigo.includes(search)).forEach(e => {
            const img = e.fotoCasa ? `<img src="${e.fotoCasa}" class="w-8 h-8 rounded-full object-cover border border-gray-200">` : '<div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center text-gray-400"><i class="fa-solid fa-home"></i></div>';
            const viz1 = e.nomeViz1 ? `<i class="fa-solid fa-user-group text-gray-400"></i> ${e.nomeViz1}` : '-';
            tbody.innerHTML += `
                <tr class="bg-white border-b hover:bg-gray-50 transition-colors">
                    <td class="text-center">${img}</td>
                    <td class="font-mono text-gray-600 font-bold">${e.codigo}</td>
                    <td class="font-bold text-gray-800">${e.nome}</td>
                    <td class="text-xs text-gray-600">${e.endereco}, ${e.bairro}</td>
                    <td class="text-xs text-gray-600 whitespace-nowrap"><i class="fa-brands fa-whatsapp text-green-500"></i> ${e.tel1}</td>
                    <td class="text-xs text-gray-500">${viz1}</td>
                    <td class="text-center flex justify-end gap-2">
                        <button onclick="App.openEmployeeModal(${e.id})" class="text-blue-500 bg-blue-50 p-2 rounded-lg"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="if(confirm('Excluir?')) { App.db.employees = App.db.employees.filter(x=>x.id!=${e.id}); App.save(); }" class="text-red-400 bg-red-50 p-2 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    },

    generateReportCarvalima() {
        const successes = this.db.deliveries.filter(d => d.status === 'entregue').length;
        const pending = this.db.deliveries.filter(d => d.status === 'pendente').length;
        const failures = this.db.deliveries.filter(d => d.status === 'nao-entregue');
        let report = `*RELAT√ìRIO DE ENTREGAS CARVALIMA* üì¶\n\n`;
        report += `‚úÖ *${successes}* Entregas conclu√≠das com √™xito.\n`;
        report += `‚ö†Ô∏è *${failures.length}* N√£o entregues.\n`;
        report += `‚è≥ *${pending}* Pendentes para os pr√≥ximos dias.\n\n`;
        if (failures.length > 0) {
            report += `*DETALHE DAS N√ÉO ENTREGUES:*\n`;
            failures.forEach(d => { report += `‚ùå (${d.codigo}) ${d.nome}\n   Motivo: ${d.recebidoPor || 'N√£o informado'}\n`; });
        }
        window.open(`https://wa.me/?text=${encodeURIComponent(report)}`, '_blank');
    },

    toggleDeliveryStatus(id) {
        const d = this.db.deliveries.find(x => x.id === id);
        if (d) {
            if (d.status === 'cancelada') d.status = 'pendente';
            else if(confirm("Suspender entrega?")) d.status = 'cancelada';
            this.save();
        }
    },

    renderDeliveriesTable() {
        const tbody = document.getElementById('tableBodyEntregas'); if(!tbody) return;
        tbody.innerHTML = '';
        const filterR = document.getElementById('filterRoute').value, filterS = document.getElementById('filterStatus').value, search = document.getElementById('searchTable').value.toLowerCase();
        this.db.deliveries.filter(d => {
            if (filterR && d.rotaId !== filterR) return false;
            if (filterS && d.status !== filterS) return false;
            if (search && !d.nome.toLowerCase().includes(search)) return false;
            return true;
        }).forEach(d => {
            const rName = this.db.routes.find(r=>r.id===d.rotaId)?.nome || '-';
            const isDone = d.status === 'entregue', isFail = d.status === 'nao-entregue', isCanc = d.status === 'cancelada';
            let badge = '';
            if (isDone) badge = '<span class="bg-green-100 text-green-700 font-bold text-[10px] px-2 py-1 rounded-full uppercase">Entregue</span>';
            else if (isFail) badge = '<span class="bg-red-100 text-red-700 font-bold text-[10px] px-2 py-1 rounded-full uppercase">Falhou</span>';
            else if (isCanc) badge = '<span class="bg-gray-100 text-gray-500 font-bold text-[10px] px-2 py-1 rounded-full uppercase">Suspensa</span>';
            else badge = '<span class="bg-yellow-100 text-yellow-700 font-bold text-[10px] px-2 py-1 rounded-full uppercase">Pendente</span>';
            const action = isCanc ? `<button onclick="App.toggleDeliveryStatus(${d.id})" class="text-green-500 bg-green-50 p-2 rounded-lg no-strike"><i class="fa-solid fa-rotate-left"></i></button>` : `<button onclick="App.toggleDeliveryStatus(${d.id})" class="text-gray-400 bg-gray-50 p-2 rounded-lg"><i class="fa-solid fa-ban"></i></button>`;
            const receivedInfo = isFail ? `<span class="text-red-600 font-bold"><i class="fa-solid fa-circle-exclamation"></i> ${d.recebidoPor}</span>` : (d.recebidoPor || '-');
            tbody.innerHTML += `
                <tr class="bg-white border-b hover:bg-gray-50 ${isCanc?'row-cancelled':''} ${isFail?'row-failed':''}">
                    <td class="text-center text-gray-300 font-mono text-[10px]">${d.id.toString().slice(-4)}</td>
                    <td class="font-mono font-bold text-gray-600">${d.codigo}</td>
                    <td class="font-bold text-gray-800">${d.nome}</td>
                    <td class="text-xs text-gray-500">${rName}</td>
                    <td class="text-center no-strike">${badge}</td>
                    <td class="text-xs text-gray-500">${d.entregueEm||'-'}</td>
                    <td class="text-xs text-gray-500">${receivedInfo}</td>
                    <td class="text-center flex justify-center gap-2 no-strike">
                        ${action}
                        <button onclick="App.db.deliveries=App.db.deliveries.filter(x=>x.id!=${d.id});App.save();" class="text-red-300 bg-red-50 p-2 rounded-lg"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    },

    fillDeliveryForm(empId) {
        if(!empId) return;
        const emp = this.db.employees.find(e => e.id == empId);
        if(emp) { document.getElementById('delCodigo').value = emp.codigo; document.getElementById('delNome').value = emp.nome; }
    },
    saveDelivery(e) {
        e.preventDefault();
        const f = e.target;
        const emp = this.db.employees.find(e => e.codigo == f.codigo.value);
        this.db.deliveries.push({ id: Date.now(), employeeId: emp ? emp.id : null, codigo: f.codigo.value, nome: f.nome.value, rotaId: f.rotaId.value, status: 'pendente', entregueEm: null, recebidoPor: '' });
        this.save(); this.closeModal('modalEntrega'); f.reset();
    },

    renderDriverView() {
        const container = document.getElementById('driverDeliveriesList'); if(!container) return;
        container.innerHTML = '';
        const routeFilter = document.getElementById('driverRouteFilter');
        const myRoutes = this.db.routes.filter(r => r.motoristaId == this.currentUser);
        if (routeFilter.innerHTML.trim() === '' || routeFilter.options.length !== Math.max(1, myRoutes.length)) {
            routeFilter.innerHTML = '';
            if (myRoutes.length > 0) myRoutes.forEach(r => routeFilter.innerHTML += `<option value="${r.id}" class="text-black">${r.nome}</option>`);
            else routeFilter.innerHTML = '<option value="" class="text-black">Sem Rotas</option>';
        }
        const selectedRouteId = routeFilter.value || (myRoutes[0] ? myRoutes[0].id : null);
        if (!selectedRouteId) { container.innerHTML = '<div class="text-center text-gray-400 mt-10 p-8 border-2 border-dashed border-gray-200 rounded-2xl bg-gray-50"><i class="fa-solid fa-clipboard-check text-4xl mb-3 text-gray-300"></i><br>Sem rota atribu√≠da.</div>'; return; }

        const deliveries = this.db.deliveries.filter(d => d.rotaId === selectedRouteId && d.status !== 'cancelada');
        deliveries.sort((a,b) => {
            if (a.status === 'pendente' && b.status !== 'pendente') return -1;
            if (a.status !== 'pendente' && b.status === 'pendente') return 1;
            return 0;
        });

        deliveries.forEach(d => {
            const emp = this.db.employees.find(e => e.codigo == d.codigo) || {};
            const isDone = d.status === 'entregue';
            const isFail = d.status === 'nao-entregue';
            const tel = emp.tel1 || '';
            const photoHTML = emp.fotoCasa ? `<img src="${emp.fotoCasa}" class="mobile-house-photo">` : `<div class="mobile-house-photo bg-gray-100 flex items-center justify-center text-gray-400"><i class="fa-solid fa-house-chimney text-5xl opacity-50"></i></div>`;
            
            let neighborsHTML = '';
            if((emp.nomeViz1 && emp.telViz1) || (emp.nomeViz2 && emp.telViz2)) {
                let list = '';
                if(emp.nomeViz1 && emp.telViz1) list += `<a href="https://wa.me/55${emp.telViz1.replace(/\D/g,'')}?text=${encodeURIComponent(`Ol√° ${emp.nomeViz1}, cesta do ${emp.nome} chegando!`)}" target="_blank" class="block bg-white border border-gray-200 p-3 rounded-lg mb-2 text-xs text-gray-700 font-medium hover:bg-gray-50 flex justify-between items-center shadow-sm"><span><i class="fa-solid fa-user-shield text-blue-400 mr-2"></i> ${emp.nomeViz1}</span><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ZAP</span></a>`;
                if(emp.nomeViz2 && emp.telViz2) list += `<a href="https://wa.me/55${emp.telViz2.replace(/\D/g,'')}?text=${encodeURIComponent(`Ol√° ${emp.nomeViz2}, cesta do ${emp.nome} chegando!`)}" target="_blank" class="block bg-white border border-gray-200 p-3 rounded-lg mb-2 text-xs text-gray-700 font-medium hover:bg-gray-50 flex justify-between items-center shadow-sm"><span><i class="fa-solid fa-user-shield text-blue-400 mr-2"></i> ${emp.nomeViz2}</span><span class="bg-green-100 text-green-700 px-2 py-1 rounded text-[10px] font-bold">ZAP</span></a>`;
                neighborsHTML = `<details class="neighbor-details mb-4"><summary class="bg-red-50 text-red-500 text-xs font-bold p-3 rounded-xl border border-red-100 cursor-pointer text-center hover:bg-red-100 select-none transition-colors"><i class="fa-solid fa-bullhorn mr-1"></i> SOCORRO! Ningu√©m atende?</summary><div class="mt-3 bg-gray-50 p-3 rounded-xl border border-gray-200 animate-[fadeIn_0.2s]"><p class="text-[10px] text-gray-400 mb-2 uppercase font-bold tracking-wider">Contatos de Emerg√™ncia:</p>${list}</div></details>`;
            }

            let footer = '';
            let cardStyle = '';
            
            if (isDone) {
                cardStyle = 'opacity-70 grayscale-[0.5] border-green-200';
                footer = `<div class="bg-green-50 p-4 rounded-xl border border-green-100 text-xs text-green-800 mt-2 flex flex-col gap-1"><div class="flex justify-between"><strong><i class="fa-regular fa-clock"></i> Entregue:</strong> <span>${d.entregueEm}</span></div><div class="flex justify-between border-t border-green-200 pt-1 mt-1"><strong><i class="fa-regular fa-user"></i> Recebido por:</strong> <span>${d.recebidoPor}</span></div></div>`;
            } else if (isFail) {
                cardStyle = 'opacity-90 border-red-200 bg-red-50';
                footer = `<div class="bg-red-100 p-4 rounded-xl border border-red-200 text-xs text-red-800 mt-2 flex flex-col gap-1"><div class="flex justify-between"><strong><i class="fa-regular fa-clock"></i> Tentativa:</strong> <span>${d.entregueEm}</span></div><div class="flex justify-between border-t border-red-200 pt-1 mt-1"><strong><i class="fa-solid fa-triangle-exclamation"></i> Motivo:</strong> <span class="font-bold">${d.recebidoPor}</span></div></div>`;
            } else {
                footer = `<div class="grid grid-cols-2 gap-3 mb-4"><a href="https://wa.me/55${tel.replace(/\D/g,'')}" target="_blank" class="bg-green-50 text-green-700 py-3 rounded-xl text-center text-xs font-bold border border-green-100 hover:bg-green-100 transition-colors flex flex-col items-center justify-center gap-1"><i class="fa-brands fa-whatsapp text-lg"></i> Mensagem</a><a href="tel:${tel}" class="bg-blue-50 text-blue-700 py-3 rounded-xl text-center text-xs font-bold border border-blue-100 hover:bg-blue-100 transition-colors flex flex-col items-center justify-center gap-1"><i class="fa-solid fa-phone text-lg"></i> Ligar</a></div>${neighborsHTML}<button onclick="App.openConfirmMobile('${d.id}', '${d.nome}')" class="w-full bg-brand-main text-white py-4 rounded-xl text-sm font-bold shadow-lg hover:bg-brand-dark transition-transform active:scale-95 flex items-center justify-center gap-2"><i class="fa-solid fa-box-open"></i> FINALIZAR ENTREGA</button>`;
            }

            container.innerHTML += `
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden ${cardStyle} transition-all">
                    ${!isDone && !isFail ? photoHTML : ''}
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <span class="bg-gray-100 text-gray-500 text-[10px] font-bold px-2 py-1 rounded-md uppercase tracking-wide">#${d.codigo}</span>
                                <h3 class="font-bold text-gray-800 text-xl leading-tight mt-1">${d.nome}</h3>
                            </div>
                            ${isDone ? '<i class="fa-solid fa-circle-check text-green-500 text-2xl"></i>' : (isFail ? '<i class="fa-solid fa-circle-xmark text-red-500 text-2xl"></i>' : '')}
                        </div>
                        <p class="text-sm text-gray-600 mb-2 flex items-start gap-2"><i class="fa-solid fa-location-dot text-red-400 mt-1"></i> <span>${emp.endereco || 'Endere√ßo n√£o cadastrado'}</span></p>
                        <p class="text-xs text-gray-400 mb-4 ml-6 font-medium uppercase tracking-wide">${emp.bairro || ''}</p>
                        ${footer}
                    </div>
                </div>`;
        });
    },

    setAdminPhone(val) { this.db.adminPhone = val.replace(/\D/g, ''); this.save(); },
    
    renderDashboard() {
        const total = this.db.deliveries.length;
        const done = this.db.deliveries.filter(d => d.status === 'entregue').length;
        const cancelled = this.db.deliveries.filter(d => d.status === 'cancelada').length;
        const failed = this.db.deliveries.filter(d => d.status === 'nao-entregue').length;
        const pending = total - done - cancelled - failed;
        document.getElementById('dashTotal').innerText = total; 
        document.getElementById('dashPending').innerText = pending; 
        document.getElementById('dashDone').innerText = done;
        document.getElementById('dashCancelled').innerText = failed;
        const list = document.getElementById('dashRoutesList'); 
        if(list) {
            list.innerHTML = '';
            this.db.routes.forEach(r => {
                const active = this.db.deliveries.filter(d => d.rotaId === r.id && d.status !== 'cancelada');
                const rd = active.filter(d => d.status === 'entregue').length;
                const pct = active.length ? Math.round((rd / active.length) * 100) : 0;
                list.innerHTML += `<div class="bg-white p-4 rounded-xl border border-gray-100 shadow-sm flex justify-between items-center"><div class="flex flex-col"><span class="font-bold text-sm text-gray-700">${r.nome}</span><span class="text-xs text-gray-400">Progresso</span></div><div class="flex items-center gap-2"><div class="w-16 h-2 bg-gray-100 rounded-full overflow-hidden"><div class="bg-brand-main h-full" style="width:${pct}%"></div></div><span class="font-bold text-brand-main text-sm">${pct}%</span></div></div>`;
            });
        }
    },

    renderRoutesGrid() { const g = document.getElementById('gridRotas'); if(g) { g.innerHTML = ''; this.db.routes.forEach(r => { g.innerHTML += `<div class="bg-gray-50 p-4 rounded-xl border border-gray-200 text-xs relative group"><div class="font-bold text-gray-700 text-sm mb-1">${r.nome}</div><span class="text-gray-500 bg-white px-2 py-1 rounded border border-gray-200 inline-block mb-2">Prev: ${r.dataPrevisao}</span><button onclick="if(confirm('Excluir rota?')) { App.db.routes=App.db.routes.filter(x=>x.id!='${r.id}');App.save(); }" class="absolute top-3 right-3 text-red-300 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash"></i></button></div>`}) } },
    renderDriversList() { const l = document.getElementById('listMotoristas'); if(l) { l.innerHTML = ''; this.db.drivers.forEach(d => { l.innerHTML += `<tr class="hover:bg-gray-50 transition-colors"><td class="px-3 py-2 font-medium text-gray-800">${d.nome}</td><td class="px-3 py-2 text-gray-500">${d.telefone}</td><td class="px-3 py-2 text-right"><button onclick="if(confirm('Excluir?')) { App.db.drivers=App.db.drivers.filter(x=>x.id!='${d.id}');App.save(); }" class="text-red-400 hover:text-red-600 bg-red-50 p-2 rounded-lg transition-colors"><i class="fa-solid fa-trash"></i></button></td></tr>`}) } },
    updateSelectors() {
        const opts = document.getElementById('driverSelectOptions'); if(opts) { opts.innerHTML = ''; this.db.drivers.forEach(d => opts.innerHTML += `<option value="${d.id}">üöö ${d.nome}</option>`); }
        const rSel = document.getElementById('selectRouteModal'); if(rSel) { rSel.innerHTML = ''; this.db.routes.forEach(r => rSel.innerHTML += `<option value="${r.id}">${r.nome}</option>`); }
        const drvSel = document.getElementById('selectDriverModal'); if(drvSel) { drvSel.innerHTML = ''; this.db.drivers.forEach(d => drvSel.innerHTML += `<option value="${d.id}">${d.nome}</option>`); }
        const empSel = document.getElementById('selectEmployeeDelivery'); if(empSel) { empSel.innerHTML = '<option value="">Selecione...</option>'; this.db.employees.forEach(e => empSel.innerHTML += `<option value="${e.id}">${e.nome} (${e.codigo})</option>`); }
        const rFilt = document.getElementById('filterRoute'); if(rFilt) { rFilt.innerHTML = '<option value="">Todas Rotas</option>'; this.db.routes.forEach(r => rFilt.innerHTML += `<option value="${r.id}">${r.nome}</option>`); }
    },

    openConfirmMobile(id,nome) { 
        this.tempId=id; this.tempName=nome; 
        this.setDeliveryStatus('success'); 
        document.getElementById('confMobName').innerText=nome; 
        document.getElementById('receiverNameInput').value=''; 
        document.getElementById('failReasonInput').value='Ningu√©m em casa';
        document.getElementById('modalConfirmMobile').classList.remove('hidden'); 
    },
    
    setDeliveryStatus(status) {
        this.currentDeliveryStatus = status;
        const tabSuccess = document.getElementById('tabSuccess'); const tabFail = document.getElementById('tabFail');
        const secSuccess = document.getElementById('sectionSuccess'); const secFail = document.getElementById('sectionFail');
        const btnConfirm = document.getElementById('btnConfirmAction'); const icon = document.getElementById('statusIcon');

        if(status === 'success') {
            tabSuccess.classList.replace('text-gray-500', 'text-green-700'); tabSuccess.classList.add('bg-white', 'shadow-sm');
            tabFail.classList.replace('text-red-600', 'text-gray-500'); tabFail.classList.remove('bg-white', 'shadow-sm');
            secSuccess.classList.remove('hidden'); secFail.classList.add('hidden');
            btnConfirm.innerText = 'Confirmar Entrega'; btnConfirm.className = 'flex-1 py-3.5 bg-brand-accent text-white rounded-xl font-bold hover:bg-green-700 shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2';
            icon.className = 'w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold text-green-600 border-4 border-green-200'; icon.innerHTML = '<i class="fa-solid fa-check"></i>';
        } else {
            tabFail.classList.replace('text-gray-500', 'text-red-600'); tabFail.classList.add('bg-white', 'shadow-sm');
            tabSuccess.classList.replace('text-green-700', 'text-gray-500'); tabSuccess.classList.remove('bg-white', 'shadow-sm');
            secSuccess.classList.add('hidden'); secFail.classList.remove('hidden');
            btnConfirm.innerText = 'Registrar Devolu√ß√£o'; btnConfirm.className = 'flex-1 py-3.5 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2';
            icon.className = 'w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl font-bold text-red-600 border-4 border-red-200'; icon.innerHTML = '<i class="fa-solid fa-xmark"></i>';
        }
    },

    fillReceiverSelf() { document.getElementById('receiverNameInput').value=this.tempName; },
    
    confirmDeliveryMobile() {
        if(!this.tempId) return; 
        const t = this.db.deliveries.find(d => d.id == this.tempId);
        if(!t) return;
        const timeStr = new Date().toLocaleString('pt-BR');
        if(this.currentDeliveryStatus === 'success') {
            const rec = document.getElementById('receiverNameInput').value.trim();
            if(!rec) return alert("Quem recebeu a cesta?");
            t.status = 'entregue'; t.recebidoPor = rec; t.entregueEm = timeStr;
            if(this.db.adminPhone) window.open(`https://wa.me/55${this.db.adminPhone}?text=${encodeURIComponent(`‚úÖ *ENTREGA REALIZADA*\n\nüì¶ Func: ${t.nome}\nüë§ Recebido por: ${rec}\n‚è∞ ${t.entregueEm}`)}`, '_blank');
        } else {
            const reason = document.getElementById('failReasonInput').value;
            t.status = 'nao-entregue'; t.recebidoPor = reason; t.entregueEm = timeStr;
            if(this.db.adminPhone) window.open(`https://wa.me/55${this.db.adminPhone}?text=${encodeURIComponent(`‚ö†Ô∏è *ENTREGA FALHOU*\n\nüì¶ Func: ${t.nome}\nüö´ Motivo: ${reason}\n‚è∞ ${t.entregueEm}`)}`, '_blank');
        }
        this.save();
        document.getElementById('modalConfirmMobile').classList.add('hidden'); 
        this.renderDriverView();
    },

    importByCodes() {
        const raw = document.getElementById('jsonInputCodes').value; if(!raw) return alert("Cole os c√≥digos JSON.");
        try {
            const codes = JSON.parse(raw); let count = 0;
            codes.forEach(code => {
                const emp = this.db.employees.find(e => e.codigo == code);
                if(emp) {
                    const exists = this.db.deliveries.find(d => d.codigo == code && d.status !== 'cancelada');
                    if(!exists) { this.db.deliveries.push({ id: Date.now() + Math.random(), employeeId: emp.id, codigo: emp.codigo, nome: emp.nome, rotaId: '', status: 'pendente', entregueEm: null, recebidoPor: '' }); count++; }
                }
            });
            alert(`${count} entregas geradas com sucesso!`); this.save();
        } catch(e) { alert("Erro JSON: " + e.message); }
    },
    exportData() { const blob = new Blob([JSON.stringify(this.db,null,2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); },

    saveRoute(e) { e.preventDefault(); this.db.routes.push({id:'r'+Date.now(),nome:e.target.nome.value,motoristaId:e.target.motoristaId.value,dataPrevisao:e.target.dataPrevisao.value}); this.save(); this.closeModal('modalRota'); e.target.reset(); },
    saveDriver(e) { e.preventDefault(); this.db.drivers.push({id:'d'+Date.now(),nome:e.target.nome.value,telefone:e.target.telefone.value}); this.save(); this.closeModal('modalMotorista'); e.target.reset(); },
    openModal(id) { document.getElementById(id).classList.remove('hidden'); }, closeModal(id) { document.getElementById(id).classList.add('hidden'); }
};

document.addEventListener('DOMContentLoaded', () => App.init());
</script>
</body>
</html>
