<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Or√ßamento - Super Cestas B√°sicas Dona Ant√¥nia</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* CSS Otimizado para Or√ßamentos */
        :root { --spacing: 0.5rem; --font-size: 0.9rem; --primary: #2b8a3e; }
        body { font-size: var(--font-size); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Layout Cabe√ßalho de Or√ßamento */
        .budget-header {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 20px;
            margin-bottom: 2rem;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 1rem;
            align-items: center;
        }
        .company-logo img { width: 100%; max-height: 120px; object-fit: contain; }
        .company-info h1 { margin: 0; font-size: 1.6rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .company-info p { margin: 0; font-size: 0.85rem; color: #555; line-height: 1.4; }
        .budget-meta { margin-top: 10px; font-weight: bold; background: #f0f0f0; padding: 5px 10px; border-radius: 4px; display: inline-block; }

        /* Tabela Limpa */
        table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
        td, th { padding: 0.5rem; vertical-align: middle; border-bottom: 1px solid #ddd; }
        thead th { background: #f9f9f9; color: #333; text-transform: uppercase; font-size: 0.8rem; border-top: 2px solid #333; }
        
        /* Inputs Compactos */
        input:not([type="checkbox"]) { 
            margin-bottom: 0; height: 2rem; font-size: 0.9rem; padding: 0 0.5rem; 
            border: 1px solid #ddd;
        }
        
        /* Utilit√°rios */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-bold { font-weight: bold; }
        .hidden { display: none !important; }
        
        /* Se√ß√£o de Totais e Termos */
        .budget-footer { margin-top: 2rem; display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem; }
        .terms-box { font-size: 0.75rem; color: #444; text-align: justify; border: 1px solid #eee; padding: 10px; background: #fffdf9; }
        .terms-box h4 { margin-bottom: 5px; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid #ddd; }
        .terms-box ul { padding-left: 1rem; margin: 0; }
        
        .totals-box { background: #f8f9fa; padding: 1rem; border-radius: 4px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; align-items: center; }
        .total-row.final { font-size: 1.3rem; color: var(--primary); border-top: 2px solid #ccc; padding-top: 0.5rem; margin-top: 0.5rem; font-weight: 800; }

        /* Controles de Tela (N√£o imprime) */
        .screen-controls { background: #333; color: white; padding: 0.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .screen-controls button { margin: 0; padding: 0.2rem 1rem; font-size: 0.8rem; width: auto; background: #555; border: none; }

        /* Impress√£o Profissional */
        @media print {
            .no-print, .screen-controls, #admin-panel, .admin-col { display: none !important; }
            body { background: white; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .container { max-width: 100%; width: 100%; margin: 0; padding: 0; }
            input { border: none !important; padding: 0 !important; background: transparent !important; }
            .budget-header { border-bottom: 2px solid #000; }
            .budget-footer { grid-template-columns: 1fr; gap: 1rem; page-break-inside: avoid; }
            .totals-box { border: 1px solid #000; background: none; }
        }
    </style>
</head>
<body>

    <!-- Faixa de Controle (Apenas Tela) -->
    <div class="screen-controls no-print">
        <div><strong>Sistema SFA v4.0</strong> - <span id="mode-badge">Modo Cliente</span></div>
        <div style="display: flex; gap: 10px;">
            <button onclick="App.toggleMode()" id="btn-mode">Acessar Admin</button>
            <button onclick="window.print()" style="background: var(--primary);">üñ®Ô∏è Imprimir Or√ßamento</button>
        </div>
    </div>

    <main class="container">
        
        <!-- Cabe√ßalho do Or√ßamento -->
        <header class="budget-header">
            <div class="company-logo">
                <!-- Caminho da logo conforme solicitado -->
                <img src="img/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" alt="Logo Dona Ant√¥nia" onerror="this.style.display='none'; document.querySelector('.company-logo').innerHTML = '<small>[Logo aqui]</small>'">
            </div>
            <div class="company-info">
                <h1>Super Cestas B√°sicas Dona Ant√¥nia</h1>
                <p>
                    <strong>CNPJ:</strong> 51.385.335.0001.06<br>
                    <strong>Endere√ßo:</strong> R. Trinta, 105 - Jardim Nossa Sra. Aparecida, Cuiab√° - MT, 78090-660<br>
                    <strong>Telefones:</strong> (65) 99681-3588 | 99815-0975
                </p>
                <div class="budget-meta">
                    OR√áAMENTO #<span id="budget-id"></span> &bull; DATA: <span id="current-date"></span>
                </div>
            </div>
        </header>

        <!-- Formul√°rio Admin (Escondido na impress√£o) -->
        <section id="admin-panel" class="hidden no-print" style="background: #f0f0f0; padding: 1rem; border: 1px dashed #999; margin-bottom: 1rem;">
            <strong>ADICIONAR ITEM:</strong>
            <div class="grid" style="grid-template-columns: 2fr 1fr 0.5fr 0.5fr 0.5fr 0.5fr auto;">
                <input type="text" id="new-name" placeholder="Produto">
                <input type="text" id="new-brand" placeholder="Marca">
                <input type="number" id="new-qty" placeholder="Qtd" value="1">
                <input type="number" id="new-cost" placeholder="Custo" step="0.01" oninput="App.calcNew('cost')">
                <input type="number" id="new-margin" placeholder="Mg %" step="0.1" oninput="App.calcNew('margin')">
                <input type="number" id="new-price" placeholder="Venda" step="0.01" oninput="App.calcNew('price')">
                <button onclick="App.add()" style="padding: 0 1rem;">+</button>
            </div>
        </section>

        <!-- Tabela de Itens -->
        <table class="budget-table">
            <thead>
                <tr>
                    <th>Descri√ß√£o do Produto</th>
                    <th class="w-brand">Marca</th>
                    <th class="text-center w-qty">Qtd</th>
                    <!-- Colunas Admin -->
                    <th class="text-right admin-col hidden">Custo Un.</th>
                    <th class="text-right admin-col hidden">Mg %</th>
                    <th class="text-right admin-col hidden">Venda Un.</th>
                    <th class="text-right admin-col hidden">Subtotal</th>
                    <th class="no-print admin-col hidden">Excluir</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- Renderizado via JS -->
            </tbody>
        </table>

        <!-- Rodap√© do Or√ßamento: Termos e Totais -->
        <footer class="budget-footer">
            
            <!-- Termos e Condi√ß√µes -->
            <div class="terms-box">
                <h4>Observa√ß√µes e Condi√ß√µes Gerais</h4>
                <p><strong>Validade da Proposta:</strong> 15 dias.</p>
                <p><strong>Condi√ß√£o de Pagamento:</strong> A combinar.</p>
                <p><strong>Prazo de Entrega:</strong> Entre 10 e 12 dias (Segunda a Domingo, das 7h √†s 21h).</p>
                <hr style="margin: 5px 0;">
                <p><strong>OBSERVA√á√ÉO IMPORTANTE:</strong> Todos os colaboradores ser√£o avisados 3x (3 dias antes da entrega, 1 dia antes e at√© 3 horas antes).</p>
                <p><em>Caso a entrega n√£o possa ser efetuada na casa do colaborador ou em vizinho por culpa do colaborador, a cesta ser√° entregue na central da Carvalima.</em></p>
            </div>

            <!-- Caixa de Totais -->
            <div class="totals-box">
                <div class="total-row">
                    <span>Subtotal Produtos:</span>
                    <strong id="subtotal-display">R$ 0,00</strong>
                </div>
                
                <div class="total-row">
                    <span>Taxa de Entrega:</span>
                    <!-- Input de Frete Edit√°vel (Admin) ou Texto (Cliente) -->
                    <div id="delivery-control">
                        <!-- Injetado via JS -->
                    </div>
                </div>

                <div class="total-row final">
                    <span>TOTAL GERAL:</span>
                    <span id="final-total-display">R$ 0,00</span>
                </div>

                <!-- Info de Lucro (Apenas Admin) -->
                <div class="admin-col hidden text-right" style="margin-top: 10px; font-size: 0.8rem; color: #2b8a3e;">
                    <span id="profit-info"></span>
                </div>
                
                <div class="no-print text-right" style="margin-top: 1rem;">
                    <button class="outline contrast" onclick="App.reset()" style="font-size: 0.7rem; padding: 2px 8px; width: auto;">Resetar Padr√£o</button>
                </div>
            </div>
        </footer>
    </main>

    <script>
        /**
         * SFA - Or√ßamento Profissional v4
         */
        const App = {
            KEY: 'carvalima_sfa_db_2026_v4', // Chave nova (v4) para incluir campo de frete
            PASS: '090479',
            state: {
                data: [],
                deliveryFee: 0, // Novo campo de estado
                isAdmin: false
            },

            INITIAL_DATA: [
                // ALIMENTOS
                { name: "A√áUCAR CRISTAL 2KG", brand: "BARRACOOL/DOCE DIA", qty: 2 },
                { name: "ARROZ TIPO1 5KG AGUILHINHA", brand: "TIO MIRO/CREMOSO/MASSON", qty: 2 },
                { name: "CAF√â 500 GR", brand: "CABOCLO/EVOLUTO", qty: 1 },
                { name: "CHARQUE TIPO 1 500GR", brand: "SIER", qty: 1 },
                { name: "FARINHA DE MANDIOCA 1 KG", brand: "SABOROSA", qty: 1 },
                { name: "FARINHA DE TRIGO 1KG", brand: "DALLLAS", qty: 2 },
                { name: "FEIJ√ÉO CARIOCA TP1 1KG", brand: "NOVO CALDO", qty: 4 },
                { name: "MACARR√ÉO ESPAGUETE 500GR", brand: "DALLLAS GREEN/STA FELICIDADE", qty: 4 },
                { name: "MOLHO DE TOMATE 340GR", brand: "TOMODORO", qty: 1 },
                { name: "√ìLEO DE SOJA 900ML", brand: "LIZA", qty: 4 },
                { name: "SAL REFINADO 1KG", brand: "BOM DE MESA", qty: 1 },
                // LIMPEZA
                { name: "CREME DENTAL 90GR", brand: "SORRISO/COLGATE", qty: 2 },
                { name: "ESPONJA DE A√áO 60GR", brand: "Q LUSTROS /ASSOLAN", qty: 2 },
                { name: "PAPEL HIG. PERFUMADO 4X30", brand: "MILLI BIANCO/ PALOMA", qty: 2 },
                { name: "SAB√ÉO BARRA GLICERINADO 5X200", brand: "OESTE/BARRA NOVA", qty: 1 },
                { name: "SAB√ÉO EM P√ì 800GR", brand: "ASSIM/AMACITEL /URCA", qty: 1 },
                { name: "SABONETE 90GR", brand: "KITE/VIDA/GIPSY", qty: 2 }
            ],

            init() {
                const now = new Date();
                document.getElementById('current-date').textContent = now.toLocaleDateString('pt-BR');
                document.getElementById('budget-id').textContent = Math.floor(now.getTime() / 100000).toString().slice(-4);
                this.load();
            },

            load() {
                const stored = localStorage.getItem(this.KEY);
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        // Verifica se √© o formato antigo (array) ou novo (objeto com deliveryFee)
                        if (Array.isArray(parsed)) {
                            this.state.data = parsed;
                            this.state.deliveryFee = 0;
                        } else {
                            this.state.data = parsed.data || [];
                            this.state.deliveryFee = parsed.deliveryFee || 0;
                        }
                    } catch(e) { this.seed(); }
                } else {
                    this.seed();
                }
                this.render();
            },

            seed() {
                this.state.data = this.INITIAL_DATA.map(item => ({
                    id: Date.now() + Math.random(),
                    name: item.name,
                    brand: item.brand,
                    qty: item.qty,
                    cost: 0, margin: 0, price: 0
                }));
                this.state.deliveryFee = 0;
                this.save();
            },

            save() {
                // Salva estado completo (dados + frete)
                const payload = {
                    data: this.state.data,
                    deliveryFee: this.state.deliveryFee
                };
                localStorage.setItem(this.KEY, JSON.stringify(payload));
                this.render();
            },

            // --- L√≥gica de Neg√≥cio ---

            add() {
                const name = document.getElementById('new-name').value;
                if (!name) return alert("Preencha o nome");
                
                const item = {
                    id: Date.now(),
                    name: name,
                    brand: document.getElementById('new-brand').value,
                    qty: parseFloat(document.getElementById('new-qty').value) || 1,
                    cost: parseFloat(document.getElementById('new-cost').value) || 0,
                    margin: parseFloat(document.getElementById('new-margin').value) || 0,
                    price: parseFloat(document.getElementById('new-price').value) || 0
                };
                this.state.data.push(item);
                
                // Limpar form
                ['new-name','new-brand','new-cost','new-margin','new-price'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('new-qty').value = '1';
                document.getElementById('new-name').focus();
                
                this.save();
            },

            update(id, field, value) {
                const item = this.state.data.find(i => i.id === id);
                if (!item) return;

                if (field === 'name') item.name = value;
                else if (field === 'brand') item.brand = value;
                else {
                    let val = parseFloat(value) || 0;
                    if (field === 'qty') item.qty = val;
                    else if (field === 'cost') { item.cost = val; item.price = item.cost * (1 + (item.margin/100)); }
                    else if (field === 'margin') { item.margin = val; item.price = item.cost * (1 + (item.margin/100)); }
                    else if (field === 'price') { item.price = val; if(item.cost>0) item.margin = ((item.price-item.cost)/item.cost)*100; }
                    
                    if(field !== 'qty') {
                        item.price = Math.round(item.price * 100) / 100;
                        item.margin = Math.round(item.margin * 10) / 10;
                    }
                }
                this.save();
            },

            updateDelivery(val) {
                this.state.deliveryFee = parseFloat(val) || 0;
                this.save(); // Salva e rerenderiza
            },

            delete(id) {
                if(confirm('Excluir item?')) {
                    this.state.data = this.state.data.filter(i => i.id !== id);
                    this.save();
                }
            },

            reset() {
                if(confirm('Restaurar lista original? Isso apaga custos e pre√ßos.')) {
                    this.seed();
                    this.render();
                }
            },

            // --- UI Helpers ---

            calcNew(source) {
                const c = parseFloat(document.getElementById('new-cost').value) || 0;
                const m = parseFloat(document.getElementById('new-margin').value) || 0;
                const p = parseFloat(document.getElementById('new-price').value) || 0;
                const pEl = document.getElementById('new-price');
                const mEl = document.getElementById('new-margin');

                if (source === 'cost' || source === 'margin') pEl.value = (c * (1 + (m/100))).toFixed(2);
                else if (source === 'price' && c > 0) mEl.value = (((p-c)/c)*100).toFixed(1);
            },

            toggleMode() {
                if(this.state.isAdmin) this.state.isAdmin = false;
                else if(prompt("Senha Admin:") === this.PASS) this.state.isAdmin = true;
                this.render();
            },

            fmt(val) { return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); },

            // --- Renderiza√ß√£o ---

            render() {
                const { data, isAdmin, deliveryFee } = this.state;
                
                // Visibilidade Admin
                document.getElementById('mode-badge').textContent = isAdmin ? "Modo ADMIN" : "Modo Cliente";
                document.getElementById('mode-badge').style.color = isAdmin ? "#ff6b6b" : "#51cf66";
                document.getElementById('admin-panel').classList.toggle('hidden', !isAdmin);
                document.querySelectorAll('.admin-col').forEach(e => e.classList.toggle('hidden', !isAdmin));

                // Tabela
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                let subtotal = 0;
                let totalCost = 0;

                data.forEach(item => {
                    const totalLine = item.qty * item.price;
                    subtotal += totalLine;
                    totalCost += (item.qty * item.cost);

                    const tr = document.createElement('tr');
                    
                    if (isAdmin) {
                        tr.innerHTML = `
                            <td><input type="text" value="${item.name}" onchange="App.update(${item.id}, 'name', this.value)"></td>
                            <td><input type="text" value="${item.brand}" onchange="App.update(${item.id}, 'brand', this.value)"></td>
                            <td><input type="number" value="${item.qty}" class="text-center" onchange="App.update(${item.id}, 'qty', this.value)"></td>
                            <td class="admin-col"><input type="number" value="${item.cost||''}" placeholder="0.00" class="text-right" step="0.01" onchange="App.update(${item.id}, 'cost', this.value)"></td>
                            <td class="admin-col"><input type="number" value="${item.margin||''}" placeholder="0" class="text-right" step="0.1" onchange="App.update(${item.id}, 'margin', this.value)"></td>
                            <td class="admin-col"><input type="number" value="${item.price||''}" placeholder="0.00" class="text-right" step="0.01" onchange="App.update(${item.id}, 'price', this.value)"></td>
                            <td class="text-right text-bold admin-col">${this.fmt(totalLine)}</td>
                            <td class="admin-col text-center"><button class="outline secondary" onclick="App.delete(${item.id})">üóëÔ∏è</button></td>
                        `;
                    } else {
                        // Cliente V√™
                        tr.innerHTML = `
                            <td>${item.name}</td>
                            <td>${item.brand}</td>
                            <td class="text-center">${item.qty}</td>
                        `;
                    }
                    tbody.appendChild(tr);
                });

                // Totais
                const finalTotal = subtotal + deliveryFee;

                document.getElementById('subtotal-display').textContent = this.fmt(subtotal);
                document.getElementById('final-total-display').textContent = this.fmt(finalTotal);

                // Controle de Frete (Input se admin, Texto se cliente)
                const deliveryDiv = document.getElementById('delivery-control');
                if (isAdmin) {
                    deliveryDiv.innerHTML = `<input type="number" value="${deliveryFee}" step="0.01" onchange="App.updateDelivery(this.value)" style="text-align:right; width: 120px; float:right;">`;
                } else {
                    deliveryDiv.innerHTML = `<strong class="text-right" style="display:block;">${this.fmt(deliveryFee)}</strong>`;
                }

                if (isAdmin) {
                    const profit = subtotal - totalCost; // Lucro sobre produtos (frete √© neutro ou lucro separado)
                    const mg = subtotal > 0 ? (profit/subtotal*100).toFixed(1) : 0;
                    document.getElementById('profit-info').innerHTML = `Lucro sobre produtos: ${this.fmt(profit)} (${mg}%)`;
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
