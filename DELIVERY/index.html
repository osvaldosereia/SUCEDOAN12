<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Logística Local-First v3.4</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ESTILOS EXTRAS -->
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .btn-primary {
            background-color: #1e293b;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #334155; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>

    <!-- 3. IMPORTMAP REACT -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Save, Truck, Package, ShoppingCart, Users, MapPin, 
          Printer, Share2, Download, Upload, Trash2, Plus, 
          Minus, CheckCircle, Search, Navigation, Edit2, 
          ArrowUp, ArrowDown, History, MessageCircle, XCircle,
          AlertTriangle, FileText, Banknote, List, Tag, Percent, 
          Calendar, Filter, Phone, Database, Clipboard
        } from 'lucide-react';

        const generateId = () => Math.random().toString(36).substr(2, 9);

        const generateClientCode = (existingClients) => {
           let code;
           let attempts = 0;
           do {
             code = Math.floor(1000 + Math.random() * 9000).toString();
             attempts++;
             if(attempts > 1000) break; 
           } while (existingClients.some(c => c.code === code));
           return code;
        };

        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });

          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);

          return [value, setValue];
        };

        const formatCurrency = (value) => {
          return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const formatDate = (dateString) => {
          if (!dateString) return '-';
          return new Date(dateString).toLocaleDateString('pt-BR');
        };

        const formatDateTime = (dateString) => {
          if (!dateString) return '-';
          return new Date(dateString).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' });
        };

        function App() {
          const [clients, setClients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [companyPhone, setCompanyPhone] = useStickyState('db_config_phone', '65998150975');
          
          const [viewMode, setViewMode] = useState('dashboard');
          const [driverData, setDriverData] = useState(null);
          
          // State global para edição de venda
          const [saleToEdit, setSaleToEdit] = useState(null);
          
          // Backup Type State
          const [backupType, setBackupType] = useState('all'); // all, clients, products

          useEffect(() => {
            const hash = window.location.hash;
            if (hash.startsWith('#driver=')) {
              try {
                const encoded = hash.replace('#driver=', '');
                const decoded = JSON.parse(atob(decodeURIComponent(encoded)));
                setDriverData(decoded);
                setViewMode('driver');
              } catch (e) {
                console.error("Link inválido");
              }
            }
          }, []);

          const handleBackup = () => {
            let data = { version: '3.4', exportedAt: new Date() };
            let filename = 'backup';

            if (backupType === 'all') {
                data = { ...data, clients, products, sales, companyPhone };
                filename = 'backup_completo';
            } else if (backupType === 'clients') {
                data = { ...data, clients };
                filename = 'backup_clientes';
            } else if (backupType === 'products') {
                data = { ...data, products };
                filename = 'backup_produtos';
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
          };

          const handleRestore = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const data = JSON.parse(event.target.result);
                const confirmMsg = "ATENÇÃO: A importação irá SOBRESCREVER os dados existentes do tipo importado. Continuar?";
                
                if (confirm(confirmMsg)) {
                  let msg = "Importado com sucesso:\n";
                  if (data.clients) { setClients(data.clients); msg += "- Clientes\n"; }
                  if (data.products) { setProducts(data.products); msg += "- Produtos\n"; }
                  if (data.sales) { setSales(data.sales); msg += "- Vendas\n"; }
                  if (data.companyPhone) setCompanyPhone(data.companyPhone);
                  alert(msg);
                }
              } catch (err) {
                alert("Erro ao ler backup.");
              }
            };
            reader.readAsText(file);
          };

          if (viewMode === 'driver') {
            return <DriverView data={driverData} onExit={() => {
              window.location.hash = '';
              setViewMode('dashboard');
            }} />;
          }

          return (
            <div className="h-screen flex flex-col bg-gray-100 text-gray-800 font-sans overflow-hidden text-sm">
              <header className="bg-slate-900 text-white p-2 flex justify-between items-center shadow-lg z-20 shrink-0 h-14 relative">
                <div className="flex items-center gap-2">
                  <div className="bg-yellow-500 text-slate-900 p-1 rounded font-bold">LOG</div>
                  <h1 className="font-bold tracking-wider text-sm md:text-base hidden sm:block">SISTEMA V3.4</h1>
                </div>
                <div className="flex gap-2 items-center">
                   <div className="flex items-center gap-1 bg-slate-800 p-1 rounded border border-slate-700">
                      <Phone size={12} className="text-gray-400"/>
                      <input 
                         className="bg-transparent text-xs text-white w-24 focus:outline-none"
                         value={companyPhone}
                         onChange={e => setCompanyPhone(e.target.value)}
                         title="Zap da Empresa para relatórios"
                      />
                   </div>
                  <label className="flex items-center gap-1 bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded cursor-pointer text-xs transition border border-slate-600">
                    <Upload size={14} /> <span className="hidden sm:inline">Importar</span>
                    <input type="file" className="hidden" accept=".json" onChange={handleRestore} />
                  </label>
                  
                  <div className="flex items-center bg-emerald-700 rounded border border-emerald-500 overflow-hidden">
                      <select 
                        className="bg-emerald-700 text-white text-xs p-1.5 outline-none font-bold cursor-pointer hover:bg-emerald-600"
                        value={backupType}
                        onChange={(e) => setBackupType(e.target.value)}
                        title="Tipo de Backup"
                      >
                          <option value="all">Exportar: Geral</option>
                          <option value="clients">Exportar: Clientes</option>
                          <option value="products">Exportar: Produtos</option>
                      </select>
                      <button onClick={handleBackup} className="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 text-xs transition font-bold border-l border-emerald-500 h-full flex items-center">
                        <Download size={14} />
                      </button>
                  </div>
                </div>
              </header>

              {/* 5 COLUMNS LAYOUT RESTORED */}
              <div className="flex-1 overflow-x-auto overflow-y-hidden">
                <div className="h-full grid grid-cols-5 divide-x divide-gray-300 min-w-[1400px]">
                  
                  <Column title="CADASTROS" icon={<Save size={16}/>}>
                    <RegistryPanel clients={clients} setClients={setClients} products={products} setProducts={setProducts} />
                  </Column>

                  <Column title="CAIXA / VENDA" icon={<ShoppingCart size={16}/>}>
                    <POSPanel 
                      clients={clients} 
                      products={products} 
                      setProducts={setProducts} 
                      sales={sales} 
                      setSales={setSales} 
                      saleToEdit={saleToEdit}
                      setSaleToEdit={setSaleToEdit}
                    />
                  </Column>

                  <Column title="EXPEDIÇÃO" icon={<Package size={16}/>}>
                    <ExpeditionPanel 
                      sales={sales} 
                      setSales={setSales} 
                      clients={clients} 
                      products={products} 
                      setProducts={setProducts}
                      onEditSale={(sale) => setSaleToEdit(sale)}
                    />
                  </Column>

                  <Column title="LOGÍSTICA" icon={<MapPin size={16}/>}>
                    <LogisticsPanel sales={sales} setSales={setSales} clients={clients} companyPhone={companyPhone} />
                  </Column>

                  <Column title="GESTÃO" icon={<Users size={16}/>}>
                    <CRMPanel sales={sales} clients={clients} products={products} />
                  </Column>

                </div>
              </div>
            </div>
          );
        }

        const Column = ({ title, icon, children }) => (
          <div className="bg-white flex flex-col min-w-0 h-full">
            <div className="bg-slate-100 p-2 border-b border-gray-200 font-bold flex items-center gap-2 text-slate-700 text-xs uppercase tracking-wide shadow-sm sticky top-0 z-10 shrink-0">
              {icon} {title}
            </div>
            <div className="flex-1 overflow-y-auto p-2 scrollbar-thin bg-white">
              {children}
            </div>
          </div>
        );

        // --- COMPONENTS ---

        function RegistryPanel({ clients, setClients, products, setProducts }) {
          const [tab, setTab] = useState('clients');
          const [editingClientId, setEditingClientId] = useState(null);
          const [editingProductId, setEditingProductId] = useState(null);
          const [searchClient, setSearchClient] = useState('');

          const [cForm, setCForm] = useState({ name: '', code: '', phone: '', address: '', city: 'CUIABÁ', district: '', region: 'CUIABÁ', mapLink: '', photoLink: '', obs: '' });
          // Default category updated to one of the new ones
          const [pForm, setPForm] = useState({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
          
          const [stockModal, setStockModal] = useState(null); 
          const [historyModal, setHistoryModal] = useState(null);

          const loadClientForEdit = (client) => {
            setCForm(client);
            setEditingClientId(client.id);
            setTab('clients');
          };

          const saveClient = () => {
            if (!cForm.name) return alert('Nome obrigatório');
            if (editingClientId) {
              setClients(clients.map(c => c.id === editingClientId ? { ...cForm, id: editingClientId, code: c.code || cForm.code } : c));
              setEditingClientId(null);
              alert('Cliente Atualizado!');
            } else {
              const newCode = generateClientCode(clients);
              setClients([...clients, { ...cForm, id: generateId(), code: newCode }]);
              alert(`Cliente Cadastrado! Código: ${newCode}`);
            }
            setCForm({ name: '', code: '', phone: '', address: '', city: 'CUIABÁ', district: '', region: 'CUIABÁ', mapLink: '', photoLink: '', obs: '' });
          };

          const deleteClient = (id) => {
            if(confirm("Tem certeza que deseja apagar este cliente?")) {
              setClients(clients.filter(c => c.id !== id));
            }
          };

          const loadProductForEdit = (product) => {
            setPForm(product);
            setEditingProductId(product.id);
            setTab('products');
          };

          const saveProduct = () => {
            if (!pForm.name) return alert('Nome obrigatório');
            if (editingProductId) {
              setProducts(products.map(p => p.id === editingProductId ? { ...pForm, id: editingProductId, stock: p.stock, stockHistory: p.stockHistory } : p));
              setEditingProductId(null);
              alert('Produto Atualizado!');
            } else {
              const newProd = { 
                ...pForm, 
                id: generateId(), 
                stockHistory: [{ date: new Date().toISOString(), type: 'INITIAL', qty: Number(pForm.stock) }] 
              };
              setProducts([...products, newProd]);
              alert('Produto Cadastrado!');
            }
            setPForm({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
          };

          const deleteProduct = (id) => {
            if(confirm("Tem certeza? Isso remove o produto de novas vendas.")) {
              setProducts(products.filter(p => p.id !== id));
            }
          };

          const handleStockMove = () => {
            if (!stockModal || stockModal.qty <= 0) return;
            const { product, type, qty } = stockModal;
            const updatedProducts = products.map(p => {
              if (p.id === product.id) {
                const newStock = type === 'IN' ? p.stock + qty : p.stock - qty;
                const newHistory = [...(p.stockHistory || []), { date: new Date().toISOString(), type, qty }];
                return { ...p, stock: newStock, stockHistory: newHistory };
              }
              return p;
            });
            setProducts(updatedProducts);
            setStockModal(null);
          };

          const filteredClients = clients
            .filter(c => c.name.toLowerCase().includes(searchClient.toLowerCase()) || (c.code && c.code.includes(searchClient)))
            .sort((a, b) => a.name.localeCompare(b.name));

          return (
            <div className="h-full flex flex-col gap-4 relative">
              <div className="flex bg-gray-200 p-1 rounded gap-1 shrink-0">
                <button onClick={() => setTab('clients')} className={`flex-1 py-1 text-xs font-bold rounded ${tab === 'clients' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>CLIENTES</button>
                <button onClick={() => setTab('products')} className={`flex-1 py-1 text-xs font-bold rounded ${tab === 'products' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>PRODUTOS</button>
              </div>

              {tab === 'clients' ? (
                <div className="flex-1 overflow-y-auto space-y-2 animate-in">
                  <div className={`p-2 rounded border space-y-2 ${editingClientId ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}`}>
                    {editingClientId && <div className="text-xs font-bold text-yellow-700 uppercase mb-1">Editando Cliente</div>}
                    <div className="flex gap-1">
                        <input className="input-field w-3/4" placeholder="Nome do Cliente" value={cForm.name} onChange={e => setCForm({...cForm, name: e.target.value})} />
                        {editingClientId && <input className="input-field w-1/4 bg-gray-100" placeholder="Cód" value={cForm.code} disabled />}
                    </div>
                    <input className="input-field" placeholder="WhatsApp (apenas números)" value={cForm.phone} onChange={e => setCForm({...cForm, phone: e.target.value})} />
                    <input className="input-field" placeholder="Endereço Completo" value={cForm.address} onChange={e => setCForm({...cForm, address: e.target.value})} />
                    <div className="flex gap-1">
                       <input className="input-field w-1/2" placeholder="Bairro" value={cForm.district} onChange={e => setCForm({...cForm, district: e.target.value})} />
                       <select className="input-field w-1/2" value={cForm.city} onChange={e => setCForm({...cForm, city: e.target.value})}>
                         <option value="CUIABÁ">Cuiabá</option>
                         <option value="VARZEA GRANDE">Várzea Grande</option>
                       </select>
                    </div>
                    <div className="flex gap-1">
                       <select className="input-field w-1/3" value={cForm.region} onChange={e => setCForm({...cForm, region: e.target.value})}>
                          <option value="CUIABÁ">CUIABÁ (Centro/Geral)</option>
                          <option value="COXIPO">COXIPO</option>
                          <option value="VARZEA GRANDE">VARZEA GRANDE</option>
                          <option value="CPA">CPA</option>
                       </select>
                       <input className="input-field w-2/3" placeholder="Link Maps" value={cForm.mapLink} onChange={e => setCForm({...cForm, mapLink: e.target.value})} />
                    </div>
                    <input className="input-field" placeholder="Observação (Ex: Casa de Esquina, Cuidado Cão)" value={cForm.obs} onChange={e => setCForm({...cForm, obs: e.target.value})} />
                    
                    <div className="flex gap-2">
                      {editingClientId && <button onClick={() => {setEditingClientId(null); setCForm({ name: '', code: '', phone: '', address: '', city: 'CUIABÁ', district: '', region: 'CUIABÁ', mapLink: '', photoLink: '', obs: '' })}} className="w-1/3 bg-gray-400 text-white rounded text-xs font-bold">CANCELAR</button>}
                      <button onClick={saveClient} className="btn-primary flex-1">{editingClientId ? 'SALVAR ALTERAÇÕES' : 'CADASTRAR'}</button>
                    </div>
                  </div>
                  
                  <div className="mt-4">
                    <div className="flex justify-between items-center mb-2 border-b pb-1 sticky top-0 bg-gray-100 z-10">
                        <h3 className="font-bold text-xs text-gray-500">BASE ({filteredClients.length})</h3>
                        <input className="text-xs p-1 border rounded w-1/2" placeholder="Buscar..." value={searchClient} onChange={e => setSearchClient(e.target.value)}/>
                    </div>
                    <div>
                        {filteredClients.map(c => (
                          <div key={c.id} className="text-xs p-2 border-b bg-white mb-1 rounded hover:bg-gray-50 flex justify-between items-center group shadow-sm">
                            <div className="truncate flex-1">
                               <div className="font-bold flex items-center gap-1">
                                    <span className="bg-slate-200 text-slate-700 px-1 rounded text-[10px]">{c.code}</span>
                                    {c.name}
                               </div>
                               <div className="text-gray-500">{c.district} • Reg: {c.region}</div>
                            </div>
                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                               <button onClick={() => loadClientForEdit(c)} className="text-blue-400 hover:text-blue-600"><Edit2 size={14}/></button>
                               <button onClick={() => deleteClient(c.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button>
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="flex-1 overflow-y-auto space-y-2 animate-in">
                  <div className={`p-2 rounded border space-y-2 ${editingProductId ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}`}>
                    {editingProductId && <div className="text-xs font-bold text-yellow-700 uppercase mb-1">Editando Produto</div>}
                    <input className="input-field" placeholder="Nome do Produto" value={pForm.name} onChange={e => setPForm({...pForm, name: e.target.value})} />
                    <div className="flex gap-1">
                        <input className="input-field w-1/2" placeholder="Cód. Interno" value={pForm.internalCode} onChange={e => setPForm({...pForm, internalCode: e.target.value})} />
                        <input className="input-field w-1/2" placeholder="Cód. Barras" value={pForm.barcode} onChange={e => setPForm({...pForm, barcode: e.target.value})} />
                    </div>
                    <div className="flex gap-1">
                       <select className="input-field w-1/2" value={pForm.category} onChange={e => setPForm({...pForm, category: e.target.value})}>
                          <option value="CESTAS BÁSICAS">CESTAS BÁSICAS</option>
                          <option value="ALIMENTOS">ALIMENTOS</option>
                          <option value="LIMPEZA">LIMPEZA</option>
                          <option value="HIGIENE">HIGIENE</option>
                       </select>
                       <input className="input-field w-1/2" placeholder="NCM" value={pForm.ncm} onChange={e => setPForm({...pForm, ncm: e.target.value})} />
                    </div>
                    <div className="flex gap-1">
                       <div className="w-1/2"><label className="text-[10px] font-bold text-gray-500">CUSTO</label><input className="input-field" type="number" value={pForm.cost} onChange={e => setPForm({...pForm, cost: e.target.value})} /></div>
                       <div className="w-1/2"><label className="text-[10px] font-bold text-gray-500">VENDA</label><input className="input-field font-bold text-green-700" type="number" value={pForm.price} onChange={e => setPForm({...pForm, price: e.target.value})} /></div>
                    </div>
                    {!pForm.isCombo && !editingProductId && (
                      <div className="bg-white p-2 rounded border border-gray-200">
                         <label className="text-[10px] font-bold text-blue-800">ESTOQUE INICIAL</label>
                         <input className="input-field" type="number" value={pForm.stock} onChange={e => setPForm({...pForm, stock: Number(e.target.value)})} />
                      </div>
                    )}
                    <div className="flex items-center gap-2 mt-2">
                      <input type="checkbox" id="isCombo" checked={pForm.isCombo} onChange={e => setPForm({...pForm, isCombo: e.target.checked})} />
                      <label htmlFor="isCombo" className="text-xs font-bold">É um Combo?</label>
                    </div>
                    {pForm.isCombo && (
                      <div className="bg-yellow-50 p-2 border border-yellow-200 rounded text-xs space-y-2">
                        <p className="font-bold text-yellow-800">Composição:</p>
                        <div className="max-h-32 overflow-y-auto">
                          {products.filter(p => !p.isCombo).map(p => (
                            <div key={p.id} className="flex justify-between items-center py-1 border-b border-yellow-100">
                              <span>{p.name}</span>
                              <input type="number" className="w-12 border rounded text-center text-xs" placeholder="0"
                                onChange={(e) => {
                                   const qty = Number(e.target.value);
                                   const existing = pForm.comboItems.filter(i => i.id !== p.id);
                                   if (qty > 0) setPForm({...pForm, comboItems: [...existing, {id: p.id, qty}]});
                                   else setPForm({...pForm, comboItems: existing});
                                }}
                              />
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    <div className="flex gap-2">
                      {editingProductId && <button onClick={() => {setEditingProductId(null); setPForm({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] })}} className="w-1/3 bg-gray-400 text-white rounded text-xs font-bold">CANCELAR</button>}
                      <button onClick={saveProduct} className="btn-primary flex-1">{editingProductId ? 'SALVAR ALTERAÇÕES' : 'CADASTRAR'}</button>
                    </div>
                  </div>

                  <div className="mt-6">
                    <h3 className="font-bold text-xs text-gray-500 mb-2 border-b">ESTOQUE</h3>
                    {products.map(p => (
                      <div key={p.id} className="flex justify-between items-center text-xs py-2 border-b group hover:bg-gray-50 px-1 bg-white mb-1 rounded shadow-sm">
                        <div className="flex-1 cursor-pointer" onClick={() => setHistoryModal(p)}>
                          <div className="font-bold flex items-center gap-1">{p.name} {p.isCombo && <span className="bg-yellow-100 text-yellow-800 text-[9px] px-1 rounded">KIT</span>}</div>
                          <div className="text-[10px] text-gray-500 flex items-center gap-1">Est: {p.stock} • {formatCurrency(p.price)}</div>
                        </div>
                        <div className="flex items-center gap-2">
                            {!p.isCombo && (
                              <div className="flex bg-gray-100 rounded border border-gray-300">
                                <button onClick={() => setStockModal({product: p, type: 'IN', qty: 0})} className="text-green-700 p-1 hover:bg-green-200 rounded-l transition"><Plus size={14}/></button>
                                <div className="w-px bg-gray-300"></div>
                                <button onClick={() => setStockModal({product: p, type: 'OUT', qty: 0})} className="text-red-700 p-1 hover:bg-red-200 rounded-r transition"><Minus size={14}/></button>
                              </div>
                            )}
                            <button onClick={() => loadProductForEdit(p)} className="text-blue-400 hover:text-blue-600 opacity-0 group-hover:opacity-100"><Edit2 size={14}/></button>
                            <button onClick={() => deleteProduct(p.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 size={14}/></button>
                        </div>
                      </div>
                    ))}
                  </div>

                  {stockModal && (
                    <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center p-4">
                      <div className="bg-white w-full rounded-lg shadow-xl p-4 flex flex-col gap-3">
                          <h3 className="font-bold text-center text-gray-800">Movimentação: {stockModal.product.name}</h3>
                          <div className={`text-sm font-bold text-center ${stockModal.type === 'IN' ? 'text-green-600' : 'text-red-600'}`}>
                            {stockModal.type === 'IN' ? 'ENTRADA DE ESTOQUE' : 'SAÍDA DE ESTOQUE'}
                          </div>
                          <input autoFocus type="number" className="text-3xl text-center w-full border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none py-2" 
                            value={stockModal.qty || ''} placeholder="0" onChange={e => setStockModal({...stockModal, qty: Number(e.target.value)})}
                          />
                          <div className="flex gap-2 w-full mt-2">
                            <button onClick={() => setStockModal(null)} className="flex-1 bg-gray-200 py-2 rounded text-sm font-bold text-gray-600">Cancelar</button>
                            <button onClick={handleStockMove} className={`flex-1 py-2 rounded text-sm font-bold text-white ${stockModal.type === 'IN' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}>Confirmar</button>
                          </div>
                      </div>
                    </div>
                  )}

                  {historyModal && (
                    <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center p-4">
                       <div className="bg-white w-full h-3/4 rounded-lg shadow-xl p-4 flex flex-col">
                           <div className="flex justify-between items-center mb-4 border-b pb-2">
                             <h3 className="font-bold text-gray-800">Histórico: {historyModal.name}</h3>
                             <button onClick={() => setHistoryModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><XCircle className="text-gray-500"/></button>
                           </div>
                           <div className="flex-1 overflow-y-auto space-y-2 pr-1 scrollbar-thin">
                             {historyModal.stockHistory?.slice().reverse().map((h, i) => (
                               <div key={i} className="text-xs border-b pb-2 flex justify-between items-center">
                                 <span className="text-gray-500">{formatDateTime(h.date)}</span>
                                 <span className={`font-bold ${h.type === 'INITIAL' || h.type === 'IN' || h.type === 'CANCEL_RETURN' ? 'text-green-600' : 'text-red-600'}`}>
                                   {h.type === 'INITIAL' ? 'Inicial' : h.type === 'IN' ? 'Entrada' : h.type === 'SALE' ? 'Venda' : h.type} ({h.qty})
                                 </span>
                               </div>
                             ))}
                             {(!historyModal.stockHistory || historyModal.stockHistory.length === 0) && <div className="text-center text-gray-400 mt-4">Sem histórico</div>}
                           </div>
                       </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        }

        function POSPanel({ clients, products, setProducts, sales, setSales, saleToEdit, setSaleToEdit }) {
          const [selectedClient, setSelectedClient] = useState('');
          const [clientSearch, setClientSearch] = useState('');
          const [cart, setCart] = useState([]);
          const [payMethod, setPayMethod] = useState('Pix');
          const [changeFor, setChangeFor] = useState(''); 
          const [obs, setObs] = useState(''); 
          const [searchProd, setSearchProd] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('todas');
          const [discount, setDiscount] = useState('');
          const [editingItem, setEditingItem] = useState(null); 
          
          const [tempQty, setTempQty] = useState({});
          
          // Batch Import State
          const [showBatchModal, setShowBatchModal] = useState(false);
          const [batchInput, setBatchInput] = useState('');

          useEffect(() => {
            if (saleToEdit) {
              const client = clients.find(c => c.id === saleToEdit.clientId);
              if (client) {
                setSelectedClient(client.id);
                setClientSearch(client.name);
              }
              setCart(saleToEdit.items.map(i => ({...i, tempId: generateId()})));
              setDiscount(saleToEdit.discount);
              setObs(saleToEdit.obs);
              setPayMethod(saleToEdit.payMethod);
              if (saleToEdit.changeFor) setChangeFor(saleToEdit.changeFor);
              setSaleToEdit(null); 
            }
          }, [saleToEdit, clients]);

          const categories = ['todas', ...new Set(products.map(p => p.category))];
          const filteredClients = clients.filter(c => c.name.toLowerCase().includes(clientSearch.toLowerCase()));

          const getQty = (id) => tempQty[id] || 1;
          const incQty = (id) => setTempQty({...tempQty, [id]: getQty(id) + 1});
          const decQty = (id) => setTempQty({...tempQty, [id]: Math.max(1, getQty(id) - 1)});

          const addToCart = (product) => {
            const qty = getQty(product.id);
            if (!product.isCombo && product.stock < qty) {
              if (!confirm(`Estoque baixo (${product.stock}). Adicionar ${qty} mesmo assim?`)) return;
            }
            
            const itemsToAdd = [];
            for(let i=0; i<qty; i++) {
               itemsToAdd.push({ ...product, tempId: generateId(), originalPrice: product.price });
            }
            setCart([...cart, ...itemsToAdd]);
            setTempQty({...tempQty, [product.id]: 1}); 
          };

          const removeFromCart = (tempId) => {
            setCart(cart.filter(item => item.tempId !== tempId));
          };

          const updateCartItemPrice = () => {
            if (!editingItem) return;
            setCart(cart.map(i => i.tempId === editingItem.tempId ? { ...i, price: editingItem.price } : i));
            setEditingItem(null);
          };

          const subTotal = cart.reduce((acc, item) => acc + Number(item.price), 0);
          const total = subTotal - (Number(discount) || 0);

          const finalizeSale = () => {
            if (!selectedClient) return alert('Selecione um cliente');
            if (cart.length === 0) return alert('Carrinho vazio');

            const newProducts = [...products];
            cart.forEach(cartItem => {
              const dbProd = newProducts.find(p => p.id === cartItem.id);
              if (dbProd) {
                if (dbProd.isCombo) {
                  dbProd.comboItems?.forEach(ing => {
                     const dbIng = newProducts.find(p => p.id === ing.id);
                     if (dbIng) {
                       dbIng.stock -= ing.qty;
                       dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'SALE_COMBO', qty: ing.qty, ref: cartItem.name });
                     }
                  });
                } else {
                  dbProd.stock -= 1;
                  dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'SALE', qty: 1 });
                }
              }
            });
            setProducts(newProducts);

            const newSale = {
              id: generateId(),
              clientId: selectedClient,
              items: cart,
              subTotal,
              discount: Number(discount) || 0,
              total,
              payMethod,
              changeFor: payMethod === 'Dinheiro' ? changeFor : null,
              obs,
              date: new Date().toISOString(),
              status: 'Pendente',
              printedLabel: false,
              printedList: false,
              routeId: null
            };

            setSales([...sales, newSale]);
            
            setCart([]);
            setSelectedClient('');
            setClientSearch('');
            setObs('');
            setChangeFor('');
            setDiscount('');
            alert('Venda Realizada!');
          };
          
          const processBatchInput = () => {
            const lines = batchInput.split('\n');
            const newItems = [];
            const notFound = [];
            
            lines.forEach(line => {
                if(!line.trim()) return;
                const parts = line.split(/[|\t;]+/); 
                const code = parts[0]?.trim();
                const qtyStr = parts[1]?.trim();
                const qty = parseInt(qtyStr) || 1;

                if (code) {
                    const product = products.find(p => p.internalCode === code);
                    if (product) {
                        for(let i=0; i<qty; i++) {
                            newItems.push({ ...product, tempId: generateId(), originalPrice: product.price });
                        }
                    } else {
                        notFound.push(code);
                    }
                }
            });

            if (newItems.length > 0) {
                setCart(prev => [...prev, ...newItems]);
                setBatchInput('');
                setShowBatchModal(false);
                if (notFound.length > 0) alert(`Itens adicionados, mas códigos não encontrados: ${notFound.join(', ')}`);
            } else {
                alert('Nenhum produto válido encontrado na lista.');
            }
          };

          const filteredProducts = products.filter(p => 
            (selectedCategory === 'todas' || p.category === selectedCategory) &&
            p.name.toLowerCase().includes(searchProd.toLowerCase())
          );

          return (
            <div className="flex flex-col h-full gap-2 relative">
              <div className="bg-white p-2 rounded border border-gray-300 shadow-sm shrink-0">
                <label className="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-1 mb-1"><Users size={10}/> Buscar Cliente</label>
                <div className="relative">
                  <input 
                    className="input-field" 
                    placeholder="Digite para buscar..." 
                    value={clientSearch}
                    onChange={e => { setClientSearch(e.target.value); setSelectedClient(''); }}
                  />
                  {clientSearch && !selectedClient && (
                    <div className="absolute top-full left-0 w-full bg-white border shadow-lg max-h-40 overflow-y-auto z-20 rounded-b">
                       {filteredClients.map(c => (
                         <div key={c.id} 
                              className="p-2 hover:bg-blue-50 cursor-pointer text-xs border-b flex justify-between"
                              onClick={() => { setSelectedClient(c.id); setClientSearch(c.name); }}
                         >
                            <span className="font-bold">{c.name}</span>
                            <span className="text-gray-500">{c.district}</span>
                         </div>
                       ))}
                       {filteredClients.length === 0 && <div className="p-2 text-xs text-gray-400">Nenhum cliente encontrado</div>}
                    </div>
                  )}
                </div>
                {selectedClient && (
                   <div className="text-[10px] text-green-600 mt-1 font-bold flex items-center gap-1"><CheckCircle size={10}/> Cliente Selecionado</div>
                )}
              </div>

              <div className="flex-1 flex flex-col min-h-0 bg-white border rounded shadow-sm">
                <div className="p-2 border-b bg-gray-50 space-y-2">
                  <div className="flex gap-2">
                     <select className="input-field w-1/3" value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)}>
                        <option value="todas">Todas</option>
                        {categories.filter(c => c!=='todas').map(c => <option key={c} value={c}>{c}</option>)}
                     </select>
                     <div className="relative w-2/3 flex gap-1">
                        <input className="w-full px-2 py-1 text-sm border rounded focus:outline-none focus:border-blue-500" placeholder="Buscar Produto..." value={searchProd} onChange={e => setSearchProd(e.target.value)}/>
                        <button onClick={() => setShowBatchModal(true)} className="bg-slate-200 p-1 rounded hover:bg-slate-300 text-slate-600" title="Colar Lista"><Clipboard size={16}/></button>
                     </div>
                  </div>
                </div>
                <div className="flex-1 overflow-y-auto p-1">
                  {filteredProducts.map(p => (
                    <div key={p.id} className="p-2 border-b bg-white flex justify-between items-center group mb-1 rounded">
                      <div className="flex-1 cursor-pointer" onClick={() => addToCart(p)}>
                        <div className="font-bold text-xs group-hover:text-blue-700">{p.name}</div>
                        <div className="text-[10px] text-gray-400">Estoque: {p.stock}</div>
                        <div className="font-bold text-xs text-green-700">{formatCurrency(p.price)}</div>
                      </div>
                      <div className="flex items-center gap-1 bg-gray-100 rounded p-1">
                         <button onClick={() => decQty(p.id)} className="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-200">-</button>
                         <span className="w-6 text-center text-xs font-bold">{getQty(p.id)}</span>
                         <button onClick={() => incQty(p.id)} className="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-200">+</button>
                         <button onClick={() => addToCart(p)} className="ml-2 bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold hover:bg-blue-500">ADD</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white border-t p-2 shadow-lg flex flex-col gap-2 shrink-0">
                <div className="flex justify-between items-center bg-slate-100 p-2 rounded">
                  <span className="font-bold text-xs">ITENS: {cart.length}</span>
                  <span className="font-bold text-lg text-green-700">{formatCurrency(total)}</span>
                </div>
                
                <div className="flex gap-2 h-20 overflow-y-auto border p-1 rounded bg-gray-50">
                   {cart.length === 0 && <div className="text-gray-400 text-xs w-full text-center mt-2">Carrinho Vazio</div>}
                   <div className="w-full space-y-1">
                      {cart.map(item => (
                        <div key={item.tempId} className="flex justify-between items-center text-xs bg-white p-1 rounded border shadow-sm">
                          <span className="truncate w-1/2">{item.name}</span>
                          <div className="flex items-center gap-2">
                             <span className="text-yellow-600 cursor-pointer hover:underline font-bold" onClick={() => setEditingItem({tempId: item.tempId, price: item.price})}>
                               {formatCurrency(item.price)}
                             </span>
                             <Trash2 size={12} className="text-red-400 cursor-pointer hover:text-red-600" onClick={() => removeFromCart(item.tempId)} />
                          </div>
                        </div>
                      ))}
                   </div>
                </div>
                
                <div className="flex gap-2">
                    <div className="flex items-center gap-1 bg-white border rounded px-1 w-1/3">
                      <Percent size={10} className="text-gray-400"/>
                      <input type="number" className="input-field border-none p-1" placeholder="Desc R$" value={discount} onChange={e => setDiscount(e.target.value)}/>
                    </div>
                    <select className="input-field w-1/3" value={payMethod} onChange={e => setPayMethod(e.target.value)}>
                      <option value="Pix">Pix</option>
                      <option value="Dinheiro">Dinheiro</option>
                      <option value="Cartão">Cartão</option>
                    </select>
                    {payMethod === 'Dinheiro' && (
                        <input type="number" className="input-field w-1/3" placeholder="Troco p/" value={changeFor} onChange={e => setChangeFor(e.target.value)} />
                    )}
                </div>
                <input className="input-field" placeholder="Observação do Pedido" value={obs} onChange={e => setObs(e.target.value)} />
                <button onClick={finalizeSale} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded text-sm shadow uppercase">FINALIZAR VENDA</button>
              </div>

              {editingItem && (
                <div className="absolute inset-0 bg-black/50 z-20 flex flex-col items-center justify-center p-4">
                  <div className="bg-white p-4 rounded shadow-lg flex flex-col gap-2 w-64">
                      <label className="text-xs font-bold">Novo Preço para este item</label>
                      <input type="number" autoFocus className="input-field text-center text-lg" value={editingItem.price} onChange={e => setEditingItem({...editingItem, price: e.target.value})}/>
                      <div className="flex gap-2">
                        <button onClick={() => setEditingItem(null)} className="flex-1 bg-gray-200 py-2 rounded text-xs">Cancelar</button>
                        <button onClick={updateCartItemPrice} className="flex-1 bg-green-600 text-white py-2 rounded text-xs font-bold">Salvar</button>
                      </div>
                  </div>
                </div>
              )}

              {/* Batch Import Modal */}
              {showBatchModal && (
                <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center p-4">
                  <div className="bg-white p-4 rounded shadow-lg flex flex-col gap-2 w-72">
                      <h3 className="font-bold text-sm text-gray-800">Importar por Código Interno</h3>
                      <p className="text-[10px] text-gray-500">Cole a lista no formato:<br/>CÓDIGO | QUANTIDADE</p>
                      <textarea 
                        className="border p-2 text-xs h-32 rounded focus:outline-none focus:border-blue-500" 
                        placeholder="Ex:&#10;020 | 2&#10;102 | 1"
                        value={batchInput}
                        onChange={e => setBatchInput(e.target.value)}
                      />
                      <div className="flex gap-2">
                        <button onClick={() => setShowBatchModal(false)} className="flex-1 bg-gray-200 py-2 rounded text-xs font-bold">Cancelar</button>
                        <button onClick={processBatchInput} className="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold hover:bg-blue-700">PROCESSAR</button>
                      </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        function ExpeditionPanel({ sales, setSales, clients, products, setProducts, onEditSale }) {
          const updateStatus = (saleId, newStatus) => {
            setSales(sales.map(s => s.id === saleId ? { ...s, status: newStatus } : s));
          };

          const togglePrint = (saleId, field) => {
            setSales(sales.map(s => s.id === saleId ? { ...s, [field]: !s[field] } : s));
          };

          const returnStock = (sale) => {
             const newProducts = [...products];
             sale.items.forEach(item => {
              const dbProd = newProducts.find(p => p.id === item.id);
              if (dbProd) {
                if (dbProd.isCombo) {
                   dbProd.comboItems?.forEach(ing => {
                     const dbIng = newProducts.find(p => p.id === ing.id);
                     if (dbIng) {
                       dbIng.stock += ing.qty;
                       dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: ing.qty });
                     }
                   });
                } else {
                  dbProd.stock += 1;
                  dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: 1 });
                }
              }
             });
             setProducts(newProducts);
          }

          const deleteSale = (sale) => {
            if (!confirm(`Excluir permanentemente a venda de ${formatCurrency(sale.total)}? Estoque será devolvido.`)) return;
            returnStock(sale);
            setSales(sales.filter(s => s.id !== sale.id));
          };

          const handleEdit = (sale) => {
             if(!confirm("Editar esta venda? Ela será removida da expedição e os itens voltarão para o carrinho.")) return;
             returnStock(sale);
             setSales(sales.filter(s => s.id !== sale.id));
             onEditSale(sale);
          };

          const printLabel = (sale, client) => {
            const w = window.open('', '', 'width=300,height=400');
            w.document.write(`
              <style>body{font-family:sans-serif; padding:10px; text-align:center; margin:0} .box{border:2px solid #000; padding:5px; margin-bottom:5px}</style>
              <h2>PEDIDO #${sale.id.substring(0,4).toUpperCase()}</h2>
              <div class="box">
                <h3>${client.name}</h3>
                <p>${client.address}</p>
                <p>${client.district} - ${client.city}</p>
                <p><strong>REG: ${client.region || client.route || 'GERAL'}</strong></p>
              </div>
              <p style="font-size:12px">OBS: ${sale.obs || '-'}</p>
              <p style="font-size:12px">CLI OBS: ${client.obs || '-'}</p>
              <script>window.print()<\/script>
            `);
            w.document.close();
          };

          const printPickingList = (sale, client) => {
            const w = window.open('', '', 'width=400,height=600');
            w.document.write(`
              <style>body{font-family:monospace; padding:20px;} h2{border-bottom:1px solid #000}</style>
              <h2>LISTA DE SEPARAÇÃO #${sale.id.substring(0,4)}</h2>
              <p>CLIENTE: ${client.name}</p>
              <hr/>
              <ul>
                ${sale.items.map(i => `<li>[ ] ${i.name}</li>`).join('')}
              </ul>
              <hr/>
              <p>OBS: ${sale.obs || ''}</p>
              <script>window.print()<\/script>
            `);
            w.document.close();
          };

          const activeSales = sales.filter(s => s.status !== 'Entregue').sort((a,b) => new Date(a.date) - new Date(b.date));

          return (
            <div className="space-y-2 h-full overflow-y-auto pb-4">
              {activeSales.map(sale => {
                const client = clients.find(c => c.id === sale.clientId) || {};
                const isPendente = sale.status === 'Pendente';
                const isMontagem = sale.status === 'Montagem';
                
                return (
                  <div key={sale.id} className={`p-2 border rounded shadow-sm relative group transition-all bg-white ${isPendente ? 'border-red-300' : isMontagem ? 'border-yellow-300' : 'border-green-300'}`}>
                     
                     <div className="flex justify-between items-start mb-2 bg-gray-50 p-1 rounded">
                        <span className="font-bold text-xs text-gray-600">#{sale.id.substring(0,4)}</span>
                        <div className="flex gap-2">
                           <button onClick={() => handleEdit(sale)} className="text-blue-500 hover:text-blue-700 flex items-center gap-1 text-[10px] font-bold border border-blue-200 px-1 rounded bg-white"><Edit2 size={10}/> EDITAR</button>
                           <button onClick={() => deleteSale(sale)} className="text-red-400 hover:text-red-600"><Trash2 size={14}/></button>
                        </div>
                     </div>
                     
                     <div className="font-bold text-sm leading-tight mb-1">{client.name}</div>
                     <div className="text-xs text-gray-500 mb-2">{client.district} • {client.region || 'CBA'}</div>
                     
                     <div className="bg-white p-1.5 rounded text-[10px] text-gray-700 mb-2 border border-gray-200 shadow-inner">
                       {sale.items.map(i => i.name).join(', ')}
                     </div>

                     <div className="grid grid-cols-2 gap-2 mb-2">
                        <button onClick={() => printLabel(sale, client)} className={`flex items-center justify-center gap-1 text-[10px] border rounded py-1 ${sale.printedLabel ? 'bg-green-100 border-green-300 text-green-700' : 'bg-gray-50 hover:bg-gray-100'}`}>
                           <Tag size={10}/> {sale.printedLabel ? 'Etiqueta OK' : 'Etiqueta'}
                        </button>
                        <button onClick={() => printPickingList(sale, client)} className={`flex items-center justify-center gap-1 text-[10px] border rounded py-1 ${sale.printedList ? 'bg-green-100 border-green-300 text-green-700' : 'bg-gray-50 hover:bg-gray-100'}`}>
                           <List size={10}/> {sale.printedList ? 'Lista OK' : 'Lista'}
                        </button>
                     </div>
                     
                     <div className="flex gap-4 text-[10px] text-gray-500 mb-2 justify-center">
                        <label className="flex items-center gap-1"><input type="checkbox" checked={sale.printedLabel} onChange={() => togglePrint(sale.id, 'printedLabel')} /> Já imprimi etiqueta</label>
                        <label className="flex items-center gap-1"><input type="checkbox" checked={sale.printedList} onChange={() => togglePrint(sale.id, 'printedList')} /> Já imprimi lista</label>
                     </div>

                     <div className="flex justify-between items-center mt-2 border-t pt-2 border-dashed border-gray-300">
                       <span className="text-[10px] font-bold uppercase tracking-wider text-gray-400">{sale.status}</span>
                       {isPendente && <button onClick={() => updateStatus(sale.id, 'Montagem')} className="bg-red-500 text-white text-xs px-3 py-1.5 rounded font-bold shadow hover:bg-red-600 transition">INICIAR</button>}
                       {isMontagem && <button onClick={() => updateStatus(sale.id, 'Rota')} className="bg-yellow-500 text-white text-xs px-3 py-1.5 rounded font-bold shadow hover:bg-yellow-600 transition">PRONTO</button>}
                       {sale.status === 'Rota' && <span className="text-xs text-green-600 font-bold flex items-center gap-1"><CheckCircle size={12}/> AGUARDANDO ROTA</span>}
                     </div>
                  </div>
                );
              })}
              {activeSales.length === 0 && <div className="text-center text-gray-400 text-xs mt-10 p-4 border-2 border-dashed border-gray-200 rounded">Expedição Vazia</div>}
            </div>
          );
        }

        function LogisticsPanel({ sales, setSales, clients, companyPhone }) {
          const [selectedRoute, setSelectedRoute] = useState('Todas');
          const [routeSales, setRouteSales] = useState([]); 

          useEffect(() => {
            const ready = sales.filter(s => s.status === 'Rota');
            const filtered = selectedRoute === 'Todas' 
              ? ready 
              : ready.filter(s => {
                  const c = clients.find(cl => cl.id === s.clientId);
                  const region = c?.region || c?.route;
                  return region === selectedRoute;
                });
            setRouteSales(filtered);
          }, [sales, selectedRoute, clients]);

          const routes = [...new Set(clients.map(c => c.region || c.route).filter(Boolean))];

          const moveOrder = (index, direction) => {
            const newOrder = [...routeSales];
            if (direction === 'up' && index > 0) {
              [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
            } else if (direction === 'down' && index < newOrder.length - 1) {
              [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
            }
            setRouteSales(newOrder);
          };

          const generateDriverLink = () => {
            if (routeSales.length === 0) return alert("Nada para entregar!");
            
            const payload = {
              route: selectedRoute,
              companyPhone, 
              generatedAt: new Date(),
              orders: routeSales.map(s => {
                const c = clients.find(cl => cl.id === s.clientId);
                return {
                  id: s.id,
                  customer: c.name,
                  phone: c.phone,
                  address: c.address,
                  district: c.district,
                  region: c.region,
                  map: c.mapLink,
                  total: s.total,
                  pay: s.payMethod,
                  changeFor: s.changeFor,
                  change: s.changeFor ? s.changeFor - s.total : 0,
                  obs: s.obs,
                  clientObs: c.obs,
                  items: s.items.map(i => i.name)
                };
              })
            };

            const encoded = encodeURIComponent(btoa(JSON.stringify(payload)));
            const link = `${window.location.origin}${window.location.pathname}#driver=${encoded}`;
            
            const textArea = document.createElement("textarea");
            textArea.value = link;
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand('copy');
              alert("LINK COPIADO! Envie para o entregador.");
            } catch (err) {
              prompt("Copie o link manualmente:", link);
            }
            document.body.removeChild(textArea);
          };

          const forceDelivery = (id) => {
            if (confirm("Marcar como entregue manualmente?")) {
              setSales(sales.map(s => s.id === id ? { ...s, status: 'Entregue' } : s));
            }
          };

          const totalValue = routeSales.reduce((acc, s) => acc + s.total, 0);

          return (
            <div className="flex flex-col h-full space-y-2">
              <div className="bg-indigo-50 p-2 rounded border border-indigo-100 space-y-2">
                <label className="text-[10px] font-bold text-indigo-800 uppercase">1. Filtrar Região</label>
                <div className="flex gap-2">
                  <select className="flex-1 input-field bg-white" value={selectedRoute} onChange={e => setSelectedRoute(e.target.value)}>
                    <option value="Todas">Todas</option>
                    {routes.map(r => <option key={r} value={r}>{r}</option>)}
                  </select>
                  <button onClick={generateDriverLink} className="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 shadow flex items-center gap-2 text-xs font-bold" title="Criar Link">
                    <Share2 size={14} /> CRIAR LINK
                  </button>
                </div>
              </div>

              {routeSales.length > 0 && (
                <div className="flex justify-between items-center text-xs px-2 py-1 bg-white border rounded text-gray-500">
                   <span>{routeSales.length} Entregas</span>
                   <span className="font-bold text-green-700">Total: {formatCurrency(totalValue)}</span>
                </div>
              )}

              <div className="flex-1 overflow-y-auto space-y-2 p-1 bg-gray-50 border rounded">
                 {routeSales.map((s, idx) => {
                   const client = clients.find(c => c.id === s.clientId) || {};
                   return (
                     <div key={s.id} className="bg-white p-2 rounded shadow-sm border-l-4 border-indigo-500 flex gap-2 relative">
                        <div className="flex flex-col justify-center gap-1 border-r pr-2 text-gray-400">
                          <button onClick={() => moveOrder(idx, 'up')} className="hover:text-indigo-600"><ArrowUp size={14}/></button>
                          <span className="text-center font-bold text-xs text-indigo-900 bg-indigo-100 rounded">{idx + 1}º</span>
                          <button onClick={() => moveOrder(idx, 'down')} className="hover:text-indigo-600"><ArrowDown size={14}/></button>
                        </div>
                        <div className="flex-1 min-w-0">
                           <div className="flex justify-between">
                             <span className="font-bold text-sm text-gray-800 truncate">{client.name}</span>
                             <button onClick={() => forceDelivery(s.id)} className="text-gray-300 hover:text-green-500"><CheckCircle size={14}/></button>
                           </div>
                           <div className="text-xs text-gray-500 truncate">{client.address}</div>
                           
                           <div className="mt-1 flex flex-wrap gap-1 text-[10px]">
                              <span className="bg-gray-200 px-1 rounded">{s.payMethod}</span>
                              <span className="bg-green-100 text-green-800 px-1 rounded font-bold">{formatCurrency(s.total)}</span>
                              {s.changeFor && <span className="bg-red-100 text-red-800 px-1 rounded font-bold">Troco: {formatCurrency(s.changeFor - s.total)}</span>}
                           </div>
                           {s.obs && <div className="text-[10px] text-orange-600 font-bold mt-1 truncate">OBS: {s.obs}</div>}
                           {client.obs && <div className="text-[10px] text-purple-600 font-bold mt-1 truncate">CLI: {client.obs}</div>}
                        </div>
                     </div>
                   );
                 })}
                 {routeSales.length === 0 && <div className="text-center text-xs text-gray-400 mt-4">Nenhuma entrega nesta rota.</div>}
              </div>
              <div className="text-[10px] text-gray-400 text-center">Ordene a sequência com as setas.</div>
            </div>
          );
        }

        function CRMPanel({ sales, clients, products }) {
          const [startDate, setStartDate] = useState(new Date().toISOString().slice(0, 10));
          const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
          const [reportType, setReportType] = useState('produto'); // produto, cidade, bairro, pagamento, rota

          const filterSales = sales.filter(s => {
            const d = s.date.slice(0, 10);
            return d >= startDate && d <= endDate;
          });

          const totalSold = filterSales.reduce((acc, s) => acc + s.total, 0);
          const deliveredSales = filterSales.filter(s => s.status === 'Entregue');
          const deliveredTotal = deliveredSales.reduce((acc, s) => acc + s.total, 0);
          
          const generateReportData = () => {
             const data = {};
             filterSales.forEach(s => {
                const client = clients.find(c => c.id === s.clientId) || {};
                
                if (reportType === 'produto') {
                    s.items.forEach(i => data[i.name] = (data[i.name] || 0) + 1);
                } else if (reportType === 'cidade') {
                    const k = client.city || 'N/A';
                    data[k] = (data[k] || 0) + 1;
                } else if (reportType === 'bairro') {
                    const k = client.district || 'N/A';
                    data[k] = (data[k] || 0) + 1;
                } else if (reportType === 'pagamento') {
                    data[s.payMethod] = (data[s.payMethod] || 0) + 1;
                } else if (reportType === 'rota') {
                    const k = client.region || client.route || 'Geral';
                    data[k] = (data[k] || 0) + 1;
                }
             });
             return Object.entries(data).sort((a,b) => b[1] - a[1]);
          };

          const reportData = generateReportData();

          return (
            <div className="space-y-4 h-full overflow-y-auto pb-10">
              <div className="bg-white p-2 rounded border shadow-sm">
                <div className="flex gap-2 mb-2">
                   <div className="flex-1">
                      <label className="text-[10px] font-bold text-gray-500">INÍCIO</label>
                      <input type="date" className="input-field" value={startDate} onChange={e => setStartDate(e.target.value)} />
                   </div>
                   <div className="flex-1">
                      <label className="text-[10px] font-bold text-gray-500">FIM</label>
                      <input type="date" className="input-field" value={endDate} onChange={e => setEndDate(e.target.value)} />
                   </div>
                </div>
                <div>
                   <label className="text-[10px] font-bold text-gray-500">TIPO DE RELATÓRIO</label>
                   <select className="input-field" value={reportType} onChange={e => setReportType(e.target.value)}>
                      <option value="produto">Por Produto</option>
                      <option value="cidade">Por Cidade</option>
                      <option value="bairro">Por Bairro</option>
                      <option value="pagamento">Por Forma de Pagamento</option>
                      <option value="rota">Por Rota/Região</option>
                   </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div className="bg-green-50 border border-green-200 rounded p-2 text-center">
                  <div className="text-[10px] font-bold text-green-800 uppercase">Recebido</div>
                  <div className="text-lg font-bold text-green-700">{formatCurrency(deliveredTotal)}</div>
                </div>
                <div className="bg-blue-50 border border-blue-200 rounded p-2 text-center">
                  <div className="text-[10px] font-bold text-blue-800 uppercase">Total Vendas</div>
                  <div className="text-lg font-bold text-blue-700">{formatCurrency(totalSold)}</div>
                </div>
              </div>

              <div className="bg-white border rounded p-2">
                <h3 className="font-bold text-xs mb-2 text-gray-600 border-b pb-1 uppercase">Relatório: {reportType}</h3>
                {reportData.map(([name, qty], i) => (
                  <div key={name} className="flex justify-between text-xs py-1 border-b border-gray-50 last:border-0">
                    <span>{i+1}. {name}</span>
                    <span className="font-mono bg-gray-100 px-1 rounded font-bold">{qty}</span>
                  </div>
                ))}
                {reportData.length === 0 && <div className="text-xs text-gray-400 text-center py-2">Sem dados.</div>}
              </div>
            </div>
          );
        }

        function DriverView({ data, onExit }) {
          const [confirmModal, setConfirmModal] = useState(null); // stores order to confirm
          const [paymentType, setPaymentType] = useState('');

          if (!data) return <div className="p-10 text-center">Link expirado ou inválido.</div>;

          const handleAction = (order, type) => {
            const cleanPhone = (p) => p.replace(/\D/g, '');
            let text = '';
            let url = '';

            if (type === 'going') {
              text = `Olá ${order.customer}, seu pedido saiu para entrega e está chegando! 🛵`;
              url = `https://wa.me/55${cleanPhone(order.phone)}?text=${encodeURIComponent(text)}`;
              window.open(url, '_blank');
            } else if (type === 'arrived') {
              text = `Olá ${order.customer}, o entregador chegou! 📍`;
              url = `https://wa.me/55${cleanPhone(order.phone)}?text=${encodeURIComponent(text)}`;
              window.open(url, '_blank');
            } else if (type === 'confirm') {
               // Open Modal
               setPaymentType(order.pay); // Default to ordered payment
               setConfirmModal(order);
            }
          };

          const finalizeConfirmation = () => {
             if (!confirmModal) return;
             
             const order = confirmModal;
             const companyPhone = data.companyPhone || '65998150975';
             const cleanCompany = companyPhone.replace(/\D/g, '');
             const now = new Date();

             const report = `
✅ *BAIXA DE ENTREGA*
📅 ${now.toLocaleDateString()} ⏰ ${now.toLocaleTimeString()}

👤 *Cliente:* ${order.customer}
📞 *Tel:* ${order.phone}
📍 *Local:* ${order.district} (${order.region || 'N/A'})
🏙 *Cidade:* ${order.address}

📦 *Produtos:*
${order.items.join(', ')}

💰 *Valor Total:* ${formatCurrency(order.total)}
💳 *Pagamento:* ${paymentType}

${order.obs ? `⚠ *Obs Pedido:* ${order.obs}` : ''}
${order.clientObs ? `⚠ *Obs Cliente:* ${order.clientObs}` : ''}
`;
             
             const url = `https://wa.me/55${cleanCompany}?text=${encodeURIComponent(report)}`;
             window.open(url, '_blank');
             setConfirmModal(null);
          };

          return (
            <div className="min-h-screen bg-gray-100 pb-12 font-sans">
              <div className="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
                <div>
                   <h1 className="font-bold text-lg leading-none">{data.route}</h1>
                   <div className="text-[10px] text-gray-400 mt-1">{data.orders.length} Entregas</div>
                </div>
                <button onClick={onExit} className="bg-slate-700 text-xs px-3 py-2 rounded border border-slate-600">Sair</button>
              </div>

              <div className="p-4 space-y-6">
                {data.orders.map((order, idx) => (
                  <div key={order.id} className="bg-white rounded-xl shadow-sm border overflow-hidden relative">
                    <div className="absolute top-0 left-0 bg-slate-900 text-white px-3 py-1 text-sm font-bold rounded-br-lg">
                      #{idx + 1}
                    </div>
                    
                    <div className="p-4 pt-8">
                      <div className="flex justify-between items-start">
                         <h2 className="text-xl font-bold text-gray-800">{order.customer}</h2>
                         <div className="text-right">
                           <div className="font-bold text-green-700 text-lg">{formatCurrency(order.total)}</div>
                           <div className="text-[10px] bg-gray-100 px-1 rounded text-gray-600 uppercase">{order.pay}</div>
                         </div>
                      </div>
                      <p className="text-gray-600 text-sm mt-1">{order.address}</p>
                      
                      {order.change > 0 && (
                        <div className="mt-2 bg-red-100 text-red-800 p-2 rounded text-center font-bold border border-red-200 animate-pulse">
                           🚨 LEVAR TROCO: {formatCurrency(order.change)}
                        </div>
                      )}

                      {(order.obs || order.clientObs) && (
                        <div className="mt-2 bg-yellow-100 text-yellow-800 p-2 rounded text-xs font-bold border border-yellow-200 flex flex-col gap-1">
                           {order.obs && <span>⚠ PEDIDO: {order.obs}</span>}
                           {order.clientObs && <span>⚠ CLIENTE: {order.clientObs}</span>}
                        </div>
                      )}

                      <div className="mt-3 bg-gray-50 p-2 rounded text-xs text-gray-600 border border-gray-100">
                        {order.items.join(' + ')}
                      </div>
                    </div>

                    <div className="grid grid-cols-4 border-t divide-x bg-gray-50">
                      {order.map && (
                         <a href={order.map} target="_blank" rel="noreferrer" className="flex flex-col items-center justify-center py-3 hover:bg-gray-200">
                           <Navigation size={20} className="text-blue-600 mb-1"/>
                           <span className="text-[10px] font-bold text-blue-800">MAPA</span>
                         </a>
                      )}
                      <button onClick={() => handleAction(order, 'going')} className="flex flex-col items-center justify-center py-3 hover:bg-gray-200">
                        <Truck size={20} className="text-orange-500 mb-1"/>
                        <span className="text-[10px] font-bold text-orange-700">INDO</span>
                      </button>
                      <button onClick={() => handleAction(order, 'arrived')} className="flex flex-col items-center justify-center py-3 hover:bg-gray-200">
                        <MapPin size={20} className="text-purple-600 mb-1"/>
                        <span className="text-[10px] font-bold text-purple-800">AQUI</span>
                      </button>
                      <button onClick={() => handleAction(order, 'confirm')} className="flex flex-col items-center justify-center py-3 hover:bg-green-100 bg-green-50">
                        <CheckCircle size={20} className="text-green-600 mb-1"/>
                        <span className="text-[10px] font-bold text-green-800">OK</span>
                      </button>
                    </div>
                  </div>
                ))}
              </div>

              {confirmModal && (
                  <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                     <div className="bg-white rounded-lg p-4 w-full max-w-sm">
                        <h2 className="font-bold text-lg mb-2">Confirmar Entrega</h2>
                        <p className="text-sm text-gray-600 mb-4">Cliente: {confirmModal.customer}</p>
                        
                        <label className="text-xs font-bold text-gray-500 block mb-1">COMO FOI PAGO?</label>
                        <select className="input-field mb-4 h-10 text-lg" value={paymentType} onChange={e => setPaymentType(e.target.value)}>
                            <option value="Pix">Pix</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão">Cartão</option>
                        </select>

                        <div className="flex gap-2">
                           <button onClick={() => setConfirmModal(null)} className="flex-1 bg-gray-200 py-3 rounded font-bold text-gray-600">Cancelar</button>
                           <button onClick={finalizeConfirmation} className="flex-1 bg-green-600 text-white py-3 rounded font-bold shadow-lg">CONFIRMAR & ENVIAR</button>
                        </div>
                     </div>
                  </div>
              )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
