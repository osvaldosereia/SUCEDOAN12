<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Log√≠stica Local-First v3.9</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ESTILOS EXTRAS -->
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .btn-primary {
            background-color: #1e293b;
            color: white;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #334155; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>

    <!-- 3. IMPORTMAP REACT -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Save, Truck, Package, ShoppingCart, Users, MapPin, 
          Printer, Share2, Download, Upload, Trash2, Plus, 
          Minus, CheckCircle, Search, Navigation, Edit2, 
          ArrowUp, ArrowDown, History, MessageCircle, XCircle,
          AlertTriangle, FileText, Banknote, List, Tag, Percent, 
          Calendar, Filter, Phone, Database, Clipboard, Box, ExternalLink,
          Clock, Home, DollarSign, CreditCard, Check
        } from 'lucide-react';

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // Gera ID sequencial di√°rio (01-99)
        const generateDailyId = (sales) => {
            const today = new Date().toISOString().slice(0, 10);
            const todaysSales = sales.filter(s => s.date.startsWith(today));
            const count = todaysSales.length + 1;
            return count > 99 ? count.toString() : count.toString().padStart(2, '0');
        };

        const generateClientCode = (existingClients) => {
           let code;
           let attempts = 0;
           do {
             code = Math.floor(1000 + Math.random() * 9000).toString();
             attempts++;
             if(attempts > 1000) break; 
           } while (existingClients.some(c => c.code === code));
           return code;
        };

        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });

          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);

          return [value, setValue];
        };

        const formatCurrency = (value) => {
          return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        };

        const formatDate = (dateString) => {
          if (!dateString) return '-';
          return new Date(dateString).toLocaleDateString('pt-BR');
        };

        const formatDateTime = (dateString) => {
          if (!dateString) return '-';
          return new Date(dateString).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' });
        };

        function App() {
          const [clients, setClients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [companyPhone, setCompanyPhone] = useStickyState('db_config_phone', '65998150975');
          
          const [viewMode, setViewMode] = useState('dashboard');
          const [driverData, setDriverData] = useState(null);
          
          const [saleToEdit, setSaleToEdit] = useState(null);
          const [backupType, setBackupType] = useState('all'); 

          // L√≥gica robusta para detectar link do entregador
          useEffect(() => {
            const checkHash = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#driver=')) {
                  try {
                    const encoded = hash.replace('#driver=', '');
                    const decoded = JSON.parse(atob(decodeURIComponent(encoded)));
                    setDriverData(decoded);
                    setViewMode('driver');
                  } catch (e) {
                    console.error("Link inv√°lido", e);
                    alert("Erro ao abrir link do entregador. Verifique se o link est√° completo.");
                  }
                } else {
                    if (viewMode === 'driver') setViewMode('dashboard');
                }
            };

            // Checa ao carregar
            checkHash();

            // Checa se a URL mudar na mesma janela
            window.addEventListener('hashchange', checkHash);
            return () => window.removeEventListener('hashchange', checkHash);
          }, []);

          const handleBackup = () => {
            let data = { version: '3.9', exportedAt: new Date() };
            let filename = 'backup';

            if (backupType === 'all') {
                data = { ...data, clients, products, sales, companyPhone };
                filename = 'backup_completo';
            } else if (backupType === 'clients') {
                data = { ...data, clients };
                filename = 'backup_clientes';
            } else if (backupType === 'products') {
                data = { ...data, products };
                filename = 'backup_produtos';
            }

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
          };

          const handleRestore = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const data = JSON.parse(event.target.result);
                const confirmMsg = "ATEN√á√ÉO: A importa√ß√£o ir√° SOBRESCREVER os dados existentes do tipo importado. Continuar?";
                
                if (confirm(confirmMsg)) {
                  let msg = "Importado com sucesso:\n";
                  if (data.clients) { setClients(data.clients); msg += "- Clientes\n"; }
                  if (data.products) { setProducts(data.products); msg += "- Produtos\n"; }
                  if (data.sales) { setSales(data.sales); msg += "- Vendas\n"; }
                  if (data.companyPhone) setCompanyPhone(data.companyPhone);
                  alert(msg);
                }
              } catch (err) {
                alert("Erro ao ler backup.");
              }
            };
            reader.readAsText(file);
          };

          if (viewMode === 'driver') {
            return <DriverView data={driverData} onExit={() => {
              window.location.hash = '';
              setViewMode('dashboard');
            }} />;
          }

          return (
            <div className="h-screen flex flex-col bg-gray-100 text-gray-800 font-sans overflow-hidden text-sm">
              <header className="bg-slate-900 text-white p-2 flex justify-between items-center shadow-lg z-20 shrink-0 h-14 relative">
                <div className="flex items-center gap-2">
                  <div className="bg-yellow-500 text-slate-900 p-1 rounded font-bold">LOG</div>
                  <h1 className="font-bold tracking-wider text-sm md:text-base hidden sm:block">SISTEMA V3.9</h1>
                </div>
                <div className="flex gap-2 items-center">
                   <div className="flex items-center gap-1 bg-slate-800 p-1 rounded border border-slate-700">
                      <Phone size={12} className="text-gray-400"/>
                      <input 
                         className="bg-transparent text-xs text-white w-24 focus:outline-none"
                         value={companyPhone}
                         onChange={e => setCompanyPhone(e.target.value)}
                         title="Zap da Empresa para relat√≥rios"
                      />
                   </div>
                  <label className="flex items-center gap-1 bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded cursor-pointer text-xs transition border border-slate-600">
                    <Upload size={14} /> <span className="hidden sm:inline">Importar</span>
                    <input type="file" className="hidden" accept=".json" onChange={handleRestore} />
                  </label>
                  
                  <div className="flex items-center bg-emerald-700 rounded border border-emerald-500 overflow-hidden">
                      <select 
                        className="bg-emerald-700 text-white text-xs p-1.5 outline-none font-bold cursor-pointer hover:bg-emerald-600"
                        value={backupType}
                        onChange={(e) => setBackupType(e.target.value)}
                        title="Tipo de Backup"
                      >
                          <option value="all">Exportar: Geral</option>
                          <option value="clients">Exportar: Clientes</option>
                          <option value="products">Exportar: Produtos</option>
                      </select>
                      <button onClick={handleBackup} className="bg-emerald-600 hover:bg-emerald-500 px-3 py-1.5 text-xs transition font-bold border-l border-emerald-500 h-full flex items-center">
                        <Download size={14} />
                      </button>
                  </div>
                </div>
              </header>

              <div className="flex-1 overflow-x-auto overflow-y-hidden">
                <div className="h-full grid grid-cols-5 divide-x divide-gray-300 min-w-[1400px]">
                  
                  <Column title="CADASTROS" icon={<Save size={16}/>}>
                    <RegistryPanel clients={clients} setClients={setClients} products={products} setProducts={setProducts} />
                  </Column>

                  <Column title="CAIXA / VENDA" icon={<ShoppingCart size={16}/>}>
                    <POSPanel 
                      clients={clients} 
                      products={products} 
                      setProducts={setProducts} 
                      sales={sales} 
                      setSales={setSales} 
                      saleToEdit={saleToEdit}
                      setSaleToEdit={setSaleToEdit}
                    />
                  </Column>

                  <Column title="EXPEDI√á√ÉO" icon={<Package size={16}/>}>
                    <ExpeditionPanel 
                      sales={sales} 
                      setSales={setSales} 
                      clients={clients} 
                      products={products} 
                      setProducts={setProducts}
                      onEditSale={(sale) => setSaleToEdit(sale)}
                    />
                  </Column>

                  <Column title="LOG√çSTICA" icon={<MapPin size={16}/>}>
                    <LogisticsPanel sales={sales} setSales={setSales} clients={clients} companyPhone={companyPhone} />
                  </Column>

                  <Column title="GEST√ÉO" icon={<Users size={16}/>}>
                    <CRMPanel sales={sales} clients={clients} products={products} />
                  </Column>

                </div>
              </div>
            </div>
          );
        }

        const Column = ({ title, icon, children }) => (
          <div className="bg-white flex flex-col min-w-0 h-full overflow-hidden">
            <div className="bg-slate-100 p-2 border-b border-gray-200 font-bold flex items-center gap-2 text-slate-700 text-xs uppercase tracking-wide shadow-sm shrink-0">
              {icon} {title}
            </div>
            <div className="flex-1 overflow-hidden bg-white relative">
              {children}
            </div>
          </div>
        );

        /* * DRIVER VIEW COMPONENT (App Entregador v2)
         * - Bot√µes de a√ß√£o r√°pida
         * - Notifica√ß√£o autom√°tica para a central
         */
        function DriverView({ data, onExit }) {
          const [deliveryModal, setDeliveryModal] = useState(null); 
          const [filter, setFilter] = useState('Todas'); // Estado para os chips de filtro
          const [completedIds, setCompletedIds] = useState([]); // Rastreia entregas feitas na sess√£o

          if (!data) return <div className="p-4 text-center">Dados inv√°lidos ou expirados.</div>;

          const companyPhone = data.companyPhone || '65998150975';

          const sendToCustomer = (phone, msg) => {
             const cleanPhone = phone.replace(/\D/g,'');
             window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
          };

          // Extrair regi√µes √∫nicas para os chips
          const uniqueRegions = [...new Set(data.orders.map(o => o.region || 'Geral').filter(Boolean))];
          const regions = ['Todas', ...uniqueRegions];
          const showChips = uniqueRegions.length > 1;

          // Filtrar pedidos
          const filteredOrders = filter === 'Todas' 
            ? data.orders 
            : data.orders.filter(o => (o.region || 'Geral') === filter);

          // Ordenar: Pendentes primeiro, Conclu√≠dos por √∫ltimo
          const visibleOrders = [...filteredOrders].sort((a, b) => {
             const aDone = completedIds.includes(a.id);
             const bDone = completedIds.includes(b.id);
             if (aDone === bDone) return 0;
             return aDone ? 1 : -1;
          });

          const handleDeliveryConfirm = (method) => {
            if (!deliveryModal) return;
            const order = deliveryModal;
            const clientPhone = order.phone.replace(/\D/g, '');
            const clientName = order.customer.split(' ')[0]; // Primeiro nome

            // Gerador de links para o cliente
            const genLink = (msg) => `https://wa.me/55${clientPhone}?text=${encodeURIComponent(msg)}`;

            const msg1 = `Ol√° ${clientName}! Muito obrigado pela prefer√™ncia. Esperamos que goste da sua cesta! üß∫‚ú®`;
            const msg2 = `Oi ${clientName}! Que tal ganhar R$ 20,00 de desconto na pr√≥xima compra? ü§ë √â s√≥ avaliar a gente rapidinho no Google: https://g.page/r/CaIREJtO1L6WEBE/review Mandar print para validar!`;
            const msg3 = `Entre no nosso Grupo VIP de Descontos para ofertas exclusivas! üöÄ https://chat.whatsapp.com/IOI3gSBLRVk4jGK2QMunp1`;
            const msg4 = `Acompanhe nossas novidades no Instagram! üì∏ https://www.instagram.com/cestas.dona.antonia.cuiaba.vg/`;

            // Mensagem para o Gestor (Central)
            const msg = `‚úÖ *ENTREGA REALIZADA*\n\n` +
                        `üÜî Pedido: #${order.id}\n` +
                        `üë§ Cliente: ${order.customer}\n` +
                        `üìç Bairro: ${order.district}\n` +
                        `üí∞ Valor: ${formatCurrency(order.total)}\n` +
                        `üíµ Recebido via: *${method}*\n\n` +
                        `--- üîó P√ìS-VENDA (LINKS P/ O CLIENTE) ---\n` +
                        `1Ô∏è‚É£ *Agradecimento:* ${genLink(msg1)}\n\n` +
                        `2Ô∏è‚É£ *Cupom R$20 (Review):* ${genLink(msg2)}\n\n` +
                        `3Ô∏è‚É£ *Grupo VIP:* ${genLink(msg3)}\n\n` +
                        `4Ô∏è‚É£ *Instagram:* ${genLink(msg4)}`;

            window.open(`https://wa.me/55${companyPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            
            // Marca como conclu√≠do e joga pro final
            setCompletedIds(prev => [...prev, order.id]);
            setDeliveryModal(null);
          };
          
          const progress = Math.round((completedIds.length / data.orders.length) * 100);
          const allFinished = completedIds.length === data.orders.length;

          return (
            <div className="min-h-screen bg-gray-50 text-gray-800 pb-16">
               <header className="bg-indigo-700 text-white p-4 sticky top-0 z-10 shadow-md">
                 <div className="flex justify-between items-center mb-2">
                    <h1 className="font-bold text-lg">ROTA: {data.route}</h1>
                    <button onClick={onExit} className="text-xs bg-indigo-800 px-2 py-1 rounded hover:bg-indigo-900 transition">Sair</button>
                 </div>
                 
                 {/* CHIPS DE FILTRO (S√≥ aparece se tiver > 1 regi√£o diferente) */}
                 {showChips && (
                     <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin mb-1">
                        {regions.map(r => (
                            <button 
                                key={r}
                                onClick={() => setFilter(r)}
                                className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition border ${filter === r ? 'bg-white text-indigo-700 border-white' : 'bg-indigo-800 text-indigo-200 border-indigo-600 hover:bg-indigo-600'}`}
                            >
                                {r}
                            </button>
                        ))}
                     </div>
                 )}

                 <div className="flex justify-between items-end">
                    <div className="text-xs opacity-80">
                        <span>{completedIds.length}/{data.orders.length} Entregas</span>
                    </div>
                    <div className="w-1/2 bg-indigo-900 rounded-full h-1.5 overflow-hidden">
                        <div className="bg-green-400 h-full transition-all duration-500" style={{width: `${progress}%`}}></div>
                    </div>
                 </div>
               </header>
               
               <div className="p-4 space-y-6">
                  {visibleOrders.map((order, idx) => {
                    const isDelivered = completedIds.includes(order.id);
                    const clientFirstName = order.customer.split(' ')[0];

                    return (
                        <div key={order.id} className={`rounded-lg shadow-sm border overflow-hidden relative transition-all duration-500 ${isDelivered ? 'bg-gray-100 border-gray-200 opacity-75' : 'bg-white'}`}>
                        {/* Overlay de Entregue */}
                        {isDelivered && (
                            <div className="absolute top-2 right-2 z-20">
                                <span className="bg-green-600 text-white text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1 shadow-sm">
                                    <Check size={12}/> ENTREGUE
                                </span>
                            </div>
                        )}

                        <div className={`p-3 border-b flex justify-between items-center ${isDelivered ? 'bg-gray-200 border-gray-300' : 'bg-indigo-50 border-indigo-100'}`}>
                            <span className={`font-bold px-3 py-1 rounded-full text-sm shadow-sm ${isDelivered ? 'bg-gray-300 text-gray-600' : 'text-indigo-900 bg-white'}`}>#{order.id}</span>
                            {!isDelivered && <span className="font-bold text-indigo-900 text-sm">Pendente</span>}
                        </div>
                        
                        <div className="p-4">
                            <h2 className="font-bold text-xl text-gray-800 mb-1 leading-tight">{order.customer}</h2>
                            <p className="text-gray-600 text-sm mb-4 flex items-start gap-1">
                                <MapPin size={16} className="mt-0.5 shrink-0 text-gray-400"/> 
                                {order.address}, {order.district}
                            </p>

                            {/* 1. OBS DO CLIENTE (Prioridade) */}
                            {order.clientObs && !isDelivered && (
                                <div className="mb-4 bg-purple-50 p-3 rounded-lg border-l-4 border-purple-500 text-purple-900 shadow-sm">
                                    <p className="text-xs font-bold uppercase mb-1">‚ö†Ô∏è Obs do Cadastro:</p>
                                    <p className="font-semibold text-sm">{order.clientObs}</p>
                                </div>
                            )}

                            {/* 2. PAINEL DE BOT√ïES (GRID 3 COLUNAS) */}
                            <div className="grid grid-cols-3 gap-2 mb-4">
                                {/* Ligar */}
                                <a href={`tel:${order.phone}`} className="flex flex-col items-center justify-center bg-gray-100 py-3 rounded hover:bg-gray-200 active:scale-95 transition">
                                    <Phone size={20} className="text-gray-700 mb-1"/>
                                    <span className="text-[10px] font-bold text-gray-600">LIGAR</span>
                                </a>

                                {/* 10 Min - Personalizado */}
                                <button onClick={() => sendToCustomer(order.phone, `Ol√° ${clientFirstName}! Sua entrega chega em aproximadamente 10 minutos. üöö`)} 
                                    className="flex flex-col items-center justify-center bg-blue-50 py-3 rounded hover:bg-blue-100 active:scale-95 transition">
                                    <Clock size={20} className="text-blue-600 mb-1"/>
                                    <span className="text-[10px] font-bold text-blue-700">10 MIN</span>
                                </button>

                                {/* Cheguei - Personalizado */}
                                <button onClick={() => sendToCustomer(order.phone, `Ol√° ${clientFirstName}! O entregador chegou e est√° aguardando. üè†`)}
                                    className="flex flex-col items-center justify-center bg-yellow-50 py-3 rounded hover:bg-yellow-100 active:scale-95 transition">
                                    <Home size={20} className="text-yellow-600 mb-1"/>
                                    <span className="text-[10px] font-bold text-yellow-700">CHEGUEI</span>
                                </button>
                            </div>

                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(order.address + ', ' + order.district)}`} target="_blank" 
                                   className={`${isDelivered ? 'bg-gray-400 cursor-default' : 'bg-blue-600 hover:bg-blue-700 shadow'} text-white py-3 rounded font-bold text-sm flex items-center justify-center gap-2 transition`}>
                                    <MapPin size={18}/> ABRIR GPS
                                </a>
                                {isDelivered ? (
                                    <button disabled className="bg-gray-200 text-gray-400 border border-gray-300 py-3 rounded font-bold text-sm flex items-center justify-center gap-2 cursor-not-allowed">
                                        <CheckCircle size={18}/> CONCLU√çDO
                                    </button>
                                ) : (
                                    <button onClick={() => setDeliveryModal(order)} className="bg-emerald-600 text-white py-3 rounded font-bold text-sm hover:bg-emerald-700 flex items-center justify-center gap-2 shadow animate-pulse">
                                        <CheckCircle size={18}/> ENTREGUE
                                    </button>
                                )}
                            </div>

                            <div className={`p-3 rounded text-sm mb-3 border ${isDelivered ? 'bg-gray-100 border-gray-200 text-gray-500' : 'bg-gray-50 border-gray-100'}`}>
                                <div className="flex justify-between mb-1">
                                    <span className="text-gray-500">Forma Pagto:</span>
                                    <span className="font-bold uppercase">{order.pay}</span>
                                </div>
                                <div className="flex justify-between items-center mb-1">
                                    <span className="text-gray-500">Valor Total:</span>
                                    <span className={`font-bold text-xl ${isDelivered ? 'text-gray-600' : 'text-green-700'}`}>{formatCurrency(order.total)}</span>
                                </div>
                                {order.change > 0 && !isDelivered && (
                                    <div className="flex justify-between text-red-600 font-bold bg-white border border-red-100 p-2 rounded mt-2">
                                    <span className="flex items-center gap-1"><AlertTriangle size={14}/> LEVAR TROCO:</span>
                                    <span className="text-lg">{formatCurrency(order.change)}</span>
                                    </div>
                                )}
                            </div>
                            
                            {order.obs && !isDelivered && (
                                <div className="text-xs bg-orange-50 p-3 rounded text-orange-900 border border-orange-200">
                                <p><strong>üìù OBS DO PEDIDO:</strong> {order.obs}</p>
                                </div>
                            )}
                        </div>
                        </div>
                    );
                  })}
               </div>

               {/* MODAL DE BAIXA */}
               {deliveryModal && (
                 <div className="fixed inset-0 bg-black/80 z-50 flex items-end justify-center sm:items-center p-4 animate-in">
                    <div className="bg-white w-full max-w-sm rounded-xl p-4 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="font-bold text-lg text-gray-800">Confirmar Recebimento</h3>
                            <button onClick={() => setDeliveryModal(null)} className="bg-gray-200 p-1 rounded-full"><XCircle size={20}/></button>
                        </div>
                        <p className="text-center text-gray-600 mb-4">Como o pagamento foi realizado?</p>
                        <div className="grid grid-cols-2 gap-3 mb-2">
                            <button onClick={() => handleDeliveryConfirm('DINHEIRO')} className="bg-green-100 text-green-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-green-200">
                                <DollarSign size={24}/> DINHEIRO
                            </button>
                            <button onClick={() => handleDeliveryConfirm('PIX')} className="bg-indigo-100 text-indigo-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-indigo-200">
                                <Share2 size={24}/> PIX
                            </button>
                            <button onClick={() => handleDeliveryConfirm('CART√ÉO')} className="bg-blue-100 text-blue-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-blue-200">
                                <CreditCard size={24}/> CART√ÉO
                            </button>
                            <button onClick={() => handleDeliveryConfirm('S√ì ENTREGUE')} className="bg-gray-100 text-gray-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-gray-200">
                                <CheckCircle size={24}/> J√Å PAGO
                            </button>
                        </div>
                        <p className="text-[10px] text-gray-400 text-center mt-2">Isso enviar√° o comprovante para a central e os links de p√≥s-venda.</p>
                    </div>
                 </div>
               )}

               <div className={`fixed bottom-0 left-0 w-full p-3 text-center text-xs font-bold shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] transition-colors ${allFinished ? 'bg-green-600 text-white' : 'bg-white text-gray-400 border-t'}`}>
                  {allFinished ? '‚úÖ ROTA FINALIZADA COM SUCESSO' : 'Rota em Andamento...'}
               </div>
            </div>
          );
        }

        function RegistryPanel({ clients, setClients, products, setProducts }) {
          const [tab, setTab] = useState('clients');
          const [editingClientId, setEditingClientId] = useState(null);
          const [editingProductId, setEditingProductId] = useState(null);
          const [searchClient, setSearchClient] = useState('');
          const [searchProduct, setSearchProduct] = useState('');

          const [cForm, setCForm] = useState({ name: '', code: '', phone: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' });
          const [pForm, setPForm] = useState({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
          
          const [stockModal, setStockModal] = useState(null); 
          const [historyModal, setHistoryModal] = useState(null);

          const loadClientForEdit = (client) => {
            setCForm(client);
            setEditingClientId(client.id);
            setTab('clients');
          };

          const saveClient = () => {
            if (!cForm.name) return alert('Nome obrigat√≥rio');
            if (editingClientId) {
              setClients(clients.map(c => c.id === editingClientId ? { ...cForm, id: editingClientId, code: c.code || cForm.code } : c));
              setEditingClientId(null);
              alert('Cliente Atualizado!');
            } else {
              const newCode = generateClientCode(clients);
              setClients([...clients, { ...cForm, id: generateId(), code: newCode }]);
              alert(`Cliente Cadastrado! C√≥digo: ${newCode}`);
            }
            setCForm({ name: '', code: '', phone: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' });
          };

          const deleteClient = (id) => {
            if(confirm("Tem certeza que deseja apagar este cliente?")) {
              setClients(clients.filter(c => c.id !== id));
            }
          };

          const loadProductForEdit = (product) => {
            setPForm(product);
            setEditingProductId(product.id);
            setTab('products');
          };

          const saveProduct = () => {
            if (!pForm.name) return alert('Nome obrigat√≥rio');
            if (editingProductId) {
              setProducts(products.map(p => p.id === editingProductId ? { ...pForm, id: editingProductId, stock: p.stock, stockHistory: p.stockHistory } : p));
              setEditingProductId(null);
              alert('Produto Atualizado!');
            } else {
              const newProd = { 
                ...pForm, 
                id: generateId(), 
                stockHistory: [{ date: new Date().toISOString(), type: 'INITIAL', qty: Number(pForm.stock) }] 
              };
              setProducts([...products, newProd]);
              alert('Produto Cadastrado!');
            }
            setPForm({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
          };

          const deleteProduct = (id) => {
            if(confirm("Tem certeza? Isso remove o produto de novas vendas.")) {
              setProducts(products.filter(p => p.id !== id));
            }
          };

          const handleStockMove = () => {
            if (!stockModal || stockModal.qty <= 0) return;
            const { product, type, qty } = stockModal;
            const updatedProducts = products.map(p => {
              if (p.id === product.id) {
                const newStock = type === 'IN' ? p.stock + qty : p.stock - qty;
                const newHistory = [...(p.stockHistory || []), { date: new Date().toISOString(), type, qty }];
                return { ...p, stock: newStock, stockHistory: newHistory };
              }
              return p;
            });
            setProducts(updatedProducts);
            setStockModal(null);
          };

          const filteredClients = clients
            .filter(c => c.name.toLowerCase().includes(searchClient.toLowerCase()) || (c.code && c.code.includes(searchClient)))
            .sort((a, b) => a.name.localeCompare(b.name));

          const filteredProducts = products
            .filter(p => p.name.toLowerCase().includes(searchProduct.toLowerCase()) || (p.internalCode && p.internalCode.includes(searchProduct)))
            .sort((a, b) => a.name.localeCompare(b.name));

          return (
            <div className="h-full flex flex-col p-2 gap-2">
              <div className="flex bg-gray-200 p-1 rounded gap-1 shrink-0">
                <button onClick={() => setTab('clients')} className={`flex-1 py-1 text-xs font-bold rounded ${tab === 'clients' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>CLIENTES</button>
                <button onClick={() => setTab('products')} className={`flex-1 py-1 text-xs font-bold rounded ${tab === 'products' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>PRODUTOS</button>
              </div>

              {tab === 'clients' ? (
                <div className="flex flex-col h-full overflow-hidden">
                  <div className={`p-2 rounded border space-y-2 shrink-0 ${editingClientId ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}`}>
                    {editingClientId && <div className="text-xs font-bold text-yellow-700 uppercase mb-1">Editando Cliente</div>}
                    <div className="flex gap-1">
                        <input className="input-field w-3/4" placeholder="Nome do Cliente" value={cForm.name} onChange={e => setCForm({...cForm, name: e.target.value})} />
                        {editingClientId && <input className="input-field w-1/4 bg-gray-100" placeholder="C√≥d" value={cForm.code} disabled />}
                    </div>
                    <input className="input-field" placeholder="WhatsApp (apenas n√∫meros)" value={cForm.phone} onChange={e => setCForm({...cForm, phone: e.target.value})} />
                    <input className="input-field" placeholder="Endere√ßo Completo" value={cForm.address} onChange={e => setCForm({...cForm, address: e.target.value})} />
                    <div className="flex gap-1">
                       <input className="input-field w-1/2" placeholder="Bairro" value={cForm.district} onChange={e => setCForm({...cForm, district: e.target.value})} />
                       <select className="input-field w-1/2" value={cForm.city} onChange={e => setCForm({...cForm, city: e.target.value})}>
                         <option value="CUIAB√Å">Cuiab√°</option>
                         <option value="VARZEA GRANDE">V√°rzea Grande</option>
                       </select>
                    </div>
                    <div className="flex gap-1">
                       <select className="input-field w-1/3" value={cForm.region} onChange={e => setCForm({...cForm, region: e.target.value})}>
                          <option value="CUIAB√Å">CUIAB√Å (Centro/Geral)</option>
                          <option value="COXIPO">COXIPO</option>
                          <option value="VARZEA GRANDE">VARZEA GRANDE</option>
                          <option value="CPA">CPA</option>
                       </select>
                       <input className="input-field w-2/3" placeholder="Link Maps" value={cForm.mapLink} onChange={e => setCForm({...cForm, mapLink: e.target.value})} />
                    </div>
                    <input className="input-field" placeholder="Observa√ß√£o" value={cForm.obs} onChange={e => setCForm({...cForm, obs: e.target.value})} />
                    <div className="flex gap-2">
                      {editingClientId && <button onClick={() => {setEditingClientId(null); setCForm({ name: '', code: '', phone: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' })}} className="w-1/3 bg-gray-400 text-white rounded text-xs font-bold">CANCELAR</button>}
                      <button onClick={saveClient} className="btn-primary flex-1">{editingClientId ? 'SALVAR ALTERA√á√ïES' : 'CADASTRAR'}</button>
                    </div>
                  </div>
                  
                  <div className="flex-1 flex flex-col min-h-0 mt-4">
                    <div className="flex justify-between items-center mb-2 border-b pb-1 shrink-0">
                        <h3 className="font-bold text-xs text-gray-500">BASE ({filteredClients.length})</h3>
                        <input className="text-xs p-1 border rounded w-1/2" placeholder="Buscar..." value={searchClient} onChange={e => setSearchClient(e.target.value)}/>
                    </div>
                    <div className="overflow-y-auto scrollbar-thin">
                        {filteredClients.map(c => (
                          <div key={c.id} className="text-xs p-2 border-b bg-white mb-1 rounded hover:bg-gray-50 flex justify-between items-center group shadow-sm">
                            <div className="truncate flex-1">
                               <div className="font-bold flex items-center gap-1">
                                    <span className="bg-slate-200 text-slate-700 px-1 rounded text-[10px]">{c.code}</span>
                                    {c.name}
                               </div>
                               <div className="text-gray-500">{c.district} ‚Ä¢ Reg: {c.region}</div>
                            </div>
                            <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                               <button onClick={() => loadClientForEdit(c)} className="text-blue-400 hover:text-blue-600"><Edit2 size={14}/></button>
                               <button onClick={() => deleteClient(c.id)} className="text-gray-300 hover:text-red-500"><Trash2 size={14}/></button>
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>
                </div>
              ) : (
                <div className="flex flex-col h-full overflow-hidden">
                  <div className={`p-2 rounded border space-y-2 shrink-0 ${editingProductId ? 'bg-yellow-50 border-yellow-300' : 'bg-white'}`}>
                    {editingProductId && <div className="text-xs font-bold text-yellow-700 uppercase mb-1">Editando Produto</div>}
                    <input className="input-field" placeholder="Nome do Produto" value={pForm.name} onChange={e => setPForm({...pForm, name: e.target.value})} />
                    <div className="flex gap-1">
                        <input className="input-field w-1/2" placeholder="C√≥d. Interno" value={pForm.internalCode} onChange={e => setPForm({...pForm, internalCode: e.target.value})} />
                        <input className="input-field w-1/2" placeholder="C√≥d. Barras" value={pForm.barcode} onChange={e => setPForm({...pForm, barcode: e.target.value})} />
                    </div>
                    <div className="flex gap-1">
                       <select className="input-field w-1/2" value={pForm.category} onChange={e => setPForm({...pForm, category: e.target.value})}>
                          <option value="CESTAS B√ÅSICAS">CESTAS B√ÅSICAS</option>
                          <option value="ALIMENTOS">ALIMENTOS</option>
                          <option value="LIMPEZA">LIMPEZA</option>
                          <option value="HIGIENE">HIGIENE</option>
                       </select>
                       <input className="input-field w-1/2" placeholder="NCM" value={pForm.ncm} onChange={e => setPForm({...pForm, ncm: e.target.value})} />
                    </div>
                    <div className="flex gap-1">
                       <div className="w-1/2"><label className="text-[10px] font-bold text-gray-500">CUSTO</label><input className="input-field" type="number" value={pForm.cost} onChange={e => setPForm({...pForm, cost: e.target.value})} /></div>
                       <div className="w-1/2"><label className="text-[10px] font-bold text-gray-500">VENDA</label><input className="input-field font-bold text-green-700" type="number" value={pForm.price} onChange={e => setPForm({...pForm, price: e.target.value})} /></div>
                    </div>
                    {!pForm.isCombo && !editingProductId && (
                      <div className="bg-white p-2 rounded border border-gray-200">
                         <label className="text-[10px] font-bold text-blue-800">ESTOQUE INICIAL</label>
                         <input className="input-field" type="number" value={pForm.stock} onChange={e => setPForm({...pForm, stock: Number(e.target.value)})} />
                      </div>
                    )}
                    <div className="flex items-center gap-2 mt-2">
                      <input type="checkbox" id="isCombo" checked={pForm.isCombo} onChange={e => setPForm({...pForm, isCombo: e.target.checked})} />
                      <label htmlFor="isCombo" className="text-xs font-bold">√â um Combo?</label>
                    </div>
                    {pForm.isCombo && (
                      <div className="bg-yellow-50 p-2 border border-yellow-200 rounded text-xs space-y-2">
                        <p className="font-bold text-yellow-800">Composi√ß√£o Padr√£o:</p>
                        <div className="max-h-32 overflow-y-auto">
                          {products.filter(p => !p.isCombo).map(p => (
                            <div key={p.id} className="flex justify-between items-center py-1 border-b border-yellow-100">
                              <span>{p.name}</span>
                              <input type="number" className="w-12 border rounded text-center text-xs" placeholder="0"
                                onChange={(e) => {
                                   const qty = Number(e.target.value);
                                   const existing = pForm.comboItems.filter(i => i.id !== p.id);
                                   if (qty > 0) setPForm({...pForm, comboItems: [...existing, {id: p.id, qty}]});
                                   else setPForm({...pForm, comboItems: existing});
                                }}
                              />
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    <div className="flex gap-2">
                      {editingProductId && <button onClick={() => {setEditingProductId(null); setPForm({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] })}} className="w-1/3 bg-gray-400 text-white rounded text-xs font-bold">CANCELAR</button>}
                      <button onClick={saveProduct} className="btn-primary flex-1">{editingProductId ? 'SALVAR ALTERA√á√ïES' : 'CADASTRAR'}</button>
                    </div>
                  </div>

                  <div className="flex-1 flex flex-col min-h-0 mt-4">
                    <div className="flex justify-between items-center mb-2 border-b pb-1 shrink-0">
                        <h3 className="font-bold text-xs text-gray-500">ESTOQUE ({filteredProducts.length})</h3>
                        <input className="text-xs p-1 border rounded w-1/2" placeholder="Buscar Prod..." value={searchProduct} onChange={e => setSearchProduct(e.target.value)}/>
                    </div>
                    <div className="overflow-y-auto scrollbar-thin">
                        {filteredProducts.map(p => (
                          <div key={p.id} className="flex justify-between items-center text-xs py-2 border-b group hover:bg-gray-50 px-1 bg-white mb-1 rounded shadow-sm">
                            <div className="flex-1 cursor-pointer" onClick={() => setHistoryModal(p)}>
                              <div className="font-bold flex items-center gap-1">{p.name} {p.isCombo && <span className="bg-yellow-100 text-yellow-800 text-[9px] px-1 rounded">KIT</span>}</div>
                              <div className="text-[10px] text-gray-500 flex items-center gap-1">Est: {p.stock} ‚Ä¢ {formatCurrency(p.price)}</div>
                            </div>
                            <div className="flex items-center gap-2">
                                {!p.isCombo && (
                                  <div className="flex bg-gray-100 rounded border border-gray-300">
                                    <button onClick={() => setStockModal({product: p, type: 'IN', qty: 0})} className="text-green-700 p-1 hover:bg-green-200 rounded-l transition"><Plus size={14}/></button>
                                    <div className="w-px bg-gray-300"></div>
                                    <button onClick={() => setStockModal({product: p, type: 'OUT', qty: 0})} className="text-red-700 p-1 hover:bg-red-200 rounded-r transition"><Minus size={14}/></button>
                                  </div>
                                )}
                                <button onClick={() => loadProductForEdit(p)} className="text-blue-400 hover:text-blue-600 opacity-0 group-hover:opacity-100"><Edit2 size={14}/></button>
                                <button onClick={() => deleteProduct(p.id)} className="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Trash2 size={14}/></button>
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>

                  {stockModal && (
                    <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center p-4">
                      <div className="bg-white w-64 rounded-lg shadow-xl p-4 flex flex-col gap-3">
                          <h3 className="font-bold text-center text-gray-800 text-sm">Mov: {stockModal.product.name}</h3>
                          <div className={`text-xs font-bold text-center ${stockModal.type === 'IN' ? 'text-green-600' : 'text-red-600'}`}>
                            {stockModal.type === 'IN' ? 'ENTRADA DE ESTOQUE' : 'SA√çDA DE ESTOQUE'}
                          </div>
                          <input autoFocus type="number" className="text-2xl text-center w-full border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none py-2" 
                            value={stockModal.qty || ''} placeholder="0" onChange={e => setStockModal({...stockModal, qty: Number(e.target.value)})}
                          />
                          <div className="flex gap-2 w-full mt-2">
                            <button onClick={() => setStockModal(null)} className="flex-1 bg-gray-200 py-1.5 rounded text-xs font-bold text-gray-600">Cancelar</button>
                            <button onClick={handleStockMove} className={`flex-1 py-1.5 rounded text-xs font-bold text-white ${stockModal.type === 'IN' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}`}>Confirmar</button>
                          </div>
                      </div>
                    </div>
                  )}

                  {historyModal && (
                    <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center p-4">
                       <div className="bg-white w-72 h-96 rounded-lg shadow-xl p-4 flex flex-col">
                           <div className="flex justify-between items-center mb-4 border-b pb-2">
                             <h3 className="font-bold text-gray-800 text-sm truncate w-48">Hist: {historyModal.name}</h3>
                             <button onClick={() => setHistoryModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><XCircle size={16} className="text-gray-500"/></button>
                           </div>
                           <div className="flex-1 overflow-y-auto space-y-2 pr-1 scrollbar-thin">
                             {historyModal.stockHistory?.slice().reverse().map((h, i) => (
                               <div key={i} className="text-xs border-b pb-2 flex justify-between items-center">
                                 <span className="text-gray-500">{formatDateTime(h.date)}</span>
                                 <span className={`font-bold ${h.type === 'INITIAL' || h.type === 'IN' || h.type === 'CANCEL_RETURN' ? 'text-green-600' : 'text-red-600'}`}>
                                   {h.type === 'INITIAL' ? 'Inicial' : h.type === 'IN' ? 'Entrada' : h.type === 'SALE' ? 'Venda' : h.type} ({h.qty})
                                 </span>
                               </div>
                             ))}
                             {(!historyModal.stockHistory || historyModal.stockHistory.length === 0) && <div className="text-center text-gray-400 mt-4 text-xs">Sem hist√≥rico</div>}
                           </div>
                       </div>
                    </div>
                  )}
                </div>
              )}
            </div>
          );
        }

        function POSPanel({ clients, products, setProducts, sales, setSales, saleToEdit, setSaleToEdit }) {
          const [selectedClient, setSelectedClient] = useState('');
          const [clientSearch, setClientSearch] = useState('');
          const [cart, setCart] = useState([]);
          const [payMethod, setPayMethod] = useState('Pix');
          const [changeFor, setChangeFor] = useState(''); 
          const [obs, setObs] = useState(''); 
          const [searchProd, setSearchProd] = useState('');
          const [selectedCategory, setSelectedCategory] = useState('todas');
          const [discount, setDiscount] = useState('');
          const [editingItem, setEditingItem] = useState(null); 
          const [volumes, setVolumes] = useState(1); 
          
          const [tempQty, setTempQty] = useState({});
          
          const [showBatchModal, setShowBatchModal] = useState(false);
          const [batchInput, setBatchInput] = useState('');

          useEffect(() => {
            if (saleToEdit) {
              const client = clients.find(c => c.id === saleToEdit.clientId);
              if (client) {
                setSelectedClient(client.id);
                setClientSearch(client.name);
              }
              setCart(saleToEdit.items.map(i => ({...i, tempId: generateId()})));
              setDiscount(saleToEdit.discount);
              setObs(saleToEdit.obs);
              setPayMethod(saleToEdit.payMethod);
              if (saleToEdit.changeFor) setChangeFor(saleToEdit.changeFor);
              setVolumes(saleToEdit.volumes || 1);
              setSaleToEdit(null); 
            }
          }, [saleToEdit, clients]);

          const categories = ['todas', ...new Set(products.map(p => p.category))];
          const filteredClients = clients.filter(c => c.name.toLowerCase().includes(clientSearch.toLowerCase()));

          const getQty = (id) => tempQty[id] || 1;
          const incQty = (id) => setTempQty({...tempQty, [id]: getQty(id) + 1});
          const decQty = (id) => setTempQty({...tempQty, [id]: Math.max(1, getQty(id) - 1)});

          const addToCart = (product) => {
            const qty = getQty(product.id);
            if (!product.isCombo && product.stock < qty) {
              if (!confirm(`Estoque baixo (${product.stock}). Adicionar ${qty} mesmo assim?`)) return;
            }
            
            const itemsToAdd = [];
            for(let i=0; i<qty; i++) {
               // Clone profundo para combos
               const cartItem = { 
                   ...product, 
                   tempId: generateId(), 
                   originalPrice: product.price,
                   // Se for combo, trazemos uma c√≥pia dos itens para poder editar
                   comboItems: product.isCombo ? product.comboItems.map(ci => ({...ci})) : []
               };
               itemsToAdd.push(cartItem);
            }
            setCart([...cart, ...itemsToAdd]);
            setTempQty({...tempQty, [product.id]: 1}); 
          };

          const removeFromCart = (tempId) => {
            setCart(cart.filter(item => item.tempId !== tempId));
          };

          const updateCartItemPrice = () => {
            if (!editingItem) return;
            setCart(cart.map(i => i.tempId === editingItem.tempId ? { ...i, price: editingItem.price } : i));
            setEditingItem(null);
          };

          const updateComboItemQty = (cartItemTempId, subItemId, newQty) => {
             setCart(cart.map(item => {
                if (item.tempId !== cartItemTempId) return item;
                // Atualiza a qtde do item dentro do combo na cesta
                return {
                    ...item,
                    comboItems: item.comboItems.map(sub => sub.id === subItemId ? {...sub, qty: newQty} : sub)
                };
             }));
          };

          const subTotal = cart.reduce((acc, item) => acc + Number(item.price), 0);
          const total = subTotal - (Number(discount) || 0);

          const finalizeSale = () => {
            if (!selectedClient) return alert('Selecione um cliente');
            if (cart.length === 0) return alert('Carrinho vazio');

            const newProducts = [...products];
            cart.forEach(cartItem => {
              const dbProd = newProducts.find(p => p.id === cartItem.id);
              if (dbProd) {
                if (dbProd.isCombo) {
                  // Baixa estoque baseado na configura√ß√£o DO CARRINHO (editada)
                  cartItem.comboItems?.forEach(ing => {
                     const dbIng = newProducts.find(p => p.id === ing.id);
                     if (dbIng) {
                       dbIng.stock -= ing.qty;
                       dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'SALE_COMBO', qty: ing.qty, ref: cartItem.name });
                     }
                  });
                } else {
                  dbProd.stock -= 1;
                  dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'SALE', qty: 1 });
                }
              }
            });
            setProducts(newProducts);
            
            // Gera ID curto di√°rio
            const shortId = generateDailyId(sales);

            const newSale = {
              id: shortId, // Novo ID curto
              fullId: generateId(), // ID √∫nico interno
              clientId: selectedClient,
              items: cart,
              subTotal,
              discount: Number(discount) || 0,
              total,
              payMethod,
              changeFor: payMethod === 'Dinheiro' ? changeFor : null,
              obs,
              date: new Date().toISOString(),
              status: 'Pendente',
              printedLabel: false,
              printedList: false,
              volumes: volumes, // Salva qtde volumes
              routeId: null
            };

            setSales([...sales, newSale]);
            
            setCart([]);
            setSelectedClient('');
            setClientSearch('');
            setObs('');
            setChangeFor('');
            setDiscount('');
            setVolumes(1);
            alert(`Venda #${shortId} Realizada!`);
          };
          
          const processBatchInput = () => {
            const lines = batchInput.split('\n');
            const newItems = [];
            const notFound = [];
            
            lines.forEach(line => {
                if(!line.trim()) return;
                const parts = line.split(/[|\t;]+/); 
                const code = parts[0]?.trim();
                const qtyStr = parts[1]?.trim();
                const qty = parseInt(qtyStr) || 1;

                if (code) {
                    const product = products.find(p => p.internalCode === code);
                    if (product) {
                        for(let i=0; i<qty; i++) {
                            newItems.push({ 
                                ...product, 
                                tempId: generateId(), 
                                originalPrice: product.price,
                                comboItems: product.isCombo ? product.comboItems.map(ci => ({...ci})) : []
                            });
                        }
                    } else {
                        notFound.push(code);
                    }
                }
            });

            if (newItems.length > 0) {
                setCart(prev => [...prev, ...newItems]);
                setBatchInput('');
                setShowBatchModal(false);
                if (notFound.length > 0) alert(`Itens adicionados, mas c√≥digos n√£o encontrados: ${notFound.join(', ')}`);
            } else {
                alert('Nenhum produto v√°lido encontrado na lista.');
            }
          };

          const filteredProducts = products.filter(p => 
            (selectedCategory === 'todas' || p.category === selectedCategory) &&
            p.name.toLowerCase().includes(searchProd.toLowerCase())
          );

          return (
            <div className="flex flex-col h-full gap-2 relative p-2">
              <div className="bg-white p-2 rounded border border-gray-300 shadow-sm shrink-0">
                <label className="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-1 mb-1"><Users size={10}/> Buscar Cliente</label>
                <div className="relative">
                  <input 
                    className="input-field" 
                    placeholder="Digite para buscar..." 
                    value={clientSearch}
                    onChange={e => { setClientSearch(e.target.value); setSelectedClient(''); }}
                  />
                  {clientSearch && !selectedClient && (
                    <div className="absolute top-full left-0 w-full bg-white border shadow-lg max-h-40 overflow-y-auto z-20 rounded-b">
                       {filteredClients.map(c => (
                         <div key={c.id} 
                              className="p-2 hover:bg-blue-50 cursor-pointer text-xs border-b flex justify-between"
                              onClick={() => { setSelectedClient(c.id); setClientSearch(c.name); }}
                         >
                            <span className="font-bold">{c.name}</span>
                            <span className="text-gray-500">{c.district}</span>
                         </div>
                       ))}
                       {filteredClients.length === 0 && <div className="p-2 text-xs text-gray-400">Nenhum cliente encontrado</div>}
                    </div>
                  )}
                </div>
                {selectedClient && (
                   <div className="text-[10px] text-green-600 mt-1 font-bold flex items-center gap-1"><CheckCircle size={10}/> Cliente Selecionado</div>
                )}
              </div>

              <div className="flex-1 flex flex-col min-h-0 bg-white border rounded shadow-sm">
                <div className="p-2 border-b bg-gray-50 space-y-2 shrink-0">
                  <div className="flex gap-2">
                     <select className="input-field w-1/3" value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)}>
                        <option value="todas">Todas</option>
                        {categories.filter(c => c!=='todas').map(c => <option key={c} value={c}>{c}</option>)}
                     </select>
                     <div className="relative w-2/3 flex gap-1">
                        <input className="w-full px-2 py-1 text-sm border rounded focus:outline-none focus:border-blue-500" placeholder="Buscar Produto..." value={searchProd} onChange={e => setSearchProd(e.target.value)}/>
                        <button onClick={() => setShowBatchModal(true)} className="bg-slate-200 p-1 rounded hover:bg-slate-300 text-slate-600" title="Colar Lista"><Clipboard size={16}/></button>
                     </div>
                  </div>
                </div>
                <div className="flex-1 overflow-y-auto p-1 scrollbar-thin">
                  {filteredProducts.map(p => (
                    <div key={p.id} className="p-2 border-b bg-white flex justify-between items-center group mb-1 rounded">
                      <div className="flex-1 cursor-pointer" onClick={() => addToCart(p)}>
                        <div className="font-bold text-xs group-hover:text-blue-700">{p.name}</div>
                        <div className="text-[10px] text-gray-400">Estoque: {p.stock}</div>
                        <div className="font-bold text-xs text-green-700">{formatCurrency(p.price)}</div>
                      </div>
                      <div className="flex items-center gap-1 bg-gray-100 rounded p-1">
                         <button onClick={() => decQty(p.id)} className="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-200">-</button>
                         <span className="w-6 text-center text-xs font-bold">{getQty(p.id)}</span>
                         <button onClick={() => incQty(p.id)} className="w-6 h-6 flex items-center justify-center bg-white border rounded hover:bg-gray-200">+</button>
                         <button onClick={() => addToCart(p)} className="ml-2 bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold hover:bg-blue-500">ADD</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="bg-white border-t p-2 shadow-lg flex flex-col gap-2 shrink-0">
                <div className="flex justify-between items-center bg-slate-100 p-2 rounded">
                  <span className="font-bold text-xs">ITENS: {cart.length}</span>
                  <span className="font-bold text-lg text-green-700">{formatCurrency(total)}</span>
                </div>
                
                <div className="flex gap-2 max-h-32 overflow-y-auto border p-1 rounded bg-gray-50 scrollbar-thin flex-col">
                   {cart.length === 0 && <div className="text-gray-400 text-xs w-full text-center mt-2">Carrinho Vazio</div>}
                   <div className="w-full space-y-1">
                      {cart.map(item => (
                        <div key={item.tempId} className="flex flex-col bg-white p-1 rounded border shadow-sm">
                          <div className="flex justify-between items-center text-xs">
                             <span className="truncate w-1/2 font-bold">{item.name}</span>
                             <div className="flex items-center gap-2">
                                <span className="text-yellow-600 cursor-pointer hover:underline font-bold" onClick={() => setEditingItem({tempId: item.tempId, price: item.price})}>
                                  {formatCurrency(item.price)}
                                </span>
                                <Trash2 size={12} className="text-red-400 cursor-pointer hover:text-red-600" onClick={() => removeFromCart(item.tempId)} />
                             </div>
                          </div>
                          {/* √Årea de Edi√ß√£o de Combo */}
                          {item.isCombo && (
                             <div className="mt-1 bg-yellow-50 p-1 rounded text-[10px] space-y-1 border border-yellow-100">
                                {item.comboItems.map(ci => {
                                    const prodInfo = products.find(p => p.id === ci.id);
                                    return (
                                        <div key={ci.id} className="flex justify-between items-center">
                                            <span className="text-gray-600 truncate">{prodInfo?.name || 'Item'}</span>
                                            <div className="flex items-center bg-white border rounded">
                                                <button className="px-1 hover:bg-gray-100" onClick={() => updateComboItemQty(item.tempId, ci.id, Math.max(0, ci.qty - 1))}>-</button>
                                                <span className="px-1 font-bold w-6 text-center">{ci.qty}</span>
                                                <button className="px-1 hover:bg-gray-100" onClick={() => updateComboItemQty(item.tempId, ci.id, ci.qty + 1)}>+</button>
                                            </div>
                                        </div>
                                    );
                                })}
                             </div>
                          )}
                        </div>
                      ))}
                   </div>
                </div>
                
                <div className="flex gap-2">
                    <div className="flex items-center gap-1 bg-white border rounded px-1 w-1/3">
                      <Percent size={10} className="text-gray-400"/>
                      <input type="number" className="input-field border-none p-1" placeholder="Desc R$" value={discount} onChange={e => setDiscount(e.target.value)}/>
                    </div>
                    <select className="input-field w-1/3" value={payMethod} onChange={e => setPayMethod(e.target.value)}>
                      <option value="Pix">Pix</option>
                      <option value="Dinheiro">Dinheiro</option>
                      <option value="Cart√£o">Cart√£o</option>
                    </select>
                    {payMethod === 'Dinheiro' && (
                        <input type="number" className="input-field w-1/3" placeholder="Troco p/" value={changeFor} onChange={e => setChangeFor(e.target.value)} />
                    )}
                </div>
                
                <div className="flex gap-2 items-center">
                    <input className="input-field flex-1" placeholder="Observa√ß√£o do Pedido" value={obs} onChange={e => setObs(e.target.value)} />
                    <div className="flex items-center bg-white border rounded px-2 gap-1 w-24" title="Quantidade de Volumes">
                        <Box size={14} className="text-gray-500"/>
                        <select className="bg-transparent text-xs font-bold outline-none w-full py-1.5" value={volumes} onChange={e => setVolumes(Number(e.target.value))}>
                            {[1,2,3,4,5,6,7,8,9,10].map(n => <option key={n} value={n}>{n} Vol</option>)}
                        </select>
                    </div>
                </div>

                <button onClick={finalizeSale} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded text-sm shadow uppercase">FINALIZAR VENDA</button>
              </div>

              {editingItem && (
                <div className="absolute inset-0 bg-black/50 z-20 flex flex-col items-center justify-center p-4">
                  <div className="bg-white p-4 rounded shadow-lg flex flex-col gap-2 w-64">
                      <label className="text-xs font-bold">Novo Pre√ßo para este item</label>
                      <input type="number" autoFocus className="input-field text-center text-lg" value={editingItem.price} onChange={e => setEditingItem({...editingItem, price: e.target.value})}/>
                      <div className="flex gap-2">
                        <button onClick={() => setEditingItem(null)} className="flex-1 bg-gray-200 py-2 rounded text-xs">Cancelar</button>
                        <button onClick={updateCartItemPrice} className="flex-1 bg-green-600 text-white py-2 rounded text-xs font-bold">Salvar</button>
                      </div>
                  </div>
                </div>
              )}

              {/* Batch Import Modal */}
              {showBatchModal && (
                <div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center p-4">
                  <div className="bg-white p-4 rounded shadow-lg flex flex-col gap-2 w-72">
                      <h3 className="font-bold text-sm text-gray-800">Importar por C√≥digo Interno</h3>
                      <p className="text-[10px] text-gray-500">Cole a lista no formato:<br/>C√ìDIGO | QUANTIDADE</p>
                      <textarea 
                        className="border p-2 text-xs h-32 rounded focus:outline-none focus:border-blue-500" 
                        placeholder="Ex:&#10;020 | 2&#10;102 | 1"
                        value={batchInput}
                        onChange={e => setBatchInput(e.target.value)}
                      />
                      <div className="flex gap-2">
                        <button onClick={() => setShowBatchModal(false)} className="flex-1 bg-gray-200 py-2 rounded text-xs font-bold">Cancelar</button>
                        <button onClick={processBatchInput} className="flex-1 bg-blue-600 text-white py-2 rounded text-xs font-bold hover:bg-blue-700">PROCESSAR</button>
                      </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        function ExpeditionPanel({ sales, setSales, clients, products, setProducts, onEditSale }) {
          const updateStatus = (saleId, newStatus) => {
            setSales(sales.map(s => s.id === saleId ? { ...s, status: newStatus } : s));
          };

          const togglePrint = (saleId, field) => {
            setSales(sales.map(s => s.id === saleId ? { ...s, [field]: !s[field] } : s));
          };

          const returnStock = (sale) => {
             const newProducts = [...products];
             sale.items.forEach(item => {
              const dbProd = newProducts.find(p => p.id === item.id);
              if (dbProd) {
                if (dbProd.isCombo) {
                   // Devolve estoque baseado no que foi salvo na venda (item.comboItems pode ter sido editado)
                   item.comboItems?.forEach(ing => {
                     const dbIng = newProducts.find(p => p.id === ing.id);
                     if (dbIng) {
                       dbIng.stock += ing.qty;
                       dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: ing.qty });
                     }
                   });
                } else {
                  dbProd.stock += 1;
                  dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: 1 });
                }
              }
             });
             setProducts(newProducts);
          }

          const deleteSale = (sale) => {
            if (!confirm(`Excluir permanentemente a venda de ${formatCurrency(sale.total)}? Estoque ser√° devolvido.`)) return;
            returnStock(sale);
            setSales(sales.filter(s => s.id !== sale.id));
          };

          const handleEdit = (sale) => {
             if(!confirm("Editar esta venda? Ela ser√° removida da expedi√ß√£o e os itens voltar√£o para o carrinho.")) return;
             returnStock(sale);
             setSales(sales.filter(s => s.id !== sale.id));
             onEditSale(sale);
          };

          const printLabel = (sale, client) => {
            const volCount = sale.volumes || 1;
            
            // Gerar m√∫ltiplas etiquetas se > 1 volume
            let labelsHtml = '';
            for (let i = 1; i <= volCount; i++) {
                labelsHtml += `
                <div class="label">
                    <div class="header">
                        <span class="region">${client.region || 'GERAL'}</span>
                        <span class="order-id">#${sale.id}</span>
                    </div>
                    
                    <div class="client-info">
                        <strong>${client.name.substring(0,25)}</strong><br/>
                        ${client.district}
                    </div>

                    <div class="footer">
                        <div class="obs">
                            <strong>OBS:</strong> ${sale.obs || '-'}
                        </div>
                        <div class="volume">
                            ${i}/${volCount}
                        </div>
                    </div>
                </div>`;
            }

            const w = window.open('', '', 'width=400,height=500');
            w.document.write(`
              <html>
              <head>
                <style>
                    @page { size: 76mm 100mm; margin: 0; }
                    body { margin: 0; padding: 0; font-family: sans-serif; }
                    .label {
                        width: 76mm;
                        height: 100mm;
                        padding: 5mm;
                        box-sizing: border-box;
                        display: flex;
                        flex-direction: column;
                        page-break-after: always;
                        border: 1px solid #ddd; /* Visual apenas na tela, some no papel */
                    }
                    .header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-bottom: 2px solid #000;
                        padding-bottom: 5px;
                        margin-bottom: 5px;
                    }
                    .region { font-size: 20px; font-weight: bold; }
                    .order-id { font-size: 32px; font-weight: 900; }
                    
                    .client-info {
                        font-size: 16px;
                        margin-bottom: 10px;
                        line-height: 1.2;
                        flex: 1;
                    }
                    
                    .footer {
                        border-top: 2px solid #000;
                        padding-top: 5px;
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-end;
                    }
                    .obs { font-size: 14px; max-width: 70%; word-break: break-word; }
                    .volume { font-size: 24px; font-weight: bold; }
                    
                    @media print {
                        .label { border: none; }
                    }
                </style>
              </head>
              <body>
                ${labelsHtml}
                <script>
                    window.onload = function() { setTimeout(function(){ window.print(); }, 500); }
                <\/script>
              </body>
              </html>
            `);
            // REMOVIDO: w.document.close(); O usu√°rio deve fechar a janela manualmente.
            // w.document.close() √© importante para terminar o stream, mas o window.close() do script foi removido.
            w.document.close(); 
          };

          const printPickingList = (sale, client) => {
            const w = window.open('', '', 'width=400,height=600');
            
            // Monta lista de itens, explodindo combos
            let itemsHtml = '';
            sale.items.forEach(item => {
                if (item.isCombo) {
                    itemsHtml += `<li class="combo-title">${item.name}</li>`;
                    // Lista os componentes salvos na venda
                    item.comboItems.forEach(ci => {
                        const prodRef = products.find(p => p.id === ci.id);
                        if (ci.qty > 0) {
                            itemsHtml += `<li class="combo-item">[ ] ${ci.qty}x ${prodRef?.name || 'Item'} <span class="code">(${prodRef?.internalCode || '-'})</span></li>`;
                        }
                    });
                } else {
                     itemsHtml += `<li>[ ] 1x ${item.name} <span class="code">(${item.internalCode || '-'})</span></li>`;
                }
            });

            w.document.write(`
              <html>
              <head>
                <style>
                    @page { size: 76mm 100mm; margin: 0; }
                    body { margin: 0; padding: 5mm; font-family: sans-serif; font-size: 14px; }
                    h2 { margin: 0 0 5px 0; border-bottom: 2px solid #000; font-size: 18px; display: flex; justify-content: space-between; }
                    .client { font-weight: bold; font-size: 16px; margin-bottom: 10px; display: block; }
                    ul { list-style: none; padding: 0; margin: 0; }
                    li { margin-bottom: 4px; border-bottom: 1px dashed #ccc; padding-bottom: 2px; }
                    .combo-title { font-weight: bold; border-bottom: none; margin-top: 5px; text-transform: uppercase; }
                    .combo-item { padding-left: 10px; font-size: 12px; }
                    .code { font-size: 10px; color: #555; }
                    .footer { margin-top: 10px; font-size: 12px; font-weight: bold; }
                </style>
              </head>
              <body>
                <h2><span>SEPARA√á√ÉO</span> <span>#${sale.id}</span></h2>
                <span class="client">${client.name}</span>
                <ul>
                    ${itemsHtml}
                </ul>
                <div class="footer">
                    OBS: ${sale.obs || ''}
                </div>
                <script>
                    window.onload = function() { setTimeout(function(){ window.print(); }, 500); }
                <\/script>
              </body>
              </html>
            `);
            w.document.close();
          };

          const activeSales = sales.filter(s => s.status !== 'Entregue').sort((a,b) => new Date(a.date) - new Date(b.date));

          return (
            <div className="space-y-2 h-full overflow-y-auto pb-4 p-2 scrollbar-thin">
              {activeSales.map(sale => {
                const client = clients.find(c => c.id === sale.clientId) || {};
                const isPendente = sale.status === 'Pendente';
                const isMontagem = sale.status === 'Montagem';
                
                return (
                  <div key={sale.id} className={`p-2 border rounded shadow-sm relative group transition-all bg-white ${isPendente ? 'border-red-300' : isMontagem ? 'border-yellow-300' : 'border-green-300'}`}>
                     
                     <div className="flex justify-between items-start mb-2 bg-gray-50 p-1 rounded">
                        <span className="font-bold text-lg text-gray-800">#{sale.id}</span>
                        <div className="flex gap-2">
                           <button onClick={() => handleEdit(sale)} className="text-blue-500 hover:text-blue-700 flex items-center gap-1 text-[10px] font-bold border border-blue-200 px-1 rounded bg-white"><Edit2 size={10}/> EDITAR</button>
                           <button onClick={() => deleteSale(sale)} className="text-red-400 hover:text-red-600"><Trash2 size={14}/></button>
                        </div>
                     </div>
                     
                     <div className="font-bold text-sm leading-tight mb-1">{client.name}</div>
                     <div className="text-xs text-gray-500 mb-2">{client.district} ‚Ä¢ {client.region || 'CBA'}</div>
                     
                     <div className="bg-white p-1.5 rounded text-[10px] text-gray-700 mb-2 border border-gray-200 shadow-inner">
                       {sale.items.map(i => i.isCombo ? `[KIT] ${i.name}` : i.name).join(', ')}
                     </div>

                     <div className="grid grid-cols-2 gap-2 mb-2">
                        <button onClick={() => printLabel(sale, client)} className={`flex items-center justify-center gap-1 text-[10px] border rounded py-1 ${sale.printedLabel ? 'bg-green-100 border-green-300 text-green-700' : 'bg-gray-50 hover:bg-gray-100'}`}>
                           <Tag size={10}/> {sale.printedLabel ? 'Etiqueta OK' : 'Etiqueta'}
                        </button>
                        <button onClick={() => printPickingList(sale, client)} className={`flex items-center justify-center gap-1 text-[10px] border rounded py-1 ${sale.printedList ? 'bg-green-100 border-green-300 text-green-700' : 'bg-gray-50 hover:bg-gray-100'}`}>
                           <List size={10}/> {sale.printedList ? 'Lista OK' : 'Lista'}
                        </button>
                     </div>
                     
                     <div className="flex gap-4 text-[10px] text-gray-500 mb-2 justify-center">
                        <label className="flex items-center gap-1"><input type="checkbox" checked={sale.printedLabel} onChange={() => togglePrint(sale.id, 'printedLabel')} /> J√° imprimi etiqueta</label>
                        <label className="flex items-center gap-1"><input type="checkbox" checked={sale.printedList} onChange={() => togglePrint(sale.id, 'printedList')} /> J√° imprimi lista</label>
                     </div>

                     <div className="flex justify-between items-center mt-2 border-t pt-2 border-dashed border-gray-300">
                       <span className="text-[10px] font-bold uppercase tracking-wider text-gray-400">{sale.status}</span>
                       {isPendente && <button onClick={() => updateStatus(sale.id, 'Montagem')} className="bg-red-500 text-white text-xs px-3 py-1.5 rounded font-bold shadow hover:bg-red-600 transition">INICIAR</button>}
                       {isMontagem && <button onClick={() => updateStatus(sale.id, 'Rota')} className="bg-yellow-500 text-white text-xs px-3 py-1.5 rounded font-bold shadow hover:bg-yellow-600 transition">PRONTO</button>}
                       {sale.status === 'Rota' && <span className="text-xs text-green-600 font-bold flex items-center gap-1"><CheckCircle size={12}/> AGUARDANDO ROTA</span>}
                     </div>
                  </div>
                );
              })}
              {activeSales.length === 0 && <div className="text-center text-gray-400 text-xs mt-10 p-4 border-2 border-dashed border-gray-200 rounded">Expedi√ß√£o Vazia</div>}
            </div>
          );
        }

        function LogisticsPanel({ sales, setSales, clients, companyPhone }) {
          const [selectedRoute, setSelectedRoute] = useState('Todas');
          const [routeSales, setRouteSales] = useState([]); 

          useEffect(() => {
            const ready = sales.filter(s => s.status === 'Rota');
            const filtered = selectedRoute === 'Todas' 
              ? ready 
              : ready.filter(s => {
                  const c = clients.find(cl => cl.id === s.clientId);
                  const region = c?.region || c?.route;
                  return region === selectedRoute;
                });
            setRouteSales(filtered);
          }, [sales, selectedRoute, clients]);

          const routes = [...new Set(clients.map(c => c.region || c.route).filter(Boolean))];

          const moveOrder = (index, direction) => {
            const newOrder = [...routeSales];
            if (direction === 'up' && index > 0) {
              [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
            } else if (direction === 'down' && index < newOrder.length - 1) {
              [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
            }
            setRouteSales(newOrder);
          };

          const generateDriverLink = () => {
            if (routeSales.length === 0) return alert("Nada para entregar!");
            
            // Otimizando payload para reduzir tamanho da URL
            const payload = {
              route: selectedRoute,
              companyPhone, 
              generatedAt: new Date(),
              orders: routeSales.map(s => {
                const c = clients.find(cl => cl.id === s.clientId);
                return {
                  id: s.id, 
                  customer: c.name,
                  phone: c.phone,
                  address: c.address,
                  district: c.district,
                  region: c.region,
                  map: c.mapLink,
                  total: s.total,
                  pay: s.payMethod,
                  change: s.changeFor ? s.changeFor - s.total : 0,
                  obs: s.obs,
                  clientObs: c.obs
                };
              })
            };

            const encoded = encodeURIComponent(btoa(JSON.stringify(payload)));
            const link = `${window.location.origin}${window.location.pathname}#driver=${encoded}`;
            
            // Tenta usar a API moderna de clipboard
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(link).then(() => {
                    alert("LINK COPIADO! Envie para o entregador.");
                }).catch(() => {
                    // Fallback
                    copyToClipboardFallback(link);
                });
            } else {
                copyToClipboardFallback(link);
            }
          };
          
          const copyToClipboardFallback = (text) => {
             const textArea = document.createElement("textarea");
             textArea.value = text;
             textArea.style.position = "fixed";
             document.body.appendChild(textArea);
             textArea.focus();
             textArea.select();
             try {
                document.execCommand('copy');
                alert("LINK COPIADO! Envie para o entregador.");
             } catch (err) {
                prompt("Copie o link manualmente:", text);
             }
             document.body.removeChild(textArea);
          };

          const forceDelivery = (id) => {
            if (confirm("Marcar como entregue manualmente?")) {
              setSales(sales.map(s => s.id === id ? { ...s, status: 'Entregue' } : s));
            }
          };

          const totalValue = routeSales.reduce((acc, s) => acc + s.total, 0);

          return (
            <div className="flex flex-col h-full space-y-2 p-2">
              <div className="bg-indigo-50 p-2 rounded border border-indigo-100 space-y-2">
                <label className="text-[10px] font-bold text-indigo-800 uppercase">1. Filtrar Regi√£o</label>
                <div className="flex gap-2">
                  <select className="flex-1 input-field bg-white" value={selectedRoute} onChange={e => setSelectedRoute(e.target.value)}>
                    <option value="Todas">Todas</option>
                    {routes.map(r => <option key={r} value={r}>{r}</option>)}
                  </select>
                  <button onClick={generateDriverLink} className="bg-indigo-600 text-white px-3 rounded hover:bg-indigo-700 shadow flex items-center gap-2 text-xs font-bold" title="Criar Link">
                    <Share2 size={14} /> CRIAR LINK
                  </button>
                </div>
              </div>

              {routeSales.length > 0 && (
                <div className="flex justify-between items-center text-xs px-2 py-1 bg-white border rounded text-gray-500">
                   <span>{routeSales.length} Entregas</span>
                   <span className="font-bold text-green-700">Total: {formatCurrency(totalValue)}</span>
                </div>
              )}

              <div className="flex-1 overflow-y-auto space-y-2 p-1 bg-gray-50 border rounded scrollbar-thin">
                 {routeSales.map((s, idx) => {
                   const client = clients.find(c => c.id === s.clientId) || {};
                   return (
                     <div key={s.id} className="bg-white p-2 rounded shadow-sm border-l-4 border-indigo-500 flex gap-2 relative">
                        <div className="flex flex-col justify-center gap-1 border-r pr-2 text-gray-400">
                          <button onClick={() => moveOrder(idx, 'up')} className="hover:text-indigo-600"><ArrowUp size={14}/></button>
                          <span className="text-center font-bold text-xs text-indigo-900 bg-indigo-100 rounded">{idx + 1}¬∫</span>
                          <button onClick={() => moveOrder(idx, 'down')} className="hover:text-indigo-600"><ArrowDown size={14}/></button>
                        </div>
                        <div className="flex-1 min-w-0">
                           <div className="flex justify-between">
                             <div className="flex gap-2 items-center">
                                <span className="bg-slate-800 text-white px-1.5 rounded text-xs font-bold">#{s.id}</span>
                                <span className="font-bold text-sm text-gray-800 truncate">{client.name}</span>
                             </div>
                             <button onClick={() => forceDelivery(s.id)} className="text-gray-300 hover:text-green-500"><CheckCircle size={14}/></button>
                           </div>
                           <div className="text-xs text-gray-500 truncate">{client.address}</div>
                           
                           <div className="mt-1 flex flex-wrap gap-1 text-[10px]">
                              <span className="bg-gray-200 px-1 rounded">{s.payMethod}</span>
                              <span className="bg-green-100 text-green-800 px-1 rounded font-bold">{formatCurrency(s.total)}</span>
                              {s.changeFor && <span className="bg-red-100 text-red-800 px-1 rounded font-bold">Troco: {formatCurrency(s.changeFor - s.total)}</span>}
                           </div>
                           {s.obs && <div className="text-[10px] text-orange-600 font-bold mt-1 truncate">OBS: {s.obs}</div>}
                           {client.obs && <div className="text-[10px] text-purple-600 font-bold mt-1 truncate">CLI: {client.obs}</div>}
                        </div>
                     </div>
                   );
                 })}
                 {routeSales.length === 0 && <div className="text-center text-xs text-gray-400 mt-4">Nenhuma entrega nesta rota.</div>}
              </div>
              <div className="text-[10px] text-gray-400 text-center">Ordene a sequ√™ncia com as setas.</div>
            </div>
          );
        }

        function CRMPanel({ sales, clients, products }) {
          const [startDate, setStartDate] = useState(new Date().toISOString().slice(0, 10));
          const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
          const [reportType, setReportType] = useState('produto'); 

          const filterSales = sales.filter(s => {
            const d = s.date.slice(0, 10);
            return d >= startDate && d <= endDate;
          });

          const totalSold = filterSales.reduce((acc, s) => acc + s.total, 0);
          const deliveredSales = filterSales.filter(s => s.status === 'Entregue');
          const deliveredTotal = deliveredSales.reduce((acc, s) => acc + s.total, 0);
          
          const generateReportData = () => {
             const data = {};
             filterSales.forEach(s => {
                const client = clients.find(c => c.id === s.clientId) || {};
                
                if (reportType === 'produto') {
                    s.items.forEach(i => data[i.name] = (data[i.name] || 0) + 1);
                } else if (reportType === 'cidade') {
                    const k = client.city || 'N/A';
                    data[k] = (data[k] || 0) + 1;
                } else if (reportType === 'bairro') {
                    const k = client.district || 'N/A';
                    data[k] = (data[k] || 0) + 1;
                } else if (reportType === 'pagamento') {
                    data[s.payMethod] = (data[s.payMethod] || 0) + 1;
                } else if (reportType === 'rota') {
                    const k = client.region || client.route || 'Geral';
                    data[k] = (data[k] || 0) + 1;
                }
             });
             return Object.entries(data).sort((a,b) => b[1] - a[1]);
          };

          const reportData = generateReportData();

          return (
            <div className="space-y-4 h-full overflow-y-auto pb-10 p-2 scrollbar-thin">
              <div className="bg-white p-2 rounded border shadow-sm">
                <div className="flex gap-2 mb-2">
                   <div className="flex-1">
                      <label className="text-[10px] font-bold text-gray-500">IN√çCIO</label>
                      <input type="date" className="input-field" value={startDate} onChange={e => setStartDate(e.target.value)} />
                   </div>
                   <div className="flex-1">
                      <label className="text-[10px] font-bold text-gray-500">FIM</label>
                      <input type="date" className="input-field" value={endDate} onChange={e => setEndDate(e.target.value)} />
                   </div>
                </div>
                <div>
                   <label className="text-[10px] font-bold text-gray-500">TIPO DE RELAT√ìRIO</label>
                   <select className="input-field" value={reportType} onChange={e => setReportType(e.target.value)}>
                      <option value="produto">Por Produto</option>
                      <option value="cidade">Por Cidade</option>
                      <option value="bairro">Por Bairro</option>
                      <option value="pagamento">Por Forma de Pagamento</option>
                      <option value="rota">Por Rota/Regi√£o</option>
                   </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-2">
                <div className="bg-green-50 border border-green-200 rounded p-2 text-center">
                  <div className="text-[10px] font-bold text-green-800 uppercase">Recebido</div>
                  <div className="text-lg font-bold text-green-700">{formatCurrency(deliveredTotal)}</div>
                </div>
                <div className="bg-blue-50 border border-blue-200 rounded p-2 text-center">
                  <div className="text-[10px] font-bold text-blue-800 uppercase">Total Vendas</div>
                  <div className="text-lg font-bold text-blue-700">{formatCurrency(totalSold)}</div>
                </div>
              </div>

              <div className="bg-white border rounded p-2">
                <h3 className="font-bold text-xs mb-2 text-gray-600 border-b pb-1 uppercase">Relat√≥rio: {reportType}</h3>
                {reportData.map(([name, qty], i) => (
                  <div key={name} className="flex justify-between text-xs py-1 border-b border-gray-50 last:border-0">
                    <span>{i+1}. {name}</span>
                    <span className="font-mono bg-gray-100 px-1 rounded font-bold">{qty}</span>
                  </div>
                ))}
                {reportData.length === 0 && <div className="text-xs text-gray-400 text-center py-2">Sem dados.</div>}
              </div>
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
