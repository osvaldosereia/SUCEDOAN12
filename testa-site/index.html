<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAS | Sandbox Pro Universal</title>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #38bdf8;
            --accent: #22c55e;
            --text: #f1f5f9;
            --border: #334155;
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.4; }

        #ui-wrapper { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        
        .card { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 1.5rem; }
        
        h2 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--primary); margin-bottom: 1rem; }

        textarea { 
            width: 100%; height: 200px; padding: 1rem; background: #000; color: #0f0; 
            border: 1px solid var(--border); border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85rem;
        }

        .upload-zone { 
            border: 2px dashed var(--border); padding: 2rem; text-align: center; border-radius: var(--radius); 
            cursor: pointer; transition: 0.3s; margin-bottom: 1rem;
        }
        .upload-zone:hover { border-color: var(--primary); background: #1e293b; }

        .file-item {
            display: grid;
            grid-template-columns: 1.5fr 2fr auto;
            gap: 10px;
            align-items: center;
            background: #0f172a;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            border: 1px solid var(--border);
        }

        .file-item input {
            background: #1e293b;
            border: 1px solid var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .btn-run {
            position: sticky; bottom: 20px; width: 100%; background: var(--accent);
            color: #000; border: none; padding: 1.2rem; border-radius: var(--radius);
            font-size: 1.1rem; font-weight: 800; cursor: pointer; box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        #preview-frame { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; border: none; display: none; z-index: 10; background: white; }
        #back-btn {
            position: fixed; bottom: 20px; left: 20px; z-index: 100;
            width: 50px; height: 50px; border-radius: 50%; background: var(--primary);
            display: none; align-items: center; justify-content: center; border: none; cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="ui-wrapper">
    <header style="margin-bottom: 2rem;">
        <h1>SISTEMAS <span style="color: var(--primary)">SANDBOX</span></h1>
        <p style="opacity: 0.7;">Arraste o index.html e outros arquivos (fotos, jsons, etc) para simular um servidor.</p>
    </header>

    <div class="card">
        <h2>1. Código HTML Principal</h2>
        <textarea id="code-editor" placeholder="Cole o HTML aqui ou arraste um arquivo .html..."></textarea>
    </div>

    <div class="card">
        <h2>2. Recursos e Arquivos de Suporte</h2>
        <div class="upload-zone" onclick="document.getElementById('file-input').click()">
            <p>Clique ou arraste qualquer arquivo aqui (imagens, vídeos, pdf, json)</p>
            <input type="file" id="file-input" multiple class="hidden">
        </div>
        <div id="file-list"></div>
    </div>

    <button class="btn-run" id="run-btn">CONFIGURAR E LANÇAR</button>
</div>

<button id="back-btn" onclick="location.reload()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
</button>

<iframe id="preview-frame"></iframe>

<script>
    const storage = { html: "", files: {} };
    const editor = document.getElementById('code-editor');
    const fileListDiv = document.getElementById('file-list');

    // Converte arquivos binários para String Base64 para que possam ser injetados no iframe
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    async function handleFiles(files) {
        for (const file of files) {
            const id = Math.random().toString(36).substr(2, 9);
            
            // Se for um HTML, assumimos que é o código principal
            if (file.name.endsWith('.html')) {
                const content = await file.text();
                editor.value = content;
                storage.html = content;
            } else {
                // Qualquer outro tipo de arquivo vai para a lista de "assets"
                const base64Data = await fileToBase64(file);
                storage.files[id] = {
                    name: file.name,
                    type: file.type,
                    data: base64Data,
                    virtualPath: file.name
                };
                renderFileList();
            }
        }
    }

    function renderFileList() {
        fileListDiv.innerHTML = '';
        Object.keys(storage.files).forEach(id => {
            const file = storage.files[id];
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <span style="font-size: 0.75rem; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">
                    ${file.name}
                </span>
                <input type="text" value="${file.virtualPath}" placeholder="Caminho/Rota" 
                    oninput="storage.files['${id}'].virtualPath = this.value">
                <button onclick="delete storage.files['${id}']; renderFileList()" style="background:none; border:none; color:#ff4444; cursor:pointer;">✕</button>
            `;
            fileListDiv.appendChild(div);
        });
    }

    document.getElementById('file-input').onchange = (e) => handleFiles(e.target.files);

    document.getElementById('run-btn').onclick = () => {
        const html = editor.value;
        if (!html) return alert("Por favor, insira o código HTML no editor!");

        const mockMap = {};
        Object.values(storage.files).forEach(f => {
            mockMap[f.virtualPath] = { data: f.data, type: f.type };
        });

        const injection = `
            <script>
                (function() {
                    const _MOCK_FILES = ${JSON.stringify(mockMap)};
                    const _originalFetch = window.fetch;

                    window.fetch = async (input, init) => {
                        let url = typeof input === 'string' ? input : input.url;
                        const cleanUrl = url.replace(/^\\.\\//, '').replace(/^\\//, '');
                        
                        const match = Object.keys(_MOCK_FILES).find(path => 
                            path === cleanUrl || url.endsWith(path)
                        );

                        if (match) {
                            console.log('Sandbox: Interceptando fetch para:', match);
                            const fileData = _MOCK_FILES[match];
                            // Converte Base64 para Blob para que o fetch responda como um arquivo real
                            const res = await _originalFetch(fileData.data);
                            const blob = await res.blob();
                            return new Response(blob, {
                                status: 200,
                                headers: { 'Content-Type': fileData.type }
                            });
                        }
                        return _originalFetch(input, init);
                    };
                })();
            <\/script>
        `;

        // Insere o mock logo no início do <head> para garantir que intercepte tudo
        const finalCode = html.includes('<head>') ? html.replace('<head>', '<head>' + injection) : injection + html;
        const blob = new Blob([finalCode], { type: 'text/html' });
        
        const iframe = document.getElementById('preview-frame');
        iframe.src = URL.createObjectURL(blob);
        iframe.style.display = 'block';
        document.getElementById('ui-wrapper').classList.add('hidden');
        document.getElementById('back-btn').style.display = 'flex';
    };

    // Suporte para Drag & Drop
    const dz = document.querySelector('.upload-zone');
    dz.ondragover = (e) => { e.preventDefault(); dz.style.borderColor = 'var(--primary)'; };
    dz.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
</script>

</body>
</html>
