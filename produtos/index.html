<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Master Pro | Pre√ßos & Padr√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .field-filled { background-color: #f0f9ff !important; border-color: #bae6fd !important; }
        .selected-item { border-left: 5px solid #3b82f6 !important; background-color: #f1f5f9; }
        
        .sidebar { width: 60px; transition: width 0.2s; overflow: hidden; white-space: nowrap; }
        .sidebar:hover { width: 220px; }
        .main-content { flex: 1; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .tab-content { display: none; height: calc(100vh - 140px); }
        .tab-content.active { display: flex; }
        .tab-btn.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }

        .status-vinc { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .status-novo { background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .price-change { font-size: 9px; color: #d97706; font-weight: bold; margin-top: 2px; display: block; }
        
        .nav-link { display: flex; align-items: center; padding: 14px 20px; color: #94a3b8; transition: all 0.2s; gap: 15px; cursor: pointer; }
        .nav-link:hover { background: #1e293b; color: #3b82f6; }
        .nav-link i { min-width: 20px; text-align: center; font-size: 18px; }

        @media print {
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; width: 85mm; margin: 0; padding: 0; }
            .etiqueta {
                width: 80mm; min-height: 40mm; margin: 0 auto; padding: 2mm 0;
                display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
                page-break-after: always; border-bottom: 1px dashed #ccc;
            }
            .etiqueta-nome { font-size: 14pt; font-weight: 900; line-height: 1.1; margin-bottom: 3mm; width: 100%; text-transform: uppercase; word-wrap: break-word; }
            .etiqueta-ean { font-size: 11pt; width: 100%; font-family: 'Courier New', monospace; letter-spacing: 1px; }
            @page { size: 85mm auto; margin: 0; }
        }
    </style>
</head>
<body class="bg-slate-50 flex overflow-hidden text-slate-900">

    <aside class="sidebar bg-slate-900 flex flex-col shadow-2xl z-50">
        <div class="p-4 mb-4 flex justify-center bg-blue-600">
            <i class="fas fa-bolt text-white text-xl"></i>
        </div>
        <nav class="flex-1 overflow-y-auto custom-scrollbar">
            <div onclick="switchTab('import')" class="nav-link text-white bg-slate-800" title="Dashboard XML"><i class="fas fa-file-invoice"></i> <span>DASHBOARD XML</span></div>
            <div onclick="switchTab('labels')" class="nav-link text-white bg-slate-800 mb-2" title="Etiquetas"><i class="fas fa-barcode"></i> <span>ETIQUETAS</span></div>
            <div class="border-t border-slate-700 my-2 mx-4"></div>
            <a href="https://www.bling.com.br/produtos.php#list" target="_blank" class="nav-link"><i class="fas fa-box"></i> <span>PRODUTOS</span></a>
            <a href="https://www.bling.com.br/vendas.php" target="_blank" class="nav-link"><i class="fas fa-shopping-cart"></i> <span>PEDIDOS</span></a>
            <a href="http://localhost:3000/" target="_blank" class="nav-link text-blue-400 font-bold"><i class="fas fa-plus-circle"></i> <span>TIRAR PEDIDO</span></a>
            <a href="https://www.bling.com.br/importador.produtos.php" target="_blank" class="nav-link"><i class="fas fa-upload"></i> <span>IMPORTAR PRODUTOS</span></a>
            <a href="https://www.bling.com.br/importador.produtos.estrutura.php" target="_blank" class="nav-link"><i class="fas fa-boxes"></i> <span>IMPORTAR COMBOS</span></a>
            <a href="https://www.bling.com.br/vendas.php#list" target="_blank" class="nav-link"><i class="fas fa-list-ul"></i> <span>PEDIDOS DE VENDA</span></a>
            <a href="https://www.bling.com.br/contatos.php" target="_blank" class="nav-link"><i class="fas fa-users"></i> <span>CLIENTES</span></a>
            <div class="border-t border-slate-800 my-2"></div>
            <a href="https://www.donaantonia.com.br/site" target="_blank" class="nav-link text-emerald-400"><i class="fas fa-globe"></i> <span>SITE DONA ANTONIA</span></a>
        </nav>
    </aside>

    <div class="main-content">
        <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-8">
                <h1 class="text-lg font-black tracking-tighter uppercase">XML MASTER <span class="text-blue-600">PRO</span></h1>
                <nav class="flex gap-4">
                    <button onclick="switchTab('import')" id="headerBtnImport" class="tab-btn active px-3 py-2 font-bold text-xs uppercase tracking-widest">Dashboard</button>
                    <button onclick="switchTab('labels')" id="headerBtnLabels" class="tab-btn px-3 py-2 font-bold text-xs uppercase tracking-widest">Etiquetas Bling</button>
                </nav>
            </div>
            <div class="flex gap-2">
                <label class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 border border-slate-300 transition-all">
                    <i class="fas fa-database text-amber-500"></i> CARREGAR CSV BLING
                    <input type="file" id="blingCsvInput" accept=".csv" class="hidden">
                </label>
                <label id="btnXml" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 shadow-lg transition-all">
                    <i class="fas fa-file-import"></i> IMPORTAR XMLS
                    <input type="file" id="xmlInput" accept=".xml" multiple class="hidden">
                </label>
            </div>
        </header>

        <div id="importTab" class="tab-content active p-4 gap-4 overflow-hidden">
            <div class="w-80 bg-white rounded-xl border border-slate-200 overflow-y-auto custom-scrollbar shadow-sm">
                <div class="p-3 border-b bg-slate-50 sticky top-0 z-20 flex justify-between items-center">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="checkAllXml" class="w-4 h-4 accent-blue-600" checked onclick="toggleAllXML(this)">
                        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">SELECIONAR TODOS</span>
                    </label>
                    <button id="btnExport" class="hidden bg-emerald-600 text-white px-3 py-1 rounded font-bold text-[10px]">EXPORTAR</button>
                </div>
                <div id="productList" class="divide-y divide-slate-100">
                    <p class="p-8 text-center text-slate-400 italic text-xs">Aguardando arquivos...</p>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-xl border border-slate-200 overflow-y-auto custom-scrollbar p-6 shadow-sm">
                <div id="editorContent" class="hidden">
                    <div class="flex justify-between items-start border-b pb-6 mb-6">
                        <div class="flex-1 mr-6">
                            <label class="text-[9px] font-black text-blue-500 uppercase">Nome / Descri√ß√£o do Produto</label>
                            <input type="text" id="editMainName" class="text-xl font-bold text-slate-800 uppercase w-full bg-slate-50 border-b-2 border-transparent focus:border-blue-500 outline-none p-1" oninput="sincronizarNome(this)">
                            <div id="calcInfo" class="mt-4"></div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col items-center gap-1 shadow-inner">
                            <span class="text-[9px] font-black text-blue-800 uppercase">Itens na Caixa (Fator)</span>
                            <input type="number" id="fatorInput" value="1" min="1" class="w-20 p-2 rounded-lg border-blue-300 text-blue-900 font-bold text-center text-lg outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4" id="fieldsGrid"></div>
                </div>
            </div>
        </div>

        <div id="labelsTab" class="tab-content flex-col p-4 overflow-hidden">
            <div class="bg-white rounded-xl border border-slate-200 flex flex-col h-full shadow-sm">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                    <div>
                        <h3 class="font-bold text-slate-700">Produtos no Cadastro Bling</h3>
                        <p class="text-xs text-slate-500">Selecione para imprimir na etiqueta 85mm</p>
                    </div>
                    <button onclick="imprimirEtiquetas()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold text-xs hover:bg-slate-900 flex items-center gap-2">
                        <i class="fas fa-print"></i> IMPRIMIR SELECIONADOS
                    </button>
                </div>
                <div class="overflow-y-auto flex-1 custom-scrollbar">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 sticky top-0 text-[10px] font-black uppercase text-slate-500">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onclick="toggleAllLabels(this)"></th>
                                <th class="p-4">Descri√ß√£o do Produto</th>
                                <th class="p-4">EAN / GTIN</th>
                                <th class="p-4">Categoria</th>
                            </tr>
                        </thead>
                        <tbody id="labelsTableBody" class="divide-y divide-slate-100">
                            <tr><td colspan="4" class="p-8 text-center text-slate-400 italic">Carregue o CSV do Bling para listar os produtos.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea" class="hidden"></div>

<script>
    let baseBling = {}; 
    let produtosCarregados = [];
    let categoriasBling = new Set();
    let produtoSelecionadoIdx = null;

    const colunasModelo = ['ID', 'C√≥digo', 'Descri√ß√£o', 'Unidade', 'NCM', 'Origem', 'Pre√ßo', 'Valor IPI fixo', 'Observa√ß√µes', 'Situa√ß√£o', 'Estoque', 'Pre√ßo de custo', 'C√≥d. no fornecedor', 'Fornecedor', 'Localiza√ß√£o', 'Estoque m√°ximo', 'Estoque m√≠nimo', 'Peso l√≠quido (Kg)', 'Peso bruto (Kg)', 'GTIN/EAN', 'GTIN/EAN da Embalagem', 'Largura do produto', 'Altura do Produto', 'Profundidade do produto', 'Data Validade', 'Descri√ß√£o do Produto no Fornecedor', 'Descri√ß√£o Complementar', 'Itens p/ caixa', 'Produto Varia√ß√£o', 'Tipo Produ√ß√£o', 'Classe de enquadramento do IPI', 'C√≥digo na Lista de Servi√ßos', 'Tipo do item', 'Grupo de Tags/Tags', 'Tributos', 'C√≥digo Pai', 'C√≥digo Integra√ß√£o', 'Grupo de produtos', 'Marca', 'CEST', 'Volumes', 'Descri√ß√£o Curta', 'Cross-Docking', 'URL Imagens Externas', 'Link Externo', 'Meses Garantia no Fornecedor', 'Clonar dados do pai', 'Condi√ß√£o do Produto', 'Frete Gr√°tis', 'N√∫mero FCI', 'V√≠deo', 'Departamento', 'Unidade de Medida', 'Pre√ßo de Compra', 'Valor base ICMS ST para reten√ß√£o', 'Valor ICMS ST para reten√ß√£o', 'Valor ICMS pr√≥prio do substituto', 'Categoria do produto', 'Informa√ß√µes Adicionais'];

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab + 'Tab').classList.add('active');
        if(tab === 'import') document.getElementById('headerBtnImport').classList.add('active');
        if(tab === 'labels') document.getElementById('headerBtnLabels').classList.add('active');
    }

    document.getElementById('blingCsvInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            let content = ev.target.result.replace(/^\ufeff/, "");
            const rows = content.split(/\r?\n/);
            const sep = rows[0].includes(';') ? ';' : ',';
            const headers = rows[0].split(sep).map(h => h.replace(/"/g, '').trim().toUpperCase());
            
            const idxID = headers.indexOf('ID'), idxEAN = headers.findIndex(h => h.includes('EAN') || h.includes('GTIN')),
                  idxEstoque = headers.indexOf('ESTOQUE'), idxDesc = headers.indexOf('DESCRI√á√ÉO'), idxPreco = headers.indexOf('PRE√áO');
            const idxCat = headers.findIndex(h => h.includes('CATEGORIA'));

            baseBling = {};
            categoriasBling.clear();
            const tbody = document.getElementById('labelsTableBody');
            tbody.innerHTML = "";

            for(let i = 1; i < rows.length; i++) {
                if(!rows[i].trim()) continue;
                const cols = rows[i].split(new RegExp(`${sep}(?=(?:(?:[^"]*"){2})*[^"]*$)`));
                const ean = cols[idxEAN]?.replace(/"/g, '').trim(); 
                const desc = cols[idxDesc]?.replace(/"/g, '').trim() || "SEM NOME";
                const cat = (idxCat > -1 && cols[idxCat]) ? cols[idxCat].replace(/"/g, '').trim() : "";
                if(cat) categoriasBling.add(cat);

                if(ean) {
                    baseBling[ean] = { 
                        id: cols[idxID]?.replace(/"/g, '').trim() || "", 
                        estoqueAtual: parseFloat(cols[idxEstoque]?.replace(/"/g, '').replace(',', '.') || 0),
                        descricao: desc, 
                        preco: cols[idxPreco]?.replace(/"/g, '').replace(',', '.') || "0.00",
                        categoria: cat
                    };

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="p-4"><input type="checkbox" class="label-check" data-nome="${desc}" data-ean="${ean}"></td>
                        <td class="p-4 font-medium">${desc}</td>
                        <td class="p-4 text-slate-500 font-mono">${ean}</td>
                        <td class="p-4 text-slate-400 text-xs">${cat}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
            alert("Base Bling carregada! " + categoriasBling.size + " categorias identificadas.");
        };
        reader.readAsText(e.target.files[0], "UTF-8");
    });

    document.getElementById('xmlInput').addEventListener('change', function(e) {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const xml = new DOMParser().parseFromString(ev.target.result, "text/xml");
                processarXML(xml, file.name);
            };
            reader.readAsText(file);
        });
    });

    function processarXML(xml, fileName) {
        const emit = xml.getElementsByTagName('emit')[0];
        const nomeForn = emit?.getElementsByTagName('xNome')[0]?.textContent || "Desconhecido";
        const itens = xml.getElementsByTagName('det');
        
        for (let i = 0; i < itens.length; i++) {
            const prod = itens[i].getElementsByTagName('prod')[0];
            const ean = prod.getElementsByTagName('cEAN')[0]?.textContent || "";
            const vUnCom = parseFloat(prod.getElementsByTagName('vUnCom')[0]?.textContent || 0); // Pre√ßo de Custo XML
            const qCom = parseFloat(prod.getElementsByTagName('qCom')[0]?.textContent || 0);
            
            const infoBling = baseBling[ean];
            const vinculado = !!infoBling;
            
            // Vari√°vel auxiliar para armazenar pre√ßo antigo para exibi√ß√£o
            let precoAntigoBling = vinculado ? infoBling.preco : null;

            let obj = { 
                _xmlSource: fileName, 
                _selected: true, 
                _original: {}, 
                _vinculado: vinculado, 
                _estoqueBling: infoBling?.estoqueAtual || 0,
                _precoBlingOriginal: precoAntigoBling // Guarda o pre√ßo original para compara√ß√£o
            };
            
            colunasModelo.forEach(col => {
                let val = "";
                
                if(col === 'ID') val = infoBling?.id || "";
                else if(col === 'Descri√ß√£o') val = (vinculado && infoBling.descricao) ? infoBling.descricao : prod.getElementsByTagName('xProd')[0]?.textContent;
                
                // REGRA 1: PRE√áO DE VENDA SEMPRE CUSTO + 50%
                else if(col === 'Pre√ßo') val = (vUnCom * 1.5).toFixed(2);
                
                // REGRA 2: UNIDADE SEMPRE "UN"
                else if(col === 'Unidade') val = "UN";

                // REGRA 3: ESTOQUE M√çNIMO SEMPRE "3"
                else if(col === 'Estoque m√≠nimo') val = "3";

                else if(col === 'Categoria do produto') val = (vinculado && infoBling.categoria) ? infoBling.categoria : "";
                else if(col === 'GTIN/EAN') val = ean;
                else if(col === 'Estoque') val = ((infoBling?.estoqueAtual || 0) + qCom).toFixed(2);
                else if(['Pre√ßo de custo', 'Pre√ßo de Compra'].includes(col)) val = vUnCom.toFixed(2);
                else if(col === 'Fornecedor') val = nomeForn;
                else if(col === 'Situa√ß√£o') val = "Ativo";
                else val = prod.getElementsByTagName(col === 'C√≥digo' ? 'cProd' : col)?.[0]?.textContent || "";
                
                obj[col] = val;
                
                if(['Estoque', 'Pre√ßo', 'Pre√ßo de custo', 'Pre√ßo de Compra'].includes(col)) {
                    obj._original[col] = (col === 'Estoque') ? qCom : val; 
                }
            });
            produtosCarregados.push(obj);
        }
        renderLista();
        document.getElementById('btnExport').classList.remove('hidden');
    }

    function renderLista() {
        const list = document.getElementById('productList');
        list.innerHTML = "";
        const grupos = {};
        produtosCarregados.forEach((p, idx) => {
            if(!grupos[p._xmlSource]) grupos[p._xmlSource] = [];
            grupos[p._xmlSource].push({p, idx});
        });
        for(const fileName in grupos) {
            const div = document.createElement('div');
            div.className = "xml-divider"; div.innerText = fileName;
            list.appendChild(div);
            grupos[fileName].forEach(({p, idx}) => {
                const item = document.createElement('div');
                item.className = `p-3 flex items-center gap-3 cursor-pointer border-l-4 ${produtoSelecionadoIdx === idx ? 'selected-item' : 'hover:bg-slate-50'}`;
                item.onclick = () => selecionarProduto(idx);
                
                // L√≥gica visual da mudan√ßa de pre√ßo
                let priceChangeHtml = '';
                if(p._vinculado && p._precoBlingOriginal) {
                    priceChangeHtml = `<span class="price-change">üí∞ De R$ ${p._precoBlingOriginal} ‚ûî R$ ${p['Pre√ßo']}</span>`;
                }

                item.innerHTML = `
                    <input type="checkbox" ${p._selected ? 'checked' : ''} onclick="event.stopPropagation(); p._selected=!p._selected">
                    <div class="flex-1 overflow-hidden">
                        <p class="text-[10px] font-bold truncate uppercase name-ref-${idx}">${p.Descri√ß√£o}</p>
                        <div class="mt-1 flex flex-wrap gap-2 items-center">
                            ${p._vinculado ? '<span class="status-vinc">VINCULADO</span>' : '<span class="status-novo">NOVO (+50%)</span>'}
                        </div>
                        ${priceChangeHtml}
                    </div>`;
                list.appendChild(item);
            });
        }
    }

    function selecionarProduto(idx) {
        produtoSelecionadoIdx = idx;
        const p = produtosCarregados[idx];
        document.getElementById('editorContent').classList.remove('hidden');
        document.getElementById('editMainName').value = p.Descri√ß√£o;
        
        document.getElementById('editMainName').readOnly = p._vinculado;
        if(p._vinculado) document.getElementById('editMainName').classList.add('opacity-50', 'cursor-not-allowed');
        else document.getElementById('editMainName').classList.remove('opacity-50', 'cursor-not-allowed');

        const grid = document.getElementById('fieldsGrid');
        grid.innerHTML = "";
        colunasModelo.forEach(col => {
            const div = document.createElement('div');
            div.className = "flex flex-col gap-1";
            let inputHtml = "";
            let isReadOnly = false;
            let extraClass = "";

            if(col === 'Categoria do produto') {
                let options = `<option value="">Selecione...</option>`;
                categoriasBling.forEach(cat => {
                    const selected = p[col] === cat ? 'selected' : '';
                    options += `<option value="${cat}" ${selected}>${cat}</option>`;
                });
                inputHtml = `<select data-col="${col}" onchange="atualizarCampo(this)" class="p-2 border border-slate-200 rounded-lg text-[11px] outline-none focus:border-blue-500 bg-white">${options}</select>`;
            } else {
                if(p._vinculado && ['Descri√ß√£o', 'GTIN/EAN', 'ID'].includes(col)) {
                    isReadOnly = true;
                    extraClass = "bg-slate-100 text-slate-400 cursor-not-allowed";
                }
                // Pre√ßo de Venda agora √© edit√°vel visualmente, mas calculado, ent√£o deixamos aberto caso queira ajuste fino
                inputHtml = `<input type="text" value="${p[col]}" data-col="${col}" ${isReadOnly ? 'readonly' : ''} oninput="atualizarCampo(this)" class="p-2 border border-slate-200 rounded-lg text-[11px] outline-none focus:border-blue-500 ${p[col]?'field-filled':''} ${extraClass}">`;
            }
            div.innerHTML = `<label class="text-[9px] font-black text-slate-500 uppercase">${col}</label>${inputHtml}`;
            grid.appendChild(div);
        });
        document.getElementById('fatorInput').value = 1;
        atualizarDisplayCalculo();
    }

    document.getElementById('fatorInput').oninput = function() {
        const fator = parseFloat(this.value) || 1;
        const p = produtosCarregados[produtoSelecionadoIdx];
        
        const qtdNota = parseFloat(p._original.Estoque);
        const custoNota = parseFloat(p._original['Pre√ßo de custo']);

        // 1. Novo Custo
        const novoCusto = (custoNota / fator);
        // 2. Novo Estoque
        const estoqueFinal = p._estoqueBling + (qtdNota * fator);
        // 3. Novo Pre√ßo de Venda (Custo + 50%)
        const novoPrecoVenda = novoCusto * 1.5;

        p['Pre√ßo de custo'] = novoCusto.toFixed(4);
        p['Pre√ßo de Compra'] = novoCusto.toFixed(4);
        p['Estoque'] = estoqueFinal.toFixed(2);
        p['Pre√ßo'] = novoPrecoVenda.toFixed(2); // Atualiza Pre√ßo de Venda

        // Atualiza inputs
        const inputCusto = document.querySelector(`input[data-col="Pre√ßo de custo"]`);
        if(inputCusto) inputCusto.value = novoCusto.toFixed(4);
        
        const inputEstoque = document.querySelector(`input[data-col="Estoque"]`);
        if(inputEstoque) inputEstoque.value = estoqueFinal.toFixed(2);

        const inputVenda = document.querySelector(`input[data-col="Pre√ßo"]`);
        if(inputVenda) inputVenda.value = novoPrecoVenda.toFixed(2);

        atualizarDisplayCalculo();
        renderLista(); // Atualiza a lista lateral para refletir a mudan√ßa de pre√ßo
    };

    function atualizarDisplayCalculo() {
        const p = produtosCarregados[produtoSelecionadoIdx];
        const f = parseFloat(document.getElementById('fatorInput').value) || 1;
        const qNota = parseFloat(p._original.Estoque);
        const vNota = parseFloat(p._original['Pre√ßo de custo']);
        
        document.getElementById('calcInfo').innerHTML = `
            <div class="estoque-highlight flex flex-col gap-1">
                <div>üì¶ Estoque: ${p._estoqueBling} (Atual) + (${qNota} cx * ${f}) = <strong>${p.Estoque} un</strong></div>
                <div>üí≤ Custo: R$ ${vNota.toFixed(2)} (cx) √∑ ${f} = <strong>R$ ${p['Pre√ßo de custo']} (un)</strong></div>
                <div>üè∑Ô∏è Venda (+50%): <strong>R$ ${p['Pre√ßo']}</strong></div>
            </div>`;
    }

    function atualizarCampo(el) {
        produtosCarregados[produtoSelecionadoIdx][el.dataset.col] = el.value;
        if(el.dataset.col === 'Descri√ß√£o') {
            document.querySelector(`.name-ref-${produtoSelecionadoIdx}`).innerText = el.value;
            document.getElementById('editMainName').value = el.value;
        }
    }

    function sincronizarNome(el) {
        if(!produtosCarregados[produtoSelecionadoIdx]._vinculado) {
            produtosCarregados[produtoSelecionadoIdx].Descri√ß√£o = el.value;
            document.querySelector(`.name-ref-${produtoSelecionadoIdx}`).innerText = el.value;
            const inp = document.querySelector(`input[data-col="Descri√ß√£o"]`);
            if(inp) inp.value = el.value;
        }
    }

    function toggleAllXML(source) {
        produtosCarregados.forEach(p => p._selected = source.checked);
        renderLista();
    }
    
    function toggleAllLabels(source) {
        document.querySelectorAll('.label-check').forEach(cb => cb.checked = source.checked);
    }

    function imprimirEtiquetas() {
        const sel = document.querySelectorAll('.label-check:checked');
        if(sel.length === 0) return alert("Selecione produtos!");
        const area = document.getElementById('printArea');
        area.innerHTML = ""; area.classList.remove('hidden');
        sel.forEach(cb => {
            const div = document.createElement('div');
            div.className = "etiqueta";
            div.innerHTML = `<div class="etiqueta-nome">${cb.dataset.nome}</div><div class="etiqueta-ean">${cb.dataset.ean}</div>`;
            area.appendChild(div);
        });
        setTimeout(() => { window.print(); area.classList.add('hidden'); }, 100);
    }

    document.getElementById('btnExport').onclick = () => {
        const sel = produtosCarregados.filter(p => p._selected);
        if(sel.length === 0) return alert("Selecione produtos!");
        let csv = ["\ufeff" + colunasModelo.join(";")];
        sel.forEach(p => csv.push(colunasModelo.map(col => `"${String(p[col]).replace(/"/g, '""')}"`).join(";")));
        const blob = new Blob([csv.join("\r\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `IMPORT_BLING_ATUALIZADO.csv`;
        a.click();
    };
</script>
</body>
</html>
