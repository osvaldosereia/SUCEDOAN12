<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Master Pro | Preços & Padrões</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .field-filled { background-color: #f0f9ff !important; border-color: #bae6fd !important; }
        .selected-item { border-left: 5px solid #3b82f6 !important; background-color: #f1f5f9; }
        
        .sidebar { width: 60px; transition: width 0.2s; overflow: hidden; white-space: nowrap; }
        .sidebar:hover { width: 220px; }
        .main-content { flex: 1; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .tab-content { display: none; height: calc(100vh - 140px); }
        .tab-content.active { display: flex; }
        .tab-btn.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }

        .status-vinc { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .status-novo { background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .price-change { font-size: 9px; color: #d97706; font-weight: bold; margin-top: 2px; display: block; }
        
        .nav-link { display: flex; align-items: center; padding: 14px 20px; color: #94a3b8; transition: all 0.2s; gap: 15px; cursor: pointer; }
        .nav-link:hover { background: #1e293b; color: #3b82f6; }
        .nav-link i { min-width: 20px; text-align: center; font-size: 18px; }

        th.sortable { cursor: pointer; user-select: none; transition: background 0.2s; }
        th.sortable:hover { background-color: #e2e8f0; }

        @media print {
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; width: 85mm; margin: 0; padding: 0; }
            .etiqueta {
                width: 80mm; min-height: 40mm; margin: 0 auto; padding: 2mm 0;
                display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
                page-break-after: always; border-bottom: 1px dashed #ccc;
            }
            .etiqueta-nome { font-size: 14pt; font-weight: 900; line-height: 1.1; margin-bottom: 3mm; width: 100%; text-transform: uppercase; word-wrap: break-word; }
            .etiqueta-ean { font-size: 11pt; width: 100%; font-family: 'Courier New', monospace; letter-spacing: 1px; }
            @page { size: 85mm auto; margin: 0; }
        }
    </style>
</head>
<body class="bg-slate-50 flex overflow-hidden text-slate-900">

    <aside class="sidebar bg-slate-900 flex flex-col shadow-2xl z-50">
        <div class="p-4 mb-4 flex justify-center bg-blue-600">
            <i class="fas fa-bolt text-white text-xl"></i>
        </div>
        <nav class="flex-1 overflow-y-auto custom-scrollbar">
            <div onclick="switchTab('import')" class="nav-link text-white bg-slate-800" title="Dashboard XML"><i class="fas fa-file-invoice"></i> <span>DASHBOARD XML</span></div>
            <div onclick="switchTab('labels')" class="nav-link text-white bg-slate-800 mb-2" title="Etiquetas"><i class="fas fa-barcode"></i> <span>ETIQUETAS</span></div>
            <div class="border-t border-slate-700 my-2 mx-4"></div>
            <a href="https://www.bling.com.br/produtos.php#list" target="_blank" class="nav-link"><i class="fas fa-box"></i> <span>PRODUTOS</span></a>
            <a href="https://www.bling.com.br/vendas.php" target="_blank" class="nav-link"><i class="fas fa-shopping-cart"></i> <span>PEDIDOS</span></a>
            <a href="http://localhost:3000/" target="_blank" class="nav-link text-blue-400 font-bold"><i class="fas fa-plus-circle"></i> <span>TIRAR PEDIDO</span></a>
            <a href="https://www.bling.com.br/importador.produtos.php" target="_blank" class="nav-link"><i class="fas fa-upload"></i> <span>IMPORTAR PRODUTOS</span></a>
            <a href="https://www.bling.com.br/importador.produtos.estrutura.php" target="_blank" class="nav-link"><i class="fas fa-boxes"></i> <span>IMPORTAR COMBOS</span></a>
            <a href="https://www.bling.com.br/vendas.php#list" target="_blank" class="nav-link"><i class="fas fa-list-ul"></i> <span>PEDIDOS DE VENDA</span></a>
            <a href="https://www.bling.com.br/contatos.php" target="_blank" class="nav-link"><i class="fas fa-users"></i> <span>CLIENTES</span></a>
            <div class="border-t border-slate-800 my-2"></div>
            <a href="https://www.donaantonia.com.br/site" target="_blank" class="nav-link text-emerald-400"><i class="fas fa-globe"></i> <span>SITE DONA ANTONIA</span></a>
        </nav>
    </aside>

    <div class="main-content">
        <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-8">
                <h1 class="text-lg font-black tracking-tighter uppercase">XML MASTER <span class="text-blue-600">PRO</span></h1>
                <nav class="flex gap-4">
                    <button onclick="switchTab('import')" id="headerBtnImport" class="tab-btn active px-3 py-2 font-bold text-xs uppercase tracking-widest">Dashboard</button>
                    <button onclick="switchTab('labels')" id="headerBtnLabels" class="tab-btn px-3 py-2 font-bold text-xs uppercase tracking-widest">Etiquetas Bling</button>
                </nav>
            </div>
            <div class="flex gap-2">
                <label class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 border border-slate-300 transition-all">
                    <i class="fas fa-database text-amber-500"></i> CARREGAR CSV BLING
                    <input type="file" id="blingCsvInput" accept=".csv" class="hidden">
                </label>
                <label id="btnXml" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 shadow-lg transition-all">
                    <i class="fas fa-file-import"></i> IMPORTAR XMLS
                    <input type="file" id="xmlInput" accept=".xml" multiple class="hidden">
                </label>
            </div>
        </header>

        <div id="importTab" class="tab-content active p-4 gap-4 overflow-hidden">
            <div class="w-80 bg-white rounded-xl border border-slate-200 overflow-y-auto custom-scrollbar shadow-sm">
                <div class="p-3 border-b bg-slate-50 sticky top-0 z-20 flex justify-between items-center flex-wrap gap-2">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="checkAllXml" class="w-4 h-4 accent-blue-600" checked onclick="toggleAllXML(this)">
                        <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">TODOS</span>
                    </label>
                    <div class="flex gap-1">
                        <button id="btnExport" class="hidden bg-emerald-600 text-white px-2 py-1 rounded font-bold text-[10px]" title="Exportar Selecionados">EXP. SEL.</button>
                        <button id="btnExportAll" class="hidden bg-blue-600 text-white px-2 py-1 rounded font-bold text-[10px]" title="Exportar Todos">EXP. TUDO</button>
                    </div>
                </div>
                <div id="productList" class="divide-y divide-slate-100">
                    <p class="p-8 text-center text-slate-400 italic text-xs">Aguardando arquivos...</p>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-xl border border-slate-200 overflow-y-auto custom-scrollbar p-6 shadow-sm">
                <div id="editorContent" class="hidden">
                    <div class="flex justify-between items-start border-b pb-6 mb-6">
                        <div class="flex-1 mr-6">
                            <label class="text-[9px] font-black text-blue-500 uppercase">Nome / Descrição do Produto</label>
                            <input type="text" id="editMainName" class="text-xl font-bold text-slate-800 uppercase w-full bg-slate-50 border-b-2 border-transparent focus:border-blue-500 outline-none p-1" oninput="sincronizarNome(this)">
                            <div id="calcInfo" class="mt-4"></div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col items-center gap-1 shadow-inner">
                            <span class="text-[9px] font-black text-blue-800 uppercase">Itens na Caixa (Fator)</span>
                            <input type="number" id="fatorInput" value="1" min="1" class="w-20 p-2 rounded-lg border-blue-300 text-blue-900 font-bold text-center text-lg outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4" id="fieldsGrid"></div>
                </div>
            </div>
        </div>

        <div id="labelsTab" class="tab-content flex-col p-4 overflow-hidden">
            <div class="bg-white rounded-xl border border-slate-200 flex flex-col h-full shadow-sm">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                    <div>
                        <h3 class="font-bold text-slate-700">Produtos no Cadastro Bling</h3>
                        <p class="text-xs text-slate-500">Clique nos títulos das colunas para ordenar</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportarBaseBling()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg font-bold text-xs hover:bg-emerald-700 flex items-center gap-2">
                            <i class="fas fa-file-export"></i> EXPORTAR LISTA COMPLETA
                        </button>
                        <button onclick="imprimirEtiquetas()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold text-xs hover:bg-slate-900 flex items-center gap-2">
                            <i class="fas fa-print"></i> IMPRIMIR SELECIONADOS
                        </button>
                    </div>
                </div>
                <div class="overflow-y-auto flex-1 custom-scrollbar">
                    <table class="w-full text-left text-sm" id="labelsTable">
                        <thead class="bg-slate-100 sticky top-0 text-[10px] font-black uppercase text-slate-500">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onclick="toggleAllLabels(this)"></th>
                                <th class="p-4 sortable" onclick="ordenarTabela(1)">Descrição do Produto <i class="fas fa-sort ml-1"></i></th>
                                <th class="p-4 sortable" onclick="ordenarTabela(2)">EAN / GTIN <i class="fas fa-sort ml-1"></i></th>
                                <th class="p-4 sortable" onclick="ordenarTabela(3)">Código <i class="fas fa-sort ml-1"></i></th>
                                <th class="p-4 sortable" onclick="ordenarTabela(4)">Localização <i class="fas fa-sort ml-1"></i></th>
                            </tr>
                        </thead>
                        <tbody id="labelsTableBody" class="divide-y divide-slate-100">
                            <tr><td colspan="5" class="p-8 text-center text-slate-400 italic">Carregue o CSV do Bling para listar os produtos.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea" class="hidden"></div>

<script>
    let baseBling = {}; 
    let produtosCarregados = [];
    let categoriasBling = new Set();
    let produtoSelecionadoIdx = null;
    let ultimoSeqCodigo = 0; 
    let listaCompletaBling = [];

    // Lista exata de colunas conforme o CSV modelo fornecido
    const colunasModelo = [
        "ID", "Código", "Descrição", "Unidade", "NCM", "Origem", "Preço", "Valor IPI fixo", "Observações", "Situação", 
        "Estoque", "Preço de custo", "Cód. no fornecedor", "Fornecedor", "Localização", "Estoque máximo", "Estoque mínimo", 
        "Peso líquido (Kg)", "Peso bruto (Kg)", "GTIN/EAN", "GTIN/EAN da Embalagem", "Largura do produto", "Altura do Produto", 
        "Profundidade do produto", "Data Validade", "Descrição do Produto no Fornecedor", "Descrição Complementar", 
        "Itens p/ caixa", "Produto Variação", "Tipo Produção", "Classe de enquadramento do IPI", "Código na Lista de Serviços", 
        "Tipo do item", "Grupo de Tags/Tags", "Tributos", "Código Pai", "Código Integração", "Grupo de produtos", "Marca", 
        "CEST", "Volumes", "Descrição Curta", "Cross-Docking", "URL Imagens Externas", "Link Externo", "Meses Garantia no Fornecedor", 
        "Clonar dados do pai", "Condição do Produto", "Frete Grátis", "Número FCI", "Vídeo", "Departamento", "Unidade de Medida", 
        "Preço de Compra", "Valor base ICMS ST para retenção", "Valor ICMS ST para retenção", "Valor ICMS próprio do substituto", 
        "Categoria do produto", "Informações Adicionais"
    ];

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab + 'Tab').classList.add('active');
        if(tab === 'import') document.getElementById('headerBtnImport').classList.add('active');
        if(tab === 'labels') document.getElementById('headerBtnLabels').classList.add('active');
    }

    // Leitura Perfeita do CSV
    document.getElementById('blingCsvInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            let content = ev.target.result.replace(/^\ufeff/, "");
            const rows = content.split(/\r?\n/);
            const sep = ';'; // Forçado para CSV Bling padrão
            
            // Assume que a primeira linha é o cabeçalho idêntico ao colunasModelo
            const headers = rows[0].split(sep).map(h => h.replace(/"/g, '').trim());
            
            // Mapear índices para a aba de etiquetas
            const idxID = headers.indexOf('ID');
            const idxEAN = headers.indexOf('GTIN/EAN');
            const idxDesc = headers.indexOf('Descrição');
            const idxCodigo = headers.indexOf('Código');
            const idxLoc = headers.indexOf('Localização');

            baseBling = {};
            categoriasBling.clear();
            listaCompletaBling = [];
            ultimoSeqCodigo = 0;
            
            const tbody = document.getElementById('labelsTableBody');
            tbody.innerHTML = "";

            for(let i = 1; i < rows.length; i++) {
                if(!rows[i].trim()) continue;
                
                // Regex para splitar respeitando aspas
                const cols = rows[i].split(new RegExp(`${sep}(?=(?:(?:[^"]*"){2})*[^"]*$)`));
                
                // Criar objeto completo do produto mantendo integridade
                let prodObj = {};
                headers.forEach((h, index) => {
                    let val = cols[index] ? cols[index].replace(/^"|"$/g, '') : "";
                    prodObj[h] = val;
                });

                listaCompletaBling.push(prodObj);

                // Armazenar na baseBling para consulta (usando EAN ou ID como chave se necessário, ou apenas guardando)
                const ean = prodObj['GTIN/EAN']?.trim();
                const codigo = prodObj['Código']?.trim();
                const desc = prodObj['Descrição'] || "SEM NOME";
                
                if (ean) baseBling[ean] = prodObj;
                if (codigo) {
                    baseBling[codigo] = prodObj;
                    // Detectar sequencia de código P
                    const match = codigo.match(/^P(\d+)/i);
                    if(match) {
                        const num = parseInt(match[1], 10);
                        if(num > ultimoSeqCodigo) ultimoSeqCodigo = num;
                    }
                }

                // Renderizar Tabela de Etiquetas
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="label-check w-4 h-4 accent-slate-800" data-ean="${ean || ''}" data-nome="${desc}"></td>
                    <td class="p-4 font-bold text-slate-700">${desc}</td>
                    <td class="p-4 font-mono text-slate-500">${ean || '-'}</td>
                    <td class="p-4 text-slate-500">${codigo || '-'}</td>
                    <td class="p-4"><span class="bg-slate-200 text-slate-600 px-2 py-1 rounded text-xs font-bold">${prodObj['Localização'] || '-'}</span></td>
                `;
                tbody.appendChild(tr);
            }
            alert(`CSV Carregado! ${rows.length - 1} produtos processados. Último código P detectado: P${ultimoSeqCodigo}`);
        };
        reader.readAsText(e.target.files[0], 'ISO-8859-1');
    });

    document.getElementById('xmlInput').addEventListener('change', function(e) {
        produtosCarregados = [];
        document.getElementById('productList').innerHTML = "";
        Array.from(e.target.files).forEach((file, i) => lerXML(file, i));
        document.getElementById('btnExport').classList.remove('hidden');
        document.getElementById('btnExportAll').classList.remove('hidden');
    });

    function lerXML(file, idx) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const parser = new DOMParser();
            const xml = parser.parseFromString(e.target.result, "text/xml");
            const emitente = xml.querySelector('emit > xNome')?.textContent || "";
            
            const dets = xml.querySelectorAll('det');
            dets.forEach((det, i) => {
                const prod = det.querySelector('prod');
                const imposto = det.querySelector('imposto');
                
                // Extração dos dados
                const xmlEan = prod.querySelector('cEAN')?.textContent || "";
                const xmlEanTrib = prod.querySelector('cEANTrib')?.textContent || "";
                const xmlDesc = prod.querySelector('xProd')?.textContent || "";
                const xmlNcm = prod.querySelector('NCM')?.textContent || "";
                const xmlCest = prod.querySelector('CEST')?.textContent || "";
                const xmlCprod = prod.querySelector('cProd')?.textContent || "";
                const xmlUcom = prod.querySelector('uCom')?.textContent || "";
                const xmlVuncom = (prod.querySelector('vUnCom')?.textContent || "0.00").replace('.', ',');
                const xmlOrig = imposto?.querySelector('ICMS orig')?.textContent || "0";

                let item;
                const searchEan = xmlEan.trim();

                if (baseBling[searchEan]) {
                    // MODO ATUALIZAÇÃO: Preserva dados originais (incluindo tabs e formatação)
                    item = { ...baseBling[searchEan] };
                    item._vinculado = true;
                    
                    // Atualiza apenas campos novos/alterados
                    item["Preço"] = xmlVuncom;
                    item["Preço de custo"] = xmlVuncom;
                    item["Cód. no fornecedor"] = xmlCprod;
                    item["Fornecedor"] = emitente;
                    item["NCM"] = xmlNcm;
                    item["Origem"] = xmlOrig;
                    if(xmlCest) item["CEST"] = xmlCest;
                } else {
                    // MODO NOVO: Cria estrutura
                    item = {};
                    colunasModelo.forEach(key => item[key] = "");
                    
                    item["Descrição"] = xmlDesc;
                    item["Unidade"] = xmlUcom;
                    item["NCM"] = xmlNcm;
                    item["Origem"] = xmlOrig;
                    item["Preço"] = xmlVuncom;
                    item["Preço de custo"] = xmlVuncom;
                    item["Cód. no fornecedor"] = xmlCprod;
                    item["Fornecedor"] = emitente;
                    
                    // Formatação para Excel (Tabs para evitar notação científica)
                    item["GTIN/EAN"] = xmlEan ? `\t${xmlEan}` : "";
                    item["GTIN/EAN da Embalagem"] = xmlEanTrib ? `\t${xmlEanTrib}` : "";
                    
                    item["CEST"] = xmlCest;
                    item["Peso líquido (Kg)"] = "0,000";
                    item["Peso bruto (Kg)"] = "0,000";
                    item["Situação"] = "Ativo";
                    item["Condição do Produto"] = "Novo";
                    item["Itens p/ caixa"] = "1";

                    ultimoSeqCodigo++;
                    item["Código"] = `P${ultimoSeqCodigo}\t`; // Padrão com tab no final
                }

                item._id = `prod-${idx}-${i}-${Date.now()}`;
                item._selected = true;
                item._custoOriginal = parseFloat(item["Preço de custo"].replace(',', '.') || 0);

                produtosCarregados.push(item);
                renderizarItemLista(item);
            });
        };
        reader.readAsText(file);
    }

    function renderizarItemLista(p) {
        const div = document.createElement('div');
        div.className = `p-3 hover:bg-blue-50 cursor-pointer transition-colors ${p._selected ? 'bg-blue-50' : ''}`;
        div.id = `row-${p._id}`;
        div.onclick = (e) => {
            if(e.target.type !== 'checkbox') carregarEditor(p);
        };
        
        let statusHtml = p._vinculado ? 
            `<span class="status-vinc">VINCULADO</span>` : 
            `<span class="status-novo">NOVO (${p["Código"]})</span>`;

        div.innerHTML = `
            <div class="flex justify-between items-start">
                <div class="flex gap-2 items-start overflow-hidden">
                    <input type="checkbox" class="mt-1 w-4 h-4 accent-blue-600" ${p._selected ? 'checked' : ''} onchange="toggleSel('${p._id}', this)">
                    <div class="overflow-hidden">
                        <div class="text-[10px] font-bold text-slate-500 truncate w-40">${p["GTIN/EAN"] || 'SEM EAN'}</div>
                        <div class="font-bold text-xs truncate w-48 text-slate-800" title="${p["Descrição"]}">${p["Descrição"]}</div>
                        <div class="flex gap-2 mt-1">
                            ${statusHtml}
                            <span class="text-[9px] bg-slate-200 px-1 rounded text-slate-600 font-bold">${p["Unidade"]}</span>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-xs font-black text-emerald-600">R$ ${parseFloat(p["Preço"]).toFixed(2)}</div>
                </div>
            </div>
        `;
        document.getElementById('productList').appendChild(div);
    }

    function toggleSel(id, cb) {
        const p = produtosCarregados.find(x => x._id === id);
        if(p) {
            p._selected = cb.checked;
            // Atualiza visual do fundo
            const row = document.getElementById(`row-${id}`);
            if(row) {
                if(p._selected) row.classList.add('bg-blue-50');
                else row.classList.remove('bg-blue-50');
            }
        }
    }

    function toggleAllXML(cb) {
        produtosCarregados.forEach(p => p._selected = cb.checked);
        document.getElementById('productList').innerHTML = "";
        produtosCarregados.forEach(p => renderizarItemLista(p));
    }

    function carregarEditor(p) {
        produtoSelecionadoIdx = produtosCarregados.findIndex(x => x._id === p._id);
        const area = document.getElementById('editorContent');
        const grid = document.getElementById('fieldsGrid');
        
        area.classList.remove('hidden');
        document.getElementById('editMainName').value = p["Descrição"];
        document.getElementById('fatorInput').value = p["Itens p/ caixa"] || 1;
        
        grid.innerHTML = "";
        
        // Campos editáveis principais (filtrados para não poluir, ou todos se quiser)
        const camposPrincipais = ["Código", "GTIN/EAN", "NCM", "Preço", "Preço de custo", "Unidade", "Marca", "Peso líquido (Kg)", "Peso bruto (Kg)"];
        
        camposPrincipais.forEach(key => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label class="block text-[9px] font-black text-slate-400 uppercase mb-1">${key}</label>
                <input type="text" value="${p[key] || ''}" oninput="atualizarCampo('${key}', this.value)" 
                    class="w-full bg-slate-50 border border-slate-200 rounded p-2 text-xs font-bold text-slate-700 focus:border-blue-500 outline-none transition-all ${p[key] ? 'field-filled' : ''}">
            `;
            grid.appendChild(div);
        });

        // Evento para fator
        document.getElementById('fatorInput').oninput = function() {
            const fator = parseFloat(this.value) || 1;
            p["Itens p/ caixa"] = this.value;
            const custoUnit = p._custoOriginal / fator;
            p["Preço de custo"] = custoUnit.toFixed(4).replace('.', ',');
            // Atualiza input visualmente se existir
            carregarEditor(p); 
        };
    }

    function atualizarCampo(key, val) {
        if(produtoSelecionadoIdx !== null) {
            produtosCarregados[produtoSelecionadoIdx][key] = val;
        }
    }

    function sincronizarNome(el) {
        if(produtoSelecionadoIdx !== null) {
            produtosCarregados[produtoSelecionadoIdx]["Descrição"] = el.value.toUpperCase();
            // Atualiza lista visual
            // Simplificação: Re-renderizar lista seria ideal, mas pesado.
        }
    }

    // Ordenação da Tabela
    let dir = "asc";
    function ordenarTabela(n) {
        const table = document.getElementById("labelsTable");
        let switching = true, shouldSwitch, switchcount = 0;
        
        while (switching) {
            switching = false;
            const rows = table.rows;
            for (let i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                const x = rows[i].getElementsByTagName("TD")[n];
                const y = rows[i + 1].getElementsByTagName("TD")[n];
                if (dir == "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) { shouldSwitch = true; break; }
                } else {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) { shouldSwitch = true; break; }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }

    function imprimirEtiquetas() {
        const sel = document.querySelectorAll('.label-check:checked');
        if(sel.length === 0) return alert("Selecione produtos!");
        const area = document.getElementById('printArea');
        area.innerHTML = ""; area.classList.remove('hidden');
        sel.forEach(cb => {
            const div = document.createElement('div');
            div.className = "etiqueta";
            div.innerHTML = `<div class="etiqueta-nome">${cb.dataset.nome}</div><div class="etiqueta-ean">${cb.dataset.ean}</div>`;
            area.appendChild(div);
        });
        setTimeout(() => { window.print(); area.classList.add('hidden'); }, 100);
    }

    function toggleAllLabels(source) {
        document.querySelectorAll('.label-check').forEach(cb => cb.checked = source.checked);
    }

    // Função genérica de exportação CSV
    function gerarCSV(listaProdutos, nomeArquivo) {
        if(listaProdutos.length === 0) return alert("Sem produtos para exportar!");
        
        // Cabeçalho CSV
        let csvContent = "\ufeff" + colunasModelo.map(c => `"${c}"`).join(";") + "\r\n";

        listaProdutos.forEach(p => {
            let row = colunasModelo.map(col => {
                let val = p[col] === undefined || p[col] === null ? "" : String(p[col]);
                return `"${val.replace(/"/g, '""')}"`;
            }).join(";");
            csvContent += row + "\r\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${nomeArquivo || 'exportacao_bling'}_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Botão Exportar Selecionados (Import XML Tab)
    document.getElementById('btnExport').onclick = () => {
        const sel = produtosCarregados.filter(p => p._selected);
        if(sel.length === 0) return alert("Selecione produtos na lista!");
        gerarCSV(sel, "exportacao_selecionados");
    };

    // Botão Exportar Tudo (Import XML Tab)
    document.getElementById('btnExportAll').onclick = () => {
        if(produtosCarregados.length === 0) return alert("Nenhum produto carregado!");
        gerarCSV(produtosCarregados, "exportacao_xml_todos");
    };
    
    // Botão Exportar Base Completa (Labels Tab)
    function exportarBaseBling() {
        if(listaCompletaBling.length === 0) return alert("Carregue o CSV do Bling primeiro!");
        gerarCSV(listaCompletaBling, "backup_completo_bling");
    }

</script>
</body>
</html>
