<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor XML para Cadastro Bling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom Scrollbar for the table */
        ::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">

    <!-- Header -->
    <header class="bg-blue-600 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i data-lucide="package-check" class="w-8 h-8"></i>
                <div>
                    <h1 class="text-xl font-bold">Assistente de Cadastro Bling</h1>
                    <p class="text-xs text-blue-100">Converta XML de Compra para Dados de Venda</p>
                </div>
            </div>
            <div class="hidden md:block text-sm bg-blue-700 py-1 px-3 rounded-full">
                Configurado para: Simples Nacional
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Upload Area -->
        <div class="bg-white rounded-xl shadow-sm border-2 border-dashed border-slate-300 p-8 text-center transition-all hover:border-blue-400 group" id="drop-zone">
            <input type="file" id="fileInput" accept=".xml" class="hidden" />
            <div class="flex flex-col items-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                <div class="w-16 h-16 bg-blue-50 text-blue-500 rounded-full flex items-center justify-center mb-4 group-hover:bg-blue-100 transition-colors">
                    <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-700">Clique para carregar o XML da Nota</h3>
                <p class="text-slate-500 mt-2 text-sm">Suporta arquivos .xml de NFe (Versão 4.0)</p>
                <p id="fileNameDisplay" class="mt-4 font-bold text-blue-600 hidden"></p>
            </div>
        </div>

        <!-- Info Cards Summary -->
        <div id="summary-section" class="hidden mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-green-500">
                <p class="text-sm text-slate-500">Fornecedor</p>
                <p class="font-bold text-lg" id="summary-supplier">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-500">
                <p class="text-sm text-slate-500">Nº Nota Fiscal</p>
                <p class="font-bold text-lg" id="summary-nfe">-</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-purple-500">
                <p class="text-sm text-slate-500">Total de Itens</p>
                <p class="font-bold text-lg" id="summary-items">0</p>
            </div>
        </div>

        <!-- Results Table -->
        <div id="results-section" class="hidden mt-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Produtos Encontrados</h2>
                <div class="flex gap-2">
                     <span class="flex items-center text-xs bg-red-100 text-red-700 px-2 py-1 rounded border border-red-200"><div class="w-2 h-2 bg-red-500 rounded-full mr-1"></div> ST (Substituição)</span>
                     <span class="flex items-center text-xs bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200"><div class="w-2 h-2 bg-green-500 rounded-full mr-1"></div> Normal</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-slate-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-100 text-slate-600 text-xs uppercase tracking-wider">
                                <th class="p-4 border-b">Produto (Descrição)</th>
                                <th class="p-4 border-b">Códigos (GTIN/SKU)</th>
                                <th class="p-4 border-b">Fiscal (NCM/CEST)</th>
                                <th class="p-4 border-b">Preço Custo (Unit)</th>
                                <th class="p-4 border-b bg-blue-50 border-blue-100 text-blue-700">Config. Saída (BLING)</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body" class="text-sm divide-y divide-slate-100">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Copiado para a área de transferência!</div>

    <script>
        // Initialize Icons
        lucide.createIcons();

        // Elements
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('drop-zone');
        const resultsSection = document.getElementById('results-section');
        const summarySection = document.getElementById('summary-section');
        const tableBody = document.getElementById('products-table-body');
        const fileNameDisplay = document.getElementById('fileNameDisplay');

        // Logic for Taxation
        function getTaxRules(cfopEntrada, cest) {
            // Logic based on the user conversation
            // 5403, 5405, 6403, 6404 -> ST
            const stCfops = ['5403', '5405', '6403', '6404', '1403', '2403'];
            
            let isST = stCfops.includes(cfopEntrada);
            
            // Fallback: if it has a CEST and isn't clearly normal, treat carefully.
            // But strict logic: If entry was 5102, usually exit is 5102 unless specifically configured otherwise.
            // Based on user input: 
            // Input 5403 -> Output 5405 (CSOSN 500)
            // Input 5102 -> Output 5102 (CSOSN 102)

            if (isST) {
                return {
                    cfopSaida: '5.405',
                    csosn: '500', // Simples Nacional for ST items already paid
                    cst: '60', // Standard regime equivalent
                    type: 'ST',
                    colorClass: 'bg-red-50 border-l-4 border-red-400'
                };
            } else {
                return {
                    cfopSaida: '5.102',
                    csosn: '102', // Simples Nacional Normal
                    cst: '00', // Standard regime equivalent
                    type: 'Normal',
                    colorClass: 'bg-green-50 border-l-4 border-green-400'
                };
            }
        }

        function formatCurrency(value) {
            if (!value) return '0,00';
            return parseFloat(value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 4 });
        }

        // Copy to clipboard helper
        window.copyToClipboard = function(text) {
            // Create a temporary textarea to handle copy
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                showToast(`Copiado: ${text}`);
            } catch (err) {
                console.error('Falha ao copiar', err);
            }
            
            document.body.removeChild(textarea);
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        // File Handling
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            if (!file) return;

            fileNameDisplay.textContent = file.name;
            fileNameDisplay.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
                processXML(xmlDoc);
            };
            reader.readAsText(file);
        }

        function getTagValue(parent, tagName) {
            const element = parent.getElementsByTagName(tagName)[0];
            return element ? element.textContent : '';
        }

        function processXML(xml) {
            // Reset UI
            tableBody.innerHTML = '';
            resultsSection.classList.remove('hidden');
            summarySection.classList.remove('hidden');

            // Header Info
            const emit = xml.getElementsByTagName('emit')[0];
            const ide = xml.getElementsByTagName('ide')[0];
            
            if(emit) {
                document.getElementById('summary-supplier').textContent = getTagValue(emit, 'xNome');
            }
            if(ide) {
                document.getElementById('summary-nfe').textContent = getTagValue(ide, 'nNF');
            }

            // Products
            const dets = xml.getElementsByTagName('det');
            document.getElementById('summary-items').textContent = dets.length;

            Array.from(dets).forEach((det, index) => {
                const prod = det.getElementsByTagName('prod')[0];
                const imposto = det.getElementsByTagName('imposto')[0];
                const icms = imposto ? imposto.getElementsByTagName('ICMS')[0] : null;
                
                // Get Origin
                let orig = '0';
                if (icms) {
                    // ICMS tags vary (ICMS00, ICMS10, ICMSSn102, etc), search deeper
                    const innerICMS = icms.children[0]; // First child usually contains the data
                    if (innerICMS) {
                        const origTag = innerICMS.getElementsByTagName('orig')[0];
                        if (origTag) orig = origTag.textContent;
                    }
                }

                // Data Extraction
                const xProd = getTagValue(prod, 'xProd');
                const ncm = getTagValue(prod, 'NCM');
                const cest = getTagValue(prod, 'CEST');
                const cfopEntrada = getTagValue(prod, 'CFOP');
                const cEAN = getTagValue(prod, 'cEAN');
                const cProd = getTagValue(prod, 'cProd'); // SKU supplier
                const uCom = getTagValue(prod, 'uCom');
                const vUnCom = getTagValue(prod, 'vUnCom');

                // Determine Rules
                const rules = getTaxRules(cfopEntrada, cest);

                // Create Row
                const row = document.createElement('tr');
                row.className = `hover:bg-slate-50 transition-colors ${rules.colorClass}`;

                // Render Item
                row.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-slate-700 mb-1">${xProd}</div>
                        <button onclick="copyToClipboard('${xProd.replace(/'/g, "\\'")}')" class="text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium">
                            <i data-lucide="copy" class="w-3 h-3"></i> Copiar Nome
                        </button>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs text-slate-500 mb-1">GTIN/EAN:</div>
                        <div class="font-mono bg-white border border-slate-200 rounded px-2 py-1 flex justify-between items-center w-32 mb-2">
                            <span>${cEAN !== 'SEM GTIN' ? cEAN : ''}</span>
                            <button onclick="copyToClipboard('${cEAN}')" class="text-slate-400 hover:text-blue-600"><i data-lucide="copy" class="w-3 h-3"></i></button>
                        </div>
                        <div class="text-xs text-slate-500 mb-1">Cód. Fornecedor:</div>
                        <div class="font-mono text-xs text-slate-600">${cProd}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="mb-2">
                            <div class="text-xs text-slate-500">NCM</div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-700">${ncm}</span>
                                <button onclick="copyToClipboard('${ncm}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="copy" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-500">CEST</div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold ${cest ? 'text-slate-700' : 'text-slate-300'}">${cest || 'Vazio'}</span>
                                ${cest ? `<button onclick="copyToClipboard('${cest}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="copy" class="w-3 h-3"></i></button>` : ''}
                            </div>
                        </div>
                         <div class="mt-2">
                            <div class="text-xs text-slate-500">Origem</div>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-slate-700">${orig}</span>
                                <button onclick="copyToClipboard('${orig}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="copy" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs text-slate-500">Valor Unit.</div>
                        <div class="font-bold text-slate-800 text-lg">R$ ${formatCurrency(vUnCom)}</div>
                        <div class="text-xs text-slate-500 mt-1">Un: <span class="font-bold">${uCom}</span></div>
                        <button onclick="copyToClipboard('${formatCurrency(vUnCom)}')" class="mt-2 text-xs flex items-center gap-1 text-blue-600 hover:text-blue-800">
                            <i data-lucide="copy" class="w-3 h-3"></i> Copiar Preço
                        </button>
                    </td>
                    <td class="p-4 align-top bg-blue-50/50">
                        <div class="mb-3">
                            <div class="text-xs text-blue-600 font-bold mb-1 uppercase">CFOP de Saída</div>
                            <div class="flex items-center justify-between bg-white border border-blue-200 rounded px-2 py-1">
                                <span class="font-bold text-blue-800">${rules.cfopSaida}</span>
                                <button onclick="copyToClipboard('${rules.cfopSaida.replace('.','')}')" class="text-blue-400 hover:text-blue-600"><i data-lucide="copy" class="w-3 h-3"></i></button>
                            </div>
                            <div class="text-[10px] text-slate-400 mt-0.5">Entrada foi: ${cfopEntrada}</div>
                        </div>
                        <div>
                            <div class="text-xs text-blue-600 font-bold mb-1 uppercase">CSOSN (Simples)</div>
                            <div class="flex items-center justify-between bg-white border border-blue-200 rounded px-2 py-1">
                                <span class="font-bold text-blue-800">${rules.csosn}</span>
                                <button onclick="copyToClipboard('${rules.csosn}')" class="text-blue-400 hover:text-blue-600"><i data-lucide="copy" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // Refresh icons for new elements
            lucide.createIcons();
        }
    </script>
</body>
</html>
