<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Master Pro | Etiquetas & Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .field-filled { background-color: #f0f9ff !important; border-color: #bae6fd !important; }
        .selected-item { border-left: 5px solid #3b82f6 !important; background-color: #f1f5f9; }
        
        .sidebar { width: 60px; transition: width 0.2s; overflow: hidden; white-space: nowrap; }
        .sidebar:hover { width: 220px; }
        .main-content { flex: 1; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Estilos de Abas */
        .tab-content { display: none; height: calc(100vh - 140px); }
        .tab-content.active { display: flex; }
        .tab-btn.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }

        .status-vinc { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .status-novo { background: #dbeafe; color: #1e40af; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .estoque-highlight { background: #fef9c3; border: 1px solid #facc15; padding: 8px 12px; border-radius: 8px; font-weight: bold; color: #854d0e; font-size: 11px; }

        /* ESTILO PARA IMPRESSÃO DE ETIQUETAS */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; }
            .etiqueta {
                width: 50mm;
                height: 25mm;
                padding: 4mm;
                border: 1px solid #eee; /* Apenas visual no browser */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                page-break-after: always;
                box-sizing: border-box;
                overflow: hidden;
            }
            .etiqueta-nome { font-size: 10pt; font-weight: bold; line-height: 1.1; margin-bottom: 2mm; width: 100%; text-transform: uppercase; }
            .etiqueta-ean { font-size: 9pt; width: 100%; font-family: monospace; }
        }
    </style>
</head>
<body class="bg-slate-50 flex overflow-hidden text-slate-900">

    <aside class="sidebar bg-slate-900 flex flex-col shadow-2xl z-50">
        <div class="p-4 mb-4 flex justify-center bg-blue-600">
            <i class="fas fa-bolt text-white text-xl"></i>
        </div>
        <nav class="flex-1">
            <a href="#" onclick="switchTab('import')" class="nav-link flex items-center p-4 text-slate-400 hover:text-white gap-4" title="Importar">
                <i class="fas fa-file-import w-5"></i> <span>IMPORTAR XML</span>
            </a>
            <a href="#" onclick="switchTab('labels')" class="nav-link flex items-center p-4 text-slate-400 hover:text-white gap-4" title="Etiquetas">
                <i class="fas fa-barcode w-5"></i> <span>ETIQUETAS</span>
            </a>
        </nav>
    </aside>

    <div class="main-content">
        <header class="bg-white border-b border-slate-200 p-4 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-8">
                <h1 class="text-lg font-black tracking-tighter uppercase">XML MASTER <span class="text-blue-600">PRO</span></h1>
                <nav class="flex gap-4">
                    <button onclick="switchTab('import')" class="tab-btn active px-3 py-2 font-bold text-xs uppercase tracking-widest">Dashboard</button>
                    <button onclick="switchTab('labels')" class="tab-btn px-3 py-2 font-bold text-xs uppercase tracking-widest">Etiquetas Bling</button>
                </nav>
            </div>
            
            <div class="flex gap-2">
                <label class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 border border-slate-300 transition-all">
                    <i class="fas fa-database text-amber-500"></i> CARREGAR CSV BLING
                    <input type="file" id="blingCsvInput" accept=".csv" class="hidden">
                </label>
                <label id="btnXml" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 shadow-lg transition-all">
                    <i class="fas fa-file-import"></i> IMPORTAR XMLS
                    <input type="file" id="xmlInput" accept=".xml" multiple class="hidden">
                </label>
            </div>
        </header>

        <div id="importTab" class="tab-content active p-4 gap-4 overflow-hidden">
            <div class="w-80 bg-white rounded-xl border border-slate-200 overflow-y-auto custom-scrollbar shadow-sm">
                <div class="p-3 border-b bg-slate-50 sticky top-0 z-20 flex justify-between items-center">
                    <span class="text-[10px] font-black uppercase text-slate-400 tracking-widest">Lista da Nota</span>
                    <button id="btnExport" class="hidden bg-emerald-600 text-white px-3 py-1 rounded font-bold text-[10px]">EXPORTAR</button>
                </div>
                <div id="productList" class="divide-y divide-slate-100">
                    <p class="p-8 text-center text-slate-400 italic text-xs">Aguardando arquivos...</p>
                </div>
            </div>

            <div class="flex-1 bg-white rounded-xl border border-slate-200 overflow-y-auto custom-scrollbar p-6 shadow-sm">
                <div id="editorContent" class="hidden">
                    <div class="flex justify-between items-start border-b pb-6 mb-6">
                        <div class="flex-1 mr-6">
                            <label class="text-[9px] font-black text-blue-500 uppercase">Nome / Descrição do Produto</label>
                            <input type="text" id="editMainName" class="text-xl font-bold text-slate-800 uppercase w-full bg-slate-50 border-b-2 border-transparent focus:border-blue-500 outline-none p-1" oninput="sincronizarNome(this)">
                            <div id="calcInfo" class="mt-4"></div>
                        </div>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 flex flex-col items-center gap-1 shadow-inner">
                            <span class="text-[9px] font-black text-blue-800 uppercase">Fator</span>
                            <input type="number" id="fatorInput" value="1" class="w-20 p-2 rounded-lg border-blue-300 text-blue-900 font-bold text-center">
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4" id="fieldsGrid"></div>
                </div>
            </div>
        </div>

        <div id="labelsTab" class="tab-content flex-col p-4 overflow-hidden">
            <div class="bg-white rounded-xl border border-slate-200 flex flex-col h-full shadow-sm">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                    <div>
                        <h3 class="font-bold text-slate-700">Produtos no Cadastro Bling</h3>
                        <p class="text-xs text-slate-500">Selecione para imprimir na etiqueta 50x25mm</p>
                    </div>
                    <button onclick="imprimirEtiquetas()" class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold text-xs hover:bg-slate-900 flex items-center gap-2">
                        <i class="fas fa-print"></i> IMPRIMIR SELECIONADOS
                    </button>
                </div>
                <div class="overflow-y-auto flex-1 custom-scrollbar">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 sticky top-0 text-[10px] font-black uppercase text-slate-500">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onclick="toggleAllLabels(this)"></th>
                                <th class="p-4">Descrição do Produto</th>
                                <th class="p-4">EAN / GTIN</th>
                            </tr>
                        </thead>
                        <tbody id="labelsTableBody" class="divide-y divide-slate-100">
                            <tr><td colspan="3" class="p-8 text-center text-slate-400 italic">Carregue o CSV do Bling para listar os produtos.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea" class="hidden"></div>

<script>
    let baseBling = {}; 
    let produtosCarregados = [];
    let produtoSelecionadoIdx = null;

    const colunasModelo = ['ID', 'Código', 'Descrição', 'Unidade', 'NCM', 'Origem', 'Preço', 'Valor IPI fixo', 'Observações', 'Situação', 'Estoque', 'Preço de custo', 'Cód. no fornecedor', 'Fornecedor', 'Localização', 'Estoque máximo', 'Estoque mínimo', 'Peso líquido (Kg)', 'Peso bruto (Kg)', 'GTIN/EAN', 'GTIN/EAN da Embalagem', 'Largura do produto', 'Altura do Produto', 'Profundidade do produto', 'Data Validade', 'Descrição do Produto no Fornecedor', 'Descrição Complementar', 'Itens p/ caixa', 'Produto Variação', 'Tipo Produção', 'Classe de enquadramento do IPI', 'Código na Lista de Serviços', 'Tipo do item', 'Grupo de Tags/Tags', 'Tributos', 'Código Pai', 'Código Integração', 'Grupo de produtos', 'Marca', 'CEST', 'Volumes', 'Descrição Curta', 'Cross-Docking', 'URL Imagens Externas', 'Link Externo', 'Meses Garantia no Fornecedor', 'Clonar dados do pai', 'Condição do Produto', 'Frete Grátis', 'Número FCI', 'Vídeo', 'Departamento', 'Unidade de Medida', 'Preço de Compra', 'Valor base ICMS ST para retenção', 'Valor ICMS ST para retenção', 'Valor ICMS próprio do substituto', 'Categoria do produto', 'Informações Adicionais'];

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tab + 'Tab').classList.add('active');
        event.currentTarget.classList.add('active');
    }

    document.getElementById('blingCsvInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            let content = ev.target.result.replace(/^\ufeff/, "");
            const rows = content.split(/\r?\n/);
            const sep = rows[0].includes(';') ? ';' : ',';
            const headers = rows[0].split(sep).map(h => h.replace(/"/g, '').trim().toUpperCase());
            
            const idxID = headers.indexOf('ID'), idxEAN = headers.findIndex(h => h.includes('EAN') || h.includes('GTIN')),
                  idxEstoque = headers.indexOf('ESTOQUE'), idxDesc = headers.indexOf('DESCRIÇÃO'), idxPreco = headers.indexOf('PREÇO');

            baseBling = {};
            const tbody = document.getElementById('labelsTableBody');
            tbody.innerHTML = "";

            for(let i = 1; i < rows.length; i++) {
                if(!rows[i].trim()) continue;
                const cols = rows[i].split(new RegExp(`${sep}(?=(?:(?:[^"]*"){2})*[^"]*$)`));
                const ean = cols[idxEAN]?.replace(/"/g, '').trim(); 
                const desc = cols[idxDesc]?.replace(/"/g, '').trim() || "SEM NOME";
                
                if(ean) {
                    baseBling[ean] = { 
                        id: cols[idxID]?.replace(/"/g, '').trim() || "", 
                        estoqueAtual: parseFloat(cols[idxEstoque]?.replace(/"/g, '').replace(',', '.') || 0),
                        descricao: desc, preco: cols[idxPreco]?.replace(/"/g, '').replace(',', '.') || ""
                    };

                    // Adiciona na tabela de etiquetas
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="p-4"><input type="checkbox" class="label-check" data-nome="${desc}" data-ean="${ean}"></td>
                        <td class="p-4 font-medium">${desc}</td>
                        <td class="p-4 text-slate-500 font-mono">${ean}</td>
                    `;
                    tbody.appendChild(tr);
                }
            }
            document.getElementById('blingAlert').classList.remove('hidden');
            document.getElementById('blingInfo').innerText = `${Object.keys(baseBling).length} PRODUTOS CARREGADOS`;
        };
        reader.readAsText(e.target.files[0], "UTF-8");
    });

    function imprimirEtiquetas() {
        const selecionados = document.querySelectorAll('.label-check:checked');
        if(selecionados.length === 0) return alert("Selecione ao menos um produto!");

        const printArea = document.getElementById('printArea');
        printArea.innerHTML = "";

        selecionados.forEach(cb => {
            const div = document.createElement('div');
            div.className = "etiqueta";
            div.innerHTML = `
                <div class="etiqueta-nome">${cb.dataset.nome}</div>
                <div class="etiqueta-ean">${cb.dataset.ean}</div>
            `;
            printArea.appendChild(div);
        });

        window.print();
    }

    function toggleAllLabels(source) {
        document.querySelectorAll('.label-check').forEach(cb => cb.checked = source.checked);
    }

    // --- REUTILIZANDO LÓGICA DE PROCESSAMENTO ANTERIOR ---
    document.getElementById('xmlInput').addEventListener('change', function(e) {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const xml = new DOMParser().parseFromString(ev.target.result, "text/xml");
                processarXML(xml, file.name);
            };
            reader.readAsText(file);
        });
    });

    function processarXML(xml, fileName) {
        const emit = xml.getElementsByTagName('emit')[0];
        const nomeForn = emit?.getElementsByTagName('xNome')[0]?.textContent || "Desconhecido";
        const itens = xml.getElementsByTagName('det');
        for (let i = 0; i < itens.length; i++) {
            const prod = itens[i].getElementsByTagName('prod')[0];
            const ean = prod.getElementsByTagName('cEAN')[0]?.textContent || "";
            const vUnCom = parseFloat(prod.getElementsByTagName('vUnCom')[0]?.textContent || 0);
            const infoBling = baseBling[ean];
            const vinculado = !!infoBling;
            
            let obj = { _xmlSource: fileName, _selected: true, _original: {}, _vinculado: vinculado, _estoqueBling: infoBling?.estoqueAtual || 0 };
            colunasModelo.forEach(col => {
                let val = "";
                if(col === 'ID') val = infoBling?.id || "";
                else if(col === 'Descrição') val = (vinculado && infoBling.descricao) ? infoBling.descricao : prod.getElementsByTagName('xProd')[0]?.textContent;
                else if(col === 'Preço') val = (vinculado && infoBling.preco) ? infoBling.preco : (vUnCom * 1.5).toFixed(2);
                else if(col === 'GTIN/EAN') val = ean;
                else if(col === 'Estoque') val = ((infoBling?.estoqueAtual || 0) + parseFloat(prod.getElementsByTagName('qCom')[0]?.textContent)).toFixed(2);
                else if(['Preço de custo', 'Preço de Compra'].includes(col)) val = vUnCom.toFixed(2);
                else if(col === 'Situação') val = "Ativo";
                else val = prod.getElementsByTagName(col === 'Código' ? 'cProd' : col)?.[0]?.textContent || "";
                obj[col] = val;
                if(['Estoque', 'Preço', 'Preço de custo'].includes(col)) obj._original[col] = (col === 'Estoque') ? parseFloat(prod.getElementsByTagName('qCom')[0]?.textContent) : val;
            });
            produtosCarregados.push(obj);
        }
        renderLista();
        document.getElementById('btnExport').classList.remove('hidden');
    }

    function renderLista() {
        const list = document.getElementById('productList');
        list.innerHTML = "";
        const grupos = {};
        produtosCarregados.forEach((p, idx) => {
            if(!grupos[p._xmlSource]) grupos[p._xmlSource] = [];
            grupos[p._xmlSource].push({p, idx});
        });
        for(const fileName in grupos) {
            const div = document.createElement('div');
            div.className = "xml-divider";
            div.innerText = fileName;
            list.appendChild(div);
            grupos[fileName].forEach(({p, idx}) => {
                const item = document.createElement('div');
                item.className = `p-3 flex items-center gap-3 cursor-pointer border-l-4 ${produtoSelecionadoIdx === idx ? 'selected-item' : 'hover:bg-slate-50'}`;
                item.onclick = () => selecionarProduto(idx);
                item.innerHTML = `<input type="checkbox" ${p._selected ? 'checked' : ''} onclick="event.stopPropagation(); p._selected=!p._selected">
                    <div class="flex-1 overflow-hidden"><p class="text-[10px] font-bold truncate uppercase">${p.Descrição}</p>
                    <div class="mt-1">${p._vinculado ? '<span class="status-vinc">VINCULADO</span>' : '<span class="status-novo">NOVO (+50%)</span>'}</div></div>`;
                list.appendChild(item);
            });
        }
    }

    function selecionarProduto(idx) {
        produtoSelecionadoIdx = idx;
        const p = produtosCarregados[idx];
        document.getElementById('editorContent').classList.remove('hidden');
        document.getElementById('editMainName').value = p.Descrição;
        const grid = document.getElementById('fieldsGrid');
        grid.innerHTML = "";
        colunasModelo.forEach(col => {
            grid.innerHTML += `<div class="flex flex-col"><label class="text-[9px] font-black text-slate-500 uppercase">${col}</label>
                <input type="text" value="${p[col]}" data-col="${col}" oninput="p[col]=this.value" class="p-2 border rounded-lg text-[11px] ${p[col]?'field-filled':''}"></div>`;
        });
    }

    function sincronizarNome(el) {
        produtosCarregados[produtoSelecionadoIdx].Descrição = el.value;
        renderLista();
    }
</script>
</body>
</html>
