<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Master Pro | Master-Detail Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .field-filled { background-color: #eff6ff !important; border-color: #bfdbfe !important; } /* Azul suave para preenchidos */
        .selected-item { border-left: 6px solid #3b82f6 !important; background-color: #f1f5f9; }
        
        .master-panel { height: calc(100vh - 120px); overflow-y: auto; }
        .detail-panel { height: calc(100vh - 120px); overflow-y: auto; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen overflow-hidden text-slate-900">

    <header class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center z-50 relative">
        <h1 class="text-xl font-black flex items-center gap-2">
            <i class="fas fa-boxes text-blue-500"></i> XML MASTER <span class="text-blue-500">PRO</span>
        </h1>
        <div class="flex gap-3">
            <label class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2">
                <i class="fas fa-database text-yellow-400"></i> 1. CARREGAR BASE BLING
                <input type="file" id="blingCsvInput" accept=".csv" class="hidden">
            </label>
            <label class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2">
                <i class="fas fa-file-upload"></i> 2. IMPORTAR XMLS
                <input type="file" id="xmlInput" accept=".xml" multiple class="hidden">
            </label>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-4">
        <div class="flex gap-6">
            
            <div class="w-1/3 bg-white rounded-xl shadow-sm border border-slate-200 master-panel custom-scrollbar">
                <div class="p-4 border-b bg-slate-50 sticky top-0 z-10 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 uppercase text-xs">Produtos na Nota</h2>
                    <button id="btnExport" class="hidden bg-emerald-600 text-white px-3 py-1 rounded font-bold text-[10px] hover:bg-emerald-700 transition-all">
                        <i class="fas fa-file-csv"></i> EXPORTAR CSV
                    </button>
                </div>
                <div id="productList" class="divide-y divide-slate-100">
                    <p class="p-8 text-center text-slate-400 italic text-sm">Nenhum XML carregado...</p>
                </div>
            </div>

            <div class="w-2/3 bg-white rounded-xl shadow-sm border border-slate-200 detail-panel custom-scrollbar p-6" id="editorPanel">
                <div class="flex flex-col items-center justify-center h-full text-slate-400" id="editorPlaceholder">
                    <i class="fas fa-mouse-pointer text-4xl mb-4 opacity-20"></i>
                    <p>Selecione um produto na lista à esquerda para editar</p>
                </div>

                <div id="editorContent" class="hidden">
                    <div class="flex justify-between items-start border-b pb-4 mb-6">
                        <div>
                            <h3 id="currentProdName" class="text-lg font-bold text-slate-800 uppercase">---</h3>
                            <span id="stBadge" class="hidden bg-red-100 text-red-700 px-2 py-0.5 rounded text-[10px] font-bold">ITEM COM ST</span>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex items-center gap-3">
                            <span class="text-xs font-bold text-blue-700 uppercase">Fator (X):</span>
                            <input type="number" id="fatorInput" placeholder="Ex: 12" class="w-20 p-2 rounded border-blue-200 text-blue-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-4" id="fieldsGrid">
                        </div>
                </div>
            </div>

        </div>
    </div>

<script>
    let baseBling = {};
    let produtosCarregados = [];
    let produtoSelecionadoIdx = null;

    const colunasModelo = [
        'ID', 'Código', 'Descrição', 'Unidade', 'NCM', 'Origem', 'Preço', 'Valor IPI fixo', 
        'Observações', 'Situação', 'Estoque', 'Preço de custo', 'Cód no fornecedor', 
        'Fornecedor', 'Localização', 'Estoque maximo', 'Estoque minimo', 'Peso líquido (Kg)', 
        'Peso bruto (Kg)', 'GTIN/EAN', 'GTIN/EAN da embalagem', 'Largura do Produto', 
        'Altura do Produto', 'Profundidade do produto', 'Data Validade', 
        'Descrição do Produto no Fornecedor', 'Descrição Complementar', 'Itens p/ caixa', 
        'Produto Variação', 'Tipo Produção', 'Classe de enquadramento do IPI', 
        'Código da lista de serviços', 'Tipo do item', 'Grupo de Tags/Tags', 'Tributos', 
        'Código Pai', 'Código Integração', 'Grupo de produtos', 'Marca', 'CEST', 'Volumes', 
        'Descrição Curta', 'Cross-Docking', 'URL Imagens Externas', 'Link Externo', 
        'Meses Garantia no Fornecedor', 'Clonar dados do pai', 'Condição do produto', 
        'Frete Grátis', 'Número FCI', 'Vídeo', 'Departamento', 'Unidade de medida', 
        'Preço de compra', 'Valor base ICMS ST para retenção', 'Valor ICMS ST para retenção', 
        'Valor ICMS próprio do substituto', 'Categoria do produto', 'Informações Adicionais'
    ];

    // Carregar Base Bling
    document.getElementById('blingCsvInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            const rows = ev.target.result.split(/\r?\n/);
            const sep = rows[0].includes(';') ? ';' : ',';
            const headers = rows[0].split(sep).map(h => h.replace(/"/g, '').trim().toUpperCase());
            const idxID = headers.findIndex(h => h === 'ID');
            const idxEAN = headers.findIndex(h => h.includes('EAN'));
            rows.forEach((row, i) => {
                if(i===0) return;
                const cols = row.split(new RegExp(`${sep}(?=(?:(?:[^"]*"){2})*[^"]*$)`));
                if(cols[idxEAN]) baseBling[cols[idxEAN].replace(/"/g, '').trim()] = cols[idxID]?.replace(/"/g, '').trim();
            });
            alert("Base Bling Carregada!");
        };
        reader.readAsText(e.target.files[0]);
    });

    // Importar XMLs
    document.getElementById('xmlInput').addEventListener('change', function(e) {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const xml = new DOMParser().parseFromString(ev.target.result, "text/xml");
                processarXML(xml);
            };
            reader.readAsText(file);
        });
    });

    function processarXML(xml) {
        const emit = xml.getElementsByTagName('emit')[0];
        const nomeForn = emit?.getElementsByTagName('xNome')[0]?.textContent || "Desconhecido";
        const itens = xml.getElementsByTagName('det');

        for (let i = 0; i < itens.length; i++) {
            const prod = itens[i].getElementsByTagName('prod')[0];
            const imposto = itens[i].getElementsByTagName('imposto')[0];
            const icmsST = imposto.querySelector('ICMS10, ICMS30, ICMS70, ICMS90, ICMSPart, ICMSST');
            const ean = prod.getElementsByTagName('cEAN')[0]?.textContent || "";

            let obj = {
                _isST: icmsST !== null,
                _original: {} // Para resetar fator
            };

            colunasModelo.forEach(col => {
                let val = "";
                if(col === 'ID') val = baseBling[ean] || "";
                else if(col === 'Descrição') val = prod.getElementsByTagName('xProd')[0]?.textContent || "";
                else if(col === 'Código') val = prod.getElementsByTagName('cProd')[0]?.textContent || "";
                else if(col === 'Unidade') val = prod.getElementsByTagName('uCom')[0]?.textContent || "";
                else if(col === 'Estoque') val = prod.getElementsByTagName('qCom')[0]?.textContent || "0";
                else if(['Preço', 'Preço de custo', 'Preço de compra'].includes(col)) val = prod.getElementsByTagName('vUnCom')[0]?.textContent || "0";
                else if(col === 'NCM') val = prod.getElementsByTagName('NCM')[0]?.textContent || "";
                else if(col === 'GTIN/EAN') val = ean;
                else if(col === 'Fornecedor') val = nomeForn;
                else if(col === 'Situação') val = "Ativo";
                else if(col === 'Valor base ICMS ST para retenção') val = icmsST?.getElementsByTagName('vBCST')[0]?.textContent || "";
                else if(col === 'Valor ICMS ST para retenção') val = icmsST?.getElementsByTagName('vICMSST')[0]?.textContent || "";
                
                obj[col] = val;
                if(['Estoque', 'Preço', 'Preço de custo', 'Preço de compra'].includes(col)) obj._original[col] = val;
            });
            produtosCarregados.push(obj);
        }
        renderLista();
        document.getElementById('btnExport').classList.remove('hidden');
    }

    function renderLista() {
        const list = document.getElementById('productList');
        list.innerHTML = "";
        produtosCarregados.forEach((p, idx) => {
            const div = document.createElement('div');
            div.className = `p-3 cursor-pointer transition-all hover:bg-slate-50 flex items-center gap-3 ${produtoSelecionadoIdx === idx ? 'selected-item' : ''}`;
            div.onclick = () => selecionarProduto(idx);
            div.innerHTML = `
                <div class="flex-1 overflow-hidden">
                    <p class="text-[11px] font-bold text-slate-800 truncate uppercase">${p.Descrição}</p>
                    <p class="text-[9px] text-slate-500 uppercase">${p.Código} | EAN: ${p['GTIN/EAN'] || '---'}</p>
                </div>
                ${p._isST ? '<i class="fas fa-exclamation-triangle text-red-500 text-[10px]"></i>' : ''}
            `;
            list.appendChild(div);
        });
    }

    function selecionarProduto(idx) {
        produtoSelecionadoIdx = idx;
        const p = produtosCarregados[idx];
        renderLista();

        document.getElementById('editorPlaceholder').classList.add('hidden');
        document.getElementById('editorContent').classList.remove('hidden');
        document.getElementById('currentProdName').innerText = p.Descrição;
        document.getElementById('stBadge').style.display = p._isST ? 'block' : 'none';
        document.getElementById('fatorInput').value = "";

        const grid = document.getElementById('fieldsGrid');
        grid.innerHTML = "";

        colunasModelo.forEach(col => {
            const val = p[col];
            const div = document.createElement('div');
            div.className = "flex flex-col gap-1";
            div.innerHTML = `
                <label class="text-[10px] font-black text-slate-400 uppercase">${col}</label>
                <input type="text" value="${val}" data-col="${col}" 
                       onchange="atualizarDados(this)"
                       class="p-2 border rounded text-xs outline-none focus:border-blue-500 ${val ? 'field-filled' : 'bg-slate-50 border-slate-200'}">
            `;
            grid.appendChild(div);
        });
    }

    function aplicarFator() {
        const f = parseFloat(document.getElementById('fatorInput').value) || 1;
        const p = produtosCarregados[produtoSelecionadoIdx];
        
        const fields = document.querySelectorAll('.input-data, input[data-col]');
        fields.forEach(input => {
            const col = input.getAttribute('data-col');
            const ori = parseFloat(p._original[col]);
            if(!isNaN(ori)) {
                if(col === 'Estoque') input.value = (ori * f).toFixed(2);
                else if(['Preço', 'Preço de custo', 'Preço de compra'].includes(col)) input.value = (ori / f).toFixed(4);
                p[col] = input.value;
            }
        });
    }
    document.getElementById('fatorInput').oninput = aplicarFator;

    function atualizarDados(el) {
        const col = el.getAttribute('data-col');
        produtosCarregados[produtoSelecionadoIdx][col] = el.value;
        if(el.value) el.classList.add('field-filled'); else el.classList.remove('field-filled');
    }

    document.getElementById('btnExport').onclick = () => {
        let csv = ["\ufeff" + colunasModelo.join(",")];
        produtosCarregados.forEach(p => {
            csv.push(colunasModelo.map(col => `"${String(p[col]).replace(/"/g, '""')}"`).join(","));
        });
        const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "IMPORTACAO_BLING_MESTRE.csv";
        a.click();
    };
</script>
</body>
</html>
