<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Importador Profissional NFe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 10; border-right: 2px solid #e2e8f0 !important; }
        input[type="text"]:focus { background-color: #f8fafc; outline: 2px solid #3b82f6; border-radius: 2px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-20">

    <header class="bg-slate-800 text-white p-6 shadow-lg mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-3">
                    <i class="fas fa-file-invoice-dollar text-blue-400"></i>
                    Conversor XML Corporativo
                </h1>
                <p class="text-slate-400 text-sm">Leitura múltipla e exportação personalizada de produtos</p>
            </div>
            <label class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold cursor-pointer transition-all flex items-center gap-2 shadow-md">
                <i class="fas fa-plus"></i> Importar XMLs
                <input type="file" id="xmlInput" accept=".xml" multiple class="hidden">
            </label>
        </div>
    </header>

    <main class="container mx-auto px-4" id="cardsContainer">
        <div id="placeholder" class="text-center py-20 border-2 border-dashed border-slate-300 rounded-xl text-slate-500">
            <i class="fas fa-cloud-upload-alt text-5xl mb-4"></i>
            <p class="text-xl">Arraste seus XMLs ou clique no botão acima para começar.</p>
        </div>
    </main>

    <template id="cardTemplate">
        <div class="nfe-card bg-white rounded-xl shadow-sm border border-slate-200 mb-10 overflow-hidden transition-all hover:shadow-md">
            <div class="bg-slate-50 border-b border-slate-200 p-4 flex justify-between items-center">
                <div class="flex gap-6">
                    <div>
                        <span class="text-xs font-bold text-slate-500 uppercase block">Fornecedor</span>
                        <span class="font-semibold text-slate-800 forn-nome">---</span>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-slate-500 uppercase block">CNPJ</span>
                        <span class="font-mono text-slate-700 forn-cnpj">---</span>
                    </div>
                    <div>
                        <span class="text-xs font-bold text-slate-500 uppercase block">Arquivo</span>
                        <span class="text-slate-600 file-name italic text-sm">---</span>
                    </div>
                </div>
                <button class="export-btn bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2 rounded flex items-center gap-2 transition-colors font-medium">
                    <i class="fas fa-file-csv"></i> Exportar Selecionados
                </button>
            </div>
            
            <div class="table-container overflow-x-auto custom-scrollbar">
                <table class="w-full text-left text-sm border-collapse">
                    <thead>
                        <tr class="bg-slate-100 text-slate-700 border-b border-slate-300" id="headerRow">
                            <th class="p-3 sticky-col bg-slate-100 w-10 text-center">
                                <input type="checkbox" class="select-all w-4 h-4 rounded">
                            </th>
                            </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        </tbody>
                </table>
            </div>
        </div>
    </template>

<script>
    const colunasModelo = [
        'ID', 'Código', 'Descrição', 'Unidade', 'NCM', 'Origem', 'Preço', 'Valor IPI fixo', 
        'Observações', 'Situação', 'Estoque', 'Preço de custo', 'Cód no fornecedor', 
        'Fornecedor', 'Localização', 'Estoque maximo', 'Estoque minimo', 'Peso líquido (Kg)', 
        'Peso bruto (Kg)', 'GTIN/EAN', 'GTIN/EAN da embalagem', 'Largura do Produto', 
        'Altura do Produto', 'Profundidade do produto', 'Data Validade', 
        'Descrição do Produto no Fornecedor', 'Descrição Complementar', 'Itens p/ caixa', 
        'Produto Variação', 'Tipo Produção', 'Classe de enquadramento do IPI', 
        'Código da lista de serviços', 'Tipo do item', 'Grupo de Tags/Tags', 'Tributos', 
        'Código Pai', 'Código Integração', 'Grupo de produtos', 'Marca', 'CEST', 'Volumes', 
        'Descrição Curta', 'Cross-Docking', 'URL Imagens Externas', 'Link Externo', 
        'Meses Garantia no Fornecedor', 'Clonar dados do pai', 'Condição do produto', 
        'Frete Grátis', 'Número FCI', 'Vídeo', 'Departamento', 'Unidade de medida', 
        'Preço de compra', 'Valor base ICMS ST para retenção', 'Valor ICMS ST para retenção', 
        'Valor ICMS próprio do substituto', 'Categoria do produto', 'Informações Adicionais'
    ];

    document.getElementById('xmlInput').addEventListener('change', function(e) {
        if(e.target.files.length > 0) {
            document.getElementById('placeholder').classList.add('hidden');
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(event.target.result, "text/xml");
                    criarCardNota(xmlDoc, file.name);
                };
                reader.readAsText(file);
            });
        }
    });

    function criarCardNota(xml, fileName) {
        const container = document.getElementById('cardsContainer');
        const template = document.getElementById('cardTemplate').content.cloneNode(true);
        
        // Dados Emitente
        const emit = xml.getElementsByTagName('emit')[0];
        const nomeForn = emit ? emit.getElementsByTagName('xNome')[0].textContent : "Não identificado";
        const cnpjForn = emit ? emit.getElementsByTagName('CNPJ')[0].textContent : "---";

        template.querySelector('.forn-nome').innerText = nomeForn;
        template.querySelector('.forn-cnpj').innerText = cnpjForn;
        template.querySelector('.file-name').innerText = fileName;

        const headerRow = template.querySelector('#headerRow');
        const tbody = template.querySelector('tbody');

        // Adicionar títulos das colunas
        colunasModelo.forEach(col => {
            const th = document.createElement('th');
            th.className = "p-3 font-semibold text-slate-600 whitespace-nowrap border-r border-slate-200";
            th.innerText = col;
            headerRow.appendChild(th);
        });

        // Adicionar Produtos
        const produtos = xml.getElementsByTagName('det');
        for (let i = 0; i < produtos.length; i++) {
            const prod = produtos[i].getElementsByTagName('prod')[0];
            const row = tbody.insertRow();
            row.className = "hover:bg-slate-50 transition-colors";
            
            // Checkbox de seleção
            const checkCell = row.insertCell();
            checkCell.className = "p-3 sticky-col text-center border-r";
            checkCell.innerHTML = `<input type="checkbox" class="prod-select w-4 h-4 rounded" checked>`;

            colunasModelo.forEach(col => {
                const cell = row.insertCell();
                cell.className = "p-1 border-r border-slate-100 min-w-[150px]";
                let valor = "";

                // Mapeamento Inteligente
                if(col === 'Código') valor = prod.getElementsByTagName('cProd')[0]?.textContent || "";
                if(col === 'Descrição') valor = prod.getElementsByTagName('xProd')[0]?.textContent || "";
                if(col === 'Unidade') valor = prod.getElementsByTagName('uCom')[0]?.textContent || "";
                if(col === 'NCM') valor = prod.getElementsByTagName('NCM')[0]?.textContent || "";
                if(col === 'Preço de custo' || col === 'Preço de compra') valor = prod.getElementsByTagName('vUnCom')[0]?.textContent || "0";
                if(col === 'Preço') valor = valor || prod.getElementsByTagName('vUnCom')[0]?.textContent || "0";
                if(col === 'GTIN/EAN') valor = prod.getElementsByTagName('cEAN')[0]?.textContent || "";
                if(col === 'Fornecedor') valor = nomeForn;
                if(col === 'Situação') valor = "Ativo";

                cell.innerHTML = `<input type="text" value="${valor}" class="w-full p-2 bg-transparent border-none text-slate-700">`;
            });
        }

        // Lógica de Selecionar Todos
        const selectAll = template.querySelector('.select-all');
        selectAll.addEventListener('change', (e) => {
            const checks = tbody.querySelectorAll('.prod-select');
            checks.forEach(c => c.checked = e.target.checked);
        });

        // Botão Exportar do Card
        template.querySelector('.export-btn').onclick = function() {
            exportarCSV(tbody, nomeForn);
        };

        container.appendChild(template);
    }

    function exportarCSV(tbody, nomeForn) {
        let csvRows = [];
        csvRows.push(colunasModelo.join(","));

        const rows = tbody.querySelectorAll("tr");
        let selecionados = 0;

        rows.forEach(row => {
            const isChecked = row.querySelector('.prod-select').checked;
            if (isChecked) {
                const rowData = [];
                const inputs = row.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    let val = input.value.replace(/,/g, ".");
                    rowData.push(`"${val}"`); // Aspas para evitar quebra com espaços
                });
                csvRows.push(rowData.join(","));
                selecionados++;
            }
        });

        if(selecionados === 0) {
            alert("Selecione ao menos um produto para exportar!");
            return;
        }

        const csvContent = "\ufeff" + csvRows.join("\n");
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `produtos_${nomeForn.substring(0,15)}.csv`);
        link.click();
    }
</script>
</body>
</html>
