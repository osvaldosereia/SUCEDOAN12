<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Master Converter | Integração Bling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 10px; width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        
        .sticky-col-check { position: sticky; left: 0; background: #f8fafc; z-index: 30; border-right: 1px solid #e2e8f0 !important; width: 50px; }
        .sticky-col-desc { position: sticky; left: 50px; background: white; z-index: 25; border-right: 2px solid #e2e8f0 !important; }

        .col-id { min-width: 100px; width: 100px; background: #fefce8 !important; } /* Amarelo claro para destaque */
        .col-cod { min-width: 100px; width: 120px; }
        .col-desc { min-width: 400px; }
        .col-small { min-width: 80px; width: 80px; }
        .col-med { min-width: 120px; width: 130px; }
        .col-large { min-width: 200px; }

        input[type="text"] { 
            width: 100%; 
            padding: 4px 8px;
            border: 1px solid transparent;
            background: transparent;
            transition: all 0.2s;
        }
        input[type="text"]:focus { 
            background: white; 
            border-color: #3b82f6; 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        tr:hover input[type="text"] { background: rgba(255,255,255,0.5); border-color: #e2e8f0; }
        
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 10px; font-bold: 700; text-transform: uppercase; }
        .status-vinc { background: #dcfce7; color: #166534; } /* Verde para vinculado */
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <header class="bg-slate-900 text-white p-6 shadow-xl border-b-4 border-blue-600">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-black tracking-tight flex items-center gap-3">
                    <i class="fas fa-sync-alt text-blue-400"></i> XML MASTER CONVERTER <span class="text-blue-500 text-sm font-light">v2.0</span>
                </h1>
                <p class="text-slate-400 text-xs font-medium">CONVERSOR COM INTELIGÊNCIA DE VÍNCULO POR EAN</p>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <label class="bg-slate-700 hover:bg-slate-600 text-white px-5 py-3 rounded-xl font-bold cursor-pointer transition-all flex items-center gap-2 border border-slate-600">
                    <i class="fas fa-database text-yellow-400"></i> 1. CARREGAR BASE BLING (CSV)
                    <input type="file" id="blingCsvInput" accept=".csv" class="hidden">
                </label>

                <label class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold cursor-pointer transition-all transform hover:scale-105 shadow-lg flex items-center gap-2">
                    <i class="fas fa-file-invoice"></i> 2. IMPORTAR XMLS
                    <input type="file" id="xmlInput" accept=".xml" multiple class="hidden">
                </label>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 mt-8 pb-20" id="cardsContainer">
        <div id="blingStatus" class="hidden mb-6 bg-emerald-100 border border-emerald-200 text-emerald-800 px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-bold">
            <i class="fas fa-check-circle"></i> Base de produtos Bling carregada: <span id="blingCount">0</span> produtos prontos para vínculo.
        </div>

        <div id="placeholder" class="bg-white text-center py-32 border-4 border-dashed border-slate-200 rounded-3xl text-slate-400">
            <i class="fas fa-project-diagram text-7xl mb-6 opacity-20"></i>
            <p class="text-2xl font-light">Siga os passos acima para iniciar o processamento.</p>
        </div>
    </main>

    <template id="cardTemplate">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 mb-12 overflow-hidden">
            <div class="bg-slate-50 p-5 border-b flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-8">
                    <div class="bg-white p-3 rounded-lg border border-slate-200">
                        <span class="text-[10px] font-black text-blue-600 uppercase block mb-1">Emitente</span>
                        <span class="font-bold text-slate-800 forn-nome text-lg">---</span>
                    </div>
                </div>
                <button class="export-btn bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-emerald-100 transition-all">
                    <i class="fas fa-download"></i> EXPORTAR CSV PARA O BLING
                </button>
            </div>
            
            <div class="overflow-x-auto custom-scrollbar">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-slate-800 text-slate-300 uppercase text-[11px] tracking-widest" id="headerRow">
                            <th class="p-4 sticky-col-check bg-slate-800 border-r border-slate-700">
                                <input type="checkbox" class="select-all w-4 h-4 accent-blue-500">
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </template>

<script>
    // Memória global para a base do Bling
    let baseBling = {}; // Chave: EAN, Valor: ID

    const colunasModelo = [
        'ID', 'Código', 'Descrição', 'Unidade', 'NCM', 'Origem', 'Preço', 'Valor IPI fixo', 
        'Observações', 'Situação', 'Estoque', 'Preço de custo', 'Cód no fornecedor', 
        'Fornecedor', 'Localização', 'Estoque maximo', 'Estoque minimo', 'Peso líquido (Kg)', 
        'Peso bruto (Kg)', 'GTIN/EAN', 'GTIN/EAN da embalagem', 'Largura do Produto', 
        'Altura do Produto', 'Profundidade do produto', 'Data Validade', 
        'Descrição do Produto no Fornecedor', 'Descrição Complementar', 'Itens p/ caixa', 
        'Produto Variação', 'Tipo Produção', 'Classe de enquadramento do IPI', 
        'Código da lista de serviços', 'Tipo do item', 'Grupo de Tags/Tags', 'Tributos', 
        'Código Pai', 'Código Integração', 'Grupo de produtos', 'Marca', 'CEST', 'Volumes', 
        'Descrição Curta', 'Cross-Docking', 'URL Imagens Externas', 'Link Externo', 
        'Meses Garantia no Fornecedor', 'Clonar dados do pai', 'Condição do produto', 
        'Frete Grátis', 'Número FCI', 'Vídeo', 'Departamento', 'Unidade de medida', 
        'Preço de compra', 'Valor base ICMS ST para retenção', 'Valor ICMS ST para retenção', 
        'Valor ICMS próprio do substituto', 'Categoria do produto', 'Informações Adicionais'
    ];

    // 1. Lógica para processar o CSV do Bling
    document.getElementById('blingCsvInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const text = event.target.result;
            const rows = text.split(/\r?\n/);
            const headers = rows[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            const idxID = headers.indexOf('ID');
            const idxEAN = headers.indexOf('GTIN/EAN');

            if (idxID === -1 || idxEAN === -1) {
                alert("Erro: O CSV do Bling deve conter as colunas 'ID' e 'GTIN/EAN'.");
                return;
            }

            let count = 0;
            baseBling = {}; // Limpa base anterior
            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); // Split que ignora vírgulas dentro de aspas
                if (cols.length > idxEAN) {
                    const idVal = cols[idxID]?.replace(/"/g, '').trim();
                    const eanVal = cols[idxEAN]?.replace(/"/g, '').trim();
                    if (eanVal && eanVal !== "") {
                        baseBling[eanVal] = idVal;
                        count++;
                    }
                }
            }
            
            const status = document.getElementById('blingStatus');
            status.classList.remove('hidden');
            document.getElementById('blingCount').innerText = count;
        };
        reader.readAsText(file);
    });

    // 2. Lógica para processar os XMLs
    document.getElementById('xmlInput').addEventListener('change', function(e) {
        if(e.target.files.length > 0) {
            document.getElementById('placeholder').style.display = 'none';
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(event.target.result, "text/xml");
                    criarCardNota(xmlDoc, file.name);
                };
                reader.readAsText(file);
            });
        }
    });

    function criarCardNota(xml, fileName) {
        const container = document.getElementById('cardsContainer');
        const template = document.getElementById('cardTemplate').content.cloneNode(true);
        
        const emit = xml.getElementsByTagName('emit')[0];
        const nomeForn = emit ? emit.getElementsByTagName('xNome')[0].textContent : "Desconhecido";
        const cnpjForn = emit ? emit.getElementsByTagName('CNPJ')[0].textContent : "---";

        template.querySelector('.forn-nome').innerText = nomeForn;
        const headerRow = template.querySelector('#headerRow');
        const tbody = template.querySelector('tbody');

        colunasModelo.forEach(col => {
            const th = document.createElement('th');
            let classe = "p-4 font-bold border-r border-slate-700 whitespace-nowrap ";
            if(col === 'ID') classe += "col-id";
            else if(col === 'Descrição') classe += "col-desc sticky-col-desc bg-slate-800";
            else if(['Unidade', 'Estoque', 'Origem'].includes(col)) classe += "col-small";
            else if(['NCM', 'Preço', 'Preço de custo'].includes(col)) classe += "col-med";
            else if(col === 'Código') classe += "col-cod";
            else classe += "col-large";
            th.className = classe;
            th.innerText = col;
            headerRow.appendChild(th);
        });

        const itens = xml.getElementsByTagName('det');
        for (let i = 0; i < itens.length; i++) {
            const prod = itens[i].getElementsByTagName('prod')[0];
            const row = tbody.insertRow();
            
            const checkCell = row.insertCell();
            checkCell.className = "p-4 sticky-col-check text-center";
            checkCell.innerHTML = `<input type="checkbox" class="prod-select w-4 h-4 accent-blue-600" checked>`;

            // Extração de dados básica para o vínculo
            const eanXML = prod.getElementsByTagName('cEAN')[0]?.textContent || "";
            const idVinculado = baseBling[eanXML] || "";

            colunasModelo.forEach(col => {
                const cell = row.insertCell();
                let valor = "";
                let classe = "p-2 border-r border-slate-100 ";

                if(col === 'ID') { 
                    valor = idVinculado; 
                    classe += "col-id";
                    if(idVinculado) cell.innerHTML = `<div class="flex flex-col"><span class="status-badge status-vinc mb-1 text-center">Vinculado</span><input type="text" value="${valor}" class="font-bold text-blue-800"></div>`;
                    else cell.innerHTML = `<input type="text" value="${valor}">`;
                    cell.className = classe;
                    return;
                }
                
                if(col === 'Código') { valor = prod.getElementsByTagName('cProd')[0]?.textContent || ""; classe += "col-cod"; }
                else if(col === 'Descrição') { valor = prod.getElementsByTagName('xProd')[0]?.textContent || ""; classe += "col-desc sticky-col-desc"; }
                else if(col === 'Unidade') { valor = prod.getElementsByTagName('uCom')[0]?.textContent || ""; classe += "col-small"; }
                else if(col === 'Estoque') { valor = prod.getElementsByTagName('qCom')[0]?.textContent || "0"; classe += "col-small text-blue-700 font-bold"; }
                else if(col === 'NCM') { valor = prod.getElementsByTagName('NCM')[0]?.textContent || ""; classe += "col-med"; }
                else if(col === 'Preço de custo' || col === 'Preço de compra' || col === 'Preço') { valor = prod.getElementsByTagName('vUnCom')[0]?.textContent || "0"; classe += "col-med"; }
                else if(col === 'GTIN/EAN') { valor = eanXML; classe += "col-med"; }
                else if(col === 'Fornecedor') { valor = nomeForn; classe += "col-large"; }
                else if(col === 'Situação') { valor = "Ativo"; classe += "col-small"; }
                else classe += "col-large";

                cell.className = classe;
                cell.innerHTML = `<input type="text" value="${valor}">`;
            });
        }

        template.querySelector('.select-all').addEventListener('change', (e) => {
            tbody.querySelectorAll('.prod-select').forEach(c => c.checked = e.target.checked);
        });

        template.querySelector('.export-btn').onclick = () => exportarCSV(tbody, nomeForn);
        container.appendChild(template);
    }

    function exportarCSV(tbody, nomeForn) {
        let csvRows = ["\ufeff" + colunasModelo.join(",")];
        const rows = tbody.querySelectorAll("tr");
        rows.forEach(row => {
            if (row.querySelector('.prod-select').checked) {
                const data = Array.from(row.querySelectorAll('input[type="text"]')).map(i => `"${i.value.replace(/"/g, '""')}"`);
                csvRows.push(data.join(","));
            }
        });
        const blob = new Blob([csvRows.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `IMPORTAR_BLING_${nomeForn.replace(/[^a-z0-9]/gi, '_').toUpperCase()}.csv`;
        link.click();
    }
</script>
</body>
</html>
