<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Master Pro | Soma de Estoque Bling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .field-filled { background-color: #eff6ff !important; border-color: #bfdbfe !important; }
        .selected-item { border-left: 6px solid #3b82f6 !important; background-color: #f1f5f9; }
        .master-panel, .detail-panel { height: calc(100vh - 140px); overflow-y: auto; }
        .xml-divider { background: #f8fafc; border-y: 1px solid #e2e8f0; padding: 6px 12px; font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .status-vinc { background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; }
        .estoque-highlight { background: #fef9c3; border: 1px solid #facc15; padding: 4px 8px; border-radius: 6px; font-weight: bold; color: #854d0e; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen overflow-hidden text-slate-900">

    <header class="bg-slate-900 text-white p-4 shadow-lg flex justify-between items-center z-50 relative">
        <h1 class="text-xl font-black flex items-center gap-2">
            <i class="fas fa-calculator text-blue-400"></i> XML MASTER <span class="text-blue-500">STOCK SUM</span>
        </h1>
        <div class="flex gap-3">
            <label class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 border border-slate-600 transition-all shadow-sm">
                <i class="fas fa-database text-yellow-400"></i> 1. CARREGAR BASE BLING
                <input type="file" id="blingCsvInput" accept=".csv" class="hidden">
            </label>
            <label class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg font-bold cursor-pointer text-xs flex items-center gap-2 shadow-lg transition-all">
                <i class="fas fa-file-upload"></i> 2. IMPORTAR XMLS
                <input type="file" id="xmlInput" accept=".xml" multiple class="hidden">
            </label>
        </div>
    </header>

    <div class="container mx-auto px-4 mt-4">
        <div id="blingAlert" class="hidden mb-4 bg-emerald-600 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-md">
            <i class="fas fa-check-circle"></i> BASE BLING CARREGADA. O sistema somará o estoque atual com o da nota automaticamente.
        </div>

        <div class="flex gap-6">
            <div class="w-1/3 bg-white rounded-xl shadow-sm border border-slate-200 master-panel custom-scrollbar">
                <div class="p-4 border-b bg-slate-50 sticky top-0 z-20 flex justify-between items-center">
                    <h2 class="font-bold text-slate-700 text-[10px] uppercase">Itens por Nota</h2>
                    <button id="btnExport" class="hidden bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-bold text-xs hover:bg-emerald-700 transition-all">
                        EXPORTAR (<span id="countSelected">0</span>)
                    </button>
                </div>
                <div id="productList" class="divide-y divide-slate-100">
                    <p class="p-8 text-center text-slate-400 italic text-sm">Aguardando Importação...</p>
                </div>
            </div>

            <div class="w-2/3 bg-white rounded-xl shadow-sm border border-slate-200 detail-panel custom-scrollbar p-6">
                <div id="editorPlaceholder" class="flex flex-col items-center justify-center h-full text-slate-400">
                    <i class="fas fa-calculator text-5xl mb-4 opacity-10"></i>
                    <p>Selecione um produto para calcular o estoque final</p>
                </div>

                <div id="editorContent" class="hidden">
                    <div class="flex justify-between items-start border-b pb-4 mb-6">
                        <div class="flex-1 mr-4">
                            <label class="text-[9px] font-black text-blue-500 uppercase">Descrição do Produto</label>
                            <input type="text" id="editMainName" class="text-lg font-bold text-slate-800 uppercase w-full bg-slate-50 border-b-2 border-transparent focus:border-blue-500 focus:bg-white outline-none p-1 transition-all" oninput="sincronizarNome(this)">
                            
                            <div id="calcInfo" class="mt-3 flex gap-2"></div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-xl border border-blue-100 flex items-center gap-3">
                            <span class="text-[10px] font-black text-blue-800 uppercase">FATOR (X)</span>
                            <input type="number" id="fatorInput" placeholder="1" class="w-16 p-2 rounded-lg border-blue-200 text-blue-900 font-bold focus:ring-2 focus:ring-blue-500 outline-none text-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-3 gap-x-4 gap-y-3" id="fieldsGrid"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    let baseBling = {}; 
    let produtosCarregados = [];
    let produtoSelecionadoIdx = null;

    const colunasModelo = [
        'ID', 'Código', 'Descrição', 'Unidade', 'NCM', 'Origem', 'Preço', 'Valor IPI fixo', 
        'Observações', 'Situação', 'Estoque', 'Preço de custo', 'Cód no fornecedor', 
        'Fornecedor', 'Localização', 'Estoque maximo', 'Estoque minimo', 'Peso líquido (Kg)', 
        'Peso bruto (Kg)', 'GTIN/EAN', 'GTIN/EAN da embalagem', 'Largura do Produto', 
        'Altura do Produto', 'Profundidade do produto', 'Data Validade', 
        'Descrição do Produto no Fornecedor', 'Descrição Complementar', 'Itens p/ caixa', 
        'Produto Variação', 'Tipo Produção', 'Classe de enquadramento do IPI', 
        'Código da lista de serviços', 'Tipo do item', 'Grupo de Tags/Tags', 'Tributos', 
        'Código Pai', 'Código Integração', 'Grupo de produtos', 'Marca', 'CEST', 'Volumes', 
        'Descrição Curta', 'Cross-Docking', 'URL Imagens Externas', 'Link Externo', 
        'Meses Garantia no Fornecedor', 'Clonar dados do pai', 'Condição do produto', 
        'Frete Grátis', 'Número FCI', 'Vídeo', 'Departamento', 'Unidade de medida', 
        'Preço de compra', 'Valor base ICMS ST para retenção', 'Valor ICMS ST para retenção', 
        'Valor ICMS próprio do substituto', 'Categoria do produto', 'Informações Adicionais'
    ];

    document.getElementById('blingCsvInput').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(ev) {
            const rows = ev.target.result.split(/\r?\n/);
            const sep = rows[0].includes(';') ? ';' : ',';
            const headers = rows[0].split(sep).map(h => h.replace(/"/g, '').trim().toUpperCase());
            const idxID = headers.findIndex(h => h === 'ID');
            const idxEAN = headers.findIndex(h => h.includes('EAN') || h.includes('GTIN'));
            const idxEstoque = headers.findIndex(h => h === 'ESTOQUE');

            baseBling = {};
            rows.forEach((row, i) => {
                if(i===0) return;
                const cols = row.split(new RegExp(`${sep}(?=(?:(?:[^"]*"){2})*[^"]*$)`));
                const ean = cols[idxEAN]?.replace(/"/g, '').trim();
                if(ean) {
                    baseBling[ean] = {
                        id: cols[idxID]?.replace(/"/g, '').trim() || "",
                        estoqueAtual: parseFloat(cols[idxEstoque]?.replace(/"/g, '').replace(',', '.') || 0)
                    };
                }
            });
            document.getElementById('blingAlert').classList.remove('hidden');
        };
        reader.readAsText(e.target.files[0]);
    });

    document.getElementById('xmlInput').addEventListener('change', function(e) {
        Array.from(e.target.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const xml = new DOMParser().parseFromString(ev.target.result, "text/xml");
                processarXML(xml, file.name);
            };
            reader.readAsText(file);
        });
    });

    function processarXML(xml, fileName) {
        const emit = xml.getElementsByTagName('emit')[0];
        const nomeForn = emit?.getElementsByTagName('xNome')[0]?.textContent || "Desconhecido";
        const itens = xml.getElementsByTagName('det');

        for (let i = 0; i < itens.length; i++) {
            const prod = itens[i].getElementsByTagName('prod')[0];
            const ean = prod.getElementsByTagName('cEAN')[0]?.textContent || "";
            const dadosBling = baseBling[ean] || { id: "", estoqueAtual: 0 };
            const qCom = parseFloat(prod.getElementsByTagName('qCom')[0]?.textContent || 0);

            let obj = {
                _xmlSource: fileName,
                _selected: true,
                _original: {},
                _vinculado: dadosBling.id !== "",
                _estoqueBling: dadosBling.estoqueAtual
            };

            colunasModelo.forEach(col => {
                let val = "";
                if(col === 'ID') val = dadosBling.id;
                else if(col === 'Descrição') val = prod.getElementsByTagName('xProd')[0]?.textContent || "";
                else if(col === 'Código') val = prod.getElementsByTagName('cProd')[0]?.textContent || "";
                else if(col === 'Estoque') val = (dadosBling.estoqueAtual + qCom).toString(); // SOMA INICIAL
                else if(['Preço', 'Preço de custo', 'Preço de compra'].includes(col)) val = prod.getElementsByTagName('vUnCom')[0]?.textContent || "0";
                else if(col === 'GTIN/EAN') val = ean;
                else if(col === 'Fornecedor') val = nomeForn;
                else if(col === 'Situação') val = "Ativo";
                else val = "";
                
                obj[col] = val;
                if(['Estoque', 'Preço', 'Preço de custo', 'Preço de compra'].includes(col)) {
                    // O estoque original para cálculo do fator é APENAS o que vem da nota
                    obj._original[col] = (col === 'Estoque') ? qCom : val;
                }
            });
            produtosCarregados.push(obj);
        }
        renderLista();
        document.getElementById('btnExport').classList.remove('hidden');
        atualizarContador();
    }

    function renderLista() {
        const list = document.getElementById('productList');
        list.innerHTML = "";
        const grupos = {};
        produtosCarregados.forEach((p, idx) => {
            if(!grupos[p._xmlSource]) grupos[p._xmlSource] = [];
            grupos[p._xmlSource].push({p, idx});
        });

        for(const fileName in grupos) {
            const divXml = document.createElement('div');
            divXml.className = "xml-divider";
            divXml.innerText = fileName;
            list.appendChild(divXml);

            grupos[fileName].forEach(({p, idx}) => {
                const item = document.createElement('div');
                item.className = `p-3 flex items-center gap-3 cursor-pointer transition-all border-l-4 border-transparent ${produtoSelecionadoIdx === idx ? 'selected-item' : 'hover:bg-slate-50'}`;
                item.onclick = () => selecionarProduto(idx);
                item.innerHTML = `
                    <input type="checkbox" class="w-4 h-4" ${p._selected ? 'checked' : ''} onclick="event.stopPropagation(); toggleItem(${idx})">
                    <div class="flex-1 overflow-hidden">
                        <p class="text-[11px] font-bold text-slate-800 truncate uppercase name-ref-${idx}">${p.Descrição}</p>
                        <div class="flex gap-2">
                             ${p._vinculado ? '<span class="status-vinc">VINCULADO</span>' : '<span class="text-[9px] bg-slate-100 px-1 rounded">NOVO</span>'}
                             <span class="text-[9px] text-slate-400 font-mono">Qtd Nota: ${p._original.Estoque}</span>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }
    }

    function selecionarProduto(idx) {
        produtoSelecionadoIdx = idx;
        const p = produtosCarregados[idx];
        renderLista();
        document.getElementById('editorPlaceholder').classList.add('hidden');
        document.getElementById('editorContent').classList.remove('hidden');
        document.getElementById('editMainName').value = p.Descrição;
        
        // Exibir Cálculo de Estoque
        const calcArea = document.getElementById('calcInfo');
        const total = parseFloat(p.Estoque);
        calcArea.innerHTML = `
            <div class="estoque-highlight text-[10px]">
                Bling: ${p._estoqueBling} + Nota: ${(total - p._estoqueBling).toFixed(2)} = Total Final: ${total.toFixed(2)}
            </div>
        `;

        const grid = document.getElementById('fieldsGrid');
        grid.innerHTML = "";
        colunasModelo.forEach(col => {
            const val = p[col];
            const div = document.createElement('div');
            div.className = "flex flex-col gap-1";
            div.innerHTML = `
                <label class="text-[9px] font-black text-slate-400 uppercase tracking-tighter">${col}</label>
                <input type="text" value="${val}" data-col="${col}" oninput="atualizarCampo(this)"
                       class="p-2 border border-slate-200 rounded-lg text-xs outline-none focus:border-blue-500 ${val ? 'field-filled' : 'bg-slate-50'}">
            `;
            grid.appendChild(div);
        });
    }

    function aplicarFator() {
        const f = parseFloat(document.getElementById('fatorInput').value) || 1;
        const p = produtosCarregados[produtoSelecionadoIdx];
        document.querySelectorAll('input[data-col]').forEach(input => {
            const col = input.dataset.col;
            const ori = parseFloat(p._original[col]);
            if(!isNaN(ori)) {
                if(col === 'Estoque') {
                    const novoEstoqueNota = ori * f;
                    const somaTotal = p._estoqueBling + novoEstoqueNota;
                    input.value = somaTotal.toFixed(2);
                    // Atualiza o box de cálculo no topo
                    document.getElementById('calcInfo').innerHTML = `
                        <div class="estoque-highlight text-[10px]">
                            Bling: ${p._estoqueBling} + (Nota: ${ori} x Fator: ${f}) = Total Final: ${somaTotal.toFixed(2)}
                        </div>
                    `;
                } else if(['Preço', 'Preço de custo', 'Preço de compra'].includes(col)) {
                    input.value = (ori / f).toFixed(4);
                }
                p[col] = input.value;
            }
        });
    }
    document.getElementById('fatorInput').oninput = aplicarFator;

    function atualizarCampo(el) {
        const col = el.dataset.col;
        produtosCarregados[produtoSelecionadoIdx][col] = el.value;
        if(col === 'Descrição') document.querySelector(`.name-ref-${produtoSelecionadoIdx}`).innerText = el.value;
    }

    function sincronizarNome(el) {
        produtosCarregados[produtoSelecionadoIdx].Descrição = el.value;
        document.querySelector(`.name-ref-${produtoSelecionadoIdx}`).innerText = el.value;
        const inp = document.querySelector(`input[data-col="Descrição"]`);
        if(inp) inp.value = el.value;
    }

    function toggleItem(idx) { produtosCarregados[idx]._selected = !produtosCarregados[idx]._selected; atualizarContador(); }
    function atualizarContador() { document.getElementById('countSelected').innerText = produtosCarregados.filter(p => p._selected).length; }

    document.getElementById('btnExport').onclick = () => {
        const sel = produtosCarregados.filter(p => p._selected);
        if(sel.length === 0) return alert("Selecione itens!");
        let csv = ["\ufeff" + colunasModelo.join(",")];
        sel.forEach(p => csv.push(colunasModelo.map(col => `"${String(p[col]).replace(/"/g, '""')}"`).join(",")));
        const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `CONSOLIDADO_BLING_SOMA.csv`;
        a.click();
    };
</script>
</body>
</html>
