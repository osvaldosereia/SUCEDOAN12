<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAS | Bling Master Suite v5.0</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --bg: #f8fafc;
            --surface: #ffffff;
            --primary: #1e293b;
            --accent: #2563eb;
            --success: #16a34a;
            --border: #e2e8f0;
            --text-dim: #64748b;
            --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: var(--font); background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; color: var(--primary); }

        /* --- TABS DE NAVEGA√á√ÉO --- */
        .tabs {
            background: var(--surface);
            display: flex;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            gap: 20px;
        }

        .tab-btn {
            padding: 16px 4px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            transition: 0.2s;
        }

        .tab-btn:hover { color: var(--accent); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* --- CONTE√öDO --- */
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }

        /* Header Interno */
        header {
            background: var(--surface); height: 60px; padding: 0 24px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        
        /* Inputs e Bot√µes */
        .btn {
            height: 36px; padding: 0 16px; border-radius: 6px; font-weight: 600; font-size: 0.85rem;
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s;
            border: 1px solid var(--border); background: white; color: var(--primary);
        }
        .btn:hover { background: #f1f5f9; }
        .btn-primary { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-success:hover { background: #15803d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .file-upload { position: relative; overflow: hidden; }
        .file-upload input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        input, textarea {
            border: 1px solid var(--border); padding: 8px; border-radius: 6px;
            font-size: 0.9rem; width: 100%; font-family: inherit;
        }
        input:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

        /* --- TAB 1: XML (Estilos da vers√£o anterior) --- */
        .grid-header {
            display: grid; grid-template-columns: 40px 110px 2fr 60px 80px 80px 100px 100px 120px 40px;
            gap: 12px; padding: 10px 20px; font-size: 0.75rem; font-weight: 700; color: var(--text-dim); text-transform: uppercase;
        }
        .row-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
            margin-bottom: 8px; padding: 12px 16px;
            display: grid; grid-template-columns: 40px 110px 2fr 60px 80px 80px 100px 100px 120px 40px;
            gap: 12px; align-items: center;
        }
        .row-card.is-st { border-left: 4px solid #7c3aed; }
        .row-details { display: none; padding: 15px; background: #f8fafc; border-top: 1px solid var(--border); grid-column: 1 / -1; margin-top: 10px; }
        .row-details.open { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }

        /* --- TAB 2: KITS (Novos Estilos) --- */
        .kit-container { padding: 20px; display: flex; gap: 20px; height: 100%; }
        .kit-input-area { flex: 1; display: flex; flex-direction: column; gap: 15px; max-width: 400px; }
        .kit-preview-area { flex: 2; background: white; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        
        .kit-preview-header {
            background: #f1f5f9; padding: 10px 15px; font-weight: 700; font-size: 0.8rem; color: var(--text-dim);
            display: grid; grid-template-columns: 60px 1fr 100px; border-bottom: 1px solid var(--border);
        }
        .kit-item {
            padding: 10px 15px; border-bottom: 1px solid var(--border);
            display: grid; grid-template-columns: 60px 1fr 100px; align-items: center;
        }
        .qty-badge { background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-weight: 700; text-align: center; }

        /* Scroll Area */
        main { flex: 1; overflow: auto; padding: 10px; }
    </style>
</head>
<body>

    <div class="tabs">
        <button class="tab-btn active" onclick="Tabs.open('xml')">üìÑ Importar XML (NFe)</button>
        <button class="tab-btn" onclick="Tabs.open('kit')">üì¶ Gerador de Kits (Composi√ß√£o)</button>
    </div>

    <div id="tab-xml" class="tab-content active">
        <header>
            <h1 style="font-size:1rem; font-weight:700">Importar NFe</h1>
            <div style="display:flex; gap:10px">
                <div class="btn btn-primary file-upload">
                    Carregar XML
                    <input type="file" id="xmlInput" accept=".xml">
                </div>
                <button class="btn btn-success" id="btnExport" onclick="App.exportExcel()" disabled>
                    Baixar Excel Produtos
                </button>
            </div>
        </header>

        <div class="grid-header">
            <div>#</div><div>C√≥digo</div><div>Descri√ß√£o</div><div style="text-align:center">Und</div>
            <div style="text-align:center">Fator</div><div style="text-align:center">Und Venda</div>
            <div style="text-align:right">Custo</div><div style="text-align:right">Estoque</div>
            <div>Marca</div><div></div>
        </div>

        <main id="gridContainer">
            <div style="text-align:center; padding: 50px; color: #94a3b8;">
                Arraste o XML para importar produtos.
            </div>
        </main>
    </div>

    <div id="tab-kit" class="tab-content">
        <header>
            <h1 style="font-size:1rem; font-weight:700">Criar Novo Kit</h1>
            <button class="btn btn-success" onclick="Kit.export()">
                Baixar Planilha de Composi√ß√£o
            </button>
        </header>

        <main>
            <div class="kit-container">
                <div class="kit-input-area">
                    <div style="background:white; padding:15px; border-radius:8px; border:1px solid var(--border)">
                        <h3 style="margin:0 0 10px 0; font-size:0.9rem">Dados do Produto Pai (Kit)</h3>
                        <div style="display:flex; flex-direction:column; gap:10px">
                            <label style="font-size:0.8rem; font-weight:600">C√≥digo do Kit (SKU Pai)</label>
                            <input type="text" id="kitCode" placeholder="Ex: KIT-CAFE-01">
                            
                            <label style="font-size:0.8rem; font-weight:600">Descri√ß√£o do Kit (Nome Pai)</label>
                            <input type="text" id="kitName" placeholder="Ex: Kit Caf√© Caboclo Promocional">
                        </div>
                    </div>

                    <div style="background:white; padding:15px; border-radius:8px; border:1px solid var(--border); flex:1; display:flex; flex-direction:column">
                        <h3 style="margin:0 0 10px 0; font-size:0.9rem">Lista de Componentes</h3>
                        <p style="font-size:0.75rem; color:#64748b; margin-bottom:5px">
                            Cole a lista no formato: <strong>1x NOME DO PRODUTO</strong>
                        </p>
                        <textarea id="kitList" style="flex:1; resize:none; font-family:monospace" 
                                  placeholder="1x CAFE CABOCLO 500G&#10;2x ACUCAR UNIAO 1KG&#10;..."
                                  oninput="Kit.parse()"></textarea>
                    </div>
                </div>

                <div class="kit-preview-area">
                    <div class="kit-preview-header">
                        <div style="text-align:center">Qtd</div>
                        <div>Componente (Descri√ß√£o)</div>
                        <div style="text-align:center">Status</div>
                    </div>
                    <div id="kitPreviewList" style="overflow:auto; flex:1">
                        <div style="padding:20px; text-align:center; color:#94a3b8">
                            A pr√©via dos itens aparecer√° aqui...
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
/**
 * SISTEMAS - Controle de Abas
 */
const Tabs = {
    open(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(`tab-${tabId}`).classList.add('active');
        event.target.classList.add('active');
    }
};

/**
 * SISTEMAS - M√≥dulo de Kits (NOVO)
 */
const Kit = {
    items: [],

    parse() {
        const text = document.getElementById('kitList').value;
        const lines = text.split('\n');
        this.items = [];

        lines.forEach(line => {
            line = line.trim();
            if(!line) return;

            // Regex: Pega n√∫mero seguido de x (ex: 10x) e o resto √© o nome
            const match = line.match(/^(\d+)[xX]\s+(.+)/);
            
            if(match) {
                this.items.push({
                    qty: parseInt(match[1]),
                    name: match[2].trim()
                });
            }
        });

        this.render();
    },

    render() {
        const container = document.getElementById('kitPreviewList');
        container.innerHTML = '';

        if(this.items.length === 0) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8">Lista vazia ou formato incorreto.</div>';
            return;
        }

        this.items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'kit-item';
            div.innerHTML = `
                <div style="text-align:center"><span class="qty-badge">${item.qty}</span></div>
                <div>${item.name}</div>
                <div style="text-align:center; font-size:0.75rem; color:#16a34a">OK</div>
            `;
            container.appendChild(div);
        });
    },

    export() {
        const parentCode = document.getElementById('kitCode').value.trim();
        const parentName = document.getElementById('kitName').value.trim();

        if(!parentCode || !parentName || this.items.length === 0) {
            alert("Preencha o C√≥digo, Nome do Kit e a Lista de Itens.");
            return;
        }

        // Cabe√ßalhos EXATOS do modelo fornecido (9 colunas)
        const headers = [
            'ID da composi√ß√£o', 
            'Descri√ß√£o da composi√ß√£o', 
            'C√≥digo da composi√ß√£o', 
            'ID do componente', 
            'Descri√ß√£o do componente', 
            'C√≥digo componente', 
            'Quantidade do Componente', 
            'Custo unit√°rio', 
            'Opera√ß√£o'
        ];

        const rows = this.items.map(item => {
            return [
                "",              // ID Comp (Vazio para novo)
                parentName,      // Descri√ß√£o Pai
                parentCode,      // C√≥digo Pai
                "",              // ID Comp (Vazio)
                item.name,       // Descri√ß√£o Componente (Nome Exato)
                "",              // C√≥digo Componente (Vazio - Bling tenta vincular pelo nome ou cria)
                item.qty,        // Quantidade
                "0",             // Custo (Vazio para teste)
                "A"              // Opera√ß√£o (A = Alterar/Adicionar)
            ];
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
        XLSX.utils.book_append_sheet(wb, ws, "Composicao");
        XLSX.writeFile(wb, `Kit_${parentCode}.xlsx`);
    }
};

/**
 * SISTEMAS - M√≥dulo NFe (Existente - Revisado V4)
 */
const App = {
    data: [],
    meta: {},
    headers: [
        "ID", "C√≥digo", "Descri√ß√£o", "Unidade", "NCM", "Origem", "Pre√ßo", "Valor IPI fixo", 
        "Observa√ß√µes", "Situa√ß√£o", "Estoque", "Pre√ßo de custo", "C√≥d no fornecedor", 
        "Fornecedor", "Localiza√ß√£o", "Estoque maximo", "Estoque minimo", "Peso l√≠quido (Kg)", 
        "Peso bruto (Kg)", "GTIN/EAN", "GTIN/EAN da embalagem", "Largura do Produto", 
        "Altura do Produto", "Profundidade do produto", "Data Validade", 
        "Descri√ß√£o do Produto no Fornecedor", "Descri√ß√£o Complementar", "Itens p/ caixa", 
        "Produto Varia√ß√£o", "Tipo Produ√ß√£o", "Classe de enquadramento do IPI", 
        "C√≥digo da lista de servi√ßos", "Tipo do item", "Grupo de Tags/Tags", "Tributos", 
        "C√≥digo Pai", "C√≥digo Integra√ß√£o", "Grupo de produtos", "Marca", "CEST", "Volumes", 
        "Descri√ß√£o Curta", "Cross-Docking", "URL Imagens Externas", "Link Externo", 
        "Meses Garantia no Fornecedor", "Clonar dados do pai", "Condi√ß√£o do produto", 
        "Frete Gr√°tis", "N√∫mero FCI", "V√≠deo", "Departamento", "Unidade de medida", 
        "Pre√ßo de compra", "Valor base ICMS ST para reten√ß√£o", "Valor ICMS ST para reten√ß√£o", 
        "Valor ICMS pr√≥prio do substituto", "Categoria do produto", "Informa√ß√µes Adicionais"
    ],

    init() {
        document.getElementById('xmlInput').addEventListener('change', (e) => this.processFile(e.target.files[0]));
    },

    processFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try { this.parseXML(e.target.result); this.render(); document.getElementById('btnExport').disabled = false; } 
            catch (err) { alert("Erro XML: " + err.message); }
        };
        reader.readAsText(file);
    },

    getVal(parent, tag) {
        const els = parent.getElementsByTagName(tag);
        return els.length > 0 ? els[0].textContent : "";
    },

    parseXML(xmlString) {
        const parser = new DOMParser();
        const xml = parser.parseFromString(xmlString, "text/xml");
        const emit = xml.getElementsByTagName('emit')[0];
        const ide = xml.getElementsByTagName('ide')[0];
        this.meta = { fornecedor: this.getVal(emit, 'xNome'), nfe: this.getVal(ide, 'nNF') };
        this.data = [];
        const dets = xml.getElementsByTagName('det');
        
        for(let i=0; i<dets.length; i++) {
            const prod = dets[i].getElementsByTagName('prod')[0];
            const imposto = dets[i].getElementsByTagName('imposto')[0];
            const vProd = parseFloat(this.getVal(prod, 'vProd') || 0);
            const qCom = parseFloat(this.getVal(prod, 'qCom') || 0);
            
            let vAcres = 0;
            if(this.getVal(imposto, 'vIPI')) vAcres += parseFloat(this.getVal(imposto, 'vIPI'));
            if(this.getVal(imposto, 'vICMSST')) vAcres += parseFloat(this.getVal(imposto, 'vICMSST'));
            if(this.getVal(prod, 'vFrete')) vAcres += parseFloat(this.getVal(prod, 'vFrete'));

            let isST = false;
            if (this.getVal(imposto, 'vICMSST') > 0) isST = true;
            const csosn = this.getVal(imposto, 'CSOSN');
            if (['201','202','203','500'].includes(csosn)) isST = true;

            this.data.push({
                _id: i,
                codigo: this.getVal(prod, 'cProd'),
                descricao: this.getVal(prod, 'xProd'),
                unidade: this.getVal(prod, 'uCom') === 'CX' ? 'UN' : this.getVal(prod, 'uCom'),
                orig: this.getVal(imposto, 'orig') || "0",
                ncm: this.getVal(prod, 'NCM'),
                cest: this.getVal(prod, 'CEST'),
                qCom: qCom,
                custoTotal: vProd + vAcres,
                fator: 1,
                grupo: isST ? "SUBSTITUTO TRIBUTARIO" : "NORMAL",
                marca: this.getVal(prod, 'xProd').split(' ')[0]
            });
        }
    },

    render() {
        const container = document.getElementById('gridContainer');
        container.innerHTML = '';
        this.data.forEach(item => {
            const finalQty = item.qCom * item.fator;
            const finalCost = item.custoTotal / finalQty;
            const div = document.createElement('div');
            div.className = `row-card ${item.grupo === 'SUBSTITUTO TRIBUTARIO' ? 'is-st' : ''}`;
            div.innerHTML = `
                <div>${item._id+1}</div>
                <div><input value="${item.codigo}" onchange="App.up(${item._id}, 'codigo', this.value)"></div>
                <div><input value="${item.descricao}" onchange="App.up(${item._id}, 'descricao', this.value)"></div>
                <div style="text-align:center">${item.unidade}</div>
                <div><input class="input-factor" value="${item.fator}" oninput="App.upFactor(${item._id}, this.value)"></div>
                <div><input value="${item.unidade}" style="text-align:center"></div>
                <div style="text-align:right"><input id="c-${item._id}" value="${finalCost.toFixed(4)}" readonly></div>
                <div style="text-align:right"><input id="q-${item._id}" value="${finalQty}" readonly></div>
                <div><input value="${item.marca}"></div>
            `;
            container.appendChild(div);
        });
    },

    up(id, k, v) { this.data[id][k] = v; },
    upFactor(id, v) { 
        this.data[id].fator = v; 
        const i = this.data[id];
        document.getElementById(`q-${id}`).value = i.qCom * v;
        document.getElementById(`c-${id}`).value = (i.custoTotal / (i.qCom * v)).toFixed(4);
    },

    exportExcel() {
        const rows = this.data.map(i => {
            const finalQty = i.qCom * i.fator;
            const finalCost = i.custoTotal / finalQty;
            const r = new Array(59).fill("");
            r[1]=i.codigo; r[2]=i.descricao; r[3]=i.unidade; r[4]=i.ncm; r[5]=i.orig; r[6]=finalCost*2;
            r[9]="Ativo"; r[10]=finalQty; r[11]=finalCost; r[13]=this.meta.fornecedor; 
            r[27]=i.fator; r[29]="T"; r[32]="Produto"; r[37]=i.grupo; r[38]=i.marca; r[39]=i.cest; 
            r[47]="Novo"; r[48]="N√£o"; r[53]=finalCost;
            return r;
        });
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet([this.headers, ...rows]);
        XLSX.utils.book_append_sheet(wb, ws, "Produtos");
        XLSX.writeFile(wb, `Importacao_${this.meta.nfe}.xlsx`);
    }
};

App.init();
</script>
</body>
</html>
