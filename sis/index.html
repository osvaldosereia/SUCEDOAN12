<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V3 | Dual Stock & Fiscal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        .view-content { display: none !important; }
        .view-content.active { display: flex !important; }
        .nav-link.active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }

        /* Modal Styles */
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .modal-content { animation: modalSlide 0.3s ease-out; }
        @keyframes modalSlide { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #print-area:not(:empty) {
            position: fixed; top: 0; right: 0; width: 380px; height: 100vh;
            background: white; box-shadow: -10px 0 30px rgba(0,0,0,0.15);
            z-index: 100; overflow-y: auto; padding: 20px; display: block;
            border-left: 4px solid #2563eb;
        }

        #expedicao-panel:fullscreen { background-color: #0f172a; padding: 20px; overflow-y: auto; }
        
        .spinner {
            border: 3px solid rgba(255,255,255,0.3); border-radius: 50%;
            border-top: 3px solid #fff; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; box-shadow: none; border: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen flex bg-slate-50">

    <!-- Modal Gerenciador de Categorias -->
    <div id="cat-modal" class="fixed inset-0 z-[80] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden modal-content max-h-[80vh] flex flex-col">
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold uppercase tracking-widest text-xs">Gestão de Categorias</h3>
                <button onclick="document.getElementById('cat-modal').classList.add('hidden')" class="hover:text-red-400 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 bg-slate-50 border-b space-y-2">
                <form onsubmit="CategoryApp.addCategory(event)" class="flex gap-2">
                    <input type="text" id="new-cat-name" placeholder="Nova Categoria Principal" class="flex-1 border rounded-lg px-3 py-2 text-xs outline-none" required>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase hover:bg-blue-700">Adicionar</button>
                </form>
            </div>
            <div class="flex-1 overflow-y-auto custom-scroll p-4 space-y-4" id="cat-list-container">
                <!-- Rendered via JS -->
            </div>
        </div>
    </div>

    <!-- Modal Ajuste de Estoque Rápido -->
    <div id="stock-modal" class="fixed inset-0 z-[70] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden modal-content">
            <div class="bg-slate-800 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold uppercase tracking-widest text-xs">Ajuste Rápido de Estoque</h3>
                <button onclick="document.getElementById('stock-modal').classList.add('hidden')" class="hover:text-red-400 transition"><i class="fa-solid fa-times"></i></button>
            </div>
            <form id="form-stock-adj" onsubmit="App.handleStockAdj(event)" class="p-5 space-y-4">
                <input type="hidden" id="adj-prod-id">
                <div class="text-center mb-4">
                    <h4 id="adj-prod-name" class="font-bold text-slate-700 text-sm">Produto XYZ</h4>
                    <p class="text-[10px] text-slate-400">Saldo Atual: <span id="adj-current-stock">0</span></p>
                </div>
                
                <div class="grid grid-cols-2 gap-2 bg-slate-50 p-2 rounded-lg border">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="adj-type" value="add" checked class="text-emerald-500 focus:ring-emerald-500">
                        <span class="text-xs font-bold text-emerald-600">Entrada (+)</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="adj-type" value="sub" class="text-red-500 focus:ring-red-500">
                        <span class="text-xs font-bold text-red-600">Saída/Perda (-)</span>
                    </label>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Qual Estoque?</label>
                    <select id="adj-dest" class="w-full bg-white border rounded-lg px-3 py-2 text-sm outline-none mt-1">
                        <option value="fisico">Físico</option>
                        <option value="fiscal">Fiscal</option>
                        <option value="ambos">Ambos</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase">Quantidade</label>
                    <input type="number" id="adj-qty" required min="1" class="w-full border rounded-lg px-3 py-2 text-lg font-bold text-center outline-none focus:border-blue-500" placeholder="0">
                </div>
                
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition text-xs uppercase">Confirmar Ajuste</button>
            </form>
        </div>
    </div>

    <!-- Modal Fiscal Detalhado -->
    <div id="fiscal-modal" class="fixed inset-0 z-[60] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden modal-content flex flex-col max-h-[90vh]">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold uppercase tracking-widest text-sm"><i class="fa-solid fa-file-invoice-dollar mr-2"></i> Detalhes Fiscais do Item</h3>
                <button onclick="LogisticsApp.closeModal()" class="hover:text-red-400 transition"><i class="fa-solid fa-times text-lg"></i></button>
            </div>
            <div id="fiscal-modal-body" class="p-6 overflow-y-auto custom-scroll space-y-4">
                <!-- Conteúdo injetado via JS -->
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end">
                <button onclick="LogisticsApp.closeModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg font-bold text-xs uppercase">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Feedback Loader -->
    <div id="f-loading" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center gap-4">
            <div class="spinner border-blue-600 border-t-transparent !border-t-blue-600"></div>
            <span class="font-medium text-slate-700">Processando...</span>
        </div>
    </div>

    <!-- SIDEBAR FIXA -->
    <aside class="fixed top-0 left-0 h-screen w-64 bg-slate-900 flex flex-col p-4 gap-2 no-print z-50">
        <div class="flex items-center gap-3 px-2 mb-8 text-white">
            <i class="fa-solid fa-cubes-stacked text-blue-500 text-2xl"></i>
            <div>
                <h1 class="font-bold tracking-tight uppercase text-sm">SISTEMA V3</h1>
                <p class="text-[10px] text-slate-400">Dual Stock Engine</p>
            </div>
        </div>
        <nav class="flex-1 space-y-1 overflow-y-auto custom-scroll">
            <button onclick="UI.switchView('cliente', this)" class="nav-link active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-users w-5"></i> <span>Clientes</span>
            </button>
            <button onclick="UI.switchView('catalogo', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-box w-5"></i> <span>Catálogo & Estoque</span>
            </button>
             <button onclick="UI.switchView('logistica', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-dolly w-5"></i> <span>Logística & XML</span>
            </button>
            <button onclick="UI.switchView('venda', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-cart-shopping w-5"></i> <span>Vendas</span>
            </button>
            <button onclick="UI.switchView('expedicao', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-truck-fast w-5"></i> <span>Expedição</span>
            </button>
            <button onclick="UI.switchView('crm', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-chart-line w-5"></i> <span>CRM</span>
            </button>
        </nav>
        <button onclick="ExportEngine.exportAll()" class="text-left px-4 py-2 text-slate-500 hover:text-emerald-400 text-xs transition mt-auto">
            <i class="fa-solid fa-database mr-2"></i> Backup Geral (DB)
        </button>
    </aside>

    <!-- CONTEÚDO PRINCIPAL COM MARGEM PARA A SIDEBAR -->
    <div class="ml-64 flex-1 flex flex-col min-h-screen">
        <header class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center no-print sticky top-0 z-40 shadow-sm">
            <h2 id="view-title" class="text-xl font-bold text-slate-800 tracking-tight">Clientes</h2>
            <div class="h-8 w-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs uppercase">AD</div>
        </header>

        <!-- VIEW: CLIENTE -->
        <main id="view-cliente" class="view-content active flex-col lg:flex-row items-start p-6 gap-6 w-full">
            <!-- Formulário Sticky -->
            <section class="w-full lg:w-96 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-shrink-0 sticky top-24">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <span id="formLabel-cliente" class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Novo Cliente</span>
                    <button onclick="UI.resetForm('cliente')" class="text-[10px] text-slate-400 hover:text-red-500 font-bold">LIMPAR</button>
                </div>
                <form id="form-cliente" onsubmit="App.handleSave('cliente', event)" class="p-5 space-y-4">
                    <input type="hidden" id="c-id">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="c-codigo" readonly placeholder="C0001" class="w-full bg-slate-100 border rounded-lg px-3 py-2 text-xs font-mono font-bold text-slate-500">
                        <select id="c-rota" required class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none font-bold text-blue-700">
                            <option value="">ROTA</option>
                            <option value="CX">CX</option>
                            <option value="VG">VG</option>
                            <option value="CBA">CBA</option>
                            <option value="CPA">CPA</option>
                        </select>
                    </div>
                    <input type="text" id="c-nome" required placeholder="Nome do Cliente" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="tel" id="c-tel" required placeholder="WhatsApp" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                        <input type="text" id="c-bairro" placeholder="Bairro" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                    </div>
                    <select id="c-cidade" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="Cuiabá">Cuiabá</option><option value="Várzea Grande">Várzea Grande</option>
                    </select>
                    <textarea id="c-endereco" rows="2" placeholder="Endereço Completo" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none"></textarea>
                    
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Dados de Busca Maps</label>
                        <input type="text" id="c-maps" placeholder="Cole coordenadas ou link aqui..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs outline-none focus:border-blue-400">
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition uppercase text-xs">Salvar Cliente</button>
                </form>
            </section>
            
            <!-- Tabela Expandida -->
            <section class="flex-1 w-full bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center sticky top-0 bg-white z-10 rounded-t-2xl">
                    <input type="text" oninput="UI.filter('cliente', this.value)" placeholder="Filtrar clientes..." class="pl-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none w-64 focus:border-blue-500">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">TOTAL: <b id="count-cliente" class="text-slate-700">0</b></span>
                </div>
                <div class="w-full overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                            <tr>
                                <th class="p-4">Cliente</th>
                                <th class="p-4">Local/Rota</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="table-cliente" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- VIEW: CATÁLOGO (PRODUTO ATUALIZADO COM CATEGORIAS) -->
        <main id="view-catalogo" class="view-content flex-col lg:flex-row items-start p-6 gap-6 w-full">
            <section class="w-full lg:w-96 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-shrink-0 sticky top-24">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <span id="formLabel-produto" class="text-[10px] font-bold text-emerald-600 uppercase">Cadastro de Produto</span>
                    <button onclick="UI.resetForm('produto')" class="text-[10px] text-slate-400 hover:text-red-500 font-bold">LIMPAR</button>
                </div>
                <form id="form-produto" onsubmit="App.handleSave('produto', event)" class="p-5 space-y-3">
                    <input type="hidden" id="p-id">
                    
                    <!-- Dados Básicos -->
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="p-codigo" readonly placeholder="P001" class="bg-slate-100 border rounded-lg px-3 py-2 text-xs font-bold text-slate-500">
                        <input type="text" id="p-ean" placeholder="EAN (GTIN)" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs outline-none">
                    </div>
                    <input type="text" id="p-nome" required placeholder="Nome do Produto" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                    
                    <!-- Categorização -->
                    <div class="grid grid-cols-2 gap-2">
                        <select id="p-categoria" onchange="CategoryApp.populateSub(this.value)" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs outline-none">
                            <option value="">Categoria</option>
                        </select>
                        <select id="p-subcategoria" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs outline-none">
                            <option value="">Subcategoria</option>
                        </select>
                    </div>
                    <input type="text" id="p-unidade" placeholder="Unid. (Ex: UN)" class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-xs uppercase">

                    <!-- Dados Fiscais Opcionais -->
                    <div class="bg-slate-50 p-2 rounded border space-y-2">
                        <label class="text-[9px] font-bold text-slate-400 uppercase block">Fiscal (Opcional)</label>
                        <div class="grid grid-cols-3 gap-2">
                            <input type="text" id="p-ncm" placeholder="NCM" class="bg-white border rounded-lg px-2 py-1 text-xs">
                            <input type="text" id="p-cest" placeholder="CEST" class="bg-white border rounded-lg px-2 py-1 text-xs">
                            <input type="text" id="p-cfop" placeholder="CFOP" class="bg-white border rounded-lg px-2 py-1 text-xs">
                        </div>
                    </div>

                    <!-- Controle de Estoque -->
                    <div class="bg-slate-50 p-2 rounded border">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block mb-1">Controle de Estoque</label>
                        <div class="flex gap-3 mb-2">
                            <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="p-stock-type" value="ambos" checked onchange="UI.toggleStockInputs()"> <span class="text-[10px] font-bold text-slate-600">Ambos</span></label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="p-stock-type" value="fisico" onchange="UI.toggleStockInputs()"> <span class="text-[10px] font-bold text-slate-600">Só Físico</span></label>
                            <label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="p-stock-type" value="fiscal" onchange="UI.toggleStockInputs()"> <span class="text-[10px] font-bold text-slate-600">Só Fiscal</span></label>
                        </div>
                        <div class="grid grid-cols-2 gap-2" id="stock-inputs-container">
                            <div id="grp-fisico">
                                <label class="text-[9px] text-slate-400 block">Estoque Físico</label>
                                <input type="number" id="p-estoque" placeholder="0" class="w-full bg-white border rounded-lg px-2 py-1 text-xs font-bold text-slate-700">
                            </div>
                            <div id="grp-fiscal">
                                <label class="text-[9px] text-slate-400 block">Estoque Fiscal</label>
                                <input type="number" id="p-estoqueFiscal" placeholder="0" class="w-full bg-white border rounded-lg px-2 py-1 text-xs font-bold text-purple-700">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="p-custo" step="0.01" placeholder="Custo R$" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs">
                        <input type="number" id="p-valor" step="0.01" required placeholder="Venda R$" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs font-bold text-emerald-600">
                    </div>

                    <div class="flex items-center gap-2 px-1">
                        <input type="checkbox" id="p-isTemp" class="rounded border-slate-300" onchange="UI.updateNextProductCode(this.checked)">
                        <label for="p-isTemp" class="text-[11px] font-bold text-slate-500 uppercase tracking-tighter">Temporário (24h)</label>
                    </div>
                    <select id="p-tipo" onchange="UI.toggleKit(this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="normal">Produto Normal</option><option value="kit">Kit / Combo</option>
                    </select>
                    <div id="p-kit-area" class="hidden space-y-3">
                        <label class="text-[9px] font-bold text-slate-400 uppercase">Lista do Kit</label>
                        <textarea id="p-kit-bulk" rows="2" class="w-full p-2 text-[10px] font-mono border rounded outline-none bg-slate-50" placeholder="P001 | 2"></textarea>
                        <div id="p-kit-list" class="max-h-32 overflow-y-auto custom-scroll space-y-1 bg-slate-50 p-2 rounded-lg border"></div>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-lg transition text-xs uppercase">Salvar Produto</button>
                </form>
            </section>
            <section class="flex-1 w-full bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center sticky top-0 bg-white z-10 rounded-t-2xl">
                    <div class="flex gap-2 items-center">
                        <input type="text" oninput="UI.filter('produto', this.value)" placeholder="Buscar catálogo..." class="pl-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none w-64 focus:border-blue-500">
                        <button onclick="CategoryApp.openModal()" class="bg-blue-100 text-blue-600 px-3 py-2 rounded-xl text-xs font-bold hover:bg-blue-200 transition"><i class="fa-solid fa-tags mr-1"></i> Categorias</button>
                    </div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase">TOTAL: <b id="count-produto" class="text-slate-700">0</b></span>
                </div>
                <div class="w-full overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                            <tr>
                                <th class="p-4">Produto</th>
                                <th class="p-4">Categoria</th>
                                <th class="p-4 text-center">Est. Físico</th>
                                <th class="p-4 text-center">Est. Fiscal</th>
                                <th class="p-4">Preço</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="table-produto" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- VIEW: LOGÍSTICA & ENTRADAS -->
        <main id="view-logistica" class="view-content flex-col p-6 gap-6 w-full">
            
            <!-- Linha Superior -->
            <div class="flex flex-col lg:flex-row gap-6 w-full">
                
                <!-- Leitor Fiscal XML (Atualizado para Entrada/Saída) -->
                <section class="flex-1 bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 uppercase text-xs flex items-center gap-2">
                            <i class="fa-solid fa-file-code text-blue-500"></i> Importação NFe (XML)
                        </h3>
                        <div class="flex gap-2">
                             <button onclick="LogisticsApp.exportData('json')" class="text-emerald-600 text-[10px] font-bold uppercase hover:underline">Exportar JSON</button>
                             <button onclick="LogisticsApp.clearData()" class="text-red-500 text-[10px] font-bold uppercase hover:underline">Limpar</button>
                        </div>
                    </div>

                    <!-- Area de Upload -->
                    <div class="mb-4 bg-slate-50 p-4 rounded-lg border border-dashed border-slate-300">
                         <input type="file" id="f-fileInput" multiple accept=".xml, text/xml" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                    </div>

                    <!-- Controles XML Avançados -->
                     <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 flex flex-col gap-3 mt-auto">
                        <div class="flex items-center gap-2 justify-between flex-wrap">
                             <span class="text-[10px] font-bold text-blue-800 uppercase flex items-center gap-1">
                                 <i class="fa-solid fa-gears"></i> Opções de Processamento
                             </span>
                             <div class="flex gap-2">
                                <select id="f-move-type" class="text-[10px] border border-blue-200 rounded p-1 outline-none font-bold text-slate-600" title="Tipo de Movimento">
                                    <option value="auto">Automático (Pelo XML)</option>
                                    <option value="entrada">Forçar ENTRADA (+)</option>
                                    <option value="saida">Forçar SAÍDA (-)</option>
                                </select>
                                <select id="f-stock-dest" class="text-[10px] border border-blue-200 rounded p-1 outline-none font-bold text-slate-600" title="Estoque Alvo">
                                    <option value="fisico">Destino: Físico</option>
                                    <option value="fiscal">Destino: Fiscal</option>
                                    <option value="ambos">Destino: Ambos</option>
                                </select>
                             </div>
                        </div>
                        <button onclick="LogisticsApp.importToStock()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg text-xs font-bold uppercase shadow-sm transition">
                            Processar XML no Estoque Selecionado
                        </button>
                    </div>

                    <!-- Mini Lista de Preview -->
                    <div class="w-full overflow-auto custom-scroll mt-4 border rounded-lg max-h-60">
                        <table class="w-full text-left text-[10px]">
                            <thead class="bg-slate-100 sticky top-0"><tr class="text-slate-500 font-bold"><th class="p-2">Item XML</th><th class="p-2">Tipo NF</th><th class="p-2 text-right">Qtd</th><th class="p-2 text-center">Ver</th></tr></thead>
                            <tbody id="f-tableBody"></tbody>
                        </table>
                    </div>
                </section>

                <!-- Entrada Manual Avulsa -->
                <section class="w-full lg:w-96 bg-white rounded-xl shadow-sm border border-slate-200 p-4 flex flex-col h-auto">
                    <h3 class="font-bold text-slate-700 uppercase text-xs mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-to-square text-orange-500"></i> Movimento Manual</h3>
                    <form id="form-entrada-manual" onsubmit="App.handleSave('entrada', event)" class="flex-1 flex flex-col gap-3">
                         <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Produto</label>
                            <select id="e-produto" required class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-xs outline-none"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Destino</label>
                             <select id="e-tipo-estoque" class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-xs outline-none font-bold text-slate-700">
                                <option value="fisico">Físico</option>
                                <option value="fiscal">Fiscal</option>
                                <option value="ambos">Ambos</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                             <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase">Qtd (+/-)</label>
                                <input type="number" id="e-qty" required class="w-full border rounded-lg px-3 py-2 text-xs outline-none font-bold" placeholder="Use - para saída">
                            </div>
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase">Custo (R$)</label>
                                <input type="number" id="e-custo" required step="0.01" class="w-full border rounded-lg px-3 py-2 text-xs outline-none">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-bold text-slate-400 uppercase">Histórico / Origem</label>
                            <input type="text" id="e-fornecedor" placeholder="Ex: Compra Avulsa / Quebra" class="w-full border rounded-lg px-3 py-2 text-xs outline-none">
                        </div>
                        <button type="submit" class="mt-auto w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl shadow-sm transition text-xs uppercase">
                            Registrar Movimento
                        </button>
                    </form>
                </section>
            </div>

            <!-- Tabela Unificada de Histórico -->
            <section class="flex-1 w-full bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
                <div class="p-3 border-b border-slate-100 bg-slate-50 flex justify-between items-center sticky top-0 z-10 rounded-t-xl">
                    <span class="text-[10px] font-bold text-slate-500 uppercase">Histórico Geral de Movimentação</span>
                    <span class="text-[10px] font-bold text-slate-400 uppercase">Itens: <b id="count-entrada" class="text-slate-700">0</b></span>
                </div>
                <div class="w-full overflow-x-auto">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                            <tr>
                                <th class="p-3">Data</th>
                                <th class="p-3">Produto</th>
                                <th class="p-3">Destino</th>
                                <th class="p-3">Origem/Obs</th>
                                <th class="p-3 text-right">Qtd</th>
                            </tr>
                        </thead>
                        <tbody id="table-entrada" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- VIEW: VENDAS -->
        <main id="view-venda" class="view-content flex-col lg:flex-row items-start p-6 gap-6 w-full">
            <section class="w-full lg:w-96 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-shrink-0 sticky top-24">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <span id="formLabel-venda" class="text-[10px] font-bold text-orange-600 uppercase">Novo Pedido</span>
                    <button onclick="UI.resetForm('venda')" class="text-[10px] text-slate-400 hover:text-red-500 font-bold">CANCELAR</button>
                </div>
                <form id="form-venda" onsubmit="App.handleSave('venda', event)" class="p-5 space-y-3">
                    <input type="hidden" id="v-id">
                    <select id="v-cliente" required class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none"></select>
                    
                    <div class="space-y-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-[10px]"></i>
                            <input type="text" id="v-prod-search" oninput="UI.searchProduct(this.value)" placeholder="Buscar produto..." class="w-full pl-8 pr-3 py-2 text-xs border border-slate-200 rounded-lg outline-none focus:border-orange-400">
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <select id="v-produto" required class="col-span-3 bg-white border rounded-lg px-3 py-2 text-sm outline-none"></select>
                            <input type="number" id="v-qty" value="1" min="1" class="bg-white border rounded-lg px-3 py-2 text-sm outline-none font-bold">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <select id="v-pagamento" required class="bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none">
                            <option value="Dinheiro">Dinheiro</option><option value="Cartão">Cartão</option>
                            <option value="Pix">Pix</option><option value="Só Entregar">Só Entregar</option>
                        </select>
                        <select id="v-rota" required class="bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none">
                            <option value="CX">CX</option><option value="VF">VF</option>
                            <option value="CBA">CBA</option><option value="CPA">CPA</option>
                        </select>
                    </div>

                    <select id="v-brinde" class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none font-bold text-purple-600">
                        <option value="">Nenhum Brinde</option>
                        <option value="Ovo">Brinde: Ovo</option>
                        <option value="Café 250g">Brinde: Café 250g</option>
                        <option value="Amaciante">Brinde: Amaciante</option>
                        <option value="Omo">Brinde: Omo</option>
                    </select>

                    <input type="number" id="v-desconto" step="0.01" placeholder="Desconto (R$)" class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none">
                    <textarea id="v-obs" rows="2" placeholder="Observações" class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none"></textarea>
                    <div class="p-3 bg-slate-900 rounded-xl text-white flex justify-between items-center">
                        <span class="text-xs uppercase font-bold text-slate-400">Total Líquido</span>
                        <span id="v-total" class="text-xl font-bold">R$ 0,00</span>
                    </div>
                    <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-xl shadow-lg transition text-xs uppercase tracking-widest">Finalizar Pedido</button>
                </form>
            </section>
            
            <section class="flex-1 w-full bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex flex-col gap-3 sticky top-0 bg-white z-10 rounded-t-2xl">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-bold uppercase text-slate-500 tracking-tighter">Histórico de Vendas</h3>
                        <div class="flex gap-2">
                            <button onclick="ExportEngine.exportSelectedSales()" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg text-[10px] font-bold hover:bg-emerald-200 transition">
                                <i class="fa-solid fa-file-export mr-1"></i> Exportar Selecionados
                            </button>
                            <span class="text-[10px] font-bold text-slate-400 tracking-tighter uppercase self-center">TOTAL: <b id="count-venda" class="text-slate-700">0</b></span>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center no-print">
                        <input type="date" id="v-filter-start" class="text-[10px] p-1.5 border rounded outline-none focus:border-blue-400">
                        <span class="text-[10px] text-slate-400 uppercase font-bold">a</span>
                        <input type="date" id="v-filter-end" class="text-[10px] p-1.5 border rounded outline-none focus:border-blue-400">
                        <button onclick="UI.render('venda')" class="bg-slate-200 hover:bg-slate-300 text-[10px] font-bold px-3 py-1.5 rounded transition uppercase">Filtrar</button>
                    </div>
                </div>
                <div class="w-full overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold sticky top-0">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onclick="UI.toggleSelectAllSales(this)"></th>
                                <th class="p-4">Pedido</th>
                                <th class="p-4">Financeiro</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="table-venda" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>
        
        <!-- VIEW: EXPEDIÇÃO -->
        <main id="view-expedicao" class="view-content flex-col w-full min-h-screen p-0 bg-slate-100">
            <div id="expedicao-panel" class="w-full min-h-screen flex flex-col">
                <div class="bg-slate-900 p-4 flex justify-between items-center flex-shrink-0 sticky top-0 z-20">
                    <h3 class="text-lg font-bold text-white uppercase tracking-widest flex items-center gap-3">
                        <i class="fa-solid fa-tv text-emerald-400"></i> Monitor de Expedição
                    </h3>
                    <div class="flex gap-3">
                        <button onclick="UI.renderExpedicao()" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg font-bold uppercase transition">Atualizar</button>
                        <button onclick="UI.toggleFullscreen()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-bold uppercase transition shadow-lg shadow-blue-900/50">
                            <i class="fa-solid fa-expand mr-1"></i> Tela Cheia
                        </button>
                    </div>
                </div>
                <!-- 4 Colunas FIXAS -->
                <div class="flex-1 grid grid-cols-4 min-h-0 divide-x divide-slate-200">
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-blue-600 text-white p-3 text-center font-black text-xl uppercase shadow-md sticky top-0 z-10">ROTA CX</div>
                        <div id="col-CX" class="flex-1 p-2 grid grid-cols-2 gap-2 content-start"></div>
                    </div>
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-emerald-600 text-white p-3 text-center font-black text-xl uppercase shadow-md sticky top-0 z-10">ROTA VG</div>
                        <div id="col-VG" class="flex-1 p-2 grid grid-cols-2 gap-2 content-start"></div>
                    </div>
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-orange-600 text-white p-3 text-center font-black text-xl uppercase shadow-md sticky top-0 z-10">ROTA CBA</div>
                        <div id="col-CBA" class="flex-1 p-2 grid grid-cols-2 gap-2 content-start"></div>
                    </div>
                    <div class="flex flex-col h-full bg-slate-100">
                        <div class="bg-purple-600 text-white p-3 text-center font-black text-xl uppercase shadow-md sticky top-0 z-10">ROTA CPA/VF</div>
                        <div id="col-CPA" class="flex-1 p-2 grid grid-cols-2 gap-2 content-start"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- VIEW: CRM -->
        <main id="view-crm" class="view-content flex-col p-6 gap-6 w-full">
            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex items-center justify-between flex-shrink-0 no-print">
                <div>
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-widest leading-none">Dashboard Analytics</h3>
                </div>
                <div class="flex gap-2 items-center">
                    <input type="date" id="crm-filter-start" class="text-[10px] p-2 border rounded-lg outline-none">
                    <button onclick="UI.renderCRM()" class="bg-blue-600 text-white text-[10px] font-bold px-4 py-2 rounded-lg hover:bg-blue-700 transition uppercase">Atualizar</button>
                </div>
            </section>
            <section class="grid grid-cols-4 gap-4 flex-shrink-0">
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Receita Bruta</span><h3 id="crm-total-rev" class="text-2xl font-black text-emerald-600 leading-tight">R$ 0,00</h3></div>
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Ticket Médio</span><h3 id="crm-avg-ticket" class="text-2xl font-black text-blue-600 leading-tight">R$ 0,00</h3></div>
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Pedidos</span><h3 id="crm-total-orders" class="text-2xl font-black text-slate-700 leading-tight">0</h3></div>
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Clientes</span><h3 id="crm-active-clients" class="text-2xl font-black text-orange-500 leading-tight">0</h3></div>
            </section>
            <section class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex-1 flex flex-col">
                <div class="p-4 border-b bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-xs font-bold uppercase text-slate-500 tracking-tighter">Performance e Resultado por Produto</h3>
                </div>
                <div class="w-full overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                            <tr>
                                <th class="p-4">Produto</th>
                                <th class="p-4 text-center">Vendas (Un)</th>
                                <th class="p-4">Faturamento</th>
                                <th class="p-4">Lucro Total</th>
                                <th class="p-4">Margem (%)</th>
                            </tr>
                        </thead>
                        <tbody id="crm-table-products" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        const storageAvailable = (type) => { try { var storage = window[type], x = '__storage_test__'; storage.setItem(x, x); storage.removeItem(x); return true; } catch (e) { return false; } };

        const DB = {
            key: 'enterprise_v5_db',
            load: () => {
                const defaults = {cliente:[], produto:[], venda:[], entrada:[], categorias: []};
                if (!storageAvailable('localStorage')) return defaults;
                let data = JSON.parse(localStorage.getItem(DB.key) || 'null');
                if(!data) return defaults;
                // PATCH CRÍTICO: Mescla defaults para garantir que a chave 'categorias' exista em dados antigos
                for(let key in defaults) {
                    if(!data[key]) data[key] = defaults[key];
                }
                return data;
            },
            saveAll: (data) => { if (storageAvailable('localStorage')) localStorage.setItem(DB.key, JSON.stringify(data)); },
            getNextCode: (type, options = {}) => {
                const db = DB.load(); let maxNum = 0;
                if (type === 'cliente') { db.cliente.forEach(c => { const n = parseInt(c.codigo?.substring(1)) || 0; if (n > maxNum) maxNum = n; }); return `C${String(maxNum + 1).padStart(4, '0')}`; }
                if (type === 'produto') { 
                    const isTemp = options.isTemp; const prefix = isTemp ? 'PT' : 'P';
                    db.produto.forEach(p => { 
                        if (isTemp && p.codigo?.startsWith('PT')) { const n = parseInt(p.codigo.substring(2)) || 0; if (n > maxNum) maxNum = n; } 
                        else if (!isTemp && p.codigo?.startsWith('P') && !p.codigo?.startsWith('PT')) { const n = parseInt(p.codigo.substring(1)) || 0; if (n > maxNum) maxNum = n; } 
                    });
                    return `${prefix}${String(maxNum + 1).padStart(3, '0')}`; 
                }
                if (type === 'venda') { db.venda.forEach(v => { const n = parseInt(v.codigo?.substring(1)) || 0; if (n > maxNum) maxNum = n; }); return `V${String(maxNum + 1).padStart(3, '0')}`; }
                return "";
            },
            save: (type, obj) => {
                const db = DB.load(); const idx = db[type].findIndex(i => i.id === obj.id);
                if (idx !== -1) { db[type][idx] = obj; } 
                else { if(!obj.id) obj.id = Date.now().toString(); if(!obj.codigo && type !== 'categorias') obj.codigo = DB.getNextCode(type, {isTemp: obj.isTemp}); db[type].push(obj); }
                if (type === 'venda' && db.venda.length > 2000) { db.venda.sort((a, b) => a.date - b.date); db.venda = db.venda.slice(-2000); }
                DB.saveAll(db);
            },
            delete: (type, id) => { const db = DB.load(); db[type] = db[type].filter(i => i.id !== id); DB.saveAll(db); }
        };

        // NEW: CATEGORY LOGIC
        const CategoryApp = {
            openModal: () => {
                document.getElementById('cat-modal').classList.remove('hidden');
                CategoryApp.renderList();
            },
            addCategory: (e) => {
                e.preventDefault();
                const name = document.getElementById('new-cat-name').value.trim();
                if(!name) return;
                const db = DB.load();
                db.categorias.push({ id: Date.now().toString(), nome: name, subs: [] });
                DB.saveAll(db);
                document.getElementById('new-cat-name').value = '';
                CategoryApp.renderList();
                App.init(); // Refresh dropdowns
            },
            addSub: (catId) => {
                const subName = prompt("Nome da Subcategoria:");
                if(!subName) return;
                const db = DB.load();
                const cat = db.categorias.find(c => c.id === catId);
                if(cat) {
                    if(!cat.subs) cat.subs = [];
                    cat.subs.push(subName);
                    DB.saveAll(db);
                    CategoryApp.renderList();
                }
            },
            deleteCat: (id) => {
                if(confirm('Excluir categoria?')) {
                    DB.delete('categorias', id);
                    CategoryApp.renderList();
                    App.init();
                }
            },
            deleteSub: (catId, subIdx) => {
                if(confirm('Excluir subcategoria?')) {
                    const db = DB.load();
                    const cat = db.categorias.find(c => c.id === catId);
                    if(cat) {
                        cat.subs.splice(subIdx, 1);
                        DB.saveAll(db);
                        CategoryApp.renderList();
                    }
                }
            },
            renderList: () => {
                const db = DB.load();
                const container = document.getElementById('cat-list-container');
                container.innerHTML = db.categorias.map(c => `
                    <div class="bg-white border rounded-lg p-3">
                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                            <h4 class="font-bold text-slate-700">${c.nome}</h4>
                            <div class="flex gap-2">
                                <button onclick="CategoryApp.addSub('${c.id}')" class="text-blue-500 text-[10px] font-bold uppercase hover:underline">+ Sub</button>
                                <button onclick="CategoryApp.deleteCat('${c.id}')" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${(c.subs || []).map((s, idx) => `
                                <span class="bg-slate-100 text-slate-600 text-[10px] px-2 py-1 rounded-full flex items-center gap-2">
                                    ${s} <button onclick="CategoryApp.deleteSub('${c.id}', ${idx})" class="hover:text-red-500">x</button>
                                </span>
                            `).join('')}
                            ${(!c.subs || c.subs.length === 0) ? '<span class="text-[10px] text-slate-400 italic">Sem subcategorias</span>' : ''}
                        </div>
                    </div>
                `).join('');
            },
            populateSelects: () => {
                const db = DB.load();
                const catSelect = document.getElementById('p-categoria');
                if(!catSelect) return;
                const currentVal = catSelect.value;
                catSelect.innerHTML = '<option value="">Categoria</option>' + db.categorias.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
                if(currentVal) catSelect.value = currentVal;
            },
            populateSub: (catName, selectedSub = '') => {
                const db = DB.load();
                const subSelect = document.getElementById('p-subcategoria');
                subSelect.innerHTML = '<option value="">Subcategoria</option>';
                const cat = db.categorias.find(c => c.nome === catName);
                if(cat && cat.subs) {
                    subSelect.innerHTML += cat.subs.map(s => `<option value="${s}">${s}</option>`).join('');
                }
                if(selectedSub) subSelect.value = selectedSub;
            }
        };

        const UI = {
            get: (id) => document.getElementById(id),
            switchView: (view, btn) => {
                document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                UI.get(`view-${view}`).classList.add('active');
                if(btn) btn.classList.add('active');
                
                let title = view.charAt(0).toUpperCase() + view.slice(1);
                if(view === 'logistica') title = "Logística & Entradas";
                if(view === 'catalogo') title = "Catálogo & Estoque";
                UI.get('view-title').innerText = title;

                if(view === 'venda') UI.renderVendaOptions();
                if(view === 'catalogo') UI.renderKitOptions();
                if(view === 'crm') UI.renderCRM();
                if(view === 'expedicao') UI.renderExpedicao();
                if(view === 'logistica') { UI.renderEntradaOptions(); LogisticsApp.render(); }
                
                if(view !== 'logistica') { UI.render(view); UI.resetForm(view); }
            },
            toggleKit: (val) => UI.get('p-kit-area').classList.toggle('hidden', val !== 'kit'),
            toggleStockInputs: () => {
                const type = document.querySelector('input[name="p-stock-type"]:checked')?.value || 'ambos';
                const fis = document.getElementById('grp-fisico');
                const fisc = document.getElementById('grp-fiscal');
                
                if(type === 'fisico') { fis.classList.remove('hidden'); fisc.classList.add('hidden'); }
                else if(type === 'fiscal') { fis.classList.add('hidden'); fisc.classList.remove('hidden'); }
                else { fis.classList.remove('hidden'); fisc.classList.remove('hidden'); }
            },
            renderKitOptions: () => {
                const prods = DB.load().produto.filter(p => p.tipo !== 'kit');
                UI.get('p-kit-list').innerHTML = prods.map(p => `<div class="flex items-center gap-2 p-1 text-[10px]"><input type="checkbox" data-pid="${p.id}" class="kit-check"><span class="flex-1 font-bold">${p.codigo} - ${p.nome}</span><input type="number" data-pid="${p.id}" value="1" class="kit-qty w-10 border rounded outline-none px-1 font-bold"></div>`).join('');
            },
            renderVendaOptions: (filter = '') => {
                const db = DB.load();
                UI.get('v-cliente').innerHTML = '<option value="">Selecionar Cliente</option>' + db.cliente.map(c => `<option value="${c.id}">${c.codigo} - ${c.nome}</option>`).join('');
                UI.get('v-produto').innerHTML = '<option value="">Selecionar Produto</option>' + db.produto.filter(p => p.nome.toLowerCase().includes(filter.toLowerCase()) || p.codigo.toLowerCase().includes(filter.toLowerCase())).map(p => `<option value="${p.id}" data-price="${p.valor}">${p.codigo} - ${p.nome} (Est: ${p.estoque})</option>`).join('');
            },
            renderEntradaOptions: () => {
                const db = DB.load();
                const sel = UI.get('e-produto');
                if(sel) sel.innerHTML = '<option value="">Selecionar Produto</option>' + db.produto.map(p => `<option value="${p.id}">${p.codigo} - ${p.nome}</option>`).join('');
            },
            searchProduct: (val) => UI.renderVendaOptions(val),
            toggleSelectAllSales: (master) => { document.querySelectorAll('.venda-select').forEach(cb => cb.checked = master.checked); },
            toggleFullscreen: () => {
                const el = document.getElementById('expedicao-panel');
                if (!document.fullscreenElement) { el.requestFullscreen().catch(err => { alert(`Erro: ${err.message}`); }); } else { document.exitFullscreen(); }
            },
            render: (type) => {
                if(type === 'crm' || type === 'expedicao' || type === 'logistica') return;
                const db = DB.load(); let data = db[type === 'catalogo' ? 'produto' : type];
                if(type === 'venda') {
                    const s = UI.get('v-filter-start').value; const e = UI.get('v-filter-end').value;
                    if(s) data = data.filter(v => v.date >= new Date(s).getTime());
                    if(e) data = data.filter(v => v.date <= new Date(e).getTime() + 86399999);
                }
                
                UI.get(`count-${type}`).innerText = data.length;
                UI.get(`table-${type}`).innerHTML = data.map(i => {
                    if(type === 'cliente') {
                        const mapsBtn = i.maps ? `<button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.maps)}', '_blank')" class="text-emerald-500 p-2" title="Abrir no Maps"><i class="fa-solid fa-map-location-dot text-xs"></i></button>` : '';
                        return `<tr class="hover:bg-slate-50 transition"><td class="p-4 font-bold text-xs">${i.codigo}-${i.nome}</td><td class="p-4 text-[10px] font-bold uppercase">${i.cidade}<br><span class="text-blue-600">ROTA: ${i.rota || '-'}</span></td><td class="p-4 text-right flex justify-end gap-1">${mapsBtn}<button onclick="App.edit('cliente','${i.id}')" class="text-blue-600 p-2"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.delete('cliente','${i.id}')" class="text-red-400 p-2"><i class="fa-solid fa-trash text-xs"></i></button></td></tr>`;
                    }
                    if(type === 'catalogo') {
                        const estColor = i.estoque <= 0 ? 'text-red-600' : 'text-slate-700';
                        const estFiscal = i.estoqueFiscal || 0;
                        const catLabel = i.categoria ? `<span class="text-[9px] bg-slate-100 px-2 py-1 rounded text-slate-500">${i.categoria}${i.subcategoria ? ' > ' + i.subcategoria : ''}</span>` : '-';
                        return `<tr class="hover:bg-slate-50 transition">
                            <td class="p-4 font-bold text-xs">${i.codigo}-${i.nome}</td>
                            <td class="p-4">${catLabel}</td>
                            <td class="p-4 font-black text-xs text-center ${estColor}">${i.estoque} <span class="text-[8px] opacity-40">un</span></td>
                            <td class="p-4 font-black text-xs text-center text-purple-700 bg-purple-50 rounded">${estFiscal} <span class="text-[8px] opacity-40">un</span></td>
                            <td class="p-4 text-[10px] font-bold text-emerald-600">R$ ${Number(i.valor).toFixed(2)}</td>
                            <td class="p-4 text-right flex justify-end gap-1">
                                <button onclick="App.openStockAdjustment('${i.id}')" class="text-slate-600 bg-slate-100 hover:bg-slate-200 p-2 rounded mr-1" title="Ajuste Rápido"><i class="fa-solid fa-sliders text-xs"></i></button>
                                <button onclick="App.edit('produto','${i.id}')" class="text-blue-600 p-2"><i class="fa-solid fa-pen text-xs"></i></button>
                                <button onclick="App.delete('produto','${i.id}')" class="text-red-400 p-2"><i class="fa-solid fa-trash text-xs"></i></button>
                            </td>
                        </tr>`;
                    }
                    if(type === 'venda') {
                        const c = db.cliente.find(x => x.id === i.cliId); const p = db.produto.find(x => x.id === i.prodId);
                        return `<tr class="hover:bg-slate-50 text-[11px]"><td class="p-4"><input type="checkbox" class="venda-select" data-id="${i.id}"></td><td class="p-4 font-bold">#${i.codigo} | ${c?.nome||'Excl'}</td><td class="p-4 font-bold text-emerald-700">R$ ${i.total.toFixed(2)}<br><span class="opacity-50 text-[9px] uppercase">${i.pag} | ${i.rota}</span></td><td class="p-4 text-right flex justify-end gap-1"><button onclick="App.printVenda('${i.id}')" class="text-slate-500 p-2"><i class="fa-solid fa-print text-xs"></i></button><button onclick="App.delete('venda','${i.id}')" class="text-red-300 p-2"><i class="fa-solid fa-times text-xs"></i></button></td></tr>`;
                    }
                }).join('');
            },
            renderExpedicao: () => {
                const db = DB.load(); ['CX', 'VG', 'CBA', 'CPA'].forEach(r => UI.get(`col-${r}`).innerHTML = '');
                db.venda.forEach(v => {
                    const r = (v.rota || 'CPA').toUpperCase(); const targetId = `col-${(r === 'VF' ? 'CPA' : r)}`; const col = UI.get(targetId);
                    if(col) {
                        const card = document.createElement('div');
                        card.className = "card-pedido bg-white border-l-4 border-slate-300 rounded shadow-sm p-2 flex justify-between items-center transition hover:scale-105 transform origin-left";
                        if(r === 'CX') card.classList.replace('border-slate-300', 'border-blue-500'); else if(r === 'VG') card.classList.replace('border-slate-300', 'border-emerald-500'); else if(r === 'CBA') card.classList.replace('border-slate-300', 'border-orange-500'); else card.classList.replace('border-slate-300', 'border-purple-500');
                        card.innerHTML = `<span class="text-xl font-black text-slate-800 tracking-tighter">${v.codigo}</span><button onclick="App.printVenda('${v.id}')" class="bg-slate-100 hover:bg-slate-200 text-slate-600 h-8 w-8 rounded-full flex items-center justify-center transition"><i class="fa-solid fa-print text-sm"></i></button>`;
                        col.appendChild(card);
                    }
                });
            },
            renderCRM: () => {
                const db = DB.load(); const totalRev = db.venda.reduce((acc, v) => acc + v.total, 0);
                UI.get('crm-total-rev').innerText = `R$ ${totalRev.toFixed(2)}`; UI.get('crm-avg-ticket').innerText = `R$ ${(totalRev / (db.venda.length || 1)).toFixed(2)}`; UI.get('crm-total-orders').innerText = db.venda.length; UI.get('crm-active-clients').innerText = [...new Set(db.venda.map(v => v.cliId))].length;
                const stats = {}; db.venda.forEach(v => { const p = db.produto.find(x => x.id === v.prodId); if(!stats[v.prodId]) { stats[v.prodId] = { nome: p ? p.nome : 'Prod. Excluído', codigo: p ? p.codigo : '???', qty: 0, rev: 0, cost: 0 }; } stats[v.prodId].qty += v.qty; stats[v.prodId].rev += v.total; stats[v.prodId].cost += (Number(p?.custo || 0) * v.qty); });
                const sorted = Object.values(stats).sort((a, b) => (b.rev - b.cost) - (a.rev - a.cost));
                UI.get('crm-table-products').innerHTML = sorted.map(s => { const profit = s.rev - s.cost; const margin = s.rev > 0 ? (profit / s.rev) * 100 : 0; return `<tr class="hover:bg-slate-50 text-xs transition-all"><td class="p-4 font-bold text-slate-700">${s.codigo} - ${s.nome}</td><td class="p-4 text-center font-black text-slate-500">${s.qty}</td><td class="p-4 font-bold text-slate-800">R$ ${s.rev.toFixed(2)}</td><td class="p-4 font-bold text-blue-600">R$ ${profit.toFixed(2)}</td><td class="p-4 font-black ${margin >= 30 ? 'text-emerald-600' : (margin >= 15 ? 'text-orange-500' : 'text-red-500')}">${margin.toFixed(1)}%</td></tr>`; }).join('');
            },
            resetForm: (t) => {
                const form = UI.get(`form-${t}`); if(!form) return; form.reset();
                if (t === 'entrada') return; 
                UI.get(`${t[0]}-id`).value = ''; UI.get(`formLabel-${t}`).innerText = `Novo ${t}`;
                if(t === 'cliente') { UI.get('c-codigo').value = DB.getNextCode('cliente'); } 
                else if(t === 'produto') { 
                    UI.get('p-isTemp').checked = false; 
                    UI.get('p-codigo').value = DB.getNextCode('produto', {isTemp: false}); 
                    UI.toggleKit('normal'); 
                    const radios = document.getElementsByName('p-stock-type');
                    if(radios.length) radios[0].checked = true;
                    UI.toggleStockInputs();
                    CategoryApp.populateSelects(); // Reset Categories
                } 
                else if(t === 'venda') { UI.get('v-total').innerText = 'R$ 0,00'; UI.get('v-brinde').value = ''; }
            },
            updateNextProductCode: (isTemp) => { UI.get('p-codigo').value = DB.getNextCode('produto', {isTemp}); },
            fillForm: (t, i) => {
                const p = t[0]; UI.get(`${p}-id`).value = i.id; UI.get(`${p}-codigo`).value = i.codigo;
                if(t === 'cliente') { UI.get('c-nome').value = i.nome; UI.get('c-tel').value = i.tel; UI.get('c-cidade').value = i.cidade; UI.get('c-bairro').value = i.bairro || ''; UI.get('c-endereco').value = i.endereco; UI.get('c-rota').value = i.rota || ''; UI.get('c-maps').value = i.maps || ''; }
                else if(t === 'produto') { 
                    UI.get('p-nome').value = i.nome; 
                    ['ean','ncm','categoria','custo','valor','estoque','tipo','cest','cfop','unidade'].forEach(k => {
                        const el = UI.get(`p-${k}`);
                        if(el) el.value = i[k] || '';
                    });
                    
                    // Handle Category and Subcategory population
                    CategoryApp.populateSelects();
                    UI.get('p-categoria').value = i.categoria || '';
                    CategoryApp.populateSub(i.categoria, i.subcategoria);

                    UI.get('p-estoqueFiscal').value = i.estoqueFiscal || 0;
                    UI.get('p-isTemp').checked = !!i.isTemp; UI.toggleKit(i.tipo); 
                    UI.toggleStockInputs();
                }
                UI.get(`formLabel-${t}`).innerText = `Editando ${t}`;
            }
        };

        const App = {
            init: () => {
                const db = DB.load(); db.produto = db.produto.filter(p => !p.deleteAt || p.deleteAt > Date.now()); DB.saveAll(db); 
                UI.render('cliente'); UI.resetForm('cliente');
                CategoryApp.populateSelects(); // Init categories
                ['v-qty', 'v-desconto', 'v-produto'].forEach(id => { const el = UI.get(id); if(el) el.addEventListener('input', App.calcVenda); });
                const fInput = document.getElementById('f-fileInput'); if(fInput) fInput.addEventListener('change', LogisticsApp.handleFileUpload);
            },
            calcVenda: () => {
                const p = UI.get('v-produto'); const price = p.options[p.selectedIndex]?.dataset.price || 0;
                const total = (Number(price) * Number(UI.get('v-qty').value)) - Number(UI.get('v-desconto').value || 0);
                UI.get('v-total').innerText = `R$ ${Math.max(0, total).toFixed(2)}`;
            },
            openStockAdjustment: (id) => {
                const db = DB.load();
                const prod = db.produto.find(p => p.id === id);
                if(!prod) return;
                document.getElementById('adj-prod-id').value = id;
                document.getElementById('adj-prod-name').innerText = `${prod.codigo} - ${prod.nome}`;
                document.getElementById('adj-current-stock').innerText = `${prod.estoque} (Físico) / ${prod.estoqueFiscal||0} (Fiscal)`;
                document.getElementById('stock-modal').classList.remove('hidden');
            },
            handleStockAdj: (e) => {
                e.preventDefault();
                const id = document.getElementById('adj-prod-id').value;
                const type = document.querySelector('input[name="adj-type"]:checked').value;
                const dest = document.getElementById('adj-dest').value;
                const qty = Number(document.getElementById('adj-qty').value);
                if(qty <= 0) return alert('Quantidade inválida');

                const db = DB.load();
                const prod = db.produto.find(p => p.id === id);
                if(prod) {
                    const signal = type === 'add' ? 1 : -1;
                    const change = qty * signal;
                    
                    if(dest === 'fisico' || dest === 'ambos') prod.estoque += change;
                    if(dest === 'fiscal' || dest === 'ambos') prod.estoqueFiscal = (prod.estoqueFiscal || 0) + change;

                    db.entrada.push({ // Registra como movimento manual
                         id: Date.now().toString(), date: Date.now(), prodId: id, qty: change, custo: prod.custo || 0, fornecedor: `Ajuste Manual (${type})`, dest: dest 
                    });
                    
                    DB.saveAll(db);
                    UI.render('catalogo');
                    document.getElementById('stock-modal').classList.add('hidden');
                    document.getElementById('form-stock-adj').reset();
                }
            },
            handleSave: (t, e) => {
                e.preventDefault(); 
                if(t === 'entrada') {
                     const prodId = UI.get('e-produto').value; 
                     const qtyInput = Number(UI.get('e-qty').value); 
                     const custo = Number(UI.get('e-custo').value); 
                     const fornecedor = UI.get('e-fornecedor').value; 
                     const dest = UI.get('e-tipo-estoque').value;
                    const db = DB.load(); const prod = db.produto.find(p => p.id === prodId);
                    if(prod) {
                        if(dest === 'fisico' || dest === 'ambos') prod.estoque += qtyInput;
                        if(dest === 'fiscal' || dest === 'ambos') prod.estoqueFiscal = (prod.estoqueFiscal || 0) + qtyInput;
                        prod.custo = custo;
                        db.entrada.push({ id: Date.now().toString(), date: Date.now(), prodId: prodId, qty: qtyInput, custo: custo, fornecedor: fornecedor, dest: dest });
                        DB.saveAll(db);
                    }
                    LogisticsApp.render(); 
                    document.getElementById('form-entrada-manual').reset();
                    return;
                }

                const p = t[0]; let objId = null; 
                if(t !== 'entrada') { objId = UI.get(`${p}-id`).value; }
                let obj = { id: objId || null }; 
                if(t !== 'venda') { obj.nome = UI.get(`${p}-nome`).value; if(objId) obj.codigo = UI.get(`${p}-codigo`).value; }
                
                if(t === 'cliente') { Object.assign(obj, { tel: UI.get('c-tel').value, cidade: UI.get('c-cidade').value, bairro: UI.get('c-bairro').value, endereco: UI.get('c-endereco').value, rota: UI.get('c-rota').value, maps: UI.get('c-maps').value }); }
                else if(t === 'produto') {
                    const isTemp = UI.get('p-isTemp').checked;
                    Object.assign(obj, { 
                        ean: UI.get('p-ean').value, 
                        ncm: UI.get('p-ncm').value, 
                        cest: UI.get('p-cest').value, 
                        cfop: UI.get('p-cfop').value, 
                        unidade: UI.get('p-unidade').value, 
                        categoria: UI.get('p-categoria').value, 
                        subcategoria: UI.get('p-subcategoria').value, // Added subcategory
                        custo: Number(UI.get('p-custo').value) || 0, // Ensure Number
                        valor: Number(UI.get('p-valor').value) || 0, 
                        estoque: Number(UI.get('p-estoque').value) || 0, 
                        estoqueFiscal: Number(UI.get('p-estoqueFiscal').value) || 0, 
                        tipo: UI.get('p-tipo').value, 
                        isTemp: isTemp 
                    });
                    if(obj.tipo === 'kit') {
                        let kitItems = Array.from(document.querySelectorAll('.kit-check:checked')).map(ck => ({ id: ck.dataset.pid, qty: Number(document.querySelector(`.kit-qty[data-pid="${ck.dataset.pid}"]`).value) }));
                        const bulkText = UI.get('p-kit-bulk').value.trim();
                        if(bulkText) { bulkText.split('\n').forEach(line => { const [code, qty] = line.split('|').map(s => s.trim()); const db = DB.load(); const found = db.produto.find(x => x.codigo === code); if(found) kitItems.push({ id: found.id, qty: Number(qty) || 1 }); }); }
                        obj.items = kitItems;
                    }
                } else if(t === 'venda') {
                    const prodSelect = UI.get('v-produto'); const prodId = prodSelect.value; const db = DB.load(); const prod = db.produto.find(x => x.id === prodId); if(!prod) return;
                    Object.assign(obj, { cliId: UI.get('v-cliente').value, prodId: prod.id, qty: Number(UI.get('v-qty').value), pag: UI.get('v-pagamento').value, rota: UI.get('v-rota').value, brinde: UI.get('v-brinde').value, total: (prod.valor * Number(UI.get('v-qty').value)) - Number(UI.get('v-desconto').value||0), date: Date.now(), obs: UI.get('v-obs').value });
                    
                    // --- LOGIC CHANGE: ONLY DEDUCT FROM PHYSICAL STOCK ---
                    const deduct = (id, q) => { 
                        const target = db.produto.find(x => x.id === id); 
                        if(target) { 
                            target.estoque -= q; // ONLY PHYSICAL STOCK
                            // Fiscal Stock (estoqueFiscal) is NOT touched here
                            
                            if(target.isTemp && target.estoque <= 0) { target.deleteAt = Date.now() + (24 * 60 * 60 * 1000); } 
                            else { if(target.deleteAt && target.estoque > 0) delete target.deleteAt; } 
                        } 
                    };
                    if(prod.tipo === 'kit' && prod.items) prod.items.forEach(ki => deduct(ki.id, ki.qty * obj.qty)); else deduct(prod.id, obj.qty);
                    DB.saveAll(db);
                }
                
                DB.save(t, obj); UI.render(t === 'produto' ? 'catalogo' : t); UI.resetForm(t);
            },
            printVenda: (id) => {
                const db = DB.load(); const v = db.venda.find(x => x.id === id); const c = db.cliente.find(x => x.id === v.cliId); const p = db.produto.find(x => x.id === v.prodId);
                let kitHtml = ""; if(p && p.tipo === 'kit' && p.items) { kitHtml = `<div style="border-top:1px dashed #000; padding-top:5px; margin-top:5px; font-size:11px;"><b>SEPARAÇÃO:</b><br>` + p.items.map(ki => { const sub = db.produto.find(x => x.id === ki.id); return `• ${ki.qty * v.qty}x ${sub?.nome || 'Item Excl'}`; }).join('<br>') + `</div>`; }
                UI.get('print-area').innerHTML = `<div class="no-print" style="margin-bottom: 20px; text-align: right;"><button onclick="UI.get('print-area').innerHTML=''" class="bg-red-600 text-white py-2 px-6 rounded-lg text-xs uppercase font-bold">Fechar</button></div><div style="font-family:monospace; width: 100%; max-width: 320px; padding: 10px; border: 1px solid #eee;"><center><h1 style="font-size: 24px; margin-bottom: 2px;">PEDIDO #${v.codigo}</h1><div style="background:#000; color:#fff; padding:10px 0; margin-top:5px; font-size: 38px; font-weight: 900;">ROTA: ${v.rota}</div></center><br><div style="font-size: 14px; border-bottom: 1px solid #000; padding-bottom: 5px;"><b>CLI:</b> [${c?.codigo}] - ${c?.nome}</div><div style="margin-top: 5px; font-size: 12px;"><b>CIDADE:</b> ${c?.cidade}/${c?.bairro}<br><b>END:</b> ${c?.endereco}</div><hr style="border:1px solid #000;margin:10px 0"><div style="font-size:16px;"><b>${v.qty}x ${p?.nome}</b></div>${kitHtml}<hr style="border:1px solid #000;margin:10px 0"><b>PGTO:</b> <span style="font-size: 16px;">${v.pag.toUpperCase()}</span><br>${v.brinde ? `<b>BRINDE:</b> <span style="font-size: 14px; color:#5b21b6;">${v.brinde.toUpperCase()}</span><br>` : ''}<div style="font-size:22px; text-align:right; margin-top: 5px;"><b>TOTAL: R$ ${v.total.toFixed(2)}</b></div><br><b>OBS:</b> ${v.obs || '-'}<br><center style="font-size: 10px; margin-top: 20px;">ENTERPRISE CORE - LOGÍSTICA<br>${new Date().toLocaleString('pt-BR')}</center></div>`;
                window.print();
            },
            edit: (t, id) => { 
                const dbType = t === 'catalogo' ? 'produto' : t;
                const i = DB.load()[dbType].find(x => x.id === id); 
                if(i) UI.fillForm(dbType, i); 
            },
            delete: (t, id) => { 
                if(confirm('Excluir?')) { 
                    DB.delete(t, id); 
                    UI.render(t === 'produto' ? 'catalogo' : t); 
                } 
            }
        };

        const ExportEngine = {
            exportAll: () => { const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(new Blob([JSON.stringify(DB.load())], {type: 'application/json'})), download: `backup_${Date.now()}.json` }); a.click(); },
            exportSelectedSales: () => {
                const db = DB.load(); const selectedIds = Array.from(document.querySelectorAll('.venda-select:checked')).map(cb => cb.dataset.id);
                if(!selectedIds.length) return alert('Selecione uma venda!');
                const report = selectedIds.map(id => { const v = db.venda.find(x => x.id === id); return { ...v, cliente: db.cliente.find(c => c.id === v.cliId), produto: db.produto.find(p => p.id === v.prodId) }; });
                const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'})), download: `vendas_selecionadas_${Date.now()}.json` }); a.click();
            }
        };

        // --- UNIFIED LOGISTICS & FISCAL LOGIC ---
        const LogisticsApp = {
            data: [], storageKey: 'nfe_sys_data_full_v2',
            loadFromStorage: () => { const stored = localStorage.getItem(LogisticsApp.storageKey); if (stored) { try { LogisticsApp.data = JSON.parse(stored); } catch (e) { localStorage.removeItem(LogisticsApp.storageKey); } } },
            saveToStorage: () => { try { localStorage.setItem(LogisticsApp.storageKey, JSON.stringify(LogisticsApp.data)); } catch (e) { alert('Limite do localStorage.'); } },
            clearData: () => { if (confirm('Apagar pré-visualização de XML?')) { LogisticsApp.data = []; localStorage.removeItem(LogisticsApp.storageKey); LogisticsApp.render(); document.getElementById('f-fileInput').value = ''; } },
            toggleLoading: (show) => { const el = document.getElementById('f-loading'); if(show) { el.classList.remove('hidden'); el.classList.add('flex'); } else { el.classList.add('hidden'); el.classList.remove('flex'); } },
            formatMoney: (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
            formatDate: (iso) => { if (!iso) return '-'; const [y, m, d] = iso.split('-'); return `${d}/${m}/${y}`; },

            // Modal Logic
            showDetails: (id) => {
                const item = LogisticsApp.data.find(i => i.id === id); if(!item) return;
                const modal = document.getElementById('fiscal-modal'); const body = document.getElementById('fiscal-modal-body');
                body.innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-sm"><div class="col-span-2 p-3 bg-slate-50 rounded border"><h4 class="font-bold text-slate-700">${item.xProd}</h4><p class="text-xs text-slate-500">Emitente: ${item.emitente}</p></div><div><span class="font-bold block text-xs uppercase text-slate-400">NCM</span> ${item.NCM}</div><div><span class="font-bold block text-xs uppercase text-slate-400">CFOP</span> ${item.CFOP}</div><div><span class="font-bold block text-xs uppercase text-slate-400">Cód. Prod</span> ${item.cProd}</div><div><span class="font-bold block text-xs uppercase text-slate-400">EAN/GTIN</span> ${item.cEAN}</div></div>
                    <div class="mt-4 border-t pt-4"><h5 class="font-bold text-slate-700 mb-2">Tributação Detalhada</h5><div class="grid grid-cols-4 gap-2 text-center"><div class="p-2 bg-red-50 rounded"><span class="block text-[10px] font-bold text-red-400">ICMS</span> <span class="font-bold text-slate-700">${LogisticsApp.formatMoney(item.vICMS)}</span></div><div class="p-2 bg-red-50 rounded"><span class="block text-[10px] font-bold text-red-400">IPI</span> <span class="font-bold text-slate-700">${LogisticsApp.formatMoney(item.vIPI)}</span></div></div></div>`;
                modal.classList.remove('hidden');
            },
            closeModal: () => { document.getElementById('fiscal-modal').classList.add('hidden'); },

            // IMPORT TO STOCK LOGIC
            importToStock: () => {
                const filtered = LogisticsApp.data; 
                const dest = document.getElementById('f-stock-dest').value;
                const forcedType = document.getElementById('f-move-type').value; 

                if(filtered.length === 0) return alert("Nenhum item XML listado.");
                if(!confirm(`Deseja processar ${filtered.length} itens no estoque?`)) return;

                const db = DB.load();
                let created = 0, updated = 0;
                
                filtered.forEach(item => {
                    let prod = db.produto.find(p => (item.cEAN && p.ean === item.cEAN) || p.nome.trim().toLowerCase() === item.xProd.trim().toLowerCase());
                    
                    if(!prod) {
                        prod = { 
                            id: Date.now().toString() + Math.random().toString().slice(2,5), 
                            codigo: DB.getNextCode('produto'), 
                            nome: item.xProd, 
                            ean: item.cEAN !== 'SEM GTIN' ? item.cEAN : '', 
                            ncm: item.NCM, 
                            cest: '', cfop: item.CFOP, unidade: item.uCom, 
                            valor: item.vUnCom * 1.5, custo: item.vUnCom, 
                            estoque: 0, estoqueFiscal: 0, 
                            tipo: 'normal' 
                        };
                        db.produto.push(prod); created++;
                    } else { updated++; }

                    let qty = item.qCom;
                    let isExit = false;

                    if(forcedType === 'saida') { isExit = true; }
                    else if(forcedType === 'entrada') { isExit = false; }
                    else { 
                        if(item.tpNF === '1') isExit = true; 
                    }

                    if(isExit) qty = -Math.abs(qty); 
                    else qty = Math.abs(qty); 

                    if(dest === 'fisico' || dest === 'ambos') prod.estoque += qty;
                    if(dest === 'fiscal' || dest === 'ambos') prod.estoqueFiscal = (prod.estoqueFiscal || 0) + qty;
                    
                    db.entrada.push({ 
                        id: Date.now().toString() + Math.random().toString().slice(2,5), 
                        date: Date.now(), 
                        prodId: prod.id, 
                        qty: qty, 
                        custo: item.vUnCom, 
                        fornecedor: `${item.emitente} (${isExit ? 'SAÍDA XML' : 'ENTRADA XML'})`, 
                        dest: dest 
                    });
                });
                
                DB.saveAll(db);
                alert(`Processamento Concluído!\nNovos: ${created}, Atualizados: ${updated}`);
                LogisticsApp.clearData();
                LogisticsApp.render(); 
            },

            handleFileUpload: async (event) => {
                const files = Array.from(event.target.files); if (files.length === 0) return;
                LogisticsApp.toggleLoading(true);
                const readFile = (file) => new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => resolve(e.target.result); reader.onerror = (e) => reject(e); reader.readAsText(file); });
                try {
                    const contents = await Promise.all(files.map(file => readFile(file))); let newItems = [];
                    contents.forEach(xml => { const items = LogisticsApp.parseXML(xml); if(items) newItems.push(...items); });
                    LogisticsApp.data = [...LogisticsApp.data, ...newItems]; LogisticsApp.saveToStorage(); LogisticsApp.render();
                } catch (e) { console.error(e); alert('Erro ao processar XML.'); } finally { LogisticsApp.toggleLoading(false); document.getElementById('f-fileInput').value = ''; }
            },
            parseXML: (xmlString) => {
                try {
                    const parser = new DOMParser(); const xmlDoc = parser.parseFromString(xmlString, "text/xml"); if (xmlDoc.getElementsByTagName("parsererror").length > 0) return null;
                    const getTag = (p, t) => { if (!p) return ''; const els = p.getElementsByTagName(t); return els.length ? els[0].textContent : ''; };
                    const getFloat = (p, t) => { const val = getTag(p, t); return val ? parseFloat(val) : 0.0; };
                    
                    const infNFe = xmlDoc.getElementsByTagName('infNFe')[0]; if (!infNFe) return null;
                    
                    const ide = xmlDoc.getElementsByTagName('ide')[0];
                    const tpNF = getTag(ide, 'tpNF'); 
                    const nNF = getTag(infNFe, 'nNF'); 
                    const dhEmiRaw = getTag(infNFe, 'dhEmi') || getTag(infNFe, 'dEmi'); 
                    const emitente = getTag(infNFe, 'xNome'); 
                    const chave = infNFe.getAttribute('Id') || '';
                    const dateObj = new Date(dhEmiRaw); 
                    const formattedDate = !isNaN(dateObj) ? dateObj.toISOString().split('T')[0] : '';
                    
                    const detTags = xmlDoc.getElementsByTagName('det'); const items = [];
                    for (let i = 0; i < detTags.length; i++) {
                        const det = detTags[i]; const prod = det.getElementsByTagName('prod')[0]; const imposto = det.getElementsByTagName('imposto')[0]; const nItem = det.getAttribute('nItem');
                        let icmsCst = '', vICMS = 0, vIPI = 0, vPIS = 0, vCOFINS = 0;
                        if (imposto) { vICMS = getFloat(imposto, 'vICMS'); vIPI = getFloat(imposto, 'vIPI'); vPIS = getFloat(imposto, 'vPIS'); vCOFINS = getFloat(imposto, 'vCOFINS'); icmsCst = getTag(imposto, 'CST') || getTag(imposto, 'CSOSN'); }
                        items.push({ 
                            id: `${chave}-${nItem}`, 
                            nNF, tpNF, dataEmissao: formattedDate, emitente, 
                            cProd: getTag(prod, 'cProd'), cEAN: getTag(prod, 'cEAN'), xProd: getTag(prod, 'xProd'), 
                            NCM: getTag(prod, 'NCM'), CFOP: getTag(prod, 'CFOP'), uCom: getTag(prod, 'uCom'), 
                            qCom: getFloat(prod, 'qCom'), vUnCom: getFloat(prod, 'vUnCom'), vProd: getFloat(prod, 'vProd'), 
                            CST_CSOSN: icmsCst, vICMS, vIPI, vPIS, vCOFINS 
                        });
                    }
                    return items;
                } catch (e) { return []; }
            },
            render: () => {
                if(LogisticsApp.data.length === 0) LogisticsApp.loadFromStorage();
                
                const tbodyXML = document.getElementById('f-tableBody');
                tbodyXML.innerHTML = LogisticsApp.data.length === 0 ? `<tr><td colspan="4" class="p-4 text-center text-slate-400">Nenhum XML carregado.</td></tr>` : 
                LogisticsApp.data.slice(0, 100).map(item => {
                    const typeBadge = item.tpNF === '1' ? '<span class="text-[9px] text-red-600 bg-red-100 px-1 rounded">SAÍDA</span>' : '<span class="text-[9px] text-emerald-600 bg-emerald-100 px-1 rounded">ENTRADA</span>';
                    return `
                    <tr class="border-b hover:bg-slate-50">
                        <td class="p-2"><div class="font-bold text-slate-700 truncate w-32">${item.xProd}</div><div class="text-[9px] text-slate-400">${item.nNF} | ${item.emitente.substring(0,10)}</div></td>
                        <td class="p-2">${typeBadge}</td>
                        <td class="p-2 text-right font-mono text-slate-600">${item.qCom}</td>
                        <td class="p-2 text-center"><button onclick="LogisticsApp.showDetails('${item.id}')" class="text-blue-500 hover:text-blue-700"><i class="fa-solid fa-eye"></i></button></td>
                    </tr>
                `}).join('');

                const db = DB.load();
                const historyData = db.entrada.sort((a,b) => b.date - a.date).slice(0, 200);
                const tbodyHist = document.getElementById('table-entrada');
                document.getElementById('count-entrada').innerText = historyData.length;
                
                tbodyHist.innerHTML = historyData.map(i => {
                     const p = db.produto.find(x => x.id === i.prodId);
                     const date = new Date(i.date).toLocaleDateString('pt-BR') + ' ' + new Date(i.date).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
                     let typeLabel = '<span class="text-[9px] bg-slate-100 px-1 rounded border">Físico</span>';
                     if(i.dest === 'fiscal') typeLabel = '<span class="text-[9px] bg-purple-100 text-purple-700 px-1 rounded border border-purple-200">Fiscal</span>';
                     if(i.dest === 'ambos') typeLabel = '<span class="text-[9px] bg-blue-100 text-blue-700 px-1 rounded border border-blue-200">Ambos</span>';
                     
                     const isNegative = i.qty < 0;
                     const qtyDisplay = isNegative ? `<span class="text-red-500 font-bold">${i.qty}</span>` : `<span class="text-emerald-600 font-bold">+${i.qty}</span>`;

                     return `<tr class="hover:bg-slate-50 text-xs border-b border-slate-50">
                         <td class="p-3 text-slate-500 whitespace-nowrap">${date}</td>
                         <td class="p-3 font-bold text-slate-700">${p ? p.codigo + ' - ' + p.nome : 'Excluído'}</td>
                         <td class="p-3">${typeLabel}</td>
                         <td class="p-3 text-slate-600 truncate max-w-[150px]">${i.fornecedor || '-'}</td>
                         <td class="p-3 font-bold text-right">${qtyDisplay}</td>
                     </tr>`;
                }).join('');
            },
            exportData: (type) => { const data = LogisticsApp.data; if(!data.length) return alert('Sem dados.'); const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `xml_preview_${Date.now()}.json`; a.click(); }
        };
        window.onload = App.init;
    </script>
</body>
</html>
