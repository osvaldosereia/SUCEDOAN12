<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAS | Sandbox Pro Path-Mapping</title>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #38bdf8;
            --accent: #22c55e;
            --text: #f1f5f9;
            --border: #334155;
            --radius: 8px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.4; }

        #ui-wrapper { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        
        .card { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border); margin-bottom: 1.5rem; }
        
        h2 { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--primary); margin-bottom: 1rem; }

        textarea { 
            width: 100%; height: 200px; padding: 1rem; background: #000; color: #0f0; 
            border: 1px solid var(--border); border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.85rem;
        }

        .upload-zone { 
            border: 2px dashed var(--border); padding: 2rem; text-align: center; border-radius: var(--radius); 
            cursor: pointer; transition: 0.3s; margin-bottom: 1rem;
        }
        .upload-zone:hover { border-color: var(--primary); background: #1e293b; }

        /* Lista de Arquivos com Input de Rota */
        .file-item {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            align-items: center;
            background: #0f172a;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 5px;
            border: 1px solid var(--border);
        }

        .file-item input {
            background: #1e293b;
            border: 1px solid var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .btn-run {
            position: sticky; bottom: 20px; width: 100%; background: var(--accent);
            color: #000; border: none; padding: 1.2rem; border-radius: var(--radius);
            font-size: 1.1rem; font-weight: 800; cursor: pointer; box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        /* Preview Mode */
        #preview-frame { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; border: none; display: none; z-index: 10; background: white; }
        #back-btn {
            position: fixed; bottom: 20px; left: 20px; z-index: 100;
            width: 50px; height: 50px; border-radius: 50%; background: var(--primary);
            display: none; align-items: center; justify-content: center; border: none; cursor: pointer;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="ui-wrapper">
    <header style="margin-bottom: 2rem;">
        <h1>SISTEMAS <span style="color: var(--primary)">SANDBOX</span></h1>
        <p style="opacity: 0.7;">Ambiente de simulação de diretórios e fetch local</p>
    </header>

    <div class="card">
        <h2>1. Código HTML (Index)</h2>
        <textarea id="code-editor" placeholder="Cole o HTML aqui ou arraste o arquivo abaixo..."></textarea>
    </div>

    <div class="card">
        <h2>2. Arquivos de Dados (JSON)</h2>
        <div class="upload-zone" onclick="document.getElementById('file-input').click()">
            <p>Clique ou arraste arquivos .json e .html</p>
            <input type="file" id="file-input" multiple accept=".html,.json" class="hidden">
        </div>
        <div id="file-list"></div>
    </div>

    <button class="btn-run" id="run-btn">CONFIGURAR E LANÇAR</button>
</div>

<button id="back-btn" onclick="location.reload()">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
</button>

<iframe id="preview-frame"></iframe>

<script>
    const storage = { html: "", files: {} }; // files: { id: { name, content, virtualPath } }
    const editor = document.getElementById('code-editor');
    const fileListDiv = document.getElementById('file-list');

    async function handleFiles(files) {
        for (const file of files) {
            const content = await file.text();
            const id = Math.random().toString(36).substr(2, 9);
            
            if (file.name === 'index.html') {
                editor.value = content;
                storage.html = content;
            } else if (file.name.endsWith('.json')) {
                storage.files[id] = {
                    name: file.name,
                    content: JSON.parse(content),
                    virtualPath: file.name // Caminho padrão é o nome do arquivo
                };
                renderFileList();
            }
        }
    }

    function renderFileList() {
        fileListDiv.innerHTML = '';
        Object.keys(storage.files).forEach(id => {
            const file = storage.files[id];
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <span style="font-size: 0.8rem; font-weight: bold;">${file.name}</span>
                <input type="text" value="${file.virtualPath}" placeholder="Rota (ex: folder/data.json)" 
                    oninput="storage.files['${id}'].virtualPath = this.value">
                <button onclick="delete storage.files['${id}']; renderFileList()" style="background:none; border:none; color:#ff4444; cursor:pointer;">✕</button>
            `;
            fileListDiv.appendChild(div);
        });
    }

    document.getElementById('file-input').onchange = (e) => handleFiles(e.target.files);

    document.getElementById('run-btn').onclick = () => {
        const html = editor.value;
        if (!html) return alert("Insira o HTML!");

        // Mapeia os caminhos virtuais para o objeto de mock
        const mockMap = {};
        Object.values(storage.files).forEach(f => {
            mockMap[f.virtualPath] = f.content;
        });

        const injection = `
            <script>
                const _MOCK_DATA = ${JSON.stringify(mockMap)};
                const _originalFetch = window.fetch;
                window.fetch = async (input, init) => {
                    let url = typeof input === 'string' ? input : input.url;
                    
                    // Normaliza a URL para bater com o virtualPath (remove ./ e / iniciais para comparar)
                    const cleanUrl = url.replace(/^\\.\\//, '').replace(/^\\//, '');
                    
                    // Busca exata ou busca pelo final do caminho
                    const match = Object.keys(_MOCK_DATA).find(path => 
                        path === cleanUrl || url.endsWith(path)
                    );

                    if (match) {
                        console.log('Sandbox: Roteando fetch para path virtual:', match);
                        return new Response(JSON.stringify(_MOCK_DATA[match]), {
                            status: 200,
                            headers: { 'Content-Type': 'application/json' }
                        });
                    }
                    return _originalFetch(input, init);
                };
            <\/script>
        `;

        const finalCode = html.includes('<head>') ? html.replace('<head>', '<head>' + injection) : injection + html;
        const blob = new Blob([finalCode], { type: 'text/html' });
        
        const iframe = document.getElementById('preview-frame');
        iframe.src = URL.createObjectURL(blob);
        iframe.style.display = 'block';
        document.getElementById('ui-wrapper').classList.add('hidden');
        document.getElementById('back-btn').style.display = 'flex';
    };

    // Drag & Drop
    const dz = document.querySelector('.upload-zone');
    dz.ondragover = (e) => { e.preventDefault(); dz.style.borderColor = 'var(--primary)'; };
    dz.ondrop = (e) => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
</script>

</body>
</html>
