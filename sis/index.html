<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V3 | Professional Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' },
                        slate: { 850: '#1e293b' } // Custom dark sidebar
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Setup */
        body { background-color: #f3f4f6; color: #111827; overflow: hidden; font-size: 13px; }
        
        /* Layout Structure */
        .app-wrapper { display: flex; height: 100vh; width: 100vw; }
        .sidebar { width: 240px; background-color: #0f172a; color: #e2e8f0; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; }
        .main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; background: #f3f4f6; position: relative; }
        .content-scroll { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px; scroll-behavior: smooth; }

        /* Sticky Headers */
        .top-header { height: 56px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; padding: 0 24px; justify-content: space-between; flex-shrink: 0; z-index: 40; }
        
        /* Components */
        .card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); overflow: hidden; display: flex; flex-direction: column; }
        .card-header { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; background-color: #f9fafb; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .card-body { padding: 16px; flex: 1; overflow-y: auto; }
        
        /* Tables */
        .table-container { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        thead th { 
            background-color: #f9fafb; color: #6b7280; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; padding: 10px 16px; border-bottom: 1px solid #e5e7eb; 
            position: sticky; top: 0; z-index: 10; 
        }
        tbody td { padding: 10px 16px; border-bottom: 1px solid #f3f4f6; color: #374151; vertical-align: middle; }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background-color: #f9fafb; }

        /* Forms */
        label { display: block; font-size: 11px; font-weight: 600; color: #4b5563; margin-bottom: 4px; text-transform: uppercase; }
        input, select, textarea { width: 100%; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 10px; font-size: 13px; color: #111827; transition: border-color 0.15s, box-shadow 0.15s; outline: none; }
        input:focus, select:focus, textarea:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        input:read-only { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 12px; transition: all 0.2s; gap: 6px; cursor: pointer; border: none; }
        .btn-primary { background-color: #2563eb; color: white; } .btn-primary:hover { background-color: #1d4ed8; }
        .btn-success { background-color: #10b981; color: white; } .btn-success:hover { background-color: #059669; }
        .btn-danger { background-color: #ef4444; color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-ghost { background-color: transparent; color: #6b7280; } .btn-ghost:hover { background-color: #f3f4f6; color: #111827; }
        
        /* Navigation */
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 16px; color: #94a3b8; border-radius: 6px; margin: 2px 8px; transition: all 0.2s; font-weight: 500; font-size: 13px; cursor: pointer; border: none; background: transparent; width: calc(100% - 16px); text-align: left; }
        .nav-item:hover { background-color: rgba(255,255,255,0.05); color: #f8fafc; }
        .nav-item.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .nav-item i { width: 18px; text-align: center; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Utility Classes */
        .hidden { display: none !important; }
        .view-section { display: none; height: 100%; flex-direction: column; gap: 20px; }
        .view-section.active { display: flex; }
        .split-view { display: flex; gap: 20px; height: 100%; align-items: flex-start; }
        .split-left { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; max-height: 100%; }
        .split-right { flex: 1; min-width: 0; display: flex; flex-direction: column; height: 100%; }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; px: 2px; py: 0.5px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .badge-gray { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; padding: 2px 6px; }
        .badge-blue { background: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; padding: 2px 6px; }
        .badge-purple { background: #f5f3ff; color: #7c3aed; border: 1px solid #ede9fe; padding: 2px 6px; }
        
        dialog::backdrop { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(2px); }
    </style>
</head>
<body>

    <div class="app-wrapper">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="p-6 flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center shadow-lg shadow-blue-900/50">
                    <i class="fa-solid fa-cube text-white text-sm"></i>
                </div>
                <div>
                    <h1 class="font-bold text-white tracking-wide text-sm">SISTEMA V3</h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-wider">Pro Edition</p>
                </div>
            </div>
            
            <nav class="flex-1 mt-4">
                <button onclick="UI.switchView('cliente', this)" class="nav-item active"><i class="fa-solid fa-users"></i> Clientes</button>
                <button onclick="UI.switchView('catalogo', this)" class="nav-item"><i class="fa-solid fa-box-archive"></i> Catálogo</button>
                <button onclick="UI.switchView('logistica', this)" class="nav-item"><i class="fa-solid fa-truck-ramp-box"></i> Logística</button>
                <button onclick="UI.switchView('venda', this)" class="nav-item"><i class="fa-solid fa-cart-shopping"></i> Vendas</button>
                <button onclick="UI.switchView('expedicao', this)" class="nav-item"><i class="fa-solid fa-clipboard-list"></i> Expedição</button>
            </nav>

            <div class="p-4 border-t border-slate-700/50">
                <button onclick="ExportEngine.exportAll()" class="nav-item !m-0 !w-full justify-center bg-slate-800 hover:bg-slate-700">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Backup Dados
                </button>
            </div>
        </aside>

        <!-- MAIN AREA -->
        <main class="main-area">
            <header class="top-header">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-lg font-bold text-gray-800">Visão Geral</h2>
                    <span class="h-4 w-px bg-gray-300"></span>
                    <span id="clock" class="text-xs font-medium text-gray-500 font-mono">00:00</span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <p class="text-xs font-bold text-gray-700">Admin User</p>
                        <p class="text-[10px] text-gray-400 uppercase">Gerente</p>
                    </div>
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 text-xs font-bold border border-gray-300">AD</div>
                </div>
            </header>

            <div class="content-scroll">
                
                <!-- VIEW: CLIENTE -->
                <div id="view-cliente" class="view-section active">
                    <div class="split-view">
                        <div class="card split-left">
                            <div class="card-header">
                                <span class="text-xs font-bold text-gray-600 uppercase">Novo Cliente</span>
                                <button onclick="UI.resetForm('cliente')" class="text-xs text-gray-400 hover:text-red-500 font-medium">Limpar</button>
                            </div>
                            <div class="card-body">
                                <form onsubmit="App.handleSave('cliente', event)" id="form-cliente" class="flex flex-col gap-4">
                                    <input type="hidden" id="c-id">
                                    <div class="grid grid-cols-3 gap-3">
                                        <div><label>Código</label><input type="text" id="c-codigo" readonly></div>
                                        <div class="col-span-2"><label>Rota</label><select id="c-rota"><option value="">Sel...</option><option value="CX">CX</option><option value="VG">VG</option><option value="CBA">CBA</option><option value="CPA">CPA</option></select></div>
                                    </div>
                                    <div><label>Nome Completo</label><input type="text" id="c-nome" required></div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label>Telefone</label><input type="text" id="c-tel"></div>
                                        <div><label>Cidade</label><select id="c-cidade"><option>Cuiabá</option><option>Várzea Grande</option></select></div>
                                    </div>
                                    <div><label>Endereço</label><textarea id="c-endereco" rows="3"></textarea></div>
                                    <button class="btn btn-primary w-full mt-2">Salvar Registro</button>
                                </form>
                            </div>
                        </div>

                        <div class="card split-right">
                            <div class="card-header">
                                <div class="flex items-center gap-3">
                                    <div class="relative">
                                        <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                                        <input type="text" oninput="UI.filter('cliente', this.value)" placeholder="Buscar clientes..." class="pl-8 !w-64">
                                    </div>
                                </div>
                                <span class="text-xs font-bold text-gray-500">Total: <span id="count-cliente" class="text-gray-800">0</span></span>
                            </div>
                            <div class="table-container flex-1">
                                <table>
                                    <thead><tr><th>Cliente</th><th>Localização</th><th class="text-right">Ações</th></tr></thead>
                                    <tbody id="table-cliente"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: CATÁLOGO -->
                <div id="view-catalogo" class="view-section">
                    <div class="split-view">
                        <!-- Form Produto -->
                        <div class="card split-left">
                            <div class="card-header">
                                <span class="text-xs font-bold text-gray-600 uppercase">Dados do Produto</span>
                                <button onclick="UI.resetForm('produto')" class="text-xs text-gray-400 hover:text-red-500 font-medium">Limpar</button>
                            </div>
                            <div class="card-body">
                                <form onsubmit="App.handleSave('produto', event)" id="form-produto" class="flex flex-col gap-3">
                                    <input type="hidden" id="p-id">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label>Código</label><input type="text" id="p-codigo" readonly class="font-bold text-gray-600"></div>
                                        <div><label>EAN (Unid)</label><input type="text" id="p-ean" placeholder="GTIN-13"></div>
                                    </div>
                                    <div><label>Descrição</label><input type="text" id="p-nome" required class="font-medium"></div>
                                    
                                    <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
                                        <div class="flex justify-between items-center mb-2">
                                            <label class="!mb-0">Estoque</label>
                                            <div class="flex gap-2">
                                                <label class="flex items-center gap-1 font-normal cursor-pointer"><input type="radio" name="p-stock-type" value="ambos" checked onchange="UI.toggleStockInputs()" class="!w-auto"> Ambos</label>
                                                <label class="flex items-center gap-1 font-normal cursor-pointer"><input type="radio" name="p-stock-type" value="fisico" onchange="UI.toggleStockInputs()" class="!w-auto"> Fís</label>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3" id="stock-inputs-container">
                                            <div id="grp-fisico"><label class="text-gray-400 text-[10px]">Físico</label><input type="number" id="p-estoque" placeholder="0" class="text-center font-bold"></div>
                                            <div id="grp-fiscal"><label class="text-purple-400 text-[10px]">Fiscal</label><input type="number" id="p-estoqueFiscal" placeholder="0" class="text-center font-bold text-purple-600 border-purple-200 bg-purple-50"></div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label>Custo (R$)</label><input type="number" id="p-custo" step="0.0001"></div>
                                        <div><label class="text-blue-600">Venda (R$)</label><input type="number" id="p-valor" step="0.01" class="font-bold text-blue-600 border-blue-200 bg-blue-50"></div>
                                    </div>

                                    <details class="group bg-white border border-gray-200 rounded-md">
                                        <summary class="list-none flex justify-between items-center cursor-pointer p-2.5 text-xs font-bold text-gray-500 hover:bg-gray-50">
                                            FISCAL / XML <i class="fa-solid fa-chevron-down text-[10px] transition-transform group-open:rotate-180"></i>
                                        </summary>
                                        <div class="p-3 pt-0 flex flex-col gap-3 border-t border-gray-100 mt-2">
                                            <div class="grid grid-cols-2 gap-3 mt-2">
                                                <div><label>NCM</label><input type="text" id="p-ncm"></div>
                                                <div><label>CEST</label><input type="text" id="p-cest"></div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-3">
                                                <div><label>CFOP</label><input type="text" id="p-cfop"></div>
                                                <div><label>CSOSN</label><input type="text" id="p-csosn"></div>
                                            </div>
                                            <input type="hidden" id="p-categoria"><input type="hidden" id="p-subcategoria"><input type="hidden" id="p-nota"><input type="hidden" id="p-refId"><input type="hidden" id="p-fator"><input type="hidden" id="p-unidade">
                                            <textarea id="p-obs-produto" rows="1" placeholder="Obs Fiscal"></textarea>
                                        </div>
                                    </details>

                                    <button class="btn btn-primary w-full mt-2 py-2.5">Salvar Produto</button>
                                </form>
                            </div>
                        </div>

                        <!-- Tabela Produto -->
                        <div class="card split-right">
                            <div class="card-header">
                                <div class="flex gap-2">
                                    <div class="relative">
                                        <i class="fa-solid fa-search absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                                        <input type="text" id="catalogo-search" oninput="Views.catalogo.filter(this.value)" placeholder="Buscar produto..." class="pl-8 !w-64">
                                    </div>
                                    <button onclick="CategoryApp.openModal()" class="btn btn-ghost border border-gray-200 !px-3 text-xs"><i class="fa-solid fa-tags"></i></button>
                                </div>
                                <span class="text-xs font-bold text-gray-500">Itens: <span id="count-produto" class="text-gray-800">0</span></span>
                            </div>
                            <div class="table-container flex-1">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 40%;">Produto</th>
                                            <th class="text-center" style="width: 10%;">Físico</th>
                                            <th class="text-center" style="width: 10%;">Fiscal</th>
                                            <th style="width: 20%;">Preço</th>
                                            <th class="text-right" style="width: 20%;">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-produto"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: LOGÍSTICA -->
                <div id="view-logistica" class="view-section">
                    <div class="split-view">
                        <div class="flex flex-col gap-4 split-left">
                            <!-- Import -->
                            <div class="card">
                                <div class="card-header"><span class="text-xs font-bold text-blue-600 uppercase">Importar XML/JSON</span></div>
                                <div class="card-body">
                                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center text-center hover:bg-gray-50 transition cursor-pointer relative">
                                        <i class="fa-solid fa-file-arrow-up text-2xl text-gray-300 mb-2"></i>
                                        <span class="text-xs text-gray-500">Arraste ou clique</span>
                                        <input type="file" id="json-import-file" accept=".json" class="absolute inset-0 opacity-0 cursor-pointer">
                                    </div>
                                    <button onclick="ImportEngine.processFile()" class="btn btn-primary w-full mt-3">Processar Arquivo</button>
                                </div>
                            </div>
                            
                            <!-- Manual -->
                            <div class="card flex-1">
                                <div class="card-header"><span class="text-xs font-bold text-orange-600 uppercase">Movimento Manual</span></div>
                                <div class="card-body">
                                    <form onsubmit="App.handleSave('entrada', event)" id="form-entrada-manual" class="flex flex-col gap-3">
                                        <div><label>Produto</label><select id="e-produto" required></select></div>
                                        <div><label>Destino</label><select id="e-tipo-estoque"><option value="fisico">Físico</option><option value="fiscal">Fiscal</option><option value="ambos">Ambos</option></select></div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div><label>Qtd (+/-)</label><input type="number" id="e-qty" required class="font-bold"></div>
                                            <div><label>Custo</label><input type="number" id="e-custo" step="0.01"></div>
                                        </div>
                                        <button class="btn btn-primary bg-orange-600 hover:bg-orange-700 w-full mt-2">Registrar</button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="card split-right">
                            <div class="card-header">
                                <span class="text-xs font-bold text-gray-600 uppercase">Histórico de Movimentação</span>
                                <span class="text-xs font-bold text-gray-500">Regs: <span id="count-entrada">0</span></span>
                            </div>
                            <div class="table-container flex-1">
                                <table>
                                    <thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Origem</th><th class="text-right">Qtd</th></tr></thead>
                                    <tbody id="table-entrada"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: VENDA -->
                <div id="view-venda" class="view-section">
                    <div class="split-view">
                        <div class="card split-left">
                            <div class="card-header">
                                <span class="text-xs font-bold text-emerald-600 uppercase">Novo Pedido</span>
                                <button onclick="UI.resetForm('venda')" class="text-xs text-gray-400 hover:text-red-500 font-medium">Limpar</button>
                            </div>
                            <div class="card-body">
                                <form onsubmit="App.handleSave('venda', event)" id="form-venda" class="flex flex-col gap-3">
                                    <input type="hidden" id="v-id">
                                    <div><label>Cliente</label><select id="v-cliente" required></select></div>
                                    <div class="p-3 bg-gray-50 rounded border border-gray-200">
                                        <label>Item</label>
                                        <input type="text" id="v-prod-search" oninput="UI.searchProduct(this.value)" placeholder="Buscar..." class="mb-2">
                                        <div class="flex gap-2">
                                            <select id="v-produto" required class="flex-1"></select>
                                            <input type="number" id="v-qty" value="1" min="1" class="w-16 text-center font-bold">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div><label>Pagamento</label><select id="v-pagamento"><option>Dinheiro</option><option>Pix</option><option>Cartão</option></select></div>
                                        <div><label>Rota</label><select id="v-rota"><option>CX</option><option>VG</option><option>CBA</option></select></div>
                                    </div>
                                    <div><label>Desconto (R$)</label><input type="number" id="v-desconto" step="0.01"></div>
                                    
                                    <div class="mt-2 p-3 bg-slate-800 rounded text-white flex justify-between items-center shadow-sm">
                                        <span class="text-xs font-bold text-slate-400 uppercase">Total</span>
                                        <span id="v-total" class="text-lg font-bold">R$ 0,00</span>
                                    </div>
                                    <button class="btn btn-success w-full py-3 text-xs uppercase tracking-wide">Finalizar Pedido</button>
                                </form>
                            </div>
                        </div>

                        <div class="card split-right">
                            <div class="card-header">
                                <div class="flex gap-2 items-center">
                                    <input type="date" id="v-filter-start" class="!w-32">
                                    <input type="date" id="v-filter-end" class="!w-32">
                                    <button onclick="Views.venda.render()" class="btn btn-ghost border border-gray-200 text-xs">Filtrar</button>
                                </div>
                                <span class="text-xs font-bold text-gray-500">Pedidos: <span id="count-venda">0</span></span>
                            </div>
                            <div class="table-container flex-1">
                                <table>
                                    <thead><tr><th class="w-10">#</th><th>Cliente</th><th>Detalhes</th><th class="text-right">Ações</th></tr></thead>
                                    <tbody id="table-venda"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VIEW: EXPEDIÇÃO -->
                <div id="view-expedicao" class="view-section">
                    <div class="grid grid-cols-4 h-full gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                        <div class="flex flex-col bg-gray-50"><div class="bg-blue-600 text-white font-bold p-3 text-center text-sm uppercase">CX</div><div id="col-CX" class="flex-1 p-2 overflow-auto space-y-2"></div></div>
                        <div class="flex flex-col bg-gray-50"><div class="bg-emerald-600 text-white font-bold p-3 text-center text-sm uppercase">VG</div><div id="col-VG" class="flex-1 p-2 overflow-auto space-y-2"></div></div>
                        <div class="flex flex-col bg-gray-50"><div class="bg-orange-600 text-white font-bold p-3 text-center text-sm uppercase">CBA</div><div id="col-CBA" class="flex-1 p-2 overflow-auto space-y-2"></div></div>
                        <div class="flex flex-col bg-gray-50"><div class="bg-purple-600 text-white font-bold p-3 text-center text-sm uppercase">CPA</div><div id="col-CPA" class="flex-1 p-2 overflow-auto space-y-2"></div></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL IMPORTAÇÃO -->
    <dialog id="import-modal" class="rounded-lg shadow-2xl p-0 w-[900px] max-w-full m-auto open:animate-in open:fade-in open:zoom-in-95 duration-200">
        <div class="p-4 bg-slate-800 text-white flex justify-between items-center sticky top-0 z-50">
            <h3 class="font-bold text-sm uppercase tracking-wide">Conferência de Importação</h3>
            <button onclick="document.getElementById('import-modal').close()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
        </div>
        <div class="p-6 bg-white">
            <div class="flex gap-6 mb-6 items-center bg-gray-50 p-4 rounded border border-gray-200">
                <span class="text-xs font-bold text-gray-500 uppercase mr-2">Destino do Estoque:</span>
                <label class="flex items-center gap-2 cursor-pointer text-xs font-medium"><input type="radio" name="import-dest" value="fisico"> Físico</label>
                <label class="flex items-center gap-2 cursor-pointer text-xs font-medium"><input type="radio" name="import-dest" value="fiscal"> Fiscal</label>
                <label class="flex items-center gap-2 cursor-pointer text-xs font-bold text-blue-600"><input type="radio" name="import-dest" value="ambos" checked> Ambos</label>
            </div>
            
            <div class="border border-gray-200 rounded-lg overflow-hidden max-h-[50vh] overflow-y-auto custom-scroll">
                <table>
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="text-center w-10"><input type="checkbox" checked onchange="ImportEngine.toggleAll(this.checked)"></th>
                            <th>Produto (JSON)</th>
                            <th style="width: 200px;">EANs Identificados</th>
                            <th>Status Sistema</th>
                            <th class="text-right">Qtd</th>
                        </tr>
                    </thead>
                    <tbody id="import-preview-list" class="bg-white"></tbody>
                </table>
            </div>
            
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="document.getElementById('import-modal').close()" class="btn btn-ghost border border-gray-200">Cancelar</button>
                <button onclick="ImportEngine.confirmImport()" class="btn btn-success px-6 shadow-md shadow-emerald-200">Confirmar e Salvar</button>
            </div>
        </div>
    </dialog>

    <!-- MODAL CATEGORIAS -->
    <dialog id="cat-modal" class="rounded-lg shadow-xl p-5 w-96 m-auto">
        <h3 class="font-bold text-sm uppercase mb-4 text-gray-700">Categorias</h3>
        <form onsubmit="CategoryApp.addCategory(event)" class="flex gap-2 mb-4">
            <input type="text" id="new-cat-name" placeholder="Nova..." class="flex-1">
            <button class="btn btn-primary">ADD</button>
        </form>
        <div id="cat-list-container" class="space-y-2 max-h-64 overflow-y-auto pr-2"></div>
        <button onclick="document.getElementById('cat-modal').close()" class="btn btn-ghost w-full mt-4 border border-gray-200">Fechar</button>
    </dialog>

    <script>
        // --- CORE ---
        const DB = {
            key: 'sys_v3_pro_db',
            load: () => {
                const def = {cliente:[], produto:[], venda:[], entrada:[], categorias: []};
                let data = JSON.parse(localStorage.getItem(DB.key) || 'null');
                if(!data) return def;
                for(let k in def) if(!data[k]) data[k] = def[k];
                return data;
            },
            saveAll: (d) => localStorage.setItem(DB.key, JSON.stringify(d)),
            save: (type, obj) => {
                const db = DB.load();
                if(obj.id) {
                    const idx = db[type].findIndex(x => x.id === obj.id);
                    if(idx > -1) db[type][idx] = obj; else db[type].push(obj);
                } else {
                    obj.id = Date.now().toString() + Math.random().toString().slice(2,5);
                    if(type==='produto' && !obj.codigo) obj.codigo = DB.nextCode('P');
                    if(type==='cliente' && !obj.codigo) obj.codigo = DB.nextCode('C');
                    if(type==='venda') obj.codigo = DB.nextCode('V');
                    db[type].push(obj);
                }
                DB.saveAll(db);
            },
            delete: (t, id) => { const db = DB.load(); db[t] = db[t].filter(x => x.id !== id); DB.saveAll(db); },
            nextCode: (prefix) => {
                const db = DB.load();
                const list = prefix === 'P' ? db.produto : (prefix === 'C' ? db.cliente : db.venda);
                let max = 0;
                list.forEach(i => {
                    const num = parseInt(i.codigo?.replace(/\D/g,'') || 0);
                    if(num > max) max = num;
                });
                return `${prefix}${String(max + 1).padStart(3, '0')}`;
            }
        };

        // --- IMPORT ENGINE ---
        const ImportEngine = {
            stagedData: [],
            processFile: () => {
                const file = document.getElementById('json-import-file').files[0];
                if(!file) return alert('Selecione um arquivo .json');
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const items = JSON.parse(e.target.result);
                        if(!Array.isArray(items)) throw new Error('JSON deve ser uma lista []');
                        
                        const db = DB.load();
                        ImportEngine.stagedData = items.map((item, idx) => {
                            const eanUnit = (item.EAN_Unidade && item.EAN_Unidade !== "PREENCHER_COM_LEITOR") ? item.EAN_Unidade : "";
                            const eanBox = (item.EAN_Caixa && item.EAN_Caixa !== "PREENCHER_COM_LEITOR") ? item.EAN_Caixa : "";
                            const validEan = eanUnit || eanBox || (item.cEAN !== "PREENCHER_COM_LEITOR" ? item.cEAN : "");

                            let match = db.produto.find(p => p.nome.toUpperCase() === item.xProd.toUpperCase());
                            if(!match && validEan) match = db.produto.find(p => p.ean === validEan);

                            let qty = Number(item.Quantidade_Total_Unidades);
                            const factor = Number(item.Fator_Conversao_Entrada) || Number(item.Fator_Conversao) || 1;
                            if(!qty) qty = (Number(item.Quantidade_NFe)||0) * factor;

                            let cost = Number(item.Custo_Unitario) || 0;
                            const costBox = Number(item.Custo_Real_Caixa) || 0;
                            if(qty > 0 && costBox > 0) cost = (costBox - (Number(item.Valor_Desconto_Total)||0)) / qty;
                            if(cost < 0) cost = 0;

                            return {
                                _id: idx,
                                json: item,
                                eanFinal: validEan,
                                eanUnit: eanUnit,
                                eanBox: eanBox,
                                qty: qty,
                                cost: cost,
                                match: match
                            };
                        });
                        
                        ImportEngine.renderPreview();
                        document.getElementById('import-modal').showModal();
                    } catch(err) { alert('Erro: ' + err.message); }
                };
                reader.readAsText(file);
            },
            renderPreview: () => {
                const tbody = document.getElementById('import-preview-list');
                tbody.innerHTML = ImportEngine.stagedData.map(d => {
                    const status = d.match ? 
                        `<span class="badge badge-purple">Atualizar: ${d.match.codigo}</span>` : 
                        `<span class="badge badge-blue">Novo</span>`;
                    
                    const eanDisplay = `
                        <div class="flex flex-col gap-1">
                            ${d.eanUnit ? `<span class="text-[10px] text-gray-500 font-mono">UN: <b class="text-gray-700">${d.eanUnit}</b></span>` : ''}
                            ${d.eanBox ? `<span class="text-[10px] text-gray-500 font-mono">CX: <b class="text-gray-700">${d.eanBox}</b></span>` : ''}
                            ${(!d.eanUnit && !d.eanBox) ? '<span class="text-[10px] text-gray-400 italic">--</span>' : ''}
                        </div>
                    `;

                    return `
                        <tr>
                            <td class="text-center"><input type="checkbox" class="import-chk cursor-pointer" value="${d._id}" checked></td>
                            <td>
                                <div class="font-bold text-gray-700 text-xs">${d.json.xProd}</div>
                            </td>
                            <td>${eanDisplay}</td>
                            <td><div class="text-xs">${status}</div><div class="text-[10px] text-gray-400 truncate w-32">${d.match ? d.match.nome : ''}</div></td>
                            <td class="text-right font-bold text-xs text-gray-700">${d.qty}</td>
                        </tr>
                    `;
                }).join('');
            },
            toggleAll: (v) => document.querySelectorAll('.import-chk').forEach(c => c.checked = v),
            confirmImport: () => {
                const dest = document.querySelector('input[name="import-dest"]:checked').value;
                const sel = Array.from(document.querySelectorAll('.import-chk:checked')).map(c => Number(c.value));
                if(!sel.length) return alert('Nada selecionado');

                const db = DB.load();
                let count = 0;

                sel.forEach(idx => {
                    const d = ImportEngine.stagedData.find(x => x._id === idx);
                    let prod = d.match ? db.produto.find(p => p.id === d.match.id) : null;

                    if(prod) {
                        if(dest !== 'fiscal') prod.estoque += d.qty;
                        if(dest !== 'fisico') prod.estoqueFiscal = (prod.estoqueFiscal||0) + d.qty;
                        if(d.cost > 0) prod.custo = d.cost;
                        if(d.eanFinal) prod.ean = d.eanFinal; // Update EAN
                        if(d.json.NCM) prod.ncm = d.json.NCM;
                        prod.nota = d.json.Numero_Nota;
                    } else {
                        prod = {
                            id: Date.now().toString() + Math.random().toString().slice(2,5),
                            codigo: DB.nextCode('P'),
                            nome: d.json.xProd.toUpperCase(),
                            ean: d.eanFinal,
                            custo: d.cost,
                            valor: 0,
                            estoque: dest !== 'fiscal' ? d.qty : 0,
                            estoqueFiscal: dest !== 'fisico' ? d.qty : 0,
                            ncm: d.json.NCM,
                            tipo: 'normal',
                            nota: d.json.Numero_Nota
                        };
                        db.produto.push(prod);
                    }
                    db.entrada.push({
                        id: Date.now().toString() + Math.random(),
                        date: Date.now(),
                        prodId: prod.id,
                        qty: d.qty,
                        custo: d.cost,
                        dest: dest,
                        fornecedor: `Imp. Nota ${d.json.Numero_Nota || 'JSON'}`
                    });
                    count++;
                });

                DB.saveAll(db);
                alert(`${count} itens processados.`);
                document.getElementById('import-modal').close();
                Views.catalogo.render();
            }
        };

        // --- VIEWS ---
        const Views = {
            cliente: {
                render: (data = null) => {
                    const list = data || DB.load().cliente;
                    document.getElementById('count-cliente').innerText = list.length;
                    document.getElementById('table-cliente').innerHTML = list.map(c => `
                        <tr>
                            <td><div class="font-bold text-xs text-gray-700">${c.codigo}</div><div class="text-[11px] text-gray-500">${c.nome}</div></td>
                            <td><span class="badge badge-blue">${c.rota || '-'}</span><div class="text-[10px] text-gray-400 mt-1">${c.cidade}</div></td>
                            <td class="text-right">
                                <button onclick="App.edit('cliente', '${c.id}')" class="btn btn-ghost p-1.5"><i class="fa-solid fa-pen text-blue-500"></i></button>
                                <button onclick="App.delete('cliente', '${c.id}')" class="btn btn-ghost p-1.5"><i class="fa-solid fa-trash text-red-400"></i></button>
                            </td>
                        </tr>
                    `).join('');
                },
                filter: (val) => {
                    const list = DB.load().cliente.filter(c => c.nome.toLowerCase().includes(val.toLowerCase()) || c.codigo.toLowerCase().includes(val.toLowerCase()));
                    Views.cliente.render(list);
                }
            },
            catalogo: {
                render: (data = null) => {
                    const list = data || DB.load().produto;
                    document.getElementById('count-produto').innerText = list.length;
                    document.getElementById('table-produto').innerHTML = list.map(p => {
                        const estStyle = p.estoque <= 0 ? 'text-red-500' : 'text-gray-700';
                        return `
                        <tr>
                            <td>
                                <div class="font-bold text-xs text-gray-800">${p.codigo} - ${p.nome}</div>
                                <div class="text-[10px] text-gray-400 font-mono mt-0.5">${p.ean || ''}</div>
                            </td>
                            <td class="text-center font-bold text-xs ${estStyle}">${p.estoque}</td>
                            <td class="text-center"><span class="badge badge-purple">${p.estoqueFiscal||0}</span></td>
                            <td>
                                <div class="font-bold text-xs text-blue-600">R$ ${Number(p.valor).toFixed(2)}</div>
                                <div class="text-[10px] text-gray-400">C: R$ ${Number(p.custo).toFixed(2)}</div>
                            </td>
                            <td class="text-right">
                                <button onclick="App.edit('produto', '${p.id}')" class="btn btn-ghost p-1.5"><i class="fa-solid fa-pen text-blue-500"></i></button>
                                <button onclick="App.delete('produto', '${p.id}')" class="btn btn-ghost p-1.5"><i class="fa-solid fa-trash text-red-400"></i></button>
                            </td>
                        </tr>`;
                    }).join('');
                },
                filter: (val) => {
                    const list = DB.load().produto.filter(p => p.nome.toLowerCase().includes(val.toLowerCase()) || p.codigo.toLowerCase().includes(val.toLowerCase()) || (p.ean && p.ean.includes(val)));
                    Views.catalogo.render(list);
                }
            },
            logistica: {
                render: () => {
                    const db = DB.load();
                    const list = db.entrada.sort((a,b) => b.date - a.date).slice(0, 100);
                    document.getElementById('count-entrada').innerText = list.length;
                    document.getElementById('table-entrada').innerHTML = list.map(i => {
                        const prod = db.produto.find(p => p.id === i.prodId);
                        const qtyClass = i.qty < 0 ? 'text-red-500' : 'text-emerald-600';
                        return `
                        <tr>
                            <td class="text-[11px] text-gray-500">${new Date(i.date).toLocaleDateString()}</td>
                            <td class="font-bold text-xs text-gray-700">${prod ? prod.nome : '???'}</td>
                            <td><span class="badge badge-gray">${i.dest}</span></td>
                            <td class="text-[11px] text-gray-500">${i.fornecedor || '-'}</td>
                            <td class="text-right font-bold text-xs ${qtyClass}">${i.qty > 0 ? '+' : ''}${i.qty}</td>
                        </tr>`;
                    }).join('');
                }
            },
            venda: {
                render: () => {
                    const list = DB.load().venda;
                    document.getElementById('table-venda').innerHTML = list.map(v => `
                        <tr>
                            <td class="font-bold text-xs">#${v.codigo}</td>
                            <td class="text-xs">Cli ID: ${v.cliId}</td>
                            <td>
                                <div class="font-bold text-xs text-emerald-600">R$ ${v.total.toFixed(2)}</div>
                                <div class="text-[10px] text-gray-400">${v.pag} - ${v.rota}</div>
                            </td>
                            <td class="text-right"><button onclick="App.delete('venda','${v.id}')" class="btn btn-ghost text-red-400"><i class="fa-solid fa-times"></i></button></td>
                        </tr>
                    `).join('');
                }
            },
            expedicao: { render: () => {} }
        };

        const App = {
            handleSave: (type, e) => {
                e.preventDefault();
                const form = document.getElementById(`form-${type}`);
                const data = {};
                Array.from(form.elements).forEach(el => {
                    if(el.id) {
                        const key = el.id.split('-')[1];
                        if(key) data[key] = el.type === 'checkbox' ? el.checked : el.value;
                    }
                });
                if(type === 'produto') {
                    data.custo = Number(data.custo);
                    data.valor = Number(data.valor);
                    data.estoque = Number(data.estoque);
                    data.estoqueFiscal = Number(data.estoqueFiscal);
                }
                
                DB.save(type, data);
                form.reset();
                if(type === 'produto') {
                    document.getElementById('p-id').value = '';
                    Views.catalogo.render();
                } else if(type === 'cliente') {
                    document.getElementById('c-id').value = '';
                    Views.cliente.render();
                }
            },
            edit: (type, id) => {
                const item = DB.load()[type].find(x => x.id === id);
                if(!item) return;
                for(let k in item) {
                    const el = document.getElementById(`${type.charAt(0)}-${k}`);
                    if(el) el.value = item[k];
                }
                document.getElementById(`${type.charAt(0)}-id`).value = item.id;
            },
            delete: (type, id) => {
                if(confirm('Confirmar exclusão?')) {
                    DB.delete(type, id);
                    Views[type].render();
                }
            }
        };

        const UI = {
            switchView: (view, btn) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                document.getElementById(`view-${view}`).classList.add('active');
                btn.classList.add('active');
                document.getElementById('page-title').innerText = view === 'logistica' ? 'Logística & Estoque' : view.charAt(0).toUpperCase() + view.slice(1);
                
                if(view === 'catalogo') Views.catalogo.render();
                if(view === 'cliente') Views.cliente.render();
                if(view === 'logistica') {
                    const sel = document.getElementById('e-produto');
                    sel.innerHTML = '<option value="">Sel...</option>' + DB.load().produto.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                    Views.logistica.render();
                }
                if(view === 'venda') Views.venda.render();
            },
            filter: (t, v) => Views[t].filter(v),
            resetForm: (t) => {
                document.getElementById(`form-${t}`).reset();
                document.getElementById(`${t.charAt(0)}-id`).value = '';
            },
            toggleStockInputs: () => {
                const type = document.querySelector('input[name="p-stock-type"]:checked').value;
                document.getElementById('grp-fisico').style.display = type === 'fiscal' ? 'none' : 'block';
                document.getElementById('grp-fiscal').style.display = type === 'fisico' ? 'none' : 'block';
            }
        };

        const CategoryApp = {
            openModal: () => document.getElementById('cat-modal').showModal(),
            addCategory: (e) => {
                e.preventDefault();
                const name = document.getElementById('new-cat-name').value;
                if(name) {
                    const db = DB.load();
                    db.categorias.push({id: Date.now(), nome: name, subs: []});
                    DB.saveAll(db);
                    CategoryApp.renderList();
                    document.getElementById('new-cat-name').value = '';
                }
            },
            renderList: () => {
                const list = document.getElementById('cat-list-container');
                list.innerHTML = DB.load().categorias.map(c => `<div class="p-2 border rounded text-xs font-bold text-gray-700 bg-gray-50 mb-1">${c.nome}</div>`).join('');
            }
        };

        window.onload = () => {
            UI.switchView('cliente', document.querySelector('.nav-item.active'));
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString().slice(0,5), 1000);
        };
    </script>
</body>
</html>
