<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SISTEMA V3 | Professional Dashboard</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root{--primary:#2563eb;--primary-hover:#1d4ed8;--success:#10b981;--success-hover:#059669;--danger:#ef4444;--danger-hover:#dc2626;--warning:#f97316;--warning-hover:#ea580c;--slate-50:#f8fafc;--slate-100:#f1f5f9;--slate-200:#e2e8f0;--slate-300:#cbd5e1;--slate-400:#94a3b8;--slate-500:#64748b;--slate-600:#475569;--slate-700:#334155;--slate-800:#1e293b;--slate-900:#0f172a;--white:#ffffff;--header-height:64px;--sidebar-width:260px;--radius:8px;--shadow:0 1px 3px 0 rgba(0,0,0,0.1),0 1px 2px 0 rgba(0,0,0,0.06)}
*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Inter',sans-serif;background-color:var(--slate-100);color:var(--slate-900);height:100vh;display:flex;overflow:hidden;font-size:13px}
.app-wrapper{display:flex;width:100%;height:100%}aside{width:var(--sidebar-width);background-color:var(--slate-900);color:var(--slate-300);display:flex;flex-direction:column;flex-shrink:0;z-index:50;box-shadow:4px 0 24px rgba(0,0,0,0.1)}
.sidebar-header{height:var(--header-height);display:flex;align-items:center;padding:0 1.5rem;border-bottom:1px solid var(--slate-800);background-color:#020617}
.sidebar-menu{flex:1;overflow-y:auto;padding:1rem .75rem;display:flex;flex-direction:column;gap:.25rem}
.nav-item{display:flex;align-items:center;gap:.75rem;padding:.75rem 1rem;border-radius:var(--radius);color:var(--slate-400);text-decoration:none;font-weight:500;transition:all .2s;background:0 0;border:none;cursor:pointer;width:100%;text-align:left;font-family:inherit;font-size:.9rem}
.nav-item:hover{background-color:var(--slate-800);color:var(--white)}.nav-item.active{background-color:var(--primary);color:var(--white);box-shadow:0 4px 12px rgba(37,99,235,.3)}.nav-item i{width:20px;text-align:center}
main{flex:1;display:flex;flex-direction:column;min-width:0;position:relative}
header.top-bar{height:var(--header-height);background-color:var(--white);border-bottom:1px solid var(--slate-200);display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;flex-shrink:0;z-index:40}
.content-area{flex:1;overflow:hidden;position:relative;background-color:#f8fafc}
.view-section{display:none;height:100%;padding:1.5rem;flex-direction:column}.view-section.active{display:flex}
.split-view{display:flex;gap:1.5rem;height:100%;align-items:flex-start}.panel-left{width:360px;flex-shrink:0;display:flex;flex-direction:column;max-height:100%;gap:1rem}.panel-right{flex:1;min-width:0;display:flex;flex-direction:column;height:100%;gap:1rem}
.card{background:var(--white);border:1px solid var(--slate-200);border-radius:var(--radius);box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}.card.full-h{height:100%}
.card-header{padding:.75rem 1rem;background-color:var(--slate-50);border-bottom:1px solid var(--slate-100);display:flex;justify-content:space-between;align-items:center;font-size:.75rem;font-weight:700;text-transform:uppercase;color:var(--slate-500);letter-spacing:.05em}
.card-body{padding:1rem;overflow-y:auto;flex:1}form{display:flex;flex-direction:column;gap:1rem}
.form-group{display:flex;flex-direction:column;gap:.35rem}label{font-size:.7rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;letter-spacing:.02em}
input,select,textarea{width:100%;padding:.6rem .75rem;border:1px solid var(--slate-300);border-radius:6px;font-family:inherit;font-size:.85rem;color:var(--slate-700);background-color:var(--white);outline:none;transition:border-color .2s,box-shadow .2s}
input:focus,select:focus,textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}input[readonly]{background-color:var(--slate-50);color:var(--slate-500);border-color:var(--slate-200)}
.row-2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}.row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:.75rem}.row-sidebar{display:grid;grid-template-columns:1fr 2fr;gap:.75rem}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;padding:.6rem 1rem;border-radius:6px;font-weight:600;font-size:.8rem;text-transform:uppercase;letter-spacing:.025em;cursor:pointer;border:none;transition:all .2s;text-decoration:none}
.btn-primary{background-color:var(--primary);color:#fff}.btn-primary:hover{background-color:var(--primary-hover)}.btn-primary:disabled{background-color:var(--slate-300);cursor:not-allowed;opacity:.7}
.btn-success{background-color:var(--success);color:#fff}.btn-success:hover{background-color:var(--success-hover)}
.btn-danger{background-color:var(--danger);color:#fff}.btn-danger:hover{background-color:var(--danger-hover)}
.btn-warning{background-color:var(--warning);color:#fff}.btn-warning:hover{background-color:var(--warning-hover)}
.btn-ghost{background-color:transparent;color:var(--slate-400);padding:.25rem .5rem}.btn-ghost:hover{background-color:var(--slate-100);color:var(--slate-600)}.btn-block{width:100%}
.table-wrapper{flex:1;overflow:auto;position:relative}table{width:100%;border-collapse:collapse;text-align:left}
thead th{position:sticky;top:0;z-index:10;background-color:var(--slate-50);color:var(--slate-500);font-size:.7rem;font-weight:700;text-transform:uppercase;padding:.75rem 1rem;border-bottom:1px solid var(--slate-200);box-shadow:0 1px 2px rgba(0,0,0,0.02)}
tbody td{padding:.75rem 1rem;border-bottom:1px solid var(--slate-100);color:var(--slate-700);vertical-align:middle;font-size:.85rem}tbody tr:hover{background-color:var(--slate-50)}
.badge{display:inline-flex;align-items:center;padding:2px 6px;border-radius:4px;font-size:.65rem;font-weight:700;text-transform:uppercase;border:1px solid transparent}
.badge-blue{background-color:#eff6ff;color:var(--primary);border-color:#dbeafe}.badge-purple{background-color:#f5f3ff;color:#7c3aed;border-color:#ede9fe}
.badge-gray{background-color:var(--slate-100);color:var(--slate-500);border-color:var(--slate-200)}.badge-orange{background-color:#fff7ed;color:var(--warning);border-color:#ffedd5}
.badge-red{background-color:#fef2f2;color:var(--danger);border-color:#fee2e2}
.font-mono{font-family:'Courier New',Courier,monospace;letter-spacing:-.02em}.text-right{text-align:right}.text-center{text-align:center}.text-bold{font-weight:700}.text-success{color:var(--success)}.text-danger{color:var(--danger)}.text-slate-400{color:var(--slate-400)}.text-xs{font-size:.75rem}
dialog{margin:auto;padding:0;border:none;border-radius:12px;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);max-width:90vw;width:900px;background:var(--white);animation:fadeIn .2s ease-out}
dialog::backdrop{background:rgba(15,23,42,.5);backdrop-filter:blur(2px)}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:0 0}::-webkit-scrollbar-thumb{background:var(--slate-300);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:var(--slate-400)}
.search-bar{position:relative}.search-bar i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--slate-400);font-size:.8rem}.search-bar input{padding-left:2rem}
.dashboard-stats{display:flex;gap:1rem;align-items:center}.stat-box{background:var(--slate-50);padding:.25rem .75rem;border-radius:6px;border:1px solid var(--slate-200);font-size:.75rem;color:var(--slate-500);font-weight:600}.stat-box b{color:var(--slate-800);font-size:.9rem;margin-left:4px}
details summary{cursor:pointer;list-style:none;padding:.5rem;background:var(--slate-50);border-radius:4px;font-size:.75rem;font-weight:700;color:var(--slate-500);display:flex;justify-content:space-between;align-items:center}
details summary:hover{background:var(--slate-100)}details[open] summary{border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:1px solid var(--slate-200)}
details .details-content{padding:1rem;border:1px solid var(--slate-100);border-top:none;border-bottom-left-radius:4px;border-bottom-right-radius:4px;background:var(--white)}
.bulk-area{font-family:monospace;font-size:.8rem;border:1px dashed var(--slate-300);background:var(--slate-50);min-height:100px}
.item-list{max-height:150px;overflow-y:auto;border:1px solid var(--slate-200);border-radius:6px;padding:.5rem}
.item-row{display:flex;justify-content:space-between;align-items:center;padding:.25rem;border-bottom:1px solid var(--slate-100);font-size:.8rem}.item-row:last-child{border-bottom:none}
</style>
</head>
<body>
<aside>
<div class="sidebar-header">
<i class="fa-solid fa-cube" style="color:var(--primary);font-size:1.2rem;margin-right:.75rem"></i>
<div><h1 style="color:#fff;font-weight:700;font-size:.9rem;letter-spacing:1px">SISTEMA V3</h1><p style="color:var(--slate-500);font-size:.65rem;text-transform:uppercase;font-weight:600">Standalone Pro</p></div>
</div>
<nav class="sidebar-menu">
<button onclick="UI.switchView('cliente',this)" class="nav-item active"><i class="fa-solid fa-users"></i> Clientes</button>
<button onclick="UI.switchView('catalogo',this)" class="nav-item"><i class="fa-solid fa-box-open"></i> Catálogo</button>
<button onclick="UI.switchView('logistica',this)" class="nav-item"><i class="fa-solid fa-truck-fast"></i> Logística</button>
<button onclick="UI.switchView('venda',this)" class="nav-item"><i class="fa-solid fa-cart-shopping"></i> Vendas</button>
<button onclick="UI.switchView('expedicao',this)" class="nav-item"><i class="fa-solid fa-clipboard-check"></i> Expedição</button>
</nav>
<div style="padding:1rem;border-top:1px solid var(--slate-800)">
<button onclick="ExportEngine.exportAll()" class="btn btn-ghost btn-block" style="color:var(--slate-400);border:1px solid var(--slate-700)"><i class="fa-solid fa-database"></i> Backup Dados</button>
<button onclick="document.getElementById('restore-file').click()" class="btn btn-ghost btn-block" style="color:var(--slate-400);border:1px solid var(--slate-700);margin-top:.5rem"><i class="fa-solid fa-upload"></i> Restaurar Dados</button>
<input type="file" id="restore-file" style="display:none" accept=".json" onchange="ExportEngine.restoreAll(this)">
</div>
</aside>
<main>
<header class="top-bar">
<div style="display:flex;align-items:center;gap:1rem">
<h2 id="page-title" style="font-size:1.1rem;font-weight:700;color:var(--slate-800)">Visão Geral</h2>
<div style="height:20px;width:1px;background:var(--slate-300)"></div>
<div style="display:flex;align-items:center;gap:.5rem;color:var(--slate-500);font-size:.8rem"><i class="fa-regular fa-clock"></i> <span id="clock" class="font-mono">00:00</span></div>
</div>
<div style="display:flex;align-items:center;gap:.75rem">
<div style="text-align:right"><p style="font-weight:700;color:var(--slate-700);font-size:.8rem">Administrador</p><p style="font-size:.65rem;color:var(--slate-400);text-transform:uppercase">Acesso Total</p></div>
<div style="width:32px;height:32px;background:#dbeafe;color:var(--primary);border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;border:1px solid #bfdbfe">AD</div>
</div>
</header>
<div class="content-area">
<div id="view-cliente" class="view-section active">
<div class="split-view">
<div class="panel-left">
<div class="card full-h">
<div class="card-header"><span>Dados do Cliente</span><button onclick="UI.resetForm('cliente')" class="btn-ghost"><i class="fa-solid fa-eraser"></i></button></div>
<div class="card-body">
<form onsubmit="App.handleSave('cliente',event)" id="form-cliente">
<input type="hidden" id="c-id">
<div class="row-sidebar"><div class="form-group"><label>Código</label><input type="text" id="c-codigo" readonly></div><div class="form-group"><label>Rota</label><select id="c-rota"><option value="">Sel...</option><option value="CX">CX</option><option value="VG">VG</option><option value="CBA">CBA</option><option value="CPA">CPA</option></select></div></div>
<div class="form-group"><label>Nome</label><input type="text" id="c-nome" required></div>
<div class="row-2"><div class="form-group"><label>Telefone</label><input type="text" id="c-tel"></div><div class="form-group"><label>Cidade</label><select id="c-cidade"><option>Cuiabá</option><option>Várzea Grande</option></select></div></div>
<div class="form-group"><label>Bairro</label><input type="text" id="c-bairro"></div>
<div class="form-group"><label>Endereço</label><textarea id="c-endereco" rows="2"></textarea></div>
<button class="btn btn-primary btn-block">Salvar Cliente</button>
</form>
<div id="client-history-area" style="margin-top:1.5rem;border-top:1px solid var(--slate-200);padding-top:1rem;display:none">
<div style="font-size:.75rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;margin-bottom:.5rem;display:flex;align-items:center;gap:5px"><i class="fa-solid fa-clock-rotate-left"></i> Histórico de Pedidos</div>
<div id="c-history-list" class="item-list" style="max-height:200px;background:var(--slate-50)"></div>
</div>
</div>
</div>
</div>
<div class="panel-right">
<div class="card full-h">
<div class="card-header">
<div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" oninput="UI.filter('cliente',this.value)" placeholder="Buscar cliente..." style="width:250px"></div>
<div class="stat-box">Total: <b id="count-cliente">0</b></div>
</div>
<div class="table-wrapper"><table><thead><tr><th>Cliente / Código</th><th>Localização</th><th class="text-right">Ações</th></tr></thead><tbody id="table-cliente"></tbody></table></div>
</div>
</div>
</div>
</div>
<div id="view-catalogo" class="view-section">
<div class="split-view">
<div class="panel-left">
<div class="card full-h">
<div class="card-header"><span>Dados do Produto</span><button onclick="UI.resetForm('produto')" class="btn-ghost"><i class="fa-solid fa-eraser"></i></button></div>
<div class="card-body">
<form onsubmit="App.handleSave('produto',event)" id="form-produto">
<input type="hidden" id="p-id">
<div class="row-2"><div class="form-group"><label>Categoria</label><select id="p-categoria"></select></div><div class="form-group"><label>Fornecedor</label><input type="text" id="p-fornecedor"></div></div>
<div class="row-2"><div class="form-group"><label>Código</label><input type="text" id="p-codigo" readonly></div><div class="form-group"><label>EAN (Unid)</label><input type="text" id="p-ean" class="font-mono"></div></div>
<div class="form-group"><label>Nome</label><input type="text" id="p-nome" required oninput="UI.updateImageSlug()"></div>
<div class="form-group"><label>Características</label><textarea id="p-caracteristicas" rows="2"></textarea></div>
<div style="background:var(--slate-50);padding:.75rem;border-radius:6px;border:1px solid var(--slate-200)">
<div style="display:flex;justify-content:space-between;margin-bottom:.5rem">
<label>Estoque (Lotes e Validade)</label>
<div style="display:flex;gap:.5rem;font-size:.7rem">
<label style="display:flex;align-items:center;gap:4px;font-weight:500;cursor:pointer"><input type="radio" name="p-stock-type" value="ambos" checked onchange="UI.toggleStockInputs()" style="width:auto"> Ambos</label>
<label style="display:flex;align-items:center;gap:4px;font-weight:500;cursor:pointer"><input type="radio" name="p-stock-type" value="fisico" onchange="UI.toggleStockInputs()" style="width:auto"> Fís</label>
</div></div>
<div id="grp-fisico">
<div style="display:grid;grid-template-columns:1.5fr 1fr;gap:5px;margin-bottom:3px;color:var(--slate-400);font-size:.65rem;font-weight:700"><span>DATA VALIDADE</span><span>QTD</span></div>
<div style="display:grid;grid-template-columns:1.5fr 1fr;gap:5px;margin-bottom:5px"><input type="date" id="p-batch-date-1" style="font-size:.75rem"><input type="number" id="p-batch-qty-1" placeholder="0" class="text-center" oninput="StockManager.calcTotalDisplay()"></div>
<div style="display:grid;grid-template-columns:1.5fr 1fr;gap:5px;margin-bottom:5px"><input type="date" id="p-batch-date-2" style="font-size:.75rem"><input type="number" id="p-batch-qty-2" placeholder="0" class="text-center" oninput="StockManager.calcTotalDisplay()"></div>
<div style="display:grid;grid-template-columns:1.5fr 1fr;gap:5px;margin-bottom:5px"><input type="date" id="p-batch-date-3" style="font-size:.75rem"><input type="number" id="p-batch-qty-3" placeholder="0" class="text-center" oninput="StockManager.calcTotalDisplay()"></div>
<div style="text-align:right;font-size:.75rem;color:var(--slate-600);border-top:1px dashed var(--slate-300);padding-top:4px;margin-top:4px">Total Físico: <b id="p-total-fisico-display">0</b></div>
</div>
<div class="form-group" id="grp-fiscal" style="margin-top:10px"><label style="color:#a855f7;font-size:.6rem">Fiscal (Sem controle de lote)</label><input type="number" id="p-estoqueFiscal" placeholder="0" class="text-center text-bold" style="color:#7e22ce;border-color:#d8b4fe;background:#f3e8ff"></div>
</div>
<div class="row-3">
<div class="form-group"><label>Custo (R$)</label><input type="number" id="p-custo" step="0.0001" oninput="UI.calcMargin()"></div>
<div class="form-group"><label>Margem (%)</label><input type="text" id="p-margem" readonly style="background-color:var(--slate-100);color:var(--slate-600);font-weight:700;text-align:center" placeholder="0%"></div>
<div class="form-group"><label style="color:var(--primary)">Venda (R$)</label><input type="number" id="p-valor" step="0.01" style="font-weight:700;color:var(--primary);background:#eff6ff;border-color:#bfdbfe" oninput="UI.calcMargin()"></div>
</div>
<div class="row-2" style="background:#fff7ed;border:1px solid #ffedd5;border-radius:6px;padding:10px;margin-top:.75rem">
<div class="form-group"><label style="display:flex;align-items:center;gap:5px;cursor:pointer"><input type="checkbox" id="p-is-offer" onchange="UI.toggleOfferInput()" style="width:auto"> Em Oferta?</label></div>
<div class="form-group" id="offer-price-container" style="display:none"><label style="color:var(--warning)">Valor Oferta (R$)</label><input type="number" id="p-offer-price" step="0.01" style="border-color:var(--warning);color:var(--warning);font-weight:700"></div>
</div>
<div style="margin-top:1rem;display:flex;flex-direction:column;gap:1rem">
<div class="row-2"><div class="form-group"><label>Peso (Kg)</label><input type="number" id="p-peso" step="0.001" placeholder="0.000"></div><div class="form-group"><label>Limite (Qtd)</label><input type="number" id="p-limit" placeholder="0"></div></div>
<div class="form-group"><label>Nome do Arquivo (Automático + Prefixo)</label>
<div style="display:flex;gap:.5rem"><input type="text" id="p-image-slug" oninput="UI.updatePreviewManual()" placeholder="Nome base (ex: arroz-5kg)" style="background-color:var(--white);color:var(--slate-700);font-family:monospace;border:1px solid var(--primary)"><button type="button" onclick="UI.copyImageSlug()" class="btn btn-ghost" title="Copiar Nome"><i class="fa-regular fa-copy"></i></button></div>
<small style="font-size:.65rem;color:var(--slate-400)">Caminho: ../site/img/produtos/<b>[nome]</b>-cesta-basica-cuiaba-varzea-grande.webp</small></div>
<div class="form-group"><label>Foto (Preview)</label>
<div style="width:100%;aspect-ratio:1/1;border:1px solid var(--slate-200);border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:var(--slate-50);position:relative;flex-direction:column"><img id="p-img-preview" src="" onerror="UI.onImgError()" style="width:100%;height:100%;object-fit:cover;display:none"><i id="p-img-icon" class="fa-solid fa-box-open" style="color:var(--slate-300);font-size:3rem"></i><p id="debug-path" style="position:absolute;bottom:0;left:0;width:100%;background:rgba(0,0,0,0.7);color:#fff;font-size:.6rem;padding:2px;text-align:center;font-family:monospace;word-break:break-all"></p></div>
</div></div>
<div style="border-top:1px solid var(--slate-200);padding-top:10px;margin-top:1rem">
<div class="form-group"><label style="display:flex;align-items:center;gap:5px"><input type="checkbox" id="p-is-combo" onchange="UI.toggleComboArea(this.checked)" style="width:auto"> É Combo / Kit?</label></div>
<div class="form-group" style="margin-top:5px"><label style="display:flex;align-items:center;gap:5px;color:var(--warning)"><input type="checkbox" id="p-personalized" style="width:auto"> Produto Personalizado (Não Exportar)</label></div>
<div id="combo-area" style="display:none;background:var(--slate-50);padding:10px;border-radius:6px;margin-top:10px">
<div class="form-group" style="margin-bottom:.5rem"><input type="text" id="p-combo-search" placeholder="Buscar para adicionar..." oninput="ComboApp.filterSelector(this.value)" style="font-size:.8rem;padding:.4rem"></div>
<div style="display:flex;gap:.5rem;margin-bottom:.5rem;align-items:flex-end"><div class="form-group" style="flex:1"><label>Selecionar Produto</label><select id="p-combo-select" style="width:100%"></select></div><div class="form-group" style="width:70px"><label>Qtd</label><input type="number" id="p-combo-qty" value="1" min="1" class="text-center"></div><button type="button" onclick="ComboApp.addFromSelector()" class="btn btn-primary" style="height:36px;margin-bottom:1px"><i class="fa-solid fa-plus"></i></button></div>
<label>Ou colar lista ([Qtd] Nome ou Código)</label><textarea id="p-combo-bulk" class="bulk-area" placeholder="[2] Sabão em Pó OMO&#10;[1] Esponja Assolan"></textarea><button type="button" onclick="ComboApp.processBulk()" class="btn btn-ghost btn-block" style="border:1px dashed var(--slate-300);margin-top:5px">Processar Lista</button><div id="p-combo-list" class="item-list mt-2"></div>
</div></div>
<details style="margin-top:10px;border:1px solid var(--slate-200);border-radius:6px"><summary style="background:var(--slate-50)">VARIAÇÕES / APELIDOS</summary><div class="details-content">
<div class="form-group"><label>Variações de Nome (Separar por |)</label><textarea id="p-variacoesNome" rows="2" placeholder="Nome 1 | Nome 2..."></textarea></div>
<div class="form-group" style="margin-top:.5rem"><label>Variações de EAN (Separar por |)</label><textarea id="p-variacoesEan" rows="2" placeholder="EAN 1 | EAN 2..."></textarea></div>
</div></details>
<details><summary>FISCAL / XML <i class="fa-solid fa-chevron-down"></i></summary><div class="details-content">
<div class="form-group"><div class="row-2"><div class="form-group"><label>NCM</label><input type="text" id="p-ncm"></div><div class="form-group"><label>CEST</label><input type="text" id="p-cest"></div></div></div>
<div class="form-group" style="margin-top:.75rem"><div class="row-2"><div class="form-group"><label>CFOP</label><input type="text" id="p-cfop"></div><div class="form-group"><label>CSOSN</label><input type="text" id="p-csosn"></div></div></div>
<input type="hidden" id="p-subcategoria"><input type="hidden" id="p-nota"><input type="hidden" id="p-refId"><input type="hidden" id="p-fator"><input type="hidden" id="p-unidade">
<div class="form-group" style="margin-top:.75rem"><label>Obs</label><textarea id="p-obs-produto" rows="2"></textarea></div>
</div></details>
<button class="btn btn-success btn-block" style="margin-top:.5rem">Salvar Produto</button>
</form>
</div>
</div>
</div>
<div class="panel-right">
<div class="card full-h">
<div class="card-header" style="flex-direction:column;align-items:stretch;gap:10px">
<div style="display:flex;justify-content:space-between;align-items:center">
<div style="display:flex;gap:.5rem"><div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" id="catalogo-search" oninput="Views.catalogo.filter()" placeholder="Buscar produto..." style="width:250px"></div>
<button onclick="CategoryApp.openModal()" class="btn btn-ghost" style="border:1px solid var(--slate-300);border-radius:6px"><i class="fa-solid fa-tags"></i></button>
<button onclick="ExportEngine.exportProducts()" class="btn btn-ghost" title="Exportar Completo (JSON)" style="border:1px solid var(--slate-300);border-radius:6px;color:var(--success)"><i class="fa-solid fa-file-export"></i></button>
<button onclick="ExportEngine.exportStock()" class="btn btn-ghost" title="Exportar Estoque (JSON)" style="border:1px solid var(--slate-300);border-radius:6px;color:var(--warning)"><i class="fa-solid fa-boxes-stacked"></i></button></div>
<div class="stat-box">Itens: <b id="count-produto">0</b></div></div>
<div style="display:flex;gap:.5rem">
<select id="filter-cat" onchange="Views.catalogo.filter()" style="font-size:.8rem;padding:.4rem"><option value="">Todas Categorias</option></select>
<select id="filter-stock" onchange="Views.catalogo.filter()" style="font-size:.8rem;padding:.4rem"><option value="">Todos Estoques</option><option value="<=0">Estoque Baixo (<= 0)</option><option value="1-10">Entre 1 e 10</option><option value="11-50">Entre 11 e 50</option><option value="51-100">Entre 51 e 100</option><option value=">100">Acima de 100</option></select>
</div></div>
<div class="table-wrapper"><table><thead><tr><th style="width:40%">Produto</th><th class="text-center" style="width:20%">Físico (Lotes)</th><th class="text-center" style="width:10%">Fiscal</th><th style="width:15%">Preço</th><th class="text-right" style="width:15%">Ações</th></tr></thead><tbody id="table-produto"></tbody></table></div>
</div>
</div>
</div>
</div>
<div id="view-logistica" class="view-section">
<div class="split-view">
<div class="panel-left">
<div class="card">
<div class="card-header"><span style="color:var(--primary)">Importação JSON</span></div>
<div class="card-body">
<div style="border:2px dashed var(--slate-300);border-radius:8px;padding:1.5rem;text-align:center;position:relative;background:var(--slate-50);cursor:pointer;transition:background .2s" onmouseover="this.style.background='#e2e8f0'" onmouseout="this.style.background='#f8fafc'">
<i class="fa-solid fa-file-code" style="font-size:1.5rem;color:var(--slate-400);margin-bottom:.5rem"></i><p style="font-size:.7rem;font-weight:700;color:var(--slate-500);text-transform:uppercase">Clique para selecionar</p><input type="file" id="json-import-file" accept=".json" style="position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;cursor:pointer">
</div>
<button onclick="ImportEngine.processFile()" class="btn btn-primary btn-block" style="margin-top:1rem">Processar Arquivo</button>
</div></div>
<div class="card" style="flex:1">
<div class="card-header"><span style="color:var(--warning)">Movimento Manual</span></div>
<div class="card-body">
<form onsubmit="App.handleSave('entrada',event)" id="form-entrada-manual">
<div class="form-group"><label>Produto</label><select id="e-produto" required></select></div>
<div class="form-group"><label>Destino</label><select id="e-tipo-estoque"><option value="fisico">Físico</option><option value="fiscal">Fiscal</option><option value="ambos">Ambos</option></select></div>
<div class="row-2"><div class="form-group"><label>Qtd (+/-)</label><input type="number" id="e-qty" required class="text-bold"></div><div class="form-group"><label>Custo</label><input type="number" id="e-custo" step="0.01"></div></div>
<button class="btn btn-warning btn-block" style="background-color:var(--warning);color:#fff;margin-top:.5rem">Registrar</button>
</form>
</div></div>
</div>
<div class="panel-right">
<div class="card full-h">
<div class="card-header"><span>Histórico</span><div class="stat-box">Regs: <b id="count-entrada">0</b></div></div>
<div class="table-wrapper"><table><thead><tr><th>Data</th><th>Produto</th><th>Tipo</th><th>Origem</th><th class="text-right">Qtd</th></tr></thead><tbody id="table-entrada"></tbody></table></div>
</div>
</div>
</div>
</div>
<div id="view-venda" class="view-section">
<div class="split-view">
<div class="panel-left">
<div class="card full-h">
<div class="card-header"><span style="color:var(--success)">Novo Pedido</span></div>
<div class="card-body">
<form id="form-venda" onsubmit="Cart.confirmSale(event)">
<input type="hidden" id="v-id">
<div class="form-group"><label>Cliente</label><select id="v-cliente" required></select></div>
<div style="background:var(--slate-50);padding:.75rem;border:1px solid var(--slate-200);border-radius:6px">
<div style="display:flex;gap:.5rem;margin-bottom:.5rem"><div style="flex:1" class="form-group"><label>Buscar Produto</label><input type="text" id="v-prod-search" oninput="UI.searchProduct(this.value)" placeholder="Nome ou Código..."></div></div>
<div style="display:flex;gap:.5rem"><select id="v-produto" style="flex:1"></select><input type="number" id="v-qty" value="1" min="1" style="width:60px;text-align:center;font-weight:700"><button type="button" onclick="Cart.add()" class="btn btn-primary"><i class="fa-solid fa-plus"></i></button></div>
<div style="margin-top:10px"><label style="cursor:pointer;font-size:.65rem" onclick="document.getElementById('bulk-venda-area').style.display = document.getElementById('bulk-venda-area').style.display === 'none' ? 'block' : 'none'">+ Inserir em Lote ([Qtd] Nome ou Código)</label><div id="bulk-venda-area" style="display:none;margin-top:5px"><textarea id="v-bulk-list" class="bulk-area" placeholder="[2] Sabão em Pó OMO&#10;[1] Esponja Assolan"></textarea><button type="button" onclick="Cart.processBulk()" class="btn btn-ghost btn-block" style="border:1px dashed var(--slate-300);margin-top:5px">Adicionar Lista</button></div></div>
</div>
<div id="v-cart-list" class="item-list" style="flex:1;min-height:150px"><div style="text-align:center;color:var(--slate-400);padding:1rem;font-size:.8rem">Carrinho vazio</div></div>
<div class="row-2"><div class="form-group"><label>Pagamento</label><select id="v-pagamento"><option>Dinheiro</option><option>Pix</option><option>Cartão</option></select></div><div class="form-group"><label>Rota</label><select id="v-rota"><option>CX</option><option>VG</option><option>CBA</option></select></div></div>
<div class="form-group"><label>Desconto (R$)</label><input type="number" id="v-desconto" step="0.01" oninput="Cart.calcTotal()"></div>
<div style="background:var(--slate-800);color:#fff;padding:1rem;border-radius:6px;display:flex;justify-content:space-between;align-items:center;margin-top:.5rem"><span style="font-size:.7rem;font-weight:700;text-transform:uppercase;color:var(--slate-400)">Total</span><span id="v-total" style="font-size:1.2rem;font-weight:700">R$ 0,00</span></div>
<button type="submit" class="btn btn-success btn-block">Finalizar Pedido</button>
</form>
</div></div>
</div>
<div class="panel-right">
<div class="card full-h">
<div class="card-header">
<div style="display:flex;gap:.5rem;align-items:center"><div class="search-bar"><i class="fa-solid fa-magnifying-glass"></i><input type="text" id="v-search-input" oninput="UI.filter('venda',this.value)" placeholder="Buscar pedido..." style="width:150px"></div><button onclick="Views.venda.render()" class="btn btn-ghost" style="border:1px solid var(--slate-200)">Limpar</button></div>
<div class="stat-box">Pedidos: <b id="count-venda">0</b></div>
</div>
<div class="table-wrapper"><table><thead><tr><th>Pedido</th><th>Cliente</th><th>Cidade</th><th>Bairro</th><th>Rota</th><th class="text-right">Ações</th></tr></thead><tbody id="table-venda"></tbody></table></div>
</div>
</div>
</div>
</div>
<div id="view-expedicao" class="view-section">
<div style="display:grid;grid-template-columns:repeat(4,1fr);height:100%;gap:1px;background:var(--slate-300);border:1px solid var(--slate-300);border-radius:8px;overflow:hidden">
<div style="background:var(--slate-50);display:flex;flex-direction:column"><div style="background:var(--primary);color:#fff;font-weight:700;padding:.75rem;text-align:center;text-transform:uppercase;display:flex;justify-content:center;align-items:center;gap:10px">CX <button onclick="ExportEngine.exportRoute('CX')" class="btn btn-ghost" style="color:#fff;padding:2px 6px;border:1px solid rgba(255,255,255,0.3)"><i class="fa-solid fa-download"></i></button></div><div id="col-CX" style="flex:1;padding:.75rem;overflow-y:auto;display:flex;flex-direction:column;gap:.5rem"></div></div>
<div style="background:var(--slate-50);display:flex;flex-direction:column"><div style="background:var(--success);color:#fff;font-weight:700;padding:.75rem;text-align:center;text-transform:uppercase;display:flex;justify-content:center;align-items:center;gap:10px">VG <button onclick="ExportEngine.exportRoute('VG')" class="btn btn-ghost" style="color:#fff;padding:2px 6px;border:1px solid rgba(255,255,255,0.3)"><i class="fa-solid fa-download"></i></button></div><div id="col-VG" style="flex:1;padding:.75rem;overflow-y:auto;display:flex;flex-direction:column;gap:.5rem"></div></div>
<div style="background:var(--slate-50);display:flex;flex-direction:column"><div style="background:var(--warning);color:#fff;font-weight:700;padding:.75rem;text-align:center;text-transform:uppercase;display:flex;justify-content:center;align-items:center;gap:10px">CBA <button onclick="ExportEngine.exportRoute('CBA')" class="btn btn-ghost" style="color:#fff;padding:2px 6px;border:1px solid rgba(255,255,255,0.3)"><i class="fa-solid fa-download"></i></button></div><div id="col-CBA" style="flex:1;padding:.75rem;overflow-y:auto;display:flex;flex-direction:column;gap:.5rem"></div></div>
<div style="background:var(--slate-50);display:flex;flex-direction:column"><div style="background:#7c3aed;color:#fff;font-weight:700;padding:.75rem;text-align:center;text-transform:uppercase;display:flex;justify-content:center;align-items:center;gap:10px">CPA <button onclick="ExportEngine.exportRoute('CPA')" class="btn btn-ghost" style="color:#fff;padding:2px 6px;border:1px solid rgba(255,255,255,0.3)"><i class="fa-solid fa-download"></i></button></div><div id="col-CPA" style="flex:1;padding:.75rem;overflow-y:auto;display:flex;flex-direction:column;gap:.5rem"></div></div>
</div>
</div>
</div>
</main>
<dialog id="sale-confirm-modal" style="width:400px"><div style="padding:1.5rem"><h3 style="font-weight:700;font-size:1.1rem;color:var(--slate-800);margin-bottom:1rem">Baixar de qual estoque?</h3>
<form onsubmit="Cart.finalize(event)">
<div style="display:flex;gap:1rem;margin-bottom:1.5rem;justify-content:center">
<label style="display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:.75rem;border:1px solid var(--slate-300);border-radius:6px;width:100%;justify-content:center"><input type="radio" name="sale-stock-type" value="fisico" checked> Físico</label>
<label style="display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:.75rem;border:1px solid var(--slate-300);border-radius:6px;width:100%;justify-content:center"><input type="radio" name="sale-stock-type" value="fiscal"> Fiscal</label>
</div>
<div style="display:flex;gap:.5rem"><button type="button" onclick="document.getElementById('sale-confirm-modal').close()" class="btn btn-ghost btn-block" style="border:1px solid var(--slate-300)">Cancelar</button><button type="submit" class="btn btn-success btn-block">Confirmar Venda</button></div>
</form></div></dialog>
<dialog id="import-modal">
<div class="card-header" style="background:var(--slate-800);color:#fff;border-bottom:none"><div style="display:flex;align-items:center;gap:.5rem"><i class="fa-solid fa-file-import"></i> <span>Conferência de Importação</span></div><button onclick="document.getElementById('import-modal').close()" style="background:0 0;border:none;color:var(--slate-400);cursor:pointer;font-size:1.1rem"><i class="fa-solid fa-times"></i></button></div>
<div style="padding:1.5rem">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;gap:1rem">
<div style="background:var(--slate-50);padding:.5rem 1rem;border-radius:var(--radius);border:1px solid var(--slate-200);display:flex;gap:1.5rem;align-items:center;flex:1"><span style="font-weight:700;font-size:.7rem;color:var(--slate-500);text-transform:uppercase">Destino:</span><label style="display:flex;align-items:center;gap:4px;font-size:.8rem;cursor:pointer"><input type="radio" name="import-dest" value="fisico"> Físico</label><label style="display:flex;align-items:center;gap:4px;font-size:.8rem;cursor:pointer"><input type="radio" name="import-dest" value="fiscal"> Fiscal</label><label style="display:flex;align-items:center;gap:4px;font-size:.8rem;cursor:pointer;font-weight:700;color:var(--primary)"><input type="radio" name="import-dest" value="ambos" checked> Ambos</label></div>
<div class="search-bar" style="width:250px"><i class="fa-solid fa-magnifying-glass"></i><input type="text" id="import-filter" oninput="ImportEngine.filterPreview(this.value)" placeholder="Filtrar..." style="width:100%"></div>
</div>
<div style="margin-bottom:1rem;display:flex;justify-content:flex-end"><button onclick="ImportEngine.openBatchLinkModal()" class="btn btn-warning" id="btn-batch-link" disabled style="opacity:.5;font-size:.75rem"><i class="fa-solid fa-link"></i> Vincular Selecionados</button></div>
<div style="border:1px solid var(--slate-200);border-radius:var(--radius);overflow:hidden;max-height:50vh;overflow-y:auto"><table style="width:100%;border-collapse:collapse"><thead><tr style="background:var(--slate-50);border-bottom:1px solid var(--slate-200)"><th style="padding:.75rem;text-align:center;width:40px"><input type="checkbox" checked onchange="ImportEngine.toggleAll(this.checked)"></th><th style="padding:.75rem;font-size:.7rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;text-align:left">Produto (JSON)</th><th style="padding:.75rem;font-size:.7rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;text-align:left;width:200px">EANs (Unid / CX)</th><th style="padding:.75rem;font-size:.7rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;text-align:left;width:150px">Status Sistema</th><th style="padding:.75rem;font-size:.7rem;font-weight:700;color:var(--slate-500);text-transform:uppercase;text-align:right;width:80px">Qtd</th></tr></thead><tbody id="import-preview-list"></tbody></table></div>
<div style="margin-top:1.5rem;display:flex;justify-content:flex-end;gap:.75rem;padding-top:1rem;border-top:1px solid var(--slate-100)"><button onclick="document.getElementById('import-modal').close()" class="btn btn-ghost" style="border:1px solid var(--slate-200)">Cancelar</button><button onclick="ImportEngine.confirmImport()" class="btn btn-success">Confirmar e Salvar</button></div>
</div></dialog>
<dialog id="product-select-modal" style="width:500px">
<div style="padding:1.5rem"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem"><h3 style="font-weight:700;color:var(--slate-700);font-size:.9rem;text-transform:uppercase">Vincular Produto Existente</h3><button onclick="document.getElementById('product-select-modal').close()" style="background:0 0;border:none;cursor:pointer;color:var(--slate-400)"><i class="fa-solid fa-times"></i></button></div>
<div class="search-bar" style="margin-bottom:1rem"><i class="fa-solid fa-magnifying-glass"></i><input type="text" id="product-link-search" oninput="ImportEngine.searchLinkProduct(this.value)" placeholder="Buscar produto no sistema..." style="width:100%"></div>
<div id="product-link-list" style="border:1px solid var(--slate-200);border-radius:6px;max-height:300px;overflow-y:auto"></div>
</div></dialog>
<dialog id="cat-modal" style="width:500px;max-height:85vh;padding:0;border:none;border-radius:12px;box-shadow:0 25px 50px -12px rgba(0,0,0,.25)">
<div style="display:flex;flex-direction:column;height:100%;max-height:85vh;background:var(--white)">
<div style="padding:1.5rem 1.5rem .5rem 1.5rem;flex-shrink:0;display:flex;justify-content:space-between;align-items:center"><h3 style="font-weight:700;color:var(--slate-700);font-size:.9rem;text-transform:uppercase">Gestão de Categorias</h3><button onclick="document.getElementById('cat-modal').close()" style="background:0 0;border:none;cursor:pointer;color:var(--slate-400)"><i class="fa-solid fa-times"></i></button></div>
<div style="padding:0 1.5rem 1rem 1.5rem;flex-shrink:0;border-bottom:1px solid var(--slate-100)"><form onsubmit="CategoryApp.addRoot(event)" style="display:flex;flex-direction:row;gap:.5rem"><input type="text" id="new-cat-root-name" placeholder="Nova Categoria Principal..." style="flex:1" required><button class="btn btn-primary">ADD</button></form></div>
<div id="cat-list-container" style="flex:1;overflow-y:auto;padding:1.5rem;display:flex;flex-direction:column;gap:.5rem"></div>
</div></dialog>
<script>
const DB={key:'sys_v3_standalone_db',load:()=>{const def={cliente:[],produto:[],venda:[],entrada:[],categorias:[]};let data=JSON.parse(localStorage.getItem(DB.key)||'null');if(!data)return def;for(let k in def)if(!data[k])data[k]=def[k];if(data.categorias){data.categorias.forEach(c=>{if(!c.subs)c.subs=[]})}return data},saveAll:(d)=>localStorage.setItem(DB.key,JSON.stringify(d)),save:(type,obj)=>{const db=DB.load();if(obj.id){const idx=db[type].findIndex(x=>x.id===obj.id);if(idx>-1)db[type][idx]=obj;else db[type].push(obj)}else{obj.id=Date.now().toString()+Math.random().toString().slice(2,5);if(type==='produto'&&!obj.codigo)obj.codigo=DB.nextCode('P');if(type==='cliente'&&!obj.codigo)obj.codigo=DB.nextCode('C');if(type==='venda')obj.codigo=DB.nextCode('V');db[type].push(obj)}DB.saveAll(db)},delete:(t,id)=>{const db=DB.load();db[t]=db[t].filter(x=>x.id!==id);DB.saveAll(db)},nextCode:(prefix)=>{const db=DB.load();const list=prefix==='P'?db.produto:(prefix==='C'?db.cliente:db.venda);let max=0;list.forEach(i=>{const num=parseInt(i.codigo?.replace(/\D/g,'')||0);if(num>max)max=num});return`${prefix}${String(max+1).padStart(3,'0')}`}};
const StockManager={calcTotalDisplay:()=>{let total=0;for(let i=1;i<=3;i++){const qty=Number(document.getElementById(`p-batch-qty-${i}`).value)||0;total+=qty}document.getElementById('p-total-fisico-display').innerText=total},deduct:(prod,qtyToDeduct)=>{if(!prod.batches||prod.batches.length===0){prod.estoque=(prod.estoque||0)-qtyToDeduct;return}prod.batches.sort((a,b)=>{if(!a.date)return 1;if(!b.date)return-1;return new Date(a.date)-new Date(b.date)});let remaining=qtyToDeduct;for(let i=0;i<prod.batches.length;i++){if(remaining<=0)break;let batch=prod.batches[i];if(batch.qty>=remaining){batch.qty-=remaining;remaining=0}else{remaining-=batch.qty;batch.qty=0}}prod.batches=prod.batches.filter(b=>b.qty>0);prod.estoque=prod.batches.reduce((acc,b)=>acc+b.qty,0)}};
const Printer={printOrder:(id)=>{const db=DB.load();const v=db.venda.find(x=>x.id===id);if(!v)return;const cli=db.cliente.find(c=>c.id===v.cliId)||{};const win=window.open('','','width=300,height=600');win.document.write(`<html><head><style>@page{margin:0}body{font-family:'Courier New',monospace;width:75mm;margin:0;padding:10px;font-size:12px}.line{border-bottom:1px dashed #000;margin:5px 0}.text-center{text-align:center}.text-right{text-align:right}.bold{font-weight:bold}.row{display:flex;justify-content:space-between}.sub-item{font-size:10px;color:#555;margin-left:10px}</style></head><body><div class="text-center bold">SISTEMA V3</div><div class="text-center">Pedido: ${v.codigo}</div><div class="line"></div><div>Cliente: ${cli.nome||'Consumidor'}</div><div>Cidade: ${cli.cidade||''} - ${cli.bairro||''}</div><div>Rota: ${v.rota}</div><div class="line"></div>`);v.items.forEach(i=>{win.document.write(`<div>${i.qty}x ${i.nome}</div><div class="text-right">R$ ${(i.price*i.qty).toFixed(2)}</div>`);const prod=db.produto.find(p=>p.id===i.id);if(prod&&prod.items&&prod.items.length>0){prod.items.forEach(sub=>{const subTotalQty=sub.qty*i.qty;win.document.write(`<div class="sub-item">↳ ${subTotalQty}x ${sub.nome}</div>`)})}});win.document.write(`<div class="line"></div><div class="row bold"><span>TOTAL</span><span>R$ ${v.total.toFixed(2)}</span></div><div class="text-center" style="margin-top:20px;">${new Date(v.date).toLocaleString()}</div>`);win.document.write('</body></html>');win.document.close();win.print()}};
const ExportEngine={exportAll:()=>{const data=DB.load();const blob=new Blob([JSON.stringify(data)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`backup_sistema_v3_${Date.now()}.json`;a.click()},exportProducts:()=>{const data=DB.load().produto.filter(p=>!p.personalized&&p.estoque>0).map(p=>{let imgName=p.codigo.toLowerCase();if(p.nome){imgName=p.nome.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+/,'').replace(/-+$/,'')}let validade=undefined;if(p.batches&&p.batches.length>0){const datedBatches=p.batches.filter(b=>b.date);if(datedBatches.length>0){datedBatches.sort((a,b)=>new Date(a.date)-new Date(b.date));validade=datedBatches[0].date}}const obj={...p,imageName:undefined,caracteristicas:p.caracteristicas||'',imagem:`../site/img/produtos/${imgName}-cesta-basica-cuiaba-varzea-grande.webp`,Limit:p.limit||0,Oferta:p.isOffer?'Sim':'Não',Valor_Oferta:p.isOffer?Number(p.offerPrice||0):0};if(validade){obj.validade=validade}return obj});const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`produtos_completo_${Date.now()}.json`;a.click()},exportStock:()=>{const list=DB.load().produto.map(p=>({codigo:p.codigo,estoque:p.estoque}));const blob=new Blob([JSON.stringify(list,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`estoque_simples_${Date.now()}.json`;a.click()},restoreAll:(input)=>{const file=input.files[0];if(!file)return;if(!confirm("ATENÇÃO: Isso irá substituir todos os dados atuais pelos do backup. Deseja continuar?")){input.value='';return}const reader=new FileReader();reader.onload=(e)=>{try{const data=JSON.parse(e.target.result);if(data.cliente&&data.produto&&Array.isArray(data.cliente)){localStorage.setItem(DB.key,JSON.stringify(data));alert("Dados restaurados com sucesso! A página será recarregada.");location.reload()}else{alert("Arquivo de backup inválido.")}}catch(err){alert("Erro ao ler arquivo: "+err.message)}};reader.readAsText(file)},exportRoute:(route)=>{const db=DB.load();const sales=db.venda.filter(v=>v.rota===route);const exportData=sales.map(sale=>{const client=db.cliente.find(c=>c.id===sale.cliId);const enrichedItems=sale.items.map(item=>{const prod=db.produto.find(p=>p.id===item.id);return{...item,isCombo:!!(prod&&prod.items&&prod.items.length>0),comboContents:(prod&&prod.items&&prod.items.length>0)?prod.items:[]}});return{pedido:sale,cliente:client||{nome:'Cliente Removido'},itensDetalhados:enrichedItems}});const blob=new Blob([JSON.stringify(exportData,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`rota_${route}_${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a)}};
const ImportEngine={stagedData:[],processFile:()=>{const file=document.getElementById('json-import-file').files[0];if(!file)return alert('Selecione um arquivo .json');const reader=new FileReader();reader.onload=(e)=>{try{const items=JSON.parse(e.target.result);if(!Array.isArray(items))throw new Error('JSON deve ser uma lista []');const db=DB.load();const groupedItems={};items.forEach((item,idx)=>{let eans=[];if(item.cEAN&&item.cEAN!=="PREENCHER_COM_LEITOR"){eans=item.cEAN.split('|').map(s=>s.trim()).filter(Boolean)}if(item.EAN_Unidade&&item.EAN_Unidade!=="PREENCHER_COM_LEITOR")eans.push(item.EAN_Unidade);if(item.EAN_Caixa&&item.EAN_Caixa!=="PREENCHER_COM_LEITOR")eans.push(item.EAN_Caixa);eans=[...new Set(eans)];let names=[];if(item.xProd){names=item.xProd.split('|').map(s=>s.trim()).filter(Boolean)}const key=eans.length>0?eans[0]:(names.length>0?names[0].toUpperCase():'UNKNOWN');if(!groupedItems[key]){groupedItems[key]={items:[],totalQty:0,firstItem:item,allEans:eans,allNames:names}}else{groupedItems[key].allEans=[...new Set([...groupedItems[key].allEans,...eans])];groupedItems[key].allNames=[...new Set([...groupedItems[key].allNames,...names])]}let qty=Number(item.Quantidade_Total_Unidades);const factor=Number(item.Fator_Conversao_Entrada)||Number(item.Fator_Conversao)||1;if(!qty)qty=(Number(item.Quantidade_NFe)||0)*factor;groupedItems[key].totalQty+=qty;groupedItems[key].items.push(item)});ImportEngine.stagedData=Object.keys(groupedItems).map((key,idx)=>{const group=groupedItems[key];const item=group.firstItem;let match=null;if(group.allEans.length>0){match=db.produto.find(p=>{const pEans=[p.ean,...(p.variacoesEan||[])].filter(Boolean);return group.allEans.some(newEan=>pEans.includes(newEan))})}if(!match&&group.allNames.length>0){match=db.produto.find(p=>{const pNames=[p.nome,...(p.variacoesNome||[])].map(n=>n.toUpperCase());return group.allNames.some(newName=>pNames.includes(newName.toUpperCase()))})}let cost=Number(item.Custo_Unitario)||0;if(cost<0)cost=0;return{_id:idx,json:item,allEans:group.allEans,allNames:group.allNames,qty:group.totalQty,cost:cost,match:match}}).sort((a,b)=>a.json.xProd.localeCompare(b.json.xProd));ImportEngine.renderPreview();document.getElementById('import-modal').showModal()}catch(err){alert('Erro: '+err.message)}};reader.readAsText(file)},filterPreview:(val)=>{const term=val.toLowerCase();const filteredData=ImportEngine.stagedData.filter(d=>d.allNames.some(n=>n.toLowerCase().includes(term))||d.allEans.some(e=>e.includes(term)));ImportEngine.renderPreview(filteredData)},renderPreview:(data=null)=>{const listToRender=data||ImportEngine.stagedData;const tbody=document.getElementById('import-preview-list');tbody.innerHTML=listToRender.map((d)=>{const status=d.match?`<span class="badge badge-purple">Atualizar: ${d.match.codigo}</span>`:`<span class="badge badge-blue">Novo</span>`;const eanDisplay=d.allEans.length>0?`<div style="display:flex; flex-direction:column; gap:2px;">${d.allEans.map(e=>`<span style="font-size:0.65rem; font-family:monospace; color:var(--slate-600);">${e}</span>`).join('')}</div>`:'<span style="font-size: 0.65rem; color: var(--slate-400); font-style: italic;">--</span>';return`<tr style="border-bottom: 1px solid var(--slate-100);"><td style="padding: 0.75rem; text-align: center;"><input type="checkbox" class="import-chk" value="${d._id}" checked onchange="ImportEngine.updateBatchBtn()"></td><td style="padding: 0.75rem;"><div style="font-weight: 700; color: var(--slate-700); font-size: 0.8rem;">${d.allNames[0]||'Sem Nome'}</div>${d.allNames.length>1?`<div style="font-size:0.65rem; color:var(--slate-400);">+ ${d.allNames.length-1} variações</div>`:''}</td><td style="padding: 0.75rem;">${eanDisplay}</td><td style="padding: 0.75rem;"><div style="margin-bottom: 2px;">${status}</div><div style="font-size: 0.65rem; color: var(--slate-400); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px;">${d.match?d.match.nome:''}</div></td><td style="padding: 0.75rem; text-align: right; font-weight: 700; color: var(--slate-700);">${d.qty}</td></tr>`}).join('');ImportEngine.updateBatchBtn()},toggleAll:(v)=>{document.querySelectorAll('.import-chk').forEach(c=>c.checked=v);ImportEngine.updateBatchBtn()},updateBatchBtn:()=>{const checked=Array.from(document.querySelectorAll('.import-chk:checked'));const btn=document.getElementById('btn-batch-link');if(checked.length>0){btn.disabled=false;btn.style.opacity=1}else{btn.disabled=true;btn.style.opacity=0.5}},openBatchLinkModal:()=>{const checked=Array.from(document.querySelectorAll('.import-chk:checked'));if(checked.length===0)return;document.getElementById('product-link-search').value='';ImportEngine.searchLinkProduct('');document.getElementById('product-select-modal').showModal()},searchLinkProduct:(val)=>{const db=DB.load();const term=val.toLowerCase();const filtered=db.produto.filter(p=>p.nome.toLowerCase().includes(term)||p.codigo.toLowerCase().includes(term));const container=document.getElementById('product-link-list');container.innerHTML=filtered.map(p=>`<div style="padding: 0.75rem; border-bottom: 1px solid var(--slate-100); cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onclick="ImportEngine.applyBatchLink('${p.id}')" onmouseover="this.style.background='var(--slate-50)'" onmouseout="this.style.background='transparent'"><div><div style="font-weight: 700; font-size: 0.8rem; color: var(--slate-700);">${p.nome}</div><div style="font-size: 0.7rem; color: var(--slate-400);">${p.codigo} | EAN: ${p.ean||'-'}</div></div><button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.65rem;">Selecionar</button></div>`).join('');if(filtered.length===0)container.innerHTML='<div style="padding: 1rem; text-align: center; color: var(--slate-400);">Nenhum produto encontrado</div>'},applyBatchLink:(prodId)=>{const db=DB.load();const prod=db.produto.find(p=>p.id===prodId);const checked=Array.from(document.querySelectorAll('.import-chk:checked')).map(c=>Number(c.value));if(prod&&checked.length>0){checked.forEach(idx=>{const item=ImportEngine.stagedData.find(d=>d._id===idx);if(item){item.match=prod}});ImportEngine.renderPreview();document.getElementById('product-select-modal').close()}},confirmImport:()=>{const dest=document.querySelector('input[name="import-dest"]:checked').value;const checkboxes=Array.from(document.querySelectorAll('.import-chk:checked'));if(checkboxes.length===0)return alert('Nada selecionado');const selectedIds=new Set(checkboxes.map(c=>Number(c.value)));const db=DB.load();let count=0;ImportEngine.stagedData.forEach(d=>{if(!selectedIds.has(d._id))return;let prod=d.match?db.produto.find(p=>p.id===d.match.id):null;if(!prod&&d.allEans.length>0){prod=db.produto.find(p=>{const pEans=[p.ean,...(p.variacoesEan||[])].filter(Boolean);return d.allEans.some(newEan=>pEans.includes(newEan))})}if(!prod&&d.allNames.length>0){prod=db.produto.find(p=>{const pNames=[p.nome,...(p.variacoesNome||[])].map(n=>n.toUpperCase());return d.allNames.some(newName=>pNames.includes(newName.toUpperCase()))})}const jsonItem=d.json;if(prod){if(dest!=='fiscal'){if(!prod.batches)prod.batches=[];let defaultBatch=prod.batches.find(b=>!b.date);if(defaultBatch){defaultBatch.qty+=d.qty}else{prod.batches.push({date:'',qty:d.qty})}prod.estoque=prod.batches.reduce((acc,b)=>acc+b.qty,0)}if(dest!=='fisico')prod.estoqueFiscal=(prod.estoqueFiscal||0)+d.qty;if(d.cost>0)prod.custo=d.cost;const cleanNewEans=d.allEans.map(e=>e.trim()).filter(Boolean);const existingEans=[prod.ean,...(prod.variacoesEan||[])].filter(Boolean);const newEansList=[...new Set([...existingEans,...cleanNewEans])];if(newEansList.length>0){if(!prod.ean)prod.ean=newEansList[0];prod.variacoesEan=newEansList}const cleanNewNames=d.allNames.map(n=>n.trim()).filter(Boolean);const existingNames=[prod.nome,...(prod.variacoesNome||[])].filter(Boolean);const newNamesList=[...new Set([...existingNames,...cleanNewNames])];if(newNamesList.length>0)prod.variacoesNome=newNamesList;if(jsonItem.NCM)prod.ncm=jsonItem.NCM;if(jsonItem.CEST)prod.cest=jsonItem.CEST;if(jsonItem.CFOP_SAIDA)prod.cfop=jsonItem.CFOP_SAIDA;if(jsonItem.CSOSN_SAIDA)prod.csosn=jsonItem.CSOSN_SAIDA;if(jsonItem.Unidade_Venda)prod.unidade=jsonItem.Unidade_Venda;prod.jsonData=jsonItem;prod.nota=jsonItem.Numero_Nota}else{const cleanEans=d.allEans.map(e=>e.trim()).filter(Boolean);const cleanNames=d.allNames.map(n=>n.trim()).filter(Boolean);prod={id:Date.now().toString()+Math.random().toString().slice(2,5),codigo:DB.nextCode('P'),nome:cleanNames[0]||jsonItem.xProd.toUpperCase(),variacoesNome:cleanNames,ean:cleanEans[0]||'',variacoesEan:cleanEans,custo:d.cost,valor:0,batches:dest!=='fiscal'?[{date:'',qty:d.qty}]:[],estoque:dest!=='fiscal'?d.qty:0,estoqueFiscal:dest!=='fisico'?d.qty:0,tipo:'normal',nota:jsonItem.Numero_Nota,ncm:jsonItem.NCM,cest:jsonItem.CEST,cfop:jsonItem.CFOP_SAIDA,csosn:jsonItem.CSOSN_SAIDA,unidade:jsonItem.Unidade_Venda,fator:jsonItem.Fator_Conversao||jsonItem.Fator_Conversao_Entrada,refId:jsonItem.id_referencia,jsonData:jsonItem};db.produto.push(prod)}db.entrada.push({id:Date.now().toString()+Math.random(),date:Date.now(),prodId:prod.id,qty:d.qty,custo:d.cost,dest:dest,fornecedor:`Imp. Nota ${jsonItem.Numero_Nota||'JSON'}`});count++});DB.saveAll(db);alert(`${count} itens processados. Verifique as validades no cadastro.`);document.getElementById('import-modal').close();document.getElementById('import-filter').value='';Views.catalogo.render()}};
const ComboApp={comboItems:[],processBulk:()=>{const text=document.getElementById('p-combo-bulk').value;if(!text)return;const lines=text.split('\n');const db=DB.load();lines.forEach(line=>{const match=line.match(/^\[(\d+)\]\s*(.*)$/);let qty=1;let identifier=line.trim();if(match){qty=parseInt(match[1],10);identifier=match[2].trim()}else{const parts=line.split('|').map(s=>s.trim());identifier=parts[0];if(parts[1])qty=parseInt(parts[1],10)||1}if(!identifier)return;const idUpper=identifier.toUpperCase();const prod=db.produto.find(p=>{const pEans=[p.ean,...(p.variacoesEan||[])].filter(Boolean);const pNames=[p.nome,...(p.variacoesNome||[])].map(n=>n.toUpperCase());return p.codigo.toUpperCase()===idUpper||pEans.includes(identifier)||pNames.includes(idUpper)});if(prod){ComboApp.comboItems.push({id:prod.id,codigo:prod.codigo,nome:prod.nome,qty:qty})}});ComboApp.renderList();document.getElementById('p-combo-bulk').value=''},addFromSelector:()=>{const prodId=document.getElementById('p-combo-select').value;const qty=Number(document.getElementById('p-combo-qty').value);if(!prodId||qty<=0)return;const db=DB.load();const prod=db.produto.find(p=>p.id===prodId);if(prod){ComboApp.comboItems.push({id:prod.id,codigo:prod.codigo,nome:prod.nome,qty:qty});ComboApp.renderList()}},populateSelect:(filterText='')=>{const db=DB.load();const select=document.getElementById('p-combo-select');let items=db.produto.filter(p=>p.estoque>0).sort((a,b)=>a.nome.localeCompare(b.nome));if(filterText){const t=filterText.toLowerCase();items=items.filter(p=>p.nome.toLowerCase().includes(t)||p.codigo.toLowerCase().includes(t))}select.innerHTML='<option value="">Selecione...</option>'+items.map(p=>`<option value="${p.id}">${p.codigo} - ${p.nome} (Q: ${p.estoque})</option>`).join('')},filterSelector:(val)=>{ComboApp.populateSelect(val)},renderList:()=>{const el=document.getElementById('p-combo-list');el.innerHTML=ComboApp.comboItems.map((i,idx)=>`<div class="item-row"><span><b>${i.codigo}</b> ${i.nome}</span><span>x${i.qty} <button type="button" onclick="ComboApp.remove(${idx})" style="color:red; margin-left:5px;">&times;</button></span></div>`).join('')},remove:(idx)=>{ComboApp.comboItems.splice(idx,1);ComboApp.renderList()}};
const Cart={items:[],add:()=>{const prodId=document.getElementById('v-produto').value;const qty=Number(document.getElementById('v-qty').value);if(!prodId||qty<=0)return;const db=DB.load();const prod=db.produto.find(p=>p.id===prodId);if(prod){Cart.items.push({id:prod.id,codigo:prod.codigo,nome:prod.nome,qty:qty,price:prod.valor});Cart.render();Cart.calcTotal()}},processBulk:()=>{const text=document.getElementById('v-bulk-list').value;if(!text)return;const db=DB.load();const lines=text.split('\n');lines.forEach(line=>{const match=line.match(/^\[(\d+)\]\s*(.*)$/);let qty=1;let identifier=line.trim();if(match){qty=parseInt(match[1],10);identifier=match[2].trim()}else{const parts=line.split('|').map(s=>s.trim());identifier=parts[0];if(parts[1])qty=parseInt(parts[1],10)||1}if(!identifier)return;const idUpper=identifier.toUpperCase();const prod=db.produto.find(p=>{const pEans=[p.ean,...(p.variacoesEan||[])].filter(Boolean);const pNames=[p.nome,...(p.variacoesNome||[])].map(n=>n.toUpperCase());return p.codigo.toUpperCase()===idUpper||pEans.includes(identifier)||pNames.includes(idUpper)});if(prod)Cart.items.push({id:prod.id,codigo:prod.codigo,nome:prod.nome,qty:qty,price:prod.valor})});Cart.render();Cart.calcTotal();document.getElementById('v-bulk-list').value=''},render:()=>{const el=document.getElementById('v-cart-list');if(Cart.items.length===0){el.innerHTML='<div style="text-align: center; color: var(--slate-400); padding: 1rem; font-size: 0.8rem;">Carrinho vazio</div>';return}el.innerHTML=Cart.items.map((i,idx)=>`<div class="item-row"><span>${i.nome}</span><span>${i.qty} x ${i.price.toFixed(2)} <button type="button" onclick="Cart.remove(${idx})" style="color:red;">&times;</button></span></div>`).join('')},remove:(idx)=>{Cart.items.splice(idx,1);Cart.render();Cart.calcTotal()},calcTotal:()=>{const sub=Cart.items.reduce((acc,i)=>acc+(i.qty*i.price),0);const desc=Number(document.getElementById('v-desconto').value)||0;document.getElementById('v-total').innerText=`R$ ${(sub-desc).toFixed(2)}`},confirmSale:(e)=>{e.preventDefault();if(Cart.items.length===0)return alert('Carrinho vazio!');document.getElementById('sale-confirm-modal').showModal()},finalize:(e)=>{e.preventDefault();const stockType=document.querySelector('input[name="sale-stock-type"]:checked').value;const db=DB.load();const cliId=document.getElementById('v-cliente').value;const pag=document.getElementById('v-pagamento').value;const rota=document.getElementById('v-rota').value;const desc=Number(document.getElementById('v-desconto').value)||0;const total=Cart.items.reduce((acc,i)=>acc+(i.qty*i.price),0)-desc;const venda={id:Date.now().toString(),codigo:DB.nextCode('V'),cliId:cliId,pag:pag,rota:rota,desc:desc,total:total,date:Date.now(),items:Cart.items};Cart.items.forEach(cartItem=>{const prod=db.produto.find(p=>p.id===cartItem.id);if(prod){if(stockType==='fisico'){StockManager.deduct(prod,cartItem.qty)}else{prod.estoqueFiscal=(prod.estoqueFiscal||0)-cartItem.qty}if(prod.items&&prod.items.length>0){prod.items.forEach(childItem=>{const childProd=db.produto.find(cp=>cp.id===childItem.id);if(childProd){const totalChildQty=childItem.qty*cartItem.qty;if(stockType==='fisico'){StockManager.deduct(childProd,totalChildQty)}else{childProd.estoqueFiscal=(childProd.estoqueFiscal||0)-totalChildQty}}})}}});db.venda.push(venda);DB.saveAll(db);alert('Venda Finalizada!');document.getElementById('sale-confirm-modal').close();Cart.items=[];Cart.render();document.getElementById('form-venda').reset();document.getElementById('v-total').innerText='R$ 0,00';Views.venda.render()}};
const Views={cliente:{render:(data=null)=>{const list=data||DB.load().cliente;document.getElementById('count-cliente').innerText=list.length;document.getElementById('table-cliente').innerHTML=list.map(c=>`<tr><td><div style="font-weight: 700; color: var(--slate-700);">${c.codigo}</div><div style="font-size: 0.75rem; color: var(--slate-500);">${c.nome}</div></td><td><span class="badge badge-blue" style="margin-bottom: 2px;">${c.rota||'-'}</span><div style="font-size: 0.7rem; color: var(--slate-400);">${c.cidade}</div></td><td class="text-right"><button onclick="App.edit('cliente', '${c.id}')" class="btn btn-ghost" style="color: var(--primary);"><i class="fa-solid fa-pen"></i></button><button onclick="App.delete('cliente', '${c.id}')" class="btn btn-ghost" style="color: var(--danger);"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('')},filter:(val)=>{const list=DB.load().cliente.filter(c=>c.nome.toLowerCase().includes(val.toLowerCase())||c.codigo.toLowerCase().includes(val.toLowerCase()));Views.cliente.render(list)}},catalogo:{render:(data=null)=>{const list=data||DB.load().produto;document.getElementById('count-produto').innerText=list.length;document.getElementById('table-produto').innerHTML=list.map(p=>{const estStyle=p.estoque<=0?'color: var(--danger);':'color: var(--slate-700);';const isCombo=p.items&&p.items.length>0?'<span class="badge badge-blue">COMBO</span>':'';const hasVar=(p.variacoesEan&&p.variacoesEan.length>1)||(p.variacoesNome&&p.variacoesNome.length>1);const varBadge=hasVar?'<i class="fa-solid fa-layer-group" title="Possui variações cadastradas" style="color:var(--slate-400); font-size:0.7rem; margin-left:4px;"></i>':'';const personBadge=p.personalized?'<i class="fa-solid fa-star" title="Personalizado" style="color:var(--warning); font-size:0.7rem; margin-left:4px;"></i>':'';const offerBadge=p.isOffer?'<span class="badge badge-orange">OFERTA</span>':'';let batchDisplay=`<div style="font-weight:700; ${estStyle}">${p.estoque} <span style="font-size:0.6rem; color:var(--slate-400);">total</span></div>`;if(p.batches&&p.batches.length>0){const sorted=[...p.batches].sort((a,b)=>{if(!a.date)return 1;if(!b.date)return-1;return new Date(a.date)-new Date(b.date)});batchDisplay+=`<div style="margin-top:2px;">`;sorted.forEach(b=>{let d=b.date?new Date(b.date).toLocaleDateString():'S/ Val';let isExpired=b.date&&new Date(b.date)<new Date();let color=isExpired?'color:var(--danger);':'color:var(--slate-500);';batchDisplay+=`<div style="font-size:0.65rem; ${color}"><i class="fa-regular fa-calendar" style="margin-right:2px;"></i> ${d}: <b>${b.qty}</b></div>`});batchDisplay+=`</div>`}return`<tr><td><div style="font-weight: 700; color: var(--slate-800);">${p.codigo} - ${p.nome} ${isCombo} ${offerBadge} ${varBadge} ${personBadge}</div><div style="font-size: 0.7rem; color: var(--slate-400); font-family: monospace; margin-top: 2px;">${p.ean||'<span style="font-style: italic; color: var(--slate-300);">Sem EAN</span>'}</div></td><td style="text-align: center; vertical-align: top;">${batchDisplay}</td><td style="text-align: center;"><span class="badge badge-purple">${p.estoqueFiscal||0}</span></td><td><div style="font-weight: 700; color: var(--primary);">R$ ${Number(p.valor).toFixed(2)}</div><div style="font-size: 0.7rem; color: var(--slate-400);">C: R$ ${Number(p.custo).toFixed(2)}</div></td><td class="text-right"><button onclick="App.edit('produto', '${p.id}')" class="btn btn-ghost" style="color: var(--primary);"><i class="fa-solid fa-pen"></i></button><button onclick="App.delete('produto', '${p.id}')" class="btn btn-ghost" style="color: var(--danger);"><i class="fa-solid fa-trash"></i></button></td></tr>`}).join('')},filter:()=>{const text=document.getElementById('catalogo-search').value.toLowerCase();const cat=document.getElementById('filter-cat').value;const stock=document.getElementById('filter-stock').value;const list=DB.load().produto.filter(p=>{const pNames=[p.nome,...(p.variacoesNome||[])].join(' ').toLowerCase();const pEans=[p.ean,...(p.variacoesEan||[])].join(' ');const matchText=pNames.includes(text)||p.codigo.toLowerCase().includes(text)||pEans.includes(text);if(!matchText)return false;if(cat&&p.categoria!==cat)return false;if(stock){const q=p.estoque;if(stock==='<=0'&&q>0)return false;if(stock==='1-10'&&(q<1||q>10))return false;if(stock==='11-50'&&(q<11||q>50))return false;if(stock==='51-100'&&(q<51||q>100))return false;if(stock==='>100'&&q<=100)return false}return true});Views.catalogo.render(list)}},logistica:{render:()=>{const db=DB.load();const list=db.entrada.sort((a,b)=>b.date-a.date).slice(0,100);document.getElementById('count-entrada').innerText=list.length;document.getElementById('table-entrada').innerHTML=list.map(i=>{const prod=db.produto.find(p=>p.id===i.prodId);const qtyClass=i.qty<0?'color: var(--danger);':'color: var(--success);';return`<tr><td style="font-size: 0.75rem; color: var(--slate-500); font-family: monospace;">${new Date(i.date).toLocaleDateString()}</td><td style="font-weight: 700; color: var(--slate-700);">${prod?prod.nome:'???'}</td><td><span class="badge badge-gray">${i.dest}</span></td><td style="font-size: 0.75rem; color: var(--slate-500); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px;" title="${i.fornecedor||'-'}">${i.fornecedor||'-'}</td><td style="text-align: right; font-weight: 700; ${qtyClass}">${i.qty>0?'+':''}${i.qty}</td></tr>`}).join('')}},venda:{render:()=>{const db=DB.load();const list=db.venda.sort((a,b)=>b.date-a.date);document.getElementById('table-venda').innerHTML=list.map(v=>{const cli=db.cliente.find(c=>c.id===v.cliId)||{};return`<tr><td style="font-weight: 700;">#${v.codigo}</td><td>${cli.nome||'-'}</td><td>${cli.cidade||'-'}</td><td>${cli.bairro||'-'}</td><td><span class="badge badge-blue">${v.rota||'-'}</span></td><td class="text-right"><button onclick="Printer.printOrder('${v.id}')" class="btn btn-ghost" style="color: var(--slate-600);" title="Imprimir"><i class="fa-solid fa-print"></i></button><button onclick="App.delete('venda','${v.id}')" class="btn btn-ghost" style="color: var(--danger);"><i class="fa-solid fa-times"></i></button></td></tr>`}).join('')}},expedicao:{render:()=>{const db=DB.load();['CX','VG','CBA','CPA'].forEach(r=>{const pedidos=db.venda.filter(v=>v.rota===r).slice(-8);document.getElementById(`col-${r}`).innerHTML=pedidos.map(p=>{const cli=db.cliente.find(c=>c.id===p.cliId);const itemsText=p.items.map(i=>`${i.qty}x ${i.nome.substring(0,10)}..`).join('<br>');return`<div style="background: white; padding: 0.75rem; border-radius: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.75rem;"><div style="display:flex; justify-content:space-between; margin-bottom:4px;"><b style="color:var(--slate-800);">#${p.codigo}</b><span style="font-weight:bold; color:var(--success);">R$ ${Number(p.total).toFixed(0)}</span></div><div style="color:var(--slate-600); margin-bottom:4px;">${cli?.nome.substring(0,15)}...</div><div style="border-top:1px dashed var(--slate-200); padding-top:4px; font-size:0.65rem; color:var(--slate-500); line-height:1.2;">${itemsText}</div></div>`}).join('')})}}};
const App={handleSave:(type,e)=>{e.preventDefault();const form=document.getElementById(`form-${type}`);let data={};if(type==='produto'){data.id=document.getElementById('p-id').value;if(!data.id){data.id=Date.now().toString()+Math.random().toString().slice(2,5);data.codigo=DB.nextCode('P')}else{data.codigo=document.getElementById('p-codigo').value}data.nome=document.getElementById('p-nome').value;data.ean=document.getElementById('p-ean').value;data.categoria=document.getElementById('p-categoria').value;data.fornecedor=document.getElementById('p-fornecedor').value;data.caracteristicas=document.getElementById('p-caracteristicas').value;data.custo=Number(document.getElementById('p-custo').value)||0;data.valor=Number(document.getElementById('p-valor').value)||0;data.batches=[];for(let i=1;i<=3;i++){const d=document.getElementById(`p-batch-date-${i}`).value;const q=Number(document.getElementById(`p-batch-qty-${i}`).value);if(q>0){data.batches.push({date:d,qty:q})}}data.estoque=data.batches.reduce((acc,b)=>acc+b.qty,0);data.estoqueFiscal=Number(document.getElementById('p-estoqueFiscal').value)||0;data.peso=Number(document.getElementById('p-peso').value)||0;data.limit=Number(document.getElementById('p-limit').value)||0;let prefixo=document.getElementById('p-image-slug').value.trim();if(!prefixo){prefixo=data.nome.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+/,'').replace(/-+$/,'')}data.imageName=prefixo;data.imagem=`../site/img/produtos/${prefixo}-cesta-basica-cuiaba-varzea-grande.webp`;if(document.getElementById('p-is-combo').checked){data.items=ComboApp.comboItems}else{data.items=[]}data.personalized=document.getElementById('p-personalized').checked;data.isOffer=document.getElementById('p-is-offer').checked;data.offerPrice=data.isOffer?(Number(document.getElementById('p-offer-price').value)||0):0;const vNomes=document.getElementById('p-variacoesNome').value;data.variacoesNome=vNomes?vNomes.split('|').map(s=>s.trim()).filter(Boolean):[];const vEans=document.getElementById('p-variacoesEan').value;data.variacoesEan=vEans?vEans.split('|').map(s=>s.trim()).filter(Boolean):[];data.ncm=document.getElementById('p-ncm').value;data.cest=document.getElementById('p-cest').value;data.cfop=document.getElementById('p-cfop').value;data.csosn=document.getElementById('p-csosn').value;data.obs=document.getElementById('p-obs-produto').value;data.subcategoria=document.getElementById('p-subcategoria').value;data.nota=document.getElementById('p-nota').value;data.refId=document.getElementById('p-refId').value;data.fator=document.getElementById('p-fator').value;data.unidade=document.getElementById('p-unidade').value}else{Array.from(form.elements).forEach(el=>{if(el.id){const key=el.id.split('-')[1];if(key)data[key]=el.type==='checkbox'?el.checked:el.value}})}if(type==='produto'||type==='cliente'){const db=DB.load();const conflict=db[type].find(x=>x.codigo===data.codigo&&x.id!==data.id);if(conflict){const prefix=type==='produto'?'P':'C';const next=DB.nextCode(prefix);alert(`Código duplicado detectado! O sistema alterou automaticamente de ${data.codigo} para ${next}.`);data.codigo=next;if(type==='produto')document.getElementById('p-codigo').value=next;else document.getElementById('c-codigo').value=next}}DB.save(type,data);form.reset();if(type==='produto'){document.getElementById('p-id').value='';ComboApp.comboItems=[];ComboApp.renderList();document.getElementById('p-img-preview').src='';document.getElementById('p-img-preview').style.display='none';document.getElementById('p-img-icon').style.display='block';document.getElementById('debug-path').innerText='';document.getElementById('p-margem').value='';document.getElementById('p-is-offer').checked=false;UI.toggleOfferInput();document.getElementById('p-image-slug').value='';document.getElementById('p-total-fisico-display').innerText='0';Views.catalogo.render()}else if(type==='cliente'){document.getElementById('c-id').value='';document.getElementById('client-history-area').style.display='none';Views.cliente.render()}},edit:(type,id)=>{const item=DB.load()[type].find(x=>x.id===id);if(!item)return;for(let k in item){const el=document.getElementById(`${type.charAt(0)}-${k}`);if(k==='obs'&&type==='produto'){document.getElementById('p-obs-produto').value=item[k];continue}if(el){if(el.type==='checkbox')el.checked=item[k];else el.value=item[k]}}document.getElementById(`${type.charAt(0)}-id`).value=item.id;if(type==='produto'){if(item.items&&item.items.length>0){document.getElementById('p-is-combo').checked=true;UI.toggleComboArea(true);ComboApp.comboItems=item.items;ComboApp.renderList()}else{document.getElementById('p-is-combo').checked=false;UI.toggleComboArea(false)}for(let i=1;i<=3;i++){document.getElementById(`p-batch-date-${i}`).value='';document.getElementById(`p-batch-qty-${i}`).value=''}if(item.batches&&item.batches.length>0){const sorted=item.batches.sort((a,b)=>{if(!a.date)return 1;if(!b.date)return-1;return new Date(a.date)-new Date(b.date)});for(let i=0;i<Math.min(sorted.length,3);i++){document.getElementById(`p-batch-date-${i+1}`).value=sorted[i].date;document.getElementById(`p-batch-qty-${i+1}`).value=sorted[i].qty}}else if(item.estoque>0){document.getElementById(`p-batch-qty-1`).value=item.estoque}StockManager.calcTotalDisplay();document.getElementById('p-personalized').checked=!!item.personalized;document.getElementById('p-is-offer').checked=!!item.isOffer;document.getElementById('p-offer-price').value=item.offerPrice||'';UI.toggleOfferInput();if(item.imageName){document.getElementById('p-image-slug').value=item.imageName;UI.updatePreviewManual()}else{document.getElementById('p-image-slug').value='';UI.updateImageSlug()}document.getElementById('p-variacoesNome').value=(item.variacoesNome||[]).join(' | ');document.getElementById('p-variacoesEan').value=(item.variacoesEan||[]).join(' | ');UI.calcMargin()}else if(type==='cliente'){const db=DB.load();const sales=db.venda.filter(v=>v.cliId===item.id).sort((a,b)=>b.date-a.date);const historyArea=document.getElementById('client-history-area');const historyList=document.getElementById('c-history-list');if(sales.length>0){historyArea.style.display='block';historyList.innerHTML=sales.map(s=>`<div class="item-row" style="cursor: pointer;" onclick="UI.goToOrder('${s.codigo}')"><span>${new Date(s.date).toLocaleDateString()}</span><span style="font-weight: 700;">#${s.codigo}</span><span style="color: var(--success);">R$ ${s.total.toFixed(2)}</span></div>`).join('')}else{historyArea.style.display='block';historyList.innerHTML='<div style="padding:0.5rem; text-align:center; color:var(--slate-400);">Nenhuma compra encontrada.</div>'}}},delete:(type,id)=>{if(confirm('Confirmar exclusão?')){DB.delete(type,id);if(type==='cliente')Views.cliente.render();else if(type==='produto')Views.catalogo.render();else if(type==='venda')Views.venda.render()}}};
const UI={switchView:(view,btn)=>{document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));document.getElementById(`view-${view}`).classList.add('active');if(btn)btn.classList.add('active');document.getElementById('page-title').innerText=view==='logistica'?'Logística & Estoque':view.charAt(0).toUpperCase()+view.slice(1);if(view==='catalogo'){Views.catalogo.render();ComboApp.populateSelect();UI.populateCategories()}if(view==='cliente')Views.cliente.render();if(view==='logistica'){const sel=document.getElementById('e-produto');sel.innerHTML='<option value="">Sel...</option>'+DB.load().produto.map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');Views.logistica.render()}if(view==='venda'){const db=DB.load();const cliSel=document.getElementById('v-cliente');cliSel.innerHTML='<option value="">Selecione...</option>'+db.cliente.map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');const prodSel=document.getElementById('v-produto');prodSel.innerHTML='<option value="">Selecione...</option>'+db.produto.map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');Views.venda.render()}if(view==='expedicao')Views.expedicao.render()},filter:(t,v)=>Views[t].filter(v),resetForm:(t)=>{document.getElementById(`form-${t}`).reset();document.getElementById(`${t.charAt(0)}-id`).value='';if(t==='produto'){ComboApp.comboItems=[];ComboApp.renderList();document.getElementById('p-is-combo').checked=false;UI.toggleComboArea(false);document.getElementById('p-img-preview').src='';document.getElementById('p-img-preview').style.display='none';document.getElementById('p-img-icon').style.display='block';document.getElementById('debug-path').innerText='';document.getElementById('p-margem').value='';document.getElementById('p-is-offer').checked=false;UI.toggleOfferInput();document.getElementById('p-image-slug').value='';document.getElementById('p-total-fisico-display').innerText='0'}if(t==='cliente'){document.getElementById('client-history-area').style.display='none'}},toggleStockInputs:()=>{const type=document.querySelector('input[name="p-stock-type"]:checked').value;document.getElementById('grp-fisico').style.display=type==='fiscal'?'none':'block';document.getElementById('grp-fiscal').style.display=type==='fisico'?'none':'block'},toggleOfferInput:()=>{const isOffer=document.getElementById('p-is-offer').checked;document.getElementById('offer-price-container').style.display=isOffer?'block':'none'},updateImageSlug:()=>{if(document.getElementById('p-image-slug').value)return;const name=document.getElementById('p-nome').value;const slug=name.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').replace(/\-\-+/g,'-').replace(/^-+/,'').replace(/-+$/,'');const previewUrl=`../site/img/produtos/${slug}-cesta-basica-cuiaba-varzea-grande.webp`;UI.updatePreviewCommon(previewUrl)},updatePreviewManual:()=>{const slug=document.getElementById('p-image-slug').value;if(!slug){UI.updateImageSlug();return}const previewUrl=`../site/img/produtos/${slug}-cesta-basica-cuiaba-varzea-grande.webp`;UI.updatePreviewCommon(previewUrl)},updatePreviewCommon:(url)=>{const imgEl=document.getElementById('p-img-preview');const iconEl=document.getElementById('p-img-icon');const debugEl=document.getElementById('debug-path');debugEl.innerText=`Tentando: ${url}`;debugEl.style.background="rgba(0,0,0,0.7)";imgEl.src=url;imgEl.onload=()=>{imgEl.style.display='block';iconEl.style.display='none';debugEl.style.background="rgba(16, 185, 129, 0.9)"};imgEl.onerror=()=>{UI.onImgError()}},onImgError:()=>{document.getElementById('p-img-preview').style.display='none';document.getElementById('p-img-icon').style.display='block';const debugEl=document.getElementById('debug-path');debugEl.style.background="rgba(239, 68, 68, 0.9)"},copyImageSlug:()=>{const copyText=document.getElementById("p-image-slug");copyText.select();copyText.setSelectionRange(0,99999);navigator.clipboard.writeText(copyText.value).then(()=>{alert("Nome copiado: "+copyText.value)})},calcMargin:()=>{const cost=parseFloat(document.getElementById('p-custo').value)||0;const sale=parseFloat(document.getElementById('p-valor').value)||0;const marginEl=document.getElementById('p-margem');if(cost>0&&sale>0){const margin=((sale-cost)/cost)*100;marginEl.value=margin.toFixed(2)+'%';marginEl.style.color=margin<0?'var(--danger)':'var(--success)'}else{marginEl.value='0%';marginEl.style.color='var(--slate-500)'}},searchProduct:(val)=>{const db=DB.load();const prodSel=document.getElementById('v-produto');const term=val.toLowerCase();const filtered=db.produto.filter(p=>{const pNames=[p.nome,...(p.variacoesNome||[])].join(' ').toLowerCase();const pEans=[p.ean,...(p.variacoesEan||[])].join(' ');return pNames.includes(term)||p.codigo.toLowerCase().includes(term)||pEans.includes(term)});prodSel.innerHTML='<option value="">Selecione...</option>'+filtered.map(p=>`<option value="${p.id}">${p.nome}</option>`).join('')},toggleComboArea:(checked)=>{document.getElementById('combo-area').style.display=checked?'block':'none';if(checked)ComboApp.populateSelect()},populateCategories:()=>{const db=DB.load();let options='<option value="">Sem Categoria</option>';db.categorias.forEach(c=>{options+=`<option value="${c.nome}">${c.nome}</option>`;if(c.subs&&c.subs.length>0){c.subs.forEach(s=>{options+=`<option value="${c.nome} > ${s.nome}">&nbsp;&nbsp;&nbsp;↳ ${s.nome}</option>`})}});const sel=document.getElementById('p-categoria');if(sel){const current=sel.value;sel.innerHTML=options;sel.value=current}const filterSel=document.getElementById('filter-cat');if(filterSel){const currentFilter=filterSel.value;const filterOptions=options.replace('value="">Sem Categoria','value="">Todas Categorias');filterSel.innerHTML=filterOptions;filterSel.value=currentFilter}},goToOrder:(orderCode)=>{const btnVenda=document.querySelector("button[onclick*='venda']");UI.switchView('venda',btnVenda);const searchInput=document.getElementById('v-search-input');if(searchInput){searchInput.value=orderCode;UI.filter('venda',orderCode)}}};
const CategoryApp={openModal:()=>{CategoryApp.renderList();document.getElementById('cat-modal').showModal()},addRoot:(e)=>{e.preventDefault();const input=document.getElementById('new-cat-root-name');const name=input.value.trim();if(!name)return;const db=DB.load();db.categorias.push({id:Date.now().toString(),nome:name,subs:[]});DB.saveAll(db);input.value='';CategoryApp.renderList();UI.populateCategories()},addSub:(parentId)=>{const name=prompt("Nome da Subcategoria:");if(!name)return;const db=DB.load();const parent=db.categorias.find(c=>c.id===String(parentId));if(parent){if(!parent.subs)parent.subs=[];parent.subs.push({id:Date.now().toString(),nome:name});DB.saveAll(db);CategoryApp.renderList();UI.populateCategories()}},edit:(id,parentId=null)=>{const db=DB.load();let target;if(parentId&&parentId!=='null'){const parent=db.categorias.find(c=>c.id===parentId);if(parent&&parent.subs){target=parent.subs.find(s=>s.id===id)}}else{target=db.categorias.find(c=>c.id===id)}if(target){const newName=prompt("Novo nome:",target.nome);if(newName&&newName.trim()){target.nome=newName.trim();DB.saveAll(db);CategoryApp.renderList();UI.populateCategories()}}},delete:(id,parentId=null)=>{if(!confirm("Tem a certeza que deseja excluir?"))return;const db=DB.load();if(parentId&&parentId!=='null'){const parent=db.categorias.find(c=>c.id===parentId);if(parent&&parent.subs){parent.subs=parent.subs.filter(s=>s.id!==id)}}else{db.categorias=db.categorias.filter(c=>c.id!==id)}DB.saveAll(db);CategoryApp.renderList();UI.populateCategories()},renderList:()=>{const db=DB.load();const container=document.getElementById('cat-list-container');if(db.categorias.length===0){container.innerHTML='<div style="color:#94a3b8; text-align:center; padding:1rem; font-size:0.8rem;">Nenhuma categoria cadastrada.</div>';return}container.innerHTML=db.categorias.map(cat=>{const subsHtml=(cat.subs||[]).map(sub=>`<div style="display:flex; justify-content:space-between; align-items:center; padding: 6px 10px; border-left: 2px solid var(--slate-200); margin-left: 15px; margin-top: 4px; background: #fff; border-radius: 4px;"><span style="font-size:0.75rem; color: var(--slate-600);"><i class="fa-solid fa-turn-up fa-rotate-90" style="margin-right:6px; color:var(--slate-300);"></i> ${sub.nome}</span><div style="display:flex; gap: 5px;"><button onclick="CategoryApp.edit('${sub.id}', '${cat.id}')" class="btn-ghost" style="padding:2px 6px; color:var(--primary); font-size:0.7rem;" title="Editar"><i class="fa-solid fa-pen"></i></button><button onclick="CategoryApp.delete('${sub.id}', '${cat.id}')" class="btn-ghost" style="padding:2px 6px; color:var(--danger); font-size:0.7rem;" title="Excluir"><i class="fa-solid fa-times"></i></button></div></div>`).join('');return`<div style="background: var(--slate-50); border: 1px solid var(--slate-200); border-radius: 6px; margin-bottom: 8px; overflow:hidden; flex-shrink: 0;"><div style="padding: 10px; display: flex; justify-content: space-between; align-items: center; background: #f1f5f9; border-bottom: 1px solid var(--slate-200);"><span style="font-weight: 700; color: var(--slate-800); font-size: 0.85rem;">${cat.nome}</span><div style="display:flex; gap: 5px;"><button onclick="CategoryApp.addSub('${cat.id}')" class="btn-ghost" style="padding:4px 8px; color:var(--success); background: #dcfce7; border-radius: 4px;" title="Adicionar Subcategoria"><i class="fa-solid fa-plus"></i></button><button onclick="CategoryApp.edit('${cat.id}')" class="btn-ghost" style="padding:4px 8px; color:var(--primary);" title="Editar Nome"><i class="fa-solid fa-pen"></i></button><button onclick="CategoryApp.delete('${cat.id}')" class="btn-ghost" style="padding:4px 8px; color:var(--danger);" title="Excluir Categoria"><i class="fa-solid fa-trash"></i></button></div></div><div style="padding: 4px 8px 8px 8px; background: var(--slate-50);">${subsHtml}</div></div>`}).join('')}};
window.onload=()=>{UI.switchView('cliente',document.querySelector('.nav-item.active'));setInterval(()=>document.getElementById('clock').innerText=new Date().toLocaleTimeString().slice(0,5),1000);setTimeout(()=>{UI.populateCategories()},500)};
</script>
</body>
</html>
