<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Leitor XML de NFe com Edi√ß√£o Manual de Fator e C√°lculo de Descontos.">
    <title>NFe Parser Pro | Exporta√ß√£o Fiscal</title>

    <style>
        /* * SISTEMAS - CSS CORE 
         * Performance: Alta (Sem frameworks)
         * Design: Minimalista & Mobile-First
         */

        :root {
            /* Paleta de Cores Otimizada */
            --primary: #2563eb;       /* Royal Blue */
            --primary-dark: #1d4ed8;
            --primary-light: #eff6ff;
            --text: #1e293b;          /* Slate 800 */
            --text-light: #64748b;    /* Slate 500 */
            --bg: #f8fafc;            /* Slate 50 */
            --surface: #ffffff;
            --border: #e2e8f0;        /* Slate 200 */
            --danger: #dc2626;        /* Red 600 */
            --danger-bg: #fef2f2;
            --success: #16a34a;       /* Green 600 */
            --success-bg: #f0fdf4;
            --warning: #ca8a04;
            --warning-bg: #fefce8;
            
            /* M√©tricas */
            --radius: 8px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --font-main: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            --spacing-sm: 0.75rem;
            --spacing-md: 1.5rem;
        }

        /* RESET & BASE */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            padding: var(--spacing-sm);
        }

        /* LAYOUT */
        main {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        /* COMPONENT: CARDS */
        section, header {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            box-shadow: var(--shadow);
        }

        /* TYPOGRAPHY */
        h1 { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.025em; }
        h1 span { color: var(--primary); }
        h2, h3 { font-size: 1.125rem; font-weight: 600; color: var(--text); margin-bottom: 1rem; }
        p { color: var(--text-light); font-size: 0.875rem; }
        
        /* HEADER */
        header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        @media (min-width: 768px) {
            header { flex-direction: row; justify-content: space-between; align-items: center; }
        }
        .badge {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid #dbeafe;
            align-self: flex-start;
        }
        .badge-warning {
            background: var(--warning-bg);
            color: var(--warning);
            border-color: #fef08a;
        }
        .badge-success {
            background: var(--success-bg);
            color: var(--success);
            border-color: #bbf7d0;
        }

        /* FORMS */
        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        input[type="text"],
        input[type="date"],
        input[type="file"],
        select {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: border-color 0.15s;
            background: var(--surface);
            color: var(--text);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        /* Estilo espec√≠fico para o input de fator na tabela */
        input.factor-input {
            width: 60px;
            padding: 4px 6px;
            text-align: center;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            font-weight: bold;
            color: var(--primary-dark);
            background: #f1f5f9;
            font-size: 0.75rem;
        }
        input.factor-input:focus {
            background: #fff;
            border-color: var(--primary);
        }
        input.factor-input::-webkit-outer-spin-button,
        input.factor-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="file"]::file-selector-button {
            background: var(--primary-light);
            color: var(--primary-dark);
            border: 0;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        /* CHECKBOX CUSTOMIZATION */
        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* GRID SYSTEM */
        .filters-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            align-items: end;
        }
        @media (min-width: 768px) {
            .filters-grid { grid-template-columns: 2fr 1fr 1fr 1fr; }
        }

        /* BUTTONS */
        button {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius);
            transition: all 0.2s;
            border: 1px solid transparent;
            width: 100%;
        }
        @media (min-width: 640px) { button { width: auto; } }

        .btn-ghost { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-ghost:hover { background: var(--bg); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-danger { background: white; color: var(--danger); border: 1px solid var(--border); }
        .btn-danger:hover { background: var(--danger-bg); border-color: #fca5a5; }

        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .btn-success:hover { background: #15803d; transform: translateY(-1px); }

        .actions-row {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }
        @media (min-width: 640px) { 
            .actions-row { flex-direction: row; align-items: center; }
            .ml-auto { margin-left: auto; }
        }

        /* EXPORT CONTROL GROUP */
        .export-control {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        @media (min-width: 640px) {
            .export-control { flex-direction: row; width: auto; flex: 1; }
        }

        /* TABLE */
        .results-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 1rem;
        }
        @media (min-width: 640px) {
            .results-header { flex-direction: row; justify-content: space-between; align-items: center; }
        }

        .total-card {
            background: var(--primary-light);
            border: 1px solid #dbeafe;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            text-align: right;
        }
        .total-label { font-size: 0.75rem; text-transform: uppercase; font-weight: 700; color: var(--text-light); }
        .total-value { font-size: 1.25rem; font-weight: 700; color: var(--primary); }

        .table-container {
            width: 100%;
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            max-height: 70vh;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        th {
            background: var(--bg);
            text-align: left;
            padding: 0.75rem;
            font-weight: 600;
            color: var(--text-light);
            text-transform: uppercase;
            font-size: 0.7rem;
            position: sticky;
            top: 0;
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }

        td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            vertical-align: middle;
        }

        th.w-check, td.w-check { width: 40px; text-align: center; padding-left: 0.5rem; padding-right: 0.5rem; }

        tr:hover td { background: var(--bg); }
        tr.selected td { background: var(--success-bg); }
        
        .text-right { text-align: right; }
        .text-brand { color: var(--primary); font-family: monospace; }
        .text-danger { color: var(--danger); }
        .text-success { color: var(--success); }
        .font-bold { font-weight: 700; }
        
        /* New Styles for Smart Fiscal */
        .smart-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            margin-left: 5px;
        }
        .smart-st { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; } /* Red for ST */
        .smart-normal { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; } /* Green for Normal */

        /* LOADING & UTILS */
        #loading {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .loader-card {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        .flex { display: flex !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading" class="hidden">
        <div class="loader-card">
            <div class="spinner"></div>
            <span style="font-weight: 500;">Processando Fiscal...</span>
        </div>
    </div>

    <main>
        
        <!-- Header -->
        <header>
            <div>
                <h1>NFe Parser Pro <span>Exporta√ß√£o Fiscal</span></h1>
                <p>Detecta Fardos, permite Edi√ß√£o e <b>deduz Descontos</b> do custo unit√°rio.</p>
            </div>
            <div class="flex flex-col items-end gap-1">
                <span class="badge">v6.2 Qtd NFe</span>
                <span class="badge badge-success">Dados Brutos + Calc</span>
            </div>
        </header>

        <!-- Upload -->
        <section>
            <label for="fileInput">1. Importar Arquivos XML (Compra)</label>
            <input type="file" id="fileInput" multiple accept=".xml, text/xml">
            <p style="margin-top: 0.5rem;">üîí O sistema agora l√™ a tag <code>&lt;vDesc&gt;</code> e calcula o custo real (Valor Produto - Desconto).</p>
        </section>

        <!-- Filtros e A√ß√µes -->
        <section>
            <div class="results-header" style="border: none; padding: 0; margin: 0 0 1rem 0;">
                <h2>2. Filtros e Sele√ß√£o Inteligente</h2>
            </div>

            <div class="filters-grid">
                <div>
                    <label for="searchInput">BUSCAR GERAL</label>
                    <input type="text" id="searchInput" placeholder="Nome, EAN, C√≥digo, NCM...">
                </div>
                <div>
                    <label for="dateStart">DATA IN√çCIO</label>
                    <input type="date" id="dateStart">
                </div>
                <div>
                    <label for="dateEnd">DATA FIM</label>
                    <input type="date" id="dateEnd">
                </div>
                <div>
                    <button class="btn-ghost" onclick="app.resetFilters()">Limpar Filtros</button>
                </div>
            </div>
            
            <div class="actions-row">
                <!-- Bot√£o de Exporta√ß√£o Condicional -->
                <div id="selectionActions" class="hidden fade-in export-control">
                    <select id="exportModeSelect" style="max-width: 250px;">
                        <option value="varejo" selected>Modo Varejo (Unidade)</option>
                        <option value="atacado">Modo Atacado (Caixa/Fardo)</option>
                        <option value="ambos">Ambos (Completo)</option>
                    </select>
                    <button class="btn-success" onclick="app.exportSmartJSON()">
                        ‚ú® Exportar Itens Selecionados
                    </button>
                </div>

                <div class="ml-auto flex gap-2 w-full sm:w-auto mt-2 sm:mt-0">
                    <button class="btn-primary" onclick="app.exportData('json')" style="width: auto;">
                        üì• Backup Bruto
                    </button>
                    <button class="btn-danger" onclick="app.clearData()" style="width: auto;">
                        üóëÔ∏è Apagar
                    </button>
                </div>
            </div>
        </section>

        <!-- Resultados -->
        <section style="padding: 0; overflow: hidden; border: none; background: transparent; box-shadow: none;">
            <div style="background: var(--surface); padding: var(--spacing-md); border: 1px solid var(--border); border-radius: var(--radius) var(--radius) 0 0; border-bottom: none;" class="results-header">
                <div>
                    <h3>3. Produtos Encontrados</h3>
                    <p>Verifique a coluna <b>Desc.</b> e <b>V. Liq</b> para conferir o custo real.</p>
                </div>
                <div class="total-card">
                    <div class="total-label">Total Filtrado</div>
                    <div id="totalValueDisplay" class="total-value">R$ 0,00</div>
                </div>
            </div>

            <div class="table-container" style="background: var(--surface); border-radius: 0 0 var(--radius) var(--radius);">
                <table>
                    <thead>
                        <tr>
                            <th class="w-check">
                                <input type="checkbox" id="selectAll" onchange="app.toggleSelectAll(this)">
                            </th>
                            <th>Fator/Cx</th>
                            <th>Data</th>
                            <th>Descri√ß√£o</th>
                            <th>EAN</th>
                            <th>NCM</th>
                            <th>CST</th>
                            <th class="text-right">Qtd</th>
                            <th class="text-right text-success" title="Valor do Desconto Rateado">Desc.</th>
                            <th class="text-right" title="Valor L√≠quido por Caixa (Entrada - Desconto)">V. Liq (Cx)</th>
                            <th class="text-right">V. Total</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- JS Renderiza aqui -->
                        <tr>
                            <td colspan="11" style="text-align: center; padding: 3rem;">
                                <div style="color: var(--text-light);">
                                    Importe arquivos XML para visualizar.
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <script>
        /**
         * SISTEMAS - Core Logic v6.2 (Strict Quantity Export)
         */
        const app = {
            data: [], 
            selectedIds: new Set(),
            storageKey: 'nfe_sys_data_discount_v6',

            init() {
                this.cacheDOM();
                this.bindEvents();
                this.loadFromStorage();
            },

            cacheDOM() {
                this.dom = {
                    fileInput: document.getElementById('fileInput'),
                    tableBody: document.getElementById('tableBody'),
                    searchInput: document.getElementById('searchInput'),
                    dateStart: document.getElementById('dateStart'),
                    dateEnd: document.getElementById('dateEnd'),
                    totalDisplay: document.getElementById('totalValueDisplay'),
                    loading: document.getElementById('loading'),
                    selectAll: document.getElementById('selectAll'),
                    selectionActions: document.getElementById('selectionActions'),
                    exportModeSelect: document.getElementById('exportModeSelect'),
                };
            },

            bindEvents() {
                this.dom.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.dom.searchInput.addEventListener('input', () => this.render());
                this.dom.dateStart.addEventListener('change', () => this.render());
                this.dom.dateEnd.addEventListener('change', () => this.render());
            },

            // --- Gerenciamento de Dados ---
            saveToStorage() {
                try { localStorage.setItem(this.storageKey, JSON.stringify(this.data)); } catch (e) { alert('LocalStorage cheio.'); }
            },
            loadFromStorage() {
                const stored = localStorage.getItem(this.storageKey);
                if (stored) { this.data = JSON.parse(stored); this.render(); }
            },
            clearData() {
                if (confirm('Limpar tudo?')) {
                    this.data = []; this.selectedIds.clear();
                    localStorage.removeItem(this.storageKey); this.render();
                    this.dom.fileInput.value = '';
                }
            },

            updateFactor(id, newValue) {
                const item = this.data.find(i => i.id === id);
                if (item) {
                    let val = parseInt(newValue);
                    if (isNaN(val) || val < 1) val = 1;
                    item.userFactor = val;
                    this.saveToStorage();
                }
            },

            toggleSelect(id) {
                this.selectedIds.has(id) ? this.selectedIds.delete(id) : this.selectedIds.add(id);
                this.updateSelectionUI();
            },
            toggleSelectAll(checkbox) {
                const filtered = this.getFilteredData();
                checkbox.checked ? filtered.forEach(i => this.selectedIds.add(i.id)) : filtered.forEach(i => this.selectedIds.delete(i.id));
                this.render();
            },
            updateSelectionUI() {
                const count = this.selectedIds.size;
                if (count > 0) {
                    this.dom.selectionActions.classList.remove('hidden');
                    this.dom.selectionActions.classList.add('flex');
                    const btn = this.dom.selectionActions.querySelector('button');
                    btn.innerHTML = `‚ú® Exportar <b>${count}</b> Itens`;
                } else {
                    this.dom.selectionActions.classList.add('hidden');
                    this.dom.selectionActions.classList.remove('flex');
                    this.dom.selectAll.checked = false;
                }
                
                document.querySelectorAll('.row-checkbox').forEach(cb => {
                    const tr = cb.closest('tr');
                    cb.checked ? tr.classList.add('selected') : tr.classList.remove('selected');
                });
            },

            // --- INTELIG√äNCIA FISCAL ---
            detectConversionFactor(description) {
                if (!description) return 1;
                const desc = description.toUpperCase();
                const regexMultiplier = /(\d+)\s*[xX]\s*\d+/; 
                const matchX = desc.match(regexMultiplier);
                if (matchX && matchX[1]) {
                    const val = parseInt(matchX[1]);
                    return val > 0 ? val : 1;
                }
                const regexPack = /(?:CX|FD|FARDO|PCT)\W+(\d+)/;
                const matchPack = desc.match(regexPack);
                if (matchPack && matchPack[1]) {
                    const val = parseInt(matchPack[1]);
                    return val > 0 ? val : 1;
                }
                return 1;
            },

            predictFiscalAttributes(item) {
                const cfopIn = parseInt(item.CFOP.replace('.', ''));
                const cstIn = parseInt(item.CST_CSOSN || '0');
                
                const isST = [1403, 2403, 5403, 5405].includes(cfopIn) || [10, 30, 60, 70, 201, 202, 500].includes(cstIn);

                if (isST) {
                    return { cfopOut: '5.405', csosnOut: '500', desc: 'Revenda ST' };
                } else {
                    return { cfopOut: '5.102', csosnOut: '102', desc: 'Revenda Normal' };
                }
            },

            // --- EXPORTA√á√ÉO (ATUALIZADO V6.2 - CAMPOS EXPL√çCITOS DE QTD) ---
            exportSmartJSON() {
                const selectedItems = this.data.filter(item => this.selectedIds.has(item.id));
                if (selectedItems.length === 0) return;

                const mode = this.dom.exportModeSelect.value;
                const exportList = [];

                selectedItems.forEach(item => {
                    const detected = this.detectConversionFactor(item.xProd);
                    const finalFactor = item.userFactor ? item.userFactor : detected;
                    const fiscal = this.predictFiscalAttributes(item);
                    
                    // --- C√ÅLCULOS ---
                    const totalDesc = item.vDesc || 0;
                    const netTotal = item.vProd - totalDesc;
                    const netCostBox = netTotal / item.qCom;
                    const unitCost = netCostBox / finalFactor;
                    
                    // Quantidade TOTAL de unidades (ex: 2 caixas * 12un = 24un)
                    const qtdTotalUnidades = item.qCom * finalFactor;

                    if (mode === 'atacado') {
                        exportList.push({
                            ...item,
                            Numero_Nota: item.nNF,
                            
                            // CAMPOS PADRONIZADOS PARA MULTIPLICA√á√ÉO
                            Quantidade_NFe: item.qCom,        // Qtd Original
                            Unidade_NFe: item.uCom,           // Un Original
                            Fator_Conversao: finalFactor,     // Fator
                            Quantidade_Total_Unidades: qtdTotalUnidades, // Resultado
                            
                            _TIPO: 'ATACADO (ENTRADA)',
                            CFOP_SAIDA_SUGERIDO: fiscal.cfopOut,
                            CSOSN_SAIDA_SUGERIDO: fiscal.csosnOut,
                            CUSTO_LIQUIDO_CAIXA: parseFloat(netCostBox.toFixed(4)),
                            Custo_Real_Caixa: parseFloat(netCostBox.toFixed(4)),
                            DESCONTO_APLICADO: totalDesc
                        });
                    }

                    if (mode === 'varejo' || mode === 'ambos') {
                        let cleanDesc = item.xProd.replace(/(\d+\s*[xX]\s*\d+)/gi, '').replace(/(FD|CX|FARDO)\s*\d*/gi, '').trim();
                        cleanDesc = cleanDesc.replace(/\s+/, ' ') + " (UN)";

                        exportList.push({
                            id_referencia: item.id,
                            Numero_Nota: item.nNF,
                            cProd_Sugestao: item.cProd + '-UN', 
                            cEAN: 'PREENCHER_COM_LEITOR', 
                            xProd: cleanDesc,
                            NCM: item.NCM, 
                            CEST: item.CEST,
                            CFOP_SAIDA: fiscal.cfopOut,
                            CSOSN_SAIDA: fiscal.csosnOut,
                            Unidade_Venda: 'UN',
                            
                            // CAMPOS PADRONIZADOS PARA MULTIPLICA√á√ÉO
                            Quantidade_NFe: item.qCom,        // Qtd Original
                            Unidade_NFe: item.uCom,           // Un Original
                            Fator_Conversao: finalFactor,     // Fator
                            Quantidade_Total_Unidades: qtdTotalUnidades, // Resultado
                            
                            Custo_Unitario: parseFloat(unitCost.toFixed(4)), 
                            Custo_Real_Caixa: parseFloat(netCostBox.toFixed(4)), 
                            Valor_Desconto_Total: totalDesc,
                            _TIPO: 'VAREJO (SAIDA)',
                            _OBS: `Entrada: ${item.qCom} ${item.uCom} x ${finalFactor} = ${qtdTotalUnidades} UN`
                        });
                    }
                });

                const filename = `exportacao_${mode}_${selectedItems.length}itens`;
                this.downloadJSON(exportList, filename);
            },

            downloadJSON(data, filenamePrefix) {
                const content = JSON.stringify(data, null, 2);
                const blob = new Blob([content], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filenamePrefix}_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },
            
            // --- Parser (Preserve Data) ---
            exportData(type) {
                // Backup Bruto
                const filename = `backup_bruto_${this.data.length}itens`;
                this.downloadJSON(this.data, filename);
            },

            async handleFileUpload(event) {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                this.toggleLoading(true);
                const promises = files.map(file => this.readFileAsText(file));
                try {
                    const contents = await Promise.all(promises);
                    let newItems = [];
                    contents.forEach(xml => {
                        const parsed = this.parseXML(xml);
                        if (parsed) newItems.push(...parsed);
                    });
                    this.data = [...this.data, ...newItems];
                    this.saveToStorage();
                    this.render();
                } catch (e) { alert('Erro no processamento.'); } 
                finally { this.toggleLoading(false); this.dom.fileInput.value = ''; }
            },
            readFileAsText(file) {
                return new Promise((r, j) => { const fr = new FileReader(); fr.onload = e => r(e.target.result); fr.onerror = j; fr.readAsText(file); });
            },
            parseXML(xmlString) {
                try {
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                    if (xmlDoc.getElementsByTagName("parsererror").length > 0) return null;
                    const getTag = (p, t) => { const el = p.getElementsByTagName(t)[0]; return el ? el.textContent : ''; };
                    const getFloat = (p, t) => { const v = getTag(p, t); return v ? parseFloat(v) : 0.0; };

                    const infNFe = xmlDoc.getElementsByTagName('infNFe')[0];
                    if (!infNFe) return null; 
                    const nNF = getTag(infNFe, 'nNF');
                    const dhEmi = getTag(infNFe, 'dhEmi') || getTag(infNFe, 'dEmi');
                    const emitente = getTag(infNFe, 'xNome');
                    const chave = infNFe.getAttribute('Id') || '';
                    
                    const dets = xmlDoc.getElementsByTagName('det');
                    const items = [];
                    for (let i = 0; i < dets.length; i++) {
                        const prod = dets[i].getElementsByTagName('prod')[0];
                        const imposto = dets[i].getElementsByTagName('imposto')[0];
                        const nItem = dets[i].getAttribute('nItem');
                        
                        let cst = '', vICMS = 0;
                        if (imposto) {
                            cst = getTag(imposto, 'CST') || getTag(imposto, 'CSOSN');
                            vICMS = getFloat(imposto, 'vICMS');
                        }

                        const vDesc = getFloat(prod, 'vDesc'); 

                        items.push({
                            id: `${chave}-${nItem}`,
                            nNF, 
                            dataEmissao: dhEmi.split('T')[0],
                            emitente,
                            cProd: getTag(prod, 'cProd'),
                            cEAN: getTag(prod, 'cEAN'),
                            xProd: getTag(prod, 'xProd'),
                            NCM: getTag(prod, 'NCM'),
                            CEST: getTag(prod, 'CEST'),
                            CFOP: getTag(prod, 'CFOP'),
                            uCom: getTag(prod, 'uCom'),
                            qCom: getFloat(prod, 'qCom'),
                            vUnCom: getFloat(prod, 'vUnCom'), 
                            vProd: getFloat(prod, 'vProd'),
                            vDesc: vDesc, 
                            CST_CSOSN: cst,
                            vICMS,
                            userFactor: null
                        });
                    }
                    return items;
                } catch (e) { return []; }
            },

            // --- Render ---
            getFilteredData() {
                const s = this.dom.searchInput.value.toLowerCase();
                const d1 = this.dom.dateStart.value;
                const d2 = this.dom.dateEnd.value;
                return this.data.filter(i => {
                    const txt = (i.emitente+i.xProd+i.cProd+i.nNF).toLowerCase().includes(s);
                    let date = true;
                    if (d1) date = date && i.dataEmissao >= d1;
                    if (d2) date = date && i.dataEmissao <= d2;
                    return txt && date;
                }).sort((a,b) => b.dataEmissao.localeCompare(a.dataEmissao));
            },
            resetFilters() {
                this.dom.searchInput.value = '';
                this.dom.dateStart.value = '';
                this.dom.dateEnd.value = '';
                this.render();
            },
            render() {
                const filtered = this.getFilteredData();
                const tbody = this.dom.tableBody;
                tbody.innerHTML = '';
                
                this.dom.selectAll.checked = filtered.length > 0 && filtered.every(i => this.selectedIds.has(i.id));

                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding: 2rem; color: #94a3b8;">Nada encontrado.</td></tr>`;
                    this.dom.totalDisplay.textContent = 'R$ 0,00';
                    this.updateSelectionUI();
                    return;
                }

                const limit = 200;
                const fragment = document.createDocumentFragment();

                filtered.slice(0, limit).forEach(item => {
                    const tr = document.createElement('tr');
                    const isSel = this.selectedIds.has(item.id);
                    if (isSel) tr.classList.add('selected');

                    const fiscal = this.predictFiscalAttributes(item);
                    const tagClass = fiscal.csosnOut === '500' ? 'smart-st' : 'smart-normal';
                    const tagLabel = fiscal.csosnOut === '500' ? 'ST' : 'NORM';
                    
                    const detected = this.detectConversionFactor(item.xProd);
                    const currentFactor = item.userFactor ? item.userFactor : detected;
                    
                    const discount = item.vDesc || 0;
                    const netTotal = item.vProd - discount;
                    const netUnitCostBox = netTotal / item.qCom; 

                    const inputHtml = `
                        <input type="number" 
                               class="factor-input" 
                               value="${currentFactor}" 
                               min="1" 
                               onchange="app.updateFactor('${item.id}', this.value)"
                               onclick="this.select()"
                               title="Qtd detectada: ${detected}. Edite para corrigir.">
                    `;

                    const descHtml = discount > 0 
                        ? `<span class="text-success font-bold">-${discount.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</span>` 
                        : '<span style="color:#cbd5e1">-</span>';

                    tr.innerHTML = `
                        <td class="w-check">
                            <input type="checkbox" class="row-checkbox" value="${item.id}" ${isSel ? 'checked' : ''} onchange="app.toggleSelect('${item.id}')">
                        </td>
                        <td style="text-align: center;">${inputHtml}</td>
                        <td>${item.dataEmissao.split('-').reverse().join('/')}</td>
                        <td title="${item.xProd}">${item.xProd.substring(0, 30)}...</td>
                        <td class="text-brand">${item.cEAN}</td>
                        <td>${item.NCM}</td>
                        <td><span class="smart-tag ${tagClass}">${tagLabel}</span></td>
                        <td class="text-right">${item.qCom}</td>
                        <td class="text-right">${descHtml}</td>
                        <td class="text-right font-bold" style="color:var(--primary)">${netUnitCostBox.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
                        <td class="text-right">${item.vProd.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
                    `;
                    fragment.appendChild(tr);
                });

                tbody.appendChild(fragment);
                this.dom.totalDisplay.textContent = filtered.reduce((a, b) => a + b.vProd, 0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
                this.updateSelectionUI();
            },
            toggleLoading(show) {
                const el = this.dom.loading;
                show ? (el.classList.remove('hidden'), el.classList.add('flex')) : (el.classList.add('hidden'), el.classList.remove('flex'));
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
