<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Kits Bling (v4.0 - CORRE√á√ÉO DEFINITIVA DE IDs)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        body { background-color: #e9ecef; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 1000px; }
        .card { border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .badge-id { font-size: 0.9em; font-family: monospace; }
        .error-box { background: #fee; border: 1px solid #f00; color: #a00; padding: 10px; display: none; margin-top: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container py-5">
        <h2 class="fw-bold text-center mb-4">üì¶ Gerador de Kits - Vers√£o Final (IDs Obrigat√≥rios)</h2>

        <div class="card p-4">
            <h5 class="fw-bold">1. Carregar CSV de Produtos (Exportado do Bling)</h5>
            <input type="file" id="fileInput" class="form-control" accept=".csv">
            <div id="statusLoad" class="mt-2 fw-bold text-muted">Aguardando arquivo...</div>
            <div id="errorLoad" class="error-box"></div>
        </div>

        <div class="card p-4">
            <h5 class="fw-bold">2. Criar Kit</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">SKU do Kit (Pai)</label>
                    <input type="text" id="kitSku" class="form-control" placeholder="Ex: KIT-123" onblur="verificarPai()">
                    <div id="paiStatus" class="form-text"></div>
                </div>
                <div class="col-md-8">
                    <label class="form-label">Nome do Kit</label>
                    <input type="text" id="kitName" class="form-control">
                </div>
                <div class="col-12">
                    <label class="form-label">Componentes (Ex: <code>1x nome do produto</code>)</label>
                    <textarea id="kitItems" class="form-control font-monospace" rows="5"></textarea>
                    <button onclick="adicionarKit()" class="btn btn-primary mt-2 w-100 fw-bold">‚¨áÔ∏è ADICIONAR √Ä LISTA</button>
                </div>
            </div>
        </div>

        <div class="card p-4">
            <h5 class="fw-bold d-flex justify-content-between">
                3. Lista Final
                <button onclick="limpar()" class="btn btn-sm btn-outline-danger">Limpar</button>
            </h5>
            <div class="table-responsive">
                <table class="table table-bordered table-striped align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Kit (Pai)</th>
                            <th>ID Pai</th>
                            <th>Qtd</th>
                            <th>Componente (Filho)</th>
                            <th>ID Filho (CR√çTICO)</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaBody"></tbody>
                </table>
            </div>
            <div class="text-end">
                <button onclick="baixarCSV()" id="btnBaixar" class="btn btn-success btn-lg disabled">üíæ BAIXAR ARQUIVO CORRETO</button>
            </div>
        </div>
    </div>

    <script>
        let produtos = [];
        let listaKits = [];

        // 1. CARREGAMENTO ROBUSTO DO ARQUIVO
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                delimiter: ";", // Bling usa ponto e v√≠rgula
                skipEmptyLines: true,
                encoding: "ISO-8859-1", // Codifica√ß√£o padr√£o do Excel BR
                complete: function(results) {
                    
                    // L√ìGICA DE DETEC√á√ÉO DE COLUNA ID (O PULO DO GATO)
                    // Procura qualquer coluna que limpa de aspas e espa√ßos seja "ID" ou "id"
                    const campos = results.meta.fields;
                    console.log("Colunas encontradas:", campos);

                    const nomeColunaID = campos.find(c => c.trim().replace(/['"]/g, '').toLowerCase() === 'id');
                    const nomeColunaCod = campos.find(c => c.trim().replace(/['"]/g, '').toLowerCase().includes('c√≥digo') || c.toLowerCase().includes('codigo'));
                    const nomeColunaDesc = campos.find(c => c.trim().replace(/['"]/g, '').toLowerCase().includes('descri'));

                    if (!nomeColunaID) {
                        document.getElementById('errorLoad').style.display = 'block';
                        document.getElementById('errorLoad').innerText = "ERRO FATAL: N√£o encontrei a coluna 'ID' no seu arquivo. Verifique se exportou corretamente do Bling.";
                        return;
                    }

                    // Mapeia for√ßando a extra√ß√£o do ID
                    produtos = results.data.map(row => {
                        // Remove aspas extras se houver nos valores
                        let idLimpo = row[nomeColunaID] ? row[nomeColunaID].replace(/['"]/g, '').trim() : "";
                        return {
                            id: idLimpo,
                            codigo: row[nomeColunaCod] ? row[nomeColunaCod].replace(/['"]/g, '').trim() : "",
                            descricao: row[nomeColunaDesc] ? row[nomeColunaDesc].replace(/['"]/g, '').trim() : "",
                            // Campo de busca normalizado
                            busca: ((row[nomeColunaDesc]||"") + " " + (row[nomeColunaCod]||"")).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        };
                    }).filter(p => p.id !== ""); // Remove linhas sem ID

                    document.getElementById('statusLoad').innerHTML = `<span class="text-success">‚úÖ ${produtos.length} produtos carregados! Coluna ID detectada: <b>${nomeColunaID}</b></span>`;
                    document.getElementById('errorLoad').style.display = 'none';
                }
            });
        });

        function normalizar(txt) {
            return txt.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        // Verifica se o Pai j√° existe para pegar o ID dele
        function verificarPai() {
            const sku = document.getElementById('kitSku').value.trim();
            const feedback = document.getElementById('paiStatus');
            if (!sku || produtos.length === 0) return;

            const pai = produtos.find(p => p.codigo === sku);
            if (pai) {
                feedback.innerHTML = `<span class="text-success fw-bold">‚úÖ Pai encontrado! ID: ${pai.id}</span>`;
                if(!document.getElementById('kitName').value) document.getElementById('kitName').value = pai.descricao;
            } else {
                feedback.innerHTML = `<span class="text-danger fw-bold">‚ö†Ô∏è Pai n√£o encontrado no arquivo (ID ser√° vazio).</span>`;
            }
        }

        function adicionarKit() {
            if (produtos.length === 0) return alert("Carregue o arquivo primeiro!");
            
            const skuPai = document.getElementById('kitSku').value.trim();
            const nomePai = document.getElementById('kitName').value.trim();
            const linhas = document.getElementById('kitItems').value.split('\n');

            // Tenta pegar ID do Pai
            const objPai = produtos.find(p => p.codigo === skuPai);
            const idPai = objPai ? objPai.id : ""; // Se n√£o achar, vai vazio (Bling tenta pelo SKU)

            linhas.forEach(linha => {
                if (!linha.trim()) return;

                const match = linha.match(/^(\d+)[xX]?\s+(.*)/);
                if (!match) return alert(`Linha inv√°lida: ${linha}`);

                const qtd = match[1];
                const termo = normalizar(match[2]);
                const palavras = termo.split(' ');

                // Busca Produto Filho
                const matches = produtos.filter(p => palavras.every(pl => p.busca.includes(pl)));

                let filho = { id: "", codigo: "ERRO", descricao: "N√ÉO ENCONTRADO" };
                let erro = true;

                if (matches.length > 0) {
                    filho = matches[0]; // Pega o primeiro
                    erro = false;
                }

                listaKits.push({
                    skuPai, nomePai, idPai,
                    idFilho: filho.id,
                    codFilho: filho.codigo,
                    descFilho: filho.descricao,
                    qtd, erro
                });
            });

            renderizar();
            document.getElementById('kitItems').value = '';
        }

        function renderizar() {
            const tbody = document.getElementById('tabelaBody');
            tbody.innerHTML = '';
            
            listaKits.forEach((item, i) => {
                const tr = document.createElement('tr');
                if (item.erro || !item.idFilho) tr.classList.add('table-danger');

                tr.innerHTML = `
                    <td>${item.skuPai}</td>
                    <td><span class="badge bg-secondary">${item.idPai || 'N/A'}</span></td>
                    <td>${item.qtd}</td>
                    <td>${item.descFilho}</td>
                    <td><span class="badge bg-${item.idFilho ? 'success' : 'danger'} badge-id">${item.idFilho || 'SEM ID'}</span></td>
                    <td><button onclick="rm(${i})" class="btn btn-sm btn-danger">X</button></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('btnBaixar').classList.remove('disabled');
        }

        function rm(i) { listaKits.splice(i, 1); renderizar(); }
        function limpar() { listaKits = []; renderizar(); }

        function baixarCSV() {
            // VERIFICA√á√ÉO FINAL
            if (listaKits.some(k => !k.idFilho)) {
                alert("PARE! Existem itens vermelhos SEM ID na lista. Eles n√£o v√£o funcionar. Corrija antes de baixar.");
                return;
            }

            const header = ["ID da composi√ß√£o", "Descri√ß√£o da composi√ß√£o", "C√≥digo da composi√ß√£o", "ID do componente", "Descri√ß√£o do componente", "C√≥digo componente", "Quantidade do Componente", "Custo unit√°rio", "Opera√ß√£o"];
            
            const rows = listaKits.map(k => [
                k.idPai,    // ID DO PAI (Se tiver)
                k.nomePai,
                k.skuPai,
                k.idFilho,  // ID DO FILHO (Obrigat√≥rio)
                k.descFilho,
                k.codFilho,
                k.qtd,
                "",         // Custo
                "A"
            ]);

            const csvContent = Papa.unparse([header, ...rows], { delimiter: ";", quotes: false });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "importacao_kits_COM_IDS.csv";
            document.body.appendChild(a);
            a.click();
        }
    </script>
</body>
</html>
