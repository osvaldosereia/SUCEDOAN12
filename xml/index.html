<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Bling - FIXO KIT100</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', monospace; }
        .card { border: 1px solid #ced4da; box-shadow: none; border-radius: 4px; }
        .fixed-data { background-color: #e9ecef; border: 1px solid #adb5bd; color: #495057; font-weight: bold; }
        .badge-id { font-size: 0.9rem; letter-spacing: 1px; }
        .table-xs th, .table-xs td { font-size: 0.85rem; padding: 0.4rem; }
    </style>
</head>
<body>

<div class="container py-4">
    <h3 class="fw-bold text-center mb-4">GERADOR DE COMPOSIÇÃO (KIT100)</h3>

    <div class="row">
        <div class="col-12 mb-3">
            <div class="card p-3 border-primary">
                <label class="fw-bold text-primary mb-2">1. CARREGUE SEU BANCO DE DADOS (CSV DO BLING)</label>
                <input type="file" id="dbInput" class="form-control" accept=".csv">
                <small id="dbStatus" class="mt-2 d-block text-muted">Aguardando arquivo...</small>
            </div>
        </div>

        <div class="col-12 mb-3">
            <div class="card p-3">
                <h6 class="fw-bold border-bottom pb-2">2. DADOS DO KIT (FIXOS)</h6>
                <div class="row g-2">
                    <div class="col-md-4">
                        <label class="small text-muted">ID da Composição</label>
                        <input type="text" class="form-control fixed-data" value="16598186578" readonly id="fixedId">
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">Descrição</label>
                        <input type="text" class="form-control fixed-data" value="KIT100" readonly id="fixedDesc">
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">Código</label>
                        <input type="text" class="form-control fixed-data" value="69486" readonly id="fixedCode">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 mb-3">
            <div class="card p-3">
                <label class="fw-bold mb-2">3. LISTA DE COMPONENTES (FILHOS)</label>
                <textarea id="inputItems" class="form-control font-monospace" rows="5" placeholder="1x cafe caboclo&#10;2x acucar uniao"></textarea>
                <button onclick="processar()" class="btn btn-dark w-100 mt-2 fw-bold">PROCESSAR LISTA</button>
            </div>
        </div>

        <div class="col-12">
            <div class="card p-3">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-xs align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>ID Pai</th>
                                <th>Cod Pai</th>
                                <th>Qtd</th>
                                <th>ID Filho (Banco)</th>
                                <th>Desc Filho</th>
                                <th>Cod Filho</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
                <button id="btnDownload" onclick="baixar()" class="btn btn-success w-100 disabled fw-bold p-3">BAIXAR CSV EXATO</button>
            </div>
        </div>
    </div>
</div>

<script>
    let dbProdutos = [];
    let listaFinal = [];

    // --- LEITURA DO ARQUIVO DE PRODUTOS ---
    document.getElementById('dbInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if(!file) return;

        Papa.parse(file, {
            header: true,
            delimiter: ";", // Bling padrão
            encoding: "ISO-8859-1", // Bling padrão
            skipEmptyLines: true,
            complete: (results) => {
                const fields = results.meta.fields.map(f => f.trim().toLowerCase());
                
                // Tenta achar as colunas independente de maiuscula/minuscula
                const keyID = results.meta.fields.find(f => f.toLowerCase().trim() === 'id');
                const keyCod = results.meta.fields.find(f => f.toLowerCase().includes('código') || f.toLowerCase().includes('codigo'));
                const keyDesc = results.meta.fields.find(f => f.toLowerCase().includes('descri'));

                if(!keyID) {
                    document.getElementById('dbStatus').innerHTML = `<span class="text-danger fw-bold">❌ ERRO: Coluna 'ID' não encontrada no CSV.</span>`;
                    return;
                }

                dbProdutos = results.data.map(row => ({
                    id: row[keyID],
                    codigo: row[keyCod] || "",
                    descricao: row[keyDesc] || "",
                    // Cria string de busca normalizada
                    busca: ((row[keyDesc]||"") + " " + (row[keyCod]||"")).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                })).filter(p => p.id && p.id.trim() !== "");

                document.getElementById('dbStatus').innerHTML = `<span class="text-success fw-bold">✅ ${dbProdutos.length} produtos carregados na memória.</span>`;
            }
        });
    });

    // --- PROCESSAMENTO ---
    function processar() {
        if(dbProdutos.length === 0) return alert("Carregue o arquivo de produtos primeiro (Passo 1).");

        const linhas = document.getElementById('inputItems').value.split('\n');
        listaFinal = [];
        const tbody = document.getElementById('previewBody');
        tbody.innerHTML = "";

        // DADOS FIXOS
        const pai = {
            id: document.getElementById('fixedId').value,
            desc: document.getElementById('fixedDesc').value,
            cod: document.getElementById('fixedCode').value
        };

        linhas.forEach(linha => {
            if(!linha.trim()) return;

            // Regex para pegar quantidade e nome
            const match = linha.match(/^(\d+)[xX]?\s+(.*)/);
            if(!match) return;

            const qtd = match[1];
            const termo = match[2].toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const termosBusca = termo.split(" ");

            // Busca no banco de dados carregado
            const encontrados = dbProdutos.filter(p => termosBusca.every(t => p.busca.includes(t)));
            
            let filho = { id: "", codigo: "", descricao: "NÃO ENCONTRADO" };
            let status = "❌";
            let classRow = "table-danger";

            if(encontrados.length > 0) {
                filho = encontrados[0]; // Pega o primeiro
                status = "✅";
                classRow = "";
            }

            // Adiciona à lista final
            listaFinal.push({
                pai: pai,
                filho: filho,
                qtd: qtd,
                valido: !!filho.id
            });

            // Renderiza na tela
            const tr = document.createElement('tr');
            tr.className = classRow;
            tr.innerHTML = `
                <td>${pai.id}</td>
                <td>${pai.cod}</td>
                <td class="text-center fw-bold">${qtd}</td>
                <td><span class="badge bg-light text-dark border badge-id">${filho.id || '---'}</span></td>
                <td>${filho.descricao}</td>
                <td>${filho.codigo}</td>
                <td class="text-center">${status}</td>
            `;
            tbody.appendChild(tr);
        });

        // Habilita download se tiver itens
        const btn = document.getElementById('btnDownload');
        if(listaFinal.length > 0 && listaFinal.every(i => i.valido)) {
            btn.classList.remove('disabled');
            btn.innerText = "BAIXAR CSV (PRONTO)";
        } else {
            btn.classList.add('disabled');
            btn.innerText = "CORRIJA OS ERROS (ITENS VERMELHOS)";
        }
    }

    // --- GERAÇÃO DO CSV ---
    function baixar() {
        // Cabeçalho Exato do Modelo
        const header = "ID da composição;Descrição da composição;Código da composição;ID do componente;Descrição do componente;Código componente;Quantidade do Componente;Custo unitário;Operação";
        
        let csvContent = header + "\n";

        listaFinal.forEach(item => {
            // Montagem da linha respeitando ordem exata
            const row = [
                item.pai.id,           // ID da composição
                item.pai.desc,         // Descrição da composição
                item.pai.cod,          // Código da composição
                item.filho.id,         // ID do componente (VEM DO BANCO DE DADOS)
                item.filho.descricao,  // Descrição do componente
                item.filho.codigo,     // Código componente
                item.qtd,              // Quantidade
                "0",                   // Custo unitário
                "A"                    // Operação
            ];
            csvContent += row.join(";") + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "importacao_kit100_final.csv";
        document.body.appendChild(link);
        link.click();
    }
</script>

</body>
</html>
