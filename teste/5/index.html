<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M칩dulo Log칤stica & Entregas (Local-First)</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ESTILOS EXTRAS -->
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>

    <!-- 3. IMPORTMAP REACT + LUCIDE -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-full overflow-hidden">
    
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Truck, MapPin, Navigation, Phone, CheckCircle, XCircle, 
          ArrowUp, ArrowDown, Share2, Upload, DollarSign, CreditCard, 
          MessageSquare, Menu, X, Gift, Home, Clock
        } from 'lucide-react';

        // --- UTILIT츼RIOS ---
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        // --- APP PRINCIPAL ---
        function App() {
          // Estados Globais
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []); // Para devolu칞칚o de estoque
          const [companyPhone] = useStickyState('db_config_phone', '5565999999999'); 
          
          const [viewMode, setViewMode] = useState('dashboard'); // 'dashboard' ou 'driver'
          const [driverData, setDriverData] = useState(null);
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

          // Roteamento via Hash para o Motorista
          useEffect(() => {
            const checkHash = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#driver=')) {
                  try {
                    const encoded = hash.replace('#driver=', '');
                    const decoded = JSON.parse(atob(decodeURIComponent(encoded)));
                    setDriverData(decoded);
                    setViewMode('driver');
                  } catch (e) {
                    console.error("Link inv치lido", e);
                    alert("Erro ao abrir link do entregador.");
                  }
                } else {
                    if (viewMode === 'driver') setViewMode('dashboard');
                }
            };
            checkHash();
            window.addEventListener('hashchange', checkHash);
            return () => window.removeEventListener('hashchange', checkHash);
          }, []);

          // Se estiver no modo motorista, renderiza a DriverView
          if (viewMode === 'driver') {
              return <DriverView data={driverData} onExit={() => { window.location.hash = ''; setViewMode('dashboard'); }} />;
          }

          return (
            <div className="flex flex-col lg:flex-row h-screen bg-gray-100 font-sans text-gray-800 overflow-hidden">
                {/* MOBILE HEADER */}
                <div className="lg:hidden bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 z-50 shadow-md">
                    <div className="flex items-center gap-2">
                        <div className="bg-indigo-500 text-white p-1 rounded font-bold text-xs">LOG</div>
                        <h1 className="font-bold tracking-wider">LOG칈STICA</h1>
                    </div>
                    <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 bg-slate-800 rounded">
                        {mobileMenuOpen ? <X size={20}/> : <Menu size={20}/>}
                    </button>
                </div>

                {/* SIDEBAR */}
                <aside className={`fixed inset-y-0 left-0 bg-slate-900 text-white flex flex-col transition-transform duration-300 z-40 w-64 lg:static lg:translate-x-0 ${mobileMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'}`}>
                    <div className="h-16 hidden lg:flex items-center justify-start px-6 border-b border-slate-800">
                        <div className="bg-indigo-500 text-white p-1.5 rounded font-bold mr-2">LOG</div>
                        <h1 className="font-bold tracking-wider hidden lg:block text-lg">LOG칈STICA <span className="text-gray-400 text-xs font-normal ml-1">v1.0</span></h1>
                    </div>
                    <nav className="flex-1 py-4 space-y-1 overflow-y-auto mt-16 lg:mt-0">
                        <button className="w-full flex items-center justify-start gap-3 p-3 lg:px-6 transition-all duration-200 bg-slate-800 text-white border-r-4 border-indigo-500">
                            <Truck size={20}/>
                            <span className="font-medium text-sm">Gest칚o de Rotas</span>
                        </button>
                    </nav>
                    <div className="p-4 border-t border-slate-800 text-xs text-slate-500 text-center">
                        M칩dulo Isolado<br/>Foco em Last Mile
                    </div>
                </aside>
                
                {/* MAIN CONTENT AREA */}
                <main className="flex-1 flex flex-col min-w-0 bg-gray-50 h-full overflow-hidden relative">
                    <header className="h-16 bg-white border-b hidden lg:flex items-center justify-between px-6 shrink-0 shadow-sm z-20">
                        <div><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">Gest칚o de Rotas e Entregadores</h2></div>
                        <div className="flex items-center gap-2">
                             <span className="bg-indigo-100 text-indigo-800 text-xs font-bold px-3 py-1 rounded-full">{sales.filter(s => s.status === 'Rota').length} Entregas Pendentes</span>
                        </div>
                    </header>
                    
                    <div className="flex-1 overflow-hidden relative bg-gray-50">
                        <LogisticsManager 
                            sales={sales} setSales={setSales} 
                            clients={clients} companyPhone={companyPhone}
                            products={products} setProducts={setProducts} 
                        />
                    </div>
                </main>
                
                {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 lg:hidden" onClick={() => setMobileMenuOpen(false)}></div>}
            </div>
          );
        }

        // --- GEST츾O DE LOG칈STICA (PAINEL) ---
        function LogisticsManager({ sales, setSales, clients, companyPhone, products, setProducts }) {
            const [selectedRoute, setSelectedRoute] = useState('Todas');
            const [routeSales, setRouteSales] = useState([]); 
            const [showImport, setShowImport] = useState(false);
            const [importText, setImportText] = useState('');

            // Filtra e organiza as vendas prontas para rota
            useEffect(() => { 
                const ready = sales.filter(s => s.status === 'Rota'); 
                const filtered = selectedRoute === 'Todas' ? ready : ready.filter(s => { 
                    if (s.regionOverride) return s.regionOverride === selectedRoute;
                    const c = clients.find(cl => cl.id === s.clientId); 
                    const region = c?.region || c?.route; 
                    return region === selectedRoute; 
                }); 
                setRouteSales(filtered); 
            }, [sales, selectedRoute, clients]);
            
            // Extrai rotas 칰nicas
            const routes = [...new Set(clients.map(c => c.region || c.route).filter(Boolean))];
            
            // Reordenar (Drag & Drop simulado com setas)
            const moveOrder = (index, direction) => { 
                const newOrder = [...routeSales]; 
                if (direction === 'up' && index > 0) { 
                    [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]]; 
                } else if (direction === 'down' && index < newOrder.length - 1) { 
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]; 
                } 
                setRouteSales(newOrder); 
            };
            
            // GERA O LINK PARA O MOTORISTA
            const generateDriverLink = () => { 
                if (routeSales.length === 0) return alert("Nada para entregar!"); 
                
                const payload = { 
                    route: selectedRoute, 
                    companyPhone, 
                    generatedAt: new Date(), 
                    orders: routeSales.map(s => { 
                        const c = clients.find(cl => cl.id === s.clientId); 
                        let finalPay = s.payMethod;
                        if (s.isPaid) finalPay += " (J츼 PAGO)";

                        return { 
                            id: s.id, 
                            customer: c.name, 
                            phone: c.phone, 
                            phone2: c.phone2, 
                            address: c.address, 
                            district: c.district, 
                            region: s.regionOverride || c.region, 
                            map: c.mapLink, 
                            total: s.total, 
                            pay: finalPay, 
                            change: s.changeFor ? s.changeFor - s.total : 0, 
                            obs: s.obs, 
                            clientObs: c.obs, 
                            isPaid: s.isPaid, 
                            gift: s.gift
                        }; 
                    }) 
                }; 
                
                // Codifica em Base64 para URL
                const encoded = encodeURIComponent(btoa(JSON.stringify(payload))); 
                const link = `${window.location.origin}${window.location.pathname}#driver=${encoded}`; 
                
                // Tenta copiar para o clipboard
                const copyToClipboardFallback = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); alert("LINK COPIADO! Envie para o motorista."); } catch (err) { prompt("Copie o link:", text); } document.body.removeChild(textArea); }; 
                if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(link).then(() => alert("LINK COPIADO! Envie para o motorista.")).catch(() => copyToClipboardFallback(link)); } else { copyToClipboardFallback(link); } 
            };
            
            // For칞a entrega manual (Admin)
            const forceDelivery = (id) => { if (confirm("Marcar entregue manualmente?")) setSales(sales.map(s => s.id === id ? { ...s, status: 'Entregue' } : s)); };
            
            const totalValue = routeSales.reduce((acc, s) => acc + s.total, 0);

            // PROCESSAMENTO DE RETORNO (TEXTO)
            const processReturnReport = () => {
                const lines = importText.split('\n');
                let updatedCount = 0;
                let newSales = [...sales];
                let newProducts = [...products];

                lines.forEach(line => {
                    const idMatch = line.match(/ID:\s*#?(\S+)/);
                    const statusMatch = line.match(/STATUS:\s*(\w+)/);
                    const payMatch = line.match(/PGTO:\s*([A-Za-z-칰\s]+)/);

                    if (idMatch && statusMatch) {
                        const id = idMatch[1];
                        const status = statusMatch[1].toUpperCase() === 'ENTREGUE' ? 'Entregue' : 
                                       statusMatch[1].toUpperCase() === 'CANCELADO' ? 'Cancelado' : null;
                        const payMethod = payMatch ? payMatch[1].trim() : null;

                        if (status) {
                            const saleIndex = newSales.findIndex(s => s.id === id);
                            if (saleIndex > -1) {
                                const sale = newSales[saleIndex];
                                // Se for cancelamento, devolve ao estoque
                                if (status === 'Cancelado' && sale.status !== 'Cancelado') {
                                     sale.items.forEach(item => {
                                        const dbProd = newProducts.find(p => p.id === item.id);
                                        if (dbProd) {
                                            if (dbProd.isCombo) { 
                                                item.comboItems?.forEach(ing => { 
                                                    const dbIng = newProducts.find(p => p.id === ing.id); 
                                                    if (dbIng) { dbIng.stock += ing.qty; dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_DRIVER', qty: ing.qty }); } 
                                                }); 
                                            } else { dbProd.stock += 1; dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_DRIVER', qty: 1 }); }
                                        }
                                     });
                                }
                                newSales[saleIndex] = { ...sale, status, payMethod: payMethod || sale.payMethod };
                                updatedCount++;
                            }
                        }
                    }
                });
                
                if (updatedCount > 0) {
                    setSales(newSales); setProducts(newProducts); setImportText(''); setShowImport(false); alert(`${updatedCount} pedidos atualizados com sucesso!`);
                } else { alert("Nenhum pedido processado. Verifique o formato do texto."); }
            };

            return (
                <div className="p-4 lg:p-6 pb-20 max-w-5xl mx-auto h-full overflow-y-auto">
                    {/* TOOLBAR */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div className="flex gap-4 items-center w-full md:w-auto">
                            <span className="font-bold text-gray-500 uppercase text-xs shrink-0">Filtrar Rota:</span>
                            <select className="border rounded-lg p-2 bg-gray-50 outline-none w-full md:w-auto text-sm" value={selectedRoute} onChange={e => setSelectedRoute(e.target.value)}>
                                <option value="Todas">Todas as Rotas</option>
                                {routes.map(r => <option key={r} value={r}>{r}</option>)}
                            </select>
                        </div>
                        <div className="flex items-center gap-4 w-full md:w-auto justify-between">
                            <div className="text-right">
                                <div className="text-xs text-gray-400 font-bold uppercase">Total da Carga</div>
                                <div className="text-2xl font-bold text-green-700">{formatCurrency(totalValue)}</div>
                            </div>
                            <button onClick={() => setShowImport(true)} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 flex items-center gap-2 shadow-sm">
                                <Upload size={16}/> PROCESSAR BAIXA
                            </button>
                        </div>
                    </div>

                    {/* LISTA DE ENTREGAS */}
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col mb-20">
                        <div className="p-3 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center">
                            <span className="font-bold text-indigo-900 text-sm flex items-center gap-2"><Truck size={16}/> {routeSales.length} Entregas na Lista</span>
                            <button onClick={generateDriverLink} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-indigo-700 transition shadow flex items-center gap-2">
                                <Share2 size={16}/> GERAR LINK MOTORISTA
                            </button>
                        </div>
                        <div className="overflow-y-auto p-2 space-y-2 bg-gray-50 max-h-[600px]">
                            {routeSales.length === 0 && <div className="p-8 text-center text-gray-400">Nenhuma entrega pronta para esta rota.</div>}
                            {routeSales.map((s, idx) => { 
                                const client = clients.find(c => c.id === s.clientId) || {}; 
                                return (
                                    <div key={s.id} className="bg-white p-3 rounded-lg border shadow-sm flex gap-4 items-center group hover:shadow-md transition">
                                        <div className="flex flex-col gap-1">
                                            <button onClick={() => moveOrder(idx, 'up')} className="p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-indigo-600"><ArrowUp size={14}/></button>
                                            <span className="font-bold text-sm text-center text-indigo-600 w-6">{idx + 1}</span>
                                            <button onClick={() => moveOrder(idx, 'down')} className="p-1 hover:bg-gray-100 rounded text-gray-400 hover:text-indigo-600"><ArrowDown size={14}/></button>
                                        </div>
                                        <div className="flex-1">
                                            <div className="flex justify-between">
                                                <h4 className="font-bold text-gray-800">{client.name}</h4>
                                                <span className="font-mono text-xs bg-gray-100 px-2 rounded text-gray-500 py-0.5">#{s.id}</span>
                                            </div>
                                            <p className="text-sm text-gray-500">{client.address}, {client.district}</p>
                                            <div className="flex flex-wrap gap-2 mt-2 text-xs">
                                                <span className="bg-blue-50 text-blue-700 px-2 py-0.5 rounded font-medium border border-blue-100">{s.payMethod}{s.isPaid ? ' (PAGO)' : ''}</span>
                                                <span className="bg-green-50 text-green-700 px-2 py-0.5 rounded font-bold border border-green-100">{formatCurrency(s.total)}</span>
                                                {s.gift && s.gift !== 'Nenhum' && <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold flex items-center gap-1 border border-purple-200"><Gift size={10}/> {s.gift}</span>}
                                            </div>
                                        </div>
                                        <button onClick={() => forceDelivery(s.id)} className="p-3 bg-gray-50 hover:bg-green-100 text-gray-300 hover:text-green-600 rounded-full transition" title="Baixa Manual">
                                            <CheckCircle size={24}/>
                                        </button>
                                    </div>
                                ); 
                            })}
                        </div>
                    </div>

                    {/* MODAL DE IMPORTA칂츾O */}
                    {showImport && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-in">
                            <div className="bg-white w-full max-w-lg rounded-xl p-6 shadow-2xl">
                                <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Upload size={20}/> Processar Retorno</h3>
                                <p className="text-xs text-gray-500 mb-2">Cole aqui o relat칩rio enviado pelo motorista no WhatsApp para dar baixa automaticamente.</p>
                                <textarea className="w-full h-48 border rounded p-3 text-xs font-mono mb-4 bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none" placeholder="Ex: RELAT칍RIO DE ENTREGA... ID: #001 | STATUS: ENTREGUE..." value={importText} onChange={e => setImportText(e.target.value)} />
                                <div className="flex gap-2">
                                    <button onClick={() => setShowImport(false)} className="flex-1 bg-gray-200 py-3 rounded-lg font-bold text-gray-600 hover:bg-gray-300 transition">Cancelar</button>
                                    <button onClick={processReturnReport} className="flex-1 bg-green-600 hover:bg-green-700 py-3 rounded-lg font-bold text-white transition shadow-lg">PROCESSAR BAIXA</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }
        
        // --- VIS츾O DO MOTORISTA (MOBILE APP) ---
        function DriverView({ data, onExit }) {
          const [deliveryModal, setDeliveryModal] = useState(null); 
          const [filter, setFilter] = useState('Todas'); 
          const [deliveryResults, setDeliveryResults] = useState({}); // Estado local das entregas

          if (!data) return <div className="p-10 text-center text-gray-500 font-bold">Link inv치lido ou expirado.</div>;
          
          const companyPhone = data.companyPhone || '5565999999999';
          const uniqueRegions = [...new Set(data.orders.map(o => o.region || 'Geral').filter(Boolean))]; 
          const regions = ['Todas', ...uniqueRegions]; 
          const showChips = uniqueRegions.length > 1;

          const filteredOrders = filter === 'Todas' ? data.orders : data.orders.filter(o => (o.region || 'Geral') === filter);
          
          // Ordena para jogar os finalizados para o final
          const visibleOrders = [...filteredOrders].sort((a, b) => { 
             const aDone = !!deliveryResults[a.id];
             const bDone = !!deliveryResults[b.id];
             if (aDone === bDone) return 0;
             return aDone ? 1 : -1;
          });

          const sendToCustomer = (phone, msg) => { 
             if(!phone) return alert("Telefone n칚o cadastrado.");
             const cleanPhone = phone.replace(/\D/g,''); 
             window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank'); 
          };

          const handleDeliveryConfirm = (method) => { 
            if (!deliveryModal) return; 
            const order = deliveryModal; 
            setDeliveryResults(prev => ({ ...prev, [order.id]: { status: 'Entregue', payMethod: method } })); 
            setDeliveryModal(null); 
          };

          const handleCancelDelivery = (order) => {
              if(confirm("Deseja realmente CANCELAR esta entrega? O produto voltar치 ao estoque.")) {
                  setDeliveryResults(prev => ({ ...prev, [order.id]: { status: 'Cancelado', payMethod: '-' } }));
              }
          };

          const generateFinalReport = () => {
              let report = `RELAT칍RIO DE ENTREGA - ${new Date().toLocaleDateString()}\n--------------------------------\n`;
              Object.entries(deliveryResults).forEach(([id, res]) => {
                  report += `ID: ${id} | STATUS: ${res.status.toUpperCase()} | PGTO: ${res.payMethod}\n`;
              });
              
              // Tenta copiar e abre WhatsApp
              const copyFallback = () => {
                   const textArea = document.createElement("textarea");
                   textArea.value = report;
                   document.body.appendChild(textArea);
                   textArea.select();
                   document.execCommand('copy');
                   document.body.removeChild(textArea);
              };

              try { navigator.clipboard.writeText(report).catch(copyFallback); } catch(e) { copyFallback(); }
              
              alert("RELAT칍RIO COPIADO! Cole no WhatsApp da empresa.");
              window.open(`https://wa.me/55${companyPhone}?text=${encodeURIComponent(report)}`, '_blank');
          };

          const completedCount = Object.keys(deliveryResults).length;
          const progress = Math.round((completedCount / data.orders.length) * 100); 
          const allFinished = completedCount === data.orders.length;

          return (
            <div className="h-screen flex flex-col bg-gray-50 text-gray-800">
               {/* Header Motorista */}
               <header className="bg-indigo-700 text-white p-4 shrink-0 shadow-md z-10">
                 <div className="flex justify-between items-center mb-2">
                    <h1 className="font-bold text-lg">ROTA: {data.route}</h1>
                    <button onClick={onExit} className="text-xs bg-indigo-800 px-3 py-1.5 rounded-lg hover:bg-indigo-900 transition font-bold border border-indigo-600">SAIR</button>
                 </div>
                 {showChips && (
                     <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin mb-1">
                         {regions.map(r => (
                             <button key={r} onClick={() => setFilter(r)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition border ${filter === r ? 'bg-white text-indigo-700 border-white' : 'bg-indigo-800 text-indigo-200 border-indigo-600'}`}>{r}</button>
                         ))}
                     </div>
                 )}
                 <div className="flex justify-between items-end mt-2">
                    <div className="text-xs opacity-80 font-mono"><span>{completedCount}/{data.orders.length} Entregas</span></div>
                    <div className="w-1/2 bg-indigo-900 rounded-full h-1.5 overflow-hidden"><div className="bg-green-400 h-full transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                 </div>
               </header>
               
               {/* Lista de Cards Mobile */}
               <div className="flex-1 overflow-y-auto p-4 space-y-6 pb-32">
                  {visibleOrders.map((order) => {
                    const result = deliveryResults[order.id];
                    const isDone = !!result;
                    const isCancelled = result?.status === 'Cancelado';
                    const clientFirstName = order.customer.split(' ')[0];
                    
                    return (
                        <div key={order.id} className={`rounded-xl shadow-sm border overflow-hidden relative transition-all duration-300 ${isDone ? 'bg-gray-100 border-gray-200 opacity-80 grayscale-[0.5]' : 'bg-white border-indigo-100'}`}>
                            {/* Status Badge */}
                            {isDone && (
                                <div className={`absolute top-0 right-0 z-20 px-3 py-1 rounded-bl-xl font-bold text-[10px] text-white shadow-sm flex items-center gap-1 ${isCancelled ? 'bg-red-600' : 'bg-green-600'}`}>
                                    {isCancelled ? <XCircle size={12}/> : <CheckCircle size={12}/>} {result.status.toUpperCase()}
                                </div>
                            )}

                            {/* Card Header */}
                            <div className={`p-3 border-b flex justify-between items-center ${isDone ? 'bg-gray-200' : 'bg-indigo-50'}`}>
                                <span className={`font-bold px-3 py-1 rounded-full text-sm shadow-sm ${isDone ? 'bg-gray-300 text-gray-600' : 'text-indigo-900 bg-white border border-indigo-100'}`}>#{order.id}</span>
                                {!isDone && <span className="font-bold text-indigo-900 text-xs uppercase tracking-wider">Pendente</span>}
                            </div>

                            {/* Card Body */}
                            <div className="p-4">
                                <h2 className="font-bold text-xl text-gray-800 mb-1 leading-tight">{order.customer}</h2>
                                <p className="text-gray-600 text-sm mb-4 flex items-start gap-1">
                                    <MapPin size={16} className="mt-0.5 shrink-0 text-gray-400"/> {order.address}, {order.district}
                                </p>
                                
                                {/* A칞칫es R치pidas */}
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <a href={`tel:${order.phone}`} className="flex flex-col items-center justify-center bg-gray-50 py-3 rounded-lg border border-gray-100 active:scale-95 transition hover:bg-gray-100">
                                        <Phone size={20} className="text-gray-700 mb-1"/>
                                        <span className="text-[10px] font-bold text-gray-600">LIGAR COMP.</span>
                                    </a>
                                    {order.phone2 ? (
                                        <a href={`tel:${order.phone2}`} className="flex flex-col items-center justify-center bg-blue-50 py-3 rounded-lg border border-blue-100 active:scale-95 transition hover:bg-blue-100">
                                            <Phone size={20} className="text-blue-700 mb-1"/>
                                            <span className="text-[10px] font-bold text-blue-600">LIGAR RECEB.</span>
                                        </a>
                                    ) : (
                                        <div className="flex flex-col items-center justify-center bg-gray-50 py-3 rounded-lg border border-gray-100 opacity-50 cursor-not-allowed">
                                            <Phone size={20} className="text-gray-300 mb-1"/>
                                            <span className="text-[10px] font-bold text-gray-400">SEM 2췈 TEL</span>
                                        </div>
                                    )}
                                </div>

                                <div className="grid grid-cols-3 gap-2 mb-4">
                                    <button onClick={() => sendToCustomer(order.phone, `Ol치 ${clientFirstName}! Sua entrega chega em aproximadamente 10 minutos. 游뚴`)} className="flex flex-col items-center justify-center bg-blue-50 py-3 rounded-lg border border-blue-100 active:scale-95 transition hover:bg-blue-100">
                                        <Clock size={20} className="text-blue-600 mb-1"/>
                                        <span className="text-[10px] font-bold text-blue-700">10 MIN</span>
                                    </button>
                                    <button onClick={() => sendToCustomer(order.phone, `Ol치 ${clientFirstName}! O entregador chegou e est치 aguardando. 游`)} className="flex flex-col items-center justify-center bg-yellow-50 py-3 rounded-lg border border-yellow-100 active:scale-95 transition hover:bg-yellow-100">
                                        <Home size={20} className="text-yellow-600 mb-1"/>
                                        <span className="text-[10px] font-bold text-yellow-700">CHEGUEI</span>
                                    </button>
                                    <a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(order.address + ', ' + order.district)}`} target="_blank" className="flex flex-col items-center justify-center bg-green-50 py-3 rounded-lg border border-green-100 active:scale-95 transition hover:bg-green-100">
                                        <MapPin size={20} className="text-green-600 mb-1"/>
                                        <span className="text-[10px] font-bold text-green-700">GPS</span>
                                    </a>
                                </div>

                                {/* Bot칫es de Finaliza칞칚o */}
                                <div className="flex gap-2">
                                    {isDone ? (
                                        <button disabled className="w-full bg-gray-100 text-gray-400 border border-gray-200 py-3 rounded-lg font-bold text-sm flex items-center justify-center gap-2 cursor-not-allowed">
                                            <CheckCircle size={18}/> FINALIZADO
                                        </button>
                                    ) : (
                                        <>
                                            <button onClick={() => handleCancelDelivery(order)} className="w-1/3 bg-red-50 text-red-600 py-3 rounded-lg font-bold text-sm hover:bg-red-100 flex items-center justify-center border border-red-100 transition active:scale-95">
                                                <XCircle size={18}/>
                                            </button>
                                            <button onClick={() => setDeliveryModal(order)} className="flex-1 bg-emerald-600 text-white py-3 rounded-lg font-bold text-sm hover:bg-emerald-700 flex items-center justify-center gap-2 shadow-lg shadow-emerald-200 active:scale-95 transition">
                                                <CheckCircle size={18}/> ENTREGAR
                                            </button>
                                        </>
                                    )}
                                </div>

                                {/* Resumo Financeiro */}
                                <div className={`p-3 rounded-lg text-sm mt-3 border ${isDone ? 'bg-gray-100 border-gray-200 text-gray-500' : 'bg-gray-50 border-gray-100'}`}>
                                    <div className="flex justify-between mb-1">
                                        <span className="text-gray-500 text-xs uppercase font-bold">Pagamento Previsto</span>
                                        <span className="font-bold uppercase text-xs bg-white px-2 rounded border">{order.pay}</span>
                                    </div>
                                    <div className="flex justify-between items-center mb-1">
                                        <span className="text-gray-500 text-xs uppercase font-bold">Valor Total</span>
                                        <span className={`font-bold text-xl ${isDone ? 'text-gray-600' : 'text-green-700'}`}>{formatCurrency(order.total)}</span>
                                    </div>
                                    {order.change > 0 && <div className="text-xs text-orange-600 font-bold mt-1 bg-orange-50 p-1 rounded border border-orange-100 text-center">Troco p/: {formatCurrency(order.change + order.total)}</div>}
                                </div>
                                {order.clientObs && <div className="text-xs text-purple-700 bg-purple-50 p-2 mt-2 rounded border border-purple-100 font-medium">丘멆잺 {order.clientObs}</div>}
                            </div>
                        </div>
                    ); 
                  })}
               </div>

               {/* MODAL DE CONFIRMA칂츾O (MOBILE) */}
               {deliveryModal && (
                   <div className="fixed inset-0 bg-black/80 z-50 flex items-end justify-center sm:items-center p-4 animate-in">
                       <div className="bg-white w-full max-w-sm rounded-2xl p-4 shadow-2xl">
                           <div className="flex justify-between items-center mb-4 border-b pb-2">
                               <h3 className="font-bold text-lg text-gray-800">Confirmar Recebimento</h3>
                               <button onClick={() => setDeliveryModal(null)} className="bg-gray-100 p-1 rounded-full"><XCircle size={20}/></button>
                           </div>
                           <p className="text-sm text-center text-gray-500 mb-4">Como o cliente pagou?</p>
                           <div className="grid grid-cols-2 gap-3 mb-2">
                               <button onClick={() => handleDeliveryConfirm('DINHEIRO')} className="bg-green-50 border border-green-100 text-green-800 p-4 rounded-xl font-bold flex flex-col items-center gap-1 hover:bg-green-100 active:scale-95 transition">
                                   <DollarSign size={24}/> DINHEIRO
                               </button>
                               <button onClick={() => handleDeliveryConfirm('PIX')} className="bg-indigo-50 border border-indigo-100 text-indigo-800 p-4 rounded-xl font-bold flex flex-col items-center gap-1 hover:bg-indigo-100 active:scale-95 transition">
                                   <Share2 size={24}/> PIX
                               </button>
                               <button onClick={() => handleDeliveryConfirm('CART츾O')} className="bg-blue-50 border border-blue-100 text-blue-800 p-4 rounded-xl font-bold flex flex-col items-center gap-1 hover:bg-blue-100 active:scale-95 transition">
                                   <CreditCard size={24}/> CART츾O
                               </button>
                               <button onClick={() => handleDeliveryConfirm('S칍 ENTREGUE')} className="bg-gray-50 border border-gray-100 text-gray-800 p-4 rounded-xl font-bold flex flex-col items-center gap-1 hover:bg-gray-100 active:scale-95 transition">
                                   <CheckCircle size={24}/> J츼 PAGO
                               </button>
                           </div>
                       </div>
                   </div>
               )}
               
               {/* BOT츾O FLUTUANTE DE RELAT칍RIO FINAL */}
               {allFinished && (
                   <div className="fixed bottom-0 left-0 w-full p-4 bg-white border-t shadow-[0_-5px_20px_-5px_rgba(0,0,0,0.1)] z-40 animate-in">
                       <button onClick={generateFinalReport} className="w-full bg-green-600 text-white font-bold py-4 rounded-xl text-lg shadow-xl hover:bg-green-700 flex items-center justify-center gap-2 active:scale-[0.98] transition">
                           <MessageSquare size={24}/> FINALIZAR E ENVIAR
                       </button>
                   </div>
               )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
