<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo Logística (Micro-frontend)</title>
    
    <!-- 1. TAILWIND CSS (PROTOCOL) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 
                            850: '#151e2e', 
                            900: '#0f172a' 
                        },
                        primary: { 
                            600: '#0284c7', 
                            700: '#0369a1' 
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'sharp': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'input': '0 1px 2px 0 rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    
    <!-- 2. GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- 3. ESTILOS GLOBAIS (PROTOCOL) -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Scrollbar */
        .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #e2e8f0; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; border: 2px solid #e2e8f0; }
        
        /* Botões Protocolo */
        .btn-primary {
            background-color: #0f172a; color: white;
            padding: 0.65rem 1.25rem; border-radius: 0.375rem;
            font-size: 0.875rem; font-weight: 600; letter-spacing: 0.025em;
            transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        .btn-primary:hover { background-color: #1e293b; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background-color: #ffffff; border: 1px solid #cbd5e1; color: #334155;
            padding: 0.65rem 1.25rem; border-radius: 0.375rem;
            font-size: 0.875rem; font-weight: 600;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            text-transform: uppercase;
        }
        .btn-secondary:hover { background-color: #f8fafc; border-color: #94a3b8; color: #0f172a; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.2s ease-out; }
    </style>

    <!-- 4. IMPORTMAP -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- 5. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-900">
    
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Truck, MapPin, Navigation, Phone, CheckCircle, XCircle, 
          ArrowUp, ArrowDown, Share2, Upload, DollarSign, CreditCard, 
          MessageSquare, Menu, X, Gift, Home, Clock
        } from 'lucide-react';

        // --- UTILS ---
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        // --- APP CONTAINER ---
        function App() {
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [companyPhone] = useStickyState('db_config_phone', '5565999999999'); 
          
          const [viewMode, setViewMode] = useState('dashboard');
          const [driverData, setDriverData] = useState(null);

          // Hash Routing (Driver Link)
          useEffect(() => {
            const checkHash = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#driver=')) {
                  try {
                    const encoded = hash.replace('#driver=', '');
                    const decoded = JSON.parse(atob(decodeURIComponent(encoded)));
                    setDriverData(decoded);
                    setViewMode('driver');
                  } catch (e) {
                    console.error("Link inválido", e);
                    alert("Erro ao abrir link do entregador.");
                  }
                } else {
                    if (viewMode === 'driver') setViewMode('dashboard');
                }
            };
            checkHash();
            window.addEventListener('hashchange', checkHash);
            return () => window.removeEventListener('hashchange', checkHash);
          }, []);

          if (viewMode === 'driver') {
              return <DriverView data={driverData} onExit={() => { window.location.hash = ''; setViewMode('dashboard'); }} />;
          }

          return (
            <div className="h-screen bg-slate-100 font-sans text-slate-900 overflow-hidden relative flex flex-col">
                <LogisticsHeader sales={sales} />
                <LogisticsManager 
                    sales={sales} setSales={setSales} 
                    clients={clients} companyPhone={companyPhone}
                    products={products} setProducts={setProducts} 
                />
            </div>
          );
        }

        // --- HEADER COMPONENT ---
        function LogisticsHeader({ sales }) {
            const routeCount = sales.filter(s => s.status === 'Rota').length;

            return (
                <header className="h-16 bg-white border-b border-slate-300 px-6 flex items-center justify-between shrink-0 shadow-sm z-20">
                    <div className="flex items-center gap-3">
                        <div className="h-8 w-1 bg-slate-900 rounded-full"></div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-900 leading-tight uppercase tracking-tight">Logística</h2>
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Gestão de Rotas</p>
                        </div>
                    </div>
                    <div className="flex gap-4">
                        <div className="text-right">
                            <span className="block text-[10px] font-bold text-slate-400 uppercase">Na Rua</span>
                            <span className="block text-lg font-bold text-primary-600 leading-none">{routeCount} Entregas</span>
                        </div>
                    </div>
                </header>
            );
        }

        // --- MANAGER DASHBOARD ---
        function LogisticsManager({ sales, setSales, clients, companyPhone, products, setProducts }) {
            const [selectedRoute, setSelectedRoute] = useState('Todas');
            const [routeSales, setRouteSales] = useState([]); 
            const [showImport, setShowImport] = useState(false);
            const [importText, setImportText] = useState('');

            // Filter Logic
            useEffect(() => { 
                const ready = sales.filter(s => s.status === 'Rota'); 
                const filtered = selectedRoute === 'Todas' ? ready : ready.filter(s => { 
                    if (s.regionOverride) return s.regionOverride === selectedRoute;
                    const c = clients.find(cl => cl.id === s.clientId); 
                    const region = c?.region || c?.route; 
                    return region === selectedRoute; 
                }); 
                setRouteSales(filtered); 
            }, [sales, selectedRoute, clients]);
            
            const routes = [...new Set(clients.map(c => c.region || c.route).filter(Boolean))];
            
            // Reorder
            const moveOrder = (index, direction) => { 
                const newOrder = [...routeSales]; 
                if (direction === 'up' && index > 0) { 
                    [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]]; 
                } else if (direction === 'down' && index < newOrder.length - 1) { 
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]; 
                } 
                setRouteSales(newOrder); 
            };
            
            // Generate Link
            const generateDriverLink = () => { 
                if (routeSales.length === 0) return alert("Nada para entregar!"); 
                const payload = { 
                    route: selectedRoute, 
                    companyPhone, 
                    generatedAt: new Date(), 
                    orders: routeSales.map(s => { 
                        const c = clients.find(cl => cl.id === s.clientId) || {}; 
                        let finalPay = s.payMethod;
                        if (s.isPaid) finalPay += " (JÁ PAGO)";
                        return { 
                            id: s.id, 
                            customer: c.name || 'Consumidor', 
                            phone: c.phone, phone2: c.phone2, 
                            address: c.address, district: c.district, 
                            region: s.regionOverride || c.region, 
                            map: c.mapLink, total: s.total, 
                            pay: finalPay, change: s.changeFor ? s.changeFor - s.total : 0, 
                            obs: s.obs, clientObs: c.obs, isPaid: s.isPaid, gift: s.gift
                        }; 
                    }) 
                }; 
                const encoded = encodeURIComponent(btoa(JSON.stringify(payload))); 
                const link = `${window.location.origin}${window.location.pathname}#driver=${encoded}`; 
                
                const copyFallback = (text) => { const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert("LINK COPIADO!"); }; 
                if (navigator.clipboard) { navigator.clipboard.writeText(link).then(() => alert("LINK COPIADO!")).catch(() => copyFallback(link)); } else { copyFallback(link); } 
            };
            
            // Force Delivery
            const forceDelivery = (id) => { if (confirm("Confirmar baixa manual?")) setSales(sales.map(s => s.id === id ? { ...s, status: 'Entregue' } : s)); };
            
            // Process Return
            const processReturnReport = () => {
                const lines = importText.split('\n');
                let updatedCount = 0;
                let newSales = [...sales];
                let newProducts = [...products];

                lines.forEach(line => {
                    const idMatch = line.match(/ID:\s*#?(\S+)/);
                    const statusMatch = line.match(/STATUS:\s*(\w+)/);
                    const payMatch = line.match(/PGTO:\s*([A-Za-zÀ-ú\s]+)/);

                    if (idMatch && statusMatch) {
                        const id = idMatch[1];
                        const status = statusMatch[1].toUpperCase() === 'ENTREGUE' ? 'Entregue' : 
                                       statusMatch[1].toUpperCase() === 'CANCELADO' ? 'Cancelado' : null;
                        const payMethod = payMatch ? payMatch[1].trim() : null;

                        if (status) {
                            const saleIndex = newSales.findIndex(s => s.id === id);
                            if (saleIndex > -1) {
                                const sale = newSales[saleIndex];
                                if (status === 'Cancelado' && sale.status !== 'Cancelado') {
                                     sale.items.forEach(item => {
                                        const dbProd = newProducts.find(p => p.id === item.id);
                                        if (dbProd) {
                                            if (dbProd.isCombo) { 
                                                item.comboItems?.forEach(ing => { 
                                                    const dbIng = newProducts.find(p => p.id === ing.id); 
                                                    if (dbIng) { dbIng.stock += ing.qty; } 
                                                }); 
                                            } else { dbProd.stock += 1; }
                                        }
                                     });
                                }
                                newSales[saleIndex] = { ...sale, status, payMethod: payMethod || sale.payMethod };
                                updatedCount++;
                            }
                        }
                    }
                });
                
                if (updatedCount > 0) {
                    setSales(newSales); setProducts(newProducts); setImportText(''); setShowImport(false); alert(`${updatedCount} pedidos processados.`);
                } else { alert("Nenhum pedido processado."); }
            };

            const totalValue = routeSales.reduce((acc, s) => acc + s.total, 0);

            return (
                <div className="flex-1 overflow-y-auto p-6 bg-slate-100">
                    <div className="max-w-5xl mx-auto">
                        
                        {/* CONTROLS */}
                        <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-300 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <span className="text-[10px] font-bold text-slate-500 uppercase">Filtrar:</span>
                                <select className="input-field py-1.5 text-sm w-full md:w-48" value={selectedRoute} onChange={e => setSelectedRoute(e.target.value)}>
                                    <option value="Todas">Todas as Rotas</option>
                                    {routes.map(r => <option key={r} value={r}>{r}</option>)}
                                </select>
                            </div>
                            <div className="flex items-center gap-4 w-full md:w-auto justify-between">
                                <div className="text-right">
                                    <span className="block text-[10px] font-bold text-slate-400 uppercase">Total Carga</span>
                                    <span className="block text-xl font-bold text-slate-800 leading-none">{formatCurrency(totalValue)}</span>
                                </div>
                                <button onClick={() => setShowImport(true)} className="btn-secondary text-[10px]">
                                    <Upload size={14}/> BAIXA RÁPIDA
                                </button>
                            </div>
                        </div>

                        {/* LIST */}
                        <div className="bg-white rounded-lg shadow-sm border border-slate-300 overflow-hidden flex flex-col mb-12">
                            <div className="p-3 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                                <span className="font-bold text-slate-700 text-sm flex items-center gap-2 uppercase tracking-wide">
                                    <Truck size={16}/> {routeSales.length} Entregas
                                </span>
                                <button onClick={generateDriverLink} className="btn-primary text-[10px] py-1.5">
                                    <Share2 size={14}/> LINK MOTORISTA
                                </button>
                            </div>
                            <div className="overflow-y-auto p-2 space-y-2 bg-slate-100 max-h-[600px]">
                                {routeSales.length === 0 && <div className="p-8 text-center text-slate-400 text-sm font-bold uppercase">Sem entregas.</div>}
                                {routeSales.map((s, idx) => { 
                                    const client = clients.find(c => c.id === s.clientId) || {}; 
                                    return (
                                        <div key={s.id} className="bg-white p-3 rounded border border-slate-200 shadow-sm flex gap-4 items-center group hover:border-slate-300 transition">
                                            <div className="flex flex-col gap-1 items-center justify-center w-8">
                                                <button onClick={() => moveOrder(idx, 'up')} className="text-slate-300 hover:text-slate-600"><ArrowUp size={14}/></button>
                                                <span className="font-bold text-sm text-slate-800">{idx + 1}</span>
                                                <button onClick={() => moveOrder(idx, 'down')} className="text-slate-300 hover:text-slate-600"><ArrowDown size={14}/></button>
                                            </div>
                                            <div className="flex-1">
                                                <div className="flex justify-between mb-1">
                                                    <h4 className="font-bold text-slate-800 text-sm uppercase">{client.name}</h4>
                                                    <span className="font-mono text-[10px] font-bold bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200 text-slate-600">#{s.id}</span>
                                                </div>
                                                <p className="text-xs text-slate-500 uppercase font-medium">{client.address}, {client.district}</p>
                                                <div className="flex flex-wrap gap-2 mt-2">
                                                    <span className="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-[10px] font-bold border border-slate-200 uppercase">{s.payMethod}{s.isPaid ? ' (PAGO)' : ''}</span>
                                                    <span className="bg-primary-600 text-white px-1.5 py-0.5 rounded text-[10px] font-bold border border-primary-700">{formatCurrency(s.total)}</span>
                                                    {s.gift && s.gift !== 'Nenhum' && <span className="bg-amber-100 text-amber-800 px-1.5 py-0.5 rounded text-[10px] font-bold border border-amber-200 flex items-center gap-1"><Gift size={10}/> {s.gift}</span>}
                                                </div>
                                            </div>
                                            <button onClick={() => forceDelivery(s.id)} className="p-2 text-slate-300 hover:text-green-600 hover:bg-green-50 rounded transition" title="Baixa Manual">
                                                <CheckCircle size={20}/>
                                            </button>
                                        </div>
                                    ); 
                                })}
                            </div>
                        </div>

                        {/* MODAL IMPORT */}
                        {showImport && (
                            <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-in">
                                <div className="bg-white w-full max-w-lg rounded-lg p-6 shadow-2xl border border-slate-300">
                                    <h3 className="text-sm font-black uppercase text-slate-800 mb-4 flex items-center gap-2"><Upload size={16}/> Processar Retorno</h3>
                                    <textarea className="input-field h-48 font-mono text-xs mb-4 resize-none" placeholder="Cole o relatório do WhatsApp aqui..." value={importText} onChange={e => setImportText(e.target.value)} />
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowImport(false)} className="btn-secondary flex-1 justify-center text-xs">Cancelar</button>
                                        <button onClick={processReturnReport} className="btn-primary flex-1 justify-center text-xs bg-green-600 hover:bg-green-700">PROCESSAR BAIXA</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // --- DRIVER VIEW (Mobile optimized but Slate themed) ---
        function DriverView({ data, onExit }) {
          const [deliveryModal, setDeliveryModal] = useState(null); 
          const [filter, setFilter] = useState('Todas'); 
          const [deliveryResults, setDeliveryResults] = useState({});

          if (!data) return <div className="p-10 text-center text-slate-500 font-bold uppercase text-sm">Link expirado.</div>;
          
          const companyPhone = data.companyPhone || '5565999999999';
          const regions = ['Todas', ...new Set(data.orders.map(o => o.region || 'Geral').filter(Boolean))]; 
          const filteredOrders = filter === 'Todas' ? data.orders : data.orders.filter(o => (o.region || 'Geral') === filter);
          const visibleOrders = [...filteredOrders].sort((a, b) => { 
             const aDone = !!deliveryResults[a.id];
             const bDone = !!deliveryResults[b.id];
             return aDone === bDone ? 0 : aDone ? 1 : -1;
          });

          const sendToCustomer = (phone, msg) => { 
             if(!phone) return alert("Sem telefone.");
             window.open(`https://wa.me/55${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank'); 
          };

          const handleDeliveryConfirm = (method) => { 
            if (!deliveryModal) return; 
            setDeliveryResults(prev => ({ ...prev, [deliveryModal.id]: { status: 'Entregue', payMethod: method } })); 
            setDeliveryModal(null); 
          };

          const generateFinalReport = () => {
              let report = `RELATÓRIO DE ENTREGA - ${new Date().toLocaleDateString()}\n--------------------------------\n`;
              Object.entries(deliveryResults).forEach(([id, res]) => { report += `ID: ${id} | STATUS: ${res.status.toUpperCase()} | PGTO: ${res.payMethod}\n`; });
              const copy = (t) => { const el = document.createElement("textarea"); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); };
              try { navigator.clipboard.writeText(report).catch(() => copy(report)); } catch(e) { copy(report); }
              alert("COPIADO!");
              window.open(`https://wa.me/55${companyPhone}?text=${encodeURIComponent(report)}`, '_blank');
          };

          const completedCount = Object.keys(deliveryResults).length;
          const progress = Math.round((completedCount / data.orders.length) * 100); 

          return (
            <div className="h-screen flex flex-col bg-slate-100 text-slate-900 font-sans">
               {/* Mobile Header */}
               <header className="bg-slate-900 text-white p-4 shrink-0 shadow-md z-10">
                 <div className="flex justify-between items-center mb-2">
                    <h1 className="font-bold text-base uppercase tracking-wider">Rota: {data.route}</h1>
                    <button onClick={onExit} className="text-[10px] font-bold border border-slate-600 px-2 py-1 rounded hover:bg-slate-800">SAIR</button>
                 </div>
                 {regions.length > 1 && (
                     <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin mb-1">
                         {regions.map(r => (
                             <button key={r} onClick={() => setFilter(r)} className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase transition border ${filter === r ? 'bg-white text-slate-900 border-white' : 'bg-slate-800 text-slate-400 border-slate-700'}`}>{r}</button>
                         ))}
                     </div>
                 )}
                 <div className="flex justify-between items-end mt-2">
                    <div className="text-[10px] font-mono text-slate-400"><span>{completedCount}/{data.orders.length}</span></div>
                    <div className="w-1/2 bg-slate-800 rounded-full h-1 overflow-hidden"><div className="bg-green-500 h-full transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                 </div>
               </header>
               
               {/* Mobile List */}
               <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                  {visibleOrders.map((order) => {
                    const result = deliveryResults[order.id];
                    const isDone = !!result;
                    const isCancelled = result?.status === 'Cancelado';
                    
                    return (
                        <div key={order.id} className={`rounded-lg shadow-sm border overflow-hidden relative transition-all ${isDone ? 'bg-slate-200 border-slate-300 opacity-70 grayscale' : 'bg-white border-slate-300'}`}>
                            {isDone && (
                                <div className={`absolute top-0 right-0 z-20 px-3 py-1 rounded-bl-lg font-bold text-[10px] text-white flex items-center gap-1 ${isCancelled ? 'bg-red-600' : 'bg-green-600'}`}>
                                    {isCancelled ? <XCircle size={10}/> : <CheckCircle size={10}/>} {result.status.toUpperCase()}
                                </div>
                            )}

                            <div className="p-3 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                                <span className="font-mono font-bold text-xs text-slate-600 bg-white px-2 py-0.5 rounded border border-slate-200">#{order.id}</span>
                                {!isDone && <span className="font-bold text-slate-400 text-[10px] uppercase">Pendente</span>}
                            </div>

                            <div className="p-4">
                                <h2 className="font-black text-lg text-slate-800 mb-1 leading-tight uppercase">{order.customer}</h2>
                                <p className="text-slate-500 text-xs mb-4 flex items-start gap-1 font-medium uppercase">
                                    <MapPin size={14} className="mt-0.5 shrink-0 text-slate-400"/> {order.address}, {order.district}
                                </p>
                                
                                <div className="grid grid-cols-2 gap-2 mb-4">
                                    <a href={`tel:${order.phone}`} className="btn-secondary text-[10px] justify-center h-10 flex-col gap-0 leading-none">
                                        <Phone size={14} className="mb-0.5"/> LIGAR
                                    </a>
                                    <a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(order.address + ', ' + order.district)}`} target="_blank" className="btn-secondary text-[10px] justify-center h-10 flex-col gap-0 leading-none text-green-700 border-green-200 bg-green-50 hover:bg-green-100">
                                        <MapPin size={14} className="mb-0.5"/> GPS
                                    </a>
                                </div>

                                <div className="flex gap-2">
                                    {!isDone && (
                                        <>
                                            <button onClick={() => { if(confirm("CANCELAR ENTREGA?")) setDeliveryResults(prev => ({ ...prev, [order.id]: { status: 'Cancelado', payMethod: '-' } })); }} className="w-12 bg-red-50 text-red-600 rounded border border-red-200 flex items-center justify-center hover:bg-red-100">
                                                <XCircle size={18}/>
                                            </button>
                                            <button onClick={() => setDeliveryModal(order)} className="btn-primary flex-1 justify-center text-xs bg-green-600 hover:bg-green-700 border-transparent shadow-md">
                                                <CheckCircle size={16}/> ENTREGAR
                                            </button>
                                        </>
                                    )}
                                </div>

                                <div className="p-2 rounded mt-3 bg-slate-100 border border-slate-200 text-xs">
                                    <div className="flex justify-between mb-1">
                                        <span className="text-slate-400 font-bold uppercase text-[10px]">Pgto</span>
                                        <span className="font-bold uppercase text-slate-700">{order.pay}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-slate-400 font-bold uppercase text-[10px]">Valor</span>
                                        <span className="font-black text-lg text-slate-800">{formatCurrency(order.total)}</span>
                                    </div>
                                    {order.change > 0 && <div className="text-[10px] text-orange-600 font-bold mt-1 text-right">Troco p/: {formatCurrency(order.change + order.total)}</div>}
                                </div>
                            </div>
                        </div>
                    ); 
                  })}
               </div>

               {/* Mobile Modal */}
               {deliveryModal && (
                   <div className="fixed inset-0 bg-slate-900/80 z-50 flex items-end justify-center sm:items-center p-4 animate-in">
                       <div className="bg-white w-full max-w-sm rounded-t-xl sm:rounded-xl p-6 shadow-2xl">
                           <h3 className="font-bold text-lg text-slate-800 mb-4 text-center uppercase">Confirmar Pagamento</h3>
                           <div className="grid grid-cols-2 gap-3">
                               <button onClick={() => handleDeliveryConfirm('DINHEIRO')} className="p-3 rounded border border-slate-200 bg-slate-50 font-bold text-xs hover:bg-green-50 hover:text-green-800 hover:border-green-200 transition">DINHEIRO</button>
                               <button onClick={() => handleDeliveryConfirm('PIX')} className="p-3 rounded border border-slate-200 bg-slate-50 font-bold text-xs hover:bg-indigo-50 hover:text-indigo-800 hover:border-indigo-200 transition">PIX</button>
                               <button onClick={() => handleDeliveryConfirm('CARTÃO')} className="p-3 rounded border border-slate-200 bg-slate-50 font-bold text-xs hover:bg-blue-50 hover:text-blue-800 hover:border-blue-200 transition">CARTÃO</button>
                               <button onClick={() => handleDeliveryConfirm('JÁ PAGO')} className="p-3 rounded border border-slate-200 bg-slate-50 font-bold text-xs hover:bg-slate-200 transition">JÁ PAGO</button>
                           </div>
                           <button onClick={() => setDeliveryModal(null)} className="mt-4 w-full py-3 text-xs font-bold text-slate-400 hover:text-slate-600">CANCELAR</button>
                       </div>
                   </div>
               )}
               
               {completedCount === data.orders.length && (
                   <div className="fixed bottom-0 left-0 w-full p-4 bg-white border-t border-slate-200 z-40 animate-in">
                       <button onClick={generateFinalReport} className="btn-primary w-full py-4 text-sm justify-center bg-green-600 hover:bg-green-700 border-transparent shadow-xl">
                           <MessageSquare size={18}/> ENVIAR RELATÓRIO
                       </button>
                   </div>
               )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
