<!DOCTYPE html> 
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV DONA ANTONIA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal-active { overflow: hidden; }
        [onclick] { cursor: pointer; }
        i svg { width: 100%; height: 100%; }
        
        /* PRINT STYLES - Optimized for 76mm x 100mm */
        @media print {
            body * { visibility: hidden; }
            #receipt-print-area, #receipt-print-area * { visibility: visible; }
            #receipt-print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 76mm;
                margin: 0;
                padding: 2mm;
                background: white;
            }
            @page {
                size: 76mm 100mm;
                margin: 0;
            }
            .no-print { display: none !important; }
        }

        .receipt-text {
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            line-height: 1.2;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <div id="app" class="p-4 md:p-8 no-print">
        <!-- HEADER -->
        <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-slate-900 uppercase font-black">PDV DONA ANTONIA</h1>
                <p class="text-slate-500 font-medium">Gestão de Pedidos e Logística</p>
            </div>
            
            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                <!-- Importadores de Banco de Dados -->
                <div class="flex gap-1">
                    <input type="file" id="importClientsInput" class="hidden" accept=".json" onchange="importClients(event)">
                    <button onclick="document.getElementById('importClientsInput').click()" title="Importar Banco de Clientes" class="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-slate-600">
                        <i data-lucide="users" class="w-5 h-5"></i>
                    </button>
                    
                    <input type="file" id="importProductsInput" class="hidden" accept=".json" onchange="importProducts(event)">
                    <button onclick="document.getElementById('importProductsInput').click()" title="Importar Banco de Produtos" class="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-slate-600">
                        <i data-lucide="package" class="w-5 h-5"></i>
                    </button>
                </div>

                <div class="h-8 w-[1px] bg-slate-200 mx-1 hidden md:block"></div>

                <input type="file" id="importSalesInput" class="hidden" accept=".json" onchange="importSales(event)">
                <button onclick="document.getElementById('importSalesInput').click()" class="flex items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-sm font-medium">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    Vendas
                </button>
                <button onclick="exportSalesToJson()" class="flex items-center justify-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors shadow-sm text-sm font-medium">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    JSON
                </button>
                <button onclick="openModal()" class="flex items-center justify-center gap-2 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors shadow-md text-sm font-black uppercase tracking-wider">
                    <i data-lucide="shopping-cart" class="w-4 h-4"></i>
                    Novo Pedido
                </button>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="max-w-7xl mx-auto mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2 relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                <input 
                    type="text" 
                    id="searchInput"
                    placeholder="Buscar cliente, rota ou item..." 
                    class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500/20 shadow-sm"
                    oninput="renderSalesTable()"
                >
            </div>
            <select id="filterRoute" onchange="renderSalesTable()" class="px-4 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-emerald-500/20 shadow-sm font-bold text-slate-600 uppercase">
                <option value="">Todas as Rotas</option>
                <option value="COXIPO">COXIPO</option>
                <option value="VG">VG</option>
                <option value="CBA">CBA</option>
                <option value="CPA">CPA</option>
            </select>
        </div>

        <!-- SALES TABLE -->
        <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200">
                            <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-slate-400">Data</th>
                            <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-slate-400">Cliente</th>
                            <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-slate-400">Rota</th>
                            <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-slate-400">Pagamento</th>
                            <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-slate-400">Total</th>
                            <th class="px-6 py-4 text-xs font-bold uppercase tracking-wider text-slate-400 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>

        <div class="max-w-7xl mx-auto mt-6 flex justify-between items-center bg-white p-4 rounded-xl border border-slate-200">
            <div id="statsCount" class="text-xs font-black text-slate-400 uppercase tracking-widest">Total: 0 Vendas</div>
            <div id="statsRevenue" class="text-lg font-black text-emerald-600 uppercase">R$ 0,00</div>
        </div>
    </div>

    <!-- PDV MODAL -->
    <div id="saleModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-5xl max-h-[95vh] overflow-hidden flex flex-col animate-in zoom-in duration-200">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 id="modalTitle" class="text-xl font-black text-slate-800 tracking-tighter uppercase">Painel de Venda</h2>
                <div class="flex gap-2">
                    <button id="printBtn" onclick="printCurrentSale()" class="hidden flex items-center gap-2 px-4 py-2 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition-all font-bold text-sm uppercase">
                        <i data-lucide="printer" class="w-4 h-4"></i> Imprimir
                    </button>
                    <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 p-2">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 flex flex-col md:flex-row gap-6">
                <!-- CARRINHO -->
                <div class="flex-1 space-y-4">
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-2">
                            <select id="itemProductSelector" class="md:col-span-2 px-3 py-2 border border-slate-200 rounded-lg outline-none bg-white text-sm font-medium">
                                <option value="">Selecione o Produto...</option>
                            </select>
                            <input type="number" id="itemQty" value="1" min="1" class="px-3 py-2 border border-slate-200 rounded-lg outline-none text-sm text-center font-bold">
                            <button onclick="addItemToCart()" class="bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors px-3 py-2 text-xs font-black uppercase">
                                Adicionar
                            </button>
                        </div>
                    </div>

                    <div class="border border-slate-200 rounded-xl overflow-hidden bg-white">
                        <table class="w-full text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200 text-slate-400 uppercase text-[10px] font-black">
                                <tr>
                                    <th class="px-4 py-3 text-left">Produto</th>
                                    <th class="px-4 py-3 text-center">Qtd</th>
                                    <th class="px-4 py-3 text-right">Subtotal</th>
                                    <th class="px-4 py-3 text-right w-10"></th>
                                </tr>
                            </thead>
                            <tbody id="cartItemsBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- DADOS DA VENDA -->
                <div class="w-full md:w-80 space-y-4 bg-slate-50 p-5 rounded-xl border border-slate-200 h-fit">
                    <input type="hidden" id="saleId">
                    
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-wider">Cliente</label>
                        <select id="saleClient" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none bg-white text-sm font-bold"></select>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-wider">Rota</label>
                            <select id="saleRoute" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none bg-white text-xs font-bold">
                                <option value="COXIPO">COXIPO</option>
                                <option value="VG">VG</option>
                                <option value="CBA">CBA</option>
                                <option value="CPA">CPA</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-wider">Pagamento</label>
                            <select id="salePayment" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none bg-white text-xs font-bold">
                                <option value="DINHEIRO">DINHEIRO</option>
                                <option value="PIX">PIX</option>
                                <option value="CARTAO">CARTÃO</option>
                                <option value="PAGO">PAGO</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1 tracking-wider">Observações</label>
                        <textarea id="saleObs" rows="2" class="w-full px-3 py-2 border border-slate-200 rounded-lg outline-none text-sm resize-none" placeholder="Ex: Entregar após as 14h"></textarea>
                    </div>

                    <div class="pt-4 border-t border-slate-200">
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-xs font-black text-slate-400 uppercase">Total</span>
                            <span id="cartTotalDisplay" class="text-2xl font-black text-emerald-600 tracking-tighter">R$ 0,00</span>
                        </div>
                        <button onclick="handleSaveSale(event)" class="w-full py-4 bg-emerald-600 text-white rounded-xl font-black hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-500/20 uppercase tracking-widest">
                            Confirmar Pedido
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RECEIPT PRINT AREA (Hidden from screen) -->
    <div id="receipt-print-area" class="receipt-text">
        <!-- Content injected by JS -->
    </div>

    <!-- NOTIFICATION SYSTEM -->
    <div id="notification" class="hidden fixed bottom-6 right-6 z-[100] flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl transition-all translate-x-12 opacity-0">
        <span id="notificationIcon"></span>
        <span id="notificationMessage" class="font-medium"></span>
    </div>

    <script>
        // --- DATA KEYS ---
        const DB_SALES = 'dona_antonia_sales_db';
        const DB_CLIENTS = 'dona_antonia_clients_db';
        const DB_PRODUCTS = 'dona_antonia_products_db';

        // --- STATE ---
        let sales = JSON.parse(localStorage.getItem(DB_SALES)) || [];
        let clients = JSON.parse(localStorage.getItem(DB_CLIENTS)) || [];
        let products = JSON.parse(localStorage.getItem(DB_PRODUCTS)) || [];
        let currentCart = [];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            refreshIcons();
            renderSalesTable();
            populateSelectors();
        });

        function refreshIcons() {
            if (window.lucide) window.lucide.createIcons();
        }

        function populateSelectors() {
            const clientSel = document.getElementById('saleClient');
            const prodSel = document.getElementById('itemProductSelector');
            
            clientSel.innerHTML = '<option value="">Selecione o Cliente...</option>' + 
                clients.sort((a,b) => a.name.localeCompare(b.name)).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                
            prodSel.innerHTML = '<option value="">Selecione o Produto...</option>' + 
                products.sort((a,b) => a.name.localeCompare(b.name)).map(p => `<option value="${p.id}">${p.name} - R$ ${p.price.toFixed(2)}</option>`).join('');
        }

        // --- LOGIC ---
        function saveSalesToStorage() {
            localStorage.setItem(DB_SALES, JSON.stringify(sales));
            renderSalesTable();
        }

        function renderSalesTable() {
            const tbody = document.getElementById('salesTableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const routeFilter = document.getElementById('filterRoute').value;
            let totalRevenue = 0;

            const filtered = sales
                .filter(s => {
                    const matchSearch = s.clientName.toLowerCase().includes(search) || s.route.toLowerCase().includes(search);
                    const matchRoute = routeFilter ? s.route === routeFilter : true;
                    return matchSearch && matchRoute;
                })
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            tbody.innerHTML = filtered.map(s => {
                totalRevenue += s.total;
                return `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 text-[10px] font-mono font-bold text-slate-400">${new Date(s.date).toLocaleString()}</td>
                    <td class="px-6 py-4 font-bold text-slate-800">${s.clientName}</td>
                    <td class="px-6 py-4"><span class="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-[9px] font-black">${s.route}</span></td>
                    <td class="px-6 py-4"><span class="text-[9px] font-bold uppercase border border-slate-200 px-2 py-0.5 rounded">${s.payment}</span></td>
                    <td class="px-6 py-4 font-black text-emerald-600">R$ ${s.total.toFixed(2)}</td>
                    <td class="px-6 py-4 text-right">
                        <div class="flex justify-end gap-1">
                            <button onclick="viewSale('${s.id}')" class="text-indigo-600 hover:bg-indigo-50 p-2 rounded-lg transition-all"><i data-lucide="eye" class="w-4 h-4"></i></button>
                            <button onclick="deleteSale('${s.id}')" class="text-slate-300 hover:text-red-600 p-2 rounded-lg transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');

            document.getElementById('statsCount').innerText = `Total: ${filtered.length} Vendas`;
            document.getElementById('statsRevenue').innerText = `R$ ${totalRevenue.toFixed(2)}`;
            refreshIcons();
        }

        // --- CART ---
        function addItemToCart() {
            const prodId = document.getElementById('itemProductSelector').value;
            const qty = parseInt(document.getElementById('itemQty').value);
            if (!prodId || qty <= 0) return notify("Selecione um produto", "error");

            const product = products.find(p => p.id === prodId);
            const existing = currentCart.find(i => i.productId === prodId);

            if (existing) {
                existing.quantity += qty;
                existing.subtotal = existing.quantity * product.price;
            } else {
                currentCart.push({ productId: product.id, name: product.name, price: product.price, quantity: qty, subtotal: qty * product.price });
            }
            renderCart();
            document.getElementById('itemQty').value = 1;
        }

        function removeCartItem(idx) {
            currentCart.splice(idx, 1);
            renderCart();
        }

        function renderCart() {
            const body = document.getElementById('cartItemsBody');
            let total = 0;
            body.innerHTML = currentCart.map((item, idx) => {
                total += item.subtotal;
                return `<tr class="border-b border-slate-50">
                    <td class="px-4 py-2 font-bold text-slate-700 uppercase text-xs">${item.name}</td>
                    <td class="px-4 py-2 text-center font-mono font-black">${item.quantity}</td>
                    <td class="px-4 py-2 text-right font-black text-slate-800">R$ ${item.subtotal.toFixed(2)}</td>
                    <td class="px-4 py-2 text-right"><button onclick="removeCartItem(${idx})" class="text-red-300 hover:text-red-600"><i data-lucide="minus-circle" class="w-4 h-4"></i></button></td>
                </tr>`;
            }).join('');
            document.getElementById('cartTotalDisplay').innerText = `R$ ${total.toFixed(2)}`;
            refreshIcons();
        }

        // --- DATABASE IMPORTS ---
        function importClients(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (Array.isArray(data)) {
                        localStorage.setItem(DB_CLIENTS, JSON.stringify(data));
                        clients = data;
                        populateSelectors();
                        notify(`${data.length} Clientes Importados`);
                    }
                } catch (err) { notify("Falha ao importar Clientes", "error"); }
            };
            reader.readAsText(file);
        }

        function importProducts(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (Array.isArray(data)) {
                        localStorage.setItem(DB_PRODUCTS, JSON.stringify(data));
                        products = data;
                        populateSelectors();
                        notify(`${data.length} Produtos Importados`);
                    }
                } catch (err) { notify("Falha ao importar Produtos", "error"); }
            };
            reader.readAsText(file);
        }

        function importSales(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if (Array.isArray(data)) {
                        sales = data;
                        saveSalesToStorage();
                        notify("Vendas Importadas");
                    }
                } catch (err) { notify("Falha ao importar Vendas", "error"); }
            };
            reader.readAsText(file);
        }

        // --- ACTIONS ---
        function openModal() {
            document.getElementById('saleModal').classList.remove('hidden');
            document.getElementById('printBtn').classList.add('hidden');
            document.getElementById('saleId').value = '';
            document.getElementById('saleClient').disabled = false;
            currentCart = [];
            renderCart();
            refreshIcons();
        }

        function viewSale(id) {
            const sale = sales.find(s => s.id === id);
            if (!sale) return;
            openModal();
            document.getElementById('printBtn').classList.remove('hidden');
            document.getElementById('saleId').value = sale.id;
            document.getElementById('saleClient').value = sale.clientId;
            document.getElementById('saleRoute').value = sale.route;
            document.getElementById('salePayment').value = sale.payment;
            document.getElementById('saleObs').value = sale.obs || '';
            currentCart = [...sale.items];
            renderCart();
            document.getElementById('saleClient').disabled = true;
        }

        function closeModal() {
            document.getElementById('saleModal').classList.add('hidden');
        }

        function handleSaveSale(e) {
            e.preventDefault();
            const clientId = document.getElementById('saleClient').value;
            const id = document.getElementById('saleId').value;
            if (!clientId || currentCart.length === 0) return notify("Dados incompletos", "error");

            const client = clients.find(c => c.id === clientId);
            const total = currentCart.reduce((s, i) => s + i.subtotal, 0);

            const sale = {
                id: id || crypto.randomUUID(),
                clientId: client.id,
                clientName: client.name,
                route: document.getElementById('saleRoute').value,
                payment: document.getElementById('salePayment').value,
                obs: document.getElementById('saleObs').value,
                items: currentCart,
                total: total,
                date: id ? sales.find(s => s.id === id).date : new Date().toISOString()
            };

            if (id) sales = sales.map(s => s.id === id ? sale : s);
            else sales.push(sale);

            saveSalesToStorage();
            closeModal();
            notify("Pedido Salvo");
        }

        function deleteSale(id) {
            if (confirm("Remover venda?")) {
                sales = sales.filter(s => s.id !== id);
                saveSalesToStorage();
                notify("Venda excluída", "error");
            }
        }

        // --- PRINTING ENGINE ---
        function printCurrentSale() {
            const id = document.getElementById('saleId').value;
            const sale = sales.find(s => s.id === id);
            if (!sale) return;

            const printArea = document.getElementById('receipt-print-area');
            
            // Build Receipt Content
            let content = `
                <div style="text-align: center; border-bottom: 1px dashed black; padding-bottom: 5px; margin-bottom: 5px;">
                    <strong style="font-size: 14px;">DONA ANTONIA</strong><br>
                    <span>RECIBO DE ENTREGA</span>
                </div>
                <div>
                    <strong>DATA:</strong> ${new Date(sale.date).toLocaleString()}<br>
                    <strong>CLIENTE:</strong> ${sale.clientName}<br>
                    <strong>ROTA:</strong> ${sale.route}<br>
                </div>
                <div style="border-top: 1px dashed black; border-bottom: 1px dashed black; margin: 5px 0; padding: 5px 0;">
                    <table style="width: 100%; font-size: 11px;">
                        ${sale.items.map(i => `
                            <tr>
                                <td>${i.name}</td>
                                <td style="text-align: center;">${i.quantity}x</td>
                                <td style="text-align: right;">${i.subtotal.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </table>
                </div>
                <div style="text-align: right; font-weight: bold;">
                    TOTAL: R$ ${sale.total.toFixed(2)}<br>
                    PAGAMENTO: ${sale.payment}
                </div>
                <div style="margin-top: 10px; font-size: 10px;">
                    <strong>OBS:</strong> ${sale.obs || 'N/A'}
                </div>
                <div style="margin-top: 20px; text-align: center; font-size: 9px; border-top: 1px solid #ccc; padding-top: 5px;">
                    Assinatura do Recebedor: __________________
                </div>
            `;

            printArea.innerHTML = content;
            window.print();
        }

        function exportSalesToJson() {
            const blob = new Blob([JSON.stringify(sales, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `CADASTRO-VENDAS.json`;
            a.click();
            notify("Exportado");
        }

        function notify(message, type = 'success') {
            const toast = document.getElementById('notification');
            const icon = document.getElementById('notificationIcon');
            const msg = document.getElementById('notificationMessage');
            msg.innerText = message;
            toast.className = `fixed bottom-6 right-6 z-[100] flex items-center gap-3 px-5 py-3 rounded-xl shadow-2xl transition-all duration-300 opacity-100 translate-x-0 ${type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-900 text-white'}`;
            const iconName = type === 'error' ? 'alert-circle' : 'check-circle-2';
            icon.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 ${type !== 'error' ? 'text-emerald-400' : ''}"></i>`;
            refreshIcons();
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.classList.add('translate-x-12');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }
    </script>
</body>
</html>
