<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo PDV (Local-First Edition)</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        primary: { 600: '#0284c7', 700: '#0369a1' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    
    <!-- 2. GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #e2e8f0; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        
        .input-label {
            display: block; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 0.05em; font-weight: 800; color: #64748b; margin-bottom: 0.25rem;
        }
        
        .input-field {
            width: 100%; padding: 0.5rem 0.75rem; 
            background-color: #ffffff; 
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; color: #0f172a;
            outline: none; transition: all 0.15s;
        }
        .input-field:focus { border-color: #0284c7; box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.1); }
        
        .btn-primary {
            background-color: #0f172a; color: white;
            padding: 0.75rem 1.25rem; border-radius: 0.375rem;
            font-size: 0.875rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            transition: all 0.2s;
        }
        .btn-primary:hover { background-color: #1e293b; transform: translateY(-1px); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.15s ease-out; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-900">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          ShoppingCart, Search, Plus, Trash2, XCircle, 
          CreditCard, Wallet, User, MapPin, 
          CheckCircle, Box, Truck
        } from 'lucide-react';

        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 6).toUpperCase();
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        // --- APP ROOT ---
        function App() {
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [sales, setSales] = useStickyState('db_sales_v3', []);

          return (
            <div className="h-screen bg-slate-200 overflow-hidden relative">
                <POSView 
                    clients={clients} 
                    products={products} 
                    setProducts={setProducts} 
                    sales={sales} 
                    setSales={setSales} 
                />
            </div>
          );
        }

        // --- POS COMPONENT ---
        function POSView({ clients, products, setProducts, sales, setSales }) {
             // State
             const [selectedClient, setSelectedClient] = useState(null);
             const [clientSearch, setClientSearch] = useState('');
             const [cart, setCart] = useState([]);
             
             // Form fields
             const [saleRegion, setSaleRegion] = useState('');
             const [saleRoute, setSaleRoute] = useState('Rota 1');
             const [isPaid, setIsPaid] = useState(false);
             const [discount, setDiscount] = useState(0);
             const [payMethod, setPayMethod] = useState('Pix');
             const [obs, setObs] = useState(''); 
             
             // UI
             const [searchProd, setSearchProd] = useState('');
             const [selectedCategory, setSelectedCategory] = useState('todas');
             const [editingItem, setEditingItem] = useState(null);

             const filteredProducts = products.filter(p => 
                (selectedCategory === 'todas' || p.category === selectedCategory) && 
                (p.name.toLowerCase().includes(searchProd.toLowerCase()) || p.id.toLowerCase().includes(searchProd.toLowerCase()))
             );

             const categories = ['todas', ...new Set(products.map(p => p.category))];
             const subTotal = useMemo(() => cart.reduce((acc, item) => acc + Number(item.price), 0), [cart]);
             const totalFinal = Math.max(0, subTotal - discount);

             // Handle Client Selection
             const handleSelectClient = (client) => {
                 setSelectedClient(client);
                 setClientSearch(client.name);
                 setSaleRegion(client.region || 'Não informada');
             };

             const addToCart = (product) => {
                const cartItem = { 
                    ...product, 
                    tempId: Math.random().toString(36).substr(2, 9),
                    originalPrice: product.price
                };
                setCart([...cart, cartItem]);
             };

             const removeFromCart = (tempId) => {
                 setCart(cart.filter(item => item.tempId !== tempId));
             };

             const finalizeSale = () => {
                if (!selectedClient) return alert('Selecione um cliente primeiro.');
                if (cart.length === 0) return alert('O carrinho está vazio.');
                
                const newSale = {
                  id: generateId(), 
                  clientName: selectedClient.name,
                  items: cart,
                  total: totalFinal, 
                  route: saleRoute,
                  region: saleRegion,
                  date: new Date().toISOString(),
                  status: 'Finalizado'
                };
                
                setSales([...sales, newSale]);
                setCart([]);
                setSelectedClient(null);
                setClientSearch('');
                setSaleRegion('');
                alert('Venda finalizada com sucesso!');
             };

             const filteredClients = clients.filter(c => c.name.toLowerCase().includes(clientSearch.toLowerCase()));

             return (
                <div className="flex flex-col lg:flex-row h-full">
                    
                    {/* ESQUERDA: LISTAGEM TIPO PLANILHA */}
                    <div className="flex-1 flex flex-col bg-white lg:border-r border-slate-300 h-[55%] lg:h-full overflow-hidden">
                        <div className="p-4 border-b border-slate-200 bg-slate-50 shrink-0">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xs font-black text-slate-700 uppercase tracking-tighter flex items-center gap-2">
                                    <Box size={16} className="text-primary-600"/> Catálogo de Produtos
                                </h2>
                                <span className="text-[10px] bg-slate-200 px-2 py-0.5 rounded-full font-bold text-slate-600">
                                    {filteredProducts.length} Itens
                                </span>
                            </div>
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
                                    <input 
                                        className="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-md text-sm bg-white focus:border-primary-600 outline-none" 
                                        placeholder="Filtrar por nome ou código..." 
                                        value={searchProd} 
                                        onChange={e => setSearchProd(e.target.value)} 
                                    />
                                </div>
                                <select 
                                    className="border border-slate-300 rounded-md px-3 bg-white text-xs font-bold outline-none" 
                                    value={selectedCategory} 
                                    onChange={e => setSelectedCategory(e.target.value)}
                                >
                                    <option value="todas">Categorias</option>
                                    {categories.filter(c=>c!=='todas').map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-auto scrollbar-thin">
                            <table className="w-full text-left border-collapse table-fixed">
                                <thead className="bg-slate-100 text-slate-500 text-[10px] uppercase font-bold sticky top-0 z-10">
                                    <tr className="border-b border-slate-200">
                                        <th className="p-3 w-20">Código</th>
                                        <th className="p-3 w-auto">Nome do Produto</th>
                                        <th className="p-3 w-32">Categoria</th>
                                        <th className="p-3 w-24 text-right">Venda</th>
                                        <th className="p-3 w-24 text-center">Estoque</th>
                                        <th className="p-3 w-12"></th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm divide-y divide-slate-100">
                                    {filteredProducts.map(p => (
                                        <tr key={p.id} className="hover:bg-slate-50 cursor-pointer group transition-colors" onClick={() => addToCart(p)}>
                                            <td className="p-3 font-mono text-[11px] text-slate-400">{p.id || '---'}</td>
                                            <td className="p-3 font-semibold text-slate-800 truncate">{p.name}</td>
                                            <td className="p-3"><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-medium">{p.category}</span></td>
                                            <td className="p-3 text-right font-bold text-primary-700">{formatCurrency(p.price)}</td>
                                            <td className="p-3 text-center">
                                                <span className={`text-xs font-bold ${p.stock <= 5 ? 'text-red-600' : 'text-slate-600'}`}>{p.stock} un</span>
                                            </td>
                                            <td className="p-3 text-center">
                                                <button className="text-slate-300 group-hover:text-primary-600"><Plus size={18}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* DIREITA: CHECKOUT & LOGÍSTICA */}
                    <div className="w-full lg:w-[400px] flex flex-col bg-slate-50 border-t lg:border-t-0 lg:border-l border-slate-300 shadow-2xl shrink-0 h-[45%] lg:h-full">
                        
                        {/* Identificação Cliente */}
                        <div className="p-4 bg-white border-b border-slate-200 space-y-3">
                            <div>
                                <label className="input-label flex items-center gap-1"><User size={12}/> Cliente</label>
                                <div className="relative">
                                    <input 
                                        className={`w-full p-2.5 border rounded-md outline-none transition text-sm font-bold ${selectedClient ? 'bg-blue-50 border-blue-400 text-blue-900' : 'bg-white border-slate-300 text-slate-900'}`} 
                                        placeholder="Localizar cliente..." 
                                        value={clientSearch} 
                                        onChange={e => { setClientSearch(e.target.value); setSelectedClient(null); }} 
                                    />
                                    {clientSearch && !selectedClient && (
                                        <div className="absolute top-full left-0 w-full bg-white border border-slate-300 shadow-2xl max-h-40 overflow-y-auto z-50 rounded-b-md">
                                            {filteredClients.map(c => (
                                                <div key={c.id} className="p-2 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0" onClick={() => handleSelectClient(c)}>
                                                    <div className="font-bold text-xs text-slate-800">{c.name}</div>
                                                    <div className="text-[9px] text-slate-400">{c.city} - {c.region}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Info Região & Rota */}
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="input-label flex items-center gap-1"><MapPin size={12}/> Região</label>
                                    <div className="p-2 bg-slate-100 rounded border border-slate-200 text-[11px] font-bold text-slate-600 uppercase truncate">
                                        {saleRegion || 'Selecione o cliente'}
                                    </div>
                                </div>
                                <div>
                                    <label className="input-label flex items-center gap-1"><Truck size={12}/> Rota</label>
                                    <select 
                                        className="input-field py-1.5 text-xs font-bold appearance-none bg-slate-50"
                                        value={saleRoute}
                                        onChange={e => setSaleRoute(e.target.value)}
                                    >
                                        <option value="Rota 1">Rota 1</option>
                                        <option value="Rota 2">Rota 2</option>
                                        <option value="Rota 3">Rota 3</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* Carrinho Compacto */}
                        <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-slate-100">
                            {cart.length === 0 ? (
                                <div className="h-full flex flex-col items-center justify-center text-slate-300 opacity-60">
                                    <ShoppingCart size={32} className="mb-2"/>
                                    <p className="text-[10px] font-bold uppercase">Aguardando itens...</p>
                                </div>
                            ) : (
                                cart.map((item) => (
                                    <div key={item.tempId} className="bg-white p-2 rounded border border-slate-200 shadow-sm flex justify-between items-center animate-in">
                                        <div className="flex-1 min-w-0">
                                            <div className="font-bold text-xs text-slate-800 truncate">{item.name}</div>
                                            <div className="text-[10px] text-primary-600 font-black">{formatCurrency(item.price)}</div>
                                        </div>
                                        <button onClick={() => removeFromCart(item.tempId)} className="p-1.5 text-slate-300 hover:text-red-500 transition"><Trash2 size={14}/></button>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Checkout Footer */}
                        <div className="bg-white p-4 border-t border-slate-200 space-y-4">
                            <div className="space-y-1">
                                <div className="flex justify-between text-[10px] font-bold text-slate-400 uppercase">
                                    <span>Subtotal</span>
                                    <span>{formatCurrency(subTotal)}</span>
                                </div>
                                <div className="flex justify-between text-xs font-black text-slate-800 pt-1 border-t border-slate-100">
                                    <span className="uppercase">Total Final</span>
                                    <span className="text-lg text-primary-700">{formatCurrency(totalFinal)}</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                                <div>
                                    <label className="input-label">Pagamento</label>
                                    <select className="input-field py-1.5 text-xs" value={payMethod} onChange={e => setPayMethod(e.target.value)}>
                                        <option value="Pix">Pix</option>
                                        <option value="Cartão">Cartão</option>
                                        <option value="Dinheiro">Dinheiro</option>
                                    </select>
                                </div>
                                <div className="flex items-end">
                                    <button 
                                        onClick={() => setIsPaid(!isPaid)}
                                        className={`w-full py-1.5 rounded border text-[10px] font-bold uppercase transition ${isPaid ? 'bg-emerald-500 border-emerald-600 text-white' : 'bg-white border-slate-300 text-slate-400'}`}
                                    >
                                        {isPaid ? 'Pago' : 'Pendente'}
                                    </button>
                                </div>
                            </div>

                            <button onClick={finalizeSale} className="btn-primary w-full py-3 shadow-lg active:scale-95">
                                <CheckCircle size={18}/> FINALIZAR PEDIDO
                            </button>
                        </div>
                    </div>
                </div>
             );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
