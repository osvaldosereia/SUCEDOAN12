<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo PDV (Local-First Edition)</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        primary: { 600: '#0284c7', 700: '#0369a1' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
    
    <!-- 2. GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .input-label {
            display: block; font-size: 0.65rem; text-transform: uppercase;
            letter-spacing: 0.075em; font-weight: 800; color: #64748b; margin-bottom: 0.35rem;
        }
        
        .input-field {
            width: 100%; padding: 0.6rem 0.75rem; 
            background-color: #ffffff; 
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; color: #0f172a;
            outline: none; transition: all 0.15s;
        }
        .input-field:focus { border-color: #0284c7; box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.1); }
        
        .btn-primary {
            background-color: #0f172a; color: white;
            padding: 0.85rem 1.25rem; border-radius: 0.5rem;
            font-size: 0.9rem; font-weight: 700;
            display: flex; align-items: center; justify-content: center; gap: 0.6rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover { background-color: #1e293b; transform: translateY(-1px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .btn-primary:active { transform: translateY(0); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.2s ease-out; }
    </style>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-900 font-sans">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          ShoppingCart, Search, Plus, Trash2, XCircle, 
          CreditCard, Wallet, User, MapPin, 
          CheckCircle, Box, Truck, MessageSquare, Tag, Percent
        } from 'lucide-react';

        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 6).toUpperCase();
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        // --- APP ROOT ---
        function App() {
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [sales, setSales] = useStickyState('db_sales_v3', []);

          return (
            <div className="h-screen bg-slate-200 overflow-hidden relative">
                <POSView 
                    clients={clients} 
                    products={products} 
                    setProducts={setProducts} 
                    sales={sales} 
                    setSales={setSales} 
                />
            </div>
          );
        }

        // --- POS COMPONENT ---
        function POSView({ clients, products, setProducts, sales, setSales }) {
             // Basic States
             const [selectedClient, setSelectedClient] = useState(null);
             const [clientSearch, setClientSearch] = useState('');
             const [cart, setCart] = useState([]);
             
             // Delivery & Logistics
             const [saleRegion, setSaleRegion] = useState('');
             const [saleRoute, setSaleRoute] = useState('Rota 1');
             
             // Financial States
             const [isPaid, setIsPaid] = useState(false);
             const [discount, setDiscount] = useState(0);
             const [useCashback, setUseCashback] = useState(false);
             const [cashbackVal, setCashbackVal] = useState(0);
             const [payMethod, setPayMethod] = useState('Pix');
             const [obs, setObs] = useState(''); 
             
             // Product UI
             const [searchProd, setSearchProd] = useState('');
             const [selectedCategory, setSelectedCategory] = useState('todas');

             const filteredProducts = products.filter(p => 
                (selectedCategory === 'todas' || p.category === selectedCategory) && 
                (p.name.toLowerCase().includes(searchProd.toLowerCase()) || p.id.toLowerCase().includes(searchProd.toLowerCase()))
             );

             const categories = ['todas', ...new Set(products.map(p => p.category))];
             
             const subTotal = useMemo(() => cart.reduce((acc, item) => acc + Number(item.price), 0), [cart]);
             const totalFinal = useMemo(() => {
                const discTotal = Number(discount) + (useCashback ? Number(cashbackVal) : 0);
                return Math.max(0, subTotal - discTotal);
             }, [subTotal, discount, useCashback, cashbackVal]);

             // Handlers
             const handleSelectClient = (client) => {
                 setSelectedClient(client);
                 setClientSearch(client.name);
                 setSaleRegion(client.region || 'Região não definida');
             };

             const addToCart = (product) => {
                const cartItem = { 
                    ...product, 
                    tempId: Math.random().toString(36).substr(2, 9)
                };
                setCart([...cart, cartItem]);
             };

             const removeFromCart = (tempId) => {
                 setCart(cart.filter(item => item.tempId !== tempId));
             };

             const finalizeSale = () => {
                if (!selectedClient) return alert('ERRO: Selecione um cliente para continuar.');
                if (cart.length === 0) return alert('ERRO: Adicione produtos ao carrinho.');
                
                const newSale = {
                  id: generateId(), 
                  clientId: selectedClient.id,
                  clientName: selectedClient.name,
                  items: cart,
                  subTotal,
                  discount,
                  cashbackUsed: useCashback ? cashbackVal : 0,
                  total: totalFinal, 
                  route: saleRoute,
                  region: saleRegion,
                  payMethod,
                  isPaid,
                  obs,
                  date: new Date().toISOString()
                };
                
                setSales([...sales, newSale]);
                
                // Reset UI
                setCart([]);
                setSelectedClient(null);
                setClientSearch('');
                setSaleRegion('');
                setDiscount(0);
                setUseCashback(false);
                setCashbackVal(0);
                setObs('');
                alert('Venda registrada com sucesso!');
             };

             const filteredClients = clients.filter(c => c.name.toLowerCase().includes(clientSearch.toLowerCase()));

             return (
                <div className="flex flex-col lg:flex-row h-full">
                    
                    {/* ESQUERDA: LISTAGEM TIPO PLANILHA */}
                    <div className="flex-1 flex flex-col bg-white lg:border-r border-slate-300 h-[40%] lg:h-full overflow-hidden">
                        <div className="p-4 border-b border-slate-200 bg-slate-50 shrink-0">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xs font-black text-slate-700 uppercase tracking-tighter flex items-center gap-2">
                                    <Box size={16} className="text-primary-600"/> Inventário de Venda
                                </h2>
                            </div>
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
                                    <input 
                                        className="w-full pl-9 pr-4 py-2 border border-slate-300 rounded-md text-sm bg-white focus:border-primary-600 outline-none" 
                                        placeholder="Pesquisar produto..." 
                                        value={searchProd} 
                                        onChange={e => setSearchProd(e.target.value)} 
                                    />
                                </div>
                                <select 
                                    className="border border-slate-300 rounded-md px-3 bg-white text-xs font-bold outline-none cursor-pointer" 
                                    value={selectedCategory} 
                                    onChange={e => setSelectedCategory(e.target.value)}
                                >
                                    <option value="todas">Todas Categorias</option>
                                    {categories.filter(c=>c!=='todas').map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-auto scrollbar-thin">
                            <table className="w-full text-left border-collapse table-fixed">
                                <thead className="bg-slate-100 text-slate-500 text-[10px] uppercase font-bold sticky top-0 z-10 shadow-sm">
                                    <tr className="border-b border-slate-200">
                                        <th className="p-3 w-20">Código</th>
                                        <th className="p-3 w-auto">Produto</th>
                                        <th className="p-3 w-32">Categoria</th>
                                        <th className="p-3 w-24 text-right">Preço</th>
                                        <th className="p-3 w-24 text-center">Estoque</th>
                                        <th className="p-3 w-12"></th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm divide-y divide-slate-100">
                                    {filteredProducts.map(p => (
                                        <tr key={p.id} className="hover:bg-blue-50/50 cursor-pointer group transition-colors" onClick={() => addToCart(p)}>
                                            <td className="p-3 font-mono text-[10px] text-slate-400">{p.id}</td>
                                            <td className="p-3 font-bold text-slate-800 truncate">{p.name}</td>
                                            <td className="p-3"><span className="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500 font-bold">{p.category}</span></td>
                                            <td className="p-3 text-right font-bold text-primary-700">{formatCurrency(p.price)}</td>
                                            <td className="p-3 text-center">
                                                <span className={`text-xs font-black ${p.stock <= 5 ? 'text-red-500' : 'text-slate-500'}`}>{p.stock} un</span>
                                            </td>
                                            <td className="p-3 text-center">
                                                <button className="text-slate-300 group-hover:text-primary-600 transition-colors"><Plus size={18}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* DIREITA: CHECKOUT (SCROLLABLE & COMPLETO) */}
                    <div className="w-full lg:w-[440px] flex flex-col bg-white border-t lg:border-t-0 lg:border-l border-slate-300 shadow-2xl shrink-0 h-[60%] lg:h-full">
                        
                        {/* HEADER CHECKOUT */}
                        <div className="p-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center shrink-0">
                            <h2 className="text-xs font-black uppercase text-slate-600 tracking-widest flex items-center gap-2">
                                <ShoppingCart size={16}/> Resumo do Pedido
                            </h2>
                            <span className="text-[10px] font-bold text-slate-400">ID: {generateId()}</span>
                        </div>

                        {/* ÁREA DE ROLAGEM PRINCIPAL */}
                        <div className="flex-1 overflow-y-auto scrollbar-thin p-4 space-y-6 bg-white">
                            
                            {/* 1. SEÇÃO CLIENTE & LOGÍSTICA */}
                            <section className="space-y-4 animate-in">
                                <div className="space-y-1">
                                    <label className="input-label flex items-center gap-1"><User size={12}/> Identificação do Cliente</label>
                                    <div className="relative">
                                        <input 
                                            className={`w-full p-3 border rounded-lg outline-none transition text-sm font-bold ${selectedClient ? 'bg-blue-50 border-primary-600 text-primary-800' : 'bg-white border-slate-300 text-slate-900'}`} 
                                            placeholder="Busque pelo nome..." 
                                            value={clientSearch} 
                                            onChange={e => { setClientSearch(e.target.value); setSelectedClient(null); }} 
                                        />
                                        {clientSearch && !selectedClient && (
                                            <div className="absolute top-full left-0 w-full bg-white border border-slate-200 shadow-2xl max-h-48 overflow-y-auto z-50 rounded-b-lg border-t-0">
                                                {filteredClients.map(c => (
                                                    <div key={c.id} className="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0" onClick={() => handleSelectClient(c)}>
                                                        <div className="font-bold text-xs text-slate-800">{c.name}</div>
                                                        <div className="text-[10px] text-slate-400 font-medium uppercase">{c.city} • {c.region}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="input-label flex items-center gap-1"><MapPin size={12}/> Região de Entrega</label>
                                        <div className="p-3 bg-slate-50 rounded-lg border border-slate-200 text-[11px] font-bold text-slate-500 uppercase truncate">
                                            {saleRegion || 'Aguardando cliente...'}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="input-label flex items-center gap-1"><Truck size={12}/> Rota Logística</label>
                                        <select 
                                            className="input-field py-2.5 text-xs font-bold bg-slate-50 border-slate-200"
                                            value={saleRoute}
                                            onChange={e => setSaleRoute(e.target.value)}
                                        >
                                            <option value="Rota 1">Rota 1</option>
                                            <option value="Rota 2">Rota 2</option>
                                            <option value="Rota 3">Rota 3</option>
                                        </select>
                                    </div>
                                </div>
                            </section>

                            <hr className="border-slate-100" />

                            {/* 2. SEÇÃO PRODUTOS NO CARRINHO */}
                            <section className="space-y-3 animate-in">
                                <label className="input-label flex items-center gap-1"><Tag size={12}/> Itens Adicionados</label>
                                {cart.length === 0 ? (
                                    <div className="py-8 flex flex-col items-center justify-center border-2 border-dashed border-slate-100 rounded-xl text-slate-300">
                                        <ShoppingCart size={24} className="mb-2 opacity-30"/>
                                        <p className="text-[10px] font-bold uppercase tracking-wider">Carrinho Vazio</p>
                                    </div>
                                ) : (
                                    <div className="space-y-2">
                                        {cart.map((item) => (
                                            <div key={item.tempId} className="bg-slate-50 p-3 rounded-lg border border-slate-200 flex justify-between items-center group">
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-bold text-xs text-slate-800 truncate">{item.name}</div>
                                                    <div className="text-[10px] text-primary-700 font-black">{formatCurrency(item.price)}</div>
                                                </div>
                                                <button onClick={() => removeFromCart(item.tempId)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-all"><Trash2 size={16}/></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </section>

                            <hr className="border-slate-100" />

                            {/* 3. FINANCEIRO & DESCONTOS */}
                            <section className="space-y-4 animate-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="input-label flex items-center gap-1">Desconto em Reais</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-2.5 text-slate-400 text-xs font-bold">R$</span>
                                            <input 
                                                type="number" 
                                                className="input-field pl-8 font-bold text-red-600 focus:border-red-400" 
                                                value={discount} 
                                                onChange={e => setDiscount(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="input-label flex items-center gap-1">Usar Cashback?</label>
                                        <div className="flex gap-2">
                                            <div className="flex items-center justify-center bg-slate-50 border border-slate-200 rounded-lg p-2.5 w-12 cursor-pointer" onClick={() => setUseCashback(!useCashback)}>
                                                <input type="checkbox" checked={useCashback} readOnly className="accent-primary-600 w-4 h-4" />
                                            </div>
                                            <input 
                                                type="number" 
                                                disabled={!useCashback}
                                                placeholder="Valor"
                                                className="input-field font-bold text-emerald-600 disabled:bg-slate-100 disabled:opacity-40" 
                                                value={cashbackVal} 
                                                onChange={e => setCashbackVal(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-1 bg-slate-900 p-4 rounded-xl text-white shadow-lg">
                                    <div className="flex justify-between items-center opacity-60 text-[10px] font-bold uppercase tracking-widest">
                                        <span>Subtotal do Pedido</span>
                                        <span>{formatCurrency(subTotal)}</span>
                                    </div>
                                    <div className="flex justify-between items-center text-xs font-black py-1">
                                        <span className="text-red-400">Total Descontos</span>
                                        <span className="text-red-400">-{formatCurrency(Number(discount) + (useCashback ? Number(cashbackVal) : 0))}</span>
                                    </div>
                                    <div className="flex justify-between items-center pt-2 border-t border-slate-800">
                                        <span className="text-xs font-bold uppercase">Total Líquido</span>
                                        <span className="text-2xl font-black text-primary-400 tracking-tight">{formatCurrency(totalFinal)}</span>
                                    </div>
                                </div>
                            </section>

                            {/* 4. PAGAMENTO & OBSERVAÇÃO */}
                            <section className="space-y-4 pb-8 animate-in">
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="input-label">Forma de Pagto</label>
                                        <select className="input-field font-bold py-2.5 text-xs bg-white" value={payMethod} onChange={e => setPayMethod(e.target.value)}>
                                            <option value="Pix">Pix / Transferência</option>
                                            <option value="Cartão">Cartão de Crédito/Débito</option>
                                            <option value="Dinheiro">Dinheiro Espécie</option>
                                        </select>
                                    </div>
                                    <div className="flex flex-col">
                                        <label className="input-label">Status</label>
                                        <button 
                                            onClick={() => setIsPaid(!isPaid)}
                                            className={`flex-1 rounded-lg border-2 text-[10px] font-black uppercase transition-all flex items-center justify-center gap-2 ${isPaid ? 'bg-emerald-500 border-emerald-600 text-white shadow-md' : 'bg-white border-slate-200 text-slate-400'}`}
                                        >
                                            {isPaid ? <CheckCircle size={14}/> : null}
                                            {isPaid ? 'Pedido Pago' : 'Pagar Agora'}
                                        </button>
                                    </div>
                                </div>

                                <div className="space-y-1">
                                    <label className="input-label flex items-center gap-1"><MessageSquare size={12}/> Observações Internas</label>
                                    <textarea 
                                        className="input-field min-h-[80px] text-xs resize-none" 
                                        placeholder="Ex: Entregar após as 14h, campainha estragada..."
                                        value={obs}
                                        onChange={e => setObs(e.target.value)}
                                    ></textarea>
                                </div>

                                <button onClick={finalizeSale} className="btn-primary w-full py-4 mt-2">
                                    <CheckCircle size={20}/> FINALIZAR E SALVAR VENDA
                                </button>
                            </section>
                        </div>
                    </div>
                </div>
             );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
