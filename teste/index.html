<!DOCTYPE html> 
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Cestas B√°sicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, onSnapshot, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√£o do Firebase (Injetada pelo ambiente)
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = window.__app_id || 'gestao-cestas-001';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Estado Global
        let user = null;
        let produtos = [];
        let view = 'dashboard';

        // Inicializa√ß√£o com Auth (Regra 3)
        async function initAuth() {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Erro na autentica√ß√£o:", error);
            }
        }

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                renderApp();
                listenToProducts();
            }
        });

        // Listeners do Firestore (Caminhos R√≠gidos - Regra 1)
        function listenToProducts() {
            if (!user) return;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'produtos');
            onSnapshot(q, (snapshot) => {
                produtos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContent();
            }, (error) => console.error("Erro ao ler produtos:", error));
        }

        // Fun√ß√µes de Neg√≥cio
        window.saveProduct = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.estoque = parseInt(data.estoque) || 0;

            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'produtos', data.codigo_interno);
            
            // Verifica se j√° existe para somar stock ou criar novo
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const oldData = docSnap.data();
                await updateDoc(docRef, {
                    nome: data.nome,
                    barcode: data.barcode,
                    ncm: data.ncm,
                    estoque: oldData.estoque + data.estoque
                });
                showMessage("Stock atualizado com sucesso!");
            } else {
                await setDoc(docRef, data);
                showMessage("Produto cadastrado com sucesso!");
            }
            e.target.reset();
        };

        window.deleteProduct = async (id) => {
            if (!confirm("Tem certeza que deseja apagar este produto?")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'produtos', id));
        };

        window.processAssembly = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rawList = formData.get('lista_produtos');
            const qtdCestas = parseInt(formData.get('quantidade_cestas'));
            const nomeCesta = formData.get('nome_cesta');
            const valorCesta = formData.get('valor_cesta');

            const linhas = rawList.trim().split('\n');
            const itensParaBaixar = [];

            // Valida√ß√£o
            try {
                for (let linha of linhas) {
                    const [cod, qtdPerCesta] = linha.split('|').map(s => s.trim());
                    if (!cod || !qtdPerCesta) continue;
                    
                    const produto = produtos.find(p => p.codigo_interno === cod);
                    if (!produto) throw new Error(`Produto n√£o encontrado: ${cod}`);
                    
                    const totalNecessario = parseInt(qtdPerCesta) * qtdCestas;
                    if (produto.estoque < totalNecessario) {
                        throw new Error(`Stock insuficiente para ${produto.nome} (${cod}). Necess√°rio: ${totalNecessario}, Dispon√≠vel: ${produto.estoque}`);
                    }
                    
                    itensParaBaixar.push({ cod, total: totalNecessario });
                }

                // Execu√ß√£o da baixa (Simplificado - Regra 2: Sem transa√ß√µes complexas, fazemos um a um)
                for (let item of itensParaBaixar) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'produtos', item.cod);
                    const prod = produtos.find(p => p.codigo_interno === item.cod);
                    await updateDoc(docRef, { estoque: prod.estoque - item.total });
                }

                // Registro da Montagem
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'montagens'), {
                    nome_cesta: nomeCesta,
                    quantidade: qtdCestas,
                    valor: valorCesta,
                    data: serverTimestamp()
                });

                showMessage(`Sucesso! ${qtdCestas} cestas montadas e stock atualizado.`);
                e.target.reset();
                setView('dashboard');
            } catch (err) {
                alert(err.message);
            }
        };

        // UI Helpers
        window.setView = (v) => {
            view = v;
            renderContent();
        };

        function showMessage(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        function renderApp() {
            document.getElementById('app').innerHTML = `
                <div class="flex h-screen bg-gray-100">
                    <!-- Sidebar -->
                    <div class="w-64 bg-slate-800 text-white flex flex-col">
                        <div class="p-6 text-xl font-bold border-b border-slate-700">Cestas Desktop</div>
                        <nav class="flex-1 p-4 space-y-2">
                            <button onclick="setView('dashboard')" class="w-full text-left p-3 rounded hover:bg-slate-700 flex items-center">üì¶ Stock Atual</button>
                            <button onclick="setView('add_product')" class="w-full text-left p-3 rounded hover:bg-slate-700 flex items-center">‚ûï Entrada / Cadastro</button>
                            <button onclick="setView('assemble')" class="w-full text-left p-3 rounded hover:bg-slate-700 flex items-center">üß∫ Montar Cestas</button>
                        </nav>
                        <div class="p-4 text-xs text-slate-400">ID: ${user.uid}</div>
                    </div>
                    <!-- Main -->
                    <div class="flex-1 flex flex-col overflow-hidden">
                        <header class="bg-white shadow-sm p-4 flex justify-between items-center">
                            <h2 id="page-title" class="text-xl font-semibold text-gray-700">Painel Principal</h2>
                        </header>
                        <main class="flex-1 overflow-y-auto p-6" id="main-content"></main>
                    </div>
                </div>
                <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-lg hidden"></div>
            `;
            renderContent();
        }

        function renderContent() {
            const main = document.getElementById('main-content');
            const title = document.getElementById('page-title');
            if (!main) return;

            switch(view) {
                case 'dashboard':
                    title.innerText = "Stock de Produtos Individuais";
                    main.innerHTML = `
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="p-4">C√≥d. Interno</th>
                                        <th class="p-4">Produto</th>
                                        <th class="p-4">EAN / NCM</th>
                                        <th class="p-4">Stock</th>
                                        <th class="p-4 text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${produtos.map(p => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-4 font-mono text-sm">${p.id}</td>
                                            <td class="p-4 font-medium">${p.nome}</td>
                                            <td class="p-4 text-gray-500 text-sm">${p.barcode} | ${p.ncm}</td>
                                            <td class="p-4"><span class="px-2 py-1 rounded ${p.estoque < 10 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${p.estoque} un</span></td>
                                            <td class="p-4 text-right">
                                                <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:underline text-sm">Apagar</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                    ${produtos.length === 0 ? '<tr><td colspan="5" class="p-10 text-center text-gray-400">Nenhum produto cadastrado.</td></tr>' : ''}
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;

                case 'add_product':
                    title.innerText = "Cadastro e Entrada de Mercadoria";
                    main.innerHTML = `
                        <div class="max-w-2xl bg-white p-8 rounded-lg shadow">
                            <form onsubmit="saveProduct(event)" class="space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="col-span-1">
                                        <label class="block text-sm font-medium text-gray-700">C√≥digo Interno</label>
                                        <input type="text" name="codigo_interno" required class="mt-1 block w-full border rounded-md p-2 border-gray-300">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="block text-sm font-medium text-gray-700">C√≥d. Barras (EAN)</label>
                                        <input type="text" name="barcode" class="mt-1 block w-full border rounded-md p-2 border-gray-300">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Nome do Produto</label>
                                    <input type="text" name="nome" required class="mt-1 block w-full border rounded-md p-2 border-gray-300">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">NCM</label>
                                        <input type="text" name="ncm" class="mt-1 block w-full border rounded-md p-2 border-gray-300">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Qtd p/ Somar ao Stock</label>
                                        <input type="number" name="estoque" required class="mt-1 block w-full border rounded-md p-2 border-gray-300 bg-yellow-50 font-bold">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md font-bold hover:bg-blue-700 transition">SALVAR / DAR ENTRADA</button>
                            </form>
                            <p class="mt-4 text-xs text-gray-500">* Se o c√≥digo j√° existir, a quantidade informada ser√° somada ao stock atual.</p>
                        </div>
                    `;
                    break;

                case 'assemble':
                    title.innerText = "Montagem de Lote de Cestas";
                    main.innerHTML = `
                        <div class="max-w-4xl bg-white p-8 rounded-lg shadow">
                            <form onsubmit="processAssembly(event)" class="space-y-6">
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="col-span-1">
                                        <label class="block text-sm font-medium text-gray-700">Nome da Cesta</label>
                                        <input type="text" name="nome_cesta" placeholder="Ex: Cesta Natalina" required class="mt-1 block w-full border rounded-md p-2 border-gray-300">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Quantidade de Cestas</label>
                                        <input type="number" name="quantidade_cestas" value="1" min="1" required class="mt-1 block w-full border rounded-md p-2 border-gray-300">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Valor Unit√°rio (Venda)</label>
                                        <input type="number" step="0.01" name="valor_cesta" placeholder="0,00" class="mt-1 block w-full border rounded-md p-2 border-gray-300">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Composi√ß√£o da Cesta (Cole a lista abaixo)</label>
                                    <div class="bg-blue-50 p-3 rounded mb-2 text-xs text-blue-800">
                                        Formato: <strong>C√ìDIGO | QUANTIDADE POR CESTA</strong> (Uma por linha)
                                    </div>
                                    <textarea name="lista_produtos" rows="10" required placeholder="ARROZ01 | 2&#10;FEIJAO02 | 1&#10;OLEO01 | 1" class="w-full border rounded-md p-3 font-mono text-sm border-gray-300 bg-gray-50 focus:bg-white"></textarea>
                                </div>

                                <div class="p-4 bg-red-50 border border-red-200 rounded text-red-800 text-sm">
                                    <strong>Aten√ß√£o:</strong> Ao clicar em finalizar, o sistema calcular√° automaticamente o total de cada item (Qtd Cestas x Qtd Item) e dar√° baixa imediata no stock.
                                </div>

                                <button type="submit" class="w-full bg-red-600 text-white p-4 rounded-md font-bold text-lg hover:bg-red-700 shadow-lg">FINALIZAR MONTAGEM E DAR BAIXA</button>
                            </form>
                        </div>
                    `;
                    break;
            }
        }

        initAuth();
    </script>
</head>
<body class="bg-gray-100">
    <div id="app">
        <div class="flex items-center justify-center h-screen">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                <p class="mt-4 text-gray-600 font-medium">A carregar sistema...</p>
            </div>
        </div>
    </div>
</body>
</html>
