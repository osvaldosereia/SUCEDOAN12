<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Log√≠stica Local-First v6.3 (Stable Fixed)</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ESTILOS EXTRAS -->
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .input-field {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem; 
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .btn-primary {
            background-color: #1e293b;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #334155; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        
        .nav-item.active { background-color: #334155; border-right: 4px solid #34d399; }
    </style>

    <!-- 3. IMPORTMAP REACT + ZOD -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "zod": "https://esm.sh/zod@3.22.4"
      }
    }
    </script>
    
    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { z } from 'zod';
        import { 
          Save, Truck, Package, ShoppingCart, Users, MapPin, 
          Printer, Share2, Download, Upload, Trash2, Plus, 
          Minus, CheckCircle, Search, Navigation, Edit2, 
          ArrowUp, ArrowDown, History, MessageCircle, XCircle,
          AlertTriangle, FileText, Banknote, List, Tag, Percent, 
          Calendar, Filter, Phone, Database, Clipboard, Box, ExternalLink,
          Clock, Home, DollarSign, CreditCard, Check, ShieldCheck, ClipboardList,
          ArrowRight, ArrowLeft, LayoutDashboard, Settings, Menu, BarChart2, TrendingUp, PieChart,
          MessageSquare, HeartHandshake, RefreshCcw, ThumbsUp, Star, Instagram, Award, Users2
        } from 'lucide-react';

        // --- SCHEMAS DE VALIDA√á√ÉO (ZOD) ---
        const ClientSchema = z.object({
            id: z.string(),
            name: z.string().min(1),
            code: z.string().optional().or(z.literal('')),
            phone: z.string().optional().or(z.literal('')),
            phone2: z.string().optional().or(z.literal('')),
            address: z.string().optional().or(z.literal('')),
            city: z.string().optional().or(z.literal('')),
            district: z.string().optional().or(z.literal('')),
            region: z.string().optional().or(z.literal('')),
            mapLink: z.string().optional().or(z.literal('')),
            photoLink: z.string().optional().or(z.literal('')),
            obs: z.string().optional().or(z.literal(''))
        });

        const ProductSchema = z.object({
            id: z.string(),
            name: z.string().min(1),
            internalCode: z.string().optional().or(z.literal('')),
            category: z.string().optional().or(z.literal('')),
            ncm: z.string().optional().or(z.literal('')),
            barcode: z.string().optional().or(z.literal('')),
            cost: z.any().transform(v => Number(v) || 0), 
            price: z.any().transform(v => Number(v) || 0),
            stock: z.any().transform(v => Number(v) || 0),
            isCombo: z.boolean().optional(),
            comboItems: z.array(z.object({
                id: z.string(),
                qty: z.number(),
                internalPrice: z.number().optional() 
            })).optional(),
            stockHistory: z.array(z.any()).optional()
        });

        const SaleItemSchema = z.object({
            id: z.string(),
            name: z.string(),
            price: z.any().transform(v => Number(v) || 0),
            tempId: z.string().optional(),
            qty: z.number().optional(), 
            isCombo: z.boolean().optional(),
            comboItems: z.array(z.any()).optional()
        }).passthrough(); 

        const SaleSchema = z.object({
            id: z.string(),
            fullId: z.string().optional(),
            clientId: z.string(),
            items: z.array(SaleItemSchema),
            subTotal: z.number(),
            discount: z.number(),
            total: z.number(),
            payMethod: z.string(),
            changeFor: z.any().optional(),
            obs: z.string().optional().or(z.literal('')),
            date: z.string(),
            status: z.string(),
            printedLabel: z.boolean().optional(),
            printedList: z.boolean().optional(),
            volumes: z.number().optional(),
            routeId: z.any().optional()
        });

        const BackupSchema = z.object({
            version: z.string().optional(),
            exportedAt: z.string().optional(),
            clients: z.array(ClientSchema).optional(),
            products: z.array(ProductSchema).optional(),
            sales: z.array(SaleSchema).optional(),
            companyPhone: z.string().optional(),
            postSaleLog: z.record(z.object({
                date: z.string(),
                count: z.number(),
                expirationDate: z.string().optional()
            })).optional()
        });
        
        // --- UTILIT√ÅRIOS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const generateDailyId = (sales) => {
            const today = new Date().toISOString().slice(0, 10);
            const todaysSales = sales.filter(s => s.date.startsWith(today));
            const count = todaysSales.length + 1;
            return count > 99 ? count.toString() : count.toString().padStart(2, '0');
        };
        const generateClientCode = (existingClients) => {
           let code;
           let attempts = 0;
           do {
             code = Math.floor(1000 + Math.random() * 9000).toString();
             attempts++;
             if(attempts > 1000) break; 
           } while (existingClients.some(c => c.code === code));
           return code;
        };
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatDate = (dateString) => (!dateString) ? '-' : new Date(dateString).toLocaleDateString('pt-BR');
        const formatDateTime = (dateString) => (!dateString) ? '-' : new Date(dateString).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' });

        const distributeTotal = (targetTotal, items, getPrice, setPrice, getQty) => {
            const currentSum = items.reduce((acc, item) => acc + (getPrice(item) * getQty(item)), 0);
            if (currentSum === 0) return items;
            const factor = targetTotal / currentSum;
            const adjustedItems = items.map(item => {
                const oldPrice = getPrice(item);
                const newPrice = Math.round((oldPrice * factor) * 100) / 100;
                const newItem = { ...item };
                setPrice(newItem, newPrice);
                return newItem;
            });
            const newSum = adjustedItems.reduce((acc, item) => acc + (getPrice(item) * getQty(item)), 0);
            const diff = Math.round((targetTotal - newSum) * 100) / 100;
            if (diff !== 0) {
                const idx = adjustedItems.reduce((maxI, el, i, arr) => getPrice(el) > getPrice(arr[maxI]) ? i : maxI, 0);
                const qty = getQty(adjustedItems[idx]);
                if (qty > 0) {
                    const priceAdjustment = diff / qty;
                    const currentP = getPrice(adjustedItems[idx]);
                    setPrice(adjustedItems[idx], currentP + priceAdjustment);
                }
            }
            return adjustedItems;
        };

        // --- COMPONENTE PRINCIPAL ---
        function App() {
          const [clients, setClients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [companyPhone, setCompanyPhone] = useStickyState('db_config_phone', '65998150975');
          const [postSaleLog, setPostSaleLog] = useStickyState('db_postsale_log', {}); 
          
          const [viewMode, setViewMode] = useState('dashboard');
          const [activeTab, setActiveTab] = useState('dashboard');
          const [showStockManager, setShowStockManager] = useState(false);
          const [driverData, setDriverData] = useState(null);
          
          const [saleToEdit, setSaleToEdit] = useState(null);
          const [backupType, setBackupType] = useState('all'); 

          useEffect(() => {
            const checkHash = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#driver=')) {
                  try {
                    const encoded = hash.replace('#driver=', '');
                    const decoded = JSON.parse(atob(decodeURIComponent(encoded)));
                    setDriverData(decoded);
                    setViewMode('driver');
                  } catch (e) {
                    console.error("Link inv√°lido", e);
                    alert("Erro ao abrir link do entregador.");
                  }
                } else {
                    if (viewMode === 'driver') setViewMode('dashboard');
                }
            };
            checkHash();
            window.addEventListener('hashchange', checkHash);
            return () => window.removeEventListener('hashchange', checkHash);
          }, []);

          const handleBackup = () => {
            let data = { version: '6.3', exportedAt: new Date().toISOString() };
            let filename = 'backup';
            if (backupType === 'all') { 
                data = { ...data, clients, products, sales, companyPhone, postSaleLog }; 
                filename = 'backup_completo'; 
            } else if (backupType === 'clients') { 
                data = { ...data, clients }; 
                filename = 'backup_clientes'; 
            } else if (backupType === 'products') { 
                data = { ...data, products }; 
                filename = 'backup_produtos'; 
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `${filename}_${new Date().toISOString().slice(0,10)}.json`; 
            a.click();
          };

          const handleRestore = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const rawData = JSON.parse(event.target.result);
                const result = BackupSchema.safeParse(rawData);
                if (!result.success) return alert(`FALHA DE INTEGRIDADE (ZOD): Arquivo inv√°lido.`);
                const data = result.data;
                if (confirm("SEGURAN√áA: Dados validados.\nSobrescrever base local?")) {
                  if (data.clients) setClients(data.clients);
                  if (data.products) setProducts(data.products);
                  if (data.sales) setSales(data.sales);
                  if (data.companyPhone) setCompanyPhone(data.companyPhone);
                  if (data.postSaleLog) setPostSaleLog(data.postSaleLog);
                  alert("Importa√ß√£o conclu√≠da.");
                }
              } catch (err) { alert("Erro ao ler JSON."); }
            };
            reader.readAsText(file);
          };

          if (viewMode === 'driver') return <DriverView data={driverData} onExit={() => { window.location.hash = ''; setViewMode('dashboard'); }} />;

          const renderContent = () => {
             switch(activeTab) {
                case 'dashboard': return <DashboardView sales={sales} products={products} clients={clients} />;
                case 'pos': return <POSView clients={clients} products={products} setProducts={setProducts} sales={sales} setSales={setSales} saleToEdit={saleToEdit} setSaleToEdit={setSaleToEdit} />;
                case 'expedition': return <ExpeditionView sales={sales} setSales={setSales} clients={clients} products={products} setProducts={setProducts} onEditSale={(sale) => { setSaleToEdit(sale); setActiveTab('pos'); }} />;
                case 'logistics': return <LogisticsView sales={sales} setSales={setSales} clients={clients} companyPhone={companyPhone} products={products} setProducts={setProducts} />;
                case 'crm': return <RegistryView clients={clients} setClients={setClients} products={products} setProducts={setProducts} />;
                case 'reports': return <ReportsView sales={sales} clients={clients} products={products} postSaleLog={postSaleLog} />;
                case 'postsale': return <PostSalesView sales={sales} clients={clients} postSaleLog={postSaleLog} setPostSaleLog={setPostSaleLog} companyPhone={companyPhone} />;
                default: return <DashboardView sales={sales} products={products} clients={clients} />;
             }
          };

          return (
            <div className="flex h-screen bg-gray-100 font-sans text-gray-800 overflow-hidden">
                <aside className="w-20 lg:w-64 bg-slate-900 text-white flex flex-col shrink-0 transition-all duration-300 z-30 shadow-xl">
                    <div className="h-16 flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800">
                        <div className="bg-yellow-500 text-slate-900 p-1.5 rounded font-bold mr-2">LOG</div>
                        <h1 className="font-bold tracking-wider hidden lg:block text-lg">SISTEMA <span className="text-emerald-400 text-xs font-normal border border-emerald-500 rounded px-1 ml-1">V6.3</span></h1>
                    </div>
                    <nav className="flex-1 py-4 space-y-1 overflow-y-auto">
                        <NavItem icon={<LayoutDashboard size={20}/>} label="Vis√£o Geral" active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} />
                        <NavItem icon={<ShoppingCart size={20}/>} label="Caixa (PDV)" active={activeTab === 'pos'} onClick={() => setActiveTab('pos')} />
                        <NavItem icon={<Package size={20}/>} label="Expedi√ß√£o" active={activeTab === 'expedition'} onClick={() => setActiveTab('expedition')} />
                        <NavItem icon={<Truck size={20}/>} label="Log√≠stica" active={activeTab === 'logistics'} onClick={() => setActiveTab('logistics')} />
                        <NavItem icon={<Database size={20}/>} label="Cadastros" active={activeTab === 'crm'} onClick={() => setActiveTab('crm')} />
                        <NavItem icon={<BarChart2 size={20}/>} label="Relat√≥rios" active={activeTab === 'reports'} onClick={() => setActiveTab('reports')} />
                        <NavItem icon={<HeartHandshake size={20}/>} label="P√≥s-Venda" active={activeTab === 'postsale'} onClick={() => setActiveTab('postsale')} />
                    </nav>
                    <div className="p-4 border-t border-slate-800 space-y-3">
                        <button onClick={() => setShowStockManager(true)} className="w-full flex items-center justify-center lg:justify-start gap-3 p-2 rounded hover:bg-slate-800 transition text-slate-400 hover:text-white">
                            <ClipboardList size={20} /> <span className="hidden lg:inline text-sm font-medium">Estoque R√°pido</span>
                        </button>
                        <div className="pt-2 border-t border-slate-800 hidden lg:block">
                            <div className="flex gap-2 mb-2">
                                <select className="bg-slate-800 text-xs text-white p-1.5 rounded border border-slate-700 flex-1 outline-none" value={backupType} onChange={(e) => setBackupType(e.target.value)}>
                                    <option value="all">Geral</option><option value="clients">Clientes</option><option value="products">Produtos</option>
                                </select>
                                <button onClick={handleBackup} className="bg-emerald-600 hover:bg-emerald-500 p-1.5 rounded text-white transition"><Download size={14} /></button>
                            </div>
                            <label className="flex items-center gap-2 text-xs text-slate-400 hover:text-white cursor-pointer transition">
                                <Upload size={14} /> Importar JSON <input type="file" className="hidden" accept=".json" onChange={handleRestore} />
                            </label>
                        </div>
                    </div>
                </aside>
                <main className="flex-1 flex flex-col min-w-0 bg-gray-50 h-full">
                    <header className="h-16 bg-white border-b flex items-center justify-between px-6 shrink-0 shadow-sm z-20">
                        <div className="flex items-center gap-2 lg:hidden"><div className="bg-yellow-500 text-slate-900 p-1 rounded font-bold">LOG</div></div>
                        <div className="hidden lg:block"><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">{activeTab === 'dashboard' ? 'Vis√£o Geral' : activeTab === 'pos' ? 'Ponto de Venda' : activeTab === 'expedition' ? 'Expedi√ß√£o' : activeTab === 'logistics' ? 'Log√≠stica' : activeTab === 'crm' ? 'Cadastros' : activeTab === 'postsale' ? 'P√≥s-Venda & Fideliza√ß√£o' : 'Relat√≥rios'}</h2></div>
                        <div className="flex items-center gap-4">
                            <div className="hidden sm:flex items-center gap-2 text-sm text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full border">
                                <Phone size={14} /><input className="bg-transparent w-24 outline-none" value={companyPhone} onChange={e => setCompanyPhone(e.target.value)} />
                            </div>
                            <div className="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 font-bold">OP</div>
                        </div>
                    </header>
                    <div className="flex-1 overflow-hidden relative">{renderContent()}</div>
                </main>
                {showStockManager && (
                    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 animate-in">
                        <div className="bg-white w-full max-w-5xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
                            <div className="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                                <h2 className="font-bold flex items-center gap-2 text-lg"><ClipboardList size={20}/> GERENCIADOR DE ESTOQUE</h2>
                                <button onClick={() => setShowStockManager(false)} className="hover:bg-slate-700 p-1.5 rounded-full transition"><XCircle size={24}/></button>
                            </div>
                            <StockManager products={products} setProducts={setProducts} />
                        </div>
                    </div>
                )}
            </div>
          );
        }

        const NavItem = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center justify-center lg:justify-start gap-3 p-3 lg:px-6 transition-all duration-200 nav-item ${active ? 'active text-white bg-slate-800' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`} title={label}>{icon}<span className="hidden lg:inline font-medium text-sm">{label}</span></button>
        );

        function DashboardView({ sales, products, clients }) {
            const today = new Date().toISOString().slice(0, 10);
            const salesToday = sales.filter(s => s.date.startsWith(today) && s.status !== 'Cancelado');
            const totalToday = salesToday.reduce((acc, s) => acc + s.total, 0);
            const pendingOrders = sales.filter(s => s.status === 'Pendente').length;
            const lowStock = products.filter(p => !p.isCombo && p.stock <= 5).length;
            
            return (
                <div className="p-6 h-full overflow-y-auto">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <MetricCard title="Vendas Hoje" value={formatCurrency(totalToday)} icon={<DollarSign size={24} className="text-green-600"/>} color="green" sub={`${salesToday.length} pedidos`} />
                        <MetricCard title="Pedidos Pendentes" value={pendingOrders} icon={<Clock size={24} className="text-orange-600"/>} color="orange" sub="Aguardando montagem" />
                        <MetricCard title="Estoque Baixo" value={lowStock} icon={<AlertTriangle size={24} className="text-red-600"/>} color="red" sub="Produtos cr√≠ticos" />
                        <MetricCard title="Total Clientes" value={clients.length} icon={<Users size={24} className="text-blue-600"/>} color="blue" sub="Base ativa" />
                    </div>
                    {/* ... rest of dashboard ... */}
                </div>
            );
        }

        const MetricCard = ({ title, value, icon, color, sub }) => (
            <div className={`bg-white p-5 rounded-xl shadow-sm border border-${color}-100 relative overflow-hidden group`}><div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110`}>{icon}</div><div className="relative z-10"><p className="text-gray-500 text-sm font-medium uppercase tracking-wider mb-1">{title}</p><h3 className="text-2xl font-bold text-gray-800 mb-1">{value}</h3><p className={`text-xs text-${color}-600 font-bold`}>{sub}</p></div></div>
        );

        // --- P√ìS-VENDA VIEW ---
        function PostSalesView({ sales, clients, postSaleLog, setPostSaleLog, companyPhone }) {
            const clientLastSale = useMemo(() => {
                const map = {};
                sales.forEach(s => { if (s.status === 'Cancelado') return; if (!map[s.clientId] || new Date(s.date) > new Date(map[s.clientId].date)) { map[s.clientId] = s; } });
                return map;
            }, [sales]);
            
            const now = new Date();
            now.setHours(0,0,0,0); 

            const buckets = { 
                today: [],      
                yesterday: [],  
                opportunity: [], 
                attention: [],   
                risk: []         
            };

            Object.values(clientLastSale).forEach(sale => {
                const saleDate = new Date(sale.date);
                saleDate.setHours(0,0,0,0); 
                
                const diffTime = now - saleDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                
                const client = clients.find(c => c.id === sale.clientId);
                if (!client) return;
                
                let rawCashback = sale.total * 0.06;
                let cashback = Math.max(5, Math.round(rawCashback / 5) * 5); 
                const data = { client, sale, diffDays, cashback };

                if (diffDays === 0) buckets.today.push(data);
                else if (diffDays === 1) buckets.yesterday.push(data);
                else if (diffDays >= 25 && diffDays <= 30) buckets.opportunity.push(data);
                else if (diffDays >= 31 && diffDays <= 45) buckets.attention.push(data);
                else if (diffDays >= 46) buckets.risk.push(data);
            });

            // L√≥gica para Cashbacks Ativos
            const activeCashbacks = useMemo(() => {
                return Object.entries(postSaleLog)
                    .map(([clientId, log]) => {
                        const client = clients.find(c => c.id === clientId);
                        if (!client) return null;
                        const expiration = log.expirationDate ? new Date(log.expirationDate) : new Date(new Date(log.date).setDate(new Date(log.date).getDate() + 7));
                        const daysLeft = Math.ceil((expiration - now) / (1000 * 60 * 60 * 24));
                        return { client, log, expiration, daysLeft };
                    })
                    .filter(item => item && item.daysLeft >= -2) // Mostra at√© 2 dias vencidos
                    .sort((a, b) => a.daysLeft - b.daysLeft);
            }, [postSaleLog, clients]);

            const LINKS = {
                instagram: "https://instagram.com/cestas.dona.antonia.cuiaba.vg",
                google: "https://g.page/r/CaIREJtO1L6WEBE/review", 
                vip: "https://chat.whatsapp.com/IOI3gSBLRVk4jGK2QMunp1"
            };

            const sendWhatsApp = (item, type = 'cashback') => {
                const log = postSaleLog[item.client.id];
                const isReminder = !!log;
                const clientName = item.client.name.split(' ')[0];
                const cleanPhone = item.client.phone.replace(/\D/g, '');
                let msg = '';
                
                const validityDate = new Date();
                validityDate.setDate(validityDate.getDate() + 7);
                const validityStr = validityDate.toLocaleDateString('pt-BR');

                if (type === 'cashback') {
                    if (item.diffDays === 0) {
                        msg = `Ol√° ${clientName}! ‚ú® Muito obrigado pela compra de hoje! J√° geramos um *Cashback de ${formatCurrency(item.cashback)}* para sua pr√≥xima visita. Validade: ${validityStr}. At√© breve!`;
                    } else if (item.diffDays === 1) {
                        msg = `Oi ${clientName}! üì¶ Tudo certo com sua entrega de ontem? S√≥ lembrando que voc√™ tem um *Cashback de ${formatCurrency(item.cashback)}* dispon√≠vel at√© ${validityStr}!`;
                    } else if (!isReminder) { 
                        msg = `Ol√° ${clientName}! üåü Faz ${item.diffDays} dias que n√£o te vemos. Como agradecimento, liberamos um *Cashback de ${formatCurrency(item.cashback)}* para sua pr√≥xima compra! üí∞ Validade: ${validityStr}. Aproveite!`; 
                    } else { 
                        msg = `Oi ${clientName}! ‚è≥ Passando pra lembrar do seu *Cashback de ${formatCurrency(item.cashback)}*! Prorroguei a validade para ${validityStr} pra voc√™ aproveitar. Vem conferir as novidades!`; 
                    }
                } else if (type === 'insta') {
                    msg = `Ol√° ${clientName}! üì∏ J√° segue a gente no Insta? Postamos novidades todo dia! Segue l√°: ${LINKS.instagram}`;
                } else if (type === 'google') {
                    msg = `Oi ${clientName}! ‚≠ê Poderia nos avaliar no Google? Ajuda muito! Link: ${LINKS.google}`;
                } else if (type === 'vip') {
                    msg = `Ei ${clientName}! üöÄ Entre no nosso Grupo VIP de descontos: ${LINKS.vip}`;
                }
                
                setPostSaleLog(prev => ({ 
                    ...prev, 
                    [item.client.id]: { 
                        date: new Date().toISOString(), 
                        count: (prev[item.client.id]?.count || 0) + 1,
                        expirationDate: validityDate.toISOString()
                    } 
                }));
                window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            const PostSaleCard = ({ item, type }) => {
                const [showMenu, setShowMenu] = useState(false);
                const log = postSaleLog[item.client.id];
                const lastMsgDate = log ? new Date(log.date).toLocaleDateString('pt-BR') : 'Nunca';
                
                if ((type === 'today' || type === 'yesterday') && showMenu) {
                    return (
                        <div className="bg-white p-3 rounded-lg shadow-md border border-blue-200 flex flex-col gap-2 relative animate-in">
                             <div className="flex justify-between items-center border-b pb-2 mb-1">
                                <span className="font-bold text-xs text-blue-800">A√ß√µes: {item.client.name.split(' ')[0]}</span>
                                <button onClick={() => setShowMenu(false)} className="text-gray-400 hover:text-red-500"><XCircle size={16}/></button>
                             </div>
                             <div className="grid grid-cols-2 gap-2">
                                <button onClick={() => sendWhatsApp(item, 'cashback')} className="bg-green-100 text-green-800 p-2 rounded flex flex-col items-center gap-1 text-[10px] font-bold hover:bg-green-200"><MessageSquare size={16}/> Cashback</button>
                                <button onClick={() => sendWhatsApp(item, 'insta')} className="bg-pink-100 text-pink-800 p-2 rounded flex flex-col items-center gap-1 text-[10px] font-bold hover:bg-pink-200"><Instagram size={16}/> Seguir</button>
                                <button onClick={() => sendWhatsApp(item, 'google')} className="bg-orange-100 text-orange-800 p-2 rounded flex flex-col items-center gap-1 text-[10px] font-bold hover:bg-orange-200"><Star size={16}/> Avaliar</button>
                                <button onClick={() => sendWhatsApp(item, 'vip')} className="bg-blue-100 text-blue-800 p-2 rounded flex flex-col items-center gap-1 text-[10px] font-bold hover:bg-blue-200"><Users2 size={16}/> Grupo VIP</button>
                             </div>
                        </div>
                    )
                }

                return (
                    <div className="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex flex-col gap-2">
                        <div className="flex justify-between items-start">
                            <span className="font-bold text-gray-800 text-sm truncate">{item.client.name}</span>
                            <span className="text-[10px] font-bold bg-gray-100 px-1.5 py-0.5 rounded text-gray-600">{item.diffDays}d</span>
                        </div>
                        <div className="text-xs text-gray-500">
                            √öltima: {formatCurrency(item.sale.total)} <br/>
                            <span className="text-[10px]">Msg: {lastMsgDate}</span>
                        </div>
                        <div className="flex items-center justify-between mt-1 pt-2 border-t border-dashed">
                            <div className="text-green-700 font-bold text-sm">
                                üéÅ {formatCurrency(item.cashback)}
                            </div>
                            {(type === 'today' || type === 'yesterday') ? (
                                <button onClick={() => setShowMenu(true)} className="px-3 py-1.5 rounded text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 flex items-center gap-1">
                                    <Menu size={12}/> OP√á√ïES
                                </button>
                            ) : (
                                <button onClick={() => sendWhatsApp(item)} className={`px-3 py-1.5 rounded text-xs font-bold text-white flex items-center gap-1 transition ${log ? 'bg-indigo-500 hover:bg-indigo-600' : 'bg-green-600 hover:bg-green-700'}`}>
                                    {log ? <RefreshCcw size={12}/> : <MessageSquare size={12}/>}
                                    {log ? 'Lembrar' : 'Enviar'}
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full p-6 overflow-x-auto">
                    <div className="flex gap-6 h-full min-w-[1900px]">
                        {/* COLUNA 0: CASHBACKS ATIVOS */}
                        <div className="flex-1 flex flex-col bg-slate-100 rounded-xl border border-slate-300 overflow-hidden min-w-0">
                             <div className="p-3 bg-slate-200 border-b border-slate-300 flex justify-between items-center"><h3 className="font-bold text-slate-800 flex items-center gap-2 text-xs lg:text-sm"><Award size={16}/> Cashbacks Ativos</h3><span className="bg-white px-2 rounded-full text-xs font-bold text-slate-700">{activeCashbacks.length}</span></div>
                             <div className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">
                                {activeCashbacks.map(ac => (
                                    <div key={ac.client.id} className="bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex flex-col gap-1">
                                        <div className="flex justify-between">
                                            <span className="font-bold text-xs truncate">{ac.client.name}</span>
                                            <span className={`text-[10px] font-bold px-1.5 rounded ${ac.daysLeft < 2 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{ac.daysLeft} dias</span>
                                        </div>
                                        <div className="text-[10px] text-gray-500">Expira: {ac.expiration.toLocaleDateString('pt-BR')}</div>
                                    </div>
                                ))}
                                {activeCashbacks.length === 0 && <div className="text-center text-xs text-gray-400 mt-4">Nenhum ativo.</div>}
                             </div>
                        </div>

                        {/* COLUNA 1: HOJE */}
                        <div className="flex-1 flex flex-col bg-blue-50 rounded-xl border border-blue-200 overflow-hidden min-w-0">
                            <div className="p-3 bg-blue-100 border-b border-blue-200 flex justify-between items-center"><h3 className="font-bold text-blue-900 flex items-center gap-2 text-xs lg:text-sm"><Star size={16}/> Hoje</h3><span className="bg-white px-2 rounded-full text-xs font-bold text-blue-700">{buckets.today.length}</span></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">{buckets.today.map(item => <PostSaleCard key={item.client.id} item={item} type="today" />)}</div>
                        </div>

                        {/* COLUNA 2: ONTEM */}
                        <div className="flex-1 flex flex-col bg-purple-50 rounded-xl border border-purple-200 overflow-hidden min-w-0">
                            <div className="p-3 bg-purple-100 border-b border-purple-200 flex justify-between items-center"><h3 className="font-bold text-purple-900 flex items-center gap-2 text-xs lg:text-sm"><ThumbsUp size={16}/> Ontem</h3><span className="bg-white px-2 rounded-full text-xs font-bold text-purple-700">{buckets.yesterday.length}</span></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">{buckets.yesterday.map(item => <PostSaleCard key={item.client.id} item={item} type="yesterday" />)}</div>
                        </div>

                        {/* COLUNA 3: OPORTUNIDADE */}
                        <div className="flex-1 flex flex-col bg-green-50 rounded-xl border border-green-200 overflow-hidden min-w-0">
                            <div className="p-3 bg-green-100 border-b border-green-200 flex justify-between items-center"><h3 className="font-bold text-green-900 flex items-center gap-2 text-xs lg:text-sm"><Clock size={16}/> Ideal (25-30d)</h3><span className="bg-white px-2 rounded-full text-xs font-bold text-green-700">{buckets.opportunity.length}</span></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">{buckets.opportunity.map(item => <PostSaleCard key={item.client.id} item={item} type="opp" />)}</div>
                        </div>

                        {/* COLUNA 4: ATEN√á√ÉO */}
                        <div className="flex-1 flex flex-col bg-yellow-50 rounded-xl border border-yellow-200 overflow-hidden min-w-0">
                            <div className="p-3 bg-yellow-100 border-b border-yellow-200 flex justify-between items-center"><h3 className="font-bold text-yellow-900 flex items-center gap-2 text-xs lg:text-sm"><AlertTriangle size={16}/> Aten√ß√£o (31d+)</h3><span className="bg-white px-2 rounded-full text-xs font-bold text-yellow-700">{buckets.attention.length}</span></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">{buckets.attention.map(item => <PostSaleCard key={item.client.id} item={item} type="att" />)}</div>
                        </div>

                        {/* COLUNA 5: RISCO */}
                        <div className="flex-1 flex flex-col bg-red-50 rounded-xl border border-red-200 overflow-hidden min-w-0">
                            <div className="p-3 bg-red-100 border-b border-red-200 flex justify-between items-center"><h3 className="font-bold text-red-900 flex items-center gap-2 text-xs lg:text-sm"><XCircle size={16}/> Risco (46d+)</h3><span className="bg-white px-2 rounded-full text-xs font-bold text-red-700">{buckets.risk.length}</span></div>
                            <div className="flex-1 overflow-y-auto p-2 space-y-2 scrollbar-thin">{buckets.risk.map(item => <PostSaleCard key={item.client.id} item={item} type="risk" />)}</div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- RELAT√ìRIOS VIEW (ATUALIZADO V6.2) ---
        function ReportsView({ sales, clients, products, postSaleLog }) {
            const [startDate, setStartDate] = useState(new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().slice(0, 10));
            const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
            const filteredSales = sales.filter(s => { const d = s.date.slice(0, 10); return d >= startDate && d <= endDate && s.status !== 'Cancelado'; });
            
            // C√°lculos existentes...
            const totalRevenue = filteredSales.reduce((acc, s) => acc + s.total, 0);
            const totalOrders = filteredSales.length;
            const ticketMedio = totalOrders > 0 ? totalRevenue / totalOrders : 0;
            let totalCost = 0; filteredSales.forEach(s => { s.items.forEach(item => { const prod = products.find(p => p.id === item.id); if (prod) { if (prod.isCombo) { prod.comboItems?.forEach(ci => { const subProd = products.find(sp => sp.id === ci.id); if (subProd) totalCost += (Number(subProd.cost) || 0) * ci.qty; }); } else { totalCost += (Number(prod.cost) || 0); } } }); });
            const grossProfit = totalRevenue - totalCost;
            const prodCount = {}; filteredSales.forEach(s => s.items.forEach(i => prodCount[i.name] = (prodCount[i.name] || 0) + 1));
            const topProducts = Object.entries(prodCount).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const clientSpend = {}; filteredSales.forEach(s => { const cName = clients.find(c => c.id === s.clientId)?.name || 'N/A'; clientSpend[cName] = (clientSpend[cName] || 0) + s.total; });
            const topClients = Object.entries(clientSpend).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const payMethods = {}; filteredSales.forEach(s => payMethods[s.payMethod] = (payMethods[s.payMethod] || 0) + 1);
            
            // Novos Relat√≥rios
            const salesByCity = {};
            const salesByDistrict = {};
            filteredSales.forEach(s => {
                const client = clients.find(c => c.id === s.clientId);
                if (client) {
                    const city = client.city || 'N/I';
                    const dist = client.district || 'N/I';
                    salesByCity[city] = (salesByCity[city] || 0) + 1;
                    salesByDistrict[dist] = (salesByDistrict[dist] || 0) + 1;
                }
            });
            const topCities = Object.entries(salesByCity).sort((a,b) => b[1]-a[1]);
            const topDistricts = Object.entries(salesByDistrict).sort((a,b) => b[1]-a[1]).slice(0, 5);
            
            // Total Cashbacks enviados
            const totalCashbacks = Object.values(postSaleLog).reduce((acc, log) => {
                 const logDate = log.date.slice(0, 10);
                 return (logDate >= startDate && logDate <= endDate) ? acc + log.count : acc;
            }, 0);

            return (
                <div className="h-full flex flex-col p-6 overflow-y-auto bg-gray-50">
                     <div className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm border"><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><TrendingUp/> Relat√≥rios & Intelig√™ncia</h2><div className="flex gap-2 items-center"><input type="date" className="border p-2 rounded text-sm" value={startDate} onChange={e => setStartDate(e.target.value)} /><span className="text-gray-400">at√©</span><input type="date" className="border p-2 rounded text-sm" value={endDate} onChange={e => setEndDate(e.target.value)} /></div></div>
                     
                     <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-l-4 border-l-blue-500"><p className="text-xs font-bold text-gray-400 uppercase">Faturamento</p><p className="text-2xl font-bold text-blue-700">{formatCurrency(totalRevenue)}</p></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-l-4 border-l-emerald-500"><p className="text-xs font-bold text-gray-400 uppercase">Lucro Bruto (Est.)</p><p className="text-2xl font-bold text-emerald-700">{formatCurrency(grossProfit)}</p></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-l-4 border-l-orange-500"><p className="text-xs font-bold text-gray-400 uppercase">Ticket M√©dio</p><p className="text-2xl font-bold text-orange-700">{formatCurrency(ticketMedio)}</p></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-l-4 border-l-purple-500"><p className="text-xs font-bold text-gray-400 uppercase">Total Pedidos</p><p className="text-2xl font-bold text-purple-700">{totalOrders}</p></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-l-4 border-l-pink-500"><p className="text-xs font-bold text-gray-400 uppercase">Cashbacks Env.</p><p className="text-2xl font-bold text-pink-700">{totalCashbacks}</p></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div className="bg-white p-4 rounded-xl shadow-sm border"><h3 className="font-bold text-gray-700 mb-4 text-sm uppercase border-b pb-2">Por Pagamento</h3><div className="space-y-2">{Object.entries(payMethods).map(([method, qtd], i) => (<div key={i} className="flex justify-between text-sm"><span className="text-gray-600">{method}</span><span className="font-bold">{qtd}</span></div>))}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border"><h3 className="font-bold text-gray-700 mb-4 text-sm uppercase border-b pb-2">Por Cidade</h3><div className="space-y-2">{topCities.map(([city, qtd], i) => (<div key={i} className="flex justify-between text-sm"><span className="text-gray-600">{city}</span><span className="font-bold">{qtd}</span></div>))}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border"><h3 className="font-bold text-gray-700 mb-4 text-sm uppercase border-b pb-2">Top Bairros</h3><div className="space-y-2">{topDistricts.map(([dist, qtd], i) => (<div key={i} className="flex justify-between text-sm"><span className="text-gray-600">{dist}</span><span className="font-bold">{qtd}</span></div>))}</div></div>
                    </div>
                </div>
            )
        }

        // --- STOCK MANAGER ---
        function StockManager({ products, setProducts }) {
             const [bulkIn, setBulkIn] = useState(''); const [bulkOut, setBulkOut] = useState(''); const sortedProducts = [...products].sort((a,b) => a.name.localeCompare(b.name));
             const processBulk = (text, type) => { 
                 const lines = text.split('\n'); const newProducts = [...products]; let log = []; let errors = []; 
                 lines.forEach(line => { 
                     if(!line.trim()) return; 
                     const parts = line.split(/[|\t]+/); 
                     const code = parts[0]?.trim(); 
                     const qty = parseInt(parts[1]?.trim()); 
                     const validity = parts[2]?.trim();

                     if (!code || isNaN(qty)) return; 
                     const prodIndex = newProducts.findIndex(p => (p.internalCode && p.internalCode === code) || (p.barcode && p.barcode === code) || (p.name.toUpperCase() === code.toUpperCase())); 
                     if (prodIndex !== -1) { 
                         const prod = newProducts[prodIndex]; const oldStock = prod.stock; 
                         if (type === 'IN') { 
                             prod.stock += qty; 
                             prod.stockHistory.push({ date: new Date().toISOString(), type: 'BULK_IN', qty, validity }); 
                             log.push(`${prod.name}: ${oldStock} -> ${prod.stock}`); 
                         } else { 
                             prod.stock -= qty; 
                             prod.stockHistory.push({ date: new Date().toISOString(), type: 'BULK_OUT', qty }); 
                             log.push(`${prod.name}: ${oldStock} -> ${prod.stock}`); 
                         } 
                     } else { errors.push(code); } 
                 }); 
                 setProducts(newProducts); let resultMsg = `${type === 'IN' ? 'ENTRADA' : 'SA√çDA'} PROCESSADA!\n\n`; if(log.length > 0) resultMsg += `Itens: ${log.length}\n`; if(errors.length > 0) resultMsg += `\nErros: ${errors.join(', ')}`; alert(resultMsg); if(type === 'IN') setBulkIn(''); else setBulkOut(''); 
            };
             return (<div className="flex h-full"><div className="w-1/3 border-r bg-gray-50 p-4 overflow-y-auto scrollbar-thin">{sortedProducts.map(p => (<div key={p.id} className="flex justify-between items-center text-xs py-2 border-b"><div><span className="font-bold block">{p.name}</span><span className="text-[10px] text-gray-500">{p.internalCode}</span></div><span className={`font-bold px-2 py-1 rounded ${p.stock <= 5 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{p.stock}</span></div>))}</div><div className="flex-1 p-6 space-y-4 overflow-y-auto"><div className="grid grid-cols-2 gap-6"><div><h3 className="font-bold text-green-700 mb-2">Entrada (C√ìD | QTD | VALIDADE)</h3><textarea className="w-full h-64 border p-2 text-xs font-mono bg-green-50" placeholder="Ex: 101 | 5 | 10/12/2025" value={bulkIn} onChange={e=>setBulkIn(e.target.value)}></textarea><button onClick={()=>processBulk(bulkIn, 'IN')} className="btn-primary w-full bg-green-600 hover:bg-green-700 mt-2">PROCESSAR ENTRADA</button></div><div><h3 className="font-bold text-red-700 mb-2">Sa√≠da (C√ìD | QTD)</h3><textarea className="w-full h-64 border p-2 text-xs font-mono bg-red-50" placeholder="Ex: 101 | 1" value={bulkOut} onChange={e=>setBulkOut(e.target.value)}></textarea><button onClick={()=>processBulk(bulkOut, 'OUT')} className="btn-primary w-full bg-red-600 hover:bg-red-700 mt-2">PROCESSAR SA√çDA</button></div></div></div></div>)
        }
        
        // --- DRIVER VIEW ---
        function DriverView({ data, onExit }) {
          const [deliveryModal, setDeliveryModal] = useState(null); 
          const [filter, setFilter] = useState('Todas'); 
          const [deliveryResults, setDeliveryResults] = useState({});

          if (!data) return <div className="p-4 text-center">Dados inv√°lidos.</div>;
          const companyPhone = data.companyPhone || '65998150975';
          const uniqueRegions = [...new Set(data.orders.map(o => o.region || 'Geral').filter(Boolean))]; 
          const regions = ['Todas', ...uniqueRegions]; 
          const showChips = uniqueRegions.length > 1;

          const filteredOrders = filter === 'Todas' ? data.orders : data.orders.filter(o => (o.region || 'Geral') === filter);
          const visibleOrders = [...filteredOrders].sort((a, b) => { 
             const aDone = !!deliveryResults[a.id];
             const bDone = !!deliveryResults[b.id];
             if (aDone === bDone) return 0;
             return aDone ? 1 : -1;
          });

          const sendToCustomer = (phone, msg) => { 
             if(!phone) return alert("Telefone n√£o cadastrado.");
             const cleanPhone = phone.replace(/\D/g,''); 
             window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank'); 
          };

          const handleDeliveryConfirm = (method) => { 
            if (!deliveryModal) return; 
            const order = deliveryModal; 
            setDeliveryResults(prev => ({ ...prev, [order.id]: { status: 'Entregue', payMethod: method } })); 
            setDeliveryModal(null); 
          };

          const handleCancelDelivery = (order) => {
              if(confirm("Deseja realmente CANCELAR esta entrega? O produto voltar√° ao estoque.")) {
                  setDeliveryResults(prev => ({ ...prev, [order.id]: { status: 'Cancelado', payMethod: '-' } }));
              }
          };

          const generateFinalReport = () => {
              let report = `RELAT√ìRIO DE ENTREGA - ${new Date().toLocaleDateString()}\n--------------------------------\n`;
              Object.entries(deliveryResults).forEach(([id, res]) => {
                  report += `ID: ${id} | STATUS: ${res.status.toUpperCase()} | PGTO: ${res.payMethod}\n`;
              });
              const textArea = document.createElement("textarea");
              textArea.value = report;
              document.body.appendChild(textArea);
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              alert("RELAT√ìRIO COPIADO! Envie no WhatsApp da empresa.");
              window.open(`https://wa.me/55${companyPhone}?text=${encodeURIComponent(report)}`, '_blank');
          };

          const completedCount = Object.keys(deliveryResults).length;
          const progress = Math.round((completedCount / data.orders.length) * 100); 
          const allFinished = completedCount === data.orders.length;

          return (
            <div className="min-h-screen bg-gray-50 text-gray-800 pb-20">
               <header className="bg-indigo-700 text-white p-4 sticky top-0 z-10 shadow-md">
                 <div className="flex justify-between items-center mb-2">
                    <h1 className="font-bold text-lg">ROTA: {data.route}</h1>
                    <button onClick={onExit} className="text-xs bg-indigo-800 px-2 py-1 rounded hover:bg-indigo-900 transition">Sair</button>
                 </div>
                 {showChips && (<div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin mb-1">{regions.map(r => (<button key={r} onClick={() => setFilter(r)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition border ${filter === r ? 'bg-white text-indigo-700 border-white' : 'bg-indigo-800 text-indigo-200 border-indigo-600 hover:bg-indigo-600'}`}>{r}</button>))}</div>)}
                 <div className="flex justify-between items-end">
                    <div className="text-xs opacity-80"><span>{completedCount}/{data.orders.length} Entregas</span></div>
                    <div className="w-1/2 bg-indigo-900 rounded-full h-1.5 overflow-hidden"><div className="bg-green-400 h-full transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                 </div>
               </header>
               <div className="p-4 space-y-6">
                  {visibleOrders.map((order) => {
                    const result = deliveryResults[order.id];
                    const isDone = !!result;
                    const isCancelled = result?.status === 'Cancelado';
                    const clientFirstName = order.customer.split(' ')[0];
                    return (
                        <div key={order.id} className={`rounded-lg shadow-sm border overflow-hidden relative transition-all duration-500 ${isDone ? 'bg-gray-100 border-gray-200 opacity-75' : 'bg-white'}`}>
                        {isDone && (<div className={`absolute top-2 right-2 z-20 px-2 py-1 rounded-full flex items-center gap-1 shadow-sm font-bold text-[10px] text-white ${isCancelled ? 'bg-red-600' : 'bg-green-600'}`}>{isCancelled ? <XCircle size={12}/> : <Check size={12}/>} {result.status.toUpperCase()}</div>)}
                        <div className={`p-3 border-b flex justify-between items-center ${isDone ? 'bg-gray-200 border-gray-300' : 'bg-indigo-50 border-indigo-100'}`}><span className={`font-bold px-3 py-1 rounded-full text-sm shadow-sm ${isDone ? 'bg-gray-300 text-gray-600' : 'text-indigo-900 bg-white'}`}>#{order.id}</span>{!isDone && <span className="font-bold text-indigo-900 text-sm">Pendente</span>}</div>
                        <div className="p-4">
                            <h2 className="font-bold text-xl text-gray-800 mb-1 leading-tight">{order.customer}</h2>
                            <p className="text-gray-600 text-sm mb-4 flex items-start gap-1"><MapPin size={16} className="mt-0.5 shrink-0 text-gray-400"/> {order.address}, {order.district}</p>
                            
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <a href={`tel:${order.phone}`} className="flex flex-col items-center justify-center bg-gray-100 py-3 rounded hover:bg-gray-200 active:scale-95 transition"><Phone size={20} className="text-gray-700 mb-1"/><span className="text-[10px] font-bold text-gray-600">LIGAR COMP.</span></a>
                                {order.phone2 ? (<a href={`tel:${order.phone2}`} className="flex flex-col items-center justify-center bg-gray-100 py-3 rounded hover:bg-gray-200 active:scale-95 transition"><Phone size={20} className="text-blue-700 mb-1"/><span className="text-[10px] font-bold text-blue-600">LIGAR RECEB.</span></a>) : (<div className="flex flex-col items-center justify-center bg-gray-50 py-3 rounded opacity-50 cursor-not-allowed"><Phone size={20} className="text-gray-300 mb-1"/><span className="text-[10px] font-bold text-gray-400">SEM 2¬∫ TEL</span></div>)}
                            </div>

                            <div className="grid grid-cols-3 gap-2 mb-4">
                                <button onClick={() => sendToCustomer(order.phone, `Ol√° ${clientFirstName}! Sua entrega chega em aproximadamente 10 minutos. üöö`)} className="flex flex-col items-center justify-center bg-blue-50 py-3 rounded hover:bg-blue-100 active:scale-95 transition"><Clock size={20} className="text-blue-600 mb-1"/><span className="text-[10px] font-bold text-blue-700">10 MIN</span></button>
                                <button onClick={() => sendToCustomer(order.phone, `Ol√° ${clientFirstName}! O entregador chegou e est√° aguardando. üè†`)} className="flex flex-col items-center justify-center bg-yellow-50 py-3 rounded hover:bg-yellow-100 active:scale-95 transition"><Home size={20} className="text-yellow-600 mb-1"/><span className="text-[10px] font-bold text-yellow-700">CHEGUEI</span></button>
                                <a href={`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(order.address + ', ' + order.district)}`} target="_blank" className="flex flex-col items-center justify-center bg-green-50 py-3 rounded hover:bg-green-100 active:scale-95 transition"><MapPin size={20} className="text-green-600 mb-1"/><span className="text-[10px] font-bold text-green-700">GPS</span></a>
                            </div>

                            <div className="flex gap-2">
                                {isDone ? (<button disabled className="flex-1 bg-gray-200 text-gray-400 border border-gray-300 py-3 rounded font-bold text-sm flex items-center justify-center gap-2 cursor-not-allowed"><CheckCircle size={18}/> FINALIZADO</button>) : (<><button onClick={() => handleCancelDelivery(order)} className="w-1/3 bg-red-100 text-red-700 py-3 rounded font-bold text-sm hover:bg-red-200 flex items-center justify-center border border-red-200"><XCircle size={18}/> CANCELAR</button><button onClick={() => setDeliveryModal(order)} className="flex-1 bg-emerald-600 text-white py-3 rounded font-bold text-sm hover:bg-emerald-700 flex items-center justify-center gap-2 shadow animate-pulse"><CheckCircle size={18}/> ENTREGAR</button></>)}
                            </div>

                            <div className={`p-3 rounded text-sm mt-3 border ${isDone ? 'bg-gray-100 border-gray-200 text-gray-500' : 'bg-gray-50 border-gray-100'}`}>
                                <div className="flex justify-between mb-1"><span className="text-gray-500">Forma Pagto Prevista:</span><span className="font-bold uppercase">{order.pay}</span></div>
                                <div className="flex justify-between items-center mb-1"><span className="text-gray-500">Valor Total:</span><span className={`font-bold text-xl ${isDone ? 'text-gray-600' : 'text-green-700'}`}>{formatCurrency(order.total)}</span></div>
                                {order.change > 0 && <div className="text-xs text-orange-600 font-bold mt-1">Troco p/: {formatCurrency(order.change + order.total)}</div>}
                            </div>
                            {order.clientObs && <div className="text-xs text-purple-700 bg-purple-50 p-2 mt-2 rounded border border-purple-100 font-medium">‚ö†Ô∏è Obs Cliente: {order.clientObs}</div>}
                        </div>
                        </div>
                    );
                  })}
               </div>
               
               {/* MODAL DE BAIXA */}
               {deliveryModal && (
                 <div className="fixed inset-0 bg-black/80 z-50 flex items-end justify-center sm:items-center p-4 animate-in">
                    <div className="bg-white w-full max-w-sm rounded-xl p-4 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h3 className="font-bold text-lg text-gray-800">Confirmar Pagamento</h3>
                            <button onClick={() => setDeliveryModal(null)} className="bg-gray-200 p-1 rounded-full"><XCircle size={20}/></button>
                        </div>
                        <p className="text-xs text-center text-gray-500 mb-2">Selecione como voc√™ recebeu:</p>
                        <div className="grid grid-cols-2 gap-3 mb-2">
                            <button onClick={() => handleDeliveryConfirm('DINHEIRO')} className="bg-green-100 text-green-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-green-200"><DollarSign size={24}/> DINHEIRO</button>
                            <button onClick={() => handleDeliveryConfirm('PIX')} className="bg-indigo-100 text-indigo-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-indigo-200"><Share2 size={24}/> PIX</button>
                            <button onClick={() => handleDeliveryConfirm('CART√ÉO')} className="bg-blue-100 text-blue-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-blue-200"><CreditCard size={24}/> CART√ÉO</button>
                            <button onClick={() => handleDeliveryConfirm('S√ì ENTREGUE')} className="bg-gray-100 text-gray-800 p-4 rounded-lg font-bold flex flex-col items-center gap-1 hover:bg-gray-200"><CheckCircle size={24}/> J√Å PAGO</button>
                        </div>
                    </div>
                 </div>
               )}

               {allFinished && (
                   <div className="fixed bottom-0 left-0 w-full p-4 bg-white border-t shadow-lg z-50 animate-in">
                       <button onClick={generateFinalReport} className="w-full bg-green-600 text-white font-bold py-4 rounded-xl text-lg shadow-xl hover:bg-green-700 flex items-center justify-center gap-2">
                           <MessageSquare size={24}/> FINALIZAR E ENVIAR RELAT√ìRIO
                       </button>
                   </div>
               )}
            </div>
          );
        }

        // --- POSVIEW (MANTIDO V6.2) ---
        function POSView({ clients, products, setProducts, sales, setSales, saleToEdit, setSaleToEdit }) {
             // ... [Mantendo l√≥gica do POSView intacta para garantir funcionamento] ...
             const [selectedClient, setSelectedClient] = useState('');
             const [clientSearch, setClientSearch] = useState('');
             const [cart, setCart] = useState([]);
             const [payMethod, setPayMethod] = useState('Pix');
             const [changeFor, setChangeFor] = useState(''); 
             const [obs, setObs] = useState(''); 
             const [searchProd, setSearchProd] = useState('');
             const [selectedCategory, setSelectedCategory] = useState('todas');
             const [editingItem, setEditingItem] = useState(null); 
             const [volumes, setVolumes] = useState(1); 
             const [tempQty, setTempQty] = useState({});
             const [manualTotal, setManualTotal] = useState('');

             useEffect(() => {
                if (saleToEdit) {
                  const client = clients.find(c => c.id === saleToEdit.clientId);
                  if (client) { setSelectedClient(client.id); setClientSearch(client.name); }
                  setCart(saleToEdit.items.map(i => ({...i, tempId: generateId()})));
                  setObs(saleToEdit.obs); setPayMethod(saleToEdit.payMethod);
                  if (saleToEdit.changeFor) setChangeFor(saleToEdit.changeFor);
                  setVolumes(saleToEdit.volumes || 1);
                  setManualTotal(saleToEdit.total.toFixed(2)); 
                  setSaleToEdit(null); 
                }
              }, [saleToEdit, clients]);
    
             const getQty = (id) => tempQty[id] || 1;
             const incQty = (id) => setTempQty({...tempQty, [id]: getQty(id) + 1});
             const decQty = (id) => setTempQty({...tempQty, [id]: Math.max(1, getQty(id) - 1)});

             const addToCart = (product) => {
                const qty = getQty(product.id);
                if (!product.isCombo && product.stock < qty) {
                  if (!confirm(`Estoque baixo (${product.stock}). Adicionar ${qty} mesmo assim?`)) return;
                }
                const itemsToAdd = [];
                for(let i=0; i<qty; i++) {
                   const cartItem = { 
                       ...product, tempId: generateId(), originalPrice: product.price,
                       comboItems: product.isCombo ? product.comboItems.map(ci => {
                           const subProd = products.find(p => p.id === ci.id);
                           const subTotalTable = product.comboItems.reduce((acc, item) => {
                               const p = products.find(prod => prod.id === item.id);
                               return acc + ((p?.price || 0) * item.qty);
                           }, 0);
                           const ratio = subTotalTable > 0 ? product.price / subTotalTable : 1;
                           return { ...ci, internalPrice: (subProd?.price || 0) * ratio }; 
                       }) : []
                   };
                   itemsToAdd.push(cartItem);
                }
                const newCart = [...cart, ...itemsToAdd];
                setCart(newCart);
                const newSum = newCart.reduce((acc, i) => acc + i.price, 0);
                setManualTotal(newSum.toFixed(2));
                setTempQty({...tempQty, [product.id]: 1}); 
             };

             const removeFromCart = (tempId) => {
                 const newCart = cart.filter(item => item.tempId !== tempId);
                 setCart(newCart);
                 const newSum = newCart.reduce((acc, i) => acc + i.price, 0);
                 setManualTotal(newSum.toFixed(2));
             };
             
             const handleManualTotalChange = (val) => {
                 setManualTotal(val);
                 const target = parseFloat(val);
                 if (!isNaN(target) && cart.length > 0) {
                     const newCart = distributeTotal(target, cart, (i)=>i.price, (i, v)=>i.price=v, ()=>1);
                     setCart(newCart);
                 }
             };

             const updateCartItemPrice = () => {
                if (!editingItem) return;
                const newCart = cart.map(i => i.tempId === editingItem.tempId ? { ...i, price: parseFloat(editingItem.price) } : i);
                setCart(newCart);
                const newSum = newCart.reduce((acc, i) => acc + i.price, 0);
                setManualTotal(newSum.toFixed(2));
                setEditingItem(null);
             };

             const updateComboItemQty = (cartItemTempId, subItemId, newQty) => {
                 setCart(cart.map(item => {
                    if (item.tempId !== cartItemTempId) return item;
                    return { ...item, comboItems: item.comboItems.map(sub => sub.id === subItemId ? {...sub, qty: newQty} : sub) };
                 }));
             };

             const subTotal = cart.reduce((acc, item) => acc + Number(item.price), 0);
             
             const finalizeSale = () => {
                if (!selectedClient) return alert('Selecione um cliente');
                if (cart.length === 0) return alert('Carrinho vazio');
                
                const finalTotal = parseFloat(manualTotal) || subTotal;

                const newProducts = [...products];
                cart.forEach(cartItem => {
                  const dbProd = newProducts.find(p => p.id === cartItem.id);
                  if (dbProd) {
                    if (dbProd.isCombo) {
                      cartItem.comboItems?.forEach(ing => {
                         const dbIng = newProducts.find(p => p.id === ing.id);
                         if (dbIng) {
                           dbIng.stock = Math.max(0, dbIng.stock - ing.qty);
                           dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'SALE_COMBO', qty: ing.qty, ref: cartItem.name });
                         }
                      });
                    } else {
                      dbProd.stock = Number(dbProd.stock) - 1;
                      dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'SALE', qty: 1 });
                    }
                  }
                });
                
                setProducts(newProducts);
                const shortId = generateDailyId(sales);
                const newSale = {
                  id: shortId, fullId: generateId(), clientId: selectedClient, items: cart,
                  subTotal: subTotal, 
                  discount: subTotal - finalTotal,
                  total: finalTotal, 
                  payMethod, changeFor: payMethod === 'Dinheiro' ? changeFor : null, obs,
                  date: new Date().toISOString(), status: 'Pendente', printedLabel: false, printedList: false, volumes: volumes, routeId: null
                };
                setSales([...sales, newSale]);
                setCart([]); setSelectedClient(''); setClientSearch(''); setObs(''); setChangeFor(''); setVolumes(1); setManualTotal('');
                alert(`Venda #${shortId} Realizada!`);
             };

             const filteredProducts = products.filter(p => (selectedCategory === 'todas' || p.category === selectedCategory) && p.name.toLowerCase().includes(searchProd.toLowerCase()));
             const filteredClients = clients.filter(c => c.name.toLowerCase().includes(clientSearch.toLowerCase()));
             const categories = ['todas', ...new Set(products.map(p => p.category))];

             return (
                <div className="flex h-full">
                    <div className="flex-1 flex flex-col border-r bg-white p-4">
                        <div className="flex gap-4 mb-4 shrink-0">
                            <div className="relative flex-1">
                                <Search className="absolute left-3 top-2.5 text-gray-400" size={20}/><input className="w-full pl-10 pr-4 py-2 border rounded-lg bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" placeholder="Buscar produto..." value={searchProd} onChange={e => setSearchProd(e.target.value)} />
                            </div>
                            <select className="border rounded-lg px-4 bg-white outline-none focus:border-blue-500" value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)}><option value="todas">Todas</option>{categories.filter(c=>c!=='todas').map(c => <option key={c} value={c}>{c}</option>)}</select>
                        </div>
                        <div className="flex-1 overflow-y-auto scrollbar-thin">
                            <div className="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3">{filteredProducts.map(p => (<div key={p.id} className="bg-white border rounded-lg p-3 hover:shadow-md transition cursor-pointer flex flex-col h-32 relative group border-slate-200" onClick={() => addToCart(p)}><div className="flex justify-between items-start mb-1"><span className="bg-slate-100 text-slate-600 text-[10px] font-mono px-1.5 rounded">{p.internalCode || '-'}</span><span className={`text-[10px] px-1.5 rounded font-bold ${p.stock > 10 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{p.stock} un</span></div><h4 className="font-bold text-sm text-gray-800 leading-tight mb-auto line-clamp-2">{p.name}</h4><div className="flex justify-between items-end mt-2"><div className="text-lg font-bold text-green-700">{formatCurrency(p.price)}</div><button className="bg-blue-600 text-white p-1.5 rounded hover:bg-blue-700 transition shadow-sm opacity-0 group-hover:opacity-100"><Plus size={16}/></button></div></div>))}</div>
                        </div>
                    </div>
                    <div className="w-[400px] flex flex-col bg-gray-50 h-full border-l shadow-xl z-10">
                        <div className="p-4 bg-white border-b shrink-0 z-20">
                            <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Cliente</label>
                            <div className="relative">
                                <input className={`w-full p-2 border rounded-lg outline-none ${selectedClient ? 'bg-green-50 border-green-500 text-green-800 font-bold' : 'bg-white'}`} placeholder="Buscar Cliente..." value={clientSearch} onChange={e => { setClientSearch(e.target.value); setSelectedClient(''); }} />
                                {clientSearch && !selectedClient && (<div className="absolute top-full left-0 w-full bg-white border shadow-xl max-h-60 overflow-y-auto z-50 rounded-b-lg">{filteredClients.map(c => (<div key={c.id} className="p-3 hover:bg-blue-50 cursor-pointer border-b flex justify-between items-center" onClick={() => { setSelectedClient(c.id); setClientSearch(c.name); }}><div><div className="font-bold text-sm">{c.name}</div><div className="text-xs text-gray-500">{c.district}</div></div></div>))}</div>)}
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin">
                            {cart.length === 0 && (<div className="h-full flex flex-col items-center justify-center text-gray-400 opacity-60"><ShoppingCart size={48} className="mb-2"/><p>Carrinho Vazio</p></div>)}
                            {cart.map(item => (
                                <div key={item.tempId} className="bg-white p-3 rounded-lg border shadow-sm relative group">
                                    <div className="flex justify-between items-start mb-1"><div className="font-bold text-sm text-gray-800 pr-6">{item.name}</div><button onClick={() => removeFromCart(item.tempId)} className="text-gray-300 hover:text-red-500 absolute top-2 right-2"><XCircle size={16}/></button></div>
                                    <div className="flex justify-between items-center"><button onClick={() => setEditingItem({tempId: item.tempId, price: item.price})} className="text-sm font-bold text-green-700 hover:underline">{formatCurrency(item.price)}</button><div className="text-xs text-gray-400">Unit√°rio</div></div>
                                    {item.isCombo && (<div className="mt-2 bg-yellow-50 p-2 rounded border border-yellow-100">{item.comboItems.map(ci => (<div key={ci.id} className="flex justify-between items-center text-xs py-1 border-b border-yellow-100 last:border-0"><span className="text-gray-600 truncate max-w-[150px]">{products.find(p => p.id === ci.id)?.name || 'Item'}</span><div className="flex items-center bg-white border rounded"><button className="px-1.5 hover:bg-gray-100" onClick={() => updateComboItemQty(item.tempId, ci.id, Math.max(0, ci.qty - 1))}>-</button><span className="w-5 text-center font-bold">{ci.qty}</span><button className="px-1.5 hover:bg-gray-100" onClick={() => updateComboItemQty(item.tempId, ci.id, ci.qty + 1)}>+</button></div></div>))}</div>)}
                                </div>
                            ))}
                        </div>
                        <div className="bg-white border-t p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
                            <div className="flex justify-between items-center mb-4">
                                <span className="text-gray-500 font-bold uppercase text-xs">Total Final (Edit√°vel)</span>
                                <input className="font-bold text-2xl text-right w-32 border-b-2 border-emerald-500 focus:outline-none text-emerald-600" value={manualTotal} onChange={(e) => handleManualTotalChange(e.target.value)} />
                            </div>
                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <div><label className="text-[10px] font-bold text-gray-400 uppercase">Pagamento</label><select className="w-full border rounded p-1.5 text-sm bg-gray-50 outline-none" value={payMethod} onChange={e => setPayMethod(e.target.value)}><option value="Pix">Pix</option><option value="Dinheiro">Dinheiro</option><option value="Cart√£o">Cart√£o</option></select></div>
                                <div><label className="text-[10px] font-bold text-gray-400 uppercase">Volumes</label><select className="w-full border rounded p-1.5 text-sm bg-gray-50 outline-none" value={volumes} onChange={e => setVolumes(e.target.value)}>{[1,2,3,4,5,6,7,8,9,10].map(n => <option key={n} value={n}>{n}</option>)}</select></div>
                            </div>
                            {payMethod === 'Dinheiro' && (<div className="mb-4"><label className="text-[10px] font-bold text-gray-400 uppercase">Troco Para</label><input className="w-full border rounded p-2 text-sm bg-gray-50 outline-none" type="number" placeholder="R$ 0,00" value={changeFor} onChange={e => setChangeFor(e.target.value)} /></div>)}
                            <input className="w-full border rounded p-2 text-sm bg-gray-50 outline-none mb-4" placeholder="Observa√ß√µes..." value={obs} onChange={e => setObs(e.target.value)} />
                            <button onClick={finalizeSale} className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition shadow-lg flex justify-between items-center px-6"><span>FINALIZAR</span><span className="text-emerald-400 text-xl">{formatCurrency(parseFloat(manualTotal) || 0)}</span></button>
                        </div>
                    </div>
                    {editingItem && (<div className="absolute inset-0 bg-black/50 z-50 flex flex-col items-center justify-center p-4"><div className="bg-white p-6 rounded-xl shadow-2xl flex flex-col gap-4 w-72"><h3 className="text-sm font-bold text-center">Ajustar Pre√ßo</h3><input type="number" autoFocus className="text-3xl font-bold text-center border-b-2 border-blue-500 outline-none pb-2 w-full" value={editingItem.price} onChange={e => setEditingItem({...editingItem, price: e.target.value})}/><div className="flex gap-2"><button onClick={() => setEditingItem(null)} className="flex-1 bg-gray-100 py-2 rounded font-bold text-gray-500">Cancelar</button><button onClick={updateCartItemPrice} className="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Salvar</button></div></div></div>)}
                </div>
             );
        }

        // --- REGISTRY VIEW (ATUALIZADO V6.2) ---
        function RegistryView({ clients, setClients, products, setProducts }) {
            const [tab, setTab] = useState('clients');
            const [cForm, setCForm] = useState({ name: '', code: '', phone: '', phone2: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' });
            const [pForm, setPForm] = useState({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
            const [editingClientId, setEditingClientId] = useState(null);
            const [editingProductId, setEditingProductId] = useState(null);
            const [search, setSearch] = useState('');

            const saveClient = () => { 
                if (!cForm.name) return alert('Nome obrigat√≥rio'); 
                if (editingClientId) { 
                    setClients(clients.map(c => c.id === editingClientId ? { ...cForm, id: editingClientId, code: c.code || cForm.code } : c)); 
                    setEditingClientId(null); 
                    alert('Atualizado!'); 
                } else { 
                    const newCode = generateClientCode(clients); 
                    setClients([...clients, { ...cForm, id: generateId(), code: newCode }]); 
                    alert(`Criado: ${newCode}`); 
                } 
                setCForm({ name: '', code: '', phone: '', phone2: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' }); 
            };
            const saveProduct = () => { 
                if (!pForm.name) return alert('Nome obrigat√≥rio'); 
                if (editingProductId) { 
                    setProducts(products.map(p => p.id === editingProductId ? { ...pForm, id: editingProductId, stock: p.stock, stockHistory: p.stockHistory } : p)); 
                    setEditingProductId(null); 
                    alert('Atualizado!'); 
                } else { 
                    const newProd = { ...pForm, id: generateId(), stockHistory: [{ date: new Date().toISOString(), type: 'INITIAL', qty: Number(pForm.stock) }] }; 
                    setProducts([...products, newProd]); 
                    alert('Criado!'); 
                } 
                setPForm({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] }); 
            };
            
            const list = tab === 'clients' ? clients.filter(c => c.name.toLowerCase().includes(search.toLowerCase())).sort((a,b) => a.name.localeCompare(b.name)) : products.filter(p => p.name.toLowerCase().includes(search.toLowerCase())).sort((a,b) => a.name.localeCompare(b.name));

            return (
                <div className="flex h-full"><div className="w-1/3 border-r bg-white flex flex-col"><div className="p-4 border-b"><div className="flex bg-gray-100 p-1 rounded-lg mb-4"><button onClick={() => setTab('clients')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${tab === 'clients' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>CLIENTES</button><button onClick={() => setTab('products')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${tab === 'products' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>PRODUTOS</button></div><input className="w-full bg-gray-50 border rounded p-2 text-sm outline-none" placeholder="Buscar..." value={search} onChange={e => setSearch(e.target.value)} /></div><div className="flex-1 overflow-y-auto">{list.map(item => (<div key={item.id} className={`p-3 border-b cursor-pointer hover:bg-gray-50 ${(editingClientId === item.id || editingProductId === item.id) ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`} onClick={() => { if(tab === 'clients') { setCForm(item); setEditingClientId(item.id); } else { setPForm(item); setEditingProductId(item.id); } }}><div className="font-bold text-sm text-gray-800">{item.name}</div><div className="text-xs text-gray-500">{tab === 'clients' ? item.district : `${formatCurrency(item.price)} ‚Ä¢ Est: ${item.stock}`}</div></div>))}</div><div className="p-3 border-t bg-gray-50 text-center"><button onClick={() => { tab === 'clients' ? (setCForm({ name: '', code: '', phone: '', phone2: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' }), setEditingClientId(null)) : (setPForm({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] }), setEditingProductId(null)) }} className="text-xs font-bold text-blue-600 flex items-center justify-center gap-1 w-full py-2 hover:bg-blue-100 rounded"><Plus size={14}/> NOVO CADASTRO</button></div></div><div className="flex-1 bg-gray-50 p-8 overflow-y-auto"><div className="max-w-2xl mx-auto bg-white p-6 rounded-xl shadow-sm border"><h2 className="text-lg font-bold text-gray-800 mb-6 border-b pb-2">{tab === 'clients' ? (editingClientId ? 'Editar Cliente' : 'Novo Cliente') : (editingProductId ? 'Editar Produto' : 'Novo Produto')}</h2>
                {tab === 'clients' ? (
                    <div className="space-y-4">
                        <div className="grid grid-cols-4 gap-4"><div className="col-span-3"><label className="text-xs font-bold text-gray-500 uppercase">Nome</label><input className="input-field" value={cForm.name} onChange={e => setCForm({...cForm, name: e.target.value})} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">C√≥digo</label><input className="input-field bg-gray-100" value={cForm.code} disabled /></div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-500 uppercase">Celular (Comprador)</label><input className="input-field" value={cForm.phone} onChange={e => setCForm({...cForm, phone: e.target.value})} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">Celular (Recebedor)</label><input className="input-field" value={cForm.phone2} onChange={e => setCForm({...cForm, phone2: e.target.value})} /></div></div>
                        <div className="grid grid-cols-3 gap-4">
                            <div className="col-span-2"><label className="text-xs font-bold text-gray-500 uppercase">Cidade</label><input className="input-field" value={cForm.city} onChange={e => setCForm({...cForm, city: e.target.value})} /></div>
                            <div><label className="text-xs font-bold text-gray-500 uppercase">Bairro</label><input className="input-field" value={cForm.district} onChange={e => setCForm({...cForm, district: e.target.value})} /></div>
                        </div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Endere√ßo</label><input className="input-field" value={cForm.address} onChange={e => setCForm({...cForm, address: e.target.value})} /></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-500 uppercase">Regi√£o / Rota</label><select className="input-field" value={cForm.region} onChange={e => setCForm({...cForm, region: e.target.value})}><option value="CUIAB√Å">CUIAB√Å (Centro)</option><option value="COXIPO">COXIPO</option><option value="VARZEA GRANDE">VARZEA GRANDE</option><option value="CPA">CPA</option></select></div><div><label className="text-xs font-bold text-gray-500 uppercase">Link Maps</label><input className="input-field" value={cForm.mapLink} onChange={e => setCForm({...cForm, mapLink: e.target.value})} /></div></div>
                        <div><label className="text-xs font-bold text-gray-500 uppercase">Observa√ß√µes</label><input className="input-field" value={cForm.obs} onChange={e => setCForm({...cForm, obs: e.target.value})} /></div>
                        <button onClick={saveClient} className="w-full btn-primary mt-4">SALVAR CLIENTE</button>
                    </div>
                ) : (
                    <div className="space-y-4">
                        <div className="grid grid-cols-3 gap-4"><div className="col-span-2"><label className="text-xs font-bold text-gray-500 uppercase">Nome Produto</label><input className="input-field" value={pForm.name} onChange={e => setPForm({...pForm, name: e.target.value})} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">C√≥d Interno</label><input className="input-field" value={pForm.internalCode} onChange={e => setPForm({...pForm, internalCode: e.target.value})} /></div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-500 uppercase">Categoria</label><input className="input-field" value={pForm.category} onChange={e => setPForm({...pForm, category: e.target.value})} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">C√≥d Barras</label><input className="input-field" value={pForm.barcode} onChange={e => setPForm({...pForm, barcode: e.target.value})} /></div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-500 uppercase">NCM</label><input className="input-field" value={pForm.ncm} onChange={e => setPForm({...pForm, ncm: e.target.value})} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">Custo</label><input className="input-field" type="number" value={pForm.cost} onChange={e => setPForm({...pForm, cost: e.target.value})} /></div></div>
                        <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-gray-500 uppercase">Pre√ßo Venda</label><input className="input-field font-bold text-green-700" type="number" value={pForm.price} onChange={e => setPForm({...pForm, price: e.target.value})} /></div><div><label className="text-xs font-bold text-gray-500 uppercase">Estoque Atual</label><input className="input-field bg-gray-100" type="number" value={pForm.stock} disabled={pForm.isCombo} onChange={e => setPForm({...pForm, stock: Number(e.target.value)})} /></div></div>
                        <div className="flex items-center gap-2 pt-2 border-t"><input type="checkbox" checked={pForm.isCombo} onChange={e => setPForm({...pForm, isCombo: e.target.checked})} /><label className="font-bold text-sm">Este produto √© um Combo/Kit?</label></div>
                        {pForm.isCombo && (<div className="bg-yellow-50 p-4 rounded border border-yellow-200"><h4 className="font-bold text-yellow-800 text-xs uppercase mb-2">Composi√ß√£o do Kit</h4><div className="space-y-2 max-h-48 overflow-y-auto">{products.filter(p => !p.isCombo).map(p => (<div key={p.id} className="flex justify-between items-center text-sm border-b border-yellow-100 pb-1"><span>{p.name}</span><input type="number" className="w-16 border rounded text-center p-1" placeholder="0" value={pForm.comboItems.find(i => i.id === p.id)?.qty || ''} onChange={(e) => { const qty = Number(e.target.value); const existing = pForm.comboItems.filter(i => i.id !== p.id); if (qty > 0) setPForm({...pForm, comboItems: [...existing, {id: p.id, qty}]}); else setPForm({...pForm, comboItems: existing}); }} /></div>))}</div></div>)}
                        <button onClick={saveProduct} className="w-full btn-primary mt-4">SALVAR PRODUTO</button>
                    </div>
                )}</div></div></div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
