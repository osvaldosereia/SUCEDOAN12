<!DOCTYPE html>
<html lang="pt-BR" itemscope itemtype="https://schema.org/LocalBusiness">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cesta Econ√¥mica | Super Cestas Dona Ant√¥nia</title>
    <meta name="description" content="Cestas b√°sicas com qualidade e pre√ßo justo. Fale com a gente!">
    <meta name="theme-color" content="#ffffff">
    
    <!-- SECURITY PROTOCOL -->
    <script>
        (function() {
            const allowedDomains = ['www.donaantonia.com.br', 'donaantonia.com.br', 'localhost', '127.0.0.1', 'generativelanguage.net'];
            const currentDomain = window.location.hostname;
            const isAllowed = allowedDomains.some(d => currentDomain === d || currentDomain.endsWith('.' + d));

            if (!isAllowed) {
                alert("‚ö†Ô∏è ALERTA DE SEGURAN√áA ‚ö†Ô∏è\n\nSITE CLONADO DETECTADO.\nACESSE O OFICIAL: WWW.DONAANTONIA.COM.BR");
                document.write(`<style>body,html{overflow:hidden!important;height:100%!important;background:#ef4444!important}body>*{filter:invert(1) blur(4px) grayscale(100%)!important;transform:rotate(180deg) scale(.9)!important;pointer-events:none!important;opacity:.5!important}#security-overlay{position:fixed!important;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.95)!important;z-index:999999!important;display:flex!important;flex-direction:column;align-items:center;justify-content:center;color:#fbbf24!important;font-family:sans-serif!important;text-align:center;transform:none!important;filter:none!important;pointer-events:auto!important}</style><div id="security-overlay"><h1 style="font-size:3rem;margin-bottom:20px">üö´ GOLPE DETECTADO üö´</h1><p style="font-size:1.5rem">Este site (<strong>${currentDomain}</strong>) n√£o √© oficial.</p><br><a href="https://www.donaantonia.com.br" style="background:#fbbf24;color:#000;padding:20px;text-decoration:none;font-weight:bold;border-radius:10px;font-size:1.2rem">IR PARA SITE OFICIAL</a></div>`);
                window.stop(); throw new Error("Security Violation");
            }
        })();
    </script>

    <!-- SCHEMA MARKUP -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "GroceryStore",
      "name": "Super Cestas Dona Ant√¥nia",
      "image": "https://donaantonia.com.br/img/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif",
      "telephone": "+5565998150975",
      "url": "https://donaantonia.com.br",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Cuiab√°",
        "addressRegion": "MT",
        "addressCountry": "BR"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": -15.6014, 
        "longitude": -56.0979
      },
      "priceRange": "$$"
    }
    </script>

    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data: blob:;">
    <meta http-equiv="X-Frame-Options" content="DENY">

    <style>
        /* === MODERN MINIMALIST THEME === */
        :root {
            --primary: #2563EB; /* Azul Moderno */
            --primary-light: #EFF6FF;
            --bg-color: #F8FAFC;
            --text-main: #1E293B;
            --text-sub: #64748B;
            --white: #ffffff;
            --bubble-bot: #ffffff;
            --bubble-user: #2563EB;
            --text-user: #ffffff;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --radius-bubble: 18px;
            --radius-card: 24px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body, html {
            height: 100%; margin: 0; padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* HEADER CLEAN */
        .modern-header {
            background-color: var(--white);
            height: 70px;
            padding: 0 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid #E2E8F0;
            z-index: 100; flex-shrink: 0;
        }

        .brand-area { display: flex; align-items: center; gap: 12px; }
        .brand-logo { 
            width: 42px; height: 42px; border-radius: 12px; 
            object-fit: cover; box-shadow: var(--shadow-sm); 
        }
        .brand-info h1 { font-size: 16px; font-weight: 700; margin: 0; color: var(--text-main); }
        .status-badge { 
            display: inline-flex; align-items: center; gap: 6px; 
            font-size: 12px; color: #10B981; font-weight: 500; 
            background: #D1FAE5; padding: 4px 8px; border-radius: 20px; 
        }
        .status-dot { width: 8px; height: 8px; background: #10B981; border-radius: 50%; }

        /* CHAT AREA */
        #chat-container {
            flex: 1; overflow-y: auto; padding: 20px;
            background-color: var(--bg-color);
            /* Sem background image para visual limpo */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* MESSAGES */
        .msg-row { 
            display: flex; width: 100%; margin-bottom: 16px; 
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        .msg-start { justify-content: flex-start; }
        .msg-end { justify-content: flex-end; }

        .msg-bubble {
            padding: 14px 18px;
            max-width: 88%;
            font-size: 15px; line-height: 1.5;
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .msg-in { 
            background-color: var(--bubble-bot); 
            color: var(--text-main);
            border-radius: var(--radius-bubble);
            border-bottom-left-radius: 4px;
        }
        
        .msg-out { 
            background-color: var(--bubble-user); 
            color: var(--text-user);
            border-radius: var(--radius-bubble);
            border-bottom-right-radius: 4px;
        }

        .msg-time { 
            display: block; text-align: right; 
            font-size: 10px; margin-top: 4px; opacity: 0.7; 
        }

        /* ANIMATIONS */
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-dot { 
            width: 6px; height: 6px; background: #94A3B8; 
            border-radius: 50%; display: inline-block; 
            animation: typing 1.4s infinite; margin: 0 2px; 
        }
        @keyframes typing { 0%,100%{transform:scale(0.8);opacity:0.5} 50%{transform:scale(1.2);opacity:1} }

        /* INPUT AREA */
        #input-footer {
            background-color: var(--white);
            padding: 16px 20px;
            border-top: 1px solid #E2E8F0;
            display: flex; align-items: center; gap: 12px;
            flex-shrink: 0; padding-bottom: max(16px, env(safe-area-inset-bottom));
        }

        .modern-input {
            flex: 1; background: #F1F5F9; border-radius: 30px;
            padding: 14px 20px; border: 1px solid transparent;
            font-size: 16px; color: var(--text-main); outline: none;
            transition: all 0.2s;
        }
        .modern-input:focus { background: var(--white); border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }

        .send-btn-modern {
            width: 48px; height: 48px; border-radius: 50%;
            background: var(--primary); color: white; border: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer; transition: transform 0.2s;
            box-shadow: 0 4px 10px rgba(37,99,235,0.3);
        }
        .send-btn-modern:active { transform: scale(0.92); }

        /* OPTIONS BUTTONS */
        .msg-options { display: flex; flex-direction: column; gap: 10px; width: 100%; margin-top: 5px; }
        
        .modern-btn {
            background: var(--white); border: 1px solid #E2E8F0;
            color: var(--primary); font-weight: 600; font-size: 15px;
            padding: 16px; border-radius: 16px; cursor: pointer;
            text-align: left; width: 100%; transition: all 0.2s;
            display: flex; flex-direction: column;
            box-shadow: var(--shadow-sm);
        }
        .modern-btn:active { background: #F8FAFC; transform: scale(0.98); }
        .btn-sub { font-size: 12px; color: var(--text-sub); font-weight: 400; margin-top: 4px; }

        /* === MODERN CARDS === */
        .card-container { width: 100%; max-width: 380px; margin-bottom: 10px; }
        
        .modern-card {
            background: var(--white);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            border: 1px solid #F1F5F9;
        }

        /* HEADER CARD */
        .card-header-img {
            position: relative;
            height: 280px; /* Mantendo a altura solicitada */
            background: #F8FAFC;
            display: flex; justify-content: center; align-items: center;
            padding: 20px;
        }
        .card-img-main {
            width: 240px; height: 240px; /* Mantendo tamanho solicitado */
            object-fit: contain; 
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }
        .selo-modern {
            position: absolute; top: 16px; left: 16px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(4px);
            padding: 6px 12px; border-radius: 20px;
            font-size: 11px; font-weight: 700; color: #B45309;
            box-shadow: var(--shadow-sm); border: 1px solid #FEF3C7;
        }

        /* CHIPS NAVIGATION (Floating Right) */
        .chips-float {
            position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 8px;
            max-height: 90%; overflow-y: auto; padding: 4px;
        }
        .chip-modern {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            padding: 8px 12px; background: rgba(255,255,255,0.85);
            backdrop-filter: blur(4px); border-radius: 12px;
            border: 1px solid #E2E8F0; color: var(--text-sub);
            cursor: pointer; text-align: center; min-width: 70px;
            transition: all 0.2s; box-shadow: var(--shadow-sm);
        }
        .chip-modern.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 4px 10px rgba(37,99,235,0.25);
        }

        /* PRODUCT SLIDER (Modern) */
        .slider-section {
            padding: 16px 0; background: #fff;
            border-bottom: 1px solid #F1F5F9;
            position: relative;
        }
        .modern-slider {
            display: flex; gap: 12px; overflow-x: auto; padding: 0 20px;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .modern-slider::-webkit-scrollbar { display: none; }
        
        .slide-item {
            flex: 0 0 100px;
            background: #F8FAFC; border-radius: 16px;
            padding: 12px 8px; text-align: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid transparent;
        }
        .slide-item img { width: 64px; height: 64px; object-fit: contain; margin-bottom: 8px; }
        .slide-qty { font-size: 11px; font-weight: 700; color: var(--primary); }
        .slide-name { font-size: 11px; color: var(--text-sub); line-height: 1.3; }

        .nav-arrow {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 32px; height: 32px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow-md); color: var(--primary); font-size: 18px;
            cursor: pointer; z-index: 10;
        }

        /* PRICE SECTION */
        .price-section { padding: 20px; background: white; }
        .price-row { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; font-size: 14px; color: var(--text-sub);
        }
        .price-val { font-weight: 700; color: var(--text-main); font-size: 16px; }

        /* DISCOUNT WIDGET */
        .modern-discount {
            background: white; border-radius: var(--radius-card); border: 1px solid #E2E8F0;
            padding: 24px; text-align: center; box-shadow: var(--shadow-sm);
        }
        .discount-highlight {
            background: #ECFDF5; border: 1px dashed #10B981; border-radius: 16px;
            padding: 16px; margin-bottom: 16px;
        }
        .discount-big { font-size: 36px; font-weight: 800; color: #059669; display: block; margin: 4px 0; }
        .discount-label { font-size: 12px; color: #059669; font-weight: 600; text-transform: uppercase; }
        
        .btn-claim {
            width: 100%; padding: 16px; border-radius: 16px;
            background: var(--primary); color: white; font-weight: 700; border: none;
            font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(37,99,235,0.3); transition: transform 0.2s;
        }
        .btn-claim:active { transform: scale(0.97); }

        /* COMPANY CARD MODERN */
        .company-modern { padding: 0; }
        .company-hero {
            padding: 24px; background: var(--white);
            display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #F1F5F9;
        }
        .company-logo-lg { width: 72px; height: 72px; border-radius: 20px; object-fit: cover; box-shadow: var(--shadow-sm); }
        .company-title { font-size: 18px; font-weight: 800; color: var(--text-main); margin: 0 0 4px 0; line-height: 1.2; }
        .company-sub { font-size: 13px; color: var(--text-sub); margin: 0; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr; gap: 8px; padding: 16px; background: #F8FAFC; }
        .stat-modern { 
            background: white; padding: 12px 16px; border-radius: 12px;
            display: flex; align-items: center; gap: 12px; border: 1px solid #E2E8F0;
        }
        .icon-box { 
            width: 32px; height: 32px; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 16px; color: white;
        }

        .social-links { padding: 20px; text-align: center; background: white; }
        .social-pill {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            border-radius: 50px; text-decoration: none; font-weight: 600; font-size: 14px;
            margin: 4px; transition: transform 0.2s;
        }
        .pill-insta { background: #FDF2F8; color: #BE185D; }
        .pill-vip { background: #FEFCE8; color: #A16207; }
        .social-pill:active { transform: scale(0.95); }

    </style>
</head>
<body>

    <!-- HEADER -->
    <header class="modern-header">
        <div class="brand-area">
            <img src="img/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo'" class="brand-logo">
            <div class="brand-info">
                <h1>Dona Ant√¥nia</h1>
                <div class="status-badge">
                    <div class="status-dot"></div> Online
                </div>
            </div>
        </div>
        <div style="display:flex; gap:16px; color:var(--text-sub); font-size:22px;">
            <i class="ph ph-dots-three-vertical"></i>
        </div>
    </header>

    <!-- CHAT -->
    <main id="chat-container">
        <!-- Messages will appear here -->
    </main>

    <!-- FOOTER -->
    <footer id="input-footer">
        <input type="text" id="user-input" class="modern-input" placeholder="Escreva uma mensagem..." autocomplete="off">
        <button id="send-btn" class="send-btn-modern">
            <i class="ph-fill ph-paper-plane-right"></i>
        </button>
    </footer>

    <script>
        // === L√ìGICA DE NEG√ìCIO (MANTIDA 100% IGUAL) ===
        
        window.dataLayer = window.dataLayer || [];
        function trackEvent(eventName, params = {}) {
            window.dataLayer.push({ 'event': eventName, ...params });
        }

        const CONFIG = {
            ownerName: "Osvaldo",
            whatsAppGroupLink: "https://chat.whatsapp.com/IOI3gSBLRVk4jGK2QMunp1",
            whatsAppNumber: "5565998150975",
            whatsAppSaveNumber: "5565998150965",
            instagramLink: "https://instagram.com/cestas.dona.antonia.cuiaba.vg"
        };

        const CESTAS = [
            {
                id: 'economica', nome: 'Cesta Econ√¥mica', destaque: 'Mais Vendida', desconto: 5, arrozQtd: 1, 
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-economica.avif',
                items: ['1 Arroz Koblenz 5kg', '1 A√ß√∫car Doce Dia 2kg', '1 √ìleo 900ml', '1 Feij√£o 1kg', '1 Caf√© 250g', '1 Espaguete 500g', '1 Trigo 1kg', '1 Farinha Mandioca 1Kg', '1 Sal 1kg', '1 Molho 340g', '1 Milho', '1 Bolacha', '1 Miojo', '1 Suco'],
                opcoes: [{ arroz: 'Valor √önico', preco: '85,00' }]
            },
            {
                id: 'mini', nome: 'Cesta Mini', desconto: 10, arrozQtd: 1,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-mini.avif',
                items: ['1 Arroz 5kg', '1 A√ß√∫car 2kg', '2 √ìleo', '2 Feij√£o', '1 Caf√©', '1 Macarr√£o', '1 Sal', '1 Molho', '1 Milho', '1 Bolacha', '1 Miojo', '2 Suco', 'Itens de Limpeza B√°sicos'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '165,00' }, { arroz: 'Koblenz', preco: '170,00' }]
            },
            {
                id: 'pequena', nome: 'Cesta Pequena', desconto: 15, arrozQtd: 2,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-pequena.avif',
                items: ['2 Arroz 5kg', '1 A√ß√∫car', '2 √ìleo', '2 Feij√£o', '1 Caf√©', '12 Ovos', '1 Bolo', 'Itens Variados...'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '215,00' }, { arroz: 'Koblenz', preco: '220,00' }]
            },
            {
                id: 'media', nome: 'Cesta M√©dia', desconto: 20, arrozQtd: 3,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-media.avif',
                items: ['3 Arroz 5kg', '2 A√ß√∫car', '3 √ìleo', '3 Feij√£o', '1 Caf√© 500g', '12 Ovos', 'Muitos itens...'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '320,00' }, { arroz: 'Koblenz', preco: '325,00' }]
            },
            {
                id: 'grande', nome: 'Cesta Grande', desconto: 25, arrozQtd: 4,
                img: 'https://donaantonia.com.br/img/cesta-basica-cuiaba-varzea-grande-grande.avif',
                items: ['4 Arroz 5kg', '3 A√ß√∫car', '4 √ìleo', '4 Feij√£o', '1 Caf√© 500g', '12 Ovos', 'Completa...'],
                opcoes: [{ arroz: 'Tio Alvino', preco: '380,00' }, { arroz: 'Koblenz', preco: '390,00' }]
            }
        ];

        // --- HELPERS DE IMAGEM ---
        function getProductImage(text) {
            const lowerText = text.toLowerCase();
            let imgName = 'outros.png';
            let folder = 'img/alimento/';

            if(lowerText.includes('creme dental')) { imgName = 'Creme Dental Sorriso 70g.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('desinfetante')) { imgName = 'Desinfetante Remmus 2L.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('detergente')) { imgName = 'Detergente Ype 500ml.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('qboa')) { imgName = 'Qboa 1 Litro.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('amaciante')) { imgName = 'amaciante ype 2L.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('esponja de lavar lou√ßa')) { imgName = 'esponja de lavar lou√ßa.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('l√£ de a√ßo') || lowerText.includes('assolan')) { imgName = 'l√£ de a√ßo assolan.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('papel higi√™nico') || lowerText.includes('papel higienico')) { imgName = 'papel higienico.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('sabonete')) { imgName = 'sabonete palmolive 85g.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('sab√£o barra')) { imgName = 'sab√£o barra ype 900g.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('sab√£o p√≥') || lowerText.includes('sab√£o em p√≥') || lowerText.includes('omo')) { imgName = 'sab√£o em p√≥ omo 800g.webp'; folder = 'img/limpeza/'; }
            else if(lowerText.includes('arroz')) imgName = 'Arroz Koblenz 5kg.webp';
            else if(lowerText.includes('a√ß√∫car') || lowerText.includes('acucar')) imgName = 'a√ßucar doce dia 2 kg.webp';
            else if(lowerText.includes('bolacha')) imgName = 'bolacha mybit.webp';
            else if(lowerText.includes('bolo')) imgName = 'bolo apti chocolate.webp';
            else if(lowerText.includes('caf√©') || lowerText.includes('cafe')) {
                if(lowerText.includes('500g')) imgName = 'cafe caboclo 500g.webp';
                else imgName = 'cafe caboclo 250g.webp';
            }
            else if(lowerText.includes('espaguete')) imgName = 'espaguete qdelicia.webp';
            else if(lowerText.includes('farinha') || lowerText.includes('mandioca')) imgName = 'farinha de mandioca.webp';
            else if(lowerText.includes('feij√£o') || lowerText.includes('feijao')) imgName = 'feij√£o da casa.webp';
            else if(lowerText.includes('milho')) imgName = 'milho verde predileta.webp';
            else if(lowerText.includes('miojo')) imgName = 'miojo apti.webp';
            else if(lowerText.includes('molho')) imgName = 'molho fugini.webp';
            else if(lowerText.includes('oleo') || lowerText.includes('√≥leo')) imgName = 'oleo de soja liza.webp';
            else if(lowerText.includes('ovo')) imgName = 'ovo duzia.jpg';
            else if(lowerText.includes('sal')) imgName = 'sal.webp';
            else if(lowerText.includes('suco')) imgName = 'suco frisco.webp';
            else if(lowerText.includes('tempero')) imgName = 'tempero tio jonas.jpg';
            else if(lowerText.includes('trigo')) imgName = 'trigo vitoriosa.webp';

            return `${folder}${imgName}`;
        }

        // --- SISTEMA DE CHAT ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const statusText = document.getElementById('status-text');
        const inputFooter = document.getElementById('input-footer');

        let state = { step: 0, userName: '', selectedDiscountId: null, timerRef: null };
        let appInitialized = false;

        function scrollToBottom() {
            chatContainer.scrollTo({ top: chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function addMessage(text, type = 'bot', delayOverride = null) {
            return new Promise(resolve => {
                let delay = 1200; 
                if (type === 'bot') {
                    const isCard = text.includes('modern-card') || text.includes('modern-discount') || text.includes('company-modern');
                    if (isCard) { delay = 1500; } 
                    else { delay = Math.min(text.length * 40 + 600, 3500); }
                } else { delay = 0; }

                if (delayOverride !== null) delay = delayOverride;
                
                setTimeout(() => {
                    if (type === 'bot') {
                        statusText.innerText = 'Digitando...';
                        const id = 'typing-' + Date.now();
                        chatContainer.insertAdjacentHTML('beforeend', `
                            <div id="${id}" class="msg-row msg-start">
                                <div class="msg-bubble msg-in">
                                    <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                                </div>
                            </div>
                        `);
                        scrollToBottom();

                        const typingTime = (text.includes('modern-card')) ? 1500 : delay; 
                        
                        setTimeout(() => {
                            const el = document.getElementById(id);
                            if(el) el.remove();
                            
                            const isComplex = text.includes('card-container') || text.includes('modern-discount');
                            const bubbleStyle = isComplex ? 'padding:0; background:transparent; box-shadow:none; max-width:100%;' : '';

                            chatContainer.insertAdjacentHTML('beforeend', `
                                <div class="msg-row msg-start">
                                    <div class="msg-bubble msg-in" style="${bubbleStyle}">
                                        ${text}
                                        ${!isComplex ? `<span class="msg-time">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>` : ''}
                                    </div>
                                </div>
                            `);
                            statusText.innerText = 'Online';
                            scrollToBottom();
                            resolve();
                        }, typingTime);
                    } else {
                        chatContainer.insertAdjacentHTML('beforeend', `
                            <div class="msg-row msg-end">
                                <div class="msg-bubble msg-out">
                                    ${text}
                                </div>
                            </div>
                        `);
                        scrollToBottom();
                        resolve();
                    }
                }, type === 'user' ? 0 : 500);
            });
        }

        function showOptions(opts) {
            setTimeout(() => {
                const id = 'opts-' + Date.now();
                const btns = opts.map(o => `
                    <button class="modern-btn" onclick="handleOpt('${o.val}', ${o.next}, '${id}', '${o.text}')">
                        ${o.text}
                        ${o.sub ? `<span class="btn-sub">${o.sub}</span>` : ''}
                    </button>
                `).join('');
                
                chatContainer.insertAdjacentHTML('beforeend', `
                    <div id="${id}" class="msg-options">${btns}</div>
                `);
                scrollToBottom();
            }, 800);
        }

        window.handleOpt = async function(val, next, id, text) {
            document.getElementById(id).remove();
            await addMessage(text, 'user');
            
            if (val.startsWith('basket_')) {
                const idx = parseInt(val.split('_')[1]);
                state.selectedDiscountId = CESTAS[idx].id;
            }
            
            state.step = next;
            nextStep();
        };

        window.selectBasketChip = function(idx) {
            const container = document.getElementById('unified-card-content');
            if(!container) return;
            container.style.opacity = '0.5';
            setTimeout(() => {
                container.innerHTML = getCardContent(CESTAS[idx]);
                container.style.opacity = '1';
            }, 150);
        };

        window.scrollSlider = function(btn) {
            const wrapper = btn.parentElement;
            const slider = wrapper.querySelector('.modern-slider');
            if(slider) {
                slider.scrollBy({ left: 220, behavior: 'smooth' });
            }
        };

        function getCardContent(cesta) {
            const chips = CESTAS.map((c, i) => `
                <div class="chip-modern ${c.id === cesta.id ? 'active' : ''}" onclick="selectBasketChip(${i})">
                    ${c.nome.replace('Cesta ', '')}
                </div>
            `).join('');

            const slides = cesta.items.map(item => {
                const match = item.match(/^(\d+)\s+(.*)$/);
                let qty = "1 un", nome = item;
                if(match) { qty = match[1] + (parseInt(match[1]) > 1 ? ' un' : ' un'); nome = match[2]; }
                const img = getProductImage(nome);
                
                return `
                <div class="slide-item">
                    <img src="${img}" onerror="this.src='https://placehold.co/60x60/f1f5f9/94a3b8?text=IMG'" loading="lazy">
                    <span class="slide-qty">${qty}</span>
                    <span class="slide-name">${nome}</span>
                </div>`;
            }).join('');

            const precos = cesta.opcoes.map(o => `
                <div class="price-row">
                    <span>${o.arroz.includes('Valor') ? 'Valor √önico' : 'Com ' + o.arroz}</span>
                    <span class="price-val">R$ ${o.preco}</span>
                </div>
            `).join('');

            return `
                <div class="card-header-img">
                    ${cesta.destaque ? `<div class="selo-modern"><i class="ph-fill ph-star"></i> ${cesta.destaque}</div>` : ''}
                    <img src="${cesta.img}" class="card-img-main" alt="${cesta.nome}">
                    <div class="chips-float">${chips}</div>
                </div>
                
                <div class="slider-section">
                    <div class="modern-slider">
                        ${slides}
                        <div style="min-width:10px"></div>
                    </div>
                    <div class="nav-arrow" onclick="scrollSlider(this)"><i class="ph-bold ph-caret-right"></i></div>
                </div>

                <div class="price-section">
                    ${precos}
                </div>
            `;
        }

        // --- FLUXO PRINCIPAL ---
        async function initApp() {
            if (appInitialized) return;
            appInitialized = true;
            trackEvent('PageView');
            
            await addMessage(`${getGreeting()}! Tudo bem? üëã`, 'bot', 800);
            await addMessage(`Aqui √© o <b>${CONFIG.ownerName}</b>, da Cesta B√°sica Dona Ant√¥nia.`, 'bot', 1200);
            await addMessage(`Qual √© o seu nome?`, 'bot', 1000);
        }

        window.addEventListener('load', initApp);
        setTimeout(initApp, 1500);

        async function handleInput() {
            const text = userInput.value.trim();
            if (!text) return;
            
            if (state.step === 0) {
                state.userName = text.split(' ')[0];
                state.step = 1;
                userInput.value = '';
                inputFooter.style.display = 'none';
                await addMessage(text, 'user');
                nextStep();
            }
        }

        async function nextStep() {
            const name = state.userName;
            if(state.timerRef) clearTimeout(state.timerRef);

            switch (state.step) {
                case 1:
                    await addMessage(`Prazer, ${name}! üòÄ`, 'bot', 1000);
                    await addMessage(`Voc√™ j√° conhece a nossa empresa?`, 'bot', 1200);
                    showOptions([
                        { text: "Sim, j√° conhe√ßo üëç", val: "sim", next: 3 },
                        { text: "N√£o conhe√ßo ü§î", val: "nao", next: 2 }
                    ]);
                    break;
                
                case 2: // Card Empresa Moderno
                    const stats = [
                        {icon: 'ph-clock', color: '#10b981', txt: '8 anos em Cuiab√° e VG'},
                        {icon: 'ph-truck', color: '#3b82f6', txt: '+30 mil Entregas'},
                        {icon: 'ph-thumbs-up', color: '#8b5cf6', txt: '6 mil seguidores (Face)'},
                        {icon: 'ph-instagram-logo', color: '#E1306C', txt: '1.9k seguidores (Insta)'}
                    ].map(s => `
                        <div class="stat-modern">
                            <div class="icon-box" style="background:${s.color}"><i class="ph-fill ${s.icon}"></i></div>
                            <span style="font-size:13px; font-weight:500; color:#334155">${s.txt}</span>
                        </div>
                    `).join('');
                    
                    const companyHTML = `
                        <div class="card-container company-modern">
                        <div class="modern-card">
                            <div class="company-hero">
                                <img src="img/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" class="company-logo-lg" onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Osvaldo'">
                                <div>
                                    <h3 class="company-title">Cesta B√°sica Dona Ant√¥nia</h3>
                                    <p class="company-sub">Desde 2016 em Cuiab√° no Coxip√≥</p>
                                </div>
                            </div>
                            <div class="stats-grid">${stats}</div>
                        </div>
                        </div>
                    `;
                    await addMessage(companyHTML, 'bot', 1500);
                    setTimeout(() => { state.step = 4; nextStep(); }, 6000);
                    break;

                case 3: 
                case 4:
                    await addMessage(state.step === 3 ? "Vou te mostrar as op√ß√µes ent√£o." : "Posso mostrar as cestas agora?", 'bot', 1200);
                    showOptions([{ text: "Ver Cestas ‚úÖ", val: "ok", next: 5 }]);
                    break;

                case 5: // Card Cesta Moderno
                    await addMessage(`Navegue pelas op√ß√µes abaixo üëá`, 'bot', 1000);
                    const cardHTML = `
                        <div class="card-container">
                            <div class="modern-card">
                                <div id="unified-card-content">
                                    ${getCardContent(CESTAS[0])}
                                </div>
                            </div>
                        </div>`;
                    
                    await addMessage(cardHTML, 'bot');
                    trackEvent('ViewContent', { content_name: 'Catalogo' });
                    
                    state.timerRef = setTimeout(() => { 
                        if(state.step === 5) {
                            state.step = 6; 
                            nextStep();
                        }
                    }, 12000); 
                    break;

                case 6: 
                    await addMessage(`Gostou de alguma? Posso te mostrar como funciona o pagamento?`, 'bot', 1200);
                    showOptions([{ text: "Pode mostrar üëç", val: "pay", next: 7 }]);
                    break;
                
                case 7:
                    await addMessage(`Aceitamos praticamente tudo:`, 'bot', 1000);
                    const payHTML = `
                        <div style="background:white; padding:20px; border-radius:16px; border:1px solid #E2E8F0; box-shadow:var(--shadow-sm);">
                            <ul style="padding-left:20px; margin:0; font-size:14px; color:#334155; line-height:1.6;">
                                <li>Cart√£o de D√©bito</li>
                                <li>Cart√£o de Cr√©dito em at√© 3x sem juros</li>
                                <li>PIX ou Dinheiro</li>
                                <li>Vale Alimenta√ß√£o e Refei√ß√£o (Alelo, Sodexo, Pluxee, Caju, Flash e Ifood)</li>
                            </ul>
                            <div style="margin-top:10px; padding-top:10px; border-top:1px dashed #E2E8F0; color:#EF4444; font-weight:700; font-size:13px; text-align:center;">
                                ‚ö†Ô∏è AINDA N√ÉO VENDEMOS A PRAZO
                            </div>
                        </div>
                    `;
                    await addMessage(payHTML, 'bot');
                    setTimeout(() => { state.step = 8; nextStep(); }, 3500);
                    break;

                case 8:
                    await addMessage(`‚≠ê ${name}, quero muito que voc√™ se torne nosso cliente.`, 'bot', 1200);
                    await addMessage(`üöÄ Posso te oferecer um desconto pra sua primeira compra?`, 'bot', 1200);
                    showOptions([{ text: "Quero Desconto üéÅ", val: "sim", next: 9 }]);
                    break;

                case 9:
                    await addMessage(`Legal! Pra qual cesta voc√™ quer o Desconto?`, 'bot', 1000);
                    const opts = CESTAS.map((c, i) => ({
                        text: c.nome.replace('Cesta ', ''),
                        sub: `(${c.arrozQtd} Arroz)`,
                        val: `basket_${i}`,
                        next: 10
                    }));
                    showOptions(opts);
                    break;

                case 10: // Desconto Moderno
                    const selected = CESTAS.find(c => c.id === state.selectedDiscountId);
                    await addMessage(`Boa escolha! Para a <b>${selected.nome}</b>, liberei isso:`, 'bot', 1200);
                    
                    const discountHTML = `
                        <div class="card-container">
                            <div class="modern-discount">
                                <div class="discount-highlight">
                                    <span class="discount-label">DESCONTO EXCLUSIVO</span>
                                    <span class="discount-big">- R$ ${selected.desconto},00</span>
                                    <span style="font-size:11px; color:#059669; opacity:0.8">V√°lido por 30 dias</span>
                                </div>
                                <button class="btn-claim" onclick="openWa('${selected.nome}', ${selected.desconto})">
                                    GARANTIR AGORA <i class="ph-bold ph-whatsapp-logo"></i>
                                </button>
                                <p style="font-size:11px; color:#94A3B8; margin-top:12px">Sem compromisso de compra hoje.</p>
                            </div>
                        </div>
                    `;
                    await addMessage(discountHTML, 'bot');
                    await addMessage("Clique acima para garantir. üëÜ", 'bot', 1200);
                    
                    const textSave = encodeURIComponent("Estou salvando seu contato");
                    await addMessage(`N√£o esque√ßa de salvar nosso contato: <a href="https://wa.me/${CONFIG.whatsAppSaveNumber}?text=${textSave}" target="_blank" class="text-link" style="color:var(--primary)">65 99815-0965</a>`, 'bot', 1500);
                    break;
            }
        }

        const getGreeting = () => {
            const h = new Date().getHours();
            return h < 12 ? "Bom dia" : h < 18 ? "Boa tarde" : "Boa noite";
        };

        window.openWa = function(cesta, desconto) {
            const msg = `Ol√°! Sou ${state.userName}. Tenho interesse na *${cesta}* e quero garantir meu desconto de *R$ ${desconto},00*.`;
            window.open(`https://wa.me/${CONFIG.whatsAppNumber}?text=${encodeURIComponent(msg)}`, '_blank');
            trackEvent('Lead');
            
            setTimeout(() => {
                const socialHTML = `
                    <div class="social-links" style="background:transparent;">
                        <a href="${CONFIG.instagramLink}" target="_blank" class="social-pill pill-insta"><i class="ph-bold ph-instagram-logo"></i> Instagram</a>
                        <a href="${CONFIG.whatsAppGroupLink}" target="_blank" class="social-pill pill-vip"><i class="ph-bold ph-star"></i> Grupo VIP</a>
                    </div>
                `;
                addMessage(socialHTML, 'bot', 1000);
            }, 2500);
        }

        sendBtn.onclick = handleInput;
        userInput.onkeypress = (e) => { if(e.key === 'Enter') handleInput(); }

    </script>
</body>
</html>
