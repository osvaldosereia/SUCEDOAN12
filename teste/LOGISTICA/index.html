<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logística - Sistema Logística v8.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        .nav-item.active { background-color: #334155; border-right: 4px solid #34d399; }
    </style>
    <script type="importmap">
    { "imports": { "react": "https://esm.sh/react@18.2.0", "react-dom/client": "https://esm.sh/react-dom@18.2.0/client", "lucide-react": "https://esm.sh/lucide-react@0.263.1", "zod": "https://esm.sh/zod@3.22.4" } }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-full">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { LayoutDashboard, ShoppingCart, Package, Truck, Database, LineChart, HeartHandshake, Menu, X, Upload, ArrowUp, ArrowDown, Gift, CheckCircle } from 'lucide-react';

        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => { window.localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
          return [value, setValue];
        };
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        const NavItem = ({ icon, label, href, active }) => (
            <a href={href} className={`w-full flex items-center justify-start gap-3 p-3 lg:px-6 transition-all duration-200 nav-item ${active ? 'active text-white bg-slate-800' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`} title={label}>{icon}<span className="font-medium text-sm">{label}</span></a>
        );

        function LogisticsView({ sales, setSales, clients, companyPhone, products, setProducts }) {
            const [selectedRoute, setSelectedRoute] = useState('Todas');
            const [routeSales, setRouteSales] = useState([]); 
            const [showImport, setShowImport] = useState(false);
            const [importText, setImportText] = useState('');

            useEffect(() => { 
                const ready = sales.filter(s => s.status === 'Rota'); 
                const filtered = selectedRoute === 'Todas' ? ready : ready.filter(s => { 
                    if (s.regionOverride) return s.regionOverride === selectedRoute;
                    const c = clients.find(cl => cl.id === s.clientId); 
                    const region = c?.region || c?.route; 
                    return region === selectedRoute; 
                }); 
                setRouteSales(filtered); 
            }, [sales, selectedRoute, clients]);
            
            const routes = [...new Set(clients.map(c => c.region || c.route).filter(Boolean))];
            const moveOrder = (index, direction) => { const newOrder = [...routeSales]; if (direction === 'up' && index > 0) { [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]]; } else if (direction === 'down' && index < newOrder.length - 1) { [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]; } setRouteSales(newOrder); };
            
            // --- UPDATED LINK GENERATOR ---
            const generateDriverLink = () => { 
                if (routeSales.length === 0) return alert("Nada para entregar!"); 
                const payload = { 
                    route: selectedRoute, companyPhone, generatedAt: new Date(), 
                    orders: routeSales.map(s => { 
                        const c = clients.find(cl => cl.id === s.clientId); 
                        let finalPay = s.payMethod;
                        if (s.isPaid) finalPay += " (JÁ PAGO)";
                        return { 
                            id: s.id, customer: c.name, phone: c.phone, phone2: c.phone2, 
                            address: c.address, district: c.district, region: s.regionOverride || c.region, map: c.mapLink, 
                            total: s.total, pay: finalPay, change: s.changeFor ? s.changeFor - s.total : 0, 
                            obs: s.obs, clientObs: c.obs, isPaid: s.isPaid, gift: s.gift
                        }; 
                    }) 
                }; 
                const encoded = encodeURIComponent(btoa(JSON.stringify(payload))); 
                // !!! CRITICAL CHANGE: POINTS TO driver.html !!!
                const link = `${window.location.origin}/driver.html#driver=${encoded}`; 
                
                const copyToClipboardFallback = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); alert("LINK COPIADO!"); } catch (err) { prompt("Copie:", text); } document.body.removeChild(textArea); }; 
                if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(link).then(() => alert("LINK COPIADO!")).catch(() => copyToClipboardFallback(link)); } else { copyToClipboardFallback(link); } 
            };
            
            const forceDelivery = (id) => { if (confirm("Marcar entregue?")) setSales(sales.map(s => s.id === id ? { ...s, status: 'Entregue' } : s)); };
            const totalValue = routeSales.reduce((acc, s) => acc + s.total, 0);

            const processReturnReport = () => {
                const lines = importText.split('\n');
                let updatedCount = 0; let newSales = [...sales]; let newProducts = [...products];
                lines.forEach(line => {
                    const idMatch = line.match(/ID:\s*#?(\S+)/);
                    const statusMatch = line.match(/STATUS:\s*(\w+)/);
                    const payMatch = line.match(/PGTO:\s*([A-Za-zÀ-ú\s]+)/);
                    if (idMatch && statusMatch) {
                        const id = idMatch[1];
                        const status = statusMatch[1].toUpperCase() === 'ENTREGUE' ? 'Entregue' : statusMatch[1].toUpperCase() === 'CANCELADO' ? 'Cancelado' : null;
                        const payMethod = payMatch ? payMatch[1].trim() : null;
                        if (status) {
                            const saleIndex = newSales.findIndex(s => s.id === id);
                            if (saleIndex > -1) {
                                const sale = newSales[saleIndex];
                                if (status === 'Cancelado' && sale.status !== 'Cancelado') {
                                     sale.items.forEach(item => {
                                        const dbProd = newProducts.find(p => p.id === item.id);
                                        if (dbProd) {
                                            if (dbProd.isCombo) { item.comboItems?.forEach(ing => { const dbIng = newProducts.find(p => p.id === ing.id); if (dbIng) { dbIng.stock += ing.qty; dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_DRIVER', qty: ing.qty }); } }); } else { dbProd.stock += 1; dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_DRIVER', qty: 1 }); }
                                        }
                                     });
                                }
                                newSales[saleIndex] = { ...sale, status, payMethod: payMethod || sale.payMethod }; updatedCount++;
                            }
                        }
                    }
                });
                if (updatedCount > 0) { setSales(newSales); setProducts(newProducts); setImportText(''); setShowImport(false); alert(`${updatedCount} pedidos atualizados com sucesso!`); } else { alert("Nenhum pedido processado. Verifique o formato."); }
            };

            return (
                <div className="p-4 lg:p-6 pb-20 max-w-5xl mx-auto">
                    <div className="bg-white p-4 rounded-xl shadow-sm border mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div className="flex gap-4 items-center w-full md:w-auto"><span className="font-bold text-gray-500 uppercase text-xs shrink-0">Região:</span><select className="border rounded-lg p-2 bg-gray-50 outline-none w-full md:w-auto" value={selectedRoute} onChange={e => setSelectedRoute(e.target.value)}><option value="Todas">Todas</option>{routes.map(r => <option key={r} value={r}>{r}</option>)}</select></div>
                        <div className="flex items-center gap-4 w-full md:w-auto justify-between"><div className="text-right"><div className="text-xs text-gray-400 font-bold uppercase">Total da Rota</div><div className="text-2xl font-bold text-green-700">{formatCurrency(totalValue)}</div></div><button onClick={() => setShowImport(true)} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 flex items-center gap-2"><Upload size={16}/> PROCESSAR RETORNO</button></div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col">
                        <div className="p-3 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center"><span className="font-bold text-indigo-900 text-sm flex items-center gap-2"><Truck size={16}/> {routeSales.length} Entregas Pendentes</span><button onClick={generateDriverLink} className="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-700 transition">GERAR LINK MOTORISTA</button></div>
                        <div className="overflow-y-auto p-2 space-y-2 bg-gray-50 max-h-[600px]">{routeSales.map((s, idx) => { const client = clients.find(c => c.id === s.clientId) || {}; return (<div key={s.id} className="bg-white p-3 rounded-lg border shadow-sm flex gap-4 items-center"><div className="flex flex-col gap-1"><button onClick={() => moveOrder(idx, 'up')} className="p-1 hover:bg-gray-100 rounded"><ArrowUp size={14} className="text-gray-400"/></button><span className="font-bold text-sm text-center text-indigo-600 w-6">{idx + 1}</span><button onClick={() => moveOrder(idx, 'down')} className="p-1 hover:bg-gray-100 rounded"><ArrowDown size={14} className="text-gray-400"/></button></div><div className="flex-1"><div className="flex justify-between"><h4 className="font-bold text-gray-800">{client.name}</h4><span className="font-mono text-xs bg-gray-100 px-2 rounded text-gray-500">#{s.id}</span></div><p className="text-sm text-gray-500">{client.address}, {client.district}</p><div className="flex flex-wrap gap-2 mt-2 text-xs"><span className="bg-blue-50 text-blue-700 px-2 py-0.5 rounded font-medium">{s.payMethod}{s.isPaid ? ' (PAGO)' : ''}</span><span className="bg-green-50 text-green-700 px-2 py-0.5 rounded font-bold">{formatCurrency(s.total)}</span>{s.gift && s.gift !== 'Nenhum' && <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold flex items-center gap-1"><Gift size={10}/> {s.gift}</span>}</div></div><button onClick={() => forceDelivery(s.id)} className="p-3 hover:bg-green-50 text-gray-300 hover:text-green-600 rounded-full transition"><CheckCircle size={24}/></button></div>); })}</div>
                    </div>
                    {showImport && (<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-lg rounded-xl p-6 shadow-2xl"><h3 className="text-lg font-bold mb-4">Processar Retorno</h3><textarea className="w-full h-48 border rounded p-2 text-xs font-mono mb-4 bg-gray-50" placeholder="Cole o relatório aqui..." value={importText} onChange={e => setImportText(e.target.value)} /><div className="flex gap-2"><button onClick={() => setShowImport(false)} className="flex-1 bg-gray-200 py-2 rounded font-bold text-gray-600">Cancelar</button><button onClick={processReturnReport} className="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded font-bold text-white">PROCESSAR BAIXA</button></div></div></div>)}
                </div>
            );
        }

        function App() {
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [companyPhone] = useStickyState('db_config_phone', '65998150975');
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

          return (
            <div className="flex flex-col lg:flex-row h-screen bg-gray-100 font-sans text-gray-800 overflow-hidden">
                <div className="lg:hidden bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 z-50 shadow-md">
                    <div className="flex items-center gap-2"><div className="bg-yellow-500 text-slate-900 p-1 rounded font-bold text-xs">LOG</div><h1 className="font-bold tracking-wider">SISTEMA v8.0</h1></div>
                    <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 bg-slate-800 rounded">{mobileMenuOpen ? <X size={20}/> : <Menu size={20}/>}</button>
                </div>
                <aside className={`fixed inset-y-0 left-0 bg-slate-900 text-white flex flex-col transition-transform duration-300 z-40 w-64 lg:static lg:translate-x-0 ${mobileMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'}`}>
                    <div className="h-16 hidden lg:flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800"><div className="bg-yellow-500 text-slate-900 p-1.5 rounded font-bold mr-2">LOG</div><h1 className="font-bold tracking-wider hidden lg:block text-lg">SISTEMA <span className="text-emerald-400 text-xs font-normal border border-emerald-500 rounded px-1 ml-1">V8.0</span></h1></div>
                    <nav className="flex-1 py-4 space-y-1 overflow-y-auto mt-16 lg:mt-0">
                        <NavItem icon={<LayoutDashboard size={20}/>} label="Visão Geral" href="index.html" />
                        <NavItem icon={<ShoppingCart size={20}/>} label="Caixa (PDV)" href="pos.html" />
                        <NavItem icon={<Package size={20}/>} label="Expedição" href="expedition.html" />
                        <NavItem icon={<Truck size={20}/>} label="Logística" href="logistics.html" active={true} />
                        <NavItem icon={<Database size={20}/>} label="Cadastros" href="registry.html" />
                        <NavItem icon={<LineChart size={20}/>} label="Inteligência (BI)" href="intelligence.html" />
                        <NavItem icon={<HeartHandshake size={20}/>} label="Pós-Venda" href="postsale.html" />
                    </nav>
                </aside>
                <main className="flex-1 flex flex-col min-w-0 bg-gray-50 h-full overflow-hidden relative">
                    <header className="h-16 bg-white border-b hidden lg:flex items-center justify-between px-6 shrink-0 shadow-sm z-20"><div><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">Logística</h2></div><div className="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 font-bold">OP</div></header>
                    <div className="flex-1 overflow-y-auto overflow-x-hidden relative bg-gray-50">
                        <LogisticsView sales={sales} setSales={setSales} clients={clients} companyPhone={companyPhone} products={products} setProducts={setProducts} />
                    </div>
                </main>
                {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 lg:hidden" onClick={() => setMobileMenuOpen(false)}></div>}
            </div>
          );
        }
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
