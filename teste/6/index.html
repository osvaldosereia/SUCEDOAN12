<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo P√≥s-Venda (Micro-frontend)</title>
    
    <!-- 1. TAILWIND CSS (PROTOCOL) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 
                            850: '#151e2e', 
                            900: '#0f172a' 
                        },
                        primary: { 
                            600: '#0284c7', 
                            700: '#0369a1' 
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'sharp': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'input': '0 1px 2px 0 rgba(0, 0, 0, 0.05)'
                    }
                }
            }
        }
    </script>
    
    <!-- 2. GOOGLE FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- 3. ESTILOS GLOBAIS (PROTOCOL) -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        
        /* Scrollbar */
        .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #e2e8f0; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; border: 2px solid #e2e8f0; }
        
        /* Inputs High Contrast */
        .input-field {
            width: 100%; padding: 0.6rem 0.75rem; 
            background-color: #ffffff; 
            border: 1px solid #cbd5e1; /* Slate-300 */
            border-radius: 0.375rem; font-size: 0.9rem; font-weight: 500; color: #0f172a;
            outline: none; transition: all 0.15s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .input-field:focus { 
            border-color: #0284c7; 
            box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.15); 
        }
        
        /* Bot√µes Protocolo */
        .btn-primary {
            background-color: #0f172a; color: white;
            padding: 0.65rem 1.25rem; border-radius: 0.375rem;
            font-size: 0.875rem; font-weight: 600; letter-spacing: 0.025em;
            transition: background-color 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            text-transform: uppercase;
        }
        .btn-primary:hover { background-color: #1e293b; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }

        .btn-secondary {
            background-color: #ffffff; border: 1px solid #cbd5e1; color: #334155;
            padding: 0.65rem 1.25rem; border-radius: 0.375rem;
            font-size: 0.875rem; font-weight: 600;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            text-transform: uppercase;
        }
        .btn-secondary:hover { background-color: #f8fafc; border-color: #94a3b8; color: #0f172a; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.2s ease-out; }
    </style>

    <!-- 4. IMPORTMAP -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
    
    <!-- 5. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 h-screen overflow-hidden text-slate-900">
    
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          HeartHandshake, MessageCircle, Ban, Search, CheckCircle, 
          Clock, Calendar, Wallet, ChevronDown, Menu, X, Star,
          ThumbsUp, RefreshCcw, UserCheck, Package
        } from 'lucide-react';

        // --- UTILS ---
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);

        // --- APP CONTAINER ---
        function App() {
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [clients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [postSaleLog, setPostSaleLog] = useStickyState('db_postsale_log', {}); 
          
          return (
            <div className="h-screen bg-slate-100 font-sans text-slate-900 overflow-hidden relative flex flex-col">
                <PostSalesHeader sales={sales} />
                <PostSalesView 
                    sales={sales} setSales={setSales} 
                    clients={clients} 
                    products={products} setProducts={setProducts}
                    postSaleLog={postSaleLog} setPostSaleLog={setPostSaleLog}
                />
            </div>
          );
        }

        // --- HEADER COMPONENT ---
        function PostSalesHeader({ sales }) {
            const completedCount = sales.filter(s => s.status === 'Entregue').length;

            return (
                <header className="h-16 bg-white border-b border-slate-300 px-6 flex items-center justify-between shrink-0 shadow-sm z-20">
                    <div className="flex items-center gap-3">
                        <div className="h-8 w-1 bg-slate-900 rounded-full"></div>
                        <div>
                            <h2 className="text-xl font-bold text-slate-900 leading-tight uppercase tracking-tight">CRM / P√≥s-Venda</h2>
                            <p className="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Satisfa√ß√£o e Fideliza√ß√£o</p>
                        </div>
                    </div>
                    <div className="flex gap-4">
                        <div className="text-right">
                            <span className="block text-[10px] font-bold text-slate-400 uppercase">Vendas Conclu√≠das</span>
                            <span className="block text-lg font-bold text-slate-800 leading-none">{completedCount}</span>
                        </div>
                    </div>
                </header>
            );
        }

        // --- MAIN VIEW ---
        function PostSalesView({ sales, setSales, clients, products, setProducts, postSaleLog, setPostSaleLog }) {
            const [displayLimit, setDisplayLimit] = useState(15);
            const [searchTerm, setSearchTerm] = useState('');
            const [filterStatus, setFilterStatus] = useState('Entregue'); // Entregue, Conclu√≠do, Todos

            // Filtering Logic
            const validSales = useMemo(() => {
                return sales
                    .filter(s => {
                        const statusMatch = filterStatus === 'Todos' 
                            ? (s.status === 'Entregue' || s.status === 'Conclu√≠do' || s.status === 'Pendente') 
                            : s.status === filterStatus;
                        
                        if (!statusMatch) return false;

                        const client = clients.find(c => c.id === s.clientId);
                        const searchLower = searchTerm.toLowerCase();
                        
                        return (
                            (client && client.name.toLowerCase().includes(searchLower)) ||
                            s.id.toLowerCase().includes(searchLower) ||
                            (s.payMethod && s.payMethod.toLowerCase().includes(searchLower))
                        );
                    })
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
            }, [sales, searchTerm, filterStatus, clients]);

            const visibleSales = validSales.slice(0, displayLimit);

            const loadMore = () => setDisplayLimit(prev => prev + 15);

            // Actions
            const sendThankYou = (sale, client) => {
                if (!client) return alert("Cliente n√£o encontrado");
                const cleanPhone = client.phone ? client.phone.replace(/\D/g, '') : '';
                if (!cleanPhone) return alert("Cliente sem telefone.");

                const msg = `Ol√° ${client.name.split(' ')[0]}! üëã\n\nPassando para agradecer pela compra de hoje! ‚ù§\nEsperamos que tenha gostado! Qualquer d√∫vida estamos √† disposi√ß√£o.`;

                setPostSaleLog(prev => ({ ...prev, [`${sale.id}_thankyou`]: { date: new Date().toISOString(), type: 'thank_you', user: 'system' } }));
                window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            };
            
            const sendSurvey = (sale, client) => {
                if (!client) return alert("Cliente n√£o encontrado");
                const cleanPhone = client.phone ? client.phone.replace(/\D/g, '') : '';
                if (!cleanPhone) return alert("Cliente sem telefone.");

                const msg = `Oi ${client.name.split(' ')[0]}, tudo bem? ‚≠ê\n\nDe 0 a 10, qual nota voc√™ daria para o nosso atendimento hoje?\nSua opini√£o √© muito importante! üôå`;

                setPostSaleLog(prev => ({ ...prev, [`${sale.id}_survey`]: { date: new Date().toISOString(), type: 'survey', user: 'system' } }));
                window.open(`https://wa.me/55${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            const cancelSale = (sale) => {
                if (!confirm(`‚ö† ESTORNO DE ESTOQUE:\n\nCancelar Venda #${sale.id}?\n\nOs produtos voltar√£o automaticamente para o estoque.`)) return;

                const newProducts = [...products];
                let logStock = [];

                sale.items.forEach(item => {
                    const dbProd = newProducts.find(p => p.id === item.id);
                    if (dbProd) {
                        if (dbProd.isCombo) {
                            item.comboItems?.forEach(ing => {
                                const dbIng = newProducts.find(p => p.id === ing.id);
                                if (dbIng) {
                                    const qtyToReturn = ing.qty * (item.qty || 1);
                                    dbIng.stock += qtyToReturn;
                                    logStock.push(`${dbIng.name} (+${qtyToReturn})`);
                                }
                            });
                        } else {
                            const qtyToReturn = (item.qty || 1);
                            dbProd.stock += qtyToReturn;
                            logStock.push(`${dbProd.name} (+${qtyToReturn})`);
                        }
                    }
                });
                
                setProducts(newProducts);
                const updatedSales = sales.map(s => s.id === sale.id ? { ...s, status: 'Cancelado' } : s);
                setSales(updatedSales);
                
                alert(`Venda cancelada.\n\nItens devolvidos:\n${logStock.join('\n')}`);
            };

            return (
                <div className="flex-1 overflow-y-auto p-6 bg-slate-100">
                    <div className="max-w-7xl mx-auto">
                        
                        {/* TOOLBAR */}
                        <div className="bg-white p-4 rounded-lg shadow-sm border border-slate-300 mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="relative w-full md:w-96">
                                <Search className="absolute left-3 top-2.5 text-slate-400" size={16}/>
                                <input 
                                    className="input-field pl-10" 
                                    placeholder="Buscar cliente, ID ou pagamento..." 
                                    value={searchTerm} 
                                    onChange={e => setSearchTerm(e.target.value)} 
                                />
                            </div>
                            <div className="flex gap-2">
                                {['Entregue', 'Conclu√≠do', 'Todos'].map(status => (
                                    <button 
                                        key={status}
                                        onClick={() => setFilterStatus(status)} 
                                        className={`px-4 py-2 rounded-md text-xs font-bold transition border ${filterStatus === status ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}`}
                                    >
                                        {status === 'Todos' ? 'TODOS' : status.toUpperCase()}
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* TABLE CONTAINER */}
                        <div className="bg-white rounded-lg shadow-sm border border-slate-300 overflow-hidden">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-slate-50 text-slate-500 uppercase text-[10px] font-bold border-b border-slate-200">
                                    <tr>
                                        <th className="p-4 w-32">Data / ID</th>
                                        <th className="p-4">Cliente</th>
                                        <th className="p-4">Resumo da Venda</th>
                                        <th className="p-4 w-40 text-center">Status CRM</th>
                                        <th className="p-4 w-48 text-center">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm divide-y divide-slate-100">
                                    {visibleSales.map(sale => {
                                        const client = clients.find(c => c.id === sale.clientId);
                                        const saleDate = new Date(sale.date);
                                        const hasThanked = postSaleLog[`${sale.id}_thankyou`];
                                        const hasSurvey = postSaleLog[`${sale.id}_survey`];
                                        
                                        return (
                                            <tr key={sale.id} className="hover:bg-slate-50 transition group">
                                                <td className="p-4">
                                                    <div className="font-mono font-bold text-slate-700 bg-slate-100 px-1.5 rounded w-fit text-xs border border-slate-200">#{sale.id}</div>
                                                    <div className="text-[10px] text-slate-400 mt-1 flex items-center gap-1 uppercase font-medium">
                                                        <Calendar size={10}/> {saleDate.toLocaleDateString('pt-BR')}
                                                    </div>
                                                </td>
                                                <td className="p-4">
                                                    {client ? (
                                                        <div>
                                                            <div className="font-bold text-slate-800 text-sm flex items-center gap-2">
                                                                {client.name}
                                                                <button onClick={() => window.open(`https://wa.me/55${client.phone?.replace(/\D/g, '')}`, '_blank')} className="text-green-600 hover:text-green-700 hover:bg-green-50 rounded p-1 transition"><MessageCircle size={14}/></button>
                                                            </div>
                                                            <div className="text-[10px] text-slate-500 uppercase">{client.district || 'Bairro N/D'}</div>
                                                        </div>
                                                    ) : <span className="text-slate-400 italic text-xs">Cliente Exclu√≠do</span>}
                                                </td>
                                                <td className="p-4">
                                                    <div className="text-xs text-slate-600 mb-1" title={sale.items.map(i => i.name).join(', ')}>
                                                        <span className="font-bold">{sale.items.length} itens:</span> {sale.items[0]?.name} {sale.items.length > 1 ? `+${sale.items.length - 1}` : ''}
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-slate-800">{formatCurrency(sale.total)}</span>
                                                        <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 uppercase font-bold">{sale.payMethod}</span>
                                                    </div>
                                                </td>
                                                <td className="p-4 text-center align-middle">
                                                    <div className="flex flex-col gap-1 items-center">
                                                        {hasThanked ? (
                                                            <span className="flex items-center gap-1 text-[9px] font-black text-green-700 bg-green-50 px-2 py-0.5 rounded border border-green-200 uppercase tracking-wide">
                                                                <CheckCircle size={10}/> Agradecido
                                                            </span>
                                                        ) : (
                                                            <span className="flex items-center gap-1 text-[9px] font-bold text-slate-400 bg-slate-50 px-2 py-0.5 rounded border border-slate-200 uppercase tracking-wide">
                                                                <Clock size={10}/> Pendente
                                                            </span>
                                                        )}
                                                        {hasSurvey && (
                                                            <span className="flex items-center gap-1 text-[9px] font-black text-primary-700 bg-blue-50 px-2 py-0.5 rounded border border-blue-200 uppercase tracking-wide">
                                                                <Star size={10}/> Pesquisa
                                                            </span>
                                                        )}
                                                    </div>
                                                </td>
                                                <td className="p-4 text-center">
                                                    <div className="flex justify-center gap-1">
                                                        <button 
                                                            onClick={() => sendThankYou(sale, client)}
                                                            className={`p-2 rounded border transition shadow-sm ${hasThanked ? 'bg-white text-slate-300 border-slate-200 cursor-not-allowed' : 'bg-white text-slate-600 border-slate-300 hover:bg-green-50 hover:text-green-700 hover:border-green-300'}`}
                                                            title="Agradecer"
                                                        >
                                                            <ThumbsUp size={16} />
                                                        </button>
                                                        <button 
                                                            onClick={() => sendSurvey(sale, client)}
                                                            className="p-2 bg-white text-slate-600 border border-slate-300 rounded hover:bg-blue-50 hover:text-primary-700 hover:border-blue-300 transition shadow-sm"
                                                            title="Pesquisa Satisfa√ß√£o"
                                                        >
                                                            <Star size={16} />
                                                        </button>
                                                        <button 
                                                            onClick={() => cancelSale(sale)}
                                                            className="p-2 bg-white text-slate-400 border border-slate-300 rounded hover:bg-red-50 hover:text-red-600 hover:border-red-300 transition shadow-sm"
                                                            title="Estornar Venda"
                                                        >
                                                            <Ban size={16} />
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {visibleSales.length === 0 && (
                                        <tr>
                                            <td colSpan="5" className="p-12 text-center text-slate-400 flex flex-col items-center justify-center">
                                                <UserCheck size={32} className="mb-2 opacity-30"/>
                                                <p className="text-sm font-medium">Nenhuma venda encontrada.</p>
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                        
                        {visibleSales.length < validSales.length && (
                            <div className="p-6 flex justify-center">
                                <button onClick={loadMore} className="btn-secondary text-xs px-6 py-2 rounded-full shadow-sm">
                                    <ChevronDown size={14} className="mr-2"/> CARREGAR MAIS
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
