<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS Local-First | Gestão de Kits & Avulsos</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#151e2e', 900: '#0f172a' },
                        primary: { 600: '#0284c7', 700: '#0369a1' },
                        alert: { 500: '#ef4444', 600: '#dc2626' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <!-- 2. FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- 3. GLOBAL STYLES -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow: hidden; margin: 0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Table Sticky Header */
        th.sticky-header { position: sticky; top: 0; background: #f8fafc; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* Inputs */
        .input-dense {
            width: 100%; padding: 0.5rem; font-size: 0.875rem;
            border: 1px solid #cbd5e1; border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .input-dense:focus { border-color: #0284c7; outline: none; box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.1); }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <!-- 4. REACT & LIBS -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    
    <div id="root" class="h-screen w-screen flex flex-col items-center justify-center bg-slate-100">
        <div id="loader" class="text-slate-500 font-medium animate-pulse">Iniciando WMS Local-First...</div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICON WRAPPER FOR LUCIDE ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = React.useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- UTILS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatBRL = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            try {
                const sticky = window.localStorage.getItem(key);
                return sticky ? JSON.parse(sticky) : defaultValue;
            } catch (e) {
                console.warn("LocalStorage bloqueado:", e);
                return defaultValue;
            }
          });
          useEffect(() => { 
            try {
                window.localStorage.setItem(key, JSON.stringify(value)); 
            } catch (e) {}
          }, [key, value]);
          return [value, setValue];
        };

        const CATEGORIES = ["ALIMENTO", "LIMPEZA", "HIGIENTE", "KIT ALIMENTO", "KIT ARROZ", "KIT LIMPEZA E HIGIENE", "OUTROS"];

        // --- APP COMPONENT ---
        function App() {
            const [products, setProducts] = useStickyState('db_products_v4', []);
            const [editingId, setEditingId] = useState(null);
            
            // --- FILTROS & BUSCA ---
            const [search, setSearch] = useState('');
            const [catFilter, setCatFilter] = useState('');
            const [showCriticalOnly, setShowCriticalOnly] = useState(false);

            // --- FORM STATE ---
            const [form, setForm] = useState({
                id: '', name: '', internalCode: '', category: 'OUTROS',
                cost: '', price: '', stock: 0, minStock: 5,
                isCombo: false, comboItems: [] // { id, qty }
            });

            // --- KIT ASSEMBLY STATE ---
            const [assemblyQty, setAssemblyQty] = useState(1);

            // --- DERIVED DATA ---
            const filteredProducts = useMemo(() => {
                return products.filter(p => {
                    const matchSearch = p.name.toLowerCase().includes(search.toLowerCase()) || 
                                      (p.internalCode && p.internalCode.includes(search));
                    const matchCat = catFilter ? p.category === catFilter : true;
                    const isCritical = p.stock <= (p.minStock || 0);
                    const matchCritical = showCriticalOnly ? isCritical : true;

                    return matchSearch && matchCat && matchCritical;
                }).sort((a,b) => {
                    if (showCriticalOnly) return a.stock - b.stock;
                    return a.name.localeCompare(b.name);
                });
            }, [products, search, catFilter, showCriticalOnly]);

            const criticalCount = products.filter(p => p.stock <= (p.minStock || 0)).length;

            // --- ACTIONS ---
            const handleNew = () => {
                const nextCode = String(products.length + 1).padStart(4, '0');
                setForm({ 
                    id: '', name: '', internalCode: nextCode, category: 'OUTROS',
                    cost: '', price: '', stock: 0, minStock: 5,
                    isCombo: false, comboItems: []
                });
                setEditingId(null);
                setAssemblyQty(1);
            };

            const handleEdit = (p) => {
                setForm({ ...p, comboItems: p.comboItems || [], minStock: p.minStock || 5 });
                setEditingId(p.id);
                setAssemblyQty(1);
            };

            const handleSave = () => {
                if (!form.name) return alert("Nome obrigatório");
                
                const payload = {
                    ...form,
                    id: editingId || generateId(),
                    cost: Number(form.cost),
                    price: Number(form.price),
                    stock: Number(form.stock),
                    minStock: Number(form.minStock),
                    updatedAt: new Date().toISOString()
                };

                if (editingId) {
                    setProducts(products.map(p => p.id === editingId ? payload : p));
                    alert("Produto atualizado.");
                } else {
                    setProducts([...products, payload]);
                    handleNew();
                }
            };

            const handleDelete = () => {
                if(!confirm("Tem certeza que deseja excluir?")) return;
                setProducts(products.filter(p => p.id !== editingId));
                handleNew();
            };

            const executeAssembly = (direction) => {
                if (!form.isCombo || !form.comboItems || form.comboItems.length === 0) return alert("Kit sem composição definida.");
                
                const qty = Number(assemblyQty);
                if (qty <= 0) return;

                const newProducts = [...products];
                const currentKit = newProducts.find(p => p.id === editingId);
                
                if (!currentKit) return;

                if (direction === 1) {
                    for (let item of form.comboItems) {
                        const source = newProducts.find(p => p.id === item.id);
                        if (!source || source.stock < (item.qty * qty)) {
                            return alert(`ERRO DE MONTAGEM:\nEstoque insuficiente de "${source?.name || 'Item'}".\nNecessário: ${item.qty * qty}\nDisponível: ${source?.stock || 0}`);
                        }
                    }
                } else {
                    if (currentKit.stock < qty) {
                        return alert(`ERRO DE DESMONTAGEM:\nEstoque de Kits insuficiente.\nAtual: ${currentKit.stock}`);
                    }
                }

                let log = direction === 1 ? "MONTAGEM REALIZADA:\n" : "DESMONTAGEM REALIZADA:\n";

                form.comboItems.forEach(item => {
                    const pIndex = newProducts.findIndex(p => p.id === item.id);
                    if (pIndex > -1) {
                        const change = item.qty * qty * direction;
                        newProducts[pIndex].stock -= change;
                        log += `- ${newProducts[pIndex].name}: ${change > 0 ? 'Saiu' : 'Entrou'} ${Math.abs(change)}\n`;
                    }
                });

                const kitIndex = newProducts.findIndex(p => p.id === editingId);
                newProducts[kitIndex].stock += (qty * direction);
                
                setProducts(newProducts);
                setForm(prev => ({ ...prev, stock: prev.stock + (qty * direction) }));
                alert(log + `\nSaldo Final do Kit: ${newProducts[kitIndex].stock}`);
            };

            const getStockStatus = (p) => {
                if (p.stock <= 0) return <span className="text-red-600 font-bold text-[10px] bg-red-100 px-2 py-0.5 rounded">ESGOTADO</span>;
                if (p.stock <= (p.minStock || 0)) return <span className="text-orange-600 font-bold text-[10px] bg-orange-100 px-2 py-0.5 rounded animate-pulse">BAIXO</span>;
                return <span className="text-emerald-600 font-bold text-[10px] bg-emerald-100 px-2 py-0.5 rounded">OK</span>;
            };

            return (
                <div className="flex h-full w-full bg-slate-200 overflow-hidden">
                    
                    {/* ASIDE LIST */}
                    <aside className="w-[65%] flex flex-col bg-white border-r border-slate-300 shadow-xl z-10 overflow-hidden">
                        <div className="p-4 bg-slate-50 border-b border-slate-200 space-y-3">
                            <div className="flex justify-between items-center">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="layers" className="text-primary-600"/>
                                    Gestão de Estoque
                                </h2>
                                <button 
                                    onClick={() => setShowCriticalOnly(!showCriticalOnly)}
                                    className={`flex items-center gap-2 px-3 py-1.5 rounded text-xs font-bold transition border ${showCriticalOnly ? 'bg-red-100 text-red-700 border-red-300' : 'bg-white text-slate-600 border-slate-300'}`}
                                >
                                    <Icon name="alert-triangle" size={14} className={showCriticalOnly ? "animate-pulse" : ""}/>
                                    {showCriticalOnly ? 'Críticos' : `Alertas (${criticalCount})`}
                                </button>
                            </div>
                            
                            <div className="flex gap-2">
                                <div className="relative flex-1">
                                    <Icon name="search" size={16} className="absolute left-3 top-2.5 text-slate-400"/>
                                    <input 
                                        value={search}
                                        onChange={e => setSearch(e.target.value)}
                                        placeholder="Buscar SKU..."
                                        className="w-full pl-9 pr-4 py-2 text-sm border border-slate-300 rounded outline-none"
                                    />
                                </div>
                                <select 
                                    value={catFilter} 
                                    onChange={e => setCatFilter(e.target.value)}
                                    className="w-40 py-2 px-3 text-sm border border-slate-300 rounded bg-white outline-none"
                                >
                                    <option value="">Todas Categorias</option>
                                    {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                        </div>

                        <div className="flex-1 overflow-auto bg-white">
                            <table className="w-full text-left border-collapse text-sm">
                                <thead className="text-xs uppercase text-slate-500 bg-slate-100 font-bold sticky top-0 z-20 shadow-sm">
                                    <tr>
                                        <th className="p-3 w-16">Cód.</th>
                                        <th className="p-3">Produto</th>
                                        <th className="p-3 w-24 text-right">Preço</th>
                                        <th className="p-3 w-24 text-center bg-blue-50/50">Avulso</th>
                                        <th className="p-3 w-24 text-center bg-amber-50/50">Kit</th>
                                        <th className="p-3 w-20 text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filteredProducts.map(p => (
                                        <tr key={p.id} onClick={() => handleEdit(p)} className={`cursor-pointer hover:bg-slate-50 ${editingId === p.id ? 'bg-blue-50' : ''}`}>
                                            <td className="p-3 font-mono text-xs text-slate-400">{p.internalCode}</td>
                                            <td className="p-3">
                                                <div className="font-medium text-slate-700">{p.name}</div>
                                                <div className="text-[10px] text-slate-400 uppercase">{p.category}</div>
                                            </td>
                                            <td className="p-3 text-right font-bold text-slate-600">{formatBRL(p.price)}</td>
                                            <td className="p-3 text-center bg-blue-50/20 font-mono">{!p.isCombo ? p.stock : '-'}</td>
                                            <td className="p-3 text-center bg-amber-50/20 font-mono text-amber-700">{p.isCombo ? p.stock : '-'}</td>
                                            <td className="p-3 text-center">{getStockStatus(p)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </aside>

                    {/* MAIN FORM */}
                    <main className="w-[35%] h-full bg-slate-100 flex flex-col overflow-hidden">
                        <div className="h-16 bg-white border-b border-slate-200 px-4 flex items-center justify-between shrink-0">
                            <h1 className="font-bold text-slate-800 text-xs uppercase">{editingId ? 'Editar Produto' : 'Novo SKU'}</h1>
                            <div className="flex gap-2">
                                <button onClick={handleNew} className="p-2 hover:bg-slate-100 rounded" title="Novo"><Icon name="plus" size={18}/></button>
                                {editingId && <button onClick={handleDelete} className="p-2 hover:bg-red-50 text-red-500 rounded"><Icon name="trash-2" size={18}/></button>}
                                <button onClick={handleSave} className="bg-slate-900 text-white px-4 py-2 rounded text-xs font-bold flex items-center gap-2"><Icon name="save" size={16}/> SALVAR</button>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            <div className="bg-white p-4 rounded shadow-sm border border-slate-200 space-y-3">
                                <div className="flex gap-3">
                                    <div className="w-1/3">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase">Cód</label>
                                        <input className="input-dense font-mono text-center bg-slate-50" value={form.internalCode} onChange={e => setForm({...form, internalCode: e.target.value})} />
                                    </div>
                                    <div className="w-2/3">
                                        <label className="text-[10px] font-bold text-slate-400 uppercase">Categoria</label>
                                        <select className="input-dense" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>
                                            {CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Nome do Produto</label>
                                    <input className="input-dense font-medium" value={form.name} onChange={e => setForm({...form, name: e.target.value})} />
                                </div>
                            </div>

                            <div className="bg-white p-4 rounded shadow-sm border border-slate-200 grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase">Custo R$</label>
                                    <input type="number" className="input-dense" value={form.cost} onChange={e => setForm({...form, cost: e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-primary-600 uppercase">Venda R$</label>
                                    <input type="number" className="input-dense font-bold text-primary-700" value={form.price} onChange={e => setForm({...form, price: e.target.value})} />
                                </div>
                            </div>

                            <div className="bg-white p-4 rounded shadow-sm border border-slate-200 space-y-3">
                                <div className="flex items-center gap-2">
                                    <input type="checkbox" id="iskit" checked={form.isCombo} onChange={e => setForm({...form, isCombo: e.target.checked})} />
                                    <label htmlFor="iskit" className="text-sm font-bold text-slate-700">Este é um KIT?</label>
                                </div>
                                <div className="grid grid-cols-2 gap-3 bg-slate-50 p-2 rounded">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 block">Estoque</label>
                                        <input type="number" className="input-dense text-center" value={form.stock} disabled={form.isCombo} onChange={e => setForm({...form, stock: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-red-400 block">Min Estoque</label>
                                        <input type="number" className="input-dense text-center" value={form.minStock} onChange={e => setForm({...form, minStock: e.target.value})} />
                                    </div>
                                </div>
                            </div>

                            {form.isCombo && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-amber-50 p-3 rounded border border-amber-200">
                                        <h4 className="text-[10px] font-bold text-amber-800 uppercase mb-2">Composição</h4>
                                        <div className="bg-white rounded max-h-40 overflow-auto border border-amber-100">
                                            {products.filter(p => !p.isCombo && p.id !== editingId).map(p => {
                                                const item = form.comboItems?.find(i => i.id === p.id);
                                                return (
                                                    <div key={p.id} className="p-2 border-b flex justify-between items-center text-xs">
                                                        <span className="truncate">{p.name}</span>
                                                        <input 
                                                            type="number" className="w-12 text-center border p-0.5 rounded" 
                                                            value={item?.qty || ''}
                                                            onChange={e => {
                                                                const val = parseInt(e.target.value) || 0;
                                                                const others = (form.comboItems || []).filter(i => i.id !== p.id);
                                                                setForm({...form, comboItems: val > 0 ? [...others, {id: p.id, qty: val}] : others});
                                                            }}
                                                        />
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>

                                    {editingId && (
                                        <div className="bg-slate-800 p-4 rounded text-white shadow-lg">
                                            <div className="flex items-center justify-between mb-3">
                                                <span className="text-xs font-bold uppercase text-amber-400">Montagem</span>
                                                <input type="number" className="w-16 bg-slate-900 border border-slate-600 rounded p-1 text-center" value={assemblyQty} onChange={e => setAssemblyQty(e.target.value)} />
                                            </div>
                                            <div className="grid grid-cols-2 gap-2">
                                                <button onClick={() => executeAssembly(1)} className="bg-emerald-600 p-2 rounded text-[10px] font-bold flex flex-col items-center"><Icon name="box" size={14}/> MONTAR</button>
                                                <button onClick={() => executeAssembly(-1)} className="bg-slate-600 p-2 rounded text-[10px] font-bold flex flex-col items-center"><Icon name="refresh-cw" size={14}/> DESMONTAR</button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
