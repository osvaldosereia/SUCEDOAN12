<!DOCTYPE html> 
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Módulo Gestão de Produtos (Local-First)</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ESTILOS EXTRAS -->
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .input-field {
            width: 100%;
            padding: 0.6rem; 
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .btn-primary {
            background-color: #1e293b;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #334155; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
    </style>

    <!-- 3. IMPORTMAP REACT + ZOD -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "zod": "https://esm.sh/zod@3.22.4"
      }
    }
    </script>
    
    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-full">
    
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { z } from 'zod';
        import { 
          Package, Search, Plus, Trash2, Save, BoxSelect, 
          Menu, X, ClipboardList, AlertTriangle, TrendingUp, DollarSign
        } from 'lucide-react';

        // --- SCHEMAS (Zod) ---
        const ProductSchema = z.object({
            id: z.string(),
            name: z.string().min(1),
            internalCode: z.string().nullish().or(z.literal('')),
            category: z.string().nullish().or(z.literal('')),
            cost: z.number().default(0), 
            price: z.number().default(0),
            stock: z.number().default(0),
            isCombo: z.boolean().optional(),
            comboItems: z.array(z.object({
                id: z.string(),
                qty: z.number(),
            })).optional(),
            stockHistory: z.array(z.any()).optional()
        });

        // --- UTILITÁRIOS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };

        // --- APP PRINCIPAL ---
        function App() {
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
          const [showStockManager, setShowStockManager] = useState(false);

          return (
            <div className="flex flex-col lg:flex-row h-screen bg-gray-100 font-sans text-gray-800 overflow-hidden">
                {/* MOBILE HEADER */}
                <div className="lg:hidden bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 z-50 shadow-md">
                    <div className="flex items-center gap-2">
                        <div className="bg-blue-500 text-white p-1 rounded font-bold text-xs">WMS</div>
                        <h1 className="font-bold tracking-wider">PRODUTOS</h1>
                    </div>
                    <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 bg-slate-800 rounded">
                        {mobileMenuOpen ? <X size={20}/> : <Menu size={20}/>}
                    </button>
                </div>

                {/* SIDEBAR */}
                <aside className={`fixed inset-y-0 left-0 bg-slate-900 text-white flex flex-col transition-transform duration-300 z-40 w-64 lg:static lg:translate-x-0 ${mobileMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'}`}>
                    <div className="h-16 hidden lg:flex items-center justify-start px-6 border-b border-slate-800">
                        <div className="bg-blue-500 text-white p-1.5 rounded font-bold mr-2">WMS</div>
                        <h1 className="font-bold tracking-wider hidden lg:block text-lg">ESTOQUE <span className="text-gray-400 text-xs font-normal ml-1">v1.0</span></h1>
                    </div>
                    <nav className="flex-1 py-4 space-y-1 overflow-y-auto mt-16 lg:mt-0">
                        <button className="w-full flex items-center justify-start gap-3 p-3 lg:px-6 transition-all duration-200 bg-slate-800 text-white border-r-4 border-blue-500">
                            <Package size={20}/>
                            <span className="font-medium text-sm">Cadastro de Produtos</span>
                        </button>
                    </nav>
                    <div className="p-4 border-t border-slate-800 space-y-3 pb-8 lg:pb-4">
                        <button onClick={() => {setShowStockManager(true); setMobileMenuOpen(false);}} className="w-full flex items-center justify-start gap-3 p-2 rounded hover:bg-slate-800 transition text-slate-400 hover:text-white border border-slate-700">
                            <ClipboardList size={20} /> <span className="text-sm font-medium">Movimentação em Massa</span>
                        </button>
                    </div>
                </aside>
                
                {/* MAIN CONTENT AREA */}
                <main className="flex-1 flex flex-col min-w-0 bg-gray-50 h-full overflow-hidden relative">
                    <header className="h-16 bg-white border-b hidden lg:flex items-center justify-between px-6 shrink-0 shadow-sm z-20">
                        <div><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">Gestão de Catálogo e Estoque</h2></div>
                        <div className="flex items-center gap-2">
                             <span className="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">{products.length} SKUs Ativos</span>
                        </div>
                    </header>
                    
                    <div className="flex-1 overflow-hidden relative bg-gray-50">
                        <ProductRegistry products={products} setProducts={setProducts} />
                    </div>
                </main>
                
                {/* MODAL MOVIMENTAÇÃO EM MASSA */}
                {showStockManager && (
                    <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 animate-in">
                        <div className="bg-white w-full max-w-5xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
                            <div className="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                                <h2 className="font-bold flex items-center gap-2 text-lg"><ClipboardList size={20}/> GERENCIADOR DE ESTOQUE (TEXTO)</h2>
                                <button onClick={() => setShowStockManager(false)} className="hover:bg-slate-700 p-1.5 rounded-full transition"><XCircle size={24}/></button>
                            </div>
                            <StockManager products={products} setProducts={setProducts} />
                        </div>
                    </div>
                )}

                {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 lg:hidden" onClick={() => setMobileMenuOpen(false)}></div>}
            </div>
          );
        }

        function XCircle({size}) { return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>; }

        // --- COMPONENTE DE REGISTRO DE PRODUTOS ---
        function ProductRegistry({ products, setProducts }) {
            const [pForm, setPForm] = useState({ 
                name: '', internalCode: '', category: 'ALIMENTOS', 
                cost: '', price: '', stock: 0, isCombo: false, comboItems: [] 
            });
            const [editingProductId, setEditingProductId] = useState(null);
            const [search, setSearch] = useState('');

            // Estatísticas Rápidas
            const registryStats = useMemo(() => {
                const uniqueProducts = products.length;
                let totalStockValue = 0;
                const combosPotential = [];

                products.forEach(p => {
                    totalStockValue += (Number(p.cost) || 0) * (Number(p.stock) || 0);

                    if (p.isCombo && p.comboItems && p.comboItems.length > 0) {
                        let maxPossible = Infinity;
                        p.comboItems.forEach(item => {
                            const ingredient = products.find(prod => prod.id === item.id);
                            if (ingredient && item.qty > 0) {
                                const possibleWithThis = Math.floor((ingredient.stock || 0) / item.qty);
                                if (possibleWithThis < maxPossible) maxPossible = possibleWithThis;
                            } else { maxPossible = 0; }
                        });
                        if (maxPossible === Infinity) maxPossible = 0;
                        combosPotential.push({ name: p.name, qty: maxPossible });
                    }
                });

                return { uniqueProducts, totalStockValue, combosPotential };
            }, [products]);

            const getNextProductCode = () => {
                const codes = products.map(p => parseInt(p.internalCode)).filter(n => !isNaN(n));
                const max = codes.length > 0 ? Math.max(...codes) : 0;
                return (max + 1).toString();
            };

            const startNew = () => {
                setPForm({ name: '', internalCode: getNextProductCode(), category: 'ALIMENTOS', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
                setEditingProductId(null);
            };

            const saveProduct = () => { 
                if (!pForm.name) return alert('Nome do produto é obrigatório');
                
                const cost = Number(pForm.cost) || 0;
                const price = Number(pForm.price) || 0;
                let margin = 0;
                if (price > 0) margin = ((price - cost) / price) * 100;
                
                if (margin < 20) {
                    if(!confirm(`ALERTA: Margem de lucro muito baixa (${margin.toFixed(1)}%).\nDeseja salvar mesmo assim?`)) return;
                }

                if (editingProductId) { 
                    setProducts(products.map(p => p.id === editingProductId ? { ...pForm, id: editingProductId, stock: p.stock, stockHistory: p.stockHistory } : p)); 
                    setEditingProductId(null); 
                    alert('Produto atualizado!'); 
                } else { 
                    const newProd = { ...pForm, id: generateId(), stockHistory: [{ date: new Date().toISOString(), type: 'INITIAL', qty: Number(pForm.stock) }] }; 
                    setProducts([...products, newProd]); 
                    alert('Produto criado com sucesso!'); 
                } 
                startNew();
            };

            const deleteItem = () => {
                if(!editingProductId) return;
                if(!confirm("TEM CERTEZA? Excluir este produto é irreversível.")) return;
                setProducts(products.filter(p => p.id !== editingProductId));
                setEditingProductId(null);
                startNew();
                alert("Produto excluído.");
            };

            // Lista Filtrada
            const list = products.filter(p => 
                p.name.toLowerCase().includes(search.toLowerCase()) || 
                (p.internalCode && p.internalCode.includes(search))
            ).sort((a,b) => a.name.localeCompare(b.name));

            return (
                <div className="flex flex-col lg:flex-row h-full pb-20 lg:pb-0">
                    {/* LISTAGEM (ESQUERDA) */}
                    <div className="flex-1 border-r bg-white flex flex-col overflow-hidden order-2 lg:order-1">
                        <div className="p-4 border-b shrink-0 bg-gray-50/50">
                            <div className="relative">
                                <Search className="absolute left-3 top-2.5 text-gray-400" size={18}/>
                                <input 
                                    className="w-full pl-10 pr-4 py-2 border rounded-lg text-sm outline-none focus:border-blue-500 transition" 
                                    placeholder="Buscar por Nome ou Código..." 
                                    value={search} 
                                    onChange={e => setSearch(e.target.value)} 
                                />
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-auto scrollbar-thin">
                            <table className="w-full text-left border-collapse text-xs sm:text-sm">
                                <thead className="bg-gray-100 text-gray-600 sticky top-0 z-10 font-bold uppercase shadow-sm">
                                    <tr>
                                        <th className="p-3 border-b">Nome</th>
                                        <th className="p-3 border-b text-center">Cód</th>
                                        <th className="p-3 border-b text-center hidden sm:table-cell">Cat</th>
                                        <th className="p-3 border-b text-right hidden md:table-cell">Custo</th>
                                        <th className="p-3 border-b text-right">Venda</th>
                                        <th className="p-3 border-b text-center hidden md:table-cell">Margem</th>
                                        <th className="p-3 border-b text-center">Estoque</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {list.map(p => {
                                        const margin = p.price > 0 ? ((p.price - p.cost) / p.price) * 100 : 0;
                                        const isSelected = editingProductId === p.id;
                                        
                                        // Semáforo de Margem
                                        let marginColor = 'text-gray-500 bg-gray-100'; 
                                        if (margin < 20) marginColor = 'text-red-800 bg-red-100 border border-red-200'; 
                                        else if (margin >= 20 && margin <= 30) marginColor = 'text-yellow-700 bg-yellow-50'; 
                                        else if (margin > 30) marginColor = 'text-green-700 bg-green-50'; 

                                        return (
                                            <tr key={p.id} onClick={() => { setPForm(p); setEditingProductId(p.id); }} className={`hover:bg-blue-50 cursor-pointer transition ${isSelected ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`}>
                                                <td className="p-3 font-medium text-gray-800">
                                                    {p.name} {p.isCombo && <span className="bg-yellow-100 text-yellow-800 px-1 rounded text-[9px] font-bold border border-yellow-200 ml-1">KIT</span>}
                                                </td>
                                                <td className="p-3 text-center text-gray-500 font-mono">{p.internalCode || '-'}</td>
                                                <td className="p-3 text-center text-gray-500 hidden sm:table-cell">{p.category}</td>
                                                <td className="p-3 text-right text-gray-500 hidden md:table-cell">{formatCurrency(p.cost)}</td>
                                                <td className="p-3 text-right font-bold text-emerald-600">{formatCurrency(p.price)}</td>
                                                <td className="p-3 text-center hidden md:table-cell"><span className={`px-2 py-0.5 rounded text-[10px] font-bold ${marginColor}`}>{margin.toFixed(0)}%</span></td>
                                                <td className="p-3 text-center font-bold">
                                                    <span className={p.stock <= 5 ? 'text-red-600' : 'text-gray-800'}>{p.stock}</span>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                    {list.length === 0 && <tr><td colSpan="7" className="p-8 text-center text-gray-400">Nenhum produto cadastrado.</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* FORMULÁRIO (DIREITA) */}
                    <div className="w-full lg:w-[400px] bg-gray-50 border-l shadow-xl z-20 flex flex-col order-1 lg:order-2 shrink-0 h-[500px] lg:h-full">
                        <div className="p-4 border-b bg-white flex justify-between items-center shadow-sm">
                            <h2 className="font-bold text-gray-800 text-sm uppercase tracking-wide">
                                {editingProductId ? 'Editar Produto' : 'Novo Produto'}
                            </h2>
                            <div className="flex gap-2">
                                {editingProductId && <button onClick={deleteItem} className="text-xs bg-red-100 text-red-600 hover:bg-red-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1"><Trash2 size={14}/> EXCLUIR</button>}
                                <button onClick={startNew} className="text-xs bg-blue-100 text-blue-600 hover:bg-blue-200 px-3 py-1.5 rounded font-bold transition flex items-center gap-1"><Plus size={14}/> NOVO</button>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            <div className="space-y-3">
                                <div>
                                    <label className="text-[10px] font-bold text-gray-400 uppercase">Nome do Produto *</label>
                                    <input className="input-field" value={pForm.name} onChange={e => setPForm({...pForm, name: e.target.value})} placeholder="Ex: Cerveja Artesanal 600ml" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-[10px] font-bold text-gray-400 uppercase">Cód Interno</label>
                                        <input className="input-field font-mono font-bold text-blue-600" value={pForm.internalCode} onChange={e => setPForm({...pForm, internalCode: e.target.value})} placeholder="001" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-gray-400 uppercase">Categoria</label>
                                        <input className="input-field" value={pForm.category} onChange={e => setPForm({...pForm, category: e.target.value})} list="categories" />
                                        <datalist id="categories">
                                            <option value="BEBIDAS"/>
                                            <option value="ALIMENTOS"/>
                                            <option value="LIMPEZA"/>
                                        </datalist>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-[10px] font-bold text-gray-400 uppercase">Custo (R$)</label>
                                        <input className="input-field" type="number" step="0.01" value={pForm.cost} onChange={e => setPForm({...pForm, cost: e.target.value})} placeholder="0.00" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-gray-400 uppercase">Venda (R$)</label>
                                        <input className="input-field font-bold text-green-700" type="number" step="0.01" value={pForm.price} onChange={e => setPForm({...pForm, price: e.target.value})} placeholder="0.00" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3 items-end">
                                    <div>
                                        <label className="text-[10px] font-bold text-gray-400 uppercase">Estoque Atual</label>
                                        <input className="input-field bg-white" type="number" value={pForm.stock} disabled={pForm.isCombo} onChange={e => setPForm({...pForm, stock: Number(e.target.value)})} />
                                    </div>
                                    <div className="pb-3">
                                        <label className="flex items-center gap-2 cursor-pointer select-none bg-blue-50 p-2 rounded border border-blue-100">
                                            <input type="checkbox" className="w-4 h-4 rounded text-blue-600" checked={pForm.isCombo} onChange={e => setPForm({...pForm, isCombo: e.target.checked})} />
                                            <span className="text-xs font-bold text-blue-800">É UM KIT/COMBO?</span>
                                        </label>
                                    </div>
                                </div>
                                
                                {/* CONFIGURADOR DE KIT */}
                                {pForm.isCombo && (
                                    <div className="bg-yellow-50 p-3 rounded border border-yellow-200 mt-2 animate-in">
                                        <h4 className="font-bold text-yellow-800 text-[10px] uppercase mb-2 flex items-center gap-1"><BoxSelect size={12}/> Composição (Abate Estoque)</h4>
                                        <div className="space-y-1 max-h-40 overflow-y-auto scrollbar-thin bg-white border rounded">
                                            {products.filter(p => !p.isCombo && p.id !== editingProductId).map(p => (
                                                <div key={p.id} className="flex justify-between items-center text-xs p-2 border-b border-gray-100 last:border-0 hover:bg-gray-50">
                                                    <span className="truncate max-w-[150px] font-medium text-gray-700">{p.name}</span>
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-gray-400 text-[10px]">Qtd:</span>
                                                        <input 
                                                            type="number" 
                                                            className="w-12 border rounded text-center p-1 bg-white focus:border-blue-500 outline-none" 
                                                            placeholder="0" 
                                                            value={pForm.comboItems.find(i => i.id === p.id)?.qty || ''} 
                                                            onChange={(e) => { 
                                                                const qty = Number(e.target.value); 
                                                                const existing = pForm.comboItems.filter(i => i.id !== p.id); 
                                                                if (qty > 0) setPForm({...pForm, comboItems: [...existing, {id: p.id, qty}]}); 
                                                                else setPForm({...pForm, comboItems: existing}); 
                                                            }} 
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                            {products.filter(p => !p.isCombo).length === 0 && <div className="p-2 text-center text-gray-400 text-xs">Sem produtos simples cadastrados.</div>}
                                        </div>
                                    </div>
                                )}
                                
                                <button onClick={saveProduct} className="w-full btn-primary mt-2 flex items-center justify-center gap-2">
                                    <Save size={18}/> {editingProductId ? 'SALVAR ALTERAÇÕES' : 'CADASTRAR PRODUTO'}
                                </button>

                                {/* DASHBOARD DE INTEHIGÊNCIA (MINI) */}
                                <div className="mt-6 bg-slate-50 rounded-lg p-3 border border-slate-200 text-xs text-gray-600 shadow-inner">
                                    <h4 className="font-bold text-slate-800 uppercase mb-2 flex items-center gap-1"><TrendingUp size={12}/> Inteligência de Estoque</h4>
                                    <ul className="space-y-1">
                                        <li className="flex justify-between"><span>SKUs Únicos:</span> <span className="font-bold">{registryStats.uniqueProducts}</span></li>
                                        <li className="flex justify-between"><span>Valor em Estoque (Custo):</span> <span className="font-bold text-emerald-600">{formatCurrency(registryStats.totalStockValue)}</span></li>
                                    </ul>
                                    {registryStats.combosPotential.length > 0 && (
                                        <div className="mt-2 pt-2 border-t border-slate-200">
                                            <p className="font-bold mb-1 text-[10px] uppercase text-slate-500">Capacidade de Kits (Baseado em Insumos):</p>
                                            <div className="space-y-1 max-h-24 overflow-y-auto scrollbar-thin">
                                                {registryStats.combosPotential.map((c, idx) => (
                                                    <div key={idx} className="flex justify-between items-center">
                                                        <span className="truncate w-32">{c.name}</span>
                                                        <span className={`font-bold px-1.5 rounded ${c.qty > 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{c.qty} un</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // --- GERENCIADOR DE ESTOQUE EM MASSA ---
        function StockManager({ products, setProducts }) {
             const [bulkIn, setBulkIn] = useState(''); 
             const [bulkOut, setBulkOut] = useState(''); 
             const sortedProducts = [...products].sort((a,b) => a.name.localeCompare(b.name));
             
             const processBulk = (text, type) => { 
                 const lines = text.split('\n'); 
                 const newProducts = [...products]; 
                 let log = []; 
                 let errors = []; 
                 
                 lines.forEach(line => { 
                     if(!line.trim()) return; 
                     // Aceita separadores: PIPE (|) ou TABulação
                     const parts = line.split(/[|\t]+/); 
                     const code = parts[0]?.trim(); 
                     const qty = parseInt(parts[1]?.trim()); 
                     const validity = parts[2]?.trim(); // Opcional

                     if (!code || isNaN(qty)) return; 
                     
                     // Busca inteligente: Código Interno > Nome Exato > Nome Parcial (Arriscado, preferir exato)
                     const prodIndex = newProducts.findIndex(p => 
                        (p.internalCode && p.internalCode === code) || 
                        (p.name.toUpperCase() === code.toUpperCase())
                     ); 
                     
                     if (prodIndex !== -1) { 
                         const prod = newProducts[prodIndex]; 
                         const oldStock = prod.stock; 
                         if (type === 'IN') { 
                             prod.stock += qty; 
                             if(!prod.stockHistory) prod.stockHistory = [];
                             prod.stockHistory.push({ date: new Date().toISOString(), type: 'BULK_IN', qty, validity }); 
                             log.push(`${prod.name}: ${oldStock} -> ${prod.stock}`); 
                         } else { 
                             prod.stock -= qty; 
                             if(!prod.stockHistory) prod.stockHistory = [];
                             prod.stockHistory.push({ date: new Date().toISOString(), type: 'BULK_OUT', qty }); 
                             log.push(`${prod.name}: ${oldStock} -> ${prod.stock}`); 
                         } 
                     } else { 
                        errors.push(code); 
                     } 
                 }); 
                 
                 setProducts(newProducts); 
                 
                 let resultMsg = `${type === 'IN' ? 'ENTRADA' : 'SAÍDA'} PROCESSADA!\n\n`; 
                 if(log.length > 0) resultMsg += `Itens atualizados: ${log.length}\n`; 
                 if(errors.length > 0) resultMsg += `\n❌ Códigos não encontrados: ${errors.join(', ')}`; 
                 
                 alert(resultMsg); 
                 if(type === 'IN') setBulkIn(''); else setBulkOut(''); 
            };

             return (
                <div className="flex h-full flex-col lg:flex-row bg-gray-100">
                    <div className="w-full lg:w-1/3 border-r bg-white p-4 overflow-y-auto scrollbar-thin h-[200px] lg:h-full shadow-inner">
                        <h4 className="font-bold text-gray-500 uppercase text-xs mb-3 sticky top-0 bg-white pb-2 border-b">Referência de Códigos</h4>
                        {sortedProducts.map(p => (
                            <div key={p.id} className="flex justify-between items-center text-xs py-2 border-b border-gray-100 hover:bg-gray-50 group">
                                <div>
                                    <span className="font-bold block text-gray-800 group-hover:text-blue-600">{p.name}</span>
                                    <span className="text-[10px] text-gray-400 font-mono select-all bg-gray-100 px-1 rounded">{p.internalCode || 'S/ COD'}</span>
                                </div>
                                <span className={`font-bold px-2 py-1 rounded ${p.stock <= 5 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{p.stock}</span>
                            </div>
                        ))}
                    </div>
                    <div className="flex-1 p-6 space-y-4 overflow-y-auto bg-gray-50">
                        <div className="bg-blue-50 border border-blue-200 p-3 rounded text-xs text-blue-800 mb-4">
                            <strong>Instruções:</strong> Copie e cole dados do Excel ou Bloco de Notas.<br/>
                            Formato aceito: <code>CÓDIGO | QUANTIDADE</code> (ex: <code>001 | 50</code> ou <code>Coca Cola | 12</code>)
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white p-4 rounded-lg shadow-sm border border-green-200">
                                <h3 className="font-bold text-green-700 mb-2 flex items-center gap-2"><Plus size={16}/> Entrada em Massa</h3>
                                <textarea className="w-full h-64 border p-3 text-xs font-mono bg-gray-50 focus:bg-white focus:border-green-500 outline-none rounded transition" placeholder="001 | 10&#10;002 | 5" value={bulkIn} onChange={e=>setBulkIn(e.target.value)}></textarea>
                                <button onClick={()=>processBulk(bulkIn, 'IN')} className="w-full bg-green-600 text-white font-bold py-3 rounded mt-2 hover:bg-green-700 transition shadow-sm">PROCESSAR ENTRADA</button>
                            </div>
                            <div className="bg-white p-4 rounded-lg shadow-sm border border-red-200">
                                <h3 className="font-bold text-red-700 mb-2 flex items-center gap-2"><Trash2 size={16}/> Saída/Baixa em Massa</h3>
                                <textarea className="w-full h-64 border p-3 text-xs font-mono bg-gray-50 focus:bg-white focus:border-red-500 outline-none rounded transition" placeholder="001 | 2&#10;005 | 1" value={bulkOut} onChange={e=>setBulkOut(e.target.value)}></textarea>
                                <button onClick={()=>processBulk(bulkOut, 'OUT')} className="w-full bg-red-600 text-white font-bold py-3 rounded mt-2 hover:bg-red-700 transition shadow-sm">PROCESSAR SAÍDA</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
