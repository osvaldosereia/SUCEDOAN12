<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Log√≠stica Local-First v8.0 (Inventory Intelligence)</title>
    
    <!-- 1. TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ESTILOS EXTRAS -->
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
        
        .input-field {
            width: 100%;
            padding: 0.6rem; 
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }
        .btn-primary {
            background-color: #1e293b;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background-color: #334155; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        
        .nav-item.active { background-color: #334155; border-right: 4px solid #34d399; }
    </style>

    <!-- 3. IMPORTMAP REACT + ZOD -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "zod": "https://esm.sh/zod@3.22.4"
      }
    }
    </script>
    
    <!-- 4. BABEL -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-full">
    
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { z } from 'zod';
        import { 
          Save, Truck, Package, ShoppingCart, Users, MapPin, 
          Printer, Share2, Download, Upload, Trash2, Plus, 
          Minus, CheckCircle, Search, Navigation, Edit2, 
          ArrowUp, ArrowDown, History, MessageCircle, XCircle,
          AlertTriangle, FileText, Banknote, List, Tag, Percent, 
          Calendar, Filter, Phone, Database, Clipboard, Box, ExternalLink,
          Clock, Home, DollarSign, CreditCard, Check, ShieldCheck, ClipboardList,
          ArrowRight, ArrowLeft, LayoutDashboard, Settings, Menu, BarChart2, TrendingUp, PieChart,
          MessageSquare, HeartHandshake, RefreshCcw, ThumbsUp, Star, Activity, LineChart, ChevronDown, Gift, X, Wallet, Ban, BoxSelect,
          GanttChart
        } from 'lucide-react';

        // --- SCHEMAS DE VALIDA√á√ÉO (ZOD) ---
        const ClientSchema = z.object({
            id: z.string(),
            name: z.string().min(1),
            code: z.string().nullish().or(z.literal('')),
            phone: z.string().nullish().or(z.literal('')),
            phone2: z.string().nullish().or(z.literal('')), 
            address: z.string().nullish().or(z.literal('')),
            city: z.string().nullish().or(z.literal('')),
            district: z.string().nullish().or(z.literal('')),
            region: z.string().nullish().or(z.literal('')),
            mapLink: z.string().nullish().or(z.literal('')),
            photoLink: z.string().nullish().or(z.literal('')),
            obs: z.string().nullish().or(z.literal(''))
        });

        const ProductSchema = z.object({
            id: z.string(),
            name: z.string().min(1),
            internalCode: z.string().nullish().or(z.literal('')),
            category: z.string().nullish().or(z.literal('')),
            ncm: z.string().nullish().or(z.literal('')),
            barcode: z.string().nullish().or(z.literal('')),
            cost: z.any().transform(v => Number(v) || 0), 
            price: z.any().transform(v => Number(v) || 0),
            stock: z.any().transform(v => Number(v) || 0),
            isCombo: z.boolean().optional(),
            comboItems: z.array(z.object({
                id: z.string(),
                qty: z.number(),
                internalPrice: z.number().optional() 
            })).optional(),
            stockHistory: z.array(z.any()).optional()
        });

        const SaleItemSchema = z.object({
            id: z.string(),
            name: z.string(),
            price: z.any().transform(v => Number(v) || 0),
            tempId: z.string().optional(),
            qty: z.number().optional(), 
            isCombo: z.boolean().optional(),
            comboItems: z.array(z.any()).optional()
        }).passthrough(); 

        const SaleSchema = z.object({
            id: z.string(),
            fullId: z.string().optional(),
            clientId: z.string(),
            items: z.array(SaleItemSchema),
            subTotal: z.number(),
            discount: z.number(),
            total: z.number(),
            payMethod: z.string(),
            changeFor: z.any().optional(),
            obs: z.string().nullish().or(z.literal('')),
            date: z.string(),
            status: z.string(),
            printedLabel: z.boolean().optional(),
            printedList: z.boolean().optional(),
            volumes: z.number().optional(),
            routeId: z.any().optional(),
            regionOverride: z.string().nullish(),
            gift: z.string().nullish(),
            isPaid: z.boolean().optional(),
            cashbackValue: z.number().optional()
        });

        const BackupSchema = z.object({
            version: z.string().optional(),
            exportedAt: z.string().optional(),
            clients: z.array(ClientSchema).optional(),
            products: z.array(ProductSchema).optional(),
            sales: z.array(SaleSchema).optional(),
            companyPhone: z.string().optional(),
            postSaleLog: z.record(z.any()).optional()
        });
        
        // --- UTILIT√ÅRIOS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const generateDailyId = (sales) => {
            const today = new Date().toISOString().slice(0, 10);
            const todaysSales = sales.filter(s => s.date.startsWith(today));
            const count = todaysSales.length + 1;
            return count > 99 ? count.toString() : count.toString().padStart(2, '0');
        };
        const generateClientCode = (existingClients) => {
           let code;
           let attempts = 0;
           do {
             code = Math.floor(1000 + Math.random() * 9000).toString();
             attempts++;
             if(attempts > 1000) break; 
           } while (existingClients.some(c => c.code === code));
           return code;
        };
        const useStickyState = (key, defaultValue) => {
          const [value, setValue] = useState(() => {
            const stickyValue = window.localStorage.getItem(key);
            return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
          });
          useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(value));
          }, [key, value]);
          return [value, setValue];
        };
        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatPercent = (value) => new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(value);
        const formatDate = (dateString) => (!dateString) ? '-' : new Date(dateString).toLocaleDateString('pt-BR');

        // --- APP PRINCIPAL ---
        function App() {
          const [clients, setClients] = useStickyState('db_clients_v3', []);
          const [products, setProducts] = useStickyState('db_products_v3', []);
          const [sales, setSales] = useStickyState('db_sales_v3', []);
          const [companyPhone, setCompanyPhone] = useStickyState('db_config_phone', '65998150975');
          const [postSaleLog, setPostSaleLog] = useStickyState('db_postsale_log', {}); 
          
          const [viewMode, setViewMode] = useState('operations');
          const [activeTab, setActiveTab] = useState('operations');
          const [showStockManager, setShowStockManager] = useState(false);
          const [driverData, setDriverData] = useState(null);
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
          
          const [saleToEdit, setSaleToEdit] = useState(null);
          const [backupType, setBackupType] = useState('all'); 

          useEffect(() => {
            const checkHash = () => {
                const hash = window.location.hash;
                if (hash.startsWith('#driver=')) {
                  try {
                    const encoded = hash.replace('#driver=', '');
                    const decoded = JSON.parse(atob(decodeURIComponent(encoded)));
                    setDriverData(decoded);
                    setViewMode('driver');
                  } catch (e) {
                    console.error("Link inv√°lido", e);
                    alert("Erro ao abrir link do entregador.");
                  }
                } else {
                    if (viewMode === 'driver') setViewMode('operations');
                }
            };
            checkHash();
            window.addEventListener('hashchange', checkHash);
            return () => window.removeEventListener('hashchange', checkHash);
          }, []);

          const handleBackup = () => {
            let data = { version: '8.0', exportedAt: new Date().toISOString() };
            let filename = 'backup';
            if (backupType === 'all') { 
                data = { ...data, clients, products, sales, companyPhone, postSaleLog }; 
                filename = 'backup_completo'; 
            } else if (backupType === 'clients') { 
                data = { ...data, clients }; 
                filename = 'backup_clientes'; 
            } else if (backupType === 'products') { 
                data = { ...data, products }; 
                filename = 'backup_produtos'; 
            }
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); 
            a.href = url; 
            a.download = `${filename}_${new Date().toISOString().slice(0,10)}.json`; 
            a.click();
          };

          const handleRestore = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const rawData = JSON.parse(event.target.result);
                const result = BackupSchema.safeParse(rawData);
                if (!result.success) return alert(`FALHA DE INTEGRIDADE (ZOD): Arquivo inv√°lido.`);
                const data = result.data;
                if (confirm("SEGURAN√áA: Dados validados.\nSobrescrever base local?")) {
                  if (data.clients) setClients(data.clients);
                  if (data.products) setProducts(data.products);
                  if (data.sales) setSales(data.sales);
                  if (data.companyPhone) setCompanyPhone(data.companyPhone);
                  if (data.postSaleLog) setPostSaleLog(data.postSaleLog);
                  alert("Importa√ß√£o conclu√≠da.");
                }
              } catch (err) { alert("Erro ao ler JSON."); }
            };
            reader.readAsText(file);
          };

          if (viewMode === 'driver') return <DriverView data={driverData} onExit={() => { window.location.hash = ''; setViewMode('operations'); }} />;

          const renderContent = () => {
             switch(activeTab) {
                case 'operations': 
                    return (
                        <OperationsView 
                            clients={clients} 
                            products={products} setProducts={setProducts} 
                            sales={sales} setSales={setSales} 
                            saleToEdit={saleToEdit} setSaleToEdit={setSaleToEdit} 
                            companyPhone={companyPhone}
                        />
                    );
                case 'crm': return <RegistryView clients={clients} setClients={setClients} products={products} setProducts={setProducts} />;
                default: return <OperationsView clients={clients} products={products} setProducts={setProducts} sales={sales} setSales={setSales} saleToEdit={saleToEdit} setSaleToEdit={setSaleToEdit} companyPhone={companyPhone} />;
             }
          };

          return (
            <div className="flex flex-col lg:flex-row h-screen bg-gray-100 font-sans text-gray-800 overflow-hidden">
                {/* MOBILE HEADER */}
                <div className="lg:hidden bg-slate-900 text-white p-4 flex justify-between items-center shrink-0 z-50 shadow-md">
                    <div className="flex items-center gap-2">
                        <div className="bg-yellow-500 text-slate-900 p-1 rounded font-bold text-xs">LOG</div>
                        <h1 className="font-bold tracking-wider">SISTEMA v8.0</h1>
                    </div>
                    <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="p-2 bg-slate-800 rounded">
                        {mobileMenuOpen ? <X size={20}/> : <Menu size={20}/>}
                    </button>
                </div>

                {/* SIDEBAR (Desktop & Mobile Drawer) */}
                <aside className={`fixed inset-y-0 left-0 bg-slate-900 text-white flex flex-col transition-transform duration-300 z-40 w-64 lg:static lg:translate-x-0 ${mobileMenuOpen ? 'translate-x-0 shadow-2xl' : '-translate-x-full'}`}>
                    <div className="h-16 hidden lg:flex items-center justify-center lg:justify-start lg:px-6 border-b border-slate-800">
                        <div className="bg-yellow-500 text-slate-900 p-1.5 rounded font-bold mr-2">LOG</div>
                        <h1 className="font-bold tracking-wider hidden lg:block text-lg">SISTEMA <span className="text-emerald-400 text-xs font-normal border border-emerald-500 rounded px-1 ml-1">V8.0</span></h1>
                    </div>
                    <nav className="flex-1 py-4 space-y-1 overflow-y-auto mt-16 lg:mt-0">
                        <NavItem icon={<GanttChart size={20}/>} label="Opera√ß√µes" active={activeTab === 'operations'} onClick={() => {setActiveTab('operations'); setMobileMenuOpen(false);}} />
                        <NavItem icon={<Database size={20}/>} label="Cadastros" active={activeTab === 'crm'} onClick={() => {setActiveTab('crm'); setMobileMenuOpen(false);}} />
                    </nav>
                    <div className="p-4 border-t border-slate-800 space-y-3 pb-8 lg:pb-4">
                        <button onClick={() => {setShowStockManager(true); setMobileMenuOpen(false);}} className="w-full flex items-center justify-start gap-3 p-2 rounded hover:bg-slate-800 transition text-slate-400 hover:text-white">
                            <ClipboardList size={20} /> <span className="text-sm font-medium">Estoque R√°pido</span>
                        </button>
                        <div className="pt-2 border-t border-slate-800">
                            <div className="flex gap-2 mb-2">
                                <select className="bg-slate-800 text-xs text-white p-1.5 rounded border border-slate-700 flex-1 outline-none" value={backupType} onChange={(e) => setBackupType(e.target.value)}>
                                    <option value="all">Geral</option><option value="clients">Clientes</option><option value="products">Produtos</option>
                                </select>
                                <button onClick={handleBackup} className="bg-emerald-600 hover:bg-emerald-500 p-1.5 rounded text-white transition"><Download size={14} /></button>
                            </div>
                            <label className="flex items-center gap-2 text-xs text-slate-400 hover:text-white cursor-pointer transition">
                                <Upload size={14} /> Importar JSON <input type="file" className="hidden" accept=".json" onChange={handleRestore} />
                            </label>
                        </div>
                    </div>
                </aside>
                
                {/* MAIN CONTENT AREA */}
                <main className="flex-1 flex flex-col min-w-0 bg-gray-50 h-full overflow-hidden relative">
                    <header className="h-16 bg-white border-b hidden lg:flex items-center justify-between px-6 shrink-0 shadow-sm z-20">
                        <div><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">{activeTab === 'operations' ? 'Painel de Opera√ß√µes' : 'Cadastros'}</h2></div>
                        <div className="flex items-center gap-4">
                            <div className="hidden sm:flex items-center gap-2 text-sm text-gray-500 bg-gray-100 px-3 py-1.5 rounded-full border">
                                <Phone size={14} /><input className="bg-transparent w-24 outline-none" value={companyPhone} onChange={e => setCompanyPhone(e.target.value)} />
                            </div>
                            <div className="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-slate-600 font-bold">OP</div>
                        </div>
                    </header>
                    <div className="flex-1 overflow-y-auto overflow-x-hidden relative bg-gray-50">
                        {renderContent()}
                    </div>
                </main>

                {showStockManager && <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 animate-in"><div className="bg-white w-full max-w-5xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden"><div className="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0"><h2 className="font-bold flex items-center gap-2 text-lg"><ClipboardList size={20}/> GERENCIADOR DE ESTOQUE</h2><button onClick={() => setShowStockManager(false)} className="hover:bg-slate-700 p-1.5 rounded-full transition"><XCircle size={24}/></button></div><StockManager products={products} setProducts={setProducts} /></div></div>}
                
                {/* Mobile Overlay */}
                {mobileMenuOpen && <div className="fixed inset-0 bg-black/50 z-30 lg:hidden" onClick={() => setMobileMenuOpen(false)}></div>}
            </div>
          );
        }

        const NavItem = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center justify-start gap-3 p-3 lg:px-6 transition-all duration-200 nav-item ${active ? 'active text-white bg-slate-800' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`} title={label}>{icon}<span className="font-medium text-sm">{label}</span></button>
        );

        // --- ABA UNIFICADA DE OPERA√á√ïES ---
        function OperationsView(props) {
            const [subTab, setSubTab] = useState('pos'); // pos, expedition, logistics

            return (
                <div className="flex flex-col h-full bg-white">
                    {/* SUB-NAVEGA√á√ÉO INTERNA */}
                    <div className="flex bg-slate-100 p-2 border-b gap-2 shrink-0 overflow-x-auto scrollbar-thin">
                        <button 
                            onClick={() => setSubTab('pos')}
                            className={`flex items-center gap-2 px-6 py-2 rounded-lg font-bold text-xs uppercase transition shadow-sm ${subTab === 'pos' ? 'bg-slate-900 text-white' : 'bg-white text-slate-500 hover:bg-slate-200'}`}
                        >
                            <ShoppingCart size={16}/> Caixa (PDV)
                        </button>
                        <button 
                            onClick={() => setSubTab('expedition')}
                            className={`flex items-center gap-2 px-6 py-2 rounded-lg font-bold text-xs uppercase transition shadow-sm ${subTab === 'expedition' ? 'bg-slate-900 text-white' : 'bg-white text-slate-500 hover:bg-slate-200'}`}
                        >
                            <Package size={16}/> Expedi√ß√£o
                        </button>
                        <button 
                            onClick={() => setSubTab('logistics')}
                            className={`flex items-center gap-2 px-6 py-2 rounded-lg font-bold text-xs uppercase transition shadow-sm ${subTab === 'logistics' ? 'bg-slate-900 text-white' : 'bg-white text-slate-500 hover:bg-slate-200'}`}
                        >
                            <Truck size={16}/> Log√≠stica
                        </button>
                    </div>

                    {/* CONTE√öDO DIN√ÇMICO */}
                    <div className="flex-1 overflow-hidden">
                        {subTab === 'pos' && <POSView {...props} />}
                        {subTab === 'expedition' && (
                            <ExpeditionView 
                                {...props} 
                                onEditSale={(sale) => { props.setSaleToEdit(sale); setSubTab('pos'); }} 
                            />
                        )}
                        {subTab === 'logistics' && <LogisticsView {...props} />}
                    </div>
                </div>
            );
        }

        // --- POS (PDV Otimizado v7.4) ---
        function POSView({ clients, products, setProducts, sales, setSales, saleToEdit, setSaleToEdit }) {
             const [selectedClient, setSelectedClient] = useState('');
             const [clientSearch, setClientSearch] = useState('');
             const [cart, setCart] = useState([]);
             const [saleRegion, setSaleRegion] = useState('');
             const [isPaid, setIsPaid] = useState(false);
             const [gift, setGift] = useState('Nenhum');
             const [discount, setDiscount] = useState(0);
             const [useCashback, setUseCashback] = useState(false);
             const [cashbackVal, setCashbackVal] = useState(0);
             const [payMethod, setPayMethod] = useState('Pix');
             const [changeFor, setChangeFor] = useState(''); 
             const [obs, setObs] = useState(''); 
             const [searchProd, setSearchProd] = useState('');
             const [selectedCategory, setSelectedCategory] = useState('todas');
             const [editingItem, setEditingItem] = useState(null); 
             const [volumes, setVolumes] = useState(1); 
             const [tempQty, setTempQty] = useState({});
             
             const productSalesCount = useMemo(() => {
                 const counts = {};
                 sales.forEach(s => {
                     s.items.forEach(i => {
                         counts[i.name] = (counts[i.name] || 0) + (i.qty || 1);
                     });
                 });
                 return counts;
             }, [sales]);

             const subTotal = useMemo(() => cart.reduce((acc, item) => acc + Number(item.price), 0), [cart]);
             const totalFinal = Math.max(0, subTotal - discount - (useCashback ? cashbackVal : 0));

             useEffect(() => {
                if (saleToEdit) {
                  const client = clients.find(c => c.id === saleToEdit.clientId);
                  if (client) { setSelectedClient(client.id); setClientSearch(client.name); }
                  setCart(saleToEdit.items.map(i => ({...i, tempId: generateId()})));
                  setObs(saleToEdit.obs); 
                  setPayMethod(saleToEdit.payMethod);
                  if (saleToEdit.changeFor) setChangeFor(saleToEdit.changeFor);
                  setVolumes(saleToEdit.volumes || 1);
                  setSaleRegion(saleToEdit.regionOverride || (client ? client.region : ''));
                  setIsPaid(saleToEdit.isPaid || false);
                  setGift(saleToEdit.gift || 'Nenhum');
                  setDiscount(saleToEdit.discount || 0);
                  if (saleToEdit.cashbackValue > 0) {
                      setUseCashback(true);
                      setCashbackVal(saleToEdit.cashbackValue);
                  }
                  setSaleToEdit(null); 
                }
              }, [saleToEdit, clients]);
    
             const getQty = (id) => tempQty[id] || 1;
             const addToCart = (product) => {
                const qty = getQty(product.id);
                if (!product.isCombo && product.stock < qty) {
                  if (!confirm(`Estoque baixo (${product.stock}). Adicionar ${qty} mesmo assim?`)) return;
                }
                const itemsToAdd = [];
                for(let i=0; i<qty; i++) {
                   const cartItem = { 
                       ...product, tempId: generateId(), originalPrice: product.price,
                       comboItems: product.isCombo ? product.comboItems.map(ci => {
                           const subProd = products.find(p => p.id === ci.id);
                           const subTotalTable = product.comboItems.reduce((acc, item) => {
                               const p = products.find(prod => prod.id === item.id);
                               return acc + ((p?.price || 0) * item.qty);
                           }, 0);
                           const ratio = subTotalTable > 0 ? product.price / subTotalTable : 1;
                           return { ...ci, internalPrice: (subProd?.price || 0) * ratio }; 
                       }) : []
                   };
                   itemsToAdd.push(cartItem);
                }
                setCart([...cart, ...itemsToAdd]);
                setTempQty({...tempQty, [product.id]: 1}); 
             };

             const removeFromCart = (tempId) => {
                 setCart(cart.filter(item => item.tempId !== tempId));
             };

             const handleManualTotalChange = (val) => {
                 const target = parseFloat(val);
                 if (!isNaN(target)) {
                     const currentCb = useCashback ? cashbackVal : 0;
                     const newDiscount = Math.max(0, subTotal - target - currentCb);
                     setDiscount(newDiscount);
                 }
             };

             const handleDiscountChange = (val) => {
                 const d = parseFloat(val);
                 if (!isNaN(d)) setDiscount(d);
             };

             const updateCartItemPrice = () => {
                if (!editingItem) return;
                const newCart = cart.map(i => i.tempId === editingItem.tempId ? { ...i, price: parseFloat(editingItem.price) } : i);
                setCart(newCart);
                setEditingItem(null);
             };

             const updateComboItemQty = (cartItemTempId, subItemId, newQty) => {
                 setCart(cart.map(item => {
                    if (item.tempId !== cartItemTempId) return item;
                    return { ...item, comboItems: item.comboItems.map(sub => sub.id === subItemId ? {...sub, qty: newQty} : sub) };
                 }));
             };

             const handleSelectClient = (c) => {
                 setSelectedClient(c.id);
                 setClientSearch(c.name);
                 setSaleRegion(c.region || ''); 
             };

             const finalizeSale = () => {
                if (!selectedClient) return alert('Selecione um cliente');
                if (cart.length === 0) return alert('Carrinho vazio');
                
                const newProducts = [...products];
                cart.forEach(cartItem => {
                  const dbProd = newProducts.find(p => p.id === cartItem.id);
                  if (dbProd) {
                    if (dbProd.isCombo) {
                      cartItem.comboItems?.forEach(ing => {
                         const dbIng = newProducts.find(p => p.id === ing.id);
                         if (dbIng) {
                           dbIng.stock = Math.max(0, dbIng.stock - ing.qty);
                           dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'SALE_COMBO', qty: ing.qty, ref: cartItem.name });
                         }
                      });
                    } else {
                      dbProd.stock = Number(dbProd.stock) - 1;
                      dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'SALE', qty: 1 });
                    }
                  }
                });
                
                setProducts(newProducts);
                const shortId = generateDailyId(sales);
                const newSale = {
                  id: shortId, fullId: generateId(), clientId: selectedClient, items: cart,
                  subTotal: subTotal, 
                  discount: discount,
                  total: totalFinal, 
                  payMethod, changeFor: payMethod === 'Dinheiro' ? changeFor : null, obs,
                  date: new Date().toISOString(), status: 'Pendente', printedLabel: false, printedList: false, volumes: volumes, routeId: null,
                  regionOverride: saleRegion, 
                  gift: gift,
                  isPaid: isPaid,
                  cashbackValue: useCashback ? cashbackVal : 0
                };
                setSales([...sales, newSale]);
                setCart([]); setSelectedClient(''); setClientSearch(''); setObs(''); setChangeFor(''); setVolumes(1); 
                setSaleRegion(''); setIsPaid(false); setGift('Nenhum'); setDiscount(0); setUseCashback(false); setCashbackVal(0);
                alert(`Venda #${shortId} Realizada!`);
             };

             const sortedProducts = useMemo(() => {
                 return [...products].sort((a, b) => {
                     const soldA = productSalesCount[a.name] || 0;
                     const soldB = productSalesCount[b.name] || 0;
                     if (soldB !== soldA) return soldB - soldA; 
                     return a.name.localeCompare(b.name);
                 });
             }, [products, productSalesCount]);

             const filteredProducts = sortedProducts.filter(p => (selectedCategory === 'todas' || p.category === selectedCategory) && p.name.toLowerCase().includes(searchProd.toLowerCase()));
             const filteredClients = clients.filter(c => c.name.toLowerCase().includes(clientSearch.toLowerCase()));
             const categories = ['todas', ...new Set(products.map(p => p.category))];

             return (
                <div className="flex flex-col lg:flex-row min-h-full">
                    <div className="flex-1 flex flex-col lg:border-r bg-white p-4 h-[500px] lg:h-auto overflow-hidden">
                        <div className="flex gap-2 lg:gap-4 mb-4 shrink-0">
                            <div className="relative flex-1">
                                <Search className="absolute left-3 top-2.5 text-gray-400" size={20}/><input className="w-full pl-10 pr-4 py-2 border rounded-lg bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" placeholder="Buscar produto..." value={searchProd} onChange={e => setSearchProd(e.target.value)} />
                            </div>
                            <select className="border rounded-lg px-2 lg:px-4 bg-white outline-none focus:border-blue-500 max-w-[100px] lg:max-w-none" value={selectedCategory} onChange={e => setSelectedCategory(e.target.value)}><option value="todas">Todas</option>{categories.filter(c=>c!=='todas').map(c => <option key={c} value={c}>{c}</option>)}</select>
                        </div>
                        <div className="flex-1 overflow-y-auto scrollbar-thin border rounded-lg">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-100 text-gray-600 text-xs uppercase sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th className="p-2 border-b">Produto</th>
                                        <th className="p-2 border-b text-center hidden sm:table-cell">Categ</th>
                                        <th className="p-2 border-b text-center">Est</th>
                                        <th className="p-2 border-b text-right">Pre√ßo</th>
                                        <th className="p-2 border-b text-center">Add</th>
                                    </tr>
                                </thead>
                                <tbody className="text-sm divide-y divide-gray-100">
                                    {filteredProducts.map(p => (
                                        <tr key={p.id} className="hover:bg-gray-50 cursor-pointer group" onClick={() => addToCart(p)}>
                                            <td className="p-2">
                                                <div className="font-bold text-gray-800 leading-tight">{p.name}</div>
                                                <div className="text-[10px] text-gray-500 flex gap-2 items-center mt-0.5">
                                                    {productSalesCount[p.name] > 0 && <span className="bg-orange-100 text-orange-800 px-1 rounded font-bold text-[9px] flex items-center">üî• {productSalesCount[p.name]}</span>}
                                                    {p.internalCode && <span>C√≥d: {p.internalCode}</span>}
                                                    {p.isCombo && <span className="bg-yellow-100 text-yellow-800 px-1 rounded font-bold text-[9px]">COMBO</span>}
                                                </div>
                                            </td>
                                            <td className="p-2 text-center hidden sm:table-cell"><span className="text-[10px] bg-gray-100 px-1.5 rounded text-gray-600">{p.category}</span></td>
                                            <td className="p-2 text-center font-bold text-xs"><span className={p.stock < 5 ? 'text-red-600' : 'text-green-600'}>{p.stock}</span></td>
                                            <td className="p-2 text-right font-bold text-emerald-600">{formatCurrency(p.price)}</td>
                                            <td className="p-2 text-center"><button className="bg-blue-600 hover:bg-blue-700 text-white p-1 rounded transition shadow-sm"><Plus size={16}/></button></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div className="w-full lg:w-[420px] flex flex-col bg-gray-50 border-t lg:border-t-0 lg:border-l shadow-xl z-20 shrink-0">
                        <div className="p-4 bg-white border-b space-y-3">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Cliente</label>
                                <div className="relative">
                                    <input className={`w-full p-3 border rounded-lg outline-none transition ${selectedClient ? 'bg-green-50 border-green-500 text-green-800 font-bold' : 'bg-white focus:border-blue-500'}`} placeholder="Buscar Cliente..." value={clientSearch} onChange={e => { setClientSearch(e.target.value); setSelectedClient(''); }} />
                                    {clientSearch && !selectedClient && (<div className="absolute top-full left-0 w-full bg-white border shadow-xl max-h-60 overflow-y-auto z-50 rounded-b-lg">{filteredClients.map(c => (<div key={c.id} className="p-3 hover:bg-blue-50 cursor-pointer border-b flex justify-between items-center" onClick={() => handleSelectClient(c)}><div><div className="font-bold text-sm">{c.name}</div><div className="text-xs text-gray-500">{c.district}</div></div></div>))}</div>)}
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Rota / Regi√£o (Edit√°vel)</label>
                                <select className="w-full border rounded p-2 text-sm bg-gray-50 outline-none focus:bg-white focus:border-blue-500" value={saleRegion} onChange={e => setSaleRegion(e.target.value)}>
                                    <option value="">Selecione...</option>
                                    <option value="CUIAB√Å">CUIAB√Å (Centro)</option>
                                    <option value="COXIPO">COXIPO</option>
                                    <option value="VARZEA GRANDE">VARZEA GRANDE</option>
                                    <option value="CPA">CPA</option>
                                    {!['CUIAB√Å', 'COXIPO', 'VARZEA GRANDE', 'CPA', ''].includes(saleRegion) && <option value={saleRegion}>{saleRegion}</option>}
                                </select>
                            </div>
                        </div>

                        <div className="p-4 space-y-2 overflow-y-auto scrollbar-thin max-h-[300px] lg:max-h-none flex-1">
                            {cart.length === 0 && (<div className="h-32 flex flex-col items-center justify-center text-gray-400 opacity-60"><ShoppingCart size={48} className="mb-2"/><p>Carrinho Vazio</p></div>)}
                            {cart.map(item => (
                                <div key={item.tempId} className="bg-white p-3 rounded-lg border shadow-sm relative group">
                                    <div className="flex justify-between items-start mb-1"><div className="font-bold text-sm text-gray-800 pr-6">{item.name}</div><button onClick={() => removeFromCart(item.tempId)} className="text-gray-300 hover:text-red-500 absolute top-2 right-2"><XCircle size={16}/></button></div>
                                    <div className="flex justify-between items-center"><button onClick={() => setEditingItem({tempId: item.tempId, price: item.price})} className="text-sm font-bold text-green-700 hover:underline">{formatCurrency(item.price)}</button><div className="text-xs text-gray-400">Unit√°rio</div></div>
                                    {item.isCombo && (<div className="mt-2 bg-yellow-50 p-2 rounded border border-yellow-100">{item.comboItems.map(ci => (<div key={ci.id} className="flex justify-between items-center text-xs py-1 border-b border-yellow-100 last:border-0"><span className="text-gray-600 truncate max-w-[150px]">{products.find(p => p.id === ci.id)?.name || 'Item'}</span><div className="flex items-center bg-white border rounded"><button className="px-1.5 hover:bg-gray-100" onClick={() => updateComboItemQty(item.tempId, ci.id, Math.max(0, ci.qty - 1))}>-</button><span className="w-5 text-center font-bold">{ci.qty}</span><button className="px-1.5 hover:bg-gray-100" onClick={() => updateComboItemQty(item.tempId, ci.id, ci.qty + 1)}>+</button></div></div>))}</div>)}
                                </div>
                            ))}
                        </div>

                        <div className="bg-white border-t p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] pb-4">
                            <div className="flex justify-between items-end mb-2">
                                <div><label className="text-[10px] font-bold text-gray-400 uppercase">Subtotal</label><div className="text-sm text-gray-600">{formatCurrency(subTotal)}</div></div>
                                <div><label className="text-[10px] font-bold text-gray-400 uppercase">Desconto (R$)</label><input type="number" className="w-24 border-b border-gray-300 text-right text-sm outline-none focus:border-red-500 text-red-500 p-1" value={discount} onChange={e => handleDiscountChange(e.target.value)} /></div>
                            </div>
                            <div className="flex items-center justify-between mb-2 p-2 bg-pink-50 rounded border border-pink-100">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" checked={useCashback} onChange={e => setUseCashback(e.target.checked)} className="w-4 h-4 text-pink-600 rounded focus:ring-pink-500" />
                                    <span className="text-xs font-bold text-pink-800 flex items-center gap-1"><Wallet size={12}/> CASHBACK</span>
                                </label>
                                {useCashback && (
                                    <input type="number" className="w-20 border-b border-pink-300 text-right text-sm outline-none bg-transparent font-bold text-pink-700" placeholder="R$ 0,00" value={cashbackVal} onChange={e => setCashbackVal(parseFloat(e.target.value) || 0)} />
                                )}
                            </div>
                            <div className="flex justify-between items-center mb-4 pt-2 border-t">
                                <span className="text-gray-500 font-bold uppercase text-xs">Total Final</span>
                                <input className="font-bold text-2xl text-right w-32 border-b-2 border-emerald-500 focus:outline-none text-emerald-600 bg-transparent" value={totalFinal.toFixed(2)} onChange={(e) => handleManualTotalChange(e.target.value)} />
                            </div>
                            <div className="grid grid-cols-2 gap-3 mb-2">
                                <div><label className="text-[10px] font-bold text-gray-400 uppercase">Pagamento</label><select className="w-full border rounded p-2 text-sm bg-gray-50 outline-none" value={payMethod} onChange={e => setPayMethod(e.target.value)}><option value="Pix">Pix</option><option value="Dinheiro">Dinheiro</option><option value="Cart√£o">Cart√£o</option></select></div>
                                <div><label className="text-[10px] font-bold text-gray-400 uppercase">Brinde</label><select className="w-full border rounded p-2 text-sm bg-gray-50 outline-none" value={gift} onChange={e => setGift(e.target.value)}><option value="Nenhum">Nenhum</option><option value="Amaciante">Amaciante</option><option value="Caf√©">Caf√©</option><option value="Ovo">Ovo</option></select></div>
                            </div>
                            {(payMethod === 'Pix' || payMethod === 'Cart√£o') && (
                                <label className="flex items-center gap-2 mb-3 bg-green-50 p-3 rounded border border-green-100 cursor-pointer">
                                    <input type="checkbox" checked={isPaid} onChange={e => setIsPaid(e.target.checked)} className="w-5 h-5 text-green-600 rounded focus:ring-green-500" />
                                    <span className="text-xs font-bold text-green-800">PEDIDO PAGO (S√ì ENTREGAR)</span>
                                </label>
                            )}
                            {payMethod === 'Dinheiro' && (<div className="mb-4"><label className="text-[10px] font-bold text-gray-400 uppercase">Troco Para</label><input className="w-full border rounded p-2 text-sm bg-gray-50 outline-none" type="number" placeholder="R$ 0,00" value={changeFor} onChange={e => setChangeFor(e.target.value)} /></div>)}
                            <div className="mb-4"><label className="text-[10px] font-bold text-gray-400 uppercase">Volumes</label><select className="w-full border rounded p-2 text-sm bg-gray-50 outline-none" value={volumes} onChange={e => setVolumes(e.target.value)}>{[1,2,3,4,5,6,7,8,9,10].map(n => <option key={n} value={n}>{n}</option>)}</select></div>
                            <input className="w-full border rounded p-2 text-sm bg-gray-50 outline-none mb-4" placeholder="Observa√ß√µes..." value={obs} onChange={e => setObs(e.target.value)} />
                            <button onClick={finalizeSale} className="w-full bg-slate-900 text-white font-bold py-4 rounded-xl hover:bg-slate-800 transition shadow-lg flex justify-between items-center px-6 text-lg"><span>FINALIZAR</span><span className="text-emerald-400">{formatCurrency(totalFinal)}</span></button>
                        </div>
                    </div>
                    {editingItem && (<div className="absolute inset-0 bg-black/50 z-50 flex flex-col items-center justify-center p-4"><div className="bg-white p-6 rounded-xl shadow-2xl flex flex-col gap-4 w-72"><h3 className="text-sm font-bold text-center">Ajustar Pre√ßo</h3><input type="number" autoFocus className="text-3xl font-bold text-center border-b-2 border-blue-500 outline-none pb-2 w-full" value={editingItem.price} onChange={e => setEditingItem({...editingItem, price: e.target.value})}/><div className="flex gap-2"><button onClick={() => setEditingItem(null)} className="flex-1 bg-gray-100 py-2 rounded font-bold text-gray-500">Cancelar</button><button onClick={updateCartItemPrice} className="flex-1 bg-blue-600 text-white py-2 rounded font-bold">Salvar</button></div></div></div>)}
                </div>
             );
        }

        // --- EXPEDITION ---
        function ExpeditionView({ sales, setSales, clients, products, setProducts, onEditSale }) {
            const updateStatus = (saleId, newStatus) => setSales(sales.map(s => s.id === saleId ? { ...s, status: newStatus } : s));
            const returnStock = (sale) => {
                 const newProducts = [...products];
                 sale.items.forEach(item => {
                  const dbProd = newProducts.find(p => p.id === item.id);
                  if (dbProd) {
                    if (dbProd.isCombo) { item.comboItems?.forEach(ing => { const dbIng = newProducts.find(p => p.id === ing.id); if (dbIng) { dbIng.stock += ing.qty; dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: ing.qty }); } }); } 
                    else { dbProd.stock += 1; dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: 1 }); }
                  }
                 });
                 setProducts(newProducts);
            }
            const deleteSale = (sale) => { if (!confirm(`Excluir permanentemente a venda #${sale.id}?`)) return; returnStock(sale); setSales(sales.filter(s => s.id !== sale.id)); };
            const handleEdit = (sale) => { if(!confirm("Editar venda? Itens voltar√£o ao carrinho.")) return; returnStock(sale); setSales(sales.filter(s => s.id !== sale.id)); onEditSale(sale); };
            const printLabel = (sale, client) => {
                const volCount = sale.volumes || 1; let labelsHtml = '';
                const regionDisplay = sale.regionOverride || client.region || 'GERAL';
                for (let i = 1; i <= volCount; i++) { labelsHtml += `<div class="label" style="border:1px solid #000; width:300px; height:400px; padding:10px; margin-bottom:10px; page-break-after:always;"><h1 style="font-size:40px;margin:0;">#${sale.id}</h1><h2 style="margin:5px 0;">${regionDisplay}</h2><p style="font-size:18px;"><strong>${client.name}</strong><br/>${client.district}</p><p>Vol: ${i}/${volCount}</p><p style="font-size:12px;">Obs: ${sale.obs || '-'}</p></div>`; }
                const w = window.open('', '', 'width=400,height=500'); w.document.write(`<html><body>${labelsHtml}<script>window.onload=function(){window.print();}<\/script></body></html>`); w.document.close();
            };
            const printPickingList = (sale, client) => {
                 let itemsHtml = '';
                 sale.items.forEach(item => { if (item.isCombo) { itemsHtml += `<strong>${item.name}</strong><br/>`; item.comboItems.forEach(ci => { if(ci.qty>0) itemsHtml += ` - ${ci.qty}x ${products.find(p=>p.id===ci.id)?.name}<br/>`; }); } else { itemsHtml += `[ ] 1x ${item.name}<br/>`; } });
                 const w = window.open('', '', 'width=400,height=600'); w.document.write(`<html><body style="font-family:sans-serif; padding:20px;"><h2>SEPARA√á√ÉO #${sale.id}</h2><h3>${client.name}</h3><hr/>${itemsHtml}<hr/><p>Obs: ${sale.obs||''}</p><script>window.onload=function(){window.print();}<\/script></body></html>`); w.document.close();
            };
            const activeSales = sales.filter(s => s.status !== 'Entregue').sort((a,b) => new Date(a.date) - new Date(b.date));
            const KanbanColumn = ({ title, status, color, children }) => (<div className="flex flex-col h-full min-w-[300px] flex-1 bg-gray-100 rounded-xl overflow-hidden border border-gray-200"><div className={`p-3 font-bold text-sm uppercase text-${color}-800 bg-${color}-100 border-b border-${color}-200 flex justify-between`}>{title}<span className="bg-white px-2 rounded-full text-xs flex items-center">{children.length}</span></div><div className="flex-1 overflow-y-auto p-3 space-y-3 scrollbar-thin">{children}</div></div>);
            const ActionButtons = ({ sale, showEdit }) => (
                <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition absolute top-4 right-4 bg-white/90 rounded shadow-sm">
                    {showEdit && <button onClick={() => handleEdit(sale)} className="p-1.5 hover:bg-blue-50 text-blue-500 rounded"><Edit2 size={16}/></button>}
                    <button onClick={() => deleteSale(sale)} className="p-1.5 hover:bg-red-50 text-red-500 rounded"><Trash2 size={16}/></button>
                </div>
            );
            return (
                <div className="p-4 lg:p-6 h-full overflow-x-auto"><div className="flex flex-col md:flex-row gap-6 h-full min-w-full md:min-w-0">
                    <KanbanColumn title="Pendente" status="Pendente" color="orange">
                        {activeSales.filter(s => s.status === 'Pendente').map(s => (
                            <div key={s.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition group relative">
                                <div className="flex justify-between items-start mb-2"><span className="font-bold text-lg text-slate-700">#{s.id}</span></div>
                                <ActionButtons sale={s} showEdit={true} />
                                <div className="font-bold text-sm mb-1">{clients.find(c=>c.id===s.clientId)?.name}</div>
                                <div className="flex gap-2 mb-3"><button onClick={() => printLabel(s, clients.find(c=>c.id===s.clientId))} className="flex-1 border rounded py-1 text-xs">Etiqueta</button><button onClick={() => printPickingList(s, clients.find(c=>c.id===s.clientId))} className="flex-1 border rounded py-1 text-xs">Lista</button></div>
                                <button onClick={() => updateStatus(s.id, 'Montagem')} className="w-full bg-orange-500 text-white font-bold py-2 rounded text-xs">INICIAR MONTAGEM</button>
                            </div>
                        ))}
                    </KanbanColumn>
                    <KanbanColumn title="Em Montagem" status="Montagem" color="blue">
                        {activeSales.filter(s => s.status === 'Montagem').map(s => (
                            <div key={s.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition group relative">
                                <div className="flex justify-between items-start mb-2"><span className="font-bold text-lg text-slate-700">#{s.id}</span></div>
                                <ActionButtons sale={s} showEdit={false} />
                                <div className="font-bold text-sm mb-1">{clients.find(c=>c.id===s.clientId)?.name}</div>
                                <button onClick={() => updateStatus(s.id, 'Rota')} className="w-full bg-blue-500 text-white font-bold py-2 rounded text-xs mt-4">PRONTO PARA ROTA</button>
                            </div>
                        ))}
                    </KanbanColumn>
                    <KanbanColumn title="Pronto p/ Rota" status="Rota" color="green">
                        {activeSales.filter(s => s.status === 'Rota').map(s => (
                            <div key={s.id} className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition group relative">
                                <div className="flex justify-between items-start mb-2"><span className="font-bold text-lg text-slate-700">#{s.id}</span></div>
                                <ActionButtons sale={s} showEdit={false} />
                                <div className="font-bold text-sm mb-1">{clients.find(c=>c.id===s.clientId)?.name}</div>
                                <div className="text-center text-xs font-bold text-green-600 bg-green-50 py-2 rounded border border-green-100 mt-4">AGUARDANDO ENTREGA</div>
                            </div>
                        ))}
                    </KanbanColumn>
                </div></div>
            );
        }

        // --- LOGISTICS ---
        function LogisticsView({ sales, setSales, clients, companyPhone, products, setProducts }) {
            const [selectedRoute, setSelectedRoute] = useState('Todas');
            const [routeSales, setRouteSales] = useState([]); 
            const [showImport, setShowImport] = useState(false);
            const [importText, setImportText] = useState('');
            useEffect(() => { 
                const ready = sales.filter(s => s.status === 'Rota'); 
                const filtered = selectedRoute === 'Todas' ? ready : ready.filter(s => { 
                    if (s.regionOverride) return s.regionOverride === selectedRoute;
                    const c = clients.find(cl => cl.id === s.clientId); 
                    const region = c?.region || c?.route; 
                    return region === selectedRoute; 
                }); 
                setRouteSales(filtered); 
            }, [sales, selectedRoute, clients]);
            const routes = [...new Set(clients.map(c => c.region || c.route).filter(Boolean))];
            const moveOrder = (index, direction) => { const newOrder = [...routeSales]; if (direction === 'up' && index > 0) { [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]]; } else if (direction === 'down' && index < newOrder.length - 1) { [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]]; } setRouteSales(newOrder); };
            const generateDriverLink = () => { 
                if (routeSales.length === 0) return alert("Nada para entregar!"); 
                const payload = { 
                    route: selectedRoute, companyPhone, generatedAt: new Date(), 
                    orders: routeSales.map(s => { 
                        const c = clients.find(cl => cl.id === s.clientId); 
                        let finalPay = s.payMethod;
                        if (s.isPaid) finalPay += " (J√Å PAGO)";
                        return { 
                            id: s.id, customer: c.name, phone: c.phone, phone2: c.phone2, 
                            address: c.address, district: c.district, region: s.regionOverride || c.region, map: c.mapLink, 
                            total: s.total, pay: finalPay, change: s.changeFor ? s.changeFor - s.total : 0, 
                            obs: s.obs, clientObs: c.obs, isPaid: s.isPaid, gift: s.gift
                        }; 
                    }) 
                }; 
                const encoded = encodeURIComponent(btoa(JSON.stringify(payload))); 
                const link = `${window.location.origin}${window.location.pathname}#driver=${encoded}`; 
                const copyToClipboardFallback = (text) => { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); alert("LINK COPIADO!"); } catch (err) { prompt("Copie:", text); } document.body.removeChild(textArea); }; 
                if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(link).then(() => alert("LINK COPIADO!")).catch(() => copyToClipboardFallback(link)); } else { copyToClipboardFallback(link); } 
            };
            const forceDelivery = (id) => { if (confirm("Marcar entregue?")) setSales(sales.map(s => s.id === id ? { ...s, status: 'Entregue' } : s)); };
            const totalValue = routeSales.reduce((acc, s) => acc + s.total, 0);
            const processReturnReport = () => {
                const lines = importText.split('\n');
                let updatedCount = 0;
                let newSales = [...sales];
                let newProducts = [...products];
                lines.forEach(line => {
                    const idMatch = line.match(/ID:\s*#?(\S+)/);
                    const statusMatch = line.match(/STATUS:\s*(\w+)/);
                    const payMatch = line.match(/PGTO:\s*([A-Za-z√Ä-√∫\s]+)/);
                    if (idMatch && statusMatch) {
                        const id = idMatch[1];
                        const status = statusMatch[1].toUpperCase() === 'ENTREGUE' ? 'Entregue' : 
                                       statusMatch[1].toUpperCase() === 'CANCELADO' ? 'Cancelado' : null;
                        const payMethod = payMatch ? payMatch[1].trim() : null;
                        if (status) {
                            const saleIndex = newSales.findIndex(s => s.id === id);
                            if (saleIndex > -1) {
                                const sale = newSales[saleIndex];
                                if (status === 'Cancelado' && sale.status !== 'Cancelado') {
                                     sale.items.forEach(item => {
                                        const dbProd = newProducts.find(p => p.id === item.id);
                                        if (dbProd) {
                                            if (dbProd.isCombo) { 
                                                item.comboItems?.forEach(ing => { 
                                                    const dbIng = newProducts.find(p => p.id === ing.id); 
                                                    if (dbIng) { dbIng.stock += ing.qty; dbIng.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: ing.qty }); } 
                                                }); 
                                            } else { dbProd.stock += 1; dbProd.stockHistory.push({ date: new Date().toISOString(), type: 'CANCEL_RETURN', qty: 1 }); }
                                        }
                                     });
                                }
                                newSales[saleIndex] = { ...sale, status, payMethod: payMethod || sale.payMethod };
                                updatedCount++;
                            }
                        }
                    }
                });
                if (updatedCount > 0) {
                    setSales(newSales); setProducts(newProducts); setImportText(''); setShowImport(false); alert(`${updatedCount} pedidos atualizados com sucesso!`);
                } else { alert("Nenhum pedido processado. Verifique o formato."); }
            };
            return (
                <div className="p-4 lg:p-6 h-full flex flex-col">
                    <div className="bg-white p-4 rounded-xl shadow-sm border mb-4 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div className="flex gap-4 items-center w-full md:w-auto">
                            <span className="font-bold text-gray-500 uppercase text-xs shrink-0">Regi√£o:</span>
                            <select className="border rounded-lg p-2 bg-gray-50 outline-none w-full md:w-auto" value={selectedRoute} onChange={e => setSelectedRoute(e.target.value)}><option value="Todas">Todas</option>{routes.map(r => <option key={r} value={r}>{r}</option>)}</select>
                        </div>
                        <div className="flex items-center gap-4 w-full md:w-auto justify-between">
                            <div className="text-right"><div className="text-xs text-gray-400 font-bold uppercase">Total da Rota</div><div className="text-2xl font-bold text-green-700">{formatCurrency(totalValue)}</div></div>
                            <button onClick={() => setShowImport(true)} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 flex items-center gap-2"><Upload size={16}/> PROCESSAR RETORNO</button>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col flex-1">
                        <div className="p-3 bg-indigo-50 border-b border-indigo-100 flex justify-between items-center shrink-0"><span className="font-bold text-indigo-900 text-sm flex items-center gap-2"><Truck size={16}/> {routeSales.length} Entregas Pendentes</span><button onClick={generateDriverLink} className="bg-indigo-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-700 transition">GERAR LINK MOTORISTA</button></div>
                        <div className="overflow-y-auto p-2 space-y-2 bg-gray-50 flex-1">{routeSales.map((s, idx) => { const client = clients.find(c => c.id === s.clientId) || {}; return (<div key={s.id} className="bg-white p-3 rounded-lg border shadow-sm flex gap-4 items-center"><div className="flex flex-col gap-1"><button onClick={() => moveOrder(idx, 'up')} className="p-1 hover:bg-gray-100 rounded"><ArrowUp size={14} className="text-gray-400"/></button><span className="font-bold text-sm text-center text-indigo-600 w-6">{idx + 1}</span><button onClick={() => moveOrder(idx, 'down')} className="p-1 hover:bg-gray-100 rounded"><ArrowDown size={14} className="text-gray-400"/></button></div><div className="flex-1"><div className="flex justify-between"><h4 className="font-bold text-gray-800">{client.name}</h4><span className="font-mono text-xs bg-gray-100 px-2 rounded text-gray-500">#{s.id}</span></div><p className="text-sm text-gray-500">{client.address}, {client.district}</p><div className="flex flex-wrap gap-2 mt-2 text-xs"><span className="bg-blue-50 text-blue-700 px-2 py-0.5 rounded font-medium">{s.payMethod}{s.isPaid ? ' (PAGO)' : ''}</span><span className="bg-green-50 text-green-700 px-2 py-0.5 rounded font-bold">{formatCurrency(s.total)}</span>{s.gift && s.gift !== 'Nenhum' && <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold flex items-center gap-1"><Gift size={10}/> {s.gift}</span>}</div></div><button onClick={() => forceDelivery(s.id)} className="p-3 hover:bg-green-50 text-gray-300 hover:text-green-600 rounded-full transition"><CheckCircle size={24}/></button></div>); })}</div>
                    </div>
                    {showImport && (<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-lg rounded-xl p-6 shadow-2xl"><h3 className="text-lg font-bold mb-4">Processar Retorno do Motorista</h3><p className="text-xs text-gray-500 mb-2">Cole aqui o relat√≥rio enviado pelo motorista no WhatsApp.</p><textarea className="w-full h-48 border rounded p-2 text-xs font-mono mb-4 bg-gray-50" placeholder="Cole o relat√≥rio aqui..." value={importText} onChange={e => setImportText(e.target.value)} /><div className="flex gap-2"><button onClick={() => setShowImport(false)} className="flex-1 bg-gray-200 py-2 rounded font-bold text-gray-600">Cancelar</button><button onClick={processReturnReport} className="flex-1 bg-green-600 hover:bg-green-700 py-2 rounded font-bold text-white">PROCESSAR BAIXA</button></div></div></div>)}
                </div>
            );
        }

        // --- REGISTRY ---
        function RegistryView({ clients, setClients, products, setProducts }) {
            const [tab, setTab] = useState('clients');
            const [cForm, setCForm] = useState({ name: '', code: '', phone: '', phone2: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' });
            const [pForm, setPForm] = useState({ name: '', internalCode: '', category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
            const [editingClientId, setEditingClientId] = useState(null);
            const [editingProductId, setEditingProductId] = useState(null);
            const [search, setSearch] = useState('');
            const registryStats = useMemo(() => {
                const uniqueProducts = products.length;
                let totalStockValue = 0;
                const combosPotential = [];
                products.forEach(p => {
                    totalStockValue += (Number(p.cost) || 0) * (Number(p.stock) || 0);
                    if (p.isCombo && p.comboItems && p.comboItems.length > 0) {
                        let maxPossible = Infinity;
                        p.comboItems.forEach(item => {
                            const ingredient = products.find(prod => prod.id === item.id);
                            if (ingredient && item.qty > 0) {
                                const possibleWithThisIngredient = Math.floor((ingredient.stock || 0) / item.qty);
                                if (possibleWithThisIngredient < maxPossible) maxPossible = possibleWithThisIngredient;
                            } else { maxPossible = 0; }
                        });
                        if (maxPossible === Infinity) maxPossible = 0;
                        combosPotential.push({ name: p.name, qty: maxPossible });
                    }
                });
                return { uniqueProducts, totalStockValue, combosPotential };
            }, [products]);
            const getNextProductCode = () => {
                const codes = products.map(p => parseInt(p.internalCode)).filter(n => !isNaN(n));
                const max = codes.length > 0 ? Math.max(...codes) : 0;
                return (max + 1).toString();
            };
            const saveClient = () => { 
                if (!cForm.name) return alert('Nome obrigat√≥rio'); 
                if (editingClientId) { 
                    setClients(clients.map(c => c.id === editingClientId ? { ...cForm, id: editingClientId, code: c.code || cForm.code } : c)); 
                    setEditingClientId(null); 
                    alert('Atualizado!'); 
                } else { 
                    const newCode = generateClientCode(clients); 
                    setClients([...clients, { ...cForm, id: generateId(), code: newCode }]); 
                    alert(`Criado: ${newCode}`); 
                } 
                setCForm({ name: '', code: '', phone: '', phone2: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' }); 
            };
            const saveProduct = () => { 
                if (!pForm.name) return alert('Nome obrigat√≥rio');
                const cost = Number(pForm.cost) || 0;
                const price = Number(pForm.price) || 0;
                let margin = 0;
                if (price > 0) margin = ((price - cost) / price) * 100;
                if (margin < 20) return alert(`ERRO: Margem de lucro muito baixa (${margin.toFixed(1)}%).\nO sistema exige no m√≠nimo 20%.`);
                if (editingProductId) { 
                    setProducts(products.map(p => p.id === editingProductId ? { ...pForm, id: editingProductId, stock: p.stock, stockHistory: p.stockHistory } : p)); 
                    setEditingProductId(null); 
                    alert('Atualizado!'); 
                } else { 
                    const newProd = { ...pForm, id: generateId(), stockHistory: [{ date: new Date().toISOString(), type: 'INITIAL', qty: Number(pForm.stock) }] }; 
                    setProducts([...products, newProd]); 
                    alert('Criado!'); 
                } 
                setPForm({ name: '', internalCode: getNextProductCode(), category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] }); 
            };
            const deleteItem = () => {
                if(tab === 'clients') {
                    if(!editingClientId) return;
                    if(!confirm("TEM CERTEZA?")) return;
                    setClients(clients.filter(c => c.id !== editingClientId));
                    setEditingClientId(null);
                    setCForm({ name: '', code: '', phone: '', phone2: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' });
                } else {
                    if(!editingProductId) return;
                    if(!confirm("TEM CERTEZA?")) return;
                    setProducts(products.filter(p => p.id !== editingProductId));
                    setEditingProductId(null);
                    setPForm({ name: '', internalCode: getNextProductCode(), category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] });
                }
            };
            const list = tab === 'clients' 
                ? clients.filter(c => c.name.toLowerCase().includes(search.toLowerCase()) || (c.code && c.code.includes(search)) || (c.phone && c.phone.includes(search))).sort((a,b) => a.name.localeCompare(b.name)) 
                : products.filter(p => p.name.toLowerCase().includes(search.toLowerCase())).sort((a,b) => a.name.localeCompare(b.name));
            return (
                <div className="flex flex-col lg:flex-row h-full pb-20 lg:pb-0">
                    <div className="flex-1 border-r bg-white flex flex-col overflow-hidden order-2 lg:order-1">
                        <div className="p-4 border-b shrink-0 bg-gray-50/50">
                            <div className="flex bg-gray-200 p-1 rounded-lg mb-3 w-full max-w-sm">
                                <button onClick={() => setTab('clients')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${tab === 'clients' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>CLIENTES</button>
                                <button onClick={() => setTab('products')} className={`flex-1 py-1.5 text-xs font-bold rounded-md transition ${tab === 'products' ? 'bg-white shadow text-blue-600' : 'text-gray-500'}`}>PRODUTOS</button>
                            </div>
                            <div className="relative">
                                <Search className="absolute left-3 top-2.5 text-gray-400" size={18}/><input className="w-full pl-10 pr-4 py-2 border rounded-lg text-sm outline-none focus:border-blue-500 transition" placeholder={`Buscar...`} value={search} onChange={e => setSearch(e.target.value)} />
                            </div>
                        </div>
                        <div className="flex-1 overflow-auto scrollbar-thin">
                            {tab === 'products' ? (
                                <table className="w-full text-left border-collapse text-xs sm:text-sm">
                                    <thead className="bg-gray-100 text-gray-600 sticky top-0 z-10 font-bold uppercase shadow-sm">
                                        <tr>
                                            <th className="p-3 border-b">Nome</th>
                                            <th className="p-3 border-b text-center">C√≥d</th>
                                            <th className="p-3 border-b text-right">Venda</th>
                                            <th className="p-3 border-b text-center">Est</th>
                                            <th className="p-3 border-b text-right bg-gray-200">V. Estoque</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {list.map(p => {
                                            const totalStockVal = (p.cost || 0) * (p.stock || 0);
                                            const isSelected = editingProductId === p.id;
                                            return (
                                                <tr key={p.id} onClick={() => { setPForm(p); setEditingProductId(p.id); }} className={`hover:bg-blue-50 cursor-pointer transition ${isSelected ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`}>
                                                    <td className="p-3 font-medium text-gray-800">{p.name} {p.isCombo && <span className="bg-yellow-100 text-yellow-800 px-1 rounded text-[9px]">KIT</span>}</td>
                                                    <td className="p-3 text-center text-gray-500">{p.internalCode || '-'}</td>
                                                    <td className="p-3 text-right font-bold text-emerald-600">{formatCurrency(p.price)}</td>
                                                    <td className="p-3 text-center font-bold">{p.stock}</td>
                                                    <td className="p-3 text-right font-mono text-slate-600 bg-gray-50">{formatCurrency(totalStockVal)}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            ) : (
                                <table className="w-full text-left border-collapse text-xs sm:text-sm">
                                    <thead className="bg-gray-100 text-gray-600 sticky top-0 z-10 font-bold uppercase shadow-sm">
                                        <tr>
                                            <th className="p-3 border-b">Nome</th>
                                            <th className="p-3 border-b">Bairro</th>
                                            <th className="p-3 border-b text-center">Contato</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {list.map(c => {
                                            const isSelected = editingClientId === c.id;
                                            return (
                                                <tr key={c.id} onClick={() => { setCForm(c); setEditingClientId(c.id); }} className={`hover:bg-blue-50 cursor-pointer transition ${isSelected ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`}>
                                                    <td className="p-3 font-medium text-gray-800">{c.name}</td>
                                                    <td className="p-3 text-gray-500">{c.district}</td>
                                                    <td className="p-3 text-center">
                                                        <div className="flex justify-center gap-2" onClick={(e) => e.stopPropagation()}>
                                                            <button onClick={() => window.open(`https://wa.me/55${c.phone?.replace(/\D/g, '')}`, '_blank')} className="p-1.5 bg-green-100 text-green-600 rounded hover:bg-green-200"><MessageCircle size={16}/></button>
                                                            <button onClick={() => window.open(`tel:${c.phone}`, '_self')} className="p-1.5 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"><Phone size={16}/></button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    </div>
                    <div className="w-full lg:w-[380px] bg-gray-50 border-l shadow-xl z-20 flex flex-col order-1 lg:order-2 shrink-0 h-[450px] lg:h-full">
                        <div className="p-4 border-b bg-white flex justify-between items-center shadow-sm">
                            <h2 className="font-bold text-gray-800 text-sm uppercase tracking-wide">{tab === 'clients' ? 'Cliente' : 'Produto'}</h2>
                            <div className="flex gap-2">
                                {(editingClientId || editingProductId) && <button onClick={deleteItem} className="text-xs bg-red-100 text-red-600 px-3 py-1.5 rounded font-bold">EXCLUIR</button>}
                                <button onClick={() => { 
                                    if(tab === 'clients') { setCForm({ name: '', code: '', phone: '', phone2: '', address: '', city: 'CUIAB√Å', district: '', region: 'CUIAB√Å', mapLink: '', photoLink: '', obs: '' }); setEditingClientId(null); } 
                                    else { setPForm({ name: '', internalCode: getNextProductCode(), category: 'ALIMENTOS', ncm: '', barcode: '', cost: '', price: '', stock: 0, isCombo: false, comboItems: [] }); setEditingProductId(null); } 
                                }} className="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded font-bold flex items-center gap-1"><Plus size={14}/> NOVO</button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4">
                            {tab === 'clients' ? (
                                <div className="space-y-3">
                                    <div><label className="text-[10px] font-bold text-gray-400 uppercase">Nome</label><input className="input-field" value={cForm.name} onChange={e => setCForm({...cForm, name: e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase">Zap</label><input className="input-field" value={cForm.phone} onChange={e => setCForm({...cForm, phone: e.target.value})} /></div>
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase">Bairro</label><input className="input-field" value={cForm.district} onChange={e => setCForm({...cForm, district: e.target.value})} /></div>
                                    </div>
                                    <div><label className="text-[10px] font-bold text-gray-400 uppercase">Endere√ßo</label><input className="input-field" value={cForm.address} onChange={e => setCForm({...cForm, address: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-gray-500 uppercase">Regi√£o</label><select className="input-field" value={cForm.region} onChange={e => setCForm({...cForm, region: e.target.value})}><option value="CUIAB√Å">CUIAB√Å</option><option value="COXIPO">COXIPO</option><option value="VARZEA GRANDE">VARZEA GRANDE</option><option value="CPA">CPA</option></select></div>
                                    <button onClick={saveClient} className="w-full btn-primary mt-2">SALVAR CLIENTE</button>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    <div><label className="text-[10px] font-bold text-gray-400 uppercase">Nome do Produto</label><input className="input-field" value={pForm.name} onChange={e => setPForm({...pForm, name: e.target.value})} /></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase">Custo</label><input className="input-field" type="number" value={pForm.cost} onChange={e => setPForm({...pForm, cost: e.target.value})} /></div>
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase">Venda</label><input className="input-field font-bold text-green-700" type="number" value={pForm.price} onChange={e => setPForm({...pForm, price: e.target.value})} /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="text-[10px] font-bold text-gray-400 uppercase">Estoque</label><input className="input-field" type="number" value={pForm.stock} disabled={pForm.isCombo} onChange={e => setPForm({...pForm, stock: Number(e.target.value)})} /></div>
                                        <div className="flex items-center pt-4"><label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" checked={pForm.isCombo} onChange={e => setPForm({...pForm, isCombo: e.target.checked})} /><span className="text-xs font-bold text-gray-600">KIT?</span></label></div>
                                    </div>
                                    {pForm.isCombo && (
                                        <div className="bg-yellow-50 p-3 rounded border border-yellow-200 mt-2">
                                            <div className="space-y-1 max-h-32 overflow-y-auto scrollbar-thin">
                                                {products.filter(p => !p.isCombo).map(p => (
                                                    <div key={p.id} className="flex justify-between items-center text-xs py-1 border-b border-yellow-100 last:border-0">
                                                        <span>{p.name}</span>
                                                        <input type="number" className="w-12 border rounded text-center" placeholder="0" value={pForm.comboItems.find(i => i.id === p.id)?.qty || ''} onChange={(e) => { 
                                                            const qty = Number(e.target.value); 
                                                            const existing = pForm.comboItems.filter(i => i.id !== p.id); 
                                                            if (qty > 0) setPForm({...pForm, comboItems: [...existing, {id: p.id, qty}]}); 
                                                            else setPForm({...pForm, comboItems: existing}); 
                                                        }} />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    <button onClick={saveProduct} className="w-full btn-primary mt-2">SALVAR PRODUTO</button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // --- STOCK MANAGER ---
        function StockManager({ products, setProducts }) {
             const [bulkIn, setBulkIn] = useState(''); const [bulkOut, setBulkOut] = useState(''); const sortedProducts = [...products].sort((a,b) => a.name.localeCompare(b.name));
             const processBulk = (text, type) => { 
                 const lines = text.split('\n'); const newProducts = [...products];
                 lines.forEach(line => { 
                     if(!line.trim()) return; 
                     const parts = line.split(/[|\t]+/); 
                     const code = parts[0]?.trim(); 
                     const qty = parseInt(parts[1]?.trim()); 
                     if (!code || isNaN(qty)) return; 
                     const prodIndex = newProducts.findIndex(p => (p.internalCode && p.internalCode === code) || (p.name.toUpperCase() === code.toUpperCase())); 
                     if (prodIndex !== -1) { 
                         const prod = newProducts[prodIndex];
                         if (type === 'IN') { prod.stock += qty; prod.stockHistory.push({ date: new Date().toISOString(), type: 'BULK_IN', qty }); } 
                         else { prod.stock -= qty; prod.stockHistory.push({ date: new Date().toISOString(), type: 'BULK_OUT', qty }); } 
                     } 
                 }); 
                 setProducts(newProducts); alert("Processado!"); if(type === 'IN') setBulkIn(''); else setBulkOut(''); 
            };
             return (<div className="flex h-full flex-col lg:flex-row"><div className="w-full lg:w-1/3 border-r bg-gray-50 p-4 overflow-y-auto h-[300px] lg:h-full">{sortedProducts.map(p => (<div key={p.id} className="flex justify-between items-center text-xs py-2 border-b"><div><span className="font-bold">{p.name}</span></div><span className={`font-bold px-2 py-1 rounded ${p.stock <= 5 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{p.stock}</span></div>))}</div><div className="flex-1 p-6 space-y-4 overflow-y-auto"><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 className="font-bold text-green-700 mb-2">Entrada Massa</h3><textarea className="w-full h-64 border p-2 text-xs font-mono" placeholder="COD | QTD" value={bulkIn} onChange={e=>setBulkIn(e.target.value)}></textarea><button onClick={()=>processBulk(bulkIn, 'IN')} className="btn-primary w-full bg-green-600 mt-2">PROCESSAR</button></div><div><h3 className="font-bold text-red-700 mb-2">Sa√≠da Massa</h3><textarea className="w-full h-64 border p-2 text-xs font-mono" placeholder="COD | QTD" value={bulkOut} onChange={e=>setBulkOut(e.target.value)}></textarea><button onClick={()=>processBulk(bulkOut, 'OUT')} className="btn-primary w-full bg-red-600 mt-2">PROCESSAR</button></div></div></div></div>)
        }
        
        // --- DRIVER VIEW ---
        function DriverView({ data, onExit }) {
          const [deliveryModal, setDeliveryModal] = useState(null); 
          const [filter, setFilter] = useState('Todas'); 
          const [deliveryResults, setDeliveryResults] = useState({});
          if (!data) return <div className="p-4 text-center">Dados inv√°lidos.</div>;
          const companyPhone = data.companyPhone || '65998150975';
          const uniqueRegions = [...new Set(data.orders.map(o => o.region || 'Geral').filter(Boolean))]; 
          const regions = ['Todas', ...uniqueRegions]; 
          const filteredOrders = filter === 'Todas' ? data.orders : data.orders.filter(o => (o.region || 'Geral') === filter);
          const visibleOrders = [...filteredOrders].sort((a, b) => deliveryResults[a.id] ? 1 : -1);
          const sendToCustomer = (phone, msg) => { 
             if(!phone) return alert("Erro.");
             window.open(`https://wa.me/55${phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank'); 
          };
          const handleDeliveryConfirm = (method) => { 
            if (!deliveryModal) return; 
            setDeliveryResults(prev => ({ ...prev, [deliveryModal.id]: { status: 'Entregue', payMethod: method } })); 
            setDeliveryModal(null); 
          };
          const generateFinalReport = () => {
              let report = `RELAT√ìRIO - ${new Date().toLocaleDateString()}\n`;
              Object.entries(deliveryResults).forEach(([id, res]) => { report += `ID: ${id} | ${res.status} | PG: ${res.payMethod}\n`; });
              window.open(`https://wa.me/55${companyPhone}?text=${encodeURIComponent(report)}`, '_blank');
          };
          return (
            <div className="h-screen flex flex-col bg-gray-50">
               <header className="bg-indigo-700 text-white p-4 shrink-0 shadow-md">
                 <div className="flex justify-between items-center mb-2"><h1 className="font-bold">ROTA: {data.route}</h1><button onClick={onExit} className="text-xs bg-indigo-800 px-2 py-1 rounded">Sair</button></div>
                 <div className="flex gap-2 overflow-x-auto pb-2">{regions.map(r => (<button key={r} onClick={() => setFilter(r)} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap transition border ${filter === r ? 'bg-white text-indigo-700' : 'bg-indigo-800'}`}>{r}</button>))}</div>
               </header>
               <div className="flex-1 overflow-y-auto p-4 space-y-4 pb-24">
                  {visibleOrders.map((order) => {
                    const result = deliveryResults[order.id];
                    const isDone = !!result;
                    return (
                        <div key={order.id} className={`rounded-lg shadow-sm border p-4 ${isDone ? 'bg-gray-100 opacity-75' : 'bg-white'}`}>
                            <div className="flex justify-between mb-2"><span className="font-bold">#{order.id}</span>{isDone && <span className="text-green-600 font-bold text-xs">{result.status}</span>}</div>
                            <h2 className="font-bold text-lg">{order.customer}</h2>
                            <p className="text-sm text-gray-600 mb-4">{order.address}, {order.district}</p>
                            <div className="grid grid-cols-2 gap-2 mb-4">
                                <a href={`tel:${order.phone}`} className="bg-gray-100 p-2 rounded text-center text-xs font-bold">LIGAR</a>
                                <button onClick={() => sendToCustomer(order.phone, "Chego em 10 min")} className="bg-blue-50 p-2 rounded text-xs font-bold">10 MIN</button>
                            </div>
                            {isDone ? (<div className="p-2 bg-gray-200 text-center font-bold text-xs rounded">CONCLU√çDO</div>) : (<button onClick={() => setDeliveryModal(order)} className="w-full bg-emerald-600 text-white py-3 rounded font-bold text-sm">ENTREGAR</button>)}
                            <div className="mt-3 text-xs flex justify-between"><span>Total:</span><span className="font-bold">{formatCurrency(order.total)}</span></div>
                        </div>); })}
               </div>
               {deliveryModal && (<div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4"><div className="bg-white w-full max-w-sm rounded-xl p-4 shadow-2xl">
                    <h3 className="font-bold mb-4">Pagamento</h3>
                    <div className="grid grid-cols-2 gap-3">
                        <button onClick={() => handleDeliveryConfirm('DINHEIRO')} className="bg-green-100 p-4 rounded-lg font-bold">DINHEIRO</button>
                        <button onClick={() => handleDeliveryConfirm('PIX')} className="bg-indigo-100 p-4 rounded-lg font-bold">PIX</button>
                        <button onClick={() => handleDeliveryConfirm('CART√ÉO')} className="bg-blue-100 p-4 rounded-lg font-bold">CART√ÉO</button>
                        <button onClick={() => handleDeliveryConfirm('PAGO')} className="bg-gray-100 p-4 rounded-lg font-bold">PAGO</button>
                    </div>
               </div></div>)}
               {Object.keys(deliveryResults).length > 0 && (<div className="fixed bottom-0 left-0 w-full p-4 bg-white border-t"><button onClick={generateFinalReport} className="w-full bg-green-600 text-white font-bold py-4 rounded-xl">ENVIAR RELAT√ìRIO</button></div>)}
            </div>);
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
