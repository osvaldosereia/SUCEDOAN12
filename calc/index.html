<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <title>Assistente | Dona Ant√¥nia</title>
    <meta name="description" content="Assistente virtual para montar sua cesta b√°sica.">
    <meta name="theme-color" content="#2563EB">
    
    <style>
        /* --- DESIGN SYSTEM (SISTEMAS) --- */
        :root {
            --primary: #2563EB;
            --primary-dark: #1D4ED8;
            --bg: #F0F2F5; /* Cor de fundo estilo WhatsApp */
            --surface: #FFFFFF;
            --text: #111827;
            --text-light: #4B5563; 
            --msg-bg: #FFFFFF;
            --msg-user: #D9FDD3; /* Verde estilo Zap */
            --border: #E5E7EB;
            --radius: 16px;
            --font-main: system-ui, -apple-system, sans-serif;
            --max-w: 600px; /* Mais estreito para parecer chat */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; background-color: var(--bg); font-family: var(--font-main);
            color: var(--text); padding-bottom: 100px;
        }

        /* HEADER */
        header {
            background: #008069; /* Verde Zap */
            color: white; padding: 16px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 100;
        }
        .avatar {
            width: 44px; height: 44px; background: white; border-radius: 50%;
            overflow: hidden; border: 2px solid rgba(255,255,255,0.5);
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .header-info h1 { margin: 0; font-size: 18px; font-weight: 600; }
        .header-info p { margin: 0; font-size: 13px; opacity: 0.9; }

        /* CONTAINER DO CHAT */
        main { max-width: var(--max-w); margin: 0 auto; padding: 16px; display: flex; flex-direction: column; gap: 20px; }

        /* BAL√ïES DE FALA */
        .bubble {
            background: var(--msg-bg); padding: 16px; border-radius: 0 16px 16px 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            position: relative; align-self: flex-start; max-width: 95%;
            animation: popIn 0.3s ease-out;
        }
        .bubble::before {
            content: ''; position: absolute; top: 0; left: -8px;
            width: 0; height: 0; 
            border-top: 10px solid var(--msg-bg); border-left: 10px solid transparent;
        }
        .bubble p { margin: 0 0 10px 0; line-height: 1.5; font-size: 16px; }
        .bubble p:last-child { margin-bottom: 0; }
        .bubble strong { color: var(--primary-dark); }

        @keyframes popIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        /* CARDS DE PRODUTO DENTRO DO CHAT */
        .chat-list {
            display: grid; gap: 10px; margin-top: 12px;
        }
        .chat-item {
            display: flex; align-items: center; gap: 12px;
            background: #F8F9FA; border: 1px solid var(--border);
            padding: 8px; border-radius: 12px;
        }
        .chat-item img {
            width: 50px; height: 50px; border-radius: 8px; 
            object-fit: contain; background: white; mix-blend-mode: multiply;
        }
        .item-info { flex-grow: 1; }
        .item-name { font-size: 14px; font-weight: 600; color: var(--text); }
        .item-price { font-size: 13px; color: var(--text-light); }
        
        /* CONTROLES SIMPLIFICADOS */
        .qty-controls {
            display: flex; align-items: center; gap: 8px;
            background: white; padding: 4px; border-radius: 8px; border: 1px solid #ddd;
        }
        .btn-act {
            width: 32px; height: 32px; border: none; border-radius: 6px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-minus { background: #fee2e2; color: #dc2626; }
        .btn-plus { background: #dcfce7; color: #16a34a; }
        .qty-num { font-weight: 700; width: 20px; text-align: center; }

        /* BARRA DE A√á√ÉO INFERIOR */
        .bottom-action {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 12px 16px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: center; z-index: 99;
        }
        .btn-main {
            background: #008069; color: white; border: none;
            width: 100%; max-width: var(--max-w); height: 50px;
            border-radius: 25px; font-size: 16px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,128,105,0.3); transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }
        
        /* UTIL */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* Loading */
        #loading-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <!-- CABE√áALHO FIXO -->
    <header>
        <div class="avatar">
            <img src="https://placehold.co/100x100/2563EB/white?text=DA" alt="Dona Ant√¥nia">
        </div>
        <div class="header-info">
            <h1>Dona Ant√¥nia</h1>
            <p>Assistente Virtual ‚Ä¢ Online</p>
        </div>
    </header>

    <!-- √ÅREA DE CONVERSA (Muda conforme o passo) -->
    <main id="chat-container">
        <!-- O conte√∫do ser√° injetado via JS -->
    </main>

    <!-- BOT√ÉO DE A√á√ÉO -->
    <div class="bottom-action" id="action-bar">
        <button class="btn-main" onclick="nextStep()" id="btn-next">
            COME√áAR
        </button>
    </div>

    <!-- JSON DATA LOADER -->
    <div id="loading-screen">
        <svg style="width:40px; height:40px; animation: spin 1s infinite linear; color: var(--primary);" viewBox="0 0 256 256"><path fill="currentColor" d="M232,128a104,104,0,0,1-208,0c0-41,23.81-76.33,58.57-92.74a8,8,0,0,1,7.23,14.28C62.66,62.88,44,93,44,128a88,88,0,0,0,176,0c0-35-18.66-65.12-45.8-78.46a8,8,0,1,1,7.23-14.28C208.19,51.67,232,87,232,128Z"></path></svg>
        <p style="margin-top:10px; font-weight:600; color:var(--text-light)">Carregando produtos...</p>
    </div>
    <style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>

    <script>
        // --- DADOS ---
        let PRODUTOS = [];
        let CART = {}; // { "id": qtd }
        let CURRENT_STEP = 0;
        
        // Cesta Padr√£o Inicial (IDs dos produtos)
        const DEFAULT_BASKET_IDS = ["001", "005", "004", "003", "006", "007", "007"]; // 2x Macarr√£o

        // --- INICIALIZA√á√ÉO ---
        async function init() {
            try {
                // Fetch dos produtos
                const res = await fetch('./produtos.json');
                if(!res.ok) throw new Error("Erro JSON");
                PRODUTOS = await res.json();
                
                // Popula cesta inicial
                DEFAULT_BASKET_IDS.forEach(id => {
                    CART[id] = (CART[id] || 0) + 1;
                });

                document.getElementById('loading-screen').classList.add('hidden');
                renderStep(0);
            } catch(e) {
                document.getElementById('loading-screen').innerHTML = "<p>Erro ao carregar. Atualize a p√°gina.</p>";
            }
        }

        // --- MOTOR DO WIZARD ---
        function renderStep(step) {
            CURRENT_STEP = step;
            const container = document.getElementById('chat-container');
            const btn = document.getElementById('btn-next');
            container.innerHTML = ''; // Limpa tela (estilo wizard)

            window.scrollTo(0,0);

            if (step === 0) {
                // INTRODU√á√ÉO
                container.innerHTML = `
                    <div class="bubble">
                        <p>Ol√°! Tudo bem? üëã</p>
                        <p>Eu sou a assistente virtual da Dona Ant√¥nia.</p>
                        <p>J√° separei uma <strong>Cesta B√°sica Padr√£o</strong> para voc√™ n√£o perder tempo.</p>
                        <p>Vamos conferir e ajustar o que voc√™ precisa?</p>
                    </div>
                `;
                btn.innerText = "VAMOS L√Å ‚û§";
                btn.onclick = () => renderStep(1);
            
            } else if (step === 1) {
                // PASSO 1: REMO√á√ÉO / AJUSTE
                let listHtml = '';
                const sortedIds = Object.keys(CART).sort();
                
                sortedIds.forEach(id => {
                    const p = PRODUTOS.find(x => x.id === id);
                    if(p) listHtml += createItemRow(p, CART[id], 'remove');
                });

                container.innerHTML = `
                    <div class="bubble">
                        <p>√ìtimo! üëá Aqui est√° a cesta que eu montei.</p>
                        <p><strong>Tem algo aqui que voc√™ N√ÉO quer?</strong></p>
                        <p>Use o bot√£o <strong>(-)</strong> para tirar ou diminuir.</p>
                    </div>
                    <div class="chat-list">
                        ${listHtml}
                    </div>
                    <div class="bubble" style="margin-top:10px; background:#fff3cd;">
                        <p>üí° <em>Dica: Se quiser tirar tudo de um item, v√° clicando no menos (-) at√© sumir.</em></p>
                    </div>
                `;
                btn.innerText = "PRONTO, PR√ìXIMO ‚û§";
                btn.onclick = () => renderStep(2);

            } else if (step === 2) {
                // PASSO 2: ADI√á√ÉO
                let listHtml = '';
                // Mostra produtos populares que N√ÉO est√£o na cesta (ou todos)
                // Para simplificar, mostramos os top 10 produtos da lista geral
                PRODUTOS.slice(0, 15).forEach(p => {
                    const qtd = CART[p.id] || 0;
                    listHtml += createItemRow(p, qtd, 'add');
                });

                container.innerHTML = `
                    <div class="bubble">
                        <p>Entendi. ‚úÖ</p>
                        <p>Agora, <strong>o que est√° faltando?</strong></p>
                        <p>Veja se quer adicionar mais alguma coisa dessa lista abaixo:</p>
                    </div>
                    <div class="chat-list">
                        ${listHtml}
                    </div>
                `;
                btn.innerText = "FECHAR PEDIDO ‚û§";
                btn.onclick = () => renderStep(3);

            } else if (step === 3) {
                // PASSO 3: FECHAMENTO / SUGEST√ÉO
                let total = 0;
                let resumoHtml = '';
                
                Object.keys(CART).forEach(id => {
                    const p = PRODUTOS.find(x => x.id === id);
                    if(p && CART[id] > 0) {
                        const sub = p.price * CART[id];
                        total += sub;
                        resumoHtml += `
                            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:14px;">
                                <span>${CART[id]}x ${p.name}</span>
                                <strong>R$ ${sub.toFixed(2).replace('.',',')}</strong>
                            </div>
                        `;
                    }
                });

                const frete = total >= 120 ? 0 : 10;
                const totalFinal = total + frete;

                container.innerHTML = `
                    <div class="bubble">
                        <p>Perfeito! Fiz as contas aqui. üßÆ</p>
                        <p>Essa √© a minha <strong>Sugest√£o Final</strong> para sua cesta:</p>
                    </div>
                    
                    <div class="bubble" style="background:white; border:1px solid var(--primary);">
                        ${resumoHtml}
                        <div style="margin-top:12px; padding-top:12px; border-top:2px dashed #ddd;">
                            <div style="display:flex; justify-content:space-between;">
                                <span>Produtos:</span> <strong>R$ ${total.toFixed(2).replace('.',',')}</strong>
                            </div>
                            <div style="display:flex; justify-content:space-between; color:${frete===0?'var(--primary)':'#d32f2f'}">
                                <span>Entrega:</span> <strong>${frete===0 ? 'GR√ÅTIS' : 'R$ 10,00'}</strong>
                            </div>
                            <div style="display:flex; justify-content:space-between; font-size:18px; margin-top:10px; color:var(--primary-dark);">
                                <strong>TOTAL:</strong> <strong>R$ ${totalFinal.toFixed(2).replace('.',',')}</strong>
                            </div>
                        </div>
                    </div>

                    <div class="bubble">
                        <p>Posso enviar esse pedido para a separa√ß√£o agora?</p>
                    </div>
                `;
                
                btn.style.background = "#25D366"; // Verde Zap
                btn.innerHTML = `<svg viewBox="0 0 256 256" style="width:24px;height:24px;fill:white"><path d="M128,24A104,104,0,0,0,36.18,176.88L24.83,210.93a16,16,0,0,0,20.24,20.24l34.05-11.35A104,104,0,1,0,128,24Zm0,192a87.87,87.87,0,0,1-44.06-11.81,8,8,0,0,0-6.54-.67L40,216,52.47,178.6a8,8,0,0,0-.66-6.54A88,88,0,1,1,128,216Z"></path></svg> ENVIAR PEDIDO NO ZAP`;
                btn.onclick = () => sendWhatsapp(totalFinal);
            }
        }

        // --- COMPONENTES ---
        function createItemRow(p, qtd, mode) {
            // Imagem principal ou placeholder
            const img = p.img || 'https://placehold.co/50';
            
            // Se modo for "add" e qtd for 0, mostra bot√£o "Adicionar"
            // Se modo for "remove" e qtd for 0, nem mostra o item (j√° foi removido da view, mas aqui garantimos)
            if (mode === 'remove' && qtd <= 0) return '';

            return `
                <div class="chat-item fade-in" id="item-${p.id}">
                    <img src="${img}" alt="${p.name}">
                    <div class="item-info">
                        <div class="item-name">${p.name}</div>
                        <div class="item-price">R$ ${p.price.toFixed(2).replace('.',',')}</div>
                    </div>
                    <div class="qty-controls">
                        <button class="btn-act btn-minus" onclick="changeQty('${p.id}', -1)">-</button>
                        <span class="qty-num">${qtd}</span>
                        <button class="btn-act btn-plus" onclick="changeQty('${p.id}', 1)">+</button>
                    </div>
                </div>
            `;
        }

        function changeQty(id, delta) {
            if (!CART[id]) CART[id] = 0;
            CART[id] += delta;
            
            if (CART[id] <= 0) {
                // Se passo 1 (remover), zerar significa tirar da lista
                if (CURRENT_STEP === 1) delete CART[id];
                else CART[id] = 0; // No passo 2, mant√©m 0 pra poder adicionar de novo se quiser
            }

            // Re-renderiza APENAS a lista do passo atual para n√£o perder scroll ou foco bruscamente
            // Mas como √© um MVP simples, re-renderizar o passo todo √© mais seguro para consist√™ncia
            renderStep(CURRENT_STEP);
        }

        function sendWhatsapp(totalVal) {
            let msg = "*PEDIDO VIA ASSISTENTE VIRTUAL*\n";
            msg += "--------------------------------\n";
            
            Object.keys(CART).forEach(id => {
                if (CART[id] > 0) {
                    const p = PRODUTOS.find(x => x.id === id);
                    msg += `[${CART[id]}] ${p.name}\n`;
                }
            });
            
            msg += "--------------------------------\n";
            msg += `*TOTAL FINAL: R$ ${totalVal.toFixed(2).replace('.',',')}*\n`;
            
            const link = `https://api.whatsapp.com/send?phone=5565998150975&text=${encodeURIComponent(msg)}`;
            window.open(link, '_blank');
        }

        // Start
        init();

    </script>
</body>
</html>
