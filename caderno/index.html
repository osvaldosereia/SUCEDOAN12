<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Conex√£o e Transcri√ß√£o</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        button { padding: 10px 15px; cursor: pointer; margin-right: 5px; }
        
        /* Cores de status */
        .status-ok { color: green; font-weight: bold; }
        .status-error { color: red; font-weight: bold; background-color: #ffe6e6; padding: 10px; border-radius: 4px; }
        .log { margin-top: 10px; font-family: monospace; font-size: 0.9em; color: #555; white-space: pre-wrap; }

        /* Desabilitar √°rea de √°udio at√© conectar */
        #audioSection.disabled { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>

    <div class="box">
        <h3>1. Configura√ß√£o de Conex√£o</h3>
        <input type="text" id="apiUrl" value="https://jsonplaceholder.typicode.com/posts/1" style="width: 100%; margin-bottom: 10px; padding: 8px;" placeholder="URL da API">
        
        <button onclick="testarConexao()">üîå Testar Conex√£o</button>
        <div id="connectionStatus" class="log"></div>
    </div>

    <div id="audioSection" class="box disabled">
        <h3>2. Grava√ß√£o e Transcri√ß√£o</h3>
        <p>O fluxo ser√°: Gravar -> Salvar Arquivo -> Transcrever.</p>
        
        <button id="btnGravar" onclick="iniciarGravacao()">üé§ Gravar</button>
        <button id="btnParar" onclick="pararESalvar()" disabled>‚èπÔ∏è Parar & Processar</button>
        
        <div id="audioStatus" class="log"></div>
        <audio id="audioPlayer" controls style="display:none; margin-top: 10px; width: 100%;"></audio>
    </div>

    <script>
        // Vari√°veis Globais
        let mediaRecorder;
        let audioChunks = [];
        let isConnected = false;

        // --- FUN√á√ÉO 1: TESTAR CONEX√ÉO ---
        async function testarConexao() {
            const url = document.getElementById('apiUrl').value;
            const statusDiv = document.getElementById('connectionStatus');
            const audioSection = document.getElementById('audioSection');

            statusDiv.innerHTML = "Tentando conectar...";
            statusDiv.className = "log";

            try {
                // Tenta fazer um fetch simples (HEAD ou GET) para ver se responde
                const response = await fetch(url, { method: 'GET' });

                if (!response.ok) {
                    // Se o servidor respondeu, mas com erro (ex: 404, 500, 401)
                    throw new Error(`Erro do Servidor: ${response.status} - ${response.statusText}`);
                }

                // SUCESSO
                statusDiv.innerHTML = "‚úÖ Conex√£o estabelecida com sucesso!";
                statusDiv.className = "log status-ok";
                
                // Habilita a se√ß√£o de √°udio
                isConnected = true;
                audioSection.classList.remove('disabled');

            } catch (error) {
                // ERRO DE REDE OU OUTROS
                console.error(error);
                let mensagemErro = error.message;

                // Tenta identificar erros comuns de conex√£o
                if (error.message.includes('Failed to fetch')) {
                    mensagemErro = "Falha na conex√£o de rede. Verifique se a URL est√° correta, se o servidor est√° online ou se h√° bloqueio de CORS.";
                }

                statusDiv.innerHTML = `‚ùå FALHA NA CONEX√ÉO:\n${mensagemErro}`;
                statusDiv.className = "log status-error";
                
                // Bloqueia √°udio novamente se falhar
                isConnected = false;
                audioSection.classList.add('disabled');
            }
        }

        // --- FUN√á√ÉO 2: GRAVA√á√ÉO ---
        async function iniciarGravacao() {
            if (!isConnected) return alert("Conecte primeiro!");

            audioChunks = []; // Limpa grava√ß√µes anteriores
            const statusDiv = document.getElementById('audioStatus');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                mediaRecorder.start();
                
                // Evento: quando houver dados de √°udio dispon√≠veis
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                // Evento: quando a grava√ß√£o parar (AQUI ACONTECE A M√ÅGICA)
                mediaRecorder.onstop = async () => {
                    statusDiv.innerText += "\nüíæ Salvando √°udio...";
                    
                    // 1. CRIA O ARQUIVO (SALVA)
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    
                    // Toca o √°udio para o usu√°rio confirmar que salvou
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';

                    // 2. CHAMA A TRANSCRI√á√ÉO (S√≥ depois de ter o blob pronto)
                    await executarTranscricao(audioBlob);
                };

                document.getElementById('btnGravar').disabled = true;
                document.getElementById('btnParar').disabled = false;
                statusDiv.innerText = "üî¥ Gravando...";

            } catch (err) {
                statusDiv.innerHTML = "Erro ao acessar microfone: " + err.message;
            }
        }

        function pararESalvar() {
            mediaRecorder.stop(); // Isso dispara o evento 'onstop' definido acima
            document.getElementById('btnGravar').disabled = false;
            document.getElementById('btnParar').disabled = true;
        }

        // --- FUN√á√ÉO 3: TRANSCRI√á√ÉO (SIMULADA) ---
        async function executarTranscricao(audioBlob) {
            const statusDiv = document.getElementById('audioStatus');
            statusDiv.innerText += "\nüöÄ Enviando para transcri√ß√£o...";

            try {
                // AQUI VOC√ä COLOCA SUA L√ìGICA REAL DE UPLOAD/TRANSCRI√á√ÉO
                // Exemplo com FormData (como se fosse enviar para OpenAI Whisper ou servidor pr√≥prio)
                
                /* const formData = new FormData();
                formData.append("file", audioBlob, "gravacao.wav");
                formData.append("model", "whisper-1");

                const response = await fetch("SEU_ENDPOINT_DE_TRANSCRICAO", {
                    method: "POST",
                    body: formData,
                    headers: { "Authorization": "Bearer SUA_CHAVE" } // Se necess√°rio
                });
                */

                // Simulando um tempo de espera (remover no c√≥digo real)
                await new Promise(r => setTimeout(r, 2000));

                // Simulando resposta
                const textoTranscrito = "Esta √© uma simula√ß√£o. O √°udio foi salvo e processado com sucesso.";

                statusDiv.innerHTML += `\n‚úÖ Transcri√ß√£o Conclu√≠da:\n"${textoTranscrito}"`;

            } catch (error) {
                statusDiv.innerHTML += `\n‚ùå Erro na transcri√ß√£o: ${error.message}`;
            }
        }
    </script>
</body>
</html>
