<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caderno Digital Pessoal</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o r√°pida e moderna -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos globais para layout iOS/Apple (desktop-like) */
        body {
            /* Prioriza a fonte do sistema iOS/macOS e fallback para Inter */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Inter', sans-serif;
            background-color: #f0f2f5; /* Fundo muito leve, t√≠pico do iOS/macOS */
            color: #1c1c1e; /* Texto quase preto para contraste */
        }
        
        /* Estilo base para pain√©is/cart√µes no estilo iOS */
        .ios-panel {
            background-color: #ffffff; 
            border-radius: 16px; /* Cantos generosamente arredondados */
            /* Sombra mais minimalista */
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04); 
            border: 1px solid rgba(220, 220, 220, 0.5); /* Borda muito suave */
            transition: all 0.2s;
        }

        /* Estilo para inputs e selects (iOS look) */
        .ios-input {
            border-radius: 10px;
            background-color: #f7f7f7; /* Fundo levemente cinza */
            border: 1px solid #d1d1d6; /* Cinza claro */
            color: #1c1c1e;
            padding: 8px 12px;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05); /* Sombra interna sutil */
        }
        .ios-input:focus {
            border-color: #007aff; /* Azul iOS ao focar */
            ring: none;
            outline: none;
        }

        /* Bot√µes de A√ß√£o Principal (iOS Blue) */
        .ios-button-primary {
            background-color: #007aff; 
            color: white;
            border-radius: 12px;
            font-weight: 600;
            padding: 10px 16px;
            transition: background-color 0.15s ease-in-out;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .ios-button-primary:hover {
            background-color: #005fcc; 
        }
        
        /* Bot√µes Secund√°rios/Neutros */
        .ios-button-secondary {
            background-color: #e5e5ea; /* Cinza suave */
            color: #1c1c1e;
            border-radius: 12px;
            font-weight: 500;
            padding: 10px 16px;
            transition: background-color 0.15s ease-in-out;
        }
        .ios-button-secondary:hover {
            background-color: #d1d1d6;
        }
        
        /* Estilo para o cart√£o de nota na lista */
        .note-card-ios {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: none;
            border: 1px solid #e0e0e0;
        }
        .note-card-ios:hover {
            background-color: #f0f0f5;
        }

        /* Esconder a barra de rolagem horizontal em telas largas, se necess√°rio */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        
        /* NOVO: Estilos para a Barra de Ferramentas Fixa e Editor */
        
        /* Container principal do editor deve permitir rolagem e ter espa√ßo para a barra fixa */
        .editor-scroll-container {
            height: 100%;
            overflow-y: auto;
        }

        /* Barra de Ferramentas Fixa/Sticky */
        #fixedToolbar {
            position: sticky;
            top: 0; /* Cola no topo do cont√™iner de rolagem */
            z-index: 20;
            background-color: #ffffff; 
            padding: 10px 24px; /* O mesmo padding horizontal do ios-panel */
            /* Ajuste para esticar a largura e ter bordas arredondadas no topo */
            margin: -24px -24px 0 -24px;
            border-bottom: 1px solid #f0f0f5;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            /* Garante que o painel de edi√ß√£o tenha padding-top para n√£o ser coberto pela barra */
        }
        
        /* Estilo da barra de t√≠tulo e data logo abaixo da barra fixa */
        .note-header-info {
            padding-top: 16px; /* Espa√ßo entre a barra fixa e o t√≠tulo */
        }

        /* Estilo para a √°rea de edi√ß√£o (contenteditable div) */
        #noteContent {
            line-height: 1.6;
            min-height: 400px;
            padding: 12px 0; /* Aumenta o padding interno verticalmente */
            border: none;
            background-color: transparent;
        }
        
        /* Estilo para o bot√£o de IA Inativo (sempre vis√≠vel, mas desativado) */
        .ia-button-inactive {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none; /* Impede cliques */
            transform: none !important; /* Remove o hover effect quando inativo */
        }

        /* Estilos de impress√£o - Oculta tudo, exceto o painel de notas, ao imprimir */
        @media print {
            body > div.flex {
                display: block !important;
                padding: 0 !important;
                height: auto !important;
            }
            .w-1/5 {
                display: none !important; /* Oculta sidebar e lista de notas */
            }
            .w-3/5 {
                width: 100% !important; /* Editor ocupa a largura total */
                padding: 20px !important;
                margin: 0 !important;
                box-shadow: none !important;
                border: none !important;
            }
            #fixedToolbar, #editorPlaceholder {
                display: none !important; /* Oculta a barra de ferramentas e placeholder */
            }
            .note-header-info, #noteContent {
                background: none !important;
            }
        }
    </style>
</head>
<body>

    <div id="loading" class="fixed inset-0 bg-gray-100 bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="text-xl font-semibold text-indigo-600">
            A carregar o caderno...
        </div>
    </div>

    <!-- Layout Principal: 3 Colunas (Estilo iOS) -->
    <div class="flex h-screen p-4 space-x-4 overflow-hidden">
        
        <!-- Coluna de Navega√ß√£o/Filtros (Sidebar) - LARGURA 20% -->
        <div class="w-1/5 ios-panel p-4 overflow-y-auto no-scrollbar">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Filtros & Categorias</h2>
            
            <button id="newNoteBtn" class="w-full ios-button-primary mb-4">
                + Nova Nota
            </button>
            
            <div class="mb-6">
                <label for="categoryFilter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Categoria</label>
                <select id="categoryFilter" class="w-full ios-input text-sm">
                    <option value="">Todas as Categorias</option>
                    <!-- Op√ß√µes de categorias ser√£o preenchidas via JS -->
                </select>
            </div>
            
            <div class="mb-6">
                <label for="dateSearch" class="block text-sm font-medium text-gray-700 mb-1">Buscar por Data (In√≠cio)</label>
                <input type="date" id="dateSearch" class="w-full ios-input text-sm">
                <p class="text-xs text-gray-500 mt-1">Busca notas criadas a partir desta data.</p>
            </div>
            
            <!-- Gest√£o de Dados -->
            <div class="mt-8 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold mb-2 text-gray-700">Gest√£o de Dados</h3>
                <button id="exportBtn" class="w-full ios-button-secondary text-sm mb-2">
                    Exportar Notas (JSON)
                </button>
                <label for="importFile" class="w-full block text-center ios-button-secondary cursor-pointer text-sm">
                    Importar Notas (JSON)
                </label>
                <!-- Campo de input de ficheiro escondido -->
                <input type="file" id="importFile" accept=".json" class="hidden">
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500">
                    <span class="font-semibold text-gray-700">Armazenamento Local.</span>
                </p>
                <p class="text-xs text-gray-500 mt-2">
                    As suas notas s√£o salvas no seu navegador.
                </p>
            </div>
        </div>

        <!-- Coluna da Lista de Notas - LARGURA 20% -->
        <div class="w-1/5 ios-panel p-4 overflow-y-auto no-scrollbar">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Minhas Notas</h2>
            <div id="notesList" class="space-y-3">
                <!-- Notas ser√£o carregadas aqui -->
                <p class="text-center text-gray-500" id="listPlaceholder">Nenhuma nota ainda. Crie uma!</p>
            </div>
        </div>

        <!-- Coluna do Editor/Visualizador de Notas - LARGURA 60% -->
        <div class="w-3/5 ios-panel p-6 relative">
            <div id="editorPlaceholder" class="flex items-center justify-center h-full text-gray-400 text-lg">
                Selecione uma nota ou crie uma nova para come√ßar a escrever.
            </div>

            <div id="noteEditor" class="h-full flex flex-col hidden">
                
                <!-- Barra de Ferramentas Fixa (STICKY) -->
                <div id="fixedToolbar" class="flex flex-wrap items-center justify-between">
                    
                    <!-- 1. Controles de Edi√ß√£o e Categoria (Esquerda) -->
                    <div class="flex space-x-3 items-center">
                        <h3 class="text-lg font-semibold text-gray-800 hidden sm:block">Editor:</h3>

                        <!-- Bot√£o Negrito -->
                        <button id="boldBtn" class="ios-button-secondary text-sm py-1 px-3" title="Negrito">
                            <span class="font-bold">B</span>
                        </button>
                        
                        <!-- Bot√£o Lista -->
                        <button id="listBtn" class="ios-button-secondary text-sm py-1 px-3 font-bold" title="Lista (N√£o Ordenada)">
                            &#x2261;
                        </button>
                        
                        <!-- Bot√£o T√≠tulo -->
                        <button id="headingBtn" class="ios-button-secondary text-sm py-1 px-3" title="T√≠tulo (H2)">
                            <span class="font-bold">H2</span>
                        </button>
                        
                        <!-- NOVO: Bot√£o Linha Separadora -->
                        <button id="separatorBtn" class="ios-button-secondary text-sm py-1 px-3 font-bold" title="Linha Separadora">
                            &mdash;
                        </button>

                         <!-- NOVO: Bot√£o Link -->
                        <button id="linkBtn" class="ios-button-secondary text-sm py-1 px-3 font-bold" title="Inserir Link">
                            <span class="text-blue-500">üîó</span>
                        </button>

                        <select id="noteCategory" class="ios-input text-sm p-1 max-w-[120px]">
                            <option value="Geral">Geral</option>
                            <option value="Ideias">Ideias</option>
                            <option value="Trabalho">Trabalho</option>
                            <option value="Pessoal">Pessoal</option>
                            <!-- Categorias do JS s√£o adicionadas aqui -->
                        </select>
                    </div>

                    <!-- 2. Bot√£o IA (Centro/Esquerda) - Sempre vis√≠vel, estado inativo por padr√£o -->
                    <button id="iaFloatingButton" 
                        class="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold py-1 px-2 rounded-full shadow-lg transition duration-150 transform hover:scale-105 ia-button-inactive"
                        title="Enviar texto selecionado para o Google IA (udm=50)">
                        üöÄ Perguntar √† IA
                    </button>

                    <!-- 3. Bot√µes de A√ß√£o (Direita) -->
                    <div class="flex space-x-2 items-center">
                        <!-- NOVO: Bot√£o Imprimir -->
                        <button id="printBtn" class="ios-button-secondary font-normal py-1 px-3 rounded-lg text-sm" title="Imprimir Nota">
                            &#x2399; <!-- √çcone de impressora ou similar -->
                        </button>

                        <button id="cancelEditBtn" class="ios-button-secondary font-normal py-1 px-3 rounded-lg text-sm">
                            Cancelar
                        </button>
                        <button id="deleteNoteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm hidden">
                            Excluir
                        </button>
                        <button id="saveNoteBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-sm">
                            Guardar
                        </button>
                    </div>
                </div> <!-- Fim #fixedToolbar -->
                
                <!-- Container de Rolagem (com o conte√∫do que rola) -->
                <div class="editor-scroll-container">
                    
                    <!-- T√≠tulo e Data (AGORA DENTRO DO SCROLL CONTAINER) -->
                    <div class="note-header-info">
                        <input type="text" id="noteTitle" placeholder="T√≠tulo da Nota" class="w-full text-2xl font-bold mb-2 ios-input border-none bg-transparent shadow-none p-0 focus:border-none focus:ring-0">
                        <p id="noteDate" class="text-sm text-gray-500 mb-4"></p>
                    </div>
                    
                    <!-- CONTE√öDO DA NOTA (Contenteditable) -->
                    <div id="noteContent" 
                        contenteditable="true" 
                        placeholder="Comece a escrever a sua nota aqui... (Cole texto formatado ou selecione texto para usar a funcionalidade de IA!)" 
                        class="w-full ios-input overflow-y-auto border-none shadow-none bg-transparent">
                    </div>
                </div>

                <!-- O bot√£o de salvar/deletar foi movido para o fixedToolbar, esta div est√° vazia, mas mantemos para refer√™ncia futura se precisar de rodap√© -->
                <div class="hidden"></div>
                
            </div>
        </div>
    </div>

    <!-- Scripts da L√≥gica da Aplica√ß√£o -->
    <script type="module">
        
        // --- Constantes e Vari√°veis de Configura√ß√£o ---
        
        // Chave de armazenamento local para as notas
        const LOCAL_STORAGE_KEY = 'notebook_personal_notes';
        
        // Prompt predefinido para a funcionalidade de IA (Mantenha o espa√ßo no final!)
        const IA_PROMPT = "Analise e explique este conceito: "; 

        // Lista das categorias dispon√≠veis (para o editor e filtro)
        const DEFAULT_CATEGORIES = ["Geral", "Ideias", "Trabalho", "Pessoal", "Estudo", "Rascunho"];

        // Vari√°veis globais de estado
        let allNotes = []; // Armazena todas as notas carregadas
        let currentNoteId = null; // ID da nota atualmente em edi√ß√£o

        // --- Fun√ß√µes de Manipula√ß√£o do LocalStorage ---

        // Carrega todas as notas do localStorage
        const loadNotesFromLocalStorage = () => {
            try {
                const storedNotes = localStorage.getItem(LOCAL_STORAGE_KEY);
                allNotes = storedNotes ? JSON.parse(storedNotes) : [];
                console.log(`Notas carregadas: ${allNotes.length}`);
            } catch (error) {
                console.error("Erro ao carregar notas do LocalStorage:", error);
                allNotes = [];
            }
        };

        // Salva o array 'allNotes' completo no localStorage
        const saveNotesToLocalStorage = () => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(allNotes));
                console.log(`Notas salvas: ${allNotes.length}`);
            } catch (error) {
                console.error("Erro ao salvar notas no LocalStorage:", error);
                alertMessage("Erro ao salvar dados localmente. O navegador pode estar cheio.", 'red');
            }
        };

        // --- Fun√ß√µes de Exporta√ß√£o e Importa√ß√£o ---

        // Fun√ß√£o para exportar todas as notas para um ficheiro JSON
        const handleExport = () => {
            if (allNotes.length === 0) {
                alertMessage("N√£o h√° notas para exportar.", 'yellow');
                return;
            }

            // 1. Prepara o conte√∫do
            const dataStr = JSON.stringify(allNotes, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            
            // 2. Cria o URL de download tempor√°rio
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // 3. Define o nome do ficheiro
            const date = new Date().toISOString().slice(0, 10);
            a.download = `caderno_notas_export_${date}.json`;
            a.href = url;
            
            // 4. Dispara o download e limpa
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alertMessage(`Exporta√ß√£o de ${allNotes.length} notas conclu√≠da!`, 'green');
        };

        // Fun√ß√£o para importar notas de um ficheiro JSON
        const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirmAction("Importar substituir√° todas as notas existentes. Tem certeza que deseja continuar?")) {
                // Se o usu√°rio cancelar, limpa o input de arquivo para permitir nova sele√ß√£o
                event.target.value = null; 
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedNotes) || importedNotes.some(n => !n.id || !n.content)) {
                        throw new Error("Formato de ficheiro JSON inv√°lido para notas.");
                    }

                    // Substitui o array de notas
                    allNotes = importedNotes; 
                    saveNotesToLocalStorage();
                    renderNotes();
                    
                    alertMessage(`Importa√ß√£o de ${importedNotes.length} notas conclu√≠da com sucesso!`, 'green');
                } catch (error) {
                    console.error("Erro ao processar ficheiro de importa√ß√£o:", error);
                    alertMessage("Erro na importa√ß√£o. Ficheiro corrompido ou formato inv√°lido.", 'red');
                } finally {
                    // Limpa o input de arquivo
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        };


        // --- Fun√ß√µes Auxiliares de UI ---

        // Preenche as op√ß√µes de categoria no filtro e no editor
        const populateCategories = () => {
            const filterEl = document.getElementById('categoryFilter');
            const editorEl = document.getElementById('noteCategory');
            
            // Limpa e adiciona a op√ß√£o "Todas" no filtro
            filterEl.innerHTML = '<option value="">Todas as Categorias</option>';
            
            // Limpa e preenche as op√ß√µes
            editorEl.innerHTML = ''; 

            DEFAULT_CATEGORIES.forEach(cat => {
                const optFilter = document.createElement('option');
                optFilter.value = optFilter.textContent = cat;
                filterEl.appendChild(optFilter);

                const optEditor = document.createElement('option');
                optEditor.value = optEditor.textContent = cat;
                editorEl.appendChild(optEditor);
            });
        };

        // Reseta o editor para o estado de "nova nota"
        const resetEditor = () => {
            currentNoteId = null;
            document.getElementById('noteTitle').value = '';
            // USO DE .innerHTML para limpar o conte√∫do formatado
            document.getElementById('noteContent').innerHTML = ''; 
            document.getElementById('noteCategory').value = 'Geral';
            document.getElementById('noteDate').textContent = 'Nova Nota (n√£o gravada)';
            document.getElementById('deleteNoteBtn').classList.add('hidden');
            
            document.getElementById('editorPlaceholder').classList.add('hidden');
            document.getElementById('noteEditor').classList.remove('hidden');
            
            // Garante que o bot√£o IA esteja inativo ao criar nova nota
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
            
            renderNotes(); // Limpa qualquer destaque na lista
        };

        // Preenche o editor com os dados de uma nota
        const loadNoteToEditor = (note) => {
            currentNoteId = note.id;
            document.getElementById('noteTitle').value = note.title;
            // USO DE .innerHTML para carregar o conte√∫do formatado
            document.getElementById('noteContent').innerHTML = note.content;
            document.getElementById('noteCategory').value = note.category || 'Geral';
            // 'createdAt' √© um timestamp em milissegundos
            document.getElementById('noteDate').textContent = `Criada em: ${formatDate(note.createdAt)}`;
            document.getElementById('deleteNoteBtn').classList.remove('hidden');

            document.getElementById('editorPlaceholder').classList.add('hidden');
            document.getElementById('noteEditor').classList.remove('hidden');
            
            // Garante que o bot√£o IA esteja inativo ao carregar nota (apenas ativa ao selecionar)
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
        };

        // Formata o timestamp (milisegundos) para uma string leg√≠vel
        const formatDate = (timestamp) => {
            if (timestamp) {
                const date = new Date(timestamp);
                return date.toLocaleDateString('pt-PT', { 
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
            }
            return new Date().toLocaleDateString('pt-PT');
        };
        
        // --- Fun√ß√µes de Renderiza√ß√£o e L√≥gica da Aplica√ß√£o ---
        
        // Renderiza a lista de notas com base nos filtros
        const renderNotes = () => {
            const listEl = document.getElementById('notesList');
            const categoryFilter = document.getElementById('categoryFilter').value;
            const dateSearch = document.getElementById('dateSearch').value;
            
            listEl.innerHTML = '';

            let filteredNotes = allNotes;

            // 1. Filtrar por Categoria
            if (categoryFilter) {
                filteredNotes = filteredNotes.filter(note => note.category === categoryFilter);
            }

            // 2. Filtrar por Data (A partir de...)
            if (dateSearch) {
                const searchDate = new Date(dateSearch);
                searchDate.setHours(0, 0, 0, 0); // In√≠cio do dia
                const searchTimestamp = searchDate.getTime();

                filteredNotes = filteredNotes.filter(note => {
                    // note.createdAt √© um timestamp em milissegundos (Date.now())
                    return note.createdAt && note.createdAt >= searchTimestamp;
                });
            }
            
            if (filteredNotes.length === 0) {
                listEl.innerHTML = `<p class="text-center text-gray-500">Nenhuma nota encontrada.</p>`;
                // Certifica-se de que o placeholder est√° escondido se houver notas, ou vis√≠vel se n√£o houver
                if (allNotes.length > 0) {
                     document.getElementById('listPlaceholder').textContent = 'Nenhuma nota correspondente aos filtros.';
                } else {
                     document.getElementById('listPlaceholder').textContent = 'Nenhuma nota ainda. Crie uma!';
                }
                return;
            }

            // 3. Ordenar (Mais recente primeiro) e Renderizar
            filteredNotes.sort((a, b) => b.createdAt - a.createdAt); // Ordena pelo timestamp

            filteredNotes.forEach(note => {
                const noteCard = document.createElement('div');
                // Aplica o estilo de cart√£o iOS para as notas na lista
                noteCard.className = `p-3 note-card-ios cursor-pointer transition duration-150 shadow-md ${note.id === currentNoteId ? 'ring-2 ring-indigo-500' : ''}`;
                
                // Extrai texto puro da nota para pr√©-visualiza√ß√£o, removendo tags HTML
                const previewText = note.content.replace(/<[^>]*>/g, '').substring(0, 100).trim();

                noteCard.innerHTML = `
                    <h3 class="text-base font-semibold truncate text-gray-800">${note.title || 'Nota Sem T√≠tulo'}</h3>
                    <p class="text-xs text-gray-500 mt-1">
                        ${note.category} ‚Ä¢ ${formatDate(note.createdAt)}
                    </p>
                    <p class="text-sm text-gray-600 mt-2 line-clamp-2">${previewText}...</p>
                `;
                noteCard.onclick = () => {
                    loadNoteToEditor(note);
                    renderNotes(); // Atualiza o destaque na lista
                };
                listEl.appendChild(noteCard);
            });

            document.getElementById('listPlaceholder').textContent = allNotes.length === 0 ? 'Nenhuma nota ainda. Crie uma!' : '';
        };

        // Guarda ou Atualiza a nota no array e no LocalStorage
        const saveNote = () => {
            const title = document.getElementById('noteTitle').value.trim() || 'Nota Sem T√≠tulo';
            // USO DE .innerHTML para obter o conte√∫do formatado
            const content = document.getElementById('noteContent').innerHTML.trim(); 
            const category = document.getElementById('noteCategory').value;
            
            // Verifica se o conte√∫do est√° realmente vazio (pode conter tags HTML, ent√£o verifica o texto puro)
            const textContent = content.replace(/<[^>]*>/g, '').trim();

            if (!textContent) {
                alertMessage("O conte√∫do da nota n√£o pode estar vazio!", 'red');
                return;
            }

            const now = Date.now();
            
            if (currentNoteId) {
                // Atualiza nota existente
                const index = allNotes.findIndex(n => n.id === currentNoteId);
                if (index !== -1) {
                    allNotes[index] = {
                        ...allNotes[index],
                        title: title,
                        content: content,
                        category: category,
                        updatedAt: now,
                    };
                }
                alertMessage("Nota atualizada com sucesso!", 'green');
            } else {
                // Cria nova nota
                const newNote = {
                    id: crypto.randomUUID(),
                    title: title,
                    content: content,
                    category: category,
                    createdAt: now,
                    updatedAt: now,
                };
                allNotes.push(newNote);
                currentNoteId = newNote.id; // Define o ID da nota rec√©m-criada
                alertMessage("Nota criada com sucesso!", 'green');
            }

            saveNotesToLocalStorage();
            renderNotes(); // Recarrega e ordena a lista
        };

        // Exclui a nota do array e do LocalStorage
        const deleteNote = () => {
            if (!currentNoteId) return;

            if (!confirmAction("Tem certeza que deseja excluir esta nota? Esta a√ß√£o √© irrevers√≠vel.")) {
                return;
            }

            // Filtra todas as notas, mantendo apenas as que n√£o t√™m o ID atual
            allNotes = allNotes.filter(n => n.id !== currentNoteId);
            saveNotesToLocalStorage();
            
            // Limpa o editor e mostra o placeholder
            resetEditor();
            document.getElementById('noteEditor').classList.add('hidden');
            document.getElementById('editorPlaceholder').classList.remove('hidden');
            
            alertMessage("Nota exclu√≠da com sucesso!", 'yellow');
            renderNotes();
        };


        // --- Funcionalidade de IA e Mensagens Personalizadas ---

        // Substitui o alert/confirm nativo por uma fun√ß√£o customizada
        const alertMessage = (message, color) => {
             console.log(`[Mensagem ${color.toUpperCase()}]: ${message}`);
             const statusEl = document.getElementById('noteDate');
             const originalText = statusEl.textContent;
             
             statusEl.classList.remove('text-gray-500', 'text-green-600', 'text-red-600', 'text-yellow-600', 'text-indigo-600'); 
             
             statusEl.textContent = message;
             
             const colorMap = { 'green': 'text-green-600', 'red': 'text-red-600', 'yellow': 'text-yellow-600' };
             statusEl.classList.add(colorMap[color] || 'text-indigo-600');
             
             setTimeout(() => {
                statusEl.textContent = originalText;
                statusEl.classList.remove(...Object.values(colorMap));
                statusEl.classList.add('text-gray-500');
             }, 3000);
        };

        const confirmAction = (message) => {
            // Usa o alert/confirm nativo, pois a implementa√ß√£o de modal √© complexa
            return window.confirm(message); 
        }
        
        // --- Fun√ß√µes de Formata√ß√£o de Texto (Editor B√°sico) ---
        
        // Fun√ß√£o utilit√°ria para focar o editor ap√≥s a execu√ß√£o do comando
        const focusEditor = () => {
            document.getElementById('noteContent').focus();
        };

        const handleBold = () => {
            document.execCommand('bold', false, null);
            focusEditor();
        };

        const handleList = () => {
            document.execCommand('insertUnorderedList', false, null);
            focusEditor();
        };

        const handleHeading = () => {
            // Usa formatBlock para aplicar H2
            document.execCommand('formatBlock', false, 'H2');
            focusEditor();
        };

        // NOVO: Aplica linha separadora
        const handleSeparator = () => {
            document.execCommand('insertHorizontalRule', false, null);
            focusEditor();
        };

        // NOVO: Aplica link (hyperlink)
        const handleLink = () => {
            const url = window.prompt("Insira o URL para o link:");
            
            if (url && url.trim() !== "") {
                // Adiciona 'http://' se n√£o houver protocolo
                const fullUrl = url.startsWith('http') ? url : `http://${url}`;
                
                // Cria o link
                document.execCommand('createLink', false, fullUrl);
                
                // Como document.execCommand n√£o define target="_blank" nativamente,
                // vamos tentar selecionar o link rec√©m-criado e adicionar o atributo.
                // Isso √© complexo e n√£o 100% garantido, mas √© a melhor tentativa em contenteditable.
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    // Procura o elemento <a> pai da sele√ß√£o/range
                    let linkElement = range.commonAncestorContainer;
                    while (linkElement && linkElement.tagName !== 'A') {
                        linkElement = linkElement.parentNode;
                    }
                    if (linkElement && linkElement.tagName === 'A') {
                        linkElement.setAttribute('target', '_blank');
                    }
                }
            }
            focusEditor();
        };

        // NOVO: Fun√ß√£o de Impress√£o
        const handlePrint = () => {
            // Usa a fun√ß√£o nativa de impress√£o do navegador
            window.print();
        };


        // Trata o texto selecionado e abre a pesquisa do Google AI
        const handleIaSearch = (event) => {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            if (!selectedText || document.getElementById('iaFloatingButton').classList.contains('ia-button-inactive')) {
                // Previne a execu√ß√£o se o bot√£o estiver inativo/n√£o houver sele√ß√£o v√°lida
                alertMessage("Selecione um texto antes de usar a IA.", 'yellow');
                return;
            }
            
            // O prompt predefinido + o texto selecionado
            const query = IA_PROMPT + selectedText;
            const encodedQuery = encodeURIComponent(query);
            
            // URL com o modo IA (udm=50)
            const googleUrl = `https://www.google.com/search?udm=50&q=${encodedQuery}`;
            
            window.open(googleUrl, '_blank');
            
            // Oculta o bot√£o flutuante ap√≥s a a√ß√£o
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
        };

        // Exibe ou move o bot√£o flutuante com base na sele√ß√£o de texto
        const checkSelection = () => {
            const editor = document.getElementById('noteContent');
            const iaButton = document.getElementById('iaFloatingButton');
            const selection = window.getSelection();

            // 1. Verifica se h√° sele√ß√£o e se ela est√° dentro do editor
            if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
                const selectedText = selection.toString().trim();

                if (selectedText.length > 0) {
                    // Texto selecionado: Ativa o bot√£o
                    iaButton.classList.remove('ia-button-inactive');
                    return;
                }
            }

            // Sem sele√ß√£o v√°lida: Desativa o bot√£o
            iaButton.classList.add('ia-button-inactive');
        };

        // --- Inicializa√ß√£o e Event Listeners ---

        const initializeApp = () => {
            loadNotesFromLocalStorage();
            populateCategories();
            renderNotes();
            // Garante que o bot√£o IA comece inativo
            document.getElementById('iaFloatingButton').classList.add('ia-button-inactive');
            // Remove o indicador de loading, pois o carregamento √© instant√¢neo
            document.getElementById('loading').classList.add('hidden');
        };

        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Listeners existentes
        document.getElementById('newNoteBtn').addEventListener('click', resetEditor);
        document.getElementById('saveNoteBtn').addEventListener('click', saveNote);
        document.getElementById('deleteNoteBtn').addEventListener('click', deleteNote);
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            currentNoteId = null;
            document.getElementById('noteEditor').classList.add('hidden');
            document.getElementById('editorPlaceholder').classList.remove('hidden');
            renderNotes();
        });

        // Listeners para filtrar a lista
        document.getElementById('categoryFilter').addEventListener('change', renderNotes);
        document.getElementById('dateSearch').addEventListener('change', renderNotes);
        
        // Listeners para os bot√µes de formata√ß√£o (agora no JS)
        document.getElementById('boldBtn').addEventListener('click', (e) => { e.preventDefault(); handleBold(); });
        document.getElementById('listBtn').addEventListener('click', (e) => { e.preventDefault(); handleList(); });
        document.getElementById('headingBtn').addEventListener('click', (e) => { e.preventDefault(); handleHeading(); });
        
        // NOVO: Listeners para as novas fun√ß√µes
        document.getElementById('separatorBtn').addEventListener('click', (e) => { e.preventDefault(); handleSeparator(); });
        document.getElementById('linkBtn').addEventListener('click', (e) => { e.preventDefault(); handleLink(); });
        document.getElementById('printBtn').addEventListener('click', (e) => { e.preventDefault(); handlePrint(); });

        // Listeners para a funcionalidade IA:
        document.getElementById('noteContent').addEventListener('mouseup', checkSelection);
        document.getElementById('noteContent').addEventListener('keyup', checkSelection);
        document.getElementById('noteContent').addEventListener('blur', () => { setTimeout(checkSelection, 100); });
        document.getElementById('iaFloatingButton').addEventListener('click', handleIaSearch);
        
        // Listeners para Exportar/Importar
        document.getElementById('exportBtn').addEventListener('click', handleExport);
        document.getElementById('importFile').addEventListener('change', handleImport);

    </script>
</body>
</html>
