<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sucedoan Painel - v35 (Paste + Badges + Zoom Fino)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- 1. VARIÁVEIS E RESET --- */
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* --- 2. CABEÇALHO (HEADER) --- */
        header {
            background: #020617;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            gap: 15px;
            flex-shrink: 0;
        }

        .brand {
            font-weight: 900;
            font-size: 18px;
            color: white;
            margin-right: auto;
            letter-spacing: -0.5px;
        }
        .brand span { color: var(--accent); }

        .nav-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #cbd5e1;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-btn.config {
            color: var(--warning);
            border-color: rgba(245, 158, 11, 0.3);
        }

        /* --- 3. ÁREAS DE VISUALIZAÇÃO (ABAS) --- */
        .view-section {
            display: none;
            flex-grow: 1;
            overflow: hidden;
            flex-direction: column;
        }
        .view-section.active {
            display: flex;
        }

        /* --- 4. BARRA DE FERRAMENTAS --- */
        .toolbar {
            padding: 12px 24px;
            display: flex;
            gap: 12px;
            background: #0f172a;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            align-items: center;
        }

        .search-container {
            flex-grow: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 10px 10px 10px 36px;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        .search-input:focus { border-color: var(--accent); }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 10px;
            color: #64748b;
            width: 16px;
        }

        #total-count {
            font-size: 11px;
            color: #94a3b8;
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }

        /* --- 5. GRID DE PRODUTOS --- */
        .product-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            align-content: start;
        }

        .card {
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border);
            transition: transform 0.2s;
            min-height: 420px;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            z-index: 10;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
        }

        /* Imagem do Card */
        .card-img-area {
            height: 160px;
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
        }

        .img-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            opacity: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            backdrop-filter: blur(2px);
        }
        .card-img-area:hover .img-overlay { opacity: 1; }

        .overlay-btn {
            background: white;
            color: #0f172a;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: 0.2s;
        }
        .overlay-btn:hover {
            transform: scale(1.1);
            background: var(--accent);
            color: white;
        }

        /* Corpo do Card */
        .card-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .card-sku {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card-title-input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            resize: none;
            overflow: hidden;
            min-height: 48px;
            line-height: 1.3;
            border-radius: 4px;
            padding: 4px;
            transition: 0.2s;
        }
        .card-title-input:hover { background: #020617; border-color: #334155; }
        .card-title-input:focus {
            background: #0f172a;
            border-color: var(--accent);
            outline: none;
            min-height: 80px;
        }

        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: auto;
            padding-top: 8px;
        }

        .stat-box { display: flex; flex-direction: column; }
        
        .stat-label {
            font-size: 9px;
            color: var(--accent);
            margin-bottom: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .stat-input {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: white;
            background: #0f172a;
            text-align: center;
        }
        .stat-input:focus { border-color: var(--accent); outline: none; }

        /* Rodapé do Card */
        .card-footer {
            padding: 8px 12px;
            background: #0f172a;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-text:hover { color: white; }

        /* --- 6. TABELA DE HISTÓRICO --- */
        .history-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .history-table th {
            text-align: left;
            padding: 12px;
            background: #020617;
            border-bottom: 2px solid var(--border);
            color: var(--accent);
            text-transform: uppercase;
            font-size: 11px;
            position: sticky;
            top: 0;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: #cbd5e1;
        }
        .history-table tr:hover { background: #1e293b; }

        /* --- 7. MODAIS --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }

        .modal-card {
            background: #1e293b;
            padding: 0;
            border-radius: 12px;
            width: 600px;
            max-width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .modal-header {
            padding: 12px 16px;
            background: #020617;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            color: #cbd5e1;
        }

        .close-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
        }

        .form-group { margin-bottom: 12px; }
        .form-group label {
            display: block;
            font-size: 10px;
            color: var(--accent);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .form-group input {
            width: 100%;
            background: #0f172a;
            border: 1px solid var(--border);
            padding: 8px;
            border-radius: 4px;
            color: white;
            font-size: 12px;
        }

        .btn-full {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            background: var(--accent);
            color: white;
            font-size: 13px;
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">SUCEDOAN <span>PRO</span></div>
        <button class="nav-btn active" onclick="showSection('products', this)">
            <i data-lucide="package" size="14"></i> PRODUTOS
        </button>
        <button class="nav-btn" onclick="showSection('history', this)">
            <i data-lucide="scroll-text" size="14"></i> HISTÓRICO
        </button>
        <div style="flex-grow:1"></div>
        <button class="nav-btn config" onclick="openConfigModal()">
            <i data-lucide="settings" size="14"></i>
        </button>
    </header>

    <div id="section-products" class="view-section active">
        <div class="toolbar">
            <button class="nav-btn primary" onclick="importarBling()">
                <i data-lucide="cloud-download" size="14"></i> BAIXAR BLING
            </button>
            
            <input type="file" id="csv-file" accept=".csv" style="display:none">
            <button class="nav-btn" onclick="document.getElementById('csv-file').click()">
                <i data-lucide="file-spreadsheet" size="14"></i> IMPORTAR CSV
            </button>
            
            <div class="search-container" style="margin-left: 15px;">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" class="search-input" id="search-input" placeholder="Buscar por Nome, Código ou EAN...">
            </div>
            
            <button class="nav-btn" onclick="exportarCSV()">
                <i data-lucide="download" size="14"></i> Exportar
            </button>
            <div id="total-count">0</div>
        </div>
        
        <div class="product-grid" id="product-grid"></div>
    </div>

    <div id="section-history" class="view-section">
        <div class="toolbar">
            <h3 style="margin:0; font-size:14px; color:white;">Histórico de Alterações</h3>
            <button class="nav-btn" onclick="clearHistory()">
                <i data-lucide="trash-2" size="14"></i> Limpar
            </button>
        </div>
        <div class="history-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th width="150">DATA / HORA</th>
                        <th width="120">USUÁRIO</th>
                        <th width="100">SKU</th>
                        <th>PRODUTO</th>
                        <th>AÇÃO / DETALHE</th>
                    </tr>
                </thead>
                <tbody id="history-tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-details" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <span>Detalhes Técnicos</span>
                <button class="close-btn" onclick="closeModal('modal-details')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div id="details-form"></div>
                <button class="btn-full" onclick="saveDetails()">FECHAR E SALVAR</button>
            </div>
        </div>
    </div>

    <div id="modal-config" class="modal-overlay">
        <div class="modal-card" style="width:400px">
            <div class="modal-header"><span>Configuração</span><button class="close-btn" onclick="closeModal('modal-config')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <p style="font-size: 12px; color: var(--text-secondary);">Configurações do sistema e integrações.</p>
                <button class="btn-full" onclick="saveConfig()">SALVAR</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. CONFIGURAÇÕES E DADOS GERAIS
        // ==========================================
        const USERS = {
            "090479": "OSVALDO", "170484": "ANDRE", "098765": "CLAUDENIL",
            "567890": "KELY", "121212": "JOSE", "123456": "ROSINA"
        };

        const STORAGE_KEY = 'sucedoan_data_v26';
        const HISTORY_KEY = 'sucedoan_history';
        
        // DEFINIÇÃO EXATA DAS COLUNAS DO SEU CSV (PARA MANTER A ORDEM NA EXPORTAÇÃO)
        const CSV_COLUMNS_ORDER = [
            "ID", "Código", "Descrição", "Unidade", "NCM", "Origem", "Preço", "Valor IPI fixo",
            "Observações", "Situação", "Estoque", "Preço de custo", "Cód. no fornecedor", "Fornecedor",
            "Localização", "Estoque máximo", "Estoque mínimo", "Peso líquido (Kg)", "Peso bruto (Kg)",
            "GTIN/EAN", "GTIN/EAN da Embalagem", "Largura do produto", "Altura do Produto",
            "Profundidade do produto", "Data Validade", "Descrição do Produto no Fornecedor",
            "Descrição Complementar", "Itens p/ caixa", "Produto Variação", "Tipo Produção",
            "Classe de enquadramento do IPI", "Código na Lista de Serviços", "Tipo do item",
            "Grupo de Tags/Tags", "Tributos", "Código Pai", "Código Integração", "Grupo de produtos",
            "Marca", "CEST", "Volumes", "Descrição Curta", "Cross-Docking", "URL Imagens Externas",
            "Link Externo", "Meses Garantia no Fornecedor", "Clonar dados do pai", "Condição do Produto",
            "Frete Grátis", "Número FCI", "Vídeo", "Departamento", "Unidade de Medida", "Preço de Compra",
            "Valor base ICMS ST para retenção", "Valor ICMS ST para retenção", "Valor ICMS próprio do substituto",
            "Categoria do produto", "Informações Adicionais"
        ];

        // CAMPOS QUE FICAM NO CARD (O RESTANTE VAI PARA O MODAL)
        const CARD_FIELDS = ["Descrição", "GTIN/EAN", "Preço", "Código", "Estoque", "Fornecedor", "Data Validade"];

        let products = [];
        let historyLog = [];
        let currentEditingId = null;

        // ==========================================
        // 2. INICIALIZAÇÃO
        // ==========================================
        window.onload = function() {
            lucide.createIcons();
            loadData();
            
            // Listener para o input de busca
            document.getElementById('search-input').addEventListener('input', (e) => renderGrid(e.target.value));
            
            // Listener para o input de arquivo CSV
            document.getElementById('csv-file').addEventListener('change', handleFileSelect, false);
        };

        function showSection(id, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            if(btn) {
                document.querySelectorAll('header .nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            if(id === 'history') renderHistory();
        }

        // ==========================================
        // 3. MANIPULAÇÃO DE DADOS (IMPORT/EXPORT)
        // ==========================================
        
        // Função para ler o arquivo CSV selecionado
        function handleFileSelect(evt) {
            const file = evt.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                delimiter: ";", // Força o delimitador ;
                encoding: "UTF-8", // Tente ISO-8859-1 se os acentos ficarem estranhos
                skipEmptyLines: true,
                complete: function(results) {
                    // Filtra apenas linhas que tenham dados válidos e mapeia para garantir todas as colunas
                    products = results.data.map(row => {
                        const cleanRow = {};
                        // Garante que todas as colunas existam, mesmo que vazias
                        CSV_COLUMNS_ORDER.forEach(col => {
                            cleanRow[col] = row[col] || "";
                        });
                        return cleanRow;
                    });

                    saveData();
                    renderGrid();
                    alert(`Importado com sucesso! ${products.length} produtos.`);
                },
                error: function(err) {
                    alert("Erro ao ler CSV: " + err.message);
                }
            });
        }

        // Exportação Idêntica ao CSV original
        function exportarCSV() {
            if (!products.length) {
                alert("Sem dados para exportar.");
                return;
            }

            // Garante a ordem das colunas
            const dataToExport = products.map(p => {
                let orderedObj = {};
                CSV_COLUMNS_ORDER.forEach(col => {
                    orderedObj[col] = p[col];
                });
                return orderedObj;
            });

            const csv = Papa.unparse(dataToExport, {
                delimiter: ";",
                quotes: true // Adiciona aspas em todos os campos conforme o original
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            // Gera um nome de arquivo com data
            const date = new Date().toISOString().slice(0,19).replace(/:/g,"-");
            link.setAttribute("download", `produtos_export_${date}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==========================================
        // 4. RENDERIZAÇÃO (CARD E GRID)
        // ==========================================
        function renderGrid(filter = "") {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = "";
            
            const term = filter.toLowerCase();
            
            // Filtra os produtos
            const filtered = products.filter(p => {
                return (p["Descrição"]?.toLowerCase().includes(term) || 
                        p["Código"]?.toLowerCase().includes(term) || 
                        p["GTIN/EAN"]?.toLowerCase().includes(term));
            });

            document.getElementById('total-count').innerText = filtered.length;

            // Renderiza cada card
            filtered.forEach((p, index) => {
                // Tenta pegar a imagem, se não tiver usa placeholder
                const imgUrl = p["URL Imagens Externas"] && p["URL Imagens Externas"].length > 10 
                               ? p["URL Imagens Externas"] 
                               : 'https://placehold.co/300x300?text=Sem+Imagem';

                const card = document.createElement('div');
                card.className = 'card';
                
                // HTML do Card com inputs editáveis
                card.innerHTML = `
                    <div class="card-img-area" onclick="openEditModal('${p["ID"]}')">
                        <img src="${imgUrl}" class="card-img" loading="lazy">
                        <div class="img-overlay">
                            <button class="overlay-btn"><i data-lucide="zoom-in"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card-sku">${p["Código"] || "SEM COD"}</div>
                        
                        <textarea class="card-title-input" rows="2" 
                            onchange="updateProduct('${p["ID"]}', 'Descrição', this.value)">${p["Descrição"] || ""}</textarea>

                        <div class="card-stats" style="grid-template-columns: 1fr 1fr; gap: 5px;">
                            <div class="stat-box">
                                <span class="stat-label">Preço</span>
                                <input class="stat-input" value="${p["Preço"]}" 
                                    onchange="updateProduct('${p["ID"]}', 'Preço', this.value)">
                            </div>
                            
                            <div class="stat-box">
                                <span class="stat-label">Estoque</span>
                                <input class="stat-input" value="${p["Estoque"]}" 
                                    onchange="updateProduct('${p["ID"]}', 'Estoque', this.value)">
                            </div>

                            <div class="stat-box">
                                <span class="stat-label">EAN</span>
                                <input class="stat-input" value="${p["GTIN/EAN"]}" 
                                    onchange="updateProduct('${p["ID"]}', 'GTIN/EAN', this.value)">
                            </div>

                            <div class="stat-box">
                                <span class="stat-label">Validade</span>
                                <input class="stat-input" value="${p["Data Validade"]}" 
                                    onchange="updateProduct('${p["ID"]}', 'Data Validade', this.value)">
                            </div>
                        </div>
                        
                        <div class="stat-box" style="margin-top: 5px;">
                            <span class="stat-label">Fornecedor</span>
                            <input class="stat-input" style="text-align:left;" value="${p["Fornecedor"]}" 
                                onchange="updateProduct('${p["ID"]}', 'Fornecedor', this.value)">
                        </div>

                    </div>
                    <div class="card-footer">
                        <button class="btn-text" onclick="openEditModal('${p["ID"]}')">
                            <i data-lucide="edit-3" size="14"></i> + DETALHES
                        </button>
                    </div>
                `;
                grid.appendChild(card);
            });
            
            lucide.createIcons();
        }

        // Atualiza um campo específico de um produto
        function updateProduct(id, field, value) {
            const product = products.find(p => p["ID"] === id);
            if (product) {
                product[field] = value;
                saveData(); // Salva no LocalStorage
            }
        }

        // ==========================================
        // 5. MODAL DE DETALHES
        // ==========================================
        function openEditModal(id) {
            const product = products.find(p => p["ID"] === id);
            if(!product) return;

            currentEditingId = id;
            const formContainer = document.getElementById('details-form');
            formContainer.innerHTML = "";

            // Percorre todas as colunas possíveis
            CSV_COLUMNS_ORDER.forEach(key => {
                // Se o campo NÃO estiver no card, adiciona no modal
                if (!CARD_FIELDS.includes(key)) {
                    const group = document.createElement('div');
                    group.className = 'form-group';
                    
                    // Label
                    const label = document.createElement('label');
                    label.innerText = key;
                    
                    // Input
                    const input = document.createElement('input');
                    input.type = "text";
                    input.value = product[key] || "";
                    
                    // Evento para salvar ao digitar/sair
                    input.onchange = function() {
                        product[key] = this.value;
                        saveData();
                    };

                    group.appendChild(label);
                    group.appendChild(input);
                    formContainer.appendChild(group);
                }
            });

            // Mostra o modal
            document.getElementById('modal-details').style.display = 'flex';
        }

        function saveDetails() {
            // Como usamos onchange nos inputs do modal, os dados já estão no objeto
            saveData();
            renderGrid(document.getElementById('search-input').value); // Atualiza grid
            closeModal('modal-details');
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // ==========================================
        // 6. PERSISTÊNCIA E HISTÓRICO
        // ==========================================
        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                try {
                    products = JSON.parse(stored);
                    renderGrid();
                } catch(e) { console.error("Erro ao carregar dados", e); }
            }
            
            const hist = localStorage.getItem(HISTORY_KEY);
            if(hist) historyLog = JSON.parse(hist);
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
        }

        function clearHistory() {
            if(confirm("Apagar todo o histórico?")) {
                historyLog = [];
                localStorage.setItem(HISTORY_KEY, '[]');
                renderHistory();
            }
        }

        function renderHistory() {
            const tbody = document.getElementById('history-tbody');
            if(!tbody) return;
            tbody.innerHTML = historyLog.map(h => `
                <tr>
                    <td>${h.date}</td>
                    <td>${h.user}</td>
                    <td>${h.sku}</td>
                    <td>${h.name}</td>
                    <td>${h.action}</td>
                </tr>
            `).join('');
        }

        // ==========================================
        // 7. FUNÇÕES AUXILIARES / PLACEHOLDERS
        // ==========================================
        function importarBling() { alert("Funcionalidade configurada para Importar CSV localmente nesta versão."); }
        function openConfigModal() { document.getElementById('modal-config').style.display = 'flex'; }
        function saveConfig() { closeModal('modal-config'); alert("Configuração salva (Simulação)"); }
        function restaurarLinksPadraoSite() { alert("Função não aplicável nesta estrutura de CSV"); }
        
    </script>
</body>
</html>
