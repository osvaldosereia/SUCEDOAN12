<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Dona Antonia - Produ√ß√£o Integrada v3</title>

    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0052cc;
            --success: #22c55e;
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f8fafc;
            --accent: #38bdf8;
            --bling-color: #f59e0b;
            --nav-height: 80px;
        }

        /* Reset e Travamento de Scroll */
        html, body { 
            height: 100%; margin: 0; overflow: hidden; 
            font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main);
        }

        /* BARRA DE NAVEGA√á√ÉO SUPERIOR */
        .global-nav {
            height: var(--nav-height); background: #000; display: flex; align-items: center; 
            padding: 0 20px; gap: 8px; border-bottom: 3px solid var(--accent); z-index: 1000; position: relative;
        }

        .nav-btn {
            height: 48px; padding: 0 15px; border-radius: 8px; border: 2px solid #334155;
            background: #1e293b; color: white; font-weight: 800; cursor: pointer;
            text-decoration: none; font-size: 11px; transition: all 0.2s; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }

        .nav-btn:hover { border-color: var(--accent); background: #334155; }
        .nav-btn.active { background: var(--primary); border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 82, 204, 0.4); }
        .nav-btn.bling { background: #f59e0b; color: #000; border-color: #d97706; }
        .nav-btn.new-order { background: #ef4444 !important; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* CONTAINERS DE CONTE√öDO */
        .view-pane { width: 100%; height: calc(100vh - var(--nav-height)); display: none; overflow-y: auto; }
        .view-pane.active { display: block; }
        .view-pane iframe { width: 100%; height: 100%; border: none; background: white; }

        /* ESTILOS DA ABA PRODU√á√ÉO */
        .app-container { padding: 15px; height: 100%; display: flex; flex-direction: column; box-sizing: border-box; }
        #search-field { 
            width: 100%; padding: 16px; border-radius: 10px; border: 3px solid var(--accent); 
            font-size: 20px; font-weight: 700; outline: none; margin-bottom: 10px; background: white; color: black;
        }
        #product-table { flex-grow: 1; border-radius: 12px; overflow: hidden; font-size: 13px; background: var(--card); }

        /* BOT√ïES DE A√á√ÉO */
        .action-btn { 
            border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; 
            font-weight: bold; font-size: 10px; margin-right: 2px; text-transform: uppercase; 
        }
        .btn-copy { background: #64748b; color: white; }
        .btn-link { background: var(--primary); color: white; }
        .btn-sync { background: var(--bling-color); color: black; border: 1px solid #d97706; }
        .btn-sync:hover { background: #fffbeb; }

        /* HEADER DOS BOT√ïES */
        .btn-header {
            padding: 10px; cursor: pointer; font-weight: bold; border-radius: 8px; border: none; font-size: 12px;
        }
        .btn-header.csv { background: #334155; color: white; }
        .btn-header.export { background: var(--success); color: white; }
        .btn-header.import-bling { background: var(--bling-color); color: black; margin-right: 10px; }

        /* MODAL FLUTUANTE DIREITO */
        #side-modal {
            position: fixed; top: calc(var(--nav-height) + 10px); right: 10px;
            width: 420px; height: calc(100vh - var(--nav-height) - 30px);
            background: white; border-radius: 15px; border: 4px solid var(--accent);
            box-shadow: -5px 0 25px rgba(0,0,0,0.5); z-index: 2000;
            display: none; flex-direction: column; overflow: hidden;
        }

        #side-modal header {
            background: var(--accent); color: black; padding: 10px;
            display: flex; justify-content: space-between; align-items: center; font-weight: bold;
        }

        #side-modal .close-modal {
            background: #ef4444; color: white; border: none; padding: 5px 10px; 
            border-radius: 5px; cursor: pointer; font-size: 12px;
        }

        #side-iframe { flex-grow: 1; border: none; }

        /* LISTA DE PEDIDOS */
        .order-card { 
            background: var(--card); border-radius: 12px; margin: 15px; padding: 20px; 
            border-left: 10px solid var(--accent); display: flex; justify-content: space-between; align-items: center; 
        }
        .btn-print { 
            background: var(--success); color: white; padding: 15px 25px; 
            border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; 
        }

        /* LOADER */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000; display: none;
            justify-content: center; align-items: center; color: white; flex-direction: column;
        }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* IMPRESS√ÉO */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 80mm; color: black; }
        }
        #print-section { display: none; background: white; padding: 10px; color: black; }
    </style>
</head>
<body>

    <script>
        // --- CONFIGURA√á√ÉO DOS WEBHOOKS DO MAKE ---
        
        // 1. Cole aqui o Webhook do cen√°rio NOVO (Get All Products)
        const MAKE_WEBHOOK_GET_PRODUCTS = "COLE_AQUI_SEU_WEBHOOK_GET"; 
        
        // 2. Cole aqui o Webhook do cen√°rio ATUAL (Update Product)
        const MAKE_WEBHOOK_UPDATE_PRODUCT = "https://hook.eu1.make.com/kvi7j1d7wsmrskoemdn86ykscenumt67";
    </script>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Processando...</div>
    </div>

    <audio id="bell-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <nav class="global-nav">
        <div style="color: var(--accent); font-weight: 900; font-size: 16px; margin-right: 10px;">DONA ANTONIA</div>
        
        <button class="nav-btn active" id="btn-producao" onclick="showView('producao', this)">üõ† PRODU√á√ÉO</button>
        <button class="nav-btn" id="btn-pedidos-nav" onclick="showView('pedidos', this)">üì¶ PEDIDOS</button>
        
        <a href="https://www.bling.com.br/vendas.checkout.php" target="_blank" class="nav-btn bling">üí∞ BLING</a>
        
        <button class="nav-btn" id="btn-editor" onclick="showView('editor', this)">üì∏ EDITOR FOTO</button>
        <button class="nav-btn" id="btn-loja" onclick="showView('loja', this)">üõí LOJA</button>
        <button class="nav-btn" id="btn-nota" onclick="showView('nota', this)">üìù CADASTRAR NOTA</button>
    </nav>

    <div id="view-producao" class="view-pane active">
        <div class="app-container">
            <header style="display:flex; gap:10px; flex-wrap: wrap;">
                <input type="text" id="search-field" placeholder="üîé ESCANEAR C√ìDIGO OU BUSCAR PRODUTO..." autofocus style="flex-grow: 1;">
                
                <button onclick="importarDoBling()" class="btn-header import-bling">‚òÅ BAIXAR TUDO DO BLING</button>
                
                <input type="file" id="csv-file" accept=".csv" style="display:none">
                <button onclick="document.getElementById('csv-file').click()" class="btn-header csv">üìÇ SUBIR CSV</button>
                <button id="btn-export" class="btn-header export">‚¨á EXPORTAR CSV</button>
            </header>
            <div id="product-table"></div>
        </div>
    </div>

    <div id="side-modal">
        <header>
            <span>REFER√äNCIA DE IMAGEM</span>
            <button class="close-modal" onclick="closeSideModal()">FECHAR [X]</button>
        </header>
        <iframe id="side-iframe" src=""></iframe>
    </div>

    <div id="view-pedidos" class="view-pane">
        <div id="lista-pedidos-container">
            <h2 style="padding: 20px;">Separa√ß√£o de Pedidos (Cupom 80mm)</h2>
            <div id="pedidos-placeholder" style="padding: 20px; opacity: 0.5;">Aguardando novos pedidos...</div>
        </div>
    </div>

    <div id="view-editor" class="view-pane"><iframe id="iframe-editor" src="https://donaantonia.com.br/bio/"></iframe></div>
    <div id="view-loja" class="view-pane"><iframe src="https://donaantonia.com.br/site/"></iframe></div>
    <div id="view-nota" class="view-pane"><iframe src="https://donaantonia.com.br/produtos/"></iframe></div>

    <div id="print-section"></div>

    <script>
        var table;
        var pedidosProcessados = [];
        const STORAGE_KEY = 'sucedoan_kiosk_data_v3'; 

        // --- GEST√ÉO DO MODAL E LOADER ---

        function toggleLoader(show, text="Processando...") {
            const el = document.getElementById('loading-overlay');
            document.getElementById('loading-text').innerText = text;
            el.style.display = show ? 'flex' : 'none';
        }

        function openSideModal(query) {
            const modal = document.getElementById('side-modal');
            const iframe = document.getElementById('side-iframe');
            iframe.src = "https://www.bing.com/images/search?q=" + encodeURIComponent(query) + "&first=1";
            modal.style.display = 'flex';
        }

        function closeSideModal() {
            document.getElementById('side-modal').style.display = 'none';
            document.getElementById('side-iframe').src = '';
        }

        // --- INTEGRA√á√ÉO MAKE/BLING ---

        async function importarDoBling() {
            if(!confirm("Tem certeza? Isso vai carregar a lista oficial do Bling e atualizar a tabela.")) return;
            
            if(MAKE_WEBHOOK_GET_PRODUCTS.includes("COLE_AQUI")) {
                alert("ERRO: Voc√™ precisa criar o Cen√°rio de Busca no Make e colar o link no c√≥digo.");
                return;
            }

            toggleLoader(true, "Baixando lista completa do Bling...");
            
            try {
                const response = await fetch(MAKE_WEBHOOK_GET_PRODUCTS);
                const data = await response.json();
                
                if(Array.isArray(data)) {
                    // Mapeamento de seguran√ßa
                    const dadosMapeados = data.map(d => ({
                        codigo: d.codigo || "",
                        nome: d.nome || "",
                        situacao: d.situacao || "A",
                        formato: d.formato || "S",
                        preco: d.preco || 0,
                        unidade: d.unidade || "UN",
                        pesoBruto: d.pesoBruto || 0,
                        pesoLiquido: d.pesoLiquido || 0,
                        gtin: d.gtin || "",
                        ncm: d.ncm || "",
                        cest: d.cest || "",
                        estoque: d.estoque || 0,
                        localizacao: d.localizacao || "",
                        url_imagem: d.url_imagem || ""
                    }));

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dadosMapeados));
                    table.setData(dadosMapeados);
                    alert("Sucesso! " + dadosMapeados.length + " produtos carregados.");
                } else {
                    alert("Erro: O Make n√£o retornou uma lista v√°lida.");
                    console.log(data);
                }
            } catch (error) {
                alert("Erro ao conectar com o Make. Verifique se o cen√°rio 'GET' est√° ativo.");
                console.error(error);
            } finally {
                toggleLoader(false);
            }
        }

       async function sincronizarProdutoUnitario(rowData, btnElement) {
            const limparTexto = (texto) => {
                if (!texto) return "";
                return texto.toString().replace(/[\r\n]+/g, "").trim();
            };

            const textoOriginal = btnElement.innerText;
            btnElement.innerText = "‚è≥ Enviando...";
            btnElement.disabled = true;

            try {
                const payload = {
                    codigo: limparTexto(rowData["codigo"]),
                    nome: limparTexto(rowData["nome"]),
                    situacao: rowData["situacao"] || "A",
                    formato: rowData["formato"] || "S",
                    
                    preco: rowData["preco"],
                    unidade: rowData["unidade"],
                    pesoBruto: rowData["pesoBruto"],
                    pesoLiquido: rowData["pesoLiquido"],
                    
                    ncm: rowData["ncm"],
                    cest: rowData["cest"],
                    gtin: rowData["gtin"],
                    
                    estoque: rowData["estoque"],
                    localizacao: rowData["localizacao"],
                    
                    url_imagem: limparTexto(rowData["url_imagem"])
                };

                const response = await fetch(MAKE_WEBHOOK_UPDATE_PRODUCT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(response.ok) {
                    btnElement.innerText = "‚úÖ Salvo";
                    btnElement.parentElement.style.backgroundColor = "#dcfce7";
                    setTimeout(() => { 
                        btnElement.innerText = textoOriginal; 
                        btnElement.disabled = false;
                        btnElement.parentElement.style.backgroundColor = "";
                    }, 2000);
                } else {
                    throw new Error("Erro na resposta do Make");
                }

            } catch (error) {
                alert("Erro ao atualizar produto.");
                console.error(error);
                btnElement.innerText = "‚ùå Erro";
                btnElement.disabled = false;
            }
        }

        // --- AUXILIARES ---

        function slugify(text) {
            if (!text) return "";
            return text.toString().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') 
                .replace(/[^\w\s-]/g, '') 
                .replace(/\s+/g, '-') 
                .replace(/--+/g, '-') 
                .trim();
        }

        function imprimirPedido(pedido) {
            const printArea = document.getElementById('print-section');
            printArea.innerHTML = `
                <div style="text-align:center; font-weight:bold; font-size:16px;">DONA ANTONIA</div>
                <hr>
                <div><b>PEDIDO:</b> #${pedido.numero}</div>
                <div><b>CLIENTE:</b> ${pedido.cliente}</div>
                <hr>
                ${pedido.itens.map(i => `<div>${i.quantidade}x ${i.descricao}</div>`).join('')}
                <hr>
                <div style="text-align:center; font-size:10px;">Sistema Sucedoan</div>
            `;
            window.print();
        }

        // --- TABELA ---

        function initTable(data) {
            table = new Tabulator("#product-table", {
                data: data,
                layout: "fitColumns",
                height: "100%",
                clipboard:true, 
                columns: [
                    {title: "A√á√ïES", width: 100, headerSort: false, frozen:true, formatter: () => "<button class='action-btn btn-sync' style='width:100%'>‚òÅ SALVAR</button>", hozAlign:"center", cellClick: (e, cell) => {
                        sincronizarProdutoUnitario(cell.getData(), e.target);
                    }},
                    
                    {title: "SKU", field: "codigo", width: 90, headerFilter:"input"},
                    {title: "NOME (DESCRI√á√ÉO)", field: "nome", widthGrow: 2, editor: "input", headerFilter:"input"},
                    
                    {title: "IMAGEM", field: "url_imagem", width: 100, editor: "input", formatter: "link", formatterParams:{label:"Ver", target:"_blank"}},
                    {title: "üîç", width: 40, hozAlign: "center", headerSort:false, formatter: () => "üîç", cellClick: (e, cell) => {
                        openSideModal(cell.getData()["nome"]);
                    }},
                    
                    {title: "R$ PRE√áO", field: "preco", width: 90, editor: "number", hozAlign:"right"},
                    {title: "UN", field: "unidade", width: 60, editor: "input", hozAlign:"center"},
                    {title: "SIT", field: "situacao", width: 60, editor: "input", hozAlign:"center"},
                    
                    {title: "ESTOQUE", field: "estoque", width: 90, editor: "number", hozAlign: "center", formatter:"prop", formatterParams:{fontWeight:"bold"}},
                    {title: "LOCAL", field: "localizacao", width: 100, editor: "input"},

                    {title: "NCM", field: "ncm", width: 90, editor: "input"},
                    {title: "CEST", field: "cest", width: 90, editor: "input"},
                    {title: "GTIN/EAN", field: "gtin", width: 110, editor: "input"},
                    {title: "PESO LIQ", field: "pesoLiquido", width: 90, editor: "number"},
                    {title: "PESO BRU", field: "pesoBruto", width: 90, editor: "number"},
                    
                    {title: "EDITOR", headerSort:false, formatter: () => "<button class='action-btn btn-copy'>FOTO</button>", width: 70, cellClick: (e, cell) => {
                        const slug = slugify(cell.getData()["nome"]);
                        navigator.clipboard.writeText(slug); 
                        document.getElementById('iframe-editor').src = "https://donaantonia.com.br/bio/?nome=" + slug;
                        showView('editor', document.getElementById('btn-editor'));
                    }},
                ],
                cellEdited: () => localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData()))
            });

            document.getElementById("search-field").addEventListener("input", (e) => {
                const val = e.target.value;
                table.setFilter([[{field:"codigo", type:"like", value:val}, {field:"nome", type:"like", value:val}]]);
            });
        }

        // --- PEDIDOS ---

        async function fetchOrders() {
            try {
                const response = await fetch('pedidos.json?t=' + Date.now());
                const orders = await response.json();
                let temNovidade = false;
                orders.forEach(o => {
                    if(!pedidosProcessados.includes(o.id)) {
                        pedidosProcessados.push(o.id);
                        temNovidade = true;
                        document.getElementById('pedidos-placeholder').style.display = 'none';
                        const container = document.getElementById('lista-pedidos-container');
                        const card = document.createElement('div');
                        card.className = 'order-card';
                        card.innerHTML = `<div><h3>Pedido #${o.numero} - ${o.cliente}</h3><p>${o.itens.length} itens</p></div><button class="btn-print" onclick='imprimirPedido(${JSON.stringify(o)})'>üñ® IMPRIMIR</button>`;
                        container.prepend(card);
                    }
                });
                if(temNovidade) {
                    document.getElementById('bell-sound').play();
                    document.getElementById('btn-pedidos-nav').classList.add('new-order');
                }
            } catch(e) { }
        }

        // --- NAVEGA√á√ÉO ---

        function showView(viewId, btn) {
            document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            if(btn) {
                btn.classList.add('active');
                btn.classList.remove('new-order');
            }
            if(viewId === 'producao') setTimeout(() => document.getElementById("search-field").focus(), 100);
        }

        window.onload = function() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) initTable(JSON.parse(saved));
            else initTable([]); 
            
            setInterval(fetchOrders, 30000);
            fetchOrders();
            document.getElementById("search-field").focus();
        };

        // --- FUN√á√ÉO DE IMPORTA√á√ÉO CSV CORRIGIDA ---
        document.getElementById('csv-file').addEventListener('change', function(e) {
            Papa.parse(e.target.files[0], {
                header: true, 
                skipEmptyLines: true, 
                encoding: "UTF-8", // Geralmente Bling exporta UTF-8 ou ISO-8859-1. Se der erro de acentua√ß√£o, mude para "ISO-8859-1"
                complete: (results) => {
                    
                    // Fun√ß√£o auxiliar para converter "1.200,50" -> 1200.50
                    const parseNum = (val) => {
                        if (typeof val === 'number') return val;
                        if (!val) return 0;
                        return parseFloat(val.replace(/\./g, '').replace(',', '.')) || 0;
                    };

                    const dadosAdaptados = results.data.map(d => ({
                        // Mapeamento: Coluna CSV do Bling -> Campo Interno do Site
                        codigo: d["C√≥digo"] || d.codigo || "",
                        nome: d["Descri√ß√£o"] || d.nome || "",
                        unidade: d["Unidade"] || d.unidade || "UN",
                        
                        // Situa√ß√£o: Se vier "Ativo" converte para "A" (padr√£o API)
                        situacao: (d["Situa√ß√£o"] === "Ativo" ? "A" : (d["Situa√ß√£o"] === "Inativo" ? "I" : (d["Situa√ß√£o"] || d.situacao || "A"))),
                        
                        preco: parseNum(d["Pre√ßo"] || d.preco),
                        
                        estoque: parseNum(d["Estoque"] || d.estoque),
                        localizacao: d["Localiza√ß√£o"] || d.localizacao || "",
                        
                        pesoLiquido: parseNum(d["Peso l√≠quido (Kg)"] || d.pesoLiquido),
                        pesoBruto: parseNum(d["Peso bruto (Kg)"] || d.pesoBruto),
                        
                        gtin: d["GTIN/EAN"] || d.gtin || "",
                        ncm: d["NCM"] || d.ncm || "",
                        cest: d["CEST"] || d.cest || "", // Adicionado
                        
                        url_imagem: d["URL Imagens Externas"] || d.url_imagem || ""
                    }));

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dadosAdaptados));
                    table.setData(dadosAdaptados);
                    alert("Dados do CSV carregados com sucesso! " + dadosAdaptados.length + " produtos importados.");
                }
            });
        });

        document.getElementById('btn-export').addEventListener('click', function() {
            table.download("csv", "estoque_completo.csv", {delimiter:";"});
        });
    </script>
</body>
</html>
