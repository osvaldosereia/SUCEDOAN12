<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Dona Antonia - Pro v4</title>

    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0052cc;
            --success: #22c55e;
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f8fafc;
            --accent: #38bdf8;
            --nav-height: 70px;
        }

        /* GERAL */
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); }
        
        /* NAV */
        .global-nav { height: var(--nav-height); background: #0b1120; display: flex; align-items: center; padding: 0 20px; gap: 10px; border-bottom: 1px solid #334155; }
        .logo { color: var(--accent); font-weight: 900; font-size: 18px; margin-right: 20px; letter-spacing: -1px; }
        .nav-btn { height: 40px; padding: 0 15px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: #94a3b8; font-weight: 700; cursor: pointer; font-size: 11px; transition: all 0.2s; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
        .nav-btn:hover { background: #334155; color: white; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .nav-btn.config { margin-left: auto; border-color: #f59e0b; color: #f59e0b; }

        /* VIEW */
        .view-pane { width: 100%; height: calc(100vh - var(--nav-height)); display: none; padding: 20px; box-sizing: border-box; }
        .view-pane.active { display: block; }

        /* CONTROLS & TABLE */
        .controls-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        #search-field { flex-grow: 1; padding: 12px; border-radius: 6px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; outline: none; }
        #search-field:focus { border-color: var(--accent); }
        .btn-action { padding: 0 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 12px; text-transform: uppercase; }
        .btn-bling { background: #f59e0b; color: black; }
        .btn-csv { background: #334155; color: white; }
        
        #product-table { height: calc(100% - 60px); border-radius: 8px; overflow: hidden; background: #1e293b; border: 1px solid #334155; }
        .tabulator-row { background: #1e293b; color: #e2e8f0; border-bottom: 1px solid #334155; }
        .tabulator-row.tabulator-row-even { background: #253045; }
        .tabulator-cell { padding: 8px; vertical-align: middle; }

        /* BOT√ïES INTERNOS DA TABELA */
        .mini-btn { border: none; border-radius: 4px; padding: 4px 8px; font-size: 10px; font-weight: bold; cursor: pointer; margin-right: 4px; text-transform: uppercase; }
        .btn-save { background: var(--success); color: white; width: 100%; margin-bottom: 4px; }
        .btn-photo { background: var(--primary); color: white; }
        .btn-details { background: #64748b; color: white; }

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-card { background: #1e293b; padding: 25px; border-radius: 12px; width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; border: 1px solid #334155; box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 15px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; padding-bottom: 15px; margin-bottom: 10px; }
        .modal-title { font-size: 18px; font-weight: bold; color: white; }
        .close-btn { background: transparent; border: none; color: #94a3b8; cursor: pointer; font-size: 20px; }

        /* EDITOR DE IMAGEM */
        .editor-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        canvas { background: #000; border: 2px dashed #475569; max-width: 100%; }
        .editor-controls { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        label { font-size: 11px; color: #94a3b8; display: block; margin-bottom: 4px; }
        input[type="range"] { width: 100%; }
        .status-bar { font-size: 12px; color: var(--accent); text-align: center; height: 15px; }

        /* FORMUL√ÅRIO DE DETALHES */
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group input { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 4px; }
        .full-width { grid-column: span 2; }

        /* LOADER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <script>
        // WEBHOOKS DO MAKE (ATUALIZE AQUI)
        const MAKE_WEBHOOK_GET = "COLE_AQUI_SEU_WEBHOOK_DE_BUSCA"; 
        const MAKE_WEBHOOK_UPDATE = "https://hook.eu1.make.com/kvi7j1d7wsmrskoemdn86ykscenumt67";
        
        const STORAGE_KEY = 'sucedoan_data_v4';
        const CONFIG_KEY = 'sucedoan_config';
    </script>

    <nav class="global-nav">
        <div class="logo">DONA ANTONIA</div>
        <button class="nav-btn active" onclick="showView('producao')">üì¶ PRODU√á√ÉO</button>
        <button class="nav-btn" onclick="showView('pedidos')">üìÑ PEDIDOS</button>
        <button class="nav-btn config" onclick="openConfigModal()">‚öôÔ∏è CONFIG GITHUB</button>
    </nav>

    <div id="view-producao" class="view-pane active">
        <div class="controls-bar">
            <input type="text" id="search-field" placeholder="üîé Buscar por Nome, SKU ou EAN..." autofocus>
            <button class="btn-action btn-bling" onclick="importarBling()">‚òÅ Baixar do Bling</button>
            <input type="file" id="csv-file" accept=".csv" style="display:none">
            <button class="btn-action btn-csv" onclick="document.getElementById('csv-file').click()">üìÇ CSV</button>
        </div>
        <div id="product-table"></div>
    </div>

    <div id="modal-editor" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title">Editor R√°pido (Github)</span>
                <button class="close-btn" onclick="closeModal('modal-editor')">√ó</button>
            </div>
            
            <div class="editor-container">
                <canvas id="imageCanvas" width="500" height="500"></canvas>
                <div class="status-bar" id="editor-status">Cole a imagem (Ctrl+V) aqui...</div>

                <div class="editor-controls">
                    <div>
                        <label>Zoom</label>
                        <input type="range" id="zoomRange" min="0.1" max="3" step="0.1" value="1">
                    </div>
                    <div>
                        <label>Nitidez (Sharpen)</label>
                        <input type="range" id="sharpenRange" min="0" max="10" step="1" value="0">
                    </div>
                </div>

                <div style="display:flex; gap:10px; width:100%">
                    <button class="btn-action btn-csv" style="flex:1" onclick="document.getElementById('fileInput').click()">üìÇ Carregar PC</button>
                    <input type="file" id="fileInput" style="display:none" accept="image/*">
                    <button class="btn-action btn-photo" style="flex:1" onclick="uploadToGithub()">üöÄ ENVIAR P/ GITHUB</button>
                </div>
                <div style="font-size:10px; color:#64748b; text-align:center;">
                    Dica: Busque no Google, Copie e d√™ <b>Ctrl+V</b> aqui dentro.
                </div>
            </div>
        </div>
    </div>

    <div id="modal-details" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title">Detalhes Completos</span>
                <button class="close-btn" onclick="saveDetailsAndClose()">üíæ SALVAR & FECHAR</button>
            </div>
            <div class="details-grid" id="details-form">
                </div>
        </div>
    </div>

    <div id="modal-config" class="modal-overlay">
        <div class="modal-card" style="width:400px">
            <div class="modal-header"><span class="modal-title">Configurar GitHub</span><button class="close-btn" onclick="closeModal('modal-config')">√ó</button></div>
            <div class="form-group">
                <label>GitHub Token (PAT)</label>
                <input type="password" id="cfg-token" placeholder="ghp_xxxxxxxxxxxx">
            </div>
            <div class="form-group">
                <label>Usu√°rio GitHub</label>
                <input type="text" id="cfg-user" placeholder="ex: osvaldosereia">
            </div>
            <div class="form-group">
                <label>Reposit√≥rio</label>
                <input type="text" id="cfg-repo" placeholder="ex: SUCEDOAN12">
            </div>
            <div class="form-group">
                <label>Pasta (Caminho)</label>
                <input type="text" id="cfg-path" value="site/img/produtos">
            </div>
            <button class="btn-action btn-save" onclick="saveConfig()" style="margin-top:15px">SALVAR CONFIGURA√á√ÉO</button>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div><span id="loader-msg">Processando...</span></div>

    <script>
        // --- VARI√ÅVEIS GLOBAIS ---
        var table;
        var currentEditingRow = null; // Linha sendo editada no momento
        var canvas = document.getElementById('imageCanvas');
        var ctx = canvas.getContext('2d');
        var loadedImage = null; // Imagem crua carregada
        var imageState = { x: 0, y: 0, scale: 1 };

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            const saved = localStorage.getItem(STORAGE_KEY);
            initTable(saved ? JSON.parse(saved) : []);
            setupEditorEvents();
            loadConfig();
        };

        function toggleLoader(show, msg) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
            document.getElementById('loader-msg').innerText = msg || "Processando...";
        }

        // --- 1. TABELA LIMPA E PROFISSIONAL ---
        function initTable(data) {
            table = new Tabulator("#product-table", {
                data: data,
                layout: "fitColumns",
                height: "100%",
                reactiveData: true,
                columns: [
                    // A√á√ïES (Fixo na esquerda)
                    {title: "A√á√ïES", width: 90, headerSort:false, frozen:true, hozAlign:"center", formatter: function(){
                        return `
                            <button class="mini-btn btn-save" title="Sincronizar com Bling">‚òÅ SYNC</button>
                            <button class="mini-btn btn-photo" title="Editor de Foto">üì∏ FOTO</button>
                            <button class="mini-btn btn-details" title="Editar Detalhes">üìù +DET</button>
                        `;
                    }, cellClick: function(e, cell){
                        const btn = e.target;
                        const row = cell.getRow();
                        
                        if(btn.classList.contains('btn-save')) syncBling(row.getData(), btn);
                        if(btn.classList.contains('btn-photo')) openPhotoEditor(row);
                        if(btn.classList.contains('btn-details')) openDetails(row);
                    }},

                    // COLUNAS VIS√çVEIS (ESSENCIAIS)
                    {title: "SKU", field: "codigo", width: 90, headerFilter:"input"},
                    {title: "PRODUTO", field: "nome", widthGrow:2, headerFilter:"input", editor:"input"},
                    {title: "ESTOQUE", field: "estoque", width: 80, hozAlign:"center", editor:"number", formatter: "prop", formatterParams:{fontWeight:"bold"}},
                    {title: "LOCAL", field: "localizacao", width: 90, editor:"input"},
                    {title: "EAN (GTIN)", field: "gtin", width: 120, editor:"input"},
                    {title: "NCM", field: "ncm", width: 90, editor:"input"},
                    
                    // IMAGEM (Miniatura)
                    {title: "IMG", field: "url_imagem", width: 60, formatter: "image", formatterParams:{height:"30px", width:"30px"}, cellClick:(e, c)=>window.open(c.getValue())}
                ],
                cellEdited: () => saveData()
            });

            // Filtro R√°pido
            document.getElementById("search-field").addEventListener("input", function(e){
                const val = e.target.value;
                table.setFilter([
                    [{field:"codigo", type:"like", value:val}, {field:"nome", type:"like", value:val}, {field:"gtin", type:"like", value:val}]
                ]);
            });
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData()));
        }

        // --- 2. EDITOR DE IMAGEM (CANVAS + GITHUB) ---

        function openPhotoEditor(row) {
            currentEditingRow = row;
            document.getElementById('modal-editor').style.display = 'flex';
            
            // Limpa o canvas e desenha fundo branco
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0,0, 500, 500);
            ctx.font = "20px Arial";
            ctx.fillStyle = "#ccc";
            ctx.fillText("Cole (Ctrl+V) ou Abra Imagem", 120, 250);
            
            loadedImage = null;
            document.getElementById('editor-status').innerText = "Editando: " + row.getData().nome;
        }

        function setupEditorEvents() {
            // Colar (Paste)
            window.addEventListener('paste', function(e) {
                if(document.getElementById('modal-editor').style.display !== 'flex') return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file') {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => loadImageToCanvas(event.target.result);
                        reader.readAsDataURL(blob);
                    }
                }
            });

            // Input Arquivo
            document.getElementById('fileInput').addEventListener('change', function(e){
                if(this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (evt) => loadImageToCanvas(evt.target.result);
                    reader.readAsDataURL(this.files[0]);
                }
            });

            // Controles
            document.getElementById('zoomRange').addEventListener('input', drawImage);
            document.getElementById('sharpenRange').addEventListener('input', drawImage); // Apenas redesenha, aplica no final ou real time (pode ser pesado)
        }

        function loadImageToCanvas(url) {
            const img = new Image();
            img.onload = function() {
                loadedImage = img;
                // Centralizar
                imageState.scale = Math.max(500/img.width, 500/img.height); // Fit cover inicial
                imageState.x = (500 - img.width * imageState.scale) / 2;
                imageState.y = (500 - img.height * imageState.scale) / 2;
                document.getElementById('zoomRange').value = imageState.scale;
                drawImage();
            };
            img.src = url;
        }

        function drawImage() {
            if(!loadedImage) return;
            
            // 1. Limpa (Fundo Branco)
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0,0, 500, 500);

            // 2. Desenha Imagem com Zoom
            const zoom = parseFloat(document.getElementById('zoomRange').value);
            const w = loadedImage.width * zoom;
            const h = loadedImage.height * zoom;
            const x = (500 - w) / 2; // Centralizado por padr√£o (simplificado)
            
            // Nota: Para arrastar, precisaria de eventos de mouse. Por enquanto, centraliza autom√°tico.
            ctx.drawImage(loadedImage, x, (500 - h) / 2, w, h);
        }

        // Fun√ß√£o de Upload para o GitHub
        async function uploadToGithub() {
            if(!loadedImage) return alert("Cole uma imagem primeiro!");
            
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
            if(!cfg.token) return alert("Configure o Token do GitHub na engrenagem!");

            toggleLoader(true, "Processando e Enviando...");

            // 1. Aplicar Nitidez (Simples) e Gerar Blob WebP
            // (Nota: Nitidez real no canvas √© complexa, vou usar qualidade alta do webp para compensar)
            
            const quality = 0.8; // Tenta 80%
            const dataUrl = canvas.toDataURL("image/webp", quality);
            const base64Content = dataUrl.split(',')[1];

            // 2. Gerar Nome (Slug)
            const rowData = currentEditingRow.getData();
            const slug = rowData.nome.toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-') + "-cesta-basica-cuiaba.webp";

            const path = cfg.path + "/" + slug;
            const apiUrl = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${path}`;

            try {
                // Verificar se arquivo existe para pegar o SHA (para update)
                let sha = null;
                try {
                    const check = await fetch(apiUrl, { 
                        headers: { "Authorization": `token ${cfg.token}` } 
                    });
                    if(check.ok) {
                        const json = await check.json();
                        sha = json.sha;
                    }
                } catch(e) {}

                // Upload (PUT)
                const body = {
                    message: "Update via Painel Dona Antonia",
                    content: base64Content
                };
                if(sha) body.sha = sha;

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        "Authorization": `token ${cfg.token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });

                if(response.ok) {
                    const resJson = await response.json();
                    const rawUrl = resJson.content.download_url; // Link direto
                    
                    // Atualiza Tabela
                    currentEditingRow.update({ url_imagem: rawUrl });
                    saveData();
                    
                    toggleLoader(false);
                    closeModal('modal-editor');
                    alert("Sucesso! Imagem atualizada.");
                } else {
                    throw new Error("Erro GitHub: " + response.status);
                }

            } catch(error) {
                toggleLoader(false);
                alert("Erro ao enviar: " + error.message);
                console.error(error);
            }
        }

        // --- 3. MODAL DE DETALHES (Campos Ocultos) ---
        function openDetails(row) {
            currentEditingRow = row;
            const data = row.getData();
            const container = document.getElementById('details-form');
            container.innerHTML = "";

            // Lista de campos para editar
            const fields = [
                {k:'preco', l:'Pre√ßo Venda (R$)'}, {k:'precoCusto', l:'Pre√ßo Custo (R$)'},
                {k:'unidade', l:'Unidade (UN/KG)'}, {k:'cest', l:'CEST'},
                {k:'pesoLiquido', l:'Peso Liq (Kg)'}, {k:'pesoBruto', l:'Peso Bruto (Kg)'},
                {k:'largura', l:'Largura (cm)'}, {k:'altura', l:'Altura (cm)'}, {k:'profundidade', l:'Profundidade (cm)'}
            ];

            fields.forEach(f => {
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label>${f.l}</label><input type="text" id="det-${f.k}" value="${data[f.k] || ''}">`;
                container.appendChild(div);
            });

            document.getElementById('modal-details').style.display = 'flex';
        }

        function saveDetailsAndClose() {
            if(!currentEditingRow) return;
            const newData = {};
            
            // Pega todos os inputs do modal
            document.querySelectorAll('#details-form input').forEach(input => {
                const key = input.id.replace('det-', '');
                newData[key] = input.value; // Salva como string ou converta se precisar
            });

            currentEditingRow.update(newData);
            saveData();
            closeModal('modal-details');
        }

        // --- 4. FUN√á√ïES GERAIS ---

        function syncBling(data, btn) {
            // L√≥gica de envio para o Make (igual ao anterior, mas usando os dados completos da linha)
            if(MAKE_WEBHOOK_UPDATE.includes("SEU_LINK")) return alert("Configure o Webhook UPDATE!");
            
            const originalText = btn.innerText;
            btn.innerText = "‚è≥";
            btn.disabled = true;

            // Limpeza b√°sica
            const payload = {...data};
            Object.keys(payload).forEach(k => {
                if(typeof payload[k] === 'string') payload[k] = payload[k].trim();
                if(payload[k] === undefined || payload[k] === null) payload[k] = "";
            });

            fetch(MAKE_WEBHOOK_UPDATE, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(res => {
                if(res.ok) {
                    btn.innerText = "‚úÖ";
                    setTimeout(()=> { btn.innerText = originalText; btn.disabled = false; }, 2000);
                } else throw new Error();
            }).catch(() => {
                btn.innerText = "‚ùå";
                btn.disabled = false;
            });
        }

        function importarBling() {
            if(MAKE_WEBHOOK_GET.includes("COLE_AQUI")) return alert("Configure o Webhook GET no c√≥digo!");
            if(!confirm("Baixar tudo do Bling?")) return;
            toggleLoader(true);
            
            fetch(MAKE_WEBHOOK_GET).then(r => r.json()).then(data => {
                if(Array.isArray(data)) {
                    // Mapeamento de seguran√ßa
                    const cleanData = data.map(d => ({
                       ...d,
                       preco: parseFloat(d.preco || 0),
                       estoque: parseFloat(d.estoque || 0)
                    }));
                    table.setData(cleanData);
                    saveData();
                    alert("Importado!");
                }
            }).catch(e => alert("Erro ao importar")).finally(() => toggleLoader(false));
        }

        // Configura√ß√£o
        function openConfigModal() {
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
            document.getElementById('cfg-token').value = cfg.token || '';
            document.getElementById('cfg-user').value = cfg.user || '';
            document.getElementById('cfg-repo').value = cfg.repo || '';
            document.getElementById('cfg-path').value = cfg.path || 'site/img/produtos';
            document.getElementById('modal-config').style.display = 'flex';
        }
        function saveConfig() {
            const cfg = {
                token: document.getElementById('cfg-token').value,
                user: document.getElementById('cfg-user').value,
                repo: document.getElementById('cfg-repo').value,
                path: document.getElementById('cfg-path').value
            };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
            closeModal('modal-config');
        }
        function loadConfig() {
            if(!localStorage.getItem(CONFIG_KEY)) alert("Bem vindo! Clique na engrenagem ‚öôÔ∏è para configurar o GitHub.");
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showView(id) {
            document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + id).classList.add('active');
        }

        // CSV Import (Mantido do anterior)
        document.getElementById('csv-file').addEventListener('change', function(e) {
            Papa.parse(e.target.files[0], {
                header: true, skipEmptyLines: true, encoding: "UTF-8",
                complete: (results) => {
                    const parseNum = (val) => val ? parseFloat(val.replace(/\./g, '').replace(',', '.')) : 0;
                    const map = results.data.map(d => ({
                        codigo: d["C√≥digo"]||d.codigo, nome: d["Descri√ß√£o"]||d.nome,
                        preco: parseNum(d["Pre√ßo"]||d.preco), estoque: parseNum(d["Estoque"]||d.estoque),
                        localizacao: d["Localiza√ß√£o"]||d.localizacao, gtin: d["GTIN/EAN"]||d.gtin,
                        ncm: d["NCM"]||d.ncm, url_imagem: d["URL Imagens Externas"]||d.url_imagem
                        // ... adicione outros se necess√°rio
                    }));
                    table.setData(map);
                    saveData();
                }
            });
        });

    </script>
</body>
</html>
