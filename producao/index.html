<script>
        // ==========================================
        // 1. CONFIGURAÇÕES E DADOS GERAIS
        // ==========================================
        const USERS = {
            "090479": "OSVALDO", "170484": "ANDRE", "098765": "CLAUDENIL",
            "567890": "KELY", "121212": "JOSE", "123456": "ROSINA"
        };

        const MAKE_WEBHOOK_GET = "COLE_AQUI_SEU_WEBHOOK_DE_BUSCA"; 
        const MAKE_WEBHOOK_UPDATE = "https://hook.eu1.make.com/kvi7j1d7wsmrskoemdn86ykscenumt67";
        
        const STORAGE_KEY = 'sucedoan_data_v24';
        const CONFIG_KEY = 'sucedoan_config';
        const HISTORY_KEY = 'sucedoan_history';
    </script>

    <script>
        // --- ESTADO ---
        let products = [], historyLog = [], currentEditingId = null, pendingSyncSku = null, currentUser = null;
        const canvas = document.getElementById('imageCanvas'), ctx = canvas.getContext('2d');
        let loadedImage = null;

        window.onload = function() {
            lucide.createIcons();
            loadData();
            setupEditorEvents();
            document.getElementById('search-input').addEventListener('input', (e) => renderGrid(e.target.value));
        };

        function showSection(id, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('section-'+id).classList.add('active');
            if(btn) { document.querySelectorAll('header .nav-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            if(id === 'history') renderHistory();
        }

        // --- IMPORTAÇÃO CSV ---
        document.getElementById('csv-file').addEventListener('change', function(e) {
            if(!e.target.files[0]) return;
            toggleLoader(true, "Lendo CSV...");
            Papa.parse(e.target.files[0], {
                header: true, skipEmptyLines: true, encoding: "ISO-8859-1", delimiter: ";", transformHeader: h => h.replace(/"/g, '').trim(),
                complete: (results) => {
                    const novos = results.data.map(d => {
                        const getVal = (keys) => { const f = Object.keys(d).find(k => keys.some(pk => k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes(pk))); return f ? d[f] : ""; };
                        const getNum = (keys) => { const v = getVal(keys); return v ? parseFloat(v.toString().replace(/\./g,'').replace(',','.'))||0 : 0; };
                        
                        const base = {
                            codigo: getVal(['codigo','sku']), nome: getVal(['descricao','nome','produto']),
                            preco: getNum(['preco','venda']), estoque: getNum(['estoque']),
                            localizacao: getVal(['localizacao','local']), gtin: getVal(['gtin','ean']),
                            url_imagem: getVal(['url','imagem']), ncm: getVal(['ncm']), cest: getVal(['cest']),
                            unidade: getVal(['unidade'])||'UN', pesoLiquido: getNum(['peso liq']), pesoBruto: getNum(['peso bru']),
                            largura: getNum(['largura']), altura: getNum(['altura']), profundidade: getNum(['profundidade']),
                            origem: getVal(['origem']), observacoes: getVal(['observacoes','obs']),
                            situacao: 'A', formato: 'S', _changed: true, _lastChange: "Importação CSV"
                        };
                        Object.keys(d).forEach(k => { const safe = k.toLowerCase().replace(/[^a-z0-9]/g, '_'); if(!base[safe] && !['codigo','nome'].includes(safe)) base[safe] = d[k]; });
                        return base;
                    });
                    products = novos.filter(p => p.codigo || p.nome);
                    saveData(); renderGrid(); toggleLoader(false);
                    alert(`${products.length} importados!`);
                }
            });
        });

        // --- AUTH ---
        function requestLogin(sku) { pendingSyncSku = sku; document.getElementById('login-pass').value=''; document.getElementById('modal-login').style.display='flex'; document.getElementById('login-pass').focus(); }
        function attemptLogin() { const p = document.getElementById('login-pass').value; if(USERS[p]) { currentUser = USERS[p]; closeModal('modal-login'); if(pendingSyncSku) executeSync(pendingSyncSku); } else document.getElementById('login-error').style.display='block'; }
        
        // --- SYNC (GARANTIA DE URL) ---
        function syncBling(sku) { requestLogin(sku); }
        function executeSync(sku) {
            const p = products.find(pr => pr.codigo == sku);
            if(MAKE_WEBHOOK_UPDATE.includes("SEU_LINK")) return alert("Configure Webhook!");
            
            if(!currentUser) currentUser = "SISTEMA"; // Auto-login fallback

            toggleLoader(true, `Sincronizando...`);
            
            // 1. DADOS BASE
            const changeType = p._lastChange || "Sincronização Manual"; 
            const payload = {...p}; 
            delete payload._changed; delete payload._lastChange;
            
            // 2. GARANTIAS BLING
            if(!payload.situacao) payload.situacao='A';
            if(!payload.formato) payload.formato='S';

            // 3. --- AQUI ESTÁ A CORREÇÃO DE OURO ---
            // Se o produto foi alterado recentemente por Imagem, nós RECONSTRUÍMOS o link para ter certeza absoluta
            if(changeType.includes("Imagem")) {
                const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
                if(cfg.user && cfg.repo) {
                    // Recria o nome do arquivo baseado no nome atual do produto
                    const slug = (p.nome||"p").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\s-]/g,'').replace(/\s+/g,'-')+".webp";
                    // Força o link correto no payload
                    const forcedUrl = `https://raw.githubusercontent.com/${cfg.user}/${cfg.repo}/main/${cfg.path}/${slug}?v=${Date.now()}`;
                    payload.url_imagem = forcedUrl;
                    
                    // Atualiza local também para garantir
                    p.url_imagem = forcedUrl;
                }
            }

            // 4. LOG E LIMPEZA DE TEXTO (Para não quebrar o Make)
            const time = new Date().toLocaleString('pt-BR');
            const logNote = `[Alt: ${currentUser} em ${time} - ${changeType}]`;
            
            let obs = (payload.observacoes || "") + " | " + logNote;
            obs = obs.replace(/[\r\n]+/g, " | ").replace(/"/g, "'");
            payload.observacoes = obs;

            // 5. ENVIO
            fetch(MAKE_WEBHOOK_UPDATE, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)})
            .then(r => { 
                if(r.ok) { 
                    p.observacoes = obs; 
                    p._changed = false; p._lastChange = ""; 
                    saveData(); 
                    addToHistory(sku, p.nome, true, changeType); 
                    renderGrid(document.getElementById('search-input').value); toggleLoader(false); 
                    
                    // Confirmação Visual
                    alert(`✅ Produto enviado!\nImagem: ${payload.url_imagem ? 'Link OK' : 'Sem Link'}`);
                } else throw new Error();
            })
            .catch(() => { toggleLoader(false); addToHistory(sku, p.nome, false, "FALHA"); alert("Erro no envio!"); })
            .finally(() => { pendingSyncSku = null; currentUser = null; });
        }

        // --- EDITOR & UPLOAD (COM AUTO-SAVE DE URL) ---
        function openPhotoEditor(sku) {
            currentEditingId = sku; const p = products.find(pr => pr.codigo == sku);
            document.getElementById('modal-editor').style.display = 'flex';
            const slug = (p.nome||"p").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\s-]/g,'').replace(/\s+/g,'-')+".webp";
            document.getElementById('file-name-preview').innerText = slug;
            ctx.fillStyle="#FFF"; ctx.fillRect(0,0,450,450); ctx.fillStyle="#94a3b8"; ctx.textAlign="center"; ctx.fillText("Ctrl+V",225,225); loadedImage=null;
        }
        
        function setupEditorEvents() {
            window.addEventListener('paste', e=>{if(document.getElementById('modal-editor').style.display==='flex'){const i=(e.clipboardData||e.originalEvent.clipboardData).items;for(let x of i)if(x.kind==='file'){const r=new FileReader();r.onload=v=>loadImageToCanvas(v.target.result);r.readAsDataURL(x.getAsFile());}}});
            document.getElementById('fileInput').addEventListener('change', function(){if(this.files[0]){const r=new FileReader();r.onload=e=>loadImageToCanvas(e.target.result);r.readAsDataURL(this.files[0]);}});
            document.getElementById('zoomRange').addEventListener('input', drawImage); document.getElementById('sharpenRange').addEventListener('input', drawImage);
        }
        function loadImageToCanvas(u){const i=new Image();i.onload=()=>{loadedImage=i;document.getElementById('zoomRange').value=Math.max(450/i.width,450/i.height);drawImage();};i.src=u;}
        function drawImage(){if(!loadedImage)return;const wC=450,hC=450,z=parseFloat(document.getElementById('zoomRange').value),s=parseFloat(document.getElementById('sharpenRange').value);ctx.fillStyle="#FFF";ctx.fillRect(0,0,wC,hC);const w=loadedImage.width*z,h=loadedImage.height*z,x=(wC-w)/2,y=(hC-h)/2;if(s>0){ctx.globalAlpha=0.5*s;ctx.drawImage(loadedImage,x-0.5,y-0.5,w,h);ctx.globalAlpha=1;}ctx.drawImage(loadedImage,x,y,w,h);const k=Math.round((canvas.toDataURL("image/webp",0.8).length*0.75)/1024);document.getElementById('file-size-preview').innerText=`~${k}kb`;}
        function downloadImage(){const a=document.createElement('a');a.download=document.getElementById('file-name-preview').innerText;a.href=canvas.toDataURL("image/webp",0.8);a.click();}
        
        async function uploadToGithub() {
            if(!loadedImage) return alert("Sem imagem");
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
            if(!cfg.token) return alert("Configure o Token!");
            
            toggleLoader(true, "Enviando para GitHub...");
            const f = document.getElementById('file-name-preview').innerText;
            
            try {
                // 1. UPLOAD
                const u = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.path}/${f}`;
                let sha = null;
                try { const c = await fetch(u, {headers:{"Authorization":`token ${cfg.token}`}}); if(c.ok) sha = (await c.json()).sha; } catch(e){}
                
                const r = await fetch(u, {
                    method: 'PUT',
                    headers: {"Authorization":`token ${cfg.token}`, "Content-Type":"application/json"},
                    body: JSON.stringify({message: "Painel Upload", content: canvas.toDataURL("image/webp", 0.8).split(',')[1], sha: sha})
                });

                if(r.ok) {
                    // 2. GRAVAÇÃO IMEDIATA DO LINK NO PRODUTO
                    // Monta o link manualmente pois já sabemos onde ele vai estar
                    const rawUrl = `https://raw.githubusercontent.com/${cfg.user}/${cfg.repo}/main/${cfg.path}/${f}`;
                    const finalUrl = `${rawUrl}?v=${Date.now()}`; // Anti-cache
                    
                    const p = products.find(p => p.codigo == currentEditingId);
                    p.url_imagem = finalUrl;
                    p._changed = true;
                    p._lastChange = "Alt: Imagem";
                    
                    saveData(); // Salva no navegador
                    
                    // Fecha editor e prepara sync
                    closeModal('modal-editor');
                    toggleLoader(false); 
                    
                    // 3. DISPARA O SYNC AUTOMÁTICO
                    requestLogin(currentEditingId); 
                    
                } else throw new Error(r.status);
            } catch(e) { toggleLoader(false); alert("Erro: "+e.message); }
        }

        // --- UTILITÁRIOS ---
        function loadData() { const s = localStorage.getItem(STORAGE_KEY); if(s) { products=JSON.parse(s); renderGrid(); } const h = localStorage.getItem(HISTORY_KEY); if(h) historyLog=JSON.parse(h); }
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(products)); }
        
        function renderGrid(f="") {
            const g = document.getElementById('product-grid'); g.innerHTML=""; const t=f.toLowerCase().trim();
            const res = products.filter(p => (p.nome+p.codigo+p.gtin+p.localizacao+p.estoque).toLowerCase().includes(t));
            document.getElementById('total-count').innerText = res.length;
            res.forEach(p => {
                const card = document.createElement('div');
                card.className = `card ${p._changed?'status-changed':'status-synced'}`;
                const img = (p.url_imagem && p.url_imagem.length>5) ? p.url_imagem : 'https://placehold.co/400x400/1e293b/475569?text=SEM+FOTO';
                card.innerHTML = `
                    <div class="card-img-area"><img src="${img}" class="card-img" onerror="this.src='https://placehold.co/400?text=ERR'"><div class="img-overlay"><button class="overlay-btn" onclick="searchGoogle('${p.nome}')"><i data-lucide="search" size="14"></i></button><button class="overlay-btn" onclick="openPhotoEditor('${p.codigo}')"><i data-lucide="camera" size="14"></i></button><button class="overlay-btn" onclick="window.open('${img}','_blank')"><i data-lucide="external-link" size="14"></i></button></div></div>
                    <div class="card-body"><div class="card-sku">${p.codigo}</div><div class="card-title" contenteditable="true" onblur="updateField('${p.codigo}','nome',this.innerText)">${p.nome}</div><div class="card-stats"><div class="stat-box"><label class="stat-label">PREÇO</label><input type="number" class="stat-input" value="${p.preco}" onchange="updateField('${p.codigo}','preco',this.value)"></div><div class="stat-box"><label class="stat-label">ESTOQUE</label><input type="number" class="stat-input" value="${p.estoque}" onchange="updateField('${p.codigo}','estoque',this.value)"></div></div><div class="card-stats"><div class="stat-box"><label class="stat-label">LOCAL</label><input type="text" class="stat-input" value="${p.localizacao}" onchange="updateField('${p.codigo}','localizacao',this.value)"></div><div class="stat-box"><label class="stat-label">EAN</label><input type="text" class="stat-input" value="${p.gtin}" onchange="updateField('${p.codigo}','gtin',this.value)"></div></div></div>
                    <div class="card-footer"><button class="btn-text" onclick="openDetails('${p.codigo}')"><i data-lucide="list-plus" size="12"></i> DET</button><button class="btn-sync-mini" onclick="syncBling('${p.codigo}')"><i data-lucide="refresh-cw" size="10"></i> SYNC</button></div>
                `; g.appendChild(card);
            }); lucide.createIcons();
        }
        function updateField(sku, f, v) { const p=products.find(x=>x.codigo==sku); if(p){ if(['preco','estoque'].includes(f)) v=parseFloat(v)||0; p[f]=v; p._changed=true; p._lastChange=`Alt: ${f.toUpperCase()}`; saveData(); renderGrid(document.getElementById('search-input').value); } }
        function searchGoogle(t) { window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(t)}`, '_blank'); }
        function addToHistory(sku,nome,ok,obs) { historyLog.unshift({date:new Date().toLocaleString('pt-BR'), user:currentUser, sku, nome, status:ok, obs}); if(historyLog.length>500)historyLog.pop(); localStorage.setItem(HISTORY_KEY,JSON.stringify(historyLog)); }
        function renderHistory() { const b=document.getElementById('history-tbody'); b.innerHTML=''; historyLog.forEach(h=>{ b.innerHTML+=`<tr><td>${h.date}</td><td><b>${h.user}</b></td><td>${h.sku}</td><td>${h.nome}</td><td><span class="badge ${h.status?'success':'error'}">${h.obs}</span></td></tr>`; }); }
        function clearHistory() { if(confirm("Apagar?")){ historyLog=[]; localStorage.removeItem(HISTORY_KEY); renderHistory(); } }
        function openDetails(sku) { currentEditingId=sku; const p=products.find(x=>x.codigo==sku); const f=document.getElementById('details-form'); f.innerHTML=''; ['ncm','cest','origem','unidade','pesoBruto','pesoLiquido','largura','altura','profundidade'].forEach(k=>f.innerHTML+=`<div class="form-group"><label>${k}</label><input type="text" id="det-${k}" value="${p[k]||''}"></div>`); document.getElementById('modal-details').style.display='flex'; }
        function saveDetails() { const p=products.find(x=>x.codigo==currentEditingId); document.querySelectorAll('#details-form input').forEach(i=>p[i.id.replace('det-','')]=i.value); p._changed=true; p._lastChange="Alt: Detalhes"; saveData(); closeModal('modal-details'); }
        function openConfigModal() { const c=JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}'); document.getElementById('cfg-token').value=c.token||''; document.getElementById('cfg-user').value=c.user||''; document.getElementById('cfg-repo').value=c.repo||''; document.getElementById('cfg-path').value=c.path||''; document.getElementById('modal-config').style.display='flex'; }
        function saveConfig() { localStorage.setItem(CONFIG_KEY,JSON.stringify({token:document.getElementById('cfg-token').value, user:document.getElementById('cfg-user').value, repo:document.getElementById('cfg-repo').value, path:document.getElementById('cfg-path').value})); closeModal('modal-config'); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function exportarCSV() { const csv=Papa.unparse(products,{quotes:true,delimiter:";"}); const l=document.createElement("a"); l.href=URL.createObjectURL(new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'})); l.download="produtos.csv"; l.click(); }
        function importarBling() { if(MAKE_WEBHOOK_GET.includes("COLE"))return alert("Config Webhook!"); if(!confirm("Substituir?"))return; toggleLoader(true,"Baixando..."); fetch(MAKE_WEBHOOK_GET).then(r=>r.json()).then(d=>{if(Array.isArray(d))products=d.map(x=>({...x,_changed:false}));saveData();renderGrid();toggleLoader(false);}).catch(e=>{toggleLoader(false);alert("Erro: "+e)}); }
        function toggleLoader(s,m) { document.getElementById('loader').style.display=s?'flex':'none'; if(m)document.getElementById('loader-msg').innerText=m; }
    </script>
