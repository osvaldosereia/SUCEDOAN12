<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Dona Antonia - Sistema Integrado</title>

    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0052cc;
            --success: #22c55e;
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f8fafc;
            --accent: #38bdf8;
            --nav-height: 80px;
        }

        html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main); }

        /* MENU SUPERIOR GLOBAL */
        .global-nav {
            height: var(--nav-height); background: #000; display: flex; align-items: center; 
            padding: 0 20px; gap: 8px; border-bottom: 3px solid var(--accent); z-index: 1000; position: relative;
        }

        .nav-btn {
            height: 45px; padding: 0 12px; border-radius: 8px; border: 2px solid #334155;
            background: #1e293b; color: white; font-weight: 800; cursor: pointer;
            text-decoration: none; font-size: 11px; transition: all 0.2s; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center;
        }

        .nav-btn:hover { border-color: var(--accent); background: #334155; }
        .nav-btn.active { background: var(--primary); border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 82, 204, 0.4); }
        .nav-btn.bling { background: #f59e0b; color: #000; border-color: #d97706; }
        .nav-btn.new-order { background: #ef4444 !important; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* AREA DE CONTEﾃ咼O */
        .view-pane { width: 100%; height: calc(100vh - var(--nav-height)); display: none; overflow-y: auto; }
        .view-pane.active { display: block; }

        /* TABELA E BUSCA */
        .app-container { padding: 15px; height: 100%; display: flex; flex-direction: column; box-sizing: border-box; }
        #search-field { width: 100%; padding: 16px; border-radius: 10px; border: 3px solid var(--accent); font-size: 20px; font-weight: 700; outline: none; margin-bottom: 10px; background: white; color: black; }
        #product-table { flex-grow: 1; border-radius: 12px; overflow: hidden; font-size: 14px; }

        /* BOTﾃ髭S INTERNOS DA TABELA */
        .action-btn { border: none; border-radius: 4px; padding: 5px 8px; cursor: pointer; font-weight: bold; font-size: 10px; margin-right: 2px; text-transform: uppercase; }
        .btn-copy { background: #64748b; color: white; }
        .btn-link { background: var(--primary); color: white; }
        .btn-search { background: #334155; color: white; cursor: pointer; border: none; border-radius: 4px; padding: 5px; }

        /* ESTILO DOS PEDIDOS */
        .order-card { background: var(--card); border-radius: 12px; margin: 15px; padding: 20px; border-left: 10px solid var(--accent); display: flex; justify-content: space-between; align-items: center; }
        .btn-print { background: var(--success); color: white; padding: 15px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* CONFIGURAﾃﾃグ DE IMPRESSﾃグ 80mm */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 80mm; color: black !important; font-family: 'Courier New', monospace; font-size: 12px; }
        }
        #print-section { display: none; background: white; padding: 10px; color: black; }
        
        iframe { width: 100%; height: 100%; border: none; background: white; }
    </style>
</head>
<body>

    <audio id="bell-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <nav class="global-nav">
        <div style="color: var(--accent); font-weight: 900; font-size: 16px; margin-right: 10px;">DONA ANTONIA</div>
        
        <button class="nav-btn active" onclick="showView('producao', '', this)">屏 PRODUﾃﾃグ</button>
        <button class="nav-btn" id="btn-pedidos-nav" onclick="showView('pedidos', '', this)">逃 PEDIDOS</button>
        
        <a href="https://www.bling.com.br/vendas.checkout.php" target="_blank" class="nav-btn bling">腸 BLING</a>
        
        <button class="nav-btn" onclick="showView('external', 'https://donaantonia.com.br/bio/', this)">萄 EDITOR FOTO</button>
        <button class="nav-btn" onclick="showView('external', 'https://donaantonia.com.br/site/', this)">將 LOJA</button>
        <button class="nav-btn" onclick="showView('external', 'https://donaantonia.com.br/produtos/', this)">統 NOTA</button>
    </nav>

    <div id="view-producao" class="view-pane active">
        <div class="app-container">
            <header style="display:flex; gap:10px;">
                <input type="text" id="search-field" placeholder="博 BUSCAR POR Cﾃ泥IGO OU DESCRIﾃﾃグ..." autofocus>
                <input type="file" id="csv-file" accept=".csv" style="display:none">
                <button onclick="document.getElementById('csv-file').click()" style="padding:10px; cursor:pointer; font-weight:bold; border-radius:8px;">SUBIR CSV</button>
                <button id="btn-export" style="background:var(--success); color:white; padding:10px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">EXPORTAR</button>
            </header>
            <div id="product-table"></div>
        </div>
    </div>

    <div id="view-pedidos" class="view-pane">
        <div id="lista-pedidos-container">
            <h2 style="padding: 20px;">Separaﾃｧﾃ｣o de Pedidos (80mm)</h2>
            <div id="pedidos-placeholder" style="padding: 20px; opacity: 0.5;">Aguardando novos pedidos...</div>
        </div>
    </div>

    <div id="view-external" class="view-pane">
        <iframe id="main-iframe" src=""></iframe>
    </div>

    <div id="print-section"></div>

    <script>
        var table;
        var pedidosProcessados = [];
        const STORAGE_KEY = 'sucedoan_kiosk_data';

        // 1. FUNﾃﾃグ SLUGIFY (Limpa o nome para o link)
        function slugify(text) {
            return text.toString().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^\w\s-]/g, '') // Remove caracteres especiais
                .replace(/\s+/g, '-') // Espaﾃｧos por hifens
                .replace(/--+/g, '-') 
                .trim();
        }

        // 2. FUNﾃﾃグ DE IMPRESSﾃグ (80mm)
        function imprimirPedido(pedido) {
            const printArea = document.getElementById('print-section');
            printArea.innerHTML = `
                <div style="text-align:center; font-weight:bold; font-size:16px;">DONA ANTONIA</div>
                <div style="text-align:center;">Cesta Bﾃ｡sica</div>
                <hr>
                <div><b>PEDIDO:</b> #${pedido.numero}</div>
                <div><b>CLIENTE:</b> ${pedido.cliente}</div>
                <hr>
                <div style="font-weight:bold;">ITENS PARA SEPARAﾃﾃグ:</div>
                ${pedido.itens.map(i => `<div style="margin-bottom:4px;">- ${i.quantidade}x ${i.descricao}</div>`).join('')}
                <hr>
                <div style="text-align:center; font-size:10px;">Gerado em: ${new Date().toLocaleString()}</div>
            `;
            window.print();
        }

        // 3. INICIALIZAﾃﾃグ DA TABELA
        function initTable(data) {
            table = new Tabulator("#product-table", {
                data: data,
                layout: "fitColumns",
                height: "100%",
                columns: [
                    {title: "Cﾃ泥IGO", field: "Cﾃｳdigo", width: 100, headerSort: false},
                    {title: "剥", width: 50, hozAlign: "center", formatter: () => "剥", headerSort: false, cellClick: (e, cell) => {
                        window.open("https://www.google.com/search?q=" + encodeURIComponent(cell.getData()["Descriﾃｧﾃ｣o"]) + "&tbm=isch", '_blank');
                    }},
                    {title: "Aﾃﾃ髭S", width: 180, headerSort: false, columns: [
                        {formatter: () => "<button class='action-btn btn-copy'>搭 NOME</button>", width: 85, cellClick: (e, cell) => {
                            const slug = slugify(cell.getData()["Descriﾃｧﾃ｣o"]);
                            navigator.clipboard.writeText(slug);
                            cell.getElement().style.background = "#22c55e";
                            setTimeout(() => cell.getElement().style.background = "", 500);
                        }},
                        {formatter: () => "<button class='action-btn btn-link'>迫 LINK</button>", width: 85, cellClick: (e, cell) => {
                            const slug = slugify(cell.getData()["Descriﾃｧﾃ｣o"]);
                            const url = `https://github.com/osvaldosereia/SUCEDOAN12/blob/main/site/img/produtos/${slug}-cesta-basica-cuiaba-varzea-grande.webp?raw=true`;
                            cell.getRow().update({"URL Imagens Externas": url});
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData()));
                        }}
                    ]},
                    {title: "URL IMAGEM", field: "URL Imagens Externas", width: 220, editor: "input"},
                    {title: "DESCRIﾃﾃグ DO PRODUTO", field: "Descriﾃｧﾃ｣o", widthGrow: 4, editor: "input"},
                    {title: "ESTOQUE", field: "Estoque", width: 90, editor: "input", hozAlign: "center"},
                    {title: "LOCAL", field: "Localizaﾃｧﾃ｣o", width: 120, editor: "input"},
                ],
                cellEdited: () => localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData()))
            });

            document.getElementById("search-field").addEventListener("input", (e) => {
                table.setFilter([[{field:"Cﾃｳdigo", type:"like", value:e.target.value}, {field:"Descriﾃｧﾃ｣o", type:"like", value:e.target.value}]]);
            });
        }

        // 4. VERIFICAﾃﾃグ DE NOVOS PEDIDOS (AUTOMﾃゝICO)
        async function fetchOrders() {
            try {
                const res = await fetch('pedidos.json?t=' + Date.now());
                const orders = await res.json();
                let temNovo = false;

                orders.forEach(o => {
                    if(!pedidosProcessados.includes(o.id)) {
                        pedidosProcessados.push(o.id);
                        temNovo = true;
                        document.getElementById('pedidos-placeholder').style.display = 'none';
                        const card = document.createElement('div');
                        card.className = 'order-card';
                        card.innerHTML = `<div><h3>#${o.numero} - ${o.cliente}</h3><p>${o.itens.length} itens</p></div><button class="btn-print" onclick='imprimirPedido(${JSON.stringify(o)})'>蜜 IMPRIMIR</button>`;
                        document.getElementById('lista-pedidos-container').prepend(card);
                    }
                });

                if(temNovo) {
                    document.getElementById('bell-sound').play();
                    document.getElementById('btn-pedidos-nav').classList.add('new-order');
                }
            } catch(e) {}
        }

        // 5. GESTﾃグ DE TELAS
        function showView(viewId, url, btn) {
            document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            btn.classList.remove('new-order');

            if(viewId === 'external') {
                document.getElementById('view-external').classList.add('active');
                document.getElementById('main-iframe').src = url;
            } else {
                document.getElementById('view-' + viewId).classList.add('active');
                if(viewId === 'producao') setTimeout(() => document.getElementById("search-field").focus(), 100);
            }
        }

        // INICIALIZAﾃﾃグ AO CARREGAR
        window.onload = () => {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) initTable(JSON.parse(savedData));
            setInterval(fetchOrders, 30000); // Checa novos pedidos a cada 30s
            document.getElementById("search-field").focus();
        };

        // CSV UPLOAD
        document.getElementById('csv-file').addEventListener('change', (e) => {
            Papa.parse(e.target.files[0], { header: true, skipEmptyLines: true, complete: (r) => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(r.data));
                initTable(r.data);
            }});
        });

        // CSV EXPORT
        document.getElementById('btn-export').addEventListener('click', () => {
            const csv = Papa.unparse(table.getData(), { quotes: true, delimiter: ";", newline: "\r\n" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob(["\ufeff" + csv]));
            link.download = "estoque_producao.csv";
            link.click();
        });
    </script>
</body>
</html>
