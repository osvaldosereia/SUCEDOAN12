<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sucedoan Painel - v43 (Export Exact Layout)</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        /* --- 1. VARIÁVEIS E RESET (MODO CLARO) --- */
        :root {
            --bg-body: #f8fafc;       /* Fundo claro */
            --bg-card: #ffffff;       /* Card branco */
            --text-primary: #1e293b;  /* Texto escuro */
            --text-secondary: #64748b;
            --accent: #2563eb;        /* Azul vibrante */
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --border: #cbd5e1;        /* Borda cinza claro */
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-body);
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-primary);
            overflow: hidden;
        }

        /* --- 2. CABEÇALHO (HEADER) --- */
        header {
            background: #ffffff;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            gap: 15px;
            flex-shrink: 0;
        }

        .brand {
            font-weight: 900;
            font-size: 18px;
            color: #0f172a;
            margin-right: auto;
            letter-spacing: -0.5px;
        }
        .brand span { color: var(--accent); }

        .nav-btn {
            background: #f1f5f9;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .nav-btn.config {
            color: var(--warning);
            border-color: #fcd34d;
            background: #fffbeb;
        }

        /* --- 3. ÁREAS DE VISUALIZAÇÃO (ABAS) --- */
        .view-section {
            display: none;
            flex-grow: 1;
            overflow: hidden;
            flex-direction: column;
        }
        .view-section.active {
            display: flex;
        }

        /* --- 4. BARRA DE FERRAMENTAS --- */
        .toolbar {
            padding: 12px 24px;
            display: flex;
            gap: 12px;
            background: #f1f5f9;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            align-items: center;
        }

        .search-container {
            flex-grow: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            background: #ffffff;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 10px 10px 36px;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }
        .search-input:focus { border-color: var(--accent); }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 10px;
            color: #94a3b8;
            width: 16px;
        }

        #total-count {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }

        /* --- 5. GRID DE PRODUTOS --- */
        .product-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: block; /* Alterado de grid para block para permitir headers */
        }
        
        .category-header {
            width: 100%;
            font-size: 14px;
            font-weight: 800;
            color: var(--accent);
            border-bottom: 2px solid var(--border);
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            text-transform: uppercase;
        }
        .category-header:first-child { margin-top: 0; }

        .category-items-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
            align-content: start;
            margin-bottom: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--border);
            transition: transform 0.2s;
            min-height: 420px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            z-index: 10;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .card.status-synced { border-top: 3px solid var(--success); }
        .card.status-changed { border-top: 3px solid var(--warning); }

        /* Imagem do Card */
        .card-img-area {
            height: 160px;
            background: #f8fafc;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            overflow: hidden;
        }

        .card-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: white;
        }

        .img-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: 0.2s;
            backdrop-filter: blur(2px);
        }
        .card-img-area:hover .img-overlay { opacity: 1; }

        .overlay-btn {
            background: white;
            color: #0f172a;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .overlay-btn:hover {
            transform: scale(1.1);
            background: var(--accent);
            color: white;
        }

        /* Corpo do Card */
        .card-body {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex-grow: 1;
        }

        .card-sku {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cat-select {
            background: #f1f5f9;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 9px;
            color: var(--accent);
            font-weight: bold;
            padding: 2px;
            max-width: 120px;
            cursor: pointer;
            outline: none;
        }

        .card-title-input {
            width: 100%;
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 600;
            resize: none;
            overflow: hidden;
            min-height: 40px;
            line-height: 1.3;
            border-radius: 4px;
            padding: 2px;
        }
        .card-title-input:focus {
            background: #f1f5f9;
            border-color: var(--accent);
            outline: none;
        }

        .card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: auto;
            padding-top: 8px;
        }

        .stat-box { display: flex; flex-direction: column; }
        
        .stat-label {
            font-size: 9px;
            color: var(--accent);
            margin-bottom: 3px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .stat-input {
            width: 100%;
            padding: 5px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            background: #f8fafc;
            text-align: center;
        }
        .stat-input:focus { border-color: var(--accent); background: white; outline: none; }

        /* Rodapé do Card */
        .card-footer {
            padding: 8px 12px;
            background: #f8fafc;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-text {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .btn-text:hover { color: var(--accent); }

        .btn-sync-mini {
            background: var(--success);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .icon-btn-mini {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            margin-left: 6px;
            vertical-align: middle;
        }
        .icon-btn-mini:hover { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- 6. TABELA DE HISTÓRICO --- */
        .history-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .history-table th {
            text-align: left;
            padding: 12px;
            background: #e2e8f0;
            border-bottom: 2px solid var(--border);
            color: var(--accent);
            text-transform: uppercase;
            font-size: 11px;
            position: sticky;
            top: 0;
        }

        .history-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-primary);
        }
        .history-table tr:hover { background: #f1f5f9; }

        /* --- 7. MODAIS --- */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-card {
            background: #ffffff;
            padding: 0;
            border-radius: 12px;
            width: 600px;
            max-width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .modal-card.login { width: 350px; }

        .modal-header {
            padding: 12px 16px;
            background: #f1f5f9;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
            font-weight: bold;
            font-size: 14px;
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .form-group label {
            display: block;
            font-size: 10px;
            color: var(--accent);
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .form-group input, .form-group select {
            width: 100%;
            background: #ffffff;
            border: 1px solid var(--border);
            padding: 8px;
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 12px;
        }

        .btn-full {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            background: var(--accent);
            color: white;
            font-size: 13px;
        }
        
        .btn-danger {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--danger);
            background: #fef2f2;
            color: var(--danger);
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            font-size: 12px;
            display: flex;
            justify-content: center;
            gap: 8px;
            align-items: center;
        }
        .btn-danger:hover { background: #fee2e2; }
        
        /* Checkbox Customizado */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-top: 10px;
            justify-content: center;
            color: var(--text-secondary);
        }
        .checkbox-wrapper input { accent-color: var(--accent); }

        /* --- 8. EDITOR DE IMAGEM --- */
        canvas {
            background: #fff;
            max-width: 100%;
            border: 1px solid var(--border);
            margin: 0 auto;
            display: block;
        }

        .editor-tools {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
            background: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
        }
        
        .sticker-tools {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: space-between;
        }

        .sticker-btn {
            flex: 1;
            padding: 6px;
            border: 1px solid var(--border);
            background: #ffffff;
            color: var(--text-secondary);
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            text-align: center;
        }
        .sticker-btn:hover { background: #e2e8f0; }
        .sticker-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .tool-group label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        input[type=range] {
            width: 100%;
            accent-color: var(--accent);
            height: 4px;
        }

        .file-info {
            background: #f1f5f9;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px dashed var(--border);
        }

        .action-row {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-act {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #ffffff;
            color: var(--text-primary);
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }
        .btn-act:hover { background: #f1f5f9; border-color: var(--accent); }
        .btn-act.primary { background: var(--accent); border: none; color: white; }

        /* --- 9. LOADER --- */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            color: var(--text-primary);
            flex-direction: column;
            gap: 15px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #cbd5e1;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <script>
        // ==========================================
        // 1. CONFIGURAÇÕES E DADOS GERAIS
        // ==========================================
        const USERS = {
            "090479": "OSVALDO", "170484": "ANDRE", "098765": "CLAUDENIL",
            "567890": "KELY", "121212": "JOSE", "123456": "ROSINA"
        };

        const MAKE_WEBHOOK_GET = "COLE_AQUI_SEU_WEBHOOK_DE_BUSCA"; 
        const MAKE_WEBHOOK_UPDATE = "https://hook.eu1.make.com/kvi7j1d7wsmrskoemdn86ykscenumt67";
        
        const STORAGE_KEY = 'sucedoan_data_v26';
        const CONFIG_KEY = 'sucedoan_config';
        const HISTORY_KEY = 'sucedoan_history';
        const LOGIN_KEY = 'sucedoan_saved_login'; 

        // --- NOVA CONFIGURAÇÃO DE CATEGORIAS ---
        // EDITE AQUI PARA ADICIONAR OU REMOVER CATEGORIAS E PALAVRAS-CHAVE
        const CONFIG_CATEGORIAS = {
            "ALIMENTOS": [
                "ARROZ", "FEIJAO", "ACUCAR", "OLEO", "AZEITE", "MACARRAO", 
                "CREME DE LEITE", "LEITE", "CAFE", "BISCOITO", "BOLACHA", 
                "CHOCOLATE", "MOLHO", "SAL", "FARINHA"
            ],
            "BEBIDAS": [
                "REFRIGERANTE", "SUCO", "AGUA", "CERVEJA", "VODKA", "WHISKY", 
                "VINHO", "ENERGETICO", "CHA"
            ],
            "LIMPEZA": [
                "SABAO", "DETERGENTE", "AGUA SANITARIA", "DESINFETANTE", "AMACIANTE",
                "ESPONJA", "ALCOOL", "MULTI USO", "LIMPA VIDROS"
            ],
            "HIGIENE": [
                "SHAMPOO", "CONDICIONADOR", "SABONETE", "CREME DENTAL", "ESCOVA",
                "PAPEL HIGIENICO", "FRALDA", "ABSORVENTE", "CREME PARA PELE", "CREME HIDRATANTE",
                "DESODORANTE", "LAMINAS"
            ],
            "BAZAR": [
                "COPO", "PRATO", "TALHER", "PANELA", "POTE", "VASSOURA", "RODO"
            ]
        };
    </script>

    <header>
        <div class="brand">SUCEDOAN <span>PRO</span></div>
        <button class="nav-btn active" onclick="showSection('products', this)">
            <i data-lucide="package" size="14"></i> PRODUTOS
        </button>
        <button class="nav-btn" onclick="showSection('history', this)">
            <i data-lucide="scroll-text" size="14"></i> HISTÓRICO
        </button>
        <div style="flex-grow:1"></div>
        <button class="nav-btn config" onclick="openConfigModal()">
            <i data-lucide="settings" size="14"></i>
        </button>
    </header>

    <div id="section-products" class="view-section active">
        <div class="toolbar">
            <button class="nav-btn primary" onclick="importarBling()">
                <i data-lucide="cloud-download" size="14"></i> BAIXAR BLING
            </button>
            
            <input type="file" id="csv-file" accept=".csv" style="display:none">
            <button class="nav-btn" onclick="document.getElementById('csv-file').click()">
                <i data-lucide="file-spreadsheet" size="14"></i> IMPORTAR CSV
            </button>
            
            <div class="search-container" style="margin-left: 15px;">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" class="search-input" id="search-input" placeholder="Buscar por Nome, SKU, EAN, Local ou Estoque...">
            </div>
            
            <button class="nav-btn" onclick="exportarCSV()">
                <i data-lucide="download" size="14"></i> CSV
            </button>
            <button class="nav-btn" onclick="exportarJSONCategorias()">
                <i data-lucide="file-json" size="14"></i> JSON CAT
            </button>
            <div id="total-count">0</div>
        </div>
        
        <div class="product-grid" id="product-grid"></div>
    </div>

    <div id="section-history" class="view-section">
        <div class="toolbar">
            <h3 style="margin:0; font-size:14px; color:var(--text-primary);">Histórico de Alterações</h3>
            <button class="nav-btn" onclick="clearHistory()">
                <i data-lucide="trash-2" size="14"></i> Limpar
            </button>
        </div>
        <div class="history-container">
            <table class="history-table">
                <thead>
                    <tr>
                        <th width="150">DATA / HORA</th>
                        <th width="120">USUÁRIO</th>
                        <th width="100">SKU</th>
                        <th>PRODUTO</th>
                        <th>AÇÃO / DETALHE</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                    </tbody>
            </table>
        </div>
    </div>

    <div id="modal-login" class="modal-overlay">
        <div class="modal-card login">
            <div class="modal-header">
                <span>AUTENTICAÇÃO</span>
                <button class="close-btn" onclick="closeModal('modal-login')"><i data-lucide="x" size="16"></i></button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:15px; color: var(--warning);">
                    <i data-lucide="lock" size="32"></i>
                    <p style="font-size:12px; margin-top:5px;">Digite sua senha pessoal</p>
                </div>
                <div class="form-group">
                    <label>Senha de Acesso</label>
                    <input type="password" id="login-pass" placeholder="******" style="text-align:center; letter-spacing: 3px; font-weight:bold; font-size:16px;" onkeydown="if(event.key==='Enter') attemptLogin()">
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="save-login">
                    <label for="save-login">Salvar senha neste dispositivo</label>
                </div>

                <button class="btn-full" onclick="attemptLogin()">CONFIRMAR</button>
                <div id="login-error" style="color:var(--danger); font-size:11px; text-align:center; margin-top:10px; display:none;">Senha incorreta!</div>
            </div>
        </div>
    </div>

    <div id="modal-editor" class="modal-overlay">
        <div class="modal-card" style="width:450px;">
            <div class="modal-header">
                <span>Editor de Imagem (Ctrl+V para Colar)</span>
                <button class="close-btn" onclick="closeModal('modal-editor')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <canvas id="imageCanvas" width="450" height="450"></canvas>
                
                <div class="file-info">
                    <span id="file-name-preview" style="color:var(--accent)">img.webp</span>
                    <span id="file-size-preview">0kb</span>
                </div>

                <div class="sticker-tools">
                    <div class="sticker-btn" id="stk-offer" onclick="toggleSticker('offer')">OFERTA</div>
                    <div class="sticker-btn" id="stk-best" onclick="toggleSticker('best')">MELHOR PREÇO</div>
                    <div class="sticker-btn" id="stk-today" onclick="toggleSticker('today')">SÓ HOJE</div>
                </div>

                <div class="editor-tools">
                    <div class="tool-group">
                        <label><span>Zoom</span></label>
                        <input type="range" id="zoomRange" min="0.1" max="3" step="0.1" value="1">
                    </div>
                    <div class="tool-group">
                        <label><span>Nitidez</span></label>
                        <input type="range" id="sharpenRange" min="0" max="5" step="0.1" value="0">
                    </div>
                    <div class="tool-group" style="grid-column: span 2;">
                        <label><span>Brilho</span></label>
                        <input type="range" id="brightnessRange" min="0" max="2" step="0.1" value="1">
                    </div>
                </div>

                <div class="action-row">
                    <button class="btn-act" onclick="document.getElementById('fileInput').click()">PC</button>
                    <input type="file" id="fileInput" style="display:none" accept="image/*">
                    
                    <button class="btn-act" onclick="downloadImage()">BAIXAR</button>
                    <button class="btn-act primary" style="flex:2" onclick="uploadToGithub()">GITHUB & SYNC</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-details" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header"><span>Detalhes Técnicos</span><button class="close-btn" onclick="saveDetails()"><i data-lucide="check"></i></button></div>
            <div class="modal-body">
                <div class="form-grid" id="details-form"></div>
                <button class="btn-full" onclick="saveDetails()">SALVAR</button>
            </div>
        </div>
    </div>

    <div id="modal-config" class="modal-overlay">
        <div class="modal-card" style="width:400px">
            <div class="modal-header"><span>Configuração</span><button class="close-btn" onclick="closeModal('modal-config')"><i data-lucide="x"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label>Token GitHub</label><input type="password" id="cfg-token" onkeydown="if(event.key==='Enter') saveConfig()"></div>
                <div class="form-group"><label>Usuário GitHub</label><input type="text" id="cfg-user" onkeydown="if(event.key==='Enter') saveConfig()"></div>
                <div class="form-group"><label>Repositório</label><input type="text" id="cfg-repo" onkeydown="if(event.key==='Enter') saveConfig()"></div>
                <div class="form-group"><label>Pasta</label><input type="text" id="cfg-path" onkeydown="if(event.key==='Enter') saveConfig()"></div>
                <button class="btn-full" onclick="saveConfig()">SALVAR</button>
                
                <hr style="margin:20px 0; border:0; border-top:1px solid #e2e8f0;">
                <button class="btn-danger" onclick="restaurarLinksPadraoSite()">
                    <i data-lucide="refresh-ccw" size="14"></i> PADRONIZAR COMO NO SITE
                </button>
                <div style="font-size:10px; color:#64748b; margin-top:8px; text-align:center;">
                    Força o uso de "i/..site/img/produtos/CODIGO.webp" em tudo.
                </div>
            </div>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div><h3 id="loader-msg">Carregando...</h3></div>

    <script>
        // ==========================================
        // 2. LÓGICA DO SISTEMA (JAVASCRIPT)
        // ==========================================
        let products = [];
        let historyLog = [];
        let currentEditingId = null;
        let pendingSyncSku = null;
        let currentUser = null;

        // Variáveis do Editor
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        let loadedImage = null;
        let activeSticker = null; 

        window.onload = function() {
            lucide.createIcons();
            loadData();
            setupEditorEvents();
            document.getElementById('search-input').addEventListener('input', (e) => renderGrid(e.target.value));
        };

        function showSection(id, btn) {
            document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
            document.getElementById('section-' + id).classList.add('active');
            
            if(btn) {
                document.querySelectorAll('header .nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            if(id === 'history') renderHistory();
        }

        // ----------------------------------------------------
        // LÓGICA DE CATEGORIZAÇÃO INTELIGENTE
        // ----------------------------------------------------
        function autoCategorizar(nome) {
            if (!nome) return "OUTROS";
            
            // Limpa o nome: Remove acentos e joga para maiúsculo
            let limpo = nome.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            
            // Divide em palavras (removendo espaços extras)
            let palavras = limpo.trim().split(/\s+/);

            // Pega as 3 primeiras palavras (ou vazio se não existir)
            let p1 = palavras[0] || "";
            let p2 = palavras[1] || "";
            let p3 = palavras[2] || "";

            // Tenta combinar em ordem de especificidade:
            // 1. Três palavras (Máxima precisão)
            // 2. Duas palavras (Alta precisão - ex: "Creme de Leite")
            // 3. Uma palavra (Baixa precisão - ex: "Creme")
            let tentativas = [
                `${p1} ${p2} ${p3}`.trim(),
                `${p1} ${p2}`.trim(),
                p1
            ];

            // Percorre as tentativas
            for (let termo of tentativas) {
                if (!termo) continue;
                
                // Verifica em cada categoria
                for (let [cat, keywords] of Object.entries(CONFIG_CATEGORIAS)) {
                    if (keywords.includes(termo)) {
                        return cat;
                    }
                }
            }

            return "OUTROS";
        }

        // ----------------------------------------------------
        // IMPORTAÇÃO CSV (DADOS COMPLETOS COM NOMES EXATOS)
        // ----------------------------------------------------
        document.getElementById('csv-file').addEventListener('change', function(e) {
            if(!e.target.files[0]) return;
            toggleLoader(true, "Lendo CSV...");
            
            Papa.parse(e.target.files[0], {
                header: true,
                skipEmptyLines: true,
                encoding: "UTF-8",
                delimiter: ";", 
                transformHeader: h => h.replace(/"/g, '').trim(),
                complete: (results) => {
                    const novos = results.data.map(d => {
                        // Função auxiliar para mapear para o App (Card)
                        const getVal = (key) => d[key] ? d[key] : "";
                        const getNum = (key) => {
                            const v = getVal(key);
                            return v ? parseFloat(v.toString().replace(/\./g,'').replace(',','.'))||0 : 0;
                        };

                        // 1. Definição Base para o App (Card Principal)
                        const base = {
                            codigo: getVal('Código'),
                            nome: getVal('Descrição'),
                            preco: getNum('Preço'),
                            estoque: getNum('Estoque'),
                            localizacao: getVal('Localização'),
                            gtin: getVal('GTIN/EAN'),
                            url_imagem: getVal('URL Imagens Externas'),
                            ncm: getVal('NCM'), 
                            validade: getVal('Data Validade'),
                            
                            // NOVA LÓGICA DE CATEGORIA APLICADA AQUI
                            categoria: autoCategorizar(getVal('Descrição')),

                            // Controle Interno
                            situacao: 'A',
                            formato: 'S',
                            _changed: true,
                            _lastChange: "Importação CSV"
                        };

                        // 2. IMPORTAÇÃO TOTAL: Copia TODAS as colunas do CSV
                        Object.keys(d).forEach(k => {
                            if(base[k] === undefined) {
                                base[k] = d[k];
                            }
                        });

                        // 3. HIGIENIZAÇÃO OBRIGATÓRIA
                        base['Origem'] = '0';
                        base['Unidade'] = 'un';
                        base['Grupo de produtos'] = '';

                        return base;
                    });

                    if(novos.length > 0) {
                        products = novos;
                        saveData();
                        renderGrid();
                    }
                    toggleLoader(false);
                }
            });
        });

        // ----------------------------------------------------
        // EXPORTAÇÃO CSV
        // ----------------------------------------------------
        function exportarCSV() {
            if (products.length === 0) return alert("Nada para exportar.");

            const colunasModelo = [
                "ID", "Código", "Descrição", "Unidade", "NCM", "Origem", "Preço", "Valor IPI fixo", 
                "Observações", "Situação", "Estoque", "Preço de custo", "Cód. no fornecedor", "Fornecedor", 
                "Localização", "Estoque máximo", "Estoque mínimo", "Peso líquido (Kg)", "Peso bruto (Kg)", 
                "GTIN/EAN", "GTIN/EAN da Embalagem", "Largura do produto", "Altura do Produto", 
                "Profundidade do produto", "Data Validade", "Descrição do Produto no Fornecedor", 
                "Descrição Complementar", "Itens p/ caixa", "Produto Variação", "Tipo Produção", 
                "Classe de enquadramento do IPI", "Código na Lista de Serviços", "Tipo do item", 
                "Grupo de Tags/Tags", "Tributos", "Código Pai", "Código Integração", "Grupo de produtos", 
                "Marca", "CEST", "Volumes", "Descrição Curta", "Cross-Docking", "URL Imagens Externas", 
                "Link Externo", "Meses Garantia no Fornecedor", "Clonar dados do pai", "Condição do Produto", 
                "Frete Grátis", "Número FCI", "Vídeo", "Departamento", "Unidade de Medida", "Preço de Compra", 
                "Valor base ICMS ST para retenção", "Valor ICMS ST para retenção", "Valor ICMS próprio do substituto", 
                "Categoria do produto", "Informações Adicionais"
            ];

            const dadosParaExportar = products.map(p => {
                const linha = {};
                const fmt = (n) => (n !== undefined && n !== null) ? n.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : "";

                // Atualiza campos editados no sistema
                p['Descrição'] = p.nome;
                p['Preço'] = fmt(p.preco);
                p['Estoque'] = fmt(p.estoque);
                p['Localização'] = p.localizacao;
                p['GTIN/EAN'] = p.gtin;
                p['URL Imagens Externas'] = ""; 
                p['NCM'] = p.ncm; 
                
                // NOTA: CATEGORIA REMOVIDA DA EXPORTAÇÃO CSV CONFORME SOLICITADO
                // p['Categoria do produto'] = p.categoria;

                p['Origem'] = '0'; 
                p['Unidade'] = 'un';
                p['Grupo de produtos'] = '';

                colunasModelo.forEach(col => {
                    linha[col] = (p[col] !== undefined && p[col] !== null) ? p[col] : "";
                });
                return linha;
            });

            const csv = Papa.unparse({
                fields: colunasModelo,
                data: dadosParaExportar
            }, {
                quotes: true, 
                delimiter: ";"
            });

            const l = document.createElement("a"); 
            l.href = URL.createObjectURL(new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' }));
            l.download = "produtos_export_identico.csv"; 
            l.click();
        }

        // ----------------------------------------------------
        // EXPORTAÇÃO JSON CATEGORIAS
        // ----------------------------------------------------
        function exportarJSONCategorias() {
            if (products.length === 0) return alert("Nada para exportar.");
            
            const grupos = {};
            products.forEach(p => {
                const cat = p.categoria || "OUTROS";
                if(!grupos[cat]) grupos[cat] = [];
                grupos[cat].push(p.codigo);
            });

            const resultado = Object.keys(grupos).map(k => ({
                categoria: k,
                produtos: grupos[k]
            }));

            const jsonStr = JSON.stringify(resultado, null, 2);
            const l = document.createElement("a");
            l.href = URL.createObjectURL(new Blob([jsonStr], { type: 'application/json' }));
            l.download = "categorias_produtos.json";
            l.click();
        }
        
        function importarBling() {
            if(MAKE_WEBHOOK_GET.includes("COLE")) return alert("Configure Webhook GET no topo do código!");
            if(!confirm("Isso substituirá a lista atual. Continuar?")) return;
            toggleLoader(true, "Baixando do Bling...");
            fetch(MAKE_WEBHOOK_GET).then(r=>r.json()).then(d => {
                if(Array.isArray(d)) { 
                    products = d.map(x => {
                        // Aplica categoria também na importação via API
                        const cat = autoCategorizar(x.nome || x.descricao);
                        return {...x, categoria: cat, _changed: false};
                    }); 
                    saveData(); renderGrid(); toggleLoader(false); 
                }
            }).catch(e => { toggleLoader(false); alert("Erro: "+e); });
        }

        function toggleLoader(show, msg) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
            if(msg) document.getElementById('loader-msg').innerText = msg;
        }
    </script>

    <script>
        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(saved) products = JSON.parse(saved);
            
            const hist = localStorage.getItem(HISTORY_KEY);
            if(hist) historyLog = JSON.parse(hist);

            const savedLogin = localStorage.getItem(LOGIN_KEY);
            if(savedLogin) currentUser = savedLogin;
            
            if(!currentUser) openModal('modal-login');
            
            // Config
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
            if(cfg.token) {
                document.getElementById('cfg-token').value = cfg.token;
                document.getElementById('cfg-user').value = cfg.user;
                document.getElementById('cfg-repo').value = cfg.repo;
                document.getElementById('cfg-path').value = cfg.path;
            }

            renderGrid();
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
        }

        function searchGoogle(term) {
            const query = encodeURIComponent(term);
            window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank');
        }

        function renderGrid(filter = "") {
            const gridContainer = document.getElementById('product-grid');
            gridContainer.innerHTML = "";
            
            let filtered = products;
            if(filter) {
                const term = filter.toLowerCase();
                filtered = products.filter(p => 
                    (p.nome||"").toLowerCase().includes(term) ||
                    (p.codigo||"").toLowerCase().includes(term) ||
                    (p.gtin||"").includes(term) ||
                    (p.localizacao||"").toLowerCase().includes(term)
                );
            }
            
            document.getElementById('total-count').innerText = filtered.length + " PRODUTOS";

            // Define categorias principais
            const catsKeys = Object.keys(CONFIG_CATEGORIAS);
            
            // Cria lista de iteração: Categorias Config + "OUTROS" (que servirá de catch-all)
            const gruposParaRenderizar = [...catsKeys, "OUTROS"];
            
            // Pega todas as categorias para o select (Visual apenas)
            const categoriasDisponiveis = [...catsKeys, "OUTROS"];

            // Loop para agrupar visualmente
            gruposParaRenderizar.forEach(catNome => {
                let prodsDaCat;
                if (catNome === "OUTROS") {
                    // CATCH-ALL: Pega qualquer coisa que não seja uma das categorias configuradas (inclui "OUTROS", null, undefined, vazios)
                    prodsDaCat = filtered.filter(p => !catsKeys.includes(p.categoria));
                } else {
                    prodsDaCat = filtered.filter(p => p.categoria === catNome);
                }

                if(prodsDaCat.length === 0) return;

                // Título da Seção
                const header = document.createElement('div');
                header.className = 'category-header';
                header.innerText = `${catNome} (${prodsDaCat.length})`;
                gridContainer.appendChild(header);

                // Grid Interno
                const subGrid = document.createElement('div');
                subGrid.className = 'category-items-container';

                prodsDaCat.forEach(p => {
                    const card = document.createElement('div');
                    card.className = `card ${p._changed ? 'status-changed' : 'status-synced'}`;
                    
                    const imgUrl = (p.url_imagem && p.url_imagem.length > 5) ? p.url_imagem : 'https://placehold.co/300x300?text=SEM+FOTO';
                    
                    // Gera opções do seletor
                    let options = "";
                    categoriasDisponiveis.forEach(c => {
                        options += `<option value="${c}" ${c === p.categoria ? 'selected' : ''}>${c}</option>`;
                    });

                    card.innerHTML = `
                        <div class="card-img-area" onclick="openEditor('${p.codigo}')">
                            <img src="${imgUrl}" class="card-img" onerror="this.src='https://placehold.co/300x300?text=ERRO'">
                            <div class="img-overlay">
                                <button class="overlay-btn" onclick="event.stopPropagation(); openEditor('${p.codigo}')" title="Editar Imagem"><i data-lucide="edit-2" size="16"></i></button>
                                <button class="overlay-btn" onclick="event.stopPropagation(); searchGoogle('${p.nome}')" title="Buscar no Google" style="margin-left:8px;"><i data-lucide="search" size="16"></i></button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="card-sku">
                                <span>${p.codigo}</span>
                                <select class="cat-select" onchange="updateProduct('${p.codigo}', 'categoria', this.value)">
                                    ${options}
                                </select>
                            </div>
                            
                            <textarea class="card-title-input" onchange="updateProduct('${p.codigo}', 'nome', this.value)">${p.nome}</textarea>

                            <div style="font-size:10px; color:var(--text-secondary); margin: 4px 0; display:grid; grid-template-columns: 1fr 1fr; gap:2px;">
                                <span style="display:flex; align-items:center;">EAN: <strong style="color:var(--text-primary); margin-left:4px;">${p.gtin || '-'}</strong>
                                    ${p.gtin ? `<button class="icon-btn-mini" onclick="searchGoogle('${p.gtin}')" title="Buscar EAN no Google"><i data-lucide="search" size="10"></i></button>` : ''}
                                </span>
                                <span>NCM: <strong style="color:var(--text-primary)">${p.ncm || '-'}</strong></span>
                                <span style="grid-column: span 2">VAL: <strong style="color:${p.validade ? '#d97706' : 'var(--text-primary)'}">${p.validade || '-'}</strong></span>
                            </div>
                            
                            <div class="card-stats">
                                <div class="stat-box">
                                    <span class="stat-label">Preço (R$)</span>
                                    <input class="stat-input" value="${formatNum(p.preco)}" 
                                        onchange="updateProduct('${p.codigo}', 'preco', this.value)">
                                </div>
                                <div class="stat-box">
                                    <span class="stat-label">Estoque</span>
                                    <input class="stat-input" value="${formatNum(p.estoque)}" 
                                        onchange="updateProduct('${p.codigo}', 'estoque', this.value)">
                                </div>
                            </div>

                            <div style="margin-top:8px;">
                                <div class="stat-box">
                                    <span class="stat-label">Localização</span>
                                    <input class="stat-input" value="${p.localizacao||''}" 
                                        onchange="updateProduct('${p.codigo}', 'localizacao', this.value)"
                                        style="text-align:left;">
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn-text" onclick="openDetails('${p.codigo}')">
                                <i data-lucide="list-plus" size="14"></i> DETALHES
                            </button>
                            <button class="btn-text" onclick="printLabel('${p.codigo}')" title="Imprimir Etiqueta" style="margin-left:10px;">
                                <i data-lucide="printer" size="14"></i>
                            </button>
                            <div style="flex-grow:1"></div>
                            ${p._changed ? 
                                `<button class="btn-sync-mini" onclick="syncSingle('${p.codigo}')">
                                    <i data-lucide="refresh-cw" size="12"></i> SYNC
                                </button>` : 
                                `<i data-lucide="check-circle" size="16" color="var(--success)"></i>`
                            }
                        </div>
                    `;
                    subGrid.appendChild(card);
                });
                gridContainer.appendChild(subGrid);
            });
            lucide.createIcons();
        }

        function printLabel(sku) {
            const p = products.find(x => x.codigo === sku);
            if (!p) return;

            const w = window.open('', '', 'width=400,height=300');
            w.document.write(`
                <html>
                <head>
                    <style>
                        @page { size: 80mm 40mm; margin: 0; }
                        body { 
                            width: 80mm; height: 40mm; 
                            margin: 0; padding: 2mm; 
                            display: flex; flex-direction: column; 
                            justify-content: center; align-items: center; 
                            font-family: sans-serif; text-align: center; 
                        }
                        .name { font-size: 14px; font-weight: 900; margin-bottom: 4px; line-height: 1.1; max-height: 28px; overflow: hidden; text-transform: uppercase; }
                        .sku { font-size: 18px; font-weight: bold; margin: 4px 0; border: 2px solid #000; padding: 2px 8px; border-radius: 4px; }
                        .meta { font-size: 12px; display: flex; gap: 10px; font-weight: bold; margin-top: 4px; }
                        .loc { background: #000; color: #fff; padding: 2px 6px; border-radius: 3px; }
                    </style>
                </head>
                <body>
                    <div class="name">${p.nome}</div>
                    <div class="sku">${p.codigo}</div>
                    <div class="meta">
                        <span>NCM: ${p.ncm || '---'}</span>
                        <span class="loc">${p.localizacao || 'SEM LOC'}</span>
                    </div>
                    <script>window.onload = function() { window.print(); }<\/script>
                </body>
                </html>
            `);
            w.document.close();
        }

        function updateProduct(sku, field, value) {
            const p = products.find(x => x.codigo === sku);
            if(!p) return;

            let finalVal = value;
            if(field === 'preco' || field === 'estoque') {
                finalVal = parseFloat(value.replace(',','.')) || 0;
            }

            if(p[field] != finalVal) {
                addToHistory(sku, p.nome, `Alterou ${field}: ${p[field]} -> ${finalVal}`);
                p[field] = finalVal;
                // Atualiza também o campo original do CSV se existir mapeamento direto
                if(field === 'nome') {
                    p['Descrição'] = finalVal;
                    // Recalcula categoria se o nome mudar, a menos que o usuário tenha mudado manualmente antes
                    // Mas como mudou o nome, é bom reavaliar ou manter. Aqui manteremos a atual.
                }
                if(field === 'preco') p['Preço'] = value; // Mantém string original
                if(field === 'estoque') p['Estoque'] = value;
                if(field === 'localizacao') p['Localização'] = finalVal;

                p._changed = true;
                p._lastChange = new Date().toLocaleString();
                saveData();
                
                // Se alterar categoria ou nome, re-renderiza a grid para mover de seção
                if(field === 'categoria' || field === 'nome') renderGrid(); 
            }
        }

        function formatNum(n) {
            return n ? n.toLocaleString('pt-BR', {minimumFractionDigits: 2}) : '0,00';
        }

        function attemptLogin() {
            const pass = document.getElementById('login-pass').value;
            if(USERS[pass]) {
                currentUser = USERS[pass];
                if(document.getElementById('save-login').checked) {
                    localStorage.setItem(LOGIN_KEY, currentUser);
                }
                closeModal('modal-login');
                alert(`Bem-vindo, ${currentUser}!`);
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }

        // --- NOVO SISTEMA DE DETALHES DINÂMICO ---
        function openDetails(sku) {
            const p = products.find(x => x.codigo === sku);
            if(!p) return;
            currentEditingId = sku;
            
            const form = document.getElementById('details-form');
            form.innerHTML = '';
            
            // Filtra chaves internas
            const keys = Object.keys(p).filter(k => !k.startsWith('_') && k !== 'formato' && k !== 'situacao');
            
            // Ordena: Prioritários primeiro, depois alfabético
            const priorities = ['codigo', 'nome', 'categoria', 'gtin', 'ncm', 'cest', 'preco', 'estoque'];
            keys.sort((a,b) => {
                const ia = priorities.indexOf(a);
                const ib = priorities.indexOf(b);
                if(ia !== -1 && ib !== -1) return ia - ib;
                if(ia !== -1) return -1;
                if(ib !== -1) return 1;
                return a.localeCompare(b);
            });

            keys.forEach(k => {
                const div = document.createElement('div');
                div.className = 'form-group';
                
                // Campos longos ocupam 2 colunas
                const valStr = String(p[k]||'');
                if(valStr.length > 30 || k === 'nome' || k === 'Descrição' || k.includes('URL') || k.includes('Obs')) {
                    div.style.gridColumn = "span 2";
                }
                
                div.innerHTML = `
                    <label>${k}</label>
                    <input type="text" value="${p[k]!==undefined && p[k]!==null ? p[k] : ''}" data-key="${k}" class="detail-input">
                `;
                form.appendChild(div);
            });
            
            openModal('modal-details');
        }

        function saveDetails() {
            const p = products.find(x => x.codigo === currentEditingId);
            if(!p) return;
            
            let changed = false;
            const inputs = document.querySelectorAll('.detail-input');

            inputs.forEach(inp => {
                const k = inp.getAttribute('data-key');
                let val = inp.value;

                // Tenta manter consistência numérica nos campos vitais
                if(['preco','estoque','pesoLiquido','pesoBruto','largura','altura','profundidade'].includes(k)) {
                     const num = parseFloat(val.replace(',','.'));
                     if(!isNaN(num)) val = num; // Atualiza para número se for campo interno
                }

                if(p[k] != val) {
                    // Log apenas de campos principais para evitar spam
                    if(['preco','estoque','nome'].includes(k)) {
                        addToHistory(p.codigo, p.nome, `Alterou ${k}`);
                    }
                    p[k] = val;
                    changed = true;
                }
            });

            if(changed) { p._changed = true; saveData(); renderGrid(); }
            closeModal('modal-details');
        }

        function openConfigModal() {
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
            document.getElementById('cfg-token').value = cfg.token||'';
            document.getElementById('cfg-user').value = cfg.user||'';
            document.getElementById('cfg-repo').value = cfg.repo||'';
            document.getElementById('cfg-path').value = cfg.path||'';
            openModal('modal-config');
        }

        function saveConfig() {
            const cfg = {
                token: document.getElementById('cfg-token').value,
                user: document.getElementById('cfg-user').value,
                repo: document.getElementById('cfg-repo').value,
                path: document.getElementById('cfg-path').value
            };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
            closeModal('modal-config');
            alert("Configurações Salvas!");
        }

        function restaurarLinksPadraoSite() {
            if(!confirm("Isso mudará TODAS as imagens para 'i/..site/img/produtos/CODIGO.webp'. Continuar?")) return;
            
            let count = 0;
            products.forEach(p => {
                const novoLink = `../site/img/produtos/${p.codigo}.webp?v=${Date.now()}`;
                if(p.url_imagem !== novoLink) {
                    p.url_imagem = novoLink;
                    p._changed = true;
                    count++;
                }
            });
            saveData();
            renderGrid();
            alert(`${count} produtos atualizados para o padrão do site!`);
        }

        // --- EDITOR ---
        function openEditor(sku) {
            const p = products.find(x => x.codigo === sku);
            currentEditingId = sku;
            document.getElementById('file-name-preview').innerText = sku + ".webp";
            
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = p.url_imagem || "";
            img.onload = () => {
                loadedImage = img;
                drawCanvas();
                openModal('modal-editor');
            };
            img.onerror = () => {
                loadedImage = null;
                drawCanvas(); // limpa
                openModal('modal-editor');
            };
        }

        function setupEditorEvents() {
            ['zoomRange','sharpenRange','brightnessRange'].forEach(id => {
                document.getElementById(id).addEventListener('input', drawCanvas);
            });
            
            document.getElementById('fileInput').addEventListener('change', (e) => {
                if(e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        const img = new Image();
                        img.onload = () => { loadedImage = img; drawCanvas(); };
                        img.src = evt.target.result;
                        
                        document.getElementById('file-size-preview').innerText = 
                            Math.round(e.target.files[0].size/1024) + "kb";
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // PASTE EVENT (CTRL+V)
            window.addEventListener('paste', e => {
                if(document.getElementById('modal-editor').style.display === 'none') return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file' && item.type.includes('image/')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onload = () => { loadedImage = img; drawCanvas(); };
                            img.src = event.target.result;
                            document.getElementById('file-size-preview').innerText = "Colado da Área de Transf.";
                        };
                        reader.readAsDataURL(blob);
                    }
                }
            });
        }

        function toggleSticker(type) {
            if(activeSticker === type) activeSticker = null;
            else activeSticker = type;
            
            document.querySelectorAll('.sticker-btn').forEach(b => b.classList.remove('active'));
            if(activeSticker) document.getElementById('stk-'+type).classList.add('active');
            drawCanvas();
        }

        function applySharpen(ctx, w, h, mix) {
            if (mix <= 0) return;
            try {
                const imageData = ctx.getImageData(0, 0, w, h);
                const data = imageData.data;
                const w4 = w * 4;
                const copy = new Uint8ClampedArray(data);

                // Convolution Kernel for Sharpening
                for (let y = 1; y < h - 1; y++) {
                    for (let x = 1; x < w - 1; x++) {
                        const i = (y * w + x) * 4;
                        for (let c = 0; c < 3; c++) {
                            const val = 
                                copy[i + c] * (1 + 4 * mix) +
                                copy[i + c - 4] * (-mix) +
                                copy[i + c + 4] * (-mix) +
                                copy[i + c - w4] * (-mix) +
                                copy[i + c + w4] * (-mix);
                            data[i + c] = val;
                        }
                    }
                }
                ctx.putImageData(imageData, 0, 0);
            } catch(e) {
                console.warn("Sharpen not possible (CORS?)", e);
            }
        }

        function drawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if(loadedImage) {
                const zoom = parseFloat(document.getElementById('zoomRange').value);
                const bright = parseFloat(document.getElementById('brightnessRange').value);
                const sharpen = parseFloat(document.getElementById('sharpenRange').value);
                
                ctx.filter = `brightness(${bright})`;
                
                const w = loadedImage.width * zoom;
                const h = loadedImage.height * zoom;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;
                
                ctx.drawImage(loadedImage, x, y, w, h);
                ctx.filter = 'none'; 
                
                // Aplica Nitidez após desenhar
                if(sharpen > 0) applySharpen(ctx, canvas.width, canvas.height, sharpen);

            } else {
                ctx.font = "20px Inter";
                ctx.fillStyle = "#94a3b8";
                ctx.textAlign = "center";
                ctx.fillText("Sem imagem", canvas.width/2, canvas.height/2);
            }

            if(activeSticker) {
                ctx.save();
                // Removida rotação e ajustadas coordenadas para horizontal topo-esquerdo
                const bannerW = 280;
                const bannerH = 60;
                const padTop = 30; // Respiro do topo
                
                // Desenha Banner (Retângulo Horizontal)
                ctx.fillStyle = (activeSticker === 'offer') ? "#ef4444" : (activeSticker === 'best' ? "#f59e0b" : "#3b82f6");
                ctx.fillRect(0, padTop, bannerW, bannerH);
                
                // Texto
                let text = "";
                if(activeSticker === 'offer') text = "OFERTA";
                if(activeSticker === 'best') text = "MELHOR PREÇO";
                if(activeSticker === 'today') text = "SÓ HOJE";

                ctx.font = "900 30px Inter";
                ctx.fillStyle = "white";
                ctx.textAlign = "left";
                ctx.shadowColor = "rgba(0,0,0,0.5)";
                ctx.shadowBlur = 4;
                
                // Texto alinhado à esquerda dentro do banner
                ctx.fillText(text, 20, padTop + 40);

                ctx.restore();
            }
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = currentEditingId + '.webp';
            link.href = canvas.toDataURL('image/webp', 0.9);
            link.click();
        }

        async function uploadToGithub() {
            if(!currentEditingId) return;
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY));
            if(!cfg || !cfg.token) return alert("Configure o Token do GitHub!");

            toggleLoader(true, "Enviando pro GitHub...");
            
            const base64 = canvas.toDataURL('image/webp', 0.9).split(',')[1];
            const fileName = currentEditingId + ".webp";
            const path = `${cfg.path}/${fileName}`.replace('//','/');
            const url = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${path}`;

            try {
                let sha = null;
                try {
                    const check = await fetch(url, { headers: { "Authorization": `token ${cfg.token}` } });
                    if(check.ok) { const json = await check.json(); sha = json.sha; }
                } catch(e) {}

                const body = {
                    message: `Alt: ${currentEditingId} via Painel`,
                    content: base64
                };
                if(sha) body.sha = sha;

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        "Authorization": `token ${cfg.token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(body)
                });

                if(!res.ok) throw new Error(await res.text());

                const p = products.find(x => x.codigo === currentEditingId);
                p.url_imagem = `../site/img/produtos/${fileName}?v=${Date.now()}`;
                
                const logMsg = `[Alt: ${currentUser} em ${new Date().toLocaleString()} - Alt: Imagem (Upload)]`;
                p.observacoes = (p.observacoes || "") + " | " + logMsg;
                
                p._changed = true;
                saveData();
                renderGrid();
                closeModal('modal-editor');
                alert("Sucesso! Imagem atualizada.");

            } catch(err) {
                alert("Erro GitHub: " + err.message);
            } finally {
                toggleLoader(false);
            }
        }

        function syncSingle(sku) {
            const p = products.find(x => x.codigo === sku);
            if(!p) return;
            if(!confirm(`Confirmar envio de ${p.nome}?`)) return;
            const payload = [p];
            sendToWebhook(payload, () => {
                p._changed = false;
                saveData();
                renderGrid();
            });
        }

        function sendToWebhook(data, callback) {
            toggleLoader(true, "Enviando...");
            fetch(MAKE_WEBHOOK_UPDATE, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(r => {
                if(r.ok) {
                    callback();
                    alert("Sincronizado!");
                } else {
                    alert("Erro ao enviar.");
                }
            }).catch(e => alert("Erro: " + e))
            .finally(() => toggleLoader(false));
        }

        function addToHistory(sku, name, action) {
            if(!currentUser) return;
            const log = {
                date: new Date().toLocaleString(),
                user: currentUser,
                sku: sku,
                name: name,
                action: action
            };
            historyLog.unshift(log);
            if(historyLog.length > 200) historyLog.pop();
            localStorage.setItem(HISTORY_KEY, JSON.stringify(historyLog));
        }

        function renderHistory() {
            const tbody = document.getElementById('history-tbody');
            tbody.innerHTML = historyLog.map(h => `
                <tr>
                    <td>${h.date}</td>
                    <td>${h.user}</td>
                    <td style="font-weight:bold; color:var(--accent)">${h.sku}</td>
                    <td>${h.name}</td>
                    <td>${h.action}</td>
                </tr>
            `).join('');
        }

        function clearHistory() {
            if(confirm("Apagar todo o histórico?")) {
                historyLog = [];
                localStorage.setItem(HISTORY_KEY, '[]');
                renderHistory();
            }
        }
    </script>
</body>
</html>
