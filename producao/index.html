<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Dona Antonia - v5 Alto Contraste</title>

    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #3b82f6; /* Azul mais claro */
            --success: #22c55e;
            --warning: #f59e0b;
            --bg: #0f172a;
            --header-bg: #1e293b;
            --row-bg: #1e293b;
            --row-alt: #334155;
            --text-color: #ffffff;
            --accent: #38bdf8;
            --nav-height: 70px;
        }

        /* GERAL */
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-color); }
        
        /* NAV */
        .global-nav { height: var(--nav-height); background: #020617; display: flex; align-items: center; padding: 0 20px; gap: 10px; border-bottom: 2px solid var(--accent); }
        .logo { color: var(--accent); font-weight: 900; font-size: 20px; margin-right: 20px; letter-spacing: 1px; }
        .nav-btn { height: 40px; padding: 0 20px; border-radius: 6px; border: 1px solid #475569; background: #1e293b; color: #cbd5e1; font-weight: 700; cursor: pointer; font-size: 12px; transition: all 0.2s; text-transform: uppercase; }
        .nav-btn:hover { background: #334155; color: white; border-color: white; }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--accent); }
        .nav-btn.config { margin-left: auto; border-color: var(--warning); color: var(--warning); }

        /* VIEW */
        .view-pane { width: 100%; height: calc(100vh - var(--nav-height)); display: none; padding: 15px; box-sizing: border-box; }
        .view-pane.active { display: block; }

        /* CONTROLS */
        .controls-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        #search-field { flex-grow: 1; padding: 12px; border-radius: 6px; border: 2px solid #475569; background: #0f172a; color: white; font-size: 16px; font-weight: bold; outline: none; }
        #search-field:focus { border-color: var(--accent); }
        .btn-action { padding: 0 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; text-transform: uppercase; color: white; }
        .btn-bling { background: var(--warning); color: black; }
        .btn-csv { background: #475569; }

        /* --- CORRE√á√ÉO DE VISIBILIDADE DA TABELA --- */
        #product-table { height: calc(100% - 60px); border-radius: 8px; overflow: hidden; border: 1px solid #475569; background-color: var(--bg); }
        
        /* Cabe√ßalho da Tabela */
        .tabulator .tabulator-header { background-color: #000 !important; color: var(--accent) !important; font-weight: 900; border-bottom: 2px solid var(--accent) !important; }
        .tabulator .tabulator-header .tabulator-col { background-color: #000 !important; }
        
        /* Linhas da Tabela (ALTO CONTRASTE) */
        .tabulator .tabulator-row { background-color: var(--row-bg) !important; color: #ffffff !important; border-bottom: 1px solid #475569 !important; }
        .tabulator .tabulator-row.tabulator-row-even { background-color: var(--row-alt) !important; } /* Zebra */
        .tabulator .tabulator-row:hover { background-color: #475569 !important; cursor: pointer; }
        
        /* C√©lulas Edit√°veis */
        .tabulator-cell.tabulator-editing { background-color: #ffffff !important; color: #000000 !important; }

        /* --- BOT√ïES INTERNOS --- */
        .btn-grid-group { display: flex; gap: 4px; justify-content: center; }
        .mini-btn { border: none; border-radius: 4px; padding: 6px 10px; font-size: 11px; font-weight: 800; cursor: pointer; color: white; text-transform: uppercase; }
        
        /* Cores dos Bot√µes */
        .btn-sync { background: var(--success); border: 1px solid #166534; } /* Verde */
        .btn-photo { background: var(--primary); border: 1px solid #1e40af; } /* Azul */
        .btn-details { background: #64748b; border: 1px solid #475569; } /* Cinza */
        
        .btn-copy-name { background: #8b5cf6; } /* Roxo */
        .btn-gen-link { background: #ec4899; } /* Rosa */

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-card { background: #1e293b; padding: 25px; border-radius: 12px; width: 650px; max-width: 95%; max-height: 95vh; overflow-y: auto; border: 2px solid var(--accent); box-shadow: 0 0 30px rgba(0,0,0,0.8); display: flex; flex-direction: column; gap: 15px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #475569; padding-bottom: 10px; }
        .modal-title { font-size: 20px; font-weight: bold; color: white; }
        .close-btn { background: #ef4444; border: none; color: white; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* EDITOR */
        .editor-container { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        canvas { background: #fff; border: 4px solid #475569; max-width: 100%; }
        .editor-controls { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; background: #0f172a; padding: 10px; border-radius: 8px; }
        label { font-size: 12px; color: #94a3b8; font-weight: bold; display: block; margin-bottom: 5px; }
        input[type="range"] { width: 100%; cursor: pointer; }

        /* DETALHES */
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { color: var(--accent); margin-bottom: 5px; font-size: 12px; text-transform: uppercase; }
        .form-group input { background: #0f172a; border: 1px solid #475569; color: white; padding: 10px; border-radius: 4px; font-size: 14px; }
        .form-group input:focus { border-color: var(--accent); outline: none; }

        /* LOADER */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .spinner { width: 50px; height: 50px; border: 5px solid #334155; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <script>
        const MAKE_WEBHOOK_GET = "COLE_AQUI_SEU_WEBHOOK_DE_BUSCA"; 
        const MAKE_WEBHOOK_UPDATE = "https://hook.eu1.make.com/kvi7j1d7wsmrskoemdn86ykscenumt67";
        
        const STORAGE_KEY = 'sucedoan_data_v5';
        const CONFIG_KEY = 'sucedoan_config';
    </script>

    <nav class="global-nav">
        <div class="logo">DONA ANTONIA</div>
        <button class="nav-btn active" onclick="showView('producao')">üì¶ PRODU√á√ÉO</button>
        <button class="nav-btn" onclick="showView('pedidos')">üìÑ PEDIDOS</button>
        <button class="nav-btn config" onclick="openConfigModal()">‚öôÔ∏è GITHUB</button>
    </nav>

    <div id="view-producao" class="view-pane active">
        <div class="controls-bar">
            <input type="text" id="search-field" placeholder="üîé Digite para filtrar...">
            <button class="btn-action btn-bling" onclick="importarBling()">‚òÅ Baixar do Bling</button>
            <input type="file" id="csv-file" accept=".csv" style="display:none">
            <button class="btn-action btn-csv" onclick="document.getElementById('csv-file').click()">üìÇ CSV</button>
        </div>
        <div id="product-table"></div>
    </div>

    <div id="modal-editor" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title">Editor de Imagem (Envio GitHub)</span>
                <button class="close-btn" onclick="closeModal('modal-editor')">FECHAR</button>
            </div>
            
            <div class="editor-container">
                <canvas id="imageCanvas" width="500" height="500"></canvas>
                <div style="color:var(--accent); font-size:12px; font-weight:bold;">Ctrl+V para Colar Imagem</div>

                <div class="editor-controls">
                    <div>
                        <label>ZOOM (Aproximar/Afastar)</label>
                        <input type="range" id="zoomRange" min="0.1" max="3" step="0.1" value="1">
                    </div>
                    <div>
                        <label>NITIDEZ (Defini√ß√£o)</label>
                        <input type="range" id="sharpenRange" min="0" max="10" step="1" value="0">
                    </div>
                </div>

                <div style="display:flex; gap:10px; width:100%">
                    <button class="btn-action btn-csv" style="flex:1" onclick="document.getElementById('fileInput').click()">üìÇ Do PC</button>
                    <input type="file" id="fileInput" style="display:none" accept="image/*">
                    <button class="btn-action btn-photo" style="flex:1" onclick="uploadToGithub()">üöÄ ENVIAR PARA GITHUB</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-details" class="modal-overlay">
        <div class="modal-card">
            <div class="modal-header">
                <span class="modal-title">Detalhes do Produto</span>
                <button class="close-btn" onclick="saveDetailsAndClose()">üíæ SALVAR</button>
            </div>
            <div class="details-grid" id="details-form"></div>
        </div>
    </div>

    <div id="modal-config" class="modal-overlay">
        <div class="modal-card" style="width:400px; height:auto;">
            <div class="modal-header"><span class="modal-title">Configurar GitHub</span><button class="close-btn" onclick="closeModal('modal-config')">X</button></div>
            <div class="form-group"><label>GitHub Token (PAT)</label><input type="password" id="cfg-token"></div>
            <div class="form-group"><label>Usu√°rio</label><input type="text" id="cfg-user"></div>
            <div class="form-group"><label>Reposit√≥rio</label><input type="text" id="cfg-repo"></div>
            <div class="form-group"><label>Pasta</label><input type="text" id="cfg-path" value="site/img/produtos"></div>
            <button class="btn-action btn-sync" onclick="saveConfig()" style="margin-top:15px">SALVAR DADOS</button>
        </div>
    </div>

    <div id="loader"><div class="spinner"></div><h3 id="loader-msg">Processando...</h3></div>

    <script>
        var table;
        var currentEditingRow = null;
        var canvas = document.getElementById('imageCanvas');
        var ctx = canvas.getContext('2d');
        var loadedImage = null;
        var imageState = { x: 0, y: 0, scale: 1 };

        window.onload = function() {
            const saved = localStorage.getItem(STORAGE_KEY);
            initTable(saved ? JSON.parse(saved) : []);
            setupEditorEvents();
            loadConfig();
        };

        function toggleLoader(show, msg) {
            document.getElementById('loader').style.display = show ? 'flex' : 'none';
            document.getElementById('loader-msg').innerText = msg || "Processando...";
        }

        // --- DEFINI√á√ÉO DA TABELA (REVISADA) ---
        function initTable(data) {
            table = new Tabulator("#product-table", {
                data: data,
                layout: "fitColumns",
                height: "100%",
                reactiveData: true,
                movableColumns: true, // Permite arrastar colunas
                columns: [
                    // 1. A√á√ïES PRINCIPAIS (Esquerda)
                    {title: "A√á√ïES DO SISTEMA", width: 190, headerSort:false, frozen:true, hozAlign:"center", formatter: function(){
                        return `
                            <div class="btn-grid-group">
                                <button class="mini-btn btn-sync" title="Enviar para o Bling">‚òÅ BLING</button>
                                <button class="mini-btn btn-photo" title="Abrir Editor">üì∏ FOTO</button>
                                <button class="mini-btn btn-details" title="Mais Dados">üìù +DET</button>
                            </div>
                        `;
                    }, cellClick: function(e, cell){
                        const t = e.target;
                        const row = cell.getRow();
                        if(t.classList.contains('btn-sync')) syncBling(row.getData(), t);
                        if(t.classList.contains('btn-photo')) openPhotoEditor(row);
                        if(t.classList.contains('btn-details')) openDetails(row);
                    }},

                    // 2. DADOS DO PRODUTO (Meio)
                    {title: "SKU", field: "codigo", width: 90, headerFilter:"input", cssClass:"font-bold"},
                    {title: "NOME DO PRODUTO", field: "nome", widthGrow: 2, headerFilter:"input", editor:"input"},
                    
                    // 3. FERRAMENTAS DE IMAGEM (Restaurado: COPIAR e LINK)
                    {title: "FERRAMENTAS IMG", width: 150, headerSort:false, hozAlign:"center", formatter: function(){
                        return `
                            <div class="btn-grid-group">
                                <button class="mini-btn btn-copy-name" title="Copiar nome slug">üìã NOME</button>
                                <button class="mini-btn btn-gen-link" title="Gerar Link GitHub">üîó LINK</button>
                            </div>
                        `;
                    }, cellClick: function(e, cell){
                        const t = e.target;
                        const row = cell.getRow();
                        const data = row.getData();

                        if(t.classList.contains('btn-copy-name')) {
                            const slug = slugify(data.nome);
                            navigator.clipboard.writeText(slug);
                            alert("Copiado: " + slug);
                        }
                        if(t.classList.contains('btn-gen-link')) {
                             const slug = slugify(data.nome);
                             const urlFinal = `https://github.com/osvaldosereia/SUCEDOAN12/blob/main/site/img/produtos/${slug}-cesta-basica-cuiaba-varzea-grande.webp?raw=true`;
                             row.update({url_imagem: urlFinal});
                             saveData();
                             alert("Link Gerado!");
                        }
                    }},

                    // 4. LINK DA IMAGEM E DADOS EXTRAS
                    {title: "URL IMAGEM", field: "url_imagem", width: 100, editor:"input", formatter:"link", formatterParams:{label:"ABRIR", target:"_blank"}},
                    {title: "EST", field: "estoque", width: 70, hozAlign:"center", editor:"number"},
                    {title: "LOCAL", field: "localizacao", width: 90, editor:"input"},
                    {title: "EAN", field: "gtin", width: 110, editor:"input"},
                    {title: "NCM", field: "ncm", width: 90, editor:"input"}
                ],
                cellEdited: () => saveData()
            });

            // Filtro
            document.getElementById("search-field").addEventListener("input", function(e){
                const val = e.target.value;
                table.setFilter([[{field:"codigo", type:"like", value:val}, {field:"nome", type:"like", value:val}, {field:"gtin", type:"like", value:val}]]);
            });
        }

        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData())); }

        // --- EDITOR DE IMAGEM ---
        function openPhotoEditor(row) {
            currentEditingRow = row;
            document.getElementById('modal-editor').style.display = 'flex';
            ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0,0, 500, 500); // Reset
            ctx.font = "20px Arial"; ctx.fillStyle = "#000"; ctx.fillText("Cole (Ctrl+V) ou Abra", 150, 250);
            loadedImage = null;
        }

        function setupEditorEvents() {
            window.addEventListener('paste', function(e) {
                if(document.getElementById('modal-editor').style.display !== 'flex') return;
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let i in items) {
                    if (items[i].kind === 'file') {
                        const reader = new FileReader();
                        reader.onload = (ev) => loadImageToCanvas(ev.target.result);
                        reader.readAsDataURL(items[i].getAsFile());
                    }
                }
            });
            document.getElementById('fileInput').addEventListener('change', function(e){
                if(this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (evt) => loadImageToCanvas(evt.target.result);
                    reader.readAsDataURL(this.files[0]);
                }
            });
            document.getElementById('zoomRange').addEventListener('input', drawImage);
        }

        function loadImageToCanvas(url) {
            const img = new Image();
            img.onload = function() {
                loadedImage = img;
                imageState.scale = Math.max(500/img.width, 500/img.height);
                document.getElementById('zoomRange').value = imageState.scale;
                drawImage();
            };
            img.src = url;
        }

        function drawImage() {
            if(!loadedImage) return;
            ctx.fillStyle = "#FFFFFF"; ctx.fillRect(0,0, 500, 500); // Fundo Branco
            const zoom = parseFloat(document.getElementById('zoomRange').value);
            const w = loadedImage.width * zoom;
            const h = loadedImage.height * zoom;
            const x = (500 - w) / 2;
            const y = (500 - h) / 2;
            ctx.drawImage(loadedImage, x, y, w, h);
        }

        async function uploadToGithub() {
            if(!loadedImage) return alert("Cole uma imagem primeiro!");
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY) || '{}');
            if(!cfg.token) return alert("Configure o Token na engrenagem!");

            toggleLoader(true, "Enviando para GitHub...");
            
            // Qualidade WebP
            const dataUrl = canvas.toDataURL("image/webp", 0.8);
            const base64Content = dataUrl.split(',')[1];
            
            // Slugify Nome
            const rowData = currentEditingRow.getData();
            const slug = slugify(rowData.nome) + "-cesta-basica-cuiaba-varzea-grande.webp";
            const path = cfg.path + "/" + slug;
            const apiUrl = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${path}`;

            try {
                let sha = null;
                try {
                    const check = await fetch(apiUrl, { headers: { "Authorization": `token ${cfg.token}` } });
                    if(check.ok) sha = (await check.json()).sha;
                } catch(e) {}

                const response = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: { "Authorization": `token ${cfg.token}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ message: "Update Painel", content: base64Content, sha: sha })
                });

                if(response.ok) {
                    const resJson = await response.json();
                    currentEditingRow.update({ url_imagem: resJson.content.download_url });
                    saveData();
                    toggleLoader(false);
                    closeModal('modal-editor');
                    alert("Imagem atualizada com sucesso!");
                } else {
                    throw new Error("Erro GitHub: " + response.status);
                }
            } catch(error) {
                toggleLoader(false);
                alert("Erro: " + error.message);
            }
        }

        // --- AUXILIARES ---
        function slugify(text) {
            return text.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s-]/g, '').replace(/\s+/g, '-').replace(/--+/g, '-').trim();
        }

        function openDetails(row) {
            currentEditingRow = row;
            const data = row.getData();
            const container = document.getElementById('details-form');
            container.innerHTML = "";
            const fields = [
                {k:'preco', l:'Pre√ßo Venda'}, {k:'unidade', l:'Unidade'},
                {k:'pesoBruto', l:'Peso Bruto'}, {k:'pesoLiquido', l:'Peso L√≠q'},
                {k:'cest', l:'CEST'}, {k:'largura', l:'Largura'}, 
                {k:'altura', l:'Altura'}, {k:'profundidade', l:'Profundidade'}
            ];
            fields.forEach(f => {
                container.innerHTML += `<div class="form-group"><label>${f.l}</label><input type="text" id="det-${f.k}" value="${data[f.k]||''}"></div>`;
            });
            document.getElementById('modal-details').style.display = 'flex';
        }

        function saveDetailsAndClose() {
            if(!currentEditingRow) return;
            const inputs = document.querySelectorAll('#details-form input');
            const updateData = {};
            inputs.forEach(i => updateData[i.id.replace('det-', '')] = i.value);
            currentEditingRow.update(updateData);
            saveData();
            closeModal('modal-details');
        }

        function syncBling(data, btn) {
            if(MAKE_WEBHOOK_UPDATE.includes("SEU_LINK")) return alert("Configure o Webhook UPDATE!");
            const txt = btn.innerText;
            btn.innerText = "‚è≥"; btn.disabled = true;
            
            // Sanitiza√ß√£o
            const payload = {...data};
            Object.keys(payload).forEach(k => { if(typeof payload[k] === 'string') payload[k] = payload[k].trim(); });

            fetch(MAKE_WEBHOOK_UPDATE, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            }).then(r => {
                if(r.ok) { btn.innerText = "‚úÖ"; setTimeout(()=>{btn.innerText=txt; btn.disabled=false}, 2000); }
                else throw new Error();
            }).catch(() => { btn.innerText = "‚ùå"; btn.disabled=false; });
        }

        function importarBling() {
            if(MAKE_WEBHOOK_GET.includes("COLE_AQUI")) return alert("Configure Webhook GET!");
            if(!confirm("Baixar lista do Bling?")) return;
            toggleLoader(true, "Baixando...");
            fetch(MAKE_WEBHOOK_GET).then(r=>r.json()).then(data=>{
                if(Array.isArray(data)) {
                    const clean = data.map(d=>({...d, preco: parseFloat(d.preco||0), estoque: parseFloat(d.estoque||0)}));
                    table.setData(clean);
                    saveData();
                    alert("Importado!");
                }
            }).catch(()=>alert("Erro na importa√ß√£o")).finally(()=>toggleLoader(false));
        }

        // Config & Modals
        function openConfigModal() {
            const cfg = JSON.parse(localStorage.getItem(CONFIG_KEY)||'{}');
            document.getElementById('cfg-token').value = cfg.token||'';
            document.getElementById('cfg-user').value = cfg.user||'';
            document.getElementById('cfg-repo').value = cfg.repo||'';
            document.getElementById('modal-config').style.display='flex';
        }
        function saveConfig() {
            const cfg = {
                token: document.getElementById('cfg-token').value,
                user: document.getElementById('cfg-user').value,
                repo: document.getElementById('cfg-repo').value,
                path: document.getElementById('cfg-path').value
            };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(cfg));
            closeModal('modal-config');
        }
        function loadConfig() { if(!localStorage.getItem(CONFIG_KEY)) alert("Configure o GitHub na engrenagem!"); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function showView(id) { document.querySelectorAll('.view-pane').forEach(v=>v.classList.remove('active')); document.getElementById('view-'+id).classList.add('active'); }

        document.getElementById('csv-file').addEventListener('change', function(e) {
            Papa.parse(e.target.files[0], { header:true, skipEmptyLines:true, encoding:"UTF-8", complete: (r) => {
                const map = r.data.map(d => ({
                    codigo: d["C√≥digo"]||d.codigo, nome: d["Descri√ß√£o"]||d.nome,
                    preco: d["Pre√ßo"]||d.preco, estoque: d["Estoque"]||d.estoque,
                    gtin: d["GTIN/EAN"]||d.gtin, ncm: d["NCM"]||d.ncm
                }));
                table.setData(map); saveData();
            }});
        });
    </script>
</body>
</html>
