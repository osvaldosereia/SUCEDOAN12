<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Dona Antonia - Produ√ß√£o Integrada</title>

    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0052cc;
            --success: #22c55e;
            --bg: #0f172a;
            --card: #1e293b;
            --text-main: #f8fafc;
            --accent: #38bdf8;
            --nav-height: 80px;
        }

        /* Reset e Travamento de Scroll da P√°gina */
        html, body { 
            height: 100%; margin: 0; overflow: hidden; 
            font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-main);
        }

        /* BARRA DE NAVEGA√á√ÉO SUPERIOR (TOPBAR) */
        .global-nav {
            height: var(--nav-height); background: #000; display: flex; align-items: center; 
            padding: 0 20px; gap: 8px; border-bottom: 3px solid var(--accent); z-index: 1000; position: relative;
        }

        .nav-btn {
            height: 48px; padding: 0 15px; border-radius: 8px; border: 2px solid #334155;
            background: #1e293b; color: white; font-weight: 800; cursor: pointer;
            text-decoration: none; font-size: 11px; transition: all 0.2s; text-transform: uppercase;
            display: flex; align-items: center; justify-content: center; text-align: center;
        }

        .nav-btn:hover { border-color: var(--accent); background: #334155; }
        .nav-btn.active { background: var(--primary); border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 82, 204, 0.4); }
        .nav-btn.bling { background: #f59e0b; color: #000; border-color: #d97706; }
        .nav-btn.new-order { background: #ef4444 !important; animation: pulse 2s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* CONTAINERS DE CONTE√öDO */
        .view-pane { width: 100%; height: calc(100vh - var(--nav-height)); display: none; overflow-y: auto; }
        .view-pane.active { display: block; }

        /* ESTILOS DA ABA PRODU√á√ÉO (TABELA) */
        .app-container { padding: 15px; height: 100%; display: flex; flex-direction: column; box-sizing: border-box; }
        #search-field { 
            width: 100%; padding: 16px; border-radius: 10px; border: 3px solid var(--accent); 
            font-size: 20px; font-weight: 700; outline: none; margin-bottom: 10px; background: white; color: black;
        }
        #product-table { flex-grow: 1; border-radius: 12px; overflow: hidden; font-size: 14px; background: var(--card); }

        /* BOT√ïES DE A√á√ÉO DENTRO DA TABELA */
        .action-btn { 
            border: none; border-radius: 4px; padding: 6px 8px; cursor: pointer; 
            font-weight: bold; font-size: 10px; margin-right: 2px; text-transform: uppercase; 
        }
        .btn-copy { background: #64748b; color: white; }
        .btn-link { background: var(--primary); color: white; }
        .btn-search-icon { background: #334155; color: white; border: none; border-radius: 4px; padding: 6px; cursor: pointer; }

        /* ESTILO DA LISTA DE PEDIDOS */
        .order-card { 
            background: var(--card); border-radius: 12px; margin: 15px; padding: 20px; 
            border-left: 10px solid var(--accent); display: flex; justify-content: space-between; align-items: center; 
        }
        .btn-print { 
            background: var(--success); color: white; padding: 15px 25px; 
            border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; 
        }

        /* CONFIGURA√á√ÉO DE IMPRESSORA T√âRMICA 80mm */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { 
                position: absolute; left: 0; top: 0; width: 80mm; 
                color: black !important; font-family: 'Courier New', monospace; font-size: 12px; 
            }
        }
        #print-section { display: none; background: white; padding: 10px; color: black; }
        
        /* IFRAMES PARA LINKS EXTERNOS */
        iframe { width: 100%; height: 100%; border: none; background: white; }
    </style>
</head>
<body>

    <audio id="bell-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <nav class="global-nav">
        <div style="color: var(--accent); font-weight: 900; font-size: 16px; margin-right: 10px;">DONA ANTONIA</div>
        
        <button class="nav-btn active" id="btn-producao" onclick="showView('producao', '', this)">üõ† PRODU√á√ÉO</button>
        <button class="nav-btn" id="btn-pedidos-nav" onclick="showView('pedidos', '', this)">üì¶ PEDIDOS</button>
        
        <a href="https://www.bling.com.br/vendas.checkout.php" target="_blank" class="nav-btn bling">üí∞ BLING</a>
        
        <button class="nav-btn" id="btn-editor" onclick="showView('external', 'https://donaantonia.com.br/bio/', this)">üì∏ EDITOR FOTO</button>
        <button class="nav-btn" id="btn-loja" onclick="showView('external', 'https://donaantonia.com.br/site/', this)">üõí LOJA</button>
        <button class="nav-btn" id="btn-nota" onclick="showView('external', 'https://donaantonia.com.br/produtos/', this)">üìù CADASTRAR NOTA</button>
    </nav>

    <div id="view-producao" class="view-pane active">
        <div class="app-container">
            <header style="display:flex; gap:10px;">
                <input type="text" id="search-field" placeholder="üîé ESCANEAR C√ìDIGO OU BUSCAR PRODUTO..." autofocus>
                <input type="file" id="csv-file" accept=".csv" style="display:none">
                <button onclick="document.getElementById('csv-file').click()" style="padding:10px; cursor:pointer; font-weight:bold; border-radius:8px;">SUBIR NOVO CSV</button>
                <button id="btn-export" style="background:var(--success); color:white; padding:10px 15px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">EXPORTAR CSV</button>
            </header>
            <div id="product-table"></div>
        </div>
    </div>

    <div id="view-pedidos" class="view-pane">
        <div id="lista-pedidos-container">
            <h2 style="padding: 20px;">Separa√ß√£o de Pedidos (Cupom 80mm)</h2>
            <div id="pedidos-placeholder" style="padding: 20px; opacity: 0.5;">Aguardando novos pedidos do Make.com...</div>
            </div>
    </div>

    <div id="view-external" class="view-pane">
        <iframe id="main-iframe" src=""></iframe>
    </div>

    <div id="print-section"></div>

    <script>
        var table;
        var pedidosProcessados = [];
        const STORAGE_KEY = 'sucedoan_kiosk_data';

        // --- FUN√á√ïES AUXILIARES ---

        // Transforma texto em "slug" (arroz-branco-5kg)
        function slugify(text) {
            if (!text) return "";
            return text.toString().toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .replace(/[^\w\s-]/g, '') // Remove caracteres especiais
                .replace(/\s+/g, '-') // Espa√ßos por hifens
                .replace(/--+/g, '-') 
                .trim();
        }

        // Fun√ß√£o de Impress√£o T√©rmica
        function imprimirPedido(pedido) {
            const printArea = document.getElementById('print-section');
            printArea.innerHTML = `
                <div style="text-align:center; font-weight:bold; font-size:16px;">DONA ANTONIA</div>
                <div style="text-align:center; margin-bottom:5px;">LOG√çSTICA E MONTAGEM</div>
                <hr>
                <div><b>PEDIDO:</b> #${pedido.numero}</div>
                <div><b>DATA:</b> ${new Date().toLocaleString()}</div>
                <div><b>CLIENTE:</b> ${pedido.cliente}</div>
                <hr>
                <div style="font-weight:bold; margin-bottom:5px;">ITENS:</div>
                ${pedido.itens.map(i => `<div>${i.quantidade}x ${i.descricao}</div>`).join('')}
                <hr>
                <div style="text-align:center; font-size:10px;">Sistema Sucedoan v2.0</div>
            `;
            window.print();
        }

        // --- L√ìGICA DA TABELA (TABULATOR) ---

        function initTable(data) {
            table = new Tabulator("#product-table", {
                data: data,
                layout: "fitColumns",
                height: "100%",
                movableColumns: true,
                columns: [
                    {title: "C√ìDIGO", field: "C√≥digo", width: 100, headerSort: false},
                    
                    // Coluna Google Imagens
                    {title: "üîç", width: 50, hozAlign: "center", formatter: () => "üîç", headerSort: false, cellClick: (e, cell) => {
                        const desc = cell.getData()["Descri√ß√£o"];
                        window.open("https://www.google.com/search?q=" + encodeURIComponent(desc) + "&tbm=isch", '_blank');
                    }},

                    // Coluna de A√ß√µes Automatizadas
                    {title: "A√á√ïES", width: 200, headerSort: false, hozAlign: "center", columns: [
                        {title: "COP/EDITOR", formatter: () => "<button class='action-btn btn-copy'>üìã NOME</button>", width: 95, cellClick: (e, cell) => {
                            const slug = slugify(cell.getData()["Descri√ß√£o"]);
                            navigator.clipboard.writeText(slug); // Copia o nome com hifens
                            
                            // Muda para a aba do Editor de Foto passando o nome na URL
                            const editorUrl = "https://donaantonia.com.br/bio/?nome=" + slug;
                            showView('external', editorUrl, document.getElementById('btn-editor'));
                        }},
                        {title: "GERAR GH", formatter: () => "<button class='action-btn btn-link'>üîó LINK</button>", width: 95, cellClick: (e, cell) => {
                            const slug = slugify(cell.getData()["Descri√ß√£o"]);
                            const urlFinal = `https://github.com/osvaldosereia/SUCEDOAN12/blob/main/site/img/produtos/${slug}-cesta-basica-cuiaba-varzea-grande.webp?raw=true`;
                            cell.getRow().update({"URL Imagens Externas": urlFinal});
                            localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData()));
                        }}
                    ]},

                    {title: "URL IMAGEM", field: "URL Imagens Externas", width: 220, editor: "input"},
                    {title: "DESCRI√á√ÉO DO PRODUTO", field: "Descri√ß√£o", widthGrow: 4, editor: "input"},
                    {title: "ESTOQUE", field: "Estoque", width: 90, editor: "input", hozAlign: "center"},
                    {title: "LOCAL", field: "Localiza√ß√£o", width: 130, editor: "input"},
                ],
                cellEdited: function(cell) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(table.getData()));
                }
            });

            // Filtro de Busca em Tempo Real
            document.getElementById("search-field").addEventListener("input", function(e){
                const val = e.target.value;
                table.setFilter([
                    [
                        {field:"C√≥digo", type:"like", value:val},
                        {field:"Descri√ß√£o", type:"like", value:val}
                    ]
                ]);
            });
        }

        // --- AUTOMA√á√ÉO DE PEDIDOS (MAKE.COM) ---

        async function fetchOrders() {
            try {
                // Tenta ler o arquivo JSON gerado pelo Make no seu reposit√≥rio
                const response = await fetch('pedidos.json?t=' + Date.now());
                const orders = await response.json();
                let temNovidade = false;

                orders.forEach(o => {
                    if(!pedidosProcessados.includes(o.id)) {
                        pedidosProcessados.push(o.id);
                        temNovidade = true;
                        
                        document.getElementById('pedidos-placeholder').style.display = 'none';
                        const container = document.getElementById('lista-pedidos-container');
                        
                        const card = document.createElement('div');
                        card.className = 'order-card';
                        card.innerHTML = `
                            <div>
                                <h3>Pedido #${o.numero} - ${o.cliente}</h3>
                                <p>${o.itens.length} itens no carrinho</p>
                            </div>
                            <button class="btn-print" onclick='imprimirPedido(${JSON.stringify(o)})'>üñ® IMPRIMIR</button>
                        `;
                        container.prepend(card); // Adiciona o mais novo no topo
                    }
                });

                if(temNovidade) {
                    document.getElementById('bell-sound').play();
                    document.getElementById('btn-pedidos-nav').classList.add('new-order');
                }
            } catch(e) { /* Silencioso se o arquivo ainda n√£o existir */ }
        }

        // --- GEST√ÉO DE TELAS E NAVEGA√á√ÉO ---

        function showView(viewId, url, btn) {
            // Esconde todas as panes
            document.querySelectorAll('.view-pane').forEach(v => v.classList.remove('active'));
            // Desativa bot√µes da nav
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // Ativa o bot√£o e a tela certa
            btn.classList.add('active');
            btn.classList.remove('new-order');

            if(viewId === 'external') {
                document.getElementById('view-external').classList.add('active');
                const iframe = document.getElementById('main-iframe');
                // S√≥ recarrega se a URL for diferente da atual
                if(iframe.src !== url) {
                    iframe.src = url;
                }
            } else {
                document.getElementById('view-' + viewId).classList.add('active');
                if(viewId === 'producao') {
                    setTimeout(() => document.getElementById("search-field").focus(), 100);
                }
            }
        }

        // --- INICIALIZA√á√ÉO E EVENTOS ---

        window.onload = function() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                initTable(JSON.parse(savedData));
            }
            // Inicia monitoramento do Make.com a cada 30 segundos
            setInterval(fetchOrders, 30000);
            fetchOrders(); // Primeira checagem imediata
            document.getElementById("search-field").focus();
        };

        // Upload de novo CSV (Sobrescreve o anterior)
        document.getElementById('csv-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: "UTF-8",
                complete: function(results) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(results.data));
                    initTable(results.data);
                    alert("Planilha atualizada com sucesso!");
                }
            });
        });

        // Exporta√ß√£o mantendo formato original
        document.getElementById('btn-export').addEventListener('click', function() {
            if (!table) return;
            const dataToExport = table.getData();
            const csv = Papa.unparse(dataToExport, {
                quotes: true,
                delimiter: ";",
                newline: "\r\n"
            });

            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "estoque_producao_editado.csv";
            link.click();
        });
    </script>
</body>
</html>
