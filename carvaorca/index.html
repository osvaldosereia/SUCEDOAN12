<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>BLING AUTOMATOR | Oficial V3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xml2js/0.6.2/xml2js.min.js"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        .header { background: #004a8d; color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .main { padding: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; }
        .btn-xml { background: #ff9800; color: white; margin-right: 10px; }
        .btn-xlsx { background: #2e7d32; color: white; }
        .btn:hover { opacity: 0.8; transform: scale(1.02); }
        #grid { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 22px; font-weight: bold;">ðŸ’Ž BLING Automator Local</div>
    <div>
        <input type="file" id="fInput" accept=".xml" style="display: none;">
        <button class="btn btn-xml" onclick="document.getElementById('fInput').click()">ðŸ“‚ CARREGAR XML</button>
        <button class="btn btn-xlsx" onclick="baixarPlanilhaBling()">ðŸ“¥ BAIXAR PLANILHA PARA BLING</button>
    </div>
</div>

<div class="main">
    <div id="grid"></div>
</div>

<script>
let grid;

// InicializaÃ§Ã£o da Tabela com colunas baseadas no modelo oficial do Bling 
grid = new Tabulator("#grid", {
    height: "calc(100vh - 120px)",
    layout: "fitColumns",
    placeholder: "Clique em 'CARREGAR XML' para processar a nota do fornecedor",
    columns: [
        {title: "CÃ³digo (SKU)", field: "codigo", editor: "input", headerFilter: "input"},
        {title: "DescriÃ§Ã£o", field: "descricao", width: 300, editor: "input"},
        {title: "Un. XML", field: "unOriginal", width: 90, hozAlign: "center"},
        {title: "Fator Conv.", field: "fator", editor: "number", width: 110, hozAlign: "center", 
            tooltip: "Edite aqui se for Caixa/Fardo para converter em Unidade"},
        {title: "PreÃ§o de custo (UN)", field: "custo", editor: "number", width: 150, formatter: "money"},
        {title: "Estoque Final", field: "estoque", width: 120, hozAlign: "center"},
        {title: "NCM", field: "ncm", editor: "input", width: 120},
        {title: "Origem", field: "origem", editor: "input", width: 90},
        {title: "CEST", field: "cest", editor: "input", width: 120},
        {title: "Possui ST", field: "st", width: 90, hozAlign: "center", formatter: "tickCross"}
    ]
});

document.getElementById('fInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
        const parser = new xml2js.Parser({ 
            explicitArray: false, 
            ignoreNamespaces: true // Resolve o problema de nÃ£o aparecer nada na planilha
        });

        parser.parseString(evt.target.result, function(err, res) {
            if (err) { alert("Erro ao processar XML!"); return; }

            // NavegaÃ§Ã£o segura nas tags do XML [cite: 131, 140]
            const nfe = res.nfeProc ? res.nfeProc.NFe.infNFe : (res.NFe ? res.NFe.infNFe : null);
            if (!nfe) { alert("Estrutura de NFe nÃ£o encontrada!"); return; }

            const itens = Array.isArray(nfe.det) ? nfe.det : [nfe.det];
            
            const rows = itens.map(i => {
                const p = i.prod;
                const imp = i.imposto;
                
                // Tenta capturar a Origem do ICMS independente da modalidade (00, 10, 60, etc) 
                const icmsTag = imp.ICMS[Object.keys(imp.ICMS)[0]];
                const origem = icmsTag ? icmsTag.orig : "0";
                
                // InteligÃªncia de ConversÃ£o: Se for Caixa (CX) ou Fardo (FD) 
                const un = p.uCom.toUpperCase();
                const fator = (un.includes('CX') || un.includes('FD') || un.includes('UNI')) ? 12 : 1;

                return {
                    codigo: p.cProd,
                    descricao: p.xProd,
                    unOriginal: p.uCom,
                    fator: fator,
                    qtdXml: parseFloat(p.qCom),
                    valorUnXml: parseFloat(p.vUnCom),
                    custo: (parseFloat(p.vUnCom) / fator).toFixed(2),
                    estoque: parseFloat(p.qCom) * fator,
                    ncm: p.NCM,
                    cest: p.CEST || "",
                    origem: origem,
                    st: !!(icmsTag.vICMSST || icmsTag.CST == "10" || icmsTag.CST == "60")
                };
            });
            grid.setData(rows);
        });
    };
    reader.readAsText(file);
});

function baixarPlanilhaBling() {
    const data = grid.getData();
    if (data.length === 0) { alert("Carregue um XML primeiro!"); return; }

    // Mapeamento exato para as colunas do modelo do Bling 
    const mapping = data.map(r => ({
        "ID": "", // Deixar vazio para novos cadastros 
        "CÃ³digo": r.codigo,
        "DescriÃ§Ã£o": r.descricao,
        "Unidade": "UN", // Padronizado para unidade [cite: 130, 431]
        "NCM": r.ncm,
        "Origem": r.origem,
        "PreÃ§o": (r.custo * 1.5).toFixed(2), // Markup sugestivo de 50% [cite: 207]
        "PreÃ§o de custo": r.custo,
        "Estoque": r.estoque,
        "CEST": r.cest,
        "SituaÃ§Ã£o": "Ativo", // [cite: 207]
        "InformaÃ§Ãµes Adicionais": r.st ? "Possui ST" : "" // [cite: 132]
    }));

    const ws = XLSX.utils.json_to_sheet(mapping);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Produtos");
    XLSX.writeFile(wb, "importar_no_bling.xlsx");
}
</script>
</body>
</html>
