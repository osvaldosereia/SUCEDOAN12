<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMAS | Importador NFe > Excel Bling</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --bg: #f1f5f9;
            --surface: #ffffff;
            --primary: #0f172a;
            --accent: #16a34a; /* Excel Green */
            --border: #cbd5e1;
            --font: 'Segoe UI', system-ui, sans-serif;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: var(--font); background: var(--bg); margin: 0; height: 100vh; display: flex; flex-direction: column; color: #334155; }

        header {
            background: var(--surface); height: 70px; padding: 0 25px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        
        .brand { font-size: 1.2rem; font-weight: 700; color: var(--primary); display: flex; gap: 10px; align-items: center; }
        .tag { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }

        .btn {
            background: white; border: 1px solid var(--border); padding: 10px 20px;
            border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; gap: 8px; align-items: center;
            transition: all 0.2s; position: relative; color: var(--primary);
        }
        .btn:hover { background: #f8fafc; border-color: #94a3b8; }
        .btn-green { background: var(--accent); color: white; border-color: var(--accent); }
        .btn-green:hover { background: #15803d; }
        .btn-green:disabled { background: #cbd5e1; border-color: #cbd5e1; cursor: not-allowed; }
        
        .file-wrapper input { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

        main { flex: 1; overflow: auto; padding: 20px; }
        
        .grid-header {
            display: grid; 
            grid-template-columns: 50px 120px 2fr 80px 100px 100px 100px 120px 40px; 
            gap: 15px; padding: 0 20px 10px 20px;
            font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #64748b;
        }

        .row-card {
            background: var(--surface); border-radius: 8px; margin-bottom: 8px;
            border: 1px solid var(--border); box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            transition: 0.2s;
        }
        .row-card:hover { border-color: var(--accent); transform: translateY(-1px); }

        .row-main {
            display: grid;
            grid-template-columns: 50px 120px 2fr 80px 100px 100px 100px 120px 40px;
            gap: 15px; padding: 15px 20px; align-items: center;
        }

        input { 
            width: 100%; border: 1px solid transparent; padding: 6px 8px; border-radius: 4px;
            background: transparent; font-size: 0.9rem; color: #334155; 
        }
        input:hover { background: #f8fafc; border-color: #e2e8f0; }
        input:focus { background: white; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1); }
        
        .input-num { text-align: right; font-feature-settings: "tnum"; font-weight: 600; }
        .input-factor { background: #f0fdf4; color: #15803d; text-align: center; font-weight: 700; border: 1px dashed #bbf7d0; }
        .readonly { background: #f1f5f9; color: #94a3b8; pointer-events: none; }

        /* Detail Panel */
        .row-details {
            display: none; padding: 20px; background: #f8fafc; border-top: 1px solid var(--border);
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;
        }
        .row-details.open { display: grid; }
        
        .field label { display: block; font-size: 0.7rem; color: #64748b; margin-bottom: 4px; font-weight: 600; }
        .field input { background: white; border: 1px solid #e2e8f0; }

        footer { padding: 15px 25px; background: white; border-top: 1px solid var(--border); font-size: 0.85rem; color: #64748b; display: flex; gap: 20px; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        SISTEMAS <span class="tag">XLSX EDITION</span>
    </div>
    <div style="display:flex; gap:10px">
        <div class="btn file-wrapper">
            üìÅ Importar XML
            <input type="file" id="xmlInput" accept=".xml">
        </div>
        <button class="btn btn-green" id="btnExport" onclick="App.exportExcel()" disabled>
            üìä Baixar Excel (.xlsx)
        </button>
    </div>
</header>

<div class="grid-header">
    <div>#</div>
    <div>C√≥digo</div>
    <div>Descri√ß√£o</div>
    <div style="text-align:center">Und XML</div>
    <div style="text-align:center">Fator</div>
    <div style="text-align:center">Und Venda</div>
    <div style="text-align:right">Custo Unit</div>
    <div style="text-align:right">Estoque</div>
    <div></div>
</div>

<main id="grid"></main>

<footer>
    <span id="f-supplier">Fornecedor: -</span>
    <span id="f-nfe">NFe: -</span>
    <span id="f-count">0 itens</span>
</footer>

<script>
const App = {
    data: [],
    meta: {},
    
    // Lista de colunas Exatas do Bling
    headers: [
        "ID", "C√≥digo", "Descri√ß√£o", "Unidade", "NCM", "Origem", "Pre√ßo", "Valor IPI fixo", 
        "Observa√ß√µes", "Situa√ß√£o", "Estoque", "Pre√ßo de custo", "C√≥d no fornecedor", 
        "Fornecedor", "Localiza√ß√£o", "Estoque maximo", "Estoque minimo", "Peso l√≠quido (Kg)", 
        "Peso bruto (Kg)", "GTIN/EAN", "GTIN/EAN da embalagem", "Largura do Produto", 
        "Altura do Produto", "Profundidade do produto", "Data Validade", 
        "Descri√ß√£o do Produto no Fornecedor", "Descri√ß√£o Complementar", "Itens p/ caixa", 
        "Produto Varia√ß√£o", "Tipo Produ√ß√£o", "Classe de enquadramento do IPI", 
        "C√≥digo da lista de servi√ßos", "Tipo do item", "Grupo de Tags/Tags", "Tributos", 
        "C√≥digo Pai", "C√≥digo Integra√ß√£o", "Grupo de produtos", "Marca", "CEST", "Volumes", 
        "Descri√ß√£o Curta", "Cross-Docking", "URL Imagens Externas", "Link Externo", 
        "Meses Garantia no Fornecedor", "Clonar dados do pai", "Condi√ß√£o do produto", 
        "Frete Gr√°tis", "N√∫mero FCI", "V√≠deo", "Departamento", "Unidade de medida", 
        "Pre√ßo de compra", "Valor base ICMS ST para reten√ß√£o", "Valor ICMS ST para reten√ß√£o", 
        "Valor ICMS pr√≥prio do substituto", "Categoria do produto", "Informa√ß√µes Adicionais"
    ],

    init() {
        document.getElementById('xmlInput').addEventListener('change', (e) => this.parseXML(e.target.files[0]));
    },

    parseXML(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(e.target.result, "text/xml");
            
            // Meta
            const emit = xml.querySelector('emit');
            const ide = xml.querySelector('ide');
            this.meta = {
                fornecedor: emit.querySelector('xNome')?.textContent,
                nfe: ide.querySelector('nNF')?.textContent
            };

            // Itens
            this.data = [];
            xml.querySelectorAll('det').forEach((det, i) => {
                const prod = det.querySelector('prod');
                const imposto = det.querySelector('imposto');

                // Impostos ocultos para custo real
                const vProd = parseFloat(prod.querySelector('vProd')?.textContent || 0);
                const qCom = parseFloat(prod.querySelector('qCom')?.textContent || 0);
                
                let vOutros = 0;
                // Soma IPI + ST + Frete
                const ipi = imposto.querySelector('IPI vIPI')?.textContent;
                const st = imposto.querySelector('vICMSST')?.textContent; // Busca gen√©rica
                const frete = prod.querySelector('vFrete')?.textContent;
                
                if(ipi) vOutros += parseFloat(ipi);
                if(st) vOutros += parseFloat(st);
                if(frete) vOutros += parseFloat(frete);

                const custoTotal = vProd + vOutros;

                this.data.push({
                    _id: i,
                    codigo: prod.querySelector('cProd')?.textContent,
                    descricao: prod.querySelector('xProd')?.textContent,
                    ncm: prod.querySelector('NCM')?.textContent,
                    cest: prod.querySelector('CEST')?.textContent || "",
                    ean: prod.querySelector('cEAN')?.textContent,
                    unidadeXML: prod.querySelector('uCom')?.textContent,
                    unidadeVenda: prod.querySelector('uCom')?.textContent === 'CX' ? 'UN' : prod.querySelector('uCom')?.textContent,
                    qCom: qCom,
                    custoTotal: custoTotal,
                    fator: 1,
                    marca: prod.querySelector('xProd')?.textContent.split(' ')[0], // Chute da marca
                    peso: det.querySelector('pesoL')?.textContent || ""
                });
            });

            this.render();
            document.getElementById('btnExport').disabled = false;
            document.getElementById('f-supplier').textContent = `Fornecedor: ${this.meta.fornecedor}`;
            document.getElementById('f-nfe').textContent = `NFe: ${this.meta.nfe}`;
            document.getElementById('f-count').textContent = `${this.data.length} itens`;
        };
        reader.readAsText(file);
    },

    render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        this.data.forEach(item => {
            const finalQty = item.qCom * item.fator;
            const finalCost = item.custoTotal / finalQty;

            const div = document.createElement('div');
            div.className = 'row-card';
            div.innerHTML = `
                <div class="row-main">
                    <div style="color:#94a3b8">${item._id + 1}</div>
                    <div><input value="${item.codigo}" onchange="App.update(${item._id}, 'codigo', this.value)"></div>
                    <div><input value="${item.descricao}" onchange="App.update(${item._id}, 'descricao', this.value)"></div>
                    <div style="text-align:center"><span class="tag" style="background:#f1f5f9; color:#64748b">${item.unidadeXML}</span></div>
                    
                    <div><input type="number" class="input-factor" value="${item.fator}" oninput="App.updateFactor(${item._id}, this.value)"></div>
                    
                    <div><input value="${item.unidadeVenda}" style="text-align:center" onchange="App.update(${item._id}, 'unidadeVenda', this.value)"></div>
                    
                    <div><input id="cost-${item._id}" class="input-num" value="${finalCost.toFixed(4)}" readonly></div>
                    <div><input id="qty-${item._id}" class="input-num" value="${finalQty}" readonly style="color:var(--accent)"></div>
                    
                    <button style="border:none; background:none; cursor:pointer; color:#94a3b8" onclick="this.closest('.row-card').querySelector('.row-details').classList.toggle('open')">
                        ‚ñº
                    </button>
                </div>
                <div class="row-details">
                    <div class="field"><label>Marca</label><input value="${item.marca}" onchange="App.update(${item._id}, 'marca', this.value)"></div>
                    <div class="field"><label>NCM</label><input value="${item.ncm}" onchange="App.update(${item._id}, 'ncm', this.value)"></div>
                    <div class="field"><label>CEST</label><input value="${item.cest}" onchange="App.update(${item._id}, 'cest', this.value)"></div>
                    <div class="field"><label>EAN/GTIN</label><input value="${item.ean}" onchange="App.update(${item._id}, 'ean', this.value)"></div>
                    <div class="field"><label>Peso (Kg)</label><input value="${item.peso}" onchange="App.update(${item._id}, 'peso', this.value)"></div>
                </div>
            `;
            grid.appendChild(div);
        });
    },

    update(id, key, val) { this.data[id][key] = val; },

    updateFactor(id, val) {
        const factor = parseFloat(val) || 1;
        this.data[id].fator = factor;
        const item = this.data[id];
        
        // Recalcula DOM
        const finalQty = item.qCom * factor;
        const finalCost = item.custoTotal / finalQty;
        
        const row = document.querySelectorAll('.row-card')[id];
        row.querySelector(`#qty-${id}`).value = finalQty;
        row.querySelector(`#cost-${id}`).value = finalCost.toFixed(4);
    },

    exportExcel() {
        // Mapear dados para o formato de array de arrays (Matriz)
        const rows = this.data.map(item => {
            const finalQty = item.qCom * item.fator;
            const finalCost = item.custoTotal / finalQty;
            
            // Cria um array vazio com o tamanho exato das colunas do Bling
            const row = new Array(this.headers.length).fill("");

            // Preenche os √≠ndices corretos
            row[1] = item.codigo;             // C√≥digo
            row[2] = item.descricao;          // Descri√ß√£o
            row[3] = item.unidadeVenda;       // Unidade
            row[4] = item.ncm;                // NCM
            row[5] = "0";                     // Origem (0 = Nacional)
            row[6] = finalCost * 2;           // Pre√ßo Venda (Sugest√£o Markup)
            row[9] = "Ativo";                 // Situa√ß√£o
            row[10] = finalQty;               // Estoque
            row[11] = finalCost;              // Pre√ßo Custo
            row[13] = this.meta.fornecedor;   // Fornecedor
            row[17] = item.peso;              // Peso Liq
            row[19] = item.ean === "SEM GTIN" ? "" : item.ean; 
            row[27] = item.fator;             // Itens p/ caixa
            row[38] = item.marca;             // Marca
            row[39] = item.cest;              // CEST
            row[53] = finalCost;              // Pre√ßo Compra

            return row;
        });

        // Adiciona cabe√ßalho
        const worksheetData = [this.headers, ...rows];

        // Cria Workbook via SheetJS
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(worksheetData);
        
        XLSX.utils.book_append_sheet(wb, ws, "ImportacaoBling");
        
        // Baixa o arquivo .xlsx
        XLSX.writeFile(wb, `Importacao_Bling_${this.meta.nfe || 'NFe'}.xlsx`);
    }
};

App.init();
</script>

</body>
</html>
