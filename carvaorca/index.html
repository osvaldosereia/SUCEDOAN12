<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotação Carvalima - SFA Otimizado</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        /* CSS Otimizado e Minimalista */
        :root { --spacing: 0.5rem; --font-size: 0.9rem; }
        body { font-size: var(--font-size); }
        
        /* Layout */
        header { padding-bottom: 0; border-bottom: 1px solid #e5e5e5; margin-bottom: 1rem; }
        hgroup h2 { font-weight: 300; color: #666; font-size: 1.1rem; }
        .container { max-width: 1200px; }

        /* Tabela */
        table { width: 100%; border-collapse: collapse; margin-bottom: 0; }
        td, th { padding: 0.4rem; vertical-align: middle; border-bottom: 1px solid #eee; }
        thead th { font-weight: 600; background: #f0f0f0; color: #333; }
        
        /* Inputs Compactos */
        input:not([type="checkbox"]):not([type="radio"]) { 
            margin-bottom: 0; height: 2rem; font-size: 0.9rem; padding: 0 0.5rem; 
            border: 1px solid #ddd; transition: border-color 0.2s;
        }
        input:focus { border-color: var(--primary); box-shadow: none; }
        input[readonly] { background-color: transparent; border: none; font-weight: bold; color: #333; }

        /* Utilitários */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .text-green { color: #2b8a3e; }
        .text-red { color: #c92a2a; }
        .w-qty { width: 70px; }
        .w-brand { width: 120px; }
        .w-money { width: 110px; }
        .w-pct { width: 80px; }
        .hidden { display: none !important; }
        .no-print { }

        /* Rodapé Fixo (Totais) */
        .summary-bar {
            position: sticky; bottom: 0; background: #fff; 
            border-top: 2px solid var(--primary); padding: 1rem;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Impressão */
        @media print {
            .no-print, .summary-bar button { display: none !important; }
            body { background: white; color: black; font-size: 10pt; }
            input { border: none !important; padding: 0 !important; height: auto !important; }
            .summary-bar { position: relative; border: 1px solid #000; box-shadow: none; margin-top: 1rem; }
            table, th, td { border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

    <header class="container">
        <nav>
            <hgroup>
                <h1>Cotação Carvalima</h1>
                <h2>Data Base: <span id="current-date"></span></h2>
            </hgroup>
            <ul>
                <li class="no-print"><button class="outline secondary" id="btn-mode" onclick="App.toggleMode()">Admin</button></li>
                <li class="no-print"><button onclick="window.print()">Imprimir</button></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <!-- Formulário de Adição (Apenas Admin) -->
        <section id="admin-panel" class="hidden no-print" style="background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
            <header style="margin-bottom: 0.5rem; border:none; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; color: #888;">Adicionar Item</header>
            <div class="grid" style="grid-template-columns: 2fr 1fr 0.5fr 0.5fr 0.5fr 0.5fr 0.2fr;">
                <input type="text" id="new-name" placeholder="Produto">
                <input type="text" id="new-brand" placeholder="Marca">
                <input type="number" id="new-qty" placeholder="Qtd" value="1">
                <input type="number" id="new-cost" placeholder="Custo" step="0.01" oninput="App.calcNew('cost')">
                <input type="number" id="new-margin" placeholder="Mg %" step="0.1" oninput="App.calcNew('margin')">
                <input type="number" id="new-price" placeholder="Venda" step="0.01" oninput="App.calcNew('price')">
                <button onclick="App.add()" style="width: auto; padding: 0 0.5rem;">+</button>
            </div>
        </section>

        <!-- Tabela Principal -->
        <figure>
            <table>
                <thead>
                    <tr>
                        <th>Produto</th>
                        <th class="w-brand">Marca</th>
                        <th class="text-center w-qty">Qtd</th>
                        
                        <!-- Colunas Visíveis APENAS no Admin -->
                        <th class="text-right w-money admin-col hidden">Custo Un.</th>
                        <th class="text-right w-pct admin-col hidden">Margem %</th>
                        <th class="text-right w-money admin-col hidden">Venda Un.</th>
                        <th class="text-right w-money admin-col hidden">Total Item</th>
                        
                        <th class="no-print w-qty admin-col hidden">Ação</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </figure>
    </main>

    <footer class="summary-bar container">
        <div class="admin-col hidden">
            <small class="text-green" id="profit-info"></small>
        </div>
        <div>
            <strong style="font-size: 1.2rem;" id="total-display">Total Cotação: R$ 0,00</strong>
        </div>
        <div class="no-print">
            <button class="outline contrast" onclick="App.reset()" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">Resetar Dados</button>
        </div>
    </footer>

    <script>
        /**
         * SFA - Single File Application Logic
         * Padrão Singleton para organização e namespace global limpo.
         */
        const App = {
            KEY: 'carvalima_sfa_db_2026_v3', // Chave atualizada para carregar a nova lista de Alimentos/Limpeza
            PASS: '090479', // Hash simples
            state: {
                data: [],
                isAdmin: false
            },

            // Lista extraída da imagem para "seeding" inicial (Com Marcas Separadas)
            INITIAL_DATA: [
                // ALIMENTOS
                { name: "AÇUCAR CRISTAL 2KG", brand: "BARRACOOL/DOCE DIA", qty: 2 },
                { name: "ARROZ TIPO1 5KG AGUILHINHA", brand: "TIO MIRO/CREMOSO/MASSON", qty: 2 },
                { name: "CAFÉ 500 GR", brand: "CABOCLO/EVOLUTO", qty: 1 },
                { name: "CHARQUE TIPO 1 500GR", brand: "SIER", qty: 1 },
                { name: "FARINHA DE MANDIOCA 1 KG", brand: "SABOROSA", qty: 1 },
                { name: "FARINHA DE TRIGO 1KG", brand: "DALLLAS", qty: 2 },
                { name: "FEIJÃO CARIOCA TP1 1KG", brand: "NOVO CALDO", qty: 4 },
                { name: "MACARRÃO ESPAGUETE 500GR", brand: "DALLLAS GREEN/STA FELICIDADE", qty: 4 },
                { name: "MOLHO DE TOMATE 340GR", brand: "TOMODORO", qty: 1 },
                { name: "ÓLEO DE SOJA 900ML", brand: "LIZA", qty: 4 },
                { name: "SAL REFINADO 1KG", brand: "BOM DE MESA", qty: 1 },
                
                // KIT LIMPEZA
                { name: "CREME DENTAL 90GR", brand: "SORRISO/COLGATE", qty: 2 },
                { name: "ESPONJA DE AÇO 60GR", brand: "Q LUSTROS /ASSOLAN", qty: 2 },
                { name: "PAPEL HIG. PERFUMADO 4X30", brand: "MILLI BIANCO/ PALOMA", qty: 2 },
                { name: "SABÃO BARRA GLICERINADO 5X200", brand: "OESTE/BARRA NOVA", qty: 1 },
                { name: "SABÃO EM PÓ 800GR", brand: "ASSIM/AMACITEL /URCA", qty: 1 },
                { name: "SABONETE 90GR", brand: "KITE/VIDA/GIPSY", qty: 2 }
            ],

            init() {
                // Configurar Data
                const now = new Date();
                document.getElementById('current-date').textContent = now.toLocaleDateString('pt-BR');
                
                // Carregar Dados
                this.load();
            },

            load() {
                const stored = localStorage.getItem(this.KEY);
                if (stored) {
                    try {
                        this.state.data = JSON.parse(stored);
                    } catch(e) { console.error("Erro ao ler DB", e); this.seed(); }
                } else {
                    this.seed();
                }
                this.render();
            },

            seed() {
                // Popula com dados da imagem, custos zerados
                this.state.data = this.INITIAL_DATA.map(item => ({
                    id: Date.now() + Math.random(),
                    name: item.name,
                    brand: item.brand,
                    qty: item.qty,
                    cost: 0,
                    margin: 0,
                    price: 0
                }));
                this.save();
            },

            save() {
                localStorage.setItem(this.KEY, JSON.stringify(this.state.data));
                this.render();
            },

            // --- Lógica de Negócio (CRUD + Cálculos) ---

            add() {
                const name = document.getElementById('new-name').value;
                if (!name) return alert("Nome é obrigatório");

                const brand = document.getElementById('new-brand').value || "";
                const qty = parseFloat(document.getElementById('new-qty').value) || 1;
                const cost = parseFloat(document.getElementById('new-cost').value) || 0;
                const margin = parseFloat(document.getElementById('new-margin').value) || 0;
                const price = parseFloat(document.getElementById('new-price').value) || 0;

                this.state.data.push({ id: Date.now(), name, brand, qty, cost, margin, price });
                
                // Limpar campos
                document.getElementById('new-name').value = '';
                document.getElementById('new-brand').value = '';
                document.getElementById('new-cost').value = '';
                document.getElementById('new-margin').value = '';
                document.getElementById('new-price').value = '';
                document.getElementById('new-name').focus();
                
                this.save();
            },

            update(id, field, value) {
                const item = this.state.data.find(i => i.id === id);
                if (!item) return;

                if (field === 'name') item.name = value;
                else if (field === 'brand') item.brand = value;
                else {
                    let val = parseFloat(value);
                    if (isNaN(val)) val = 0;

                    if (field === 'qty') item.qty = val;
                    else if (field === 'cost') {
                        item.cost = val;
                        // Custo mudou: Recalcula Preço mantendo Margem
                        item.price = item.cost * (1 + (item.margin / 100));
                    }
                    else if (field === 'margin') {
                        item.margin = val;
                        // Margem mudou: Recalcula Preço mantendo Custo
                        item.price = item.cost * (1 + (item.margin / 100));
                    }
                    else if (field === 'price') {
                        item.price = val;
                        // Preço mudou: Recalcula Margem (Engenharia Reversa)
                        if (item.cost > 0) item.margin = ((item.price - item.cost) / item.cost) * 100;
                    }
                    
                    // Arredondamento seguro (2 casas)
                    if(field !== 'qty') {
                        item.price = Math.round(item.price * 100) / 100;
                        item.margin = Math.round(item.margin * 10) / 10;
                    }
                }
                this.save();
            },

            delete(id) {
                if (confirm('Deletar item?')) {
                    this.state.data = this.state.data.filter(i => i.id !== id);
                    this.save();
                }
            },

            reset() {
                if (confirm('ATENÇÃO: Isso apagará todas as edições e restaurará a lista original. Continuar?')) {
                    localStorage.removeItem(this.KEY);
                    this.seed();
                    this.render();
                }
            },

            // --- Lógica Auxiliar de UI ---

            calcNew(source) {
                // Cálculo em tempo real para o formulário de adição
                const els = {
                    c: document.getElementById('new-cost'),
                    m: document.getElementById('new-margin'),
                    p: document.getElementById('new-price')
                };
                const val = {
                    c: parseFloat(els.c.value) || 0,
                    m: parseFloat(els.m.value) || 0,
                    p: parseFloat(els.p.value) || 0
                };

                if (source === 'cost' || source === 'margin') {
                    els.p.value = (val.c * (1 + (val.m / 100))).toFixed(2);
                } else if (source === 'price') {
                    if (val.c > 0) els.m.value = (((val.p - val.c) / val.c) * 100).toFixed(1);
                }
            },

            toggleMode() {
                if (this.state.isAdmin) {
                    this.state.isAdmin = false;
                } else {
                    const pwd = prompt("Senha Admin:");
                    if (pwd === this.PASS) this.state.isAdmin = true;
                    else if (pwd !== null) alert("Senha inválida");
                }
                this.render();
            },

            formatMoney(val) {
                return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            },

            // --- Renderização (Core) ---

            render() {
                const tbody = document.getElementById('table-body');
                const adminCols = document.querySelectorAll('.admin-col');
                const adminPanel = document.getElementById('admin-panel');
                const btnMode = document.getElementById('btn-mode');
                
                // Controle de Visibilidade Admin/Cliente
                btnMode.textContent = this.state.isAdmin ? "Sair Admin" : "Acessar Admin";
                btnMode.className = this.state.isAdmin ? "outline contrast" : "outline secondary";
                
                adminPanel.classList.toggle('hidden', !this.state.isAdmin);
                adminCols.forEach(el => el.classList.toggle('hidden', !this.state.isAdmin));

                // Construção da Tabela
                tbody.innerHTML = '';
                let grandTotal = 0;
                let totalCost = 0;

                this.state.data.forEach(item => {
                    const totalLine = item.qty * item.price;
                    grandTotal += totalLine;
                    totalCost += (item.qty * item.cost);

                    const tr = document.createElement('tr');
                    
                    // Helpers de exibição: Se for 0, mostra string vazia
                    const showCost = item.cost === 0 ? '' : item.cost;
                    const showMargin = item.margin === 0 ? '' : item.margin;
                    const showPrice = item.price === 0 ? '' : item.price;

                    if (this.state.isAdmin) {
                        tr.innerHTML = `
                            <td><input type="text" value="${item.name}" onchange="App.update(${item.id}, 'name', this.value)"></td>
                            <td><input type="text" value="${item.brand}" onchange="App.update(${item.id}, 'brand', this.value)"></td>
                            <td><input type="number" value="${item.qty}" class="text-center" onchange="App.update(${item.id}, 'qty', this.value)"></td>
                            
                            <td class="admin-col"><input type="number" placeholder="0,00" value="${showCost}" step="0.01" class="text-right" onchange="App.update(${item.id}, 'cost', this.value)"></td>
                            <td class="admin-col"><input type="number" placeholder="0" value="${showMargin}" step="0.1" class="text-right" onchange="App.update(${item.id}, 'margin', this.value)"></td>
                            <td class="admin-col"><input type="number" placeholder="0,00" value="${showPrice}" step="0.01" class="text-right" onchange="App.update(${item.id}, 'price', this.value)"></td>
                            <td class="text-right font-bold admin-col">${this.formatMoney(totalLine)}</td>
                            
                            <td class="no-print admin-col text-center"><button class="outline secondary" onclick="App.delete(${item.id})" style="border:none; color: #c92a2a;">&times;</button></td>
                        `;
                    } else {
                        // Modo Cliente (Leitura) - SEM PREÇOS INDIVIDUAIS
                        tr.innerHTML = `
                            <td>${item.name}</td>
                            <td>${item.brand}</td>
                            <td class="text-center">${item.qty}</td>
                        `;
                    }
                    tbody.appendChild(tr);
                });

                // Totais
                document.getElementById('total-display').textContent = `Total Cotação: ${this.formatMoney(grandTotal)}`;
                
                if (this.state.isAdmin) {
                    const profit = grandTotal - totalCost;
                    const mgTotal = grandTotal > 0 ? (profit/grandTotal*100).toFixed(1) : 0;
                    document.getElementById('profit-info').innerHTML = 
                        `Custo: ${this.formatMoney(totalCost)} | Lucro: <b>${this.formatMoney(profit)}</b> (${mgTotal}%)`;
                }
            }
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
