<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Dona Ant√¥nia | Cestas</title>
    <style>
        /* --- RESET & VARS --- */
        :root {
            --primary: #d31a28;
            --text: #1a1a1a;
            --gray-light: #f5f5f5;
            --gray-med: #e0e0e0;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; font-family: var(--font-main); color: var(--text); background: #fff; }
        img { max-width: 100%; display: block; }
        button { border: none; background: none; font-family: inherit; cursor: pointer; }

        /* --- UI COMPONENTS --- */
        .container { max-width: 600px; margin: 0 auto; padding: 0 16px; position: relative; }
        .hidden { display: none !important; }
        
        /* Cabe√ßalho Minimalista */
        header { 
            position: sticky; top: 0; z-index: 100; background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px); border-bottom: 1px solid var(--gray-light); height: 60px;
            display: flex; align-items: center; justify-content: center;
        }
        .logo { font-weight: 800; font-size: 1.2rem; color: var(--text); letter-spacing: -0.5px; }
        
        /* Bot√£o Flutuante de Cesta (Chat) */
        .cart-float {
            position: absolute; right: 16px; top: 12px; background: var(--gray-light);
            padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 700;
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .cart-float.active { background: var(--primary); color: white; }

        /* --- HOME --- */
        #view-home { padding: 30px 0 60px; }
        .hero-txt { text-align: center; margin-bottom: 30px; }
        .hero-txt h1 { font-size: 1.5rem; margin-bottom: 8px; letter-spacing: -0.5px; }
        .hero-txt p { color: #666; font-size: 0.95rem; }

        .basket-grid { display: grid; gap: 24px; }
        .basket-item { 
            border-radius: 16px; overflow: hidden; background: #fff; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); transition: transform 0.2s;
        }
        .basket-item:active { transform: scale(0.98); }
        .bi-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: var(--gray-light); }
        .bi-info { padding: 20px; }
        .bi-title { font-size: 1.2rem; font-weight: 800; margin-bottom: 4px; }
        .bi-price { font-size: 1.3rem; color: var(--primary); font-weight: 700; margin-bottom: 15px; }
        
        .bi-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { padding: 14px; border-radius: 12px; font-weight: 700; font-size: 0.95rem; text-align: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { border: 2px solid var(--gray-med); color: var(--text); }

        /* --- CHAT FLOW --- */
        #view-chat { 
            position: fixed; inset: 0; background: #fff; z-index: 200; 
            display: flex; flex-direction: column; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #view-chat.open { transform: translateX(0); }
        
        .chat-scroll { flex: 1; overflow-y: auto; padding: 20px 0 80px; scroll-behavior: smooth; }
        
        /* Mensagens do Rob√¥ */
        .msg-bot { 
            margin: 15px 16px; font-size: 1.05rem; line-height: 1.5; color: #333; 
            animation: slideIn 0.3s ease;
        }
        .msg-bot strong { color: var(--primary); }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* Bot√µes de Resposta (Inline) */
        .options-group { 
            display: flex; flex-wrap: wrap; gap: 10px; padding: 0 16px; margin-bottom: 30px; 
            animation: fadeIn 0.5s ease;
        }
        .btn-opt {
            flex: 1 1 45%; padding: 16px; background: #fff; border: 1px solid var(--gray-med);
            border-radius: 12px; font-weight: 600; color: #444; text-align: left;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: all 0.2s;
        }
        .btn-opt.highlight { background: var(--text); color: white; border-color: var(--text); }
        .btn-opt:active { transform: scale(0.97); }

        /* GRID PRODUTOS (Minimalista) */
        .chat-products {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; 
            padding: 10px 16px 20px; animation: slideIn 0.4s ease;
        }
        .prod-card { position: relative; }
        .pc-img-box { 
            background: var(--gray-light); border-radius: 12px; aspect-ratio: 1; 
            margin-bottom: 8px; position: relative; overflow: hidden;
        }
        .pc-img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
        
        /* Controles de Qtd */
        .pc-ctrl {
            position: absolute; bottom: 8px; right: 8px; background: white;
            border-radius: 20px; display: flex; align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden;
        }
        .pc-btn { width: 32px; height: 32px; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; color: var(--primary); }
        .pc-val { font-weight: 700; font-size: 0.9rem; min-width: 20px; text-align: center; }
        
        /* Quando qty = 0, mostra s√≥ bot√£o + */
        .pc-add-btn {
            position: absolute; bottom: 8px; right: 8px; width: 36px; height: 36px;
            background: white; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem;
        }

        .pc-name { font-size: 0.85rem; line-height: 1.2; color: #444; margin-bottom: 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .pc-price { font-weight: 700; font-size: 0.95rem; color: var(--text); }
        .pc-price small { color: #999; text-decoration: line-through; font-weight: 400; font-size: 0.8rem; margin-right: 4px; }

        /* --- MODAL CARRINHO --- */
        dialog {
            width: 100%; max-width: 500px; border: none; border-radius: 20px 20px 0 0;
            padding: 0; position: fixed; bottom: 0; margin: 0 auto;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s;
        }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        
        .modal-head { padding: 20px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--gray-light); font-weight: 700; font-size: 1.1rem; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-foot { padding: 20px; border-top: 1px solid var(--gray-light); background: #f9f9f9; }
        
        .cart-line { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem; }
        .total-row { display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: 800; margin-bottom: 10px; }
        
        select { width: 100%; padding: 12px; border: 1px solid var(--gray-med); border-radius: 8px; margin-top: 5px; font-size: 1rem; background: white; }
    </style>
</head>
<body>

<div class="container" id="view-home">
    <header style="margin-bottom:20px; border:none; background:transparent;">
        <div class="logo">Dona Ant√¥nia</div>
    </header>
    
    <div class="hero-txt">
        <h1>Cestas B√°sicas & Mercado</h1>
        <p>Praticidade para sua casa. Pague s√≥ na entrega.</p>
    </div>

    <div class="basket-grid" id="home-list">
        </div>
</div>

<div id="view-chat">
    <header>
        <button onclick="Chat.close()" style="position:absolute; left:16px; font-size:1.5rem;">‚úï</button>
        <div class="logo">Personalizar</div>
        <button class="cart-float" onclick="App.openCart()">
            üõí <span id="cart-total">R$ 0,00</span>
        </button>
    </header>

    <div class="chat-scroll" id="chat-feed">
        </div>
</div>

<dialog id="modal-cart">
    <div class="modal-head">
        Sua Lista <button onclick="document.getElementById('modal-cart').close()">‚úï</button>
    </div>
    <div class="modal-body" id="cart-list"></div>
    <div class="modal-foot">
        <div class="total-row">
            <span>Total</span> <span id="modal-total" style="color:var(--primary)">R$ 0,00</span>
        </div>
        <div style="margin-bottom:15px">
            <label style="font-size:0.85rem; font-weight:600;">Forma de Pagamento:</label>
            <select id="pay-method">
                <option>Pix na Entrega</option>
                <option>Dinheiro</option>
                <option>Cart√£o Cr√©dito/D√©bito</option>
                <option>Vale Alimenta√ß√£o</option>
            </select>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="App.sendZap()">Confirmar Pedido</button>
    </div>
</dialog>

<script>
// DADOS DE CATEGORIAS (Ordem de Condu√ß√£o)
const CATEGORY_FLOW = [
    { key: 'MERCEARIA E ALIMENTOS', label: 'Mercearia e Alimentos' },
    { key: 'CAF√â DA MANH√É E LANCHES', label: 'Caf√© da Manh√£' },
    { key: 'LIMPEZA E LAVANDERIA', label: 'Limpeza' },
    { key: 'CUIDADOS PESSOAIS', label: 'Higiene e Pessoal' },
    { key: 'BAZAR E UTILIDADES', label: 'Utilidades' }
];

const App = {
    data: [],
    cart: {},
    currentBasket: null,

    async init() {
        try {
            const req = await fetch('produtos/produtos.json?v=' + Date.now());
            const json = await req.json();
            const raw = json.produtos || json;
            
            // Tratamento e Mapeamento
            this.data = raw.map(p => ({
                ...p,
                id: String(p.id),
                valor: parseFloat(p.valor || 0),
                offerPrice: parseFloat(p.Valor_Oferta || 0),
                isOffer: p.Oferta === 'Sim',
                catMain: this.getCategoryRoot(p.categoria || ""),
                imagem: p.imagem ? `img/produtos/${p.imagem.split('/').pop()}` : 'img/placeholder.jpg'
            }));

            this.renderHome();
        } catch(e) { alert("Erro ao carregar produtos."); console.error(e); }
    },

    getCategoryRoot(catStr) {
        const c = catStr.toUpperCase();
        // Mapeamento baseado na sua lista
        if (c.includes('MERCEARIA') || c.includes('ALIMENTOS')) return 'MERCEARIA E ALIMENTOS';
        if (c.includes('CAF√â') || c.includes('LANCHES')) return 'CAF√â DA MANH√É E LANCHES';
        if (c.includes('LIMPEZA') || c.includes('LAVANDERIA')) return 'LIMPEZA E LAVANDERIA';
        if (c.includes('CUIDADOS') || c.includes('PESSOAIS')) return 'CUIDADOS PESSOAIS';
        if (c.includes('BAZAR') || c.includes('UTILIDADES')) return 'BAZAR E UTILIDADES';
        return 'OUTROS';
    },

    renderHome() {
        const grid = document.getElementById('home-list');
        const baskets = this.data.filter(p => p.categoria && p.categoria.includes('CESTA'));
        
        grid.innerHTML = baskets.map(b => `
            <div class="basket-item">
                <img src="${b.imagem}" class="bi-img" loading="lazy">
                <div class="bi-info">
                    <div class="bi-title">${b.nome}</div>
                    <div class="bi-price">R$ ${b.valor.toFixed(2).replace('.',',')}</div>
                    <div class="bi-actions">
                        <button class="btn btn-outline" onclick="App.directOrder('${b.id}')">Pedir Direto</button>
                        <button class="btn btn-primary" onclick="Chat.start('${b.id}')">Personalizar</button>
                    </div>
                </div>
            </div>
        `).join('');
    },

    modQty(id, delta) {
        if(!this.cart[id]) this.cart[id] = 0;
        this.cart[id] += delta;
        if(this.cart[id] <= 0) delete this.cart[id];
        
        this.updateTotals();
        Chat.refreshGrids(id); // Atualiza grids vis√≠veis no chat
    },

    updateTotals() {
        let total = 0, count = 0;
        for(let id in this.cart) {
            const p = this.data.find(x => x.id === id);
            if(p) {
                total += (p.isOffer ? p.offerPrice : p.valor) * this.cart[id];
                count += this.cart[id];
            }
        }
        
        // Atualiza UI
        const txt = "R$ " + total.toFixed(2).replace('.',',');
        document.getElementById('cart-total').innerText = txt;
        document.getElementById('modal-total').innerText = txt;
        
        const btn = document.querySelector('.cart-float');
        if(count > 0) btn.classList.add('active'); else btn.classList.remove('active');
        
        return total;
    },

    openCart() {
        const list = document.getElementById('cart-list');
        list.innerHTML = Object.keys(this.cart).length === 0 
            ? '<p style="text-align:center; color:#999">Cesta vazia.</p>'
            : Object.keys(this.cart).map(id => {
                const p = this.data.find(x => x.id === id);
                const price = p.isOffer ? p.offerPrice : p.valor;
                return `
                <div class="cart-line">
                    <span style="flex:1">${this.cart[id]}x ${p.nome}</span>
                    <span style="font-weight:700">R$ ${(price * this.cart[id]).toFixed(2).replace('.',',')}</span>
                </div>`;
            }).join('');
        document.getElementById('modal-cart').showModal();
    },

    directOrder(bid) {
        const b = this.data.find(x => x.id === bid);
        if(confirm(`Pedir ${b.nome} direto no WhatsApp?`)) {
            const msg = `Ol√°! Quero pedir a *${b.nome}* (Padr√£o) de R$ ${b.valor.toFixed(2).replace('.',',')}`;
            window.open(`https://api.whatsapp.com/send?phone=5565996813588&text=${encodeURIComponent(msg)}`, '_blank');
        }
    },

    sendZap() {
        let msg = `*PEDIDO DONA ANT√îNIA*\n`;
        if(this.currentBasket) msg += `Base: ${this.currentBasket.nome}\n`;
        msg += `\n*ITENS:*\n`;
        for(let id in this.cart) {
            const p = this.data.find(x => x.id === id);
            msg += `${this.cart[id]}x ${p.nome}\n`;
        }
        msg += `\n*TOTAL: ${document.getElementById('modal-total').innerText}*\n`;
        msg += `Pagamento: ${document.getElementById('pay-method').value}`;
        window.open(`https://api.whatsapp.com/send?phone=5565996813588&text=${encodeURIComponent(msg)}`, '_blank');
    }
};

const Chat = {
    feed: document.getElementById('chat-feed'),
    flowIndex: 0,

    start(basketId) {
        App.currentBasket = App.data.find(x => x.id === basketId);
        App.cart = {};
        
        // Popula itens iniciais
        if(App.currentBasket.items) {
            App.currentBasket.items.forEach(i => {
                const pid = String(i.id);
                if(App.data.find(x => x.id === pid)) App.cart[pid] = (App.cart[pid]||0) + parseInt(i.qty||1);
            });
        }
        App.updateTotals();

        // UI Open
        document.getElementById('view-chat').classList.add('open');
        this.feed.innerHTML = '';
        this.flowIndex = 0;

        // In√≠cio
        this.botSay(`Voc√™ escolheu a <strong>${App.currentBasket.nome}</strong>.`);
        this.botSay("Aqui est√° o que vem nela. Pode retirar o que n√£o quiser:");
        
        const initialItems = Object.keys(App.cart).map(id => App.data.find(x => x.id === id));
        this.showProductGrid(initialItems);

        this.askOptions("Tudo certo com esses itens?", [
            { text: "üëç Tudo certo, vamos seguir", next: () => this.nextCategory() }
        ]);
    },

    nextCategory() {
        if (this.flowIndex >= CATEGORY_FLOW.length) {
            this.finish();
            return;
        }

        const cat = CATEGORY_FLOW[this.flowIndex];
        const items = App.data.filter(p => p.catMain === cat.key).slice(0, 16); // Top 16 para n√£o travar
        
        this.flowIndex++;

        if (items.length === 0) {
            this.nextCategory(); // Pula se vazia
            return;
        }

        this.botSay(`Vamos ver <strong>${cat.label}</strong>?`);
        this.showProductGrid(items);
        this.askOptions("Deseja algo mais daqui?", [
            { text: "Pr√≥xima categoria ‚û°", next: () => this.nextCategory(), highlight: true }
        ]);
    },

    finish() {
        this.botSay("Finalizamos! Confira seu pedido no carrinho l√° em cima üõí ou clique abaixo.");
        this.askOptions("Concluir Pedido", [
            { text: "‚úÖ Ver Resumo e Pedir", next: () => App.openCart(), highlight: true },
            { text: "Ver Ofertas Extras", next: () => { /* Logica extra se quiser */ App.openCart() } }
        ]);
    },

    // UI Builders
    botSay(html) {
        const el = document.createElement('div');
        el.className = 'msg-bot';
        el.innerHTML = html;
        this.feed.appendChild(el);
        this.scrollToBottom();
    },

    showProductGrid(list) {
        const el = document.createElement('div');
        el.className = 'chat-products';
        el.innerHTML = list.map(p => this.cardHTML(p)).join('');
        this.feed.appendChild(el);
    },

    cardHTML(p) {
        const qty = App.cart[p.id] || 0;
        const price = p.isOffer ? p.offerPrice : p.valor;
        
        // Layout Minimalista: Imagem grande, titulo pequeno
        return `
        <div class="prod-card" data-pid="${p.id}">
            <div class="pc-img-box"><img src="${p.imagem}" class="pc-img" loading="lazy"></div>
            <div class="pc-name">${p.nome}</div>
            <div class="pc-price">${p.isOffer ? `<small>R$${p.valor}</small>` : ''}R$ ${price.toFixed(2).replace('.',',')}</div>
            
            ${qty === 0 
                ? `<div class="pc-add-btn" onclick="App.modQty('${p.id}', 1)">+</div>`
                : `<div class="pc-ctrl">
                    <div class="pc-btn" onclick="App.modQty('${p.id}', -1)">-</div>
                    <div class="pc-val">${qty}</div>
                    <div class="pc-btn" onclick="App.modQty('${p.id}', 1)">+</div>
                   </div>`
            }
        </div>`;
    },

    refreshGrids(id) {
        // Atualiza apenas os cards desse produto vis√≠veis na tela (sem recriar tudo)
        const p = App.data.find(x => x.id === id);
        if(!p) return;
        const cards = document.querySelectorAll(`.prod-card[data-pid="${id}"]`);
        cards.forEach(card => {
            card.outerHTML = this.cardHTML(p);
        });
    },

    askOptions(title, options) {
        const group = document.createElement('div');
        group.className = 'options-group';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = `btn-opt ${opt.highlight ? 'highlight' : ''}`;
            btn.innerText = opt.text;
            btn.onclick = () => {
                group.remove(); // Remove bot√µes ap√≥s clique
                opt.next();
            };
            group.appendChild(btn);
        });
        this.feed.appendChild(group);
        this.scrollToBottom();
    },

    scrollToBottom() {
        setTimeout(() => this.feed.scrollTop = this.feed.scrollHeight, 100);
    },

    close() {
        if(confirm("Sair e perder as altera√ß√µes?")) {
            document.getElementById('view-chat').classList.remove('open');
        }
    }
};

window.onload = () => App.init();
</script>
</body>
</html>
