<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="Super Cestas B√°sicas Dona Ant√¥nia - Qualidade e pre√ßo justo.">
<meta name="theme-color" content="#ffffff">
<title>Super Cestas B√°sicas Dona Ant√¥nia</title>
<style>
:root {
    /* PALETA PROFISSIONAL */
    --c-p: #0f172a;      /* Texto Principal */
    --c-s: #1e293b;      /* Texto Secund√°rio */
    --c-t: #64748b;      /* Texto Terci√°rio */
    --c-a: #ea580c;      /* A√ß√£o Principal (Laranja) */
    --c-ok: #15803d;     /* Sucesso */
    --c-err: #b91c1c;    /* Erro */
    --c-bg: #e2e8f0;     /* Fundo Geral */
    --c-surf: #ffffff;   /* Superf√≠cie Cards */
    --c-bd: #cbd5e1;     /* Bordas */
    --font: 'Inter', system-ui, sans-serif;
    
    --sh-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
    --sh-float: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
body{font-family:var(--font);background:var(--c-bg);color:var(--c-p);margin:0;padding:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased}
img{user-select:none;} 
button{cursor:pointer;border:none;background:0 0;font-family:inherit;font-weight:600}

/* LAYOUT DESKTOP LIMITER */
.layout-limit { width: 100%; max-width: 1200px; margin: 0 auto; position: relative; }

/* HEADER */
.app-header{flex:0 0 auto;width:100%;background:#fff;border-bottom:1px solid var(--c-bd);z-index:20;display:flex;flex-direction:column;align-items:center}
/* Ajuste de respiro: Menos espa√ßo embaixo (4px) */
.header-inner{display:flex;align-items:center;padding:12px 20px 4px 20px;width:100%;gap:15px;}
.header-brand{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.logo{width:65px;height:65px;border-radius:50%;object-fit:cover;border:1px solid var(--c-bd)}

/* SEARCH BAR */
.search-bar-area{flex:1;position:relative}
.search-inp{width:100%;background:#f8fafc;border:1px solid var(--c-bd);padding:12px 15px 12px 40px;border-radius:12px;font-weight:600;color:var(--c-p);transition:box-shadow .2s;font-size:0.95rem;}
.search-inp:focus{box-shadow:0 0 0 2px rgba(15, 23, 42, 0.1); border-color:var(--c-p)}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--c-t);pointer-events:none}
.clear-search{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#cbd5e1;color:#fff;border-radius:50%;width:24px;height:24px;font-size:12px;display:none;align-items:center;justify-content:center;cursor:pointer}

/* CHIPS BAR (Categorias R√°pidas) */
/* Ajuste de respiro: Menos espa√ßo em cima (4px) */
.chips-bar {
    display: none; width: 100%; max-width: 1200px; padding: 4px 20px 12px 20px; gap: 8px;
    overflow-x: auto; scroll-behavior: smooth; align-items: center;
}
.chips-bar::-webkit-scrollbar { display: none; }
.chip {
    padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
    background: #f1f5f9; color: var(--c-s); white-space: nowrap; border: 1px solid var(--c-bd);
    cursor: pointer; transition: 0.2s;
}
.chip.active { background: var(--c-p); color: #fff; border-color: var(--c-p); }

/* PALCO CENTRAL (GRADE VERTICAL) */
.main-stage{flex:1;position:relative;display:block;overflow-y:auto;overflow-x:hidden;background:var(--c-bg);padding-bottom:140px; scroll-behavior:smooth;}

/* BANNERS */
.banner-wrapper {
    width: 100%; max-width: 1200px; margin: 0 auto;
    padding: 15px 20px 5px; display: none; gap: 12px;
    overflow-x: auto; scroll-snap-type: x mandatory;
    scrollbar-width: none;
}
.banner-wrapper::-webkit-scrollbar { display: none; }
.banner-card {
    flex: 0 0 85%; scroll-snap-align: start;
    border-radius: 16px; padding: 18px 20px;
    display: flex; flex-direction: column; justify-content: center;
    cursor: pointer; transition: transform 0.2s;
    min-height: 90px; box-shadow: var(--sh-card);
}
.banner-card:active { transform: scale(0.98); }
.banner-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 4px; line-height: 1.1; letter-spacing: -0.5px;}
.banner-sub { font-size: 0.8rem; font-weight: 500; opacity: 0.9; line-height: 1.2; }

@media(min-width: 800px) {
    .banner-wrapper { overflow-x: visible; }
    .banner-card { flex: 1; }
}

/* FILTRO DISCRETO ACIMA DA GRADE */
.filter-row {
    width: 100%; max-width: 1200px; margin: 0 auto; padding: 10px 20px 0;
    display: flex; justify-content: flex-end; align-items: center;
}
.filter-sel-inline {
    background: transparent; border: none; font-weight: 700; color: var(--c-s);
    font-size: 0.8rem; text-align: right; cursor: pointer; appearance: none; -webkit-appearance: none;
    padding-right: 15px; position: relative;
}
.filter-wrapper { position: relative; display: inline-block; }
.filter-wrapper::after { content: '‚ñº'; font-size: 0.6rem; position: absolute; right: 0; top: 50%; transform: translateY(-50%); color: var(--c-s); pointer-events: none;}

.grid-wrapper{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px; padding: 15px 20px 20px;
    width: 100%; max-width: 1200px; margin: 0 auto;
    align-content: start;
}

@media(max-width:600px){
    .grid-wrapper{ grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px 15px 15px; }
    .filter-row { padding: 5px 15px 0; }
}

/* CARDS */
.u-card{
    background:var(--c-surf);
    border-radius:20px;
    border:1px solid #fff;
    box-shadow:var(--sh-card);
    display:flex;flex-direction:column;
    position:relative; height: 100%;
    transition:transform .2s, box-shadow .2s;
}
.u-card:hover{box-shadow:var(--sh-float);transform:translateY(-4px);z-index:10}

.u-img-area{width:100%;aspect-ratio:1;background:#fff;position:relative;overflow:hidden;border-bottom:1px solid #f1f5f9;cursor:zoom-in; border-radius: 20px 20px 0 0;}
.u-img{width:100%;height:100%;object-fit:contain;mix-blend-mode:multiply;padding:5px;transition:transform .3s} 
.u-img-area:hover .u-img{transform:scale(1.05)}
.u-img-cesta{object-fit:cover;padding:0;mix-blend-mode:normal}

.offer-tag{position:absolute;bottom:0;left:0;background:#dc2626;color:#fff;font-size:0.7rem;padding:4px 10px;border-top-right-radius:12px;font-weight:800;z-index:5;box-shadow:2px -2px 5px rgba(0,0,0,0.1)}

.combo-strike { text-decoration: line-through; color: var(--c-t); font-size: 0.85rem; font-weight: 600; }
.combo-save { color: var(--c-ok); font-size: 0.75rem; font-weight: 800; background: #dcfce7; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px;}

.u-info{padding:10px;display:flex;flex-direction:column;gap:4px;flex:1; border-radius: 0 0 20px 20px; background: var(--c-surf);}
.u-name{
    font-size:0.8rem; font-weight:600;
    color:var(--c-p); line-height:1.3;
    display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;
    min-height:3.9em; flex-grow: 1; 
}

.meta-row { margin-bottom: 4px; }
.meta-text { font-size: 0.65rem; font-weight: 700; color: var(--c-t); display: block; }

/* √ÅREA DE PRE√áO E DESCONTO */
.price-area { margin-top: auto; display: flex; flex-direction: column; gap: 0px; }
.old-price-row { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
.strike-price { font-size: 0.75rem; color: var(--c-t); text-decoration: line-through; font-weight: 600; }
.discount-badge { background: #fee2e2; color: var(--c-err); font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 4px; line-height: 1; }
.u-price{font-size:1.15rem;font-weight:800;color:var(--c-a);letter-spacing:-0.5px;}

@media(max-width:600px){
    .u-name{font-size: 0.75rem; font-weight: 500; -webkit-line-clamp: 3; min-height: 3.9em;}
    .u-price{font-size: 1rem; font-weight: 700;}
}

/* BOT√ïES E INPUTS */
.u-action-row{padding-top:8px; padding-bottom: 4px; position: relative;}
.btn-big-action{
    width:100%; background:var(--c-p); color:#fff;
    padding:10px 8px; border-radius:10px;
    font-weight:700; font-size:0.75rem;
    display:flex; align-items:center; justify-content:center; gap:4px;
    transition:background .2s, transform .1s;
}
@media(max-width:600px){
    .btn-big-action{padding: 12px 8px; font-size: 0.8rem;}
}

.btn-big-action:active:not(:disabled){transform:scale(0.95)}
.btn-big-action.success-flash{animation:flashGreen 0.5s ease-out}

/* CSS para Bot√£o Esgotado */
.btn-big-action:disabled {
    background: #cbd5e1 !important;
    color: var(--c-t) !important;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
}

@keyframes flashGreen {
    0% { background: var(--c-p); }
    50% { background: var(--c-ok); transform: scale(1.05); }
    100% { background: var(--c-p); }
}

.qty-row{display:flex;align-items:center;justify-content:space-between;background:#f1f5f9;border-radius:12px;padding:3px;border:1px solid var(--c-bd)}
.btn-qty{width:32px;height:32px;border-radius:6px;background:#fff;font-size:1rem;font-weight:800;box-shadow:var(--sh-sm);color:var(--c-p)}
.qty-inp{
    width:30px; text-align:center; font-size:0.95rem; font-weight:800;
    border:none; background:transparent; color:var(--c-p);
    -moz-appearance:textfield;
}
.qty-inp::-webkit-outer-spin-button,.qty-inp::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

/* LINK DE CATEGORIA (OFERTAS) */
.offer-cat-link {
    font-size: 0.65rem; font-weight: 800; color: var(--c-a); text-align: center;
    margin-top: 8px; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
}
.offer-cat-link:active { opacity: 0.7; }

/* FLOATING BOTTOM AREA (Discreto e na mesma linha) */
.floating-bottom {
    position: fixed; bottom: calc(60px + env(safe-area-inset-bottom));
    left: 0; width: 100%; z-index: 90; display: none; /* S√≥ aparece no carrinho */
    justify-content: center; pointer-events: none; 
}

.floating-checkout-wrap {
    width: 100%; max-width: 600px; padding: 10px 15px;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
    border-top: 1px solid var(--c-bd); pointer-events: auto;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
}

.checkout-inline-row {
    display: flex; gap: 15px; align-items: center; justify-content: space-between; width: 100%;
}

.progress-mini { flex: 1; display: flex; flex-direction: column; gap: 4px; }
#prog-txt-mini { font-size: 0.65rem; font-weight: 800; color: var(--c-s); text-transform: uppercase;}
.prog-track-mini { width: 100%; height: 6px; background: #cbd5e1; border-radius: 3px; overflow: hidden; }
.prog-fill-mini { height: 100%; background: var(--c-ok); width: 0%; transition: width 0.3s ease-out; }

.btn-floating-checkout{
    flex: 1; background:#16a34a; color:#fff;
    padding:12px 10px; border-radius:12px; font-weight:900; font-size:0.9rem;
    display:flex; align-items:center; justify-content:center;
    box-shadow:0 4px 12px rgba(22,163,74,0.3); border:none; cursor:pointer;
    transition:transform .1s; text-align: center; white-space: nowrap;
}
.btn-floating-checkout:active{transform:scale(0.98)}

/* APP TAB BAR (Bottom Navigation) - Agora com 4 abas */
.bottom-nav-bar {
    position: fixed; bottom: 0; left: 0; width: 100%;
    background: #fff; display: flex; justify-content: space-around; align-items: center;
    height: 60px; border-top: 1px solid var(--c-bd); z-index: 100;
    padding-bottom: env(safe-area-inset-bottom);
}
.tab-item {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    flex: 1; height: 100%; color: var(--c-t); cursor: pointer; gap: 4px; transition: color 0.2s; position: relative;
}
.tab-item.active { color: var(--c-p); }
.tab-icon { font-size: 1.3rem; line-height: 1; }
.tab-label { font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
.cart-badge {
    position: absolute; top: 6px; right: calc(50% - 15px);
    background: var(--c-err); color: #fff; font-size: 0.6rem; font-weight: 800;
    padding: 2px 6px; border-radius: 10px; line-height: 1; border: 2px solid #fff; display: none;
}

/* MODAIS */
dialog{border:none;border-radius:24px;width:92%;max-width:420px;padding:0;box-shadow:0 25px 50px -12px rgba(0,0,0,0.4);background:#fff;animation:modalPop .3s}
dialog::backdrop{background:rgba(15,23,42,0.85);backdrop-filter:blur(4px)}
@keyframes modalPop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
.modal-body{padding:25px 20px;text-align:center}
.btn-modal{width:100%;padding:14px;border-radius:12px;font-weight:800;margin-bottom:10px;font-size:1rem}
.btn-modal.primary{background:var(--c-p);color:#fff}
.btn-modal.secondary{background:#fff;border:2px solid var(--c-bd);color:var(--c-s)}

/* MACRO DEPARTMENTS GRID (Modal Corredores) */
.macro-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
.macro-card {
    background: #f8fafc; border: 1px solid var(--c-bd); border-radius: 16px; padding: 25px 10px;
    display: flex; flex-direction: column; align-items: center; gap: 10px; cursor: pointer;
    transition: transform 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
}
.macro-card:active { transform: scale(0.95); }
.macro-card.alimentos { border-color: #fca5a5; background: #fef2f2; }
.macro-card.higiene { border-color: #93c5fd; background: #eff6ff; }
.macro-card.limpeza { border-color: #86efac; background: #f0fdf4; }
.macro-card.utilidades { border-color: #fde047; background: #fefce8; }
.macro-icon { font-size: 2.2rem; line-height: 1; }
.macro-title { font-weight: 800; font-size: 0.85rem; color: var(--c-p); text-transform: uppercase; }

/* TOAST */
#toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
.toast { padding: 12px 20px; color: #fff; border-radius: 12px; font-weight: 700; font-size: 0.9rem; box-shadow: var(--sh-float); text-align: center; animation: toastPop 0.3s ease-out; pointer-events: auto; }
@keyframes toastPop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* ZOOM */
#modal-image-zoom{background:transparent;box-shadow:none;width:100%;height:100%;max-width:none;max-height:none}
#modal-image-zoom .modal-body{padding:0;display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;position:relative}
#zoom-img{max-width:90%;max-height:85vh;border-radius:12px;background:#fff;box-shadow:0 25px 50px rgba(0,0,0,0.5)}
.btn-close-zoom{position:absolute;top:20px;right:20px;width:44px;height:44px;background:#fff;border-radius:50%;color:var(--c-p);font-weight:800;font-size:1.2rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:2010;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .2s}
.btn-close-zoom:hover{transform:scale(1.1)}

/* FAQ & SOCIAL */
.faq-header { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; border-bottom:1px solid #eee; padding-bottom:15px }
.faq-logo { width: 80px; height: 80px; border-radius: 50%; border:1px solid #cbd5e1; }
.faq-info-txt { font-size: 0.85rem; color: var(--c-s); line-height: 1.4; }
.faq-item { text-align: left; margin-bottom: 12px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px; }
.faq-q { font-weight: 700; color: var(--c-p); font-size: 0.9rem; }
.faq-a { font-size: 0.8rem; color: var(--c-s); margin-top: 4px; }
.social-row { display: flex; gap: 10px; justify-content: center; margin-top: 20px; margin-bottom: 15px; }
.btn-social { flex: 1; padding: 10px; border-radius: 10px; font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 6px; color: #fff; }

/* MODAL CAROUSEL */
.modal-carousel-track { display: flex; overflow-x: auto; gap: 12px; padding: 10px 5px; scroll-snap-type: x mandatory; justify-content: flex-start; }
.modal-carousel-track::-webkit-scrollbar{height:4px;background:transparent}
.modal-card { flex: 0 0 140px; scroll-snap-align: start; border: 1px solid #eee; border-radius: 12px; padding: 8px; background: #fff; display: flex; flex-direction: column; text-align: left; }
.modal-card img { width: 100%; aspect-ratio: 1; object-fit: contain; mix-blend-mode: multiply; margin-bottom: 6px; }
.modal-card .mc-name { font-size: 0.75rem; font-weight: 700; color: var(--c-p); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.5em; }
.modal-card .mc-price { font-size: 0.9rem; font-weight: 800; color: var(--c-a); margin-top: auto; }
.modal-card .mc-qty { font-size: 0.75rem; font-weight: 600; color: var(--c-s); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 4px; }

</style>
</head>
<body>

<header class="app-header">
    <div class="layout-limit header-inner">
        <div class="header-brand">
            <img src="img/produtos/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" class="logo" alt="Logo">
        </div>
        <div class="search-bar-area">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="search-inp" class="search-inp" placeholder="Buscar produto..." oninput="handleSearch(this.value)">
            <button class="clear-search" id="btn-clr-search" onclick="clearSearch()">‚úï</button>
        </div>
    </div>
    <div class="layout-limit" style="width: 100%;">
        <div class="chips-bar" id="chips-bar">
            </div>
    </div>
</header>

<main class="main-stage" id="scroll-stage">
    
    <div class="banner-wrapper" id="banner-area">
        </div>

    <div class="filter-row" id="filter-container">
        <div class="filter-wrapper">
            <select class="filter-sel-inline" id="filter-sel" onchange="applyFilter()">
                <option value="def">Relev√¢ncia</option>
                <option value="min">Menor Pre√ßo</option>
                <option value="max">Maior Pre√ßo</option>
                <option value="az">A-Z</option>
            </select>
        </div>
    </div>
    <div class="grid-wrapper" id="main-grid">
        </div>
</main>

<div class="floating-bottom" id="floating-bottom">
    <div class="floating-checkout-wrap">
        <div class="checkout-inline-row">
            <div class="progress-mini" id="progress-mini">
                <span id="prog-txt-mini">Faltam R$ 85</span>
                <div class="prog-track-mini"><div class="prog-fill-mini" id="prog-fill-mini"></div></div>
            </div>
            <button class="btn-floating-checkout" id="btn-checkout" onclick="openCheckout()">FINALIZAR</button>
        </div>
    </div>
</div>

<nav class="bottom-nav-bar">
    <div class="tab-item active" id="tab-__CESTAS__" onclick="loadCategory('__CESTAS__')">
        <div class="tab-icon">üì¶</div><div class="tab-label">Cestas</div>
    </div>
    <div class="tab-item" id="tab-__OFFERS__" onclick="loadCategory('__OFFERS__')">
        <div class="tab-icon">üî•</div><div class="tab-label">Ofertas</div>
    </div>
    <div class="tab-item" id="tab-CORREDORES" onclick="$('modal-corredores').showModal()">
        <div class="tab-icon">üóÇÔ∏è</div><div class="tab-label">Corredores</div>
    </div>
    <div class="tab-item" id="tab-__CART__" onclick="loadCategory('__CART__')">
        <div class="cart-badge" id="badge-count">0</div>
        <div class="tab-icon">üõí</div><div class="tab-label">Carrinho</div>
    </div>
</nav>

<div id="toast-container"></div>

<dialog id="modal-corredores">
    <div class="modal-body">
        <h3 style="font-weight:900; color:var(--c-p); text-transform:uppercase; margin-bottom:5px;">Corredores</h3>
        <p style="font-size:0.85rem; color:var(--c-s); margin-bottom: 5px;">Escolha um corredor para explorar</p>
        
        <div class="macro-grid">
            <div class="macro-card alimentos" onclick="loadMacro('Alimentos')">
                <div class="macro-icon">ü•´</div><div class="macro-title">Alimentos</div>
            </div>
            <div class="macro-card limpeza" onclick="loadMacro('Limpeza')">
                <div class="macro-icon">üßπ</div><div class="macro-title">Limpeza</div>
            </div>
            <div class="macro-card higiene" onclick="loadMacro('Higiene')">
                <div class="macro-icon">üßº</div><div class="macro-title">Higiene</div>
            </div>
            <div class="macro-card utilidades" onclick="loadMacro('Utilidades')">
                <div class="macro-icon">ü•õ</div><div class="macro-title">Utilidades</div>
            </div>
        </div>

        <button class="btn-modal secondary" onclick="$('modal-corredores').close(); $('modal-faq').showModal();">Informa√ß√µes e Contato</button>
        <button class="btn-modal secondary" style="border:none; color:var(--c-t);" onclick="$('modal-corredores').close()">‚úï Fechar Menu</button>
    </div>
</dialog>

<dialog id="modal-basket-preview">
    <div class="modal-body">
        <h3 class="stage-title" style="color:var(--c-p);font-size:1.4rem" id="prev-title"></h3>
        <p style="color:var(--c-s);margin-bottom:15px" id="prev-desc"></p>
        <div style="background:#f8fafc;padding:5px;border-radius:12px;border:1px solid var(--c-bd);margin-bottom:15px">
            <div class="modal-carousel-track" id="prev-list"></div>
        </div>
        <div style="margin-top:20px">
            <div style="font-size:1.8rem;font-weight:900;color:var(--c-a);margin-bottom:15px" id="prev-price"></div>
            <button class="btn-modal primary" id="btn-confirm-preview">ENCOMENDAR CESTA PADR√ÉO</button>
            <button class="btn-modal primary" id="btn-customize-preview" style="background:var(--c-a); display:none;">TROCAR PRODUTOS</button>
            <button class="btn-modal secondary" onclick="$('modal-basket-preview').close()">Voltar</button>
        </div>
    </div>
</dialog>

<dialog id="modal-checkout">
    <div class="modal-body" style="text-align:left">
        <h3 style="text-align:center;text-transform:uppercase;font-weight:900">Finalizar Pedido</h3>
        <div style="background:#f8fafc;padding:5px;border-radius:12px;border:1px solid var(--c-bd);margin:15px 0">
            <div class="modal-carousel-track" id="chk-list"></div>
        </div>
        <div style="text-align:right;margin-bottom:15px">
            <div style="font-size:1.4rem;font-weight:900" id="chk-total"></div>
        </div>
        
        <div id="coupon-toggle" onclick="this.style.display='none'; $('coupon-wrap').style.display='flex';" style="color:var(--c-a); font-size:0.8rem; font-weight:800; cursor:pointer; margin-bottom:15px; text-decoration:underline;">Tem um cupom de desconto?</div>
        <div id="coupon-wrap" style="display:none; gap:5px; margin-bottom:15px">
            <input id="cupom-code" style="flex:1;padding:10px;border:1px solid var(--c-bd);border-radius:8px;text-transform:uppercase" placeholder="C√ìDIGO">
            <button onclick="applyCupom()" style="background:var(--c-p);color:#fff;padding:0 15px;border-radius:8px;font-weight:700">OK</button>
        </div>
        <div id="cupom-msg" style="font-size:.8rem;font-weight:700;margin-bottom:10px;display:none"></div>
        
        <input id="cli-nome" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid var(--c-bd);border-radius:8px;font-weight:600" placeholder="Seu Nome Completo">
        <select id="cli-pgto" style="width:100%;padding:12px;margin-bottom:20px;border:1px solid var(--c-bd);border-radius:8px;font-weight:600;background:#fff">
            <option>PIX na Entrega</option>
            <option>Dinheiro</option>
            <option>Cart√£o de Cr√©dito</option>
            <option>Cart√£o de D√©bito</option>
            <option>Cart√£o Alimenta√ß√£o</option>
        </select>
        <button class="btn-modal primary" onclick="sendOrder()">ENVIAR PEDIDO (WHATSAPP)</button>
        <button class="btn-modal secondary" onclick="$('modal-checkout').close()">Continuar Comprando</button>
        <button class="btn-modal" style="color:var(--c-err);font-size:0.8rem;border:none;background:transparent" onclick="clearCart()">Esvaziar Carrinho</button>
    </div>
</dialog>

<dialog id="modal-image-zoom" onclick="if(event.target===this)this.close()">
    <div class="modal-body">
        <button class="btn-close-zoom" onclick="this.closest('dialog').close()">‚úï</button>
        <img id="zoom-img" src="">
    </div>
</dialog>

<dialog id="modal-faq" onclick="if(event.target===this)this.close()">
    <div class="modal-body">
        <div class="faq-header">
            <img src="img/produtos/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" class="faq-logo" alt="Logo">
            <h3 style="font-weight:900;color:var(--c-p);text-transform:uppercase">Dona Ant√¥nia</h3>
            <div class="faq-info-txt">Cuiab√° e V√°rzea Grande - MT<br>Tel: (65) 99681-3588</div>
        </div>
        <div class="faq-item"><div class="faq-q">Qual o valor da entrega?</div><div class="faq-a">A entrega √© totalmente gr√°tis para Cuiab√° e V√°rzea Grande.</div></div>
        <div class="faq-item"><div class="faq-q">Quais as formas de pagamento?</div><div class="faq-a">Aceitamos PIX, Dinheiro, Cart√£o de Cr√©dito e D√©bito na entrega.</div></div>
        <div class="faq-item"><div class="faq-q">Qual o prazo de entrega?</div><div class="faq-a">Entregas em at√© 24 horas √∫teis ap√≥s a confirma√ß√£o do pedido.</div></div>
        <div class="faq-item"><div class="faq-q">Posso personalizar a cesta?</div><div class="faq-a">Sim! Voc√™ pode adicionar ou remover itens conforme sua necessidade.</div></div>
        <div class="social-row">
            <button class="btn-social" style="background:#25D366" onclick="window.open('https://wa.me/5565996813588','_blank')">WhatsApp</button>
            <button class="btn-social" style="background:#E1306C" onclick="alert('Link do Instagram aqui')">Instagram</button>
        </div>
        <button class="btn-modal secondary" onclick="this.closest('dialog').close()">Voltar</button>
    </div>
</dialog>

<script>
const $=i=>document.getElementById(i);
const STATE={
    baskets:[], prods:[], coupons:[], combos:[], departamentos:{}, banners:[],
    cart:{}, cartOrder:[], 
    activeCat:'__CESTAS__', 
    activeMacro: null,
    activeMicro: null,
    mode:'zero', 
    baseBasket:null, minBasketPrice:0, 
    basketExtraFee:0, 
    comboDiscount: 0, 
    coupon:null,
    currentList: []
};

async function init(){
    try{
        const[r1,r2,r3,r4,r5,r6]=await Promise.all([
            fetch('produtos-cesta-basica.json?v='+Date.now()),
            fetch('produtos.json?v='+Date.now()),
            fetch('cupons.json?v='+Date.now()).catch(()=>({ok:false})),
            fetch('combos.json?v='+Date.now()).catch(()=>({ok:false})),
            fetch('departamento.json?v='+Date.now()).catch(()=>({ok:false})),
            fetch('banner.json?v='+Date.now()).catch(()=>({ok:false}))
        ]);
        if(r1.ok) STATE.baskets = await r1.json();
        if(r2.ok){
            let t=(await r2.text()).trim().replace(/,(\s+)?$/,"");
            let raw = JSON.parse(t.startsWith('[')?t:'['+t+']');
            STATE.prods = raw.filter(x=>x.situacao==="A").map(p=>({
                id:String(p.id), code:String(p.codigo||p.id),
                name:p.nome, price:parseFloat(p.preco),
                oldPrice: p.preco_antigo ? parseFloat(p.preco_antigo) : null,
                stock:parseInt(p.estoque)||0,
                cat:(p.categoria||p.Categoria||"Outros").trim(),
                val:p.validade, img:`img/produtos/${p.codigo||p.id}.webp`
            }));
        }
        if(r3&&r3.ok) STATE.coupons = await r3.json();
        if(r4&&r4.ok) STATE.combos = await r4.json();
        if(r5&&r5.ok) STATE.departamentos = await r5.json();
        if(r6&&r6.ok) STATE.banners = await r6.json();

        renderBanners();
        loadCategory('__CESTAS__');
        updateTotals(); 
    }catch(e){
        $('main-grid').innerHTML='<p style="grid-column:1/-1;padding:20px;text-align:center;color:red;font-weight:bold;">Erro fatal na leitura dos arquivos.<br>Abra o F12 para ver detalhes.</p>';
        console.error("ERRO DO C√ìDIGO", e);
    }
}

/* --- LOGICA DOS BANNERS --- */
function renderBanners() {
    const wrap = $('banner-area');
    if (!STATE.banners || STATE.banners.length === 0) {
        wrap.style.display = 'none';
        return;
    }
    wrap.innerHTML = STATE.banners.map(b => `
        <div class="banner-card" style="background:${b.corFundo}; color:${b.corTexto}" onclick="handleBannerClick('${b.linkChip}')">
            <div class="banner-title">${b.titulo}</div>
            <div class="banner-sub">${b.subtitulo}</div>
        </div>
    `).join('');
}

window.handleBannerClick = function(link) {
    if(!link) return;
    if(link.startsWith('__')) {
        loadCategory(link);
    } else if (['OFERTAS_SEMANA', 'COMBOS', 'ATE_2'].includes(link)) {
        loadCategory('__OFFERS__');
        setTimeout(() => loadOfferMicro(link), 100);
    } else {
        goToCategory(link);
    }
}

/* --- NAVEGACAO ENTRE DEPARTAMENTOS --- */
function loadMacro(macroName) {
    $('modal-corredores').close();
    document.querySelectorAll('.tab-item').forEach(el=>el.classList.remove('active'));
    $('tab-CORREDORES').classList.add('active');
    
    STATE.activeCat = 'MACRO';
    STATE.activeMacro = macroName;

    let chipsHtml = `<div class="chip active" id="chip-Todos" onclick="loadMicro('Todos')">Ver Tudo</div>`;
    
    let categoriasDoCorredor = STATE.departamentos[macroName] || [];
    categoriasDoCorredor.sort((a,b) => a.localeCompare(b)); 

    categoriasDoCorredor.forEach(cat => {
        const safeId = cat.replace(/\s/g,'-');
        chipsHtml += `<div class="chip" id="chip-${safeId}" onclick="loadMicro('${cat.replace(/'/g,"\\'")}')">${cat}</div>`;
    });
    
    $('chips-bar').innerHTML = chipsHtml;
    $('chips-bar').style.display = 'flex';
    $('banner-area').style.display = 'none'; // Esconde banners nos corredores
    
    loadMicro('Todos');
    updateTotals();
}

function loadMicro(catName) {
    STATE.activeMicro = catName;
    
    document.querySelectorAll('.chip').forEach(el=>el.classList.remove('active'));
    let c = document.getElementById(`chip-${catName.replace(/\s/g,'-')}`);
    if(c) {
        c.classList.add('active');
        c.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});
    }

    let list = [];
    if(catName === 'Todos') {
        const categoriasDoCorredor = STATE.departamentos[STATE.activeMacro] || [];
        list = STATE.prods.filter(p => categoriasDoCorredor.includes(p.cat));
    } else {
        list = STATE.prods.filter(p => p.cat === catName);
    }
    
    STATE.currentList = list;
    applyFilter();
}

/* --- ABA DE OFERTAS & CHIPS ESPECIAIS --- */
function loadOfferMicro(type) {
    STATE.activeMicro = type;
    
    document.querySelectorAll('.chip').forEach(el=>el.classList.remove('active'));
    let c = document.getElementById(`chip-${type}`);
    if(c) {
        c.classList.add('active');
        c.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});
    }

    if (type === 'OFERTAS_SEMANA') {
        $('filter-sel').value = 'def';
        STATE.currentList = STATE.prods.filter(p => p.oldPrice && p.oldPrice > p.price);
        applyFilter();
    } else if (type === 'COMBOS') {
        STATE.currentList = STATE.combos;
        renderChunked(STATE.currentList, 'COMBO', true);
    } else if (type === 'ATE_2') {
        $('filter-sel').value = 'min'; 
        STATE.currentList = STATE.prods.filter(p => p.price <= 2.00);
        applyFilter();
    }
}

/* --- NAVEGACAO PRINCIPAL --- */
function loadCategory(key){
    if(key === '__CART__' && Object.keys(STATE.cart).length === 0) return showToast("Seu carrinho est√° vazio!", "r");

    $('modal-corredores').close();
    $('chips-bar').style.display = 'none'; 
    
    // Controlo dos Banners (Apenas vis√≠veis na Home/Cestas)
    if(key === '__CESTAS__' && STATE.banners && STATE.banners.length > 0) {
        $('banner-area').style.display = 'flex';
    } else {
        $('banner-area').style.display = 'none';
    }

    document.querySelectorAll('.tab-item').forEach(el=>el.classList.remove('active'));
    if(key === '__CESTAS__' || key === '__OFFERS__' || key === '__CART__') {
        let tab = document.getElementById(`tab-${key}`);
        if(tab) tab.classList.add('active');
    }

    STATE.activeCat = key;
    
    if(key === '__CESTAS__'){
        STATE.currentList = STATE.baskets;
        renderChunked(STATE.currentList, 'BASKET', true);
    } 
    else if(key === '__CART__'){
        STATE.currentList = STATE.cartOrder.map(id=>STATE.prods.find(p=>p.id===id)).filter(Boolean);
        renderChunked(STATE.currentList, 'PROD', true);
    }
    else if(key === '__OFFERS__'){
        let chipsHtml = `
            <div class="chip" id="chip-OFERTAS_SEMANA" onclick="loadOfferMicro('OFERTAS_SEMANA')">Ofertas da Semana</div>
            <div class="chip" id="chip-COMBOS" onclick="loadOfferMicro('COMBOS')">Combos</div>
            <div class="chip" id="chip-ATE_2" onclick="loadOfferMicro('ATE_2')">At√© R$ 2,00</div>
        `;
        $('chips-bar').innerHTML = chipsHtml;
        $('chips-bar').style.display = 'flex';
        loadOfferMicro('OFERTAS_SEMANA');
    }
    
    updateTotals(); 
}

function applyFilter(){
    const type = $('filter-sel').value;
    if(STATE.activeCat === '__CESTAS__' || STATE.activeMicro === 'COMBOS') return; 
    
    let list = [...STATE.currentList];
    if(type === 'min') list.sort((a,b)=>a.price - b.price);
    if(type === 'max') list.sort((a,b)=>b.price - a.price);
    if(type === 'az') list.sort((a,b)=>a.name.localeCompare(b.name));
    
    if(type === 'def') list.sort((a,b)=>{
        const fa = a.oldPrice && a.oldPrice > a.price;
        const fb = b.oldPrice && b.oldPrice > b.price;
        return fa===fb ? 0 : fa ? -1 : 1;
    });

    renderChunked(list, 'PROD', true);
}

function renderChunked(list, type, reset){
    const grid = $('main-grid');
    if(reset) grid.innerHTML = '';
    
    if(type === 'BASKET' || type === 'COMBO') {
        $('filter-container').style.display = 'none';
    } else {
        $('filter-container').style.display = 'flex';
    }

    const html = list.map(item => {
        if(type === 'BASKET') return cardBasket(item);
        if(type === 'COMBO') return cardCombo(item);
        return cardProd(item);
    }).join('');
    
    grid.innerHTML = html || '<p style="grid-column:1/-1;text-align:center;color:#94a3b8;padding:20px;margin:auto;">Nenhum item encontrado.</p>';
    
    if(reset) $('scroll-stage').scrollTo({top:0, behavior: 'smooth'});
}

/* LINK DINAMICO PARA CATEGORIA */
window.goToCategory = function(catName) {
    let foundMacro = 'Alimentos'; 
    for(let macro in STATE.departamentos) {
        if(STATE.departamentos[macro] && STATE.departamentos[macro].includes(catName)) {
            foundMacro = macro;
            break;
        }
    }
    loadMacro(foundMacro);
    setTimeout(() => { loadMicro(catName); }, 100);
}

/* CARDS */
function cardBasket(item){
    return `
    <div class="u-card">
        <div class="u-img-area"><img src="${item.imagem}" class="u-img u-img-cesta" loading="lazy"></div>
        <div class="u-info">
            <div class="u-name">${formatName(item.nome)}</div>
            <div class="u-price">${fmt(item.preco)}</div>
            <div class="u-action-row">
                <button class="btn-big-action" onclick="previewBasket('${item.id}')">VER ITENS</button>
            </div>
        </div>
    </div>`;
}

function cardCombo(item){
    let sum = 0;
    item.produtos.forEach(s => {
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x => x.id === ref.trim() || x.code === ref.trim());
        if (p) sum += p.price * parseInt(qStr);
    });
    const econ = sum - item.preco;
    
    return `
    <div class="u-card">
        <div class="u-img-area">
            <img src="${item.imagem || 'img/produtos/cesta.webp'}" class="u-img u-img-cesta" loading="lazy">
            <div class="offer-tag" style="background:var(--c-ok)">üî• COMBO</div>
        </div>
        <div class="u-info">
            <div class="u-name">${formatName(item.nome)}</div>
            <div style="margin-top:auto">
                <div class="combo-strike">De: ${fmt(sum)}</div>
                <div class="u-price">Por: ${fmt(item.preco)}</div>
                ${econ > 0 ? `<div class="combo-save">Sua economia: ${fmt(econ)}</div>` : ''}
            </div>
            <div class="u-action-row">
                <button class="btn-big-action" onclick="previewCombo('${item.id}')">VER ITENS</button>
            </div>
        </div>
    </div>`;
}

function cardProd(item){
    const q = STATE.cart[item.id] || 0;
    const isOfferTab = (STATE.activeCat === '__OFFERS__' && STATE.activeMicro !== 'COMBOS');
    const isOffer = item.oldPrice && item.oldPrice > item.price;
    
    let metaHtml = '';
    if(item.val || item.stock < 10) {
        let m = [];
        if(item.val) m.push(`Val: ${item.val}`);
        if(item.stock < 10) m.push(`Restam ${item.stock}`);
        metaHtml = `<div class="meta-row"><span class="meta-text">${m.join(' | ')}</span></div>`;
    }

    let priceHtml = '';
    if (isOffer) {
        const discountPct = Math.round(((item.oldPrice - item.price) / item.oldPrice) * 100);
        priceHtml = `
        <div class="price-area">
            <div class="old-price-row">
                <span class="strike-price">${fmt(item.oldPrice)}</span>
                <span class="discount-badge">-${discountPct}%</span>
            </div>
            <div class="u-price">${fmt(item.price)}</div>
        </div>`;
    } else {
        priceHtml = `
        <div class="price-area">
            <div class="u-price">${fmt(item.price)}</div>
        </div>`;
    }
    
    const btn = q > 0 
        ? `<div class="qty-row">
             <button class="btn-qty" onclick="upd('${item.id}',-1)">-</button>
             <input class="qty-inp qty-${item.id}" type="number" value="${q}" onchange="upd('${item.id}',this.value- ${q})">
             <button class="btn-qty" onclick="upd('${item.id}',1)" style="color:var(--c-ok)">+</button>
           </div>`
        : `<button class="btn-big-action" id="btn-add-${item.id}" onclick="addAnim('${item.id}');upd('${item.id}',1)" ${item.stock<=0?'disabled':''}>${item.stock<=0?'ESGOTADO':'ADICIONAR'}</button>`;
    
    return `
    <div class="u-card">
        <div class="u-img-area" onclick="openImageZoom('${item.img}')">
            <img src="${item.img}" class="u-img" loading="lazy">
        </div>
        <div class="u-info">
            <div class="u-name">${formatName(item.name)}</div>
            ${metaHtml}
            ${priceHtml}
            <div class="u-action-row ctrl-wrap-${item.id}">
                ${btn}
                ${(isOfferTab && item.cat) ? `<div class="offer-cat-link" onclick="goToCategory('${item.cat}')">+ ${item.cat}</div>` : ''}
            </div>
        </div>
    </div>`;
}

function addAnim(id){
    if(navigator.vibrate) navigator.vibrate(50);
    const btn = document.getElementById(`btn-add-${id}`);
    if(btn){
        btn.classList.add('success-flash');
        const old = btn.innerText; btn.innerText = "SUCESSO!";
        setTimeout(()=>btn.innerText=old, 600);
    }
}

/* PREVIEWS */
function previewBasket(id){
    const c = STATE.baskets.find(x=>String(x.id)===String(id));
    if(!c) return;
    STATE.tempBasket = c;
    $('prev-title').innerHTML = formatName(c.nome);
    $('prev-desc').innerHTML = `${c.produtos.length} itens inclusos`;
    $('prev-price').innerHTML = fmt(c.preco);
    $('prev-list').innerHTML = c.produtos.map(s=>{
        const [qtd, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        return `<div class="modal-card"><img src="${p?.img}" loading="lazy"><div class="mc-name">${p?formatName(p.name):ref}</div><div class="mc-qty">${qtd}x</div></div>`
    }).join('');
    
    const btn = $('btn-confirm-preview');
    btn.innerText = "ENCOMENDAR CESTA PADR√ÉO";
    btn.onclick = () => { confirmBasket(); openCheckout(); };
    
    const btnCust = $('btn-customize-preview');
    if(btnCust) {
        btnCust.style.display = 'block';
        btnCust.innerText = "TROCAR PRODUTOS";
        btnCust.onclick = () => confirmBasket();
    }
    
    $('modal-basket-preview').showModal();
}

function previewCombo(id){
    const c = STATE.combos.find(x=>String(x.id)===String(id));
    if(!c) return;
    
    let sum = 0;
    $('prev-title').innerHTML = formatName(c.nome);
    $('prev-list').innerHTML = c.produtos.map(s=>{
        const [qtd, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p) sum += p.price * parseInt(qtd);
        return `<div class="modal-card"><img src="${p?.img}" loading="lazy"><div class="mc-name">${p?formatName(p.name):ref}</div><div class="mc-qty">${qtd}x</div></div>`
    }).join('');
    
    const econ = sum - c.preco;
    $('prev-desc').innerHTML = `<span class="combo-strike">De: ${fmt(sum)}</span> | <span style="color:var(--c-ok);font-weight:bold">Economia: ${fmt(econ)}</span>`;
    $('prev-price').innerHTML = fmt(c.preco);
    
    const btn = $('btn-confirm-preview');
    btn.innerText = "ADICIONAR COMBO AO CARRINHO";
    btn.onclick = () => confirmCombo(id);
    
    const btnCust = $('btn-customize-preview');
    if(btnCust) btnCust.style.display = 'none';
    
    $('modal-basket-preview').showModal();
}

/* CONFIRMA√á√ïES */
function confirmBasket(){
    const c = STATE.tempBasket;
    STATE.mode = 'custom';
    STATE.baseBasket = c;
    STATE.minBasketPrice = c.preco; 
    STATE.cart = {}; STATE.cartOrder = [];
    
    let itemsSum = 0;
    let alertStock = false;
    c.produtos.forEach(s=>{
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p){
            let q = parseInt(qStr);
            if(q > p.stock) {
                q = p.stock;
                alertStock = true;
            }
            if(q > 0) {
                STATE.cart[p.id] = q; STATE.cartOrder.push(p.id);
                itemsSum += (p.price * q);
            }
        }
    });

    STATE.basketExtraFee = STATE.minBasketPrice - itemsSum;
    $('modal-basket-preview').close();
    
    if(alertStock) showToast(`Cesta carregada! Alguns itens limitados ao estoque.`, 's');
    else showToast(`Cesta carregada!`, 's');
    
    loadCategory('__CART__');
}

function confirmCombo(id){
    const c = STATE.combos.find(x=>String(x.id)===String(id));
    if(!c) return;
    
    let canAdd = true;
    let missingItem = "";
    c.produtos.forEach(s=>{
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p){
            const cur = STATE.cart[p.id] || 0;
            if(cur + parseInt(qStr) > p.stock) {
                canAdd = false;
                missingItem = p.name;
            }
        }
    });

    if(!canAdd) return showToast(`Estoque insuficiente: ${missingItem}`, "r");
    
    c.produtos.forEach(s=>{
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p){
            const q = parseInt(qStr);
            const cur = STATE.cart[p.id] || 0;
            if(cur === 0) STATE.cartOrder.push(p.id);
            STATE.cart[p.id] = cur + q;
        }
    });
    
    $('modal-basket-preview').close();
    showToast(`Combo adicionado! Os itens foram para o carrinho.`, 's');
    loadCategory('__CART__');
}

function upd(id, delta){
    const p = STATE.prods.find(x=>x.id===id);
    if(!p) return;
    const cur = STATE.cart[id] || 0;
    
    let next = cur + parseInt(delta);
    if(isNaN(next)) next = 0;
    next = Math.max(0, next);
    
    if(next > p.stock) {
        showToast(`Apenas ${p.stock} unidades dispon√≠veis`, "r");
        document.querySelectorAll(`.qty-${id}`).forEach(e=>e.value = cur);
        return;
    }
    
    if(cur === 0 && next > 0) STATE.cartOrder.push(id);
    STATE.cart[id] = next;
    if(next === 0){
        delete STATE.cart[id];
        STATE.cartOrder = STATE.cartOrder.filter(x=>x!==id);
        if(STATE.activeCat === '__CART__') loadCategory('__CART__');
    }
    
    document.querySelectorAll(`.qty-${id}`).forEach(e=>e.value = next);
    
    if((cur===0 && next>0) || (cur>0 && next===0)){
        const btn = next > 0 
             ? `<div class="qty-row"><button class="btn-qty" onclick="upd('${id}',-1)">-</button><input class="qty-inp qty-${id}" type="number" value="${next}" onchange="upd('${id}',this.value-${next})"><button class="btn-qty" onclick="upd('${id}',1)" style="color:var(--c-ok)">+</button></div>`
             : `<button class="btn-big-action" id="btn-add-${id}" onclick="addAnim('${id}');upd('${id}',1)">ADICIONAR</button>`;
        document.querySelectorAll(`.ctrl-wrap-${id}`).forEach(el=> {
            el.innerHTML = btn + ((STATE.activeCat === '__OFFERS__' && p.cat) ? `<div class="offer-cat-link" onclick="goToCategory('${p.cat}')">+ ${p.cat}</div>` : '');
        });
    }
    updateTotals();
}

function updateTotals(){
    let sumItems = 0, count = 0;
    Object.entries(STATE.cart).forEach(([id,q])=>{
        const p = STATE.prods.find(x=>x.id===id);
        if(p){ sumItems += p.price * q; count += q; }
    });

    STATE.comboDiscount = 0;
    let tempCart = { ...STATE.cart };
    
    if (STATE.combos && STATE.combos.length > 0) {
        STATE.combos.forEach(c => {
            let possibleTimes = 9999;
            let comboSomaProd = 0;
            let reqs = [];
            c.produtos.forEach(s => {
                const parts = s.split('x');
                if (parts.length === 2) {
                    const q = parseInt(parts[0]);
                    const ref = parts[1].trim();
                    const p = STATE.prods.find(x => x.id === ref || x.code === ref);
                    if (p) { reqs.push({ id: p.id, q: q }); comboSomaProd += p.price * q; }
                }
            });
            if (reqs.length === 0) possibleTimes = 0;
            reqs.forEach(r => { let inCart = tempCart[r.id] || 0; possibleTimes = Math.min(possibleTimes, Math.floor(inCart / r.q)); });
            if (possibleTimes > 0) {
                reqs.forEach(r => tempCart[r.id] -= (r.q * possibleTimes));
                let discountPerCombo = comboSomaProd - c.preco;
                if (discountPerCombo > 0) STATE.comboDiscount += discountPerCombo * possibleTimes;
            }
        });
    }

    let displayTotal = sumItems - STATE.comboDiscount;
    let btnCheckout = $('btn-checkout');
    let isCheckoutBlocked = false;
    
    if(STATE.mode === 'custom' && STATE.minBasketPrice > 0){
        displayTotal += STATE.basketExtraFee;
        if(displayTotal < STATE.minBasketPrice){
            const credit = STATE.minBasketPrice - displayTotal;
            displayTotal = STATE.minBasketPrice; 
            $('prog-txt-mini').innerHTML = `<span style="color:var(--c-a);">USE ${fmt(credit)} DE CR√âDITO</span>`;
            $('prog-fill-mini').style.width = '100%'; 
            $('prog-fill-mini').style.background = 'repeating-linear-gradient(45deg, var(--c-a), var(--c-a) 10px, #fb923c 10px, #fb923c 20px)';
            isCheckoutBlocked = true; 
        } else {
            $('prog-txt-mini').innerText = "Pedido Liberado!";
            $('prog-fill-mini').style.width = '100%'; 
            $('prog-fill-mini').style.background = 'var(--c-ok)';
        }
    } else {
        const minOrder = 85.00;
        const missing = Math.max(0, minOrder - displayTotal);
        const pct = Math.min(100, (displayTotal / minOrder) * 100);
        if(missing > 0){
            $('prog-txt-mini').innerText = `Faltam ${fmt(missing)}`;
            $('prog-fill-mini').style.width = `${pct}%`; 
            $('prog-fill-mini').style.background = 'var(--c-a)';
            isCheckoutBlocked = true;
        } else {
            $('prog-txt-mini').innerText = "Pedido Liberado!";
            $('prog-fill-mini').style.width = '100%'; 
            $('prog-fill-mini').style.background = 'var(--c-ok)';
        }
    }

    if(STATE.coupon){
        if(displayTotal >= STATE.coupon.minimo) displayTotal -= STATE.coupon.desconto;
        else { STATE.coupon=null; showToast("Cupom removido", "r"); }
    }

    // UPDATE UI
    const badge = $('badge-count');
    badge.innerText = count;
    badge.style.display = count > 0 ? 'block' : 'none';

    $('chk-total').innerText = fmt(displayTotal);
    
    // VISIBILIDADE NO CARRINHO
    if(STATE.activeCat === '__CART__' && count > 0) {
        $('floating-bottom').style.display = 'flex';
        btnCheckout.disabled = isCheckoutBlocked;
        btnCheckout.style.background = isCheckoutBlocked ? '#94a3b8' : '#16a34a';
        btnCheckout.innerHTML = `FINALIZAR ‚Ä¢ ${fmt(displayTotal)}`;
    } else {
        $('floating-bottom').style.display = 'none';
    }
}

function openCheckout(){
    if($('btn-checkout').disabled) return showToast("Adicione produtos para liberar o pedido!", "r");
    
    let listHtml = STATE.cartOrder.map(id=>{
        const p = STATE.prods.find(x=>x.id===id);
        return `<div class="modal-card"><img src="${p.img}"><div class="mc-name">${formatName(p.name)}</div><div class="mc-price">${fmt(p.price)}</div><div class="mc-qty">${STATE.cart[id]}x</div></div>`
    }).join('');
    
    if(STATE.comboDiscount > 0){
        listHtml += `<div class="modal-card" style="border:1px solid var(--c-ok);background:#f0fdf4">
                        <div class="mc-name" style="color:var(--c-ok);font-size:0.85rem">üéÅ Desconto Combo</div>
                        <div class="mc-price" style="color:var(--c-ok)">- ${fmt(STATE.comboDiscount)}</div>
                     </div>`;
    }

    $('chk-list').innerHTML = listHtml;
    $('modal-checkout').showModal();
}

/* UTILS */
function clearCart(){ if(confirm("Esvaziar tudo?")){STATE.cart={};STATE.cartOrder=[];STATE.mode='zero';STATE.minBasketPrice=0;STATE.basketExtraFee=0;STATE.comboDiscount=0;STATE.coupon=null;updateTotals();$('modal-checkout').close();loadCategory('__CESTAS__');}}
function handleSearch(q){
    const btn=$('btn-clr-search'); btn.style.display=q?'flex':'none';
    if(!q) return STATE.activeCat === 'MACRO' ? loadMicro(STATE.activeMicro) : loadCategory(STATE.activeCat);
    STATE.currentList = STATE.prods.filter(p=>p.name.toUpperCase().includes(q.toUpperCase()));
    renderChunked(STATE.currentList, 'PROD', true);
}
function clearSearch(){$('search-inp').value='';handleSearch('');}
function applyCupom(){
    const c=STATE.coupons.find(x=>x.codigo===$('cupom-code').value.toUpperCase().trim());
    const tot=parseMoney($('chk-total').innerText);
    
    if(c && tot>=c.minimo){ STATE.coupon=c; updateTotals(); $('cupom-msg').innerText="CUPOM APLICADO!"; $('cupom-msg').style.display='block'; }
    else showToast("Cupom inv√°lido ou m√≠nimo n√£o atingido", "r");
}

async function sendOrder(){
    const nome=$('cli-nome').value; if(!nome) return alert("Por favor, digite seu nome");
    let itemsTxt="", apiItens=[]; let totalBruto=0;
    
    Object.entries(STATE.cart).forEach(([id,q])=>{
        const p=STATE.prods.find(x=>x.id===id);
        if(p){ totalBruto+=p.price*q; itemsTxt+=`${q}x ${p.name}\n`; apiItens.push({id:p.id,nome:p.name,qtd:q,price:p.price}); }
    });

    let final = totalBruto - STATE.comboDiscount;
    
    if(STATE.comboDiscount > 0){
        itemsTxt += `\n[DESCONTO COMBO APLICADO: -${fmt(STATE.comboDiscount)}]`;
        apiItens.push({id:'DESC_COMBO', nome:'Desconto de Combo', qtd:1, price: -STATE.comboDiscount});
    }

    if(STATE.mode === 'custom' && STATE.minBasketPrice > 0){
        final = Math.max(final + STATE.basketExtraFee, STATE.minBasketPrice);
        if(STATE.basketExtraFee > 0){
            itemsTxt += `\n[OUTRAS DESPESAS/TAXA: ${fmt(STATE.basketExtraFee)}]`;
            apiItens.push({id:'GAP', nome:'Taxas / Outras Despesas', qtd:1, price:STATE.basketExtraFee});
        }
    }

    if(STATE.coupon){ final-=STATE.coupon.desconto; itemsTxt+=`\nCUPOM: ${STATE.coupon.codigo}`; }
    
    const msg = `*NOVO PEDIDO*\nüë§ ${nome}\nüí∞ ${$('cli-pgto').value}\n\n*ITENS:*\n${itemsTxt}\n\n*TOTAL: ${fmt(final)}*`;
    
    try{
        fetch("https://hook.eu1.make.com/yisqs4w309ogi6fx4969dbsr2q7fu7il", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                cliente:{nome},
                pedido:{
                    itens:apiItens,
                    total:final,
                    outras_despesas: (STATE.mode === 'custom' ? STATE.basketExtraFee : 0) 
                }
            })
        });
    }catch(e){}
    window.location.href=`https://wa.me/5565996813588?text=${encodeURIComponent(msg)}`;
}

function formatName(s){ return s?s.replace(/\s+/g,' ').trim().toLowerCase().split(' ').map(w=>w.length<=3?w:w[0].toUpperCase()+w.slice(1)).join(' '):''; }
function parseMoney(s){return parseFloat(s.replace('R$','').replace('.','').replace(',','.').trim());}
function fmt(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function showToast(m,t){const d=document.createElement('div');d.className='toast';d.style.background=t==='r'?'var(--c-err)':'var(--c-ok)';d.innerText=m;$('toast-container').appendChild(d);setTimeout(()=>d.remove(),2500);}
function openImageZoom(s){$('zoom-img').src=s;$('modal-image-zoom').showModal();}

init();
</script>
</body>
</html>
