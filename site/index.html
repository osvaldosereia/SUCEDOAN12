<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Super Cestas Dona Ant√¥nia - Encomende online via WhatsApp.">
    
    <meta name="geo.region" content="BR-MT" />
    <meta name="geo.placename" content="Cuiab√°" />
    <meta name="theme-color" content="#F3F4F6"> <title>Super Cestas Dona Ant√¥nia</title>

    <style>
        /* --- CONFIGURA√á√ïES GERAIS "CLEAN & FAST" REFINADO --- */
        :root {
            --cor-primary: #333333; 
            --cor-accent: #E63946;  
            --cor-bg: #FFFFFF;      
            --cor-surface: #FFFFFF; 
            --cor-bar-bg: #F3F4F6;  /* Cinza claro para barras */
            --cor-text-main: #333333;
            --cor-text-light: #666666;
            --cor-divider: #EEEEEE; 
            
            /* Tipografia Leve e Ajustada */
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-size-name: 0.8rem;   /* Reduzido conforme pedido */
            --font-size-price: 1.0rem;  /* Reduzido conforme pedido */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-stack);
            background-color: var(--cor-bg);
            color: var(--cor-text-main);
            margin: 0;
            padding-bottom: 120px;
            font-size: 16px;
            line-height: 1.4;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3 { margin: 0; font-weight: 600; color: var(--cor-text-main); letter-spacing: -0.5px; }
        button { cursor: pointer; border: none; outline: none; background: none; font-family: inherit; }

        /* --- ANIMA√á√ïES --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideFade { 
            0% { opacity: 0; transform: translateY(10px); } 
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        /* --- CABE√áALHO --- */
        .header-wrapper {
            position: sticky; top: 0; z-index: 100;
            background: var(--cor-bar-bg); /* Cinza claro */
            border-bottom: 1px solid #e5e5e5;
        }

        header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px;
            height: 60px;
            max-width: 1200px; margin: 0 auto;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        
        .logo { 
            width: 45px; height: 45px; 
            border-radius: 50%; /* Redonda */
            object-fit: cover;
            border: 1px solid #ddd;
        }
        
        .page-title { font-size: 1.1rem; font-weight: 600; color: var(--cor-text-main); }
        .btn-back { display: none; font-size: 1.2rem; color: var(--cor-text-main); padding: 5px; }
        .btn-help { width: 32px; height: 32px; background: white; border: 1px solid #ddd; border-radius: 50%; color: var(--cor-text-main); font-weight: 600; font-size: 1rem; }

        /* --- VISUALIZA√á√ÉO (VIEWS) --- */
        main { display: block; width: 100%; max-width: 1200px; margin: 0 auto; }
        .view { display: none; padding: 10px 0; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }

        /* --- BANNER ROTATIVO AUTOM√ÅTICO --- */
        .banner-rotativo-wrapper {
            padding: 15px 20px 5px 20px;
            margin-bottom: 10px;
        }
        .banner-box {
            background: linear-gradient(135deg, #fce4ec, #fff9c4); /* Cores suaves de fundo */
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            height: 100px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            border: 1px solid #f0f0f0;
            overflow: hidden;
            position: relative;
        }
        .banner-text {
            font-size: 1.05rem;
            font-weight: 600;
            color: #444;
            animation: fadeIn 0.5s ease-in-out;
            width: 100%;
        }

        /* --- TITULOS DE SE√á√ÉO --- */
        .section-header {
            padding: 20px 20px 10px 20px;
            font-size: 1.1rem;
            font-weight: 700; /* Mais peso */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid transparent;
        }

        /* --- CARROSSEL COM LINHAS E SETA --- */
        .carousel-container {
            position: relative;
            width: 100%;
        }
        
        .scroll-indicator-right {
            position: absolute;
            right: 0; top: 0; bottom: 0;
            width: 60px;
            background: linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,1));
            display: flex; align-items: center; justify-content: flex-end;
            padding-right: 15px;
            pointer-events: none;
            z-index: 10;
            transition: opacity 0.5s ease;
        }
        .scroll-indicator-right.faded { opacity: 0; }
        .arrow-icon {
            width: 30px; height: 30px;
            background: rgba(0,0,0,0.05);
            border-radius: 50%;
            display: grid; place-items: center;
            font-size: 1.2rem; color: #666;
        }

        /* Grid de Cestas (Vertical na Home) */
        .grid-cestas { display: flex; flex-direction: column; gap: 0; }
        
        .cesta-card { 
            background: white; 
            padding: 20px;
            display: flex; flex-direction: row; 
            align-items: center;
            gap: 20px;
            border-bottom: 1px solid var(--cor-divider);
            position: relative;
        }
        
        .cesta-img-wrap { width: 100px; height: 100px; flex-shrink: 0; }
        .cesta-img { width: 100%; height: 100%; object-fit: contain; }
        
        .cesta-content { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .cesta-name { font-size: 1.1rem; font-weight: 600; color: var(--cor-text-main); margin-bottom: 5px; }
        .cesta-info { font-size: 0.85rem; color: var(--cor-text-light); margin-bottom: 8px; }
        .cesta-price { font-size: 1.2rem; font-weight: 700; color: var(--cor-text-main); }
        
        .cesta-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn-card { 
            padding: 8px 16px; border-radius: 4px; font-weight: 500; font-size: 0.85rem; 
            border: 1px solid #ddd; background: white;
        }
        .btn-primary { border-color: var(--cor-primary); background: var(--cor-primary); color: white; }

        /* --- CARROSSEL DE PRODUTOS E ITENS DA CESTA --- */
        .products-carousel { 
            display: flex; 
            overflow-x: auto; 
            padding: 10px 20px 20px 20px; 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch; 
        }
        .products-carousel::-webkit-scrollbar { height: 4px; }
        .products-carousel::-webkit-scrollbar-track { background: #f1f1f1; }
        .products-carousel::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

        .prod-card { 
            flex: 0 0 150px; /* Largura do card */
            background: white;
            padding: 10px 15px 10px 0; 
            margin-right: 15px;
            border-right: 1px solid var(--cor-divider); 
            display: flex; flex-direction: column; 
            align-items: flex-start; 
            text-align: left;
            position: relative;
        }
        .prod-card:last-child { border-right: none; }
        .prod-card.active { background: #fff; } 
        .prod-card.esgotado { opacity: 0.5; }
        .prod-card.hidden { display: none !important; } 
        
        .prod-img-box { 
            width: 100%; height: 120px; /* Foto Grande */
            margin-bottom: 10px; 
            display: flex; align-items: center; justify-content: center; 
        }
        .prod-img { width: 100%; height: 100%; object-fit: contain; }
        
        .prod-name { 
            font-size: var(--font-size-name); /* Fonte menor */
            color: var(--cor-text-light); 
            font-weight: 500;
            line-height: 1.3; 
            margin-bottom: 5px; 
            height: 36px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        
        .prod-price { font-size: var(--font-size-price); font-weight: 700; color: var(--cor-text-main); margin-bottom: 10px; }
        
        .action-area { width: 100%; margin-top: auto; }
        .btn-add-simple { 
            width: 100%; padding: 8px; 
            background: white; border: 1px solid #ddd; color: #333; 
            border-radius: 4px; font-weight: 600; font-size: 0.8rem; 
        }
        .btn-add-simple:active { background: #eee; }
        
        .qty-control { display: flex; align-items: center; justify-content: space-between; border: 1px solid #ddd; border-radius: 4px; padding: 4px; width: 100%; }
        .btn-q { width: 24px; height: 24px; font-size: 1rem; display: grid; place-items: center; color: #555; }
        .val-q { font-weight: 600; font-size: 0.95rem; }

        /* --- BOT√ÉO FLUTUANTE (BARRA DA BASE) --- */
        .float-bar { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--cor-bar-bg); /* Cinza claro */
            border-top: 1px solid #ddd;
            padding: 15px 20px; 
            display: none; justify-content: space-between; align-items: center; 
            z-index: 90; 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }
        .total-lbl { font-size: 0.75rem; color: #888; text-transform: uppercase; }
        .total-val { font-size: 1.2rem; font-weight: 700; color: var(--cor-primary); }
        .btn-finish { 
            background: var(--cor-primary); color: white; 
            padding: 10px 25px; border-radius: 4px; 
            font-weight: 600; font-size: 0.95rem; 
        }
        .btn-finish:disabled { background: #ccc; }

        /* --- FILTRO / CATEGORIAS --- */
        .catalog-tools { 
            position: sticky; top: 60px; z-index: 95; 
            background: rgba(243, 244, 246, 0.98); /* Cinza claro com transpar√™ncia */
            padding: 10px 20px; 
            border-bottom: 1px solid var(--cor-divider);
        }
        .search-container { position: relative; margin-bottom: 10px; }
        .search-input { 
            width: 100%; padding: 10px 10px 10px 35px; 
            border-radius: 4px; border: 1px solid #ddd; 
            background: white; color: #333; outline: none; font-size: 0.95rem;
        }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        
        .cat-nav { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; }
        .cat-nav::-webkit-scrollbar { display: none; }
        .cat-chip { 
            white-space: nowrap; padding: 6px 0; 
            background: none; border: none;
            font-size: 0.9rem; font-weight: 500; color: #888; 
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .cat-chip:active, .cat-chip.active { color: var(--cor-text-main); border-color: var(--cor-text-main); font-weight: 700; }

        /* --- MODAIS E UTILIT√ÅRIOS --- */
        dialog { border: none; border-radius: 8px; padding: 0; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        dialog::backdrop { background: rgba(0,0,0,0.4); }
        .modal-head { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; background: #fafafa; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-size: 1rem; }
        
        /* Bot√£o Hist√≥rico na Home */
        .btn-history {
            width: calc(100% - 40px); margin: 10px 20px; 
            padding: 12px; background: white; border: 1px solid #ddd;
            font-size: 0.9rem; color: #555;
        }

        /* Toast */
        .status-toast { 
            display: none; position: fixed; top: 80px; left: 50%; transform: translateX(-50%); 
            background: #333; color: white; padding: 10px 20px; 
            border-radius: 4px; font-weight: 500; z-index: 200; font-size: 0.9rem;
        }
        
        dialog#zoom-modal { background: #fff; width: 100%; height: 100%; border-radius: 0; }
        .zoom-close { position: absolute; top: 10px; right: 10px; font-size: 2rem; padding: 10px; z-index: 10; background:none; }
        .zoom-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .zoom-img-full { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* Badge Oferta */
        .offer-badge {
            position: absolute; top: 0; left: 0; 
            background: var(--cor-accent); color: white; 
            font-size: 0.7rem; padding: 2px 6px; font-weight: 600;
            border-bottom-right-radius: 4px; z-index: 2;
        }

        /* Divis√≥ria da Cesta */
        .basket-separator {
            width: 100%; height: 10px; background: #f0f0f0; border-top: 1px solid #e5e5e5; border-bottom: 1px solid #e5e5e5; margin-bottom: 20px;
        }

        @media (min-width: 900px) {
            .grid-cestas { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
            .cesta-card { border: 1px solid #eee; border-radius: 8px; }
            .prod-card { flex: 0 0 170px; }
        }
    </style>
</head>
<body>

    <div id="status-toast" class="status-toast"></div>

    <div class="header-wrapper">
        <header>
            <div class="header-left">
                <button class="btn-back" id="btn-back" onclick="resetAndGoHome()">‚ùÆ</button>
                <img src="img/logo.webp" class="logo" alt="Logo">
                <div id="page-title" class="page-title">Super Cestas</div>
            </div>
            <button class="btn-help" onclick="document.getElementById('modal-faq').showModal()">?</button>
        </header>
    </div>

    <main id="main-content">
        
        <div id="view-home" class="view active">
            
            <div class="banner-rotativo-wrapper">
                <div class="banner-box">
                    <div id="banner-text" class="banner-text"></div>
                </div>
            </div>
            
            <div id="home-offers-section" style="display:none; margin-bottom: 20px;">
                <h3 class="section-header" style="color:var(--cor-accent);">üî• Ofertas do Dia</h3>
                <div class="carousel-container" id="home-offers-scroll-area">
                    <div class="scroll-indicator-right"><div class="arrow-icon">‚ùØ</div></div>
                    <div class="products-carousel" id="home-offers-list"></div>
                </div>
            </div>

            <button class="btn-history" onclick="showHistory()">Meus Pedidos Anteriores</button>

            <h2 class="section-header" style="color:#333;">Nossas Cestas</h2>
            <div class="grid-cestas" id="cestas-container">
                <p style="text-align:center; padding:40px; color:#999">Carregando cat√°logo...</p>
            </div>
        </div>

        <div id="view-catalogo" class="view">
            <div class="catalog-tools">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="search-input" placeholder="Buscar produto..." onkeyup="doSearch(this.value)">
                </div>
                <div class="cat-nav" id="cat-nav"></div>
            </div>
            <div id="catalog-content"></div>
        </div>
    </main>

    <div class="float-bar" id="cart-bar">
        <div class="total-info">
            <div class="total-lbl">Total Estimado</div>
            <div class="total-val" id="total-display">R$ 0,00</div>
        </div>
        <button class="btn-finish" id="btn-finish" onclick="openCheckout()">CONCLUIR PEDIDO</button>
    </div>

    <dialog id="modal-details">
        <div class="modal-head">
            <h3>Itens da Cesta</h3>
            <button onclick="document.getElementById('modal-details').close()" style="font-size:1.5rem;">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="detail-list"></div>
            <div style="padding:20px 0; text-align:center;">
                <button class="btn-finish" style="width:100%" onclick="orderDirect()">PEDIR ESSA CESTA</button>
            </div>
        </div>
    </dialog>

    <dialog id="modal-checkout">
        <div class="modal-head">
            <h3>Finalizar Pedido</h3>
            <button onclick="document.getElementById('modal-checkout').close()" style="font-size:1.5rem;">‚úï</button>
        </div>
        <div class="modal-body">
            <h4 style="margin-bottom:15px; color:#666; font-size:0.9rem;">ITENS DO PEDIDO</h4>
            <div id="checkout-list" style="margin-bottom:20px; font-size:0.9rem;"></div>
            
            <label style="display:block; margin-bottom:5px;">Cupom de Desconto</label>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="coupon-code" class="input-box" style="margin:0; text-transform:uppercase;" placeholder="C√ìDIGO">
                <button type="button" class="btn-finish" style="padding:0 20px; background:#333;" onclick="applyCoupon()">OK</button>
            </div>
            
            <div id="discount-display" style="display:none; justify-content:space-between; color:green; font-weight:bold; margin-bottom:10px;">
                <span>Desconto:</span>
                <span id="discount-value">- R$ 0,00</span>
            </div>

            <div style="background: #f9f9f9; padding: 20px; border-radius: 4px; text-align: center; margin-bottom: 25px; border:1px solid #eee;">
                <span style="display:block; font-size:0.8rem; color:#888; text-transform:uppercase;">Valor Total a Pagar</span>
                <span id="checkout-total" style="font-size:2rem; font-weight:700; color:var(--cor-accent);">R$ 0,00</span>
            </div>
            
           <form onsubmit="sendWhatsapp(event)">
            <label>Nome Completo</label><input type="text" id="cust-name" class="input-box" required placeholder="Seu nome">
            <label>CPF</label><input type="tel" id="cust-cpf" class="input-box" required placeholder="000.000.000-00" maxlength="14" oninput="mascaraCPF(this)">
            <label>WhatsApp</label><input type="tel" id="cust-phone" class="input-box" required placeholder="(65) 99999-9999" maxlength="15" oninput="mascaraTelefone(this)">
            <label>Endere√ßo de Entrega</label><input type="text" id="cust-addr" class="input-box" required placeholder="Rua, N√∫mero, Bairro">
            <label>Forma de Pagamento</label>
            <select id="cust-pay" class="input-box">
                <option>PIX (Na entrega)</option>
                <option>Dinheiro (Levar troco?)</option>
                <option>Cart√£o de Cr√©dito</option>
                <option>Cart√£o de D√©bito</option>
                <option>Cart√£o Alimenta√ß√£o</option>
                <option>Cart√£o Refei√ß√£o</option>
            </select>
            <p style="font-size:0.8rem; color:#666; text-align:center; margin-top:-10px; margin-bottom:20px;">
                üí≥ Parcelamos em at√© 3x sem juros no Cart√£o de Cr√©dito.
            </p>
            <button type="submit" class="btn-finish" style="width:100%;">ENVIAR PEDIDO</button>
        </form>
        </div>
    </dialog>

    <dialog id="modal-history">
        <div class="modal-head"><h3>Meus Pedidos</h3><button onclick="document.getElementById('modal-history').close()" style="font-size:1.5rem;">‚úï</button></div>
        <div class="modal-body" id="history-list">
            <p style="text-align:center; color:#999;">Voc√™ ainda n√£o tem pedidos salvos.</p>
        </div>
    </dialog>

    <dialog id="modal-faq">
        <div class="modal-head"><h3>Ajuda (FAQ)</h3><button onclick="document.getElementById('modal-faq').close()" style="font-size:1.5rem;">‚úï</button></div>
        <div class="modal-body">
            <details><summary>Entrega</summary><div class="ans" style="padding:10px; color:#666;">Realizamos entregas em toda Cuiab√° e V√°rzea Grande. Ap√≥s finalizar o pedido no site, voc√™ ser√° direcionado ao WhatsApp onde nossa equipe confirmar√° o endere√ßo e combinar√° o melhor hor√°rio para entrega.</div></details>
            <details><summary>Pagamento</summary><div class="ans" style="padding:10px; color:#666;">O pagamento √© feito exclusivamente na entrega. Aceitamos:<br>- PIX<br>- Dinheiro<br>- Cart√£o de Cr√©dito (at√© 3x sem juros)<br>- Cart√£o de D√©bito<br>- Cart√£o Alimenta√ß√£o e Refei√ß√£o.</div></details>
            <details><summary>Posso mudar itens?</summary><div class="ans" style="padding:10px; color:#666;">Sim! Ao escolher uma cesta, clique em "Personalizar". Voc√™ pode alterar as quantidades, remover itens que n√£o deseja (respeitando o limite m√≠nimo) e adicionar itens extras do nosso cat√°logo avulso.</div></details>
            <details><summary>Pedido M√≠nimo</summary><div class="ans" style="padding:10px; color:#666;">O valor m√≠nimo para fechar um pedido √© o pre√ßo base da Cesta B√°sica escolhida. Voc√™ n√£o pode remover itens a ponto de o valor ficar abaixo disso.</div></details>
            <details><summary>Produtos em Oferta</summary><div class="ans" style="padding:10px; color:#666;">Fique de olho na categoria "Ofertas" e nos banners da p√°gina inicial para aproveitar nossos descontos especiais.</div></details>
            <div style="text-align:center; margin-top:30px; padding-top:20px; border-top:1px dashed #ddd;">
                <p><strong>Super Cestas Dona Ant√¥nia</strong><br>CNPJ: 00.000.000/0001-00<br>Atendimento Online - Cuiab√° e VG<br><strong>(65) 98449-1018</strong><br><strong>(65) 99815-0975</strong></p>
                <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                    <a href="https://wa.me/5565984491018" style="padding:10px 20px; border-radius:20px; color:white; background:#25D366; text-decoration:none; font-weight:600;">WhatsApp</a>
                    <a href="#" style="padding:10px 20px; border-radius:20px; color:white; background:#E1306C; text-decoration:none; font-weight:600;">Instagram</a>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="zoom-modal">
        <button class="zoom-close" onclick="document.getElementById('zoom-modal').close()">‚úï</button>
        <div class="zoom-content"><img id="zoom-img" class="zoom-img-full"></div>
    </dialog>

    <script>
        const CONFIG = { whatsapp: "5565984491018", maxRemoval: 0.3 };
        const MAKE_WEBHOOK = "https://hook.eu1.make.com/yisqs4w309ogi6fx4969dbsr2q7fu7il"; 

        // FRASES DO BANNER ROTATIVO (F√°cil de alterar)
        const CONFIG_BANNERS_ROTATIVOS = [
            "Entrega Gr√°tis em Cuiab√° e VG",
            "Parcele em at√© 3x sem juros",
            "S√≥ pague na hora da entrega",
            "Aqui compensa comprar"
        ];

        const CONFIG_CUPONS = { "BEMVINDO": 5, "CLIENTEVIP": 10, "DONAANTONIA": 3 };

        // CORES PARA AS CATEGORIAS
        const CAT_COLORS = ["#E63946", "#2A9D8F", "#F4A261", "#264653", "#9C27B0", "#D81B60", "#Fbc02d"];

        const CONFIG_CATEGORIAS = {
            "Beb√™ e Infantil": ["FRALDA", "LENCO UMEDECIDO", "HUGGIES", "POMADA", "MUCILON"],
            "Cabelos": ["SHAMPOO", "CONDICIONADOR", "SEDA", "SKALA", "CREME", "PENTE"],
            "Higiene Pessoal": ["SABONETE", "DESODORANTE", "ABSORVENTE", "ALGODAO", "COTONETE", "GILETTE"],
            "Higiene Bucal": ["CREME DENTAL", "ESCOVA DENTAL", "FIO DENTAL", "COLGATE"],
            "Lavanderia": ["SABAO", "OMO", "YPE", "AMACIANTE", "Q BOA", "PRENDEDOR"],
            "Limpeza da Casa": ["DESINFETANTE", "VEJA", "DETERGENTE", "ESPONJA", "BOMBRIL", "PANO", "INSETICIDA", "VASSOURA", "SACO LIXO"],
            "Mercearia B√°sica": ["ARROZ", "FEIJAO", "ACUCAR", "OLEO", "MILHARINA", "CUZ CUZ", "FARINHA", "FUBA", "MILHO VERDE", "SARDINHA", "SAL"],
            "Massas e Molhos": ["MACARRAO", "EXTRATO", "MOLHO", "QUEIJO RALADO"],
             "Caf√© da Manh√£": ["CAFE", "FILTRO", "LEITE", "ACHOCOLATADO", "CEREAL", "AVEIA", "SUCO", "CHA", "ERVA TERERE"],            
            "Biscoitos e Lanches": ["BISCOITO", "BOLACHA", "WAFER", "TORRADA", "ROSQUINHA"],
            "Doces e Sobremesas": ["LEITE CONDENSADO", "CREME LEITE", "GELATINA", "BOLO", "MISTURA PRA BOLO", "CREME DE LEITE"],
            "Temperos": ["CALDO", "SAL", "TEMPERO", "PIMENTA", "MAIONESE", "KETCHUP", "VINAGRE"],
            "Cozinha": ["COPO", "PANELA", "DESCANSO DE PANELA", "PRATO", "GARFO", "FACA", "COLHER", "TABUA DE CARNE", "TALHER", "PAPEL ALUMINIO", "COPO", "PRATO", "TALHER", "TIGELA", "TRAVESSA", "CANECA", "PETISQUEIRA", "JARRA", "POTE", "CUMBUCA", "SOCADOR", "DESCASCADOR", "PENEIRA"],
            "Utilidades": ["LAMPADA", "PILHA", "FOSFORO", "RALO", "SUPORTE", "PREGO", "PARAFUSO", "VARAL", "PROTETOR DE RALO"],
            "Papelaria": ["CANETA", "LAPIS", "CADERNO", "BORRACHA", "APONTADOR", "CLIPS", "REGUA", "GRAMPEADOR", "GRAFITE", "LAPISEIRA", "LIVRO"]
        };
        const CATEGORIA_PADRAO = "Outros";

        let DB_PROD = [], DB_CESTAS = [], CART = {}, CURR_CESTA = null, ORIG_COUNTS = {}, ORIG_TOTAL = 0;
        let ACTIVE_COUPON = null;

        // SISTEMA DE BANNER ROTATIVO
        let bannerIdx = 0;
        function cycleBanner() {
            const el = document.getElementById('banner-text');
            el.style.opacity = 0;
            setTimeout(() => {
                el.innerText = CONFIG_BANNERS_ROTATIVOS[bannerIdx];
                el.style.opacity = 1;
                bannerIdx = (bannerIdx + 1) % CONFIG_BANNERS_ROTATIVOS.length;
            }, 500);
        }
        setInterval(cycleBanner, 3500); // Muda a cada 3.5 segundos

        function detectingCategory(nomeProduto) {
            if (!nomeProduto) return CATEGORIA_PADRAO;
            const nomeLimpo = nomeProduto.replace(/^OFERTA\s-\s/i, "").normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase();
            for (const [categoria, keywords] of Object.entries(CONFIG_CATEGORIAS)) {
                for (const keyword of keywords) {
                    if (nomeLimpo.includes(keyword.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase())) return categoria;
                }
            }
            return CATEGORIA_PADRAO;
        }

        async function init() {
            try {
                const cRes = await fetch('produtos-cesta-basica.json');
                if (cRes.ok) { DB_CESTAS = await cRes.json(); renderHome(); }
            } catch (e) { console.error(e); }

            try {
                const pRes = await fetch('produtos.json');
                if (pRes.ok) {
                    let text = await pRes.text();
                    text = text.trim().replace(/,(\s+)?$/, "");
                    if (!text.startsWith('[')) text = '[' + text;
                    if (!text.endsWith(']')) text = text + ']';
                    
                    const rawProd = JSON.parse(text);
                    DB_PROD = rawProd.filter(x => x && x.situacao === "A").map(x => {
                        const sId = String(x.id);
                        const sCodigo = x.codigo ? String(x.codigo) : sId;
                        return { 
                            id: sId, 
                            name: x.nome, 
                            price: parseFloat(x.preco), 
                            cat: detectingCategory(x.nome), 
                            stock: x.estoque || 0, 
                            img: `img/produtos/${sCodigo}.webp`
                        };
                    });
                    
                    renderHomeOffers();
                    cycleBanner(); // Inicia banner

                    const savedCestaId = localStorage.getItem('da_cesta_id');
                    const savedCart = localStorage.getItem('da_cart');
                    const savedOrig = localStorage.getItem('da_orig');
                    
                    if (savedCestaId && savedCart && DB_CESTAS.length > 0) {
                        const c = DB_CESTAS.find(x => x.id === savedCestaId);
                        if (c) {
                            CURR_CESTA = c;
                            CART = JSON.parse(savedCart);
                            ORIG_COUNTS = savedOrig ? JSON.parse(savedOrig) : {};
                            let t = 0; for(let k in ORIG_COUNTS) t += ORIG_COUNTS[k]; ORIG_TOTAL = t;
                            goToCatalogUI();
                        }
                    }
                }
            } catch (e) { console.error(e); }
        }

        function goToCatalogUI() {
            document.getElementById('view-home').classList.remove('active');
            document.getElementById('view-catalogo').classList.add('active');
            document.getElementById('btn-back').style.display = 'block';
            document.getElementById('cart-bar').style.display = 'flex';
            document.getElementById('page-title').innerText = CURR_CESTA.nome;
            renderCatalog();
            updateTotals();
        }

        function saveState() {
            if (CURR_CESTA) {
                localStorage.setItem('da_cesta_id', CURR_CESTA.id);
                localStorage.setItem('da_cart', JSON.stringify(CART));
                localStorage.setItem('da_orig', JSON.stringify(ORIG_COUNTS));
            }
        }

        function resetAndGoHome() {
            if(confirm("Voltar ao in√≠cio limpar√° seu carrinho. Continuar?")) {
                localStorage.removeItem('da_cesta_id'); localStorage.removeItem('da_cart'); localStorage.removeItem('da_orig');
                CART = {}; CURR_CESTA = null; ORIG_COUNTS = {}; ACTIVE_COUPON = null;
                document.getElementById('view-home').classList.add('active');
                document.getElementById('view-catalogo').classList.remove('active');
                document.getElementById('btn-back').style.display = 'none';
                document.getElementById('cart-bar').style.display = 'none';
                document.getElementById('page-title').innerText = "Super Cestas";
            }
        }

        function goCatalog(id) {
            if (DB_PROD.length === 0) { showToast("Aguarde, carregando produtos..."); init(); return; }
            window.scrollTo(0,0);
            CURR_CESTA = DB_CESTAS.find(c => c.id === id);
            CART = {}; ORIG_COUNTS = {}; ORIG_TOTAL = 0; ACTIVE_COUPON = null;
            
            CURR_CESTA.produtos.forEach(s => {
                const parts = s.split('x '); 
                if(parts.length >= 2) {
                    const iq = parseInt(parts[0]);
                    const cid = parts[1].trim();
                    if(DB_PROD.find(x => x.id === cid)) {
                        CART[cid] = iq; ORIG_COUNTS[cid] = iq; ORIG_TOTAL += iq;
                    }
                }
            });
            saveState();
            goToCatalogUI();
        }

        function renderHome() {
            const div = document.getElementById('cestas-container');
            div.innerHTML = "";
            const ph = svgPlace();
            DB_CESTAS.forEach(c => {
                const img = (c.imagem && c.imagem !== "") ? c.imagem : ph;
                div.innerHTML += `
                <div class="cesta-card">
                    <div class="cesta-img-wrap"><img src="${img}" class="cesta-img" loading="lazy"></div>
                    <div class="cesta-content">
                        <div class="cesta-name">${c.nome}</div>
                        <span class="cesta-info">${c.produtos.length} Itens</span>
                        <div class="cesta-price">${fmt(c.preco)}</div>
                        <div class="cesta-actions">
                            <button class="btn-card" onclick="details('${c.id}')">Ver Itens</button>
                            <button class="btn-card btn-primary" onclick="goCatalog('${c.id}')">Personalizar</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function renderHomeOffers() {
            const container = document.getElementById('home-offers-section');
            const list = document.getElementById('home-offers-list');
            const offers = DB_PROD.filter(p => p.name.toUpperCase().startsWith("OFERTA -"));
            
            if (offers.length === 0) { container.style.display = 'none'; return; }

            container.style.display = 'block';
            list.innerHTML = "";
            
            const scrollArea = document.getElementById('home-offers-scroll-area');
            const arrow = scrollArea.querySelector('.scroll-indicator-right');
            scrollArea.querySelector('.products-carousel').addEventListener('scroll', function() {
                if(this.scrollLeft > 10) arrow.classList.add('faded'); else arrow.classList.remove('faded');
            });

            offers.forEach(p => {
                const img = p.img || svgPlace();
                list.innerHTML += `
                <div class="prod-card">
                    <div class="offer-badge">OFERTA</div>
                    <div class="prod-img-box"><img src="${img}" class="prod-img" loading="lazy"></div>
                    <div class="prod-price" style="color:var(--cor-accent)">${fmt(p.price)}</div>
                    <div class="prod-name">${p.name}</div>
                    <div class="action-area"><button class="btn-add-simple" onclick="warnNoBasket()">ADICIONAR</button></div>
                </div>`;
            });
        }

        function warnNoBasket() { showToast("Primeiro escolha uma Cesta B√°sica para personalizar."); }

        function renderCatalog() {
            const div = document.getElementById('catalog-content');
            const navDiv = document.getElementById('cat-nav');
            div.innerHTML = ""; navDiv.innerHTML = "";
            
            // 1. √Årea: Itens da Cesta (Estilo ID√äNTICO aos produtos)
            let html = `<div style="padding:0;">
                <h3 class="section-header" style="color:#333;">Itens da Cesta</h3>
                <div class="carousel-container">
                    <div class="scroll-indicator-right"><div class="arrow-icon">‚ùØ</div></div>
                    <div class="products-carousel" onscroll="checkArrow(this)">`;
            
            Object.keys(ORIG_COUNTS).forEach(id => {
                const p = DB_PROD.find(x => x.id === id);
                if(!p) return;
                html += buildProductCard(p); // Reusa exatamente o mesmo card
            });
            html += `</div></div></div>`;
            html += `<div class="basket-separator"></div>`; // Linha Separadora

            // 2. Ofertas
            const offers = DB_PROD.filter(p => p.name.toUpperCase().startsWith("OFERTA -"));
            if (offers.length > 0) {
                const safeId = 'cat-offers';
                navDiv.innerHTML += `<button class="cat-chip" onclick="scrollToCat('${safeId}')" style="color:var(--cor-accent)">üî• OFERTAS</button>`;
                html += `<div id="${safeId}" class="cat-section">
                         <h3 class="section-header" style="color:var(--cor-accent)">üî• Ofertas Especiais</h3>
                         <div class="carousel-container">
                            <div class="scroll-indicator-right"><div class="arrow-icon">‚ùØ</div></div>
                            <div class="products-carousel" onscroll="checkArrow(this)">`;
                offers.forEach(p => html += buildProductCard(p));
                html += `</div></div></div>`;
            }

            // 3. Categorias
            const cats = {};
            DB_PROD.forEach(p => { if(!cats[p.cat]) cats[p.cat] = []; cats[p.cat].push(p); });
            const sortedKeys = Object.keys(cats).sort();

            sortedKeys.forEach((c, index) => {
                if (c === CATEGORIA_PADRAO && cats[c].length === 0) return;
                const safeId = `cat-${index}`;
                navDiv.innerHTML += `<button class="cat-chip" onclick="scrollToCat('${safeId}')">${c}</button>`;
                
                // Cor do T√≠tulo
                const titleColor = CAT_COLORS[index % CAT_COLORS.length];

                html += `<div id="${safeId}" class="cat-section">
                         <h3 class="section-header" style="color:${titleColor}">${c}</h3>
                         <div class="carousel-container">
                             <div class="scroll-indicator-right"><div class="arrow-icon">‚ùØ</div></div>
                             <div class="products-carousel" onscroll="checkArrow(this)">`;
                cats[c].forEach(p => html += buildProductCard(p));
                html += `</div></div></div>`; 
            });
            div.innerHTML = html;
        }

        function checkArrow(el) {
            const arrow = el.parentElement.querySelector('.scroll-indicator-right');
            if(el.scrollLeft > 10) arrow.classList.add('faded'); else arrow.classList.remove('faded');
        }

        function buildProductCard(p) {
            const q = CART[p.id] || 0;
            const semEstoque = p.stock <= 0;
            const isOffer = p.name.toUpperCase().startsWith("OFERTA -");
            const imgSrc = p.img || svgPlace();
            
            let btnHtml = "";
            if (semEstoque && q === 0) btnHtml = `<button class="btn-add-simple" style="background:#eee; color:#aaa;" disabled>ESGOTADO</button>`;
            else if (q > 0) btnHtml = `<div class="qty-control"><button class="btn-q" onclick="upd('${p.id}', -1)">-</button><span class="val-q" id="qty-${p.id}">${q}</span><button class="btn-q" onclick="upd('${p.id}', 1)">+</button></div>`;
            else btnHtml = `<button class="btn-add-simple" onclick="upd('${p.id}', 1)">ADICIONAR</button>`;

            return `
            <div class="prod-card prod-search-item ${q>0?'active':''}" id="card-${p.id}" data-name="${p.name.toLowerCase()}">
                ${isOffer ? '<div class="offer-badge">OFERTA</div>' : ''}
                <div class="prod-img-box"><img src="${imgSrc}" class="prod-img" loading="lazy" onclick="zoom('${imgSrc}')"></div>
                <div class="prod-name">${p.name}</div>
                <div class="prod-price">${fmt(p.price)}</div>
                <div class="action-area" id="act-${p.id}">${btnHtml}</div>
            </div>`;
        }

        function applyCoupon() {
            const code = document.getElementById('coupon-code').value.trim().toUpperCase();
            if (CONFIG_CUPONS[code]) {
                ACTIVE_COUPON = { code: code, percent: CONFIG_CUPONS[code] };
                showToast(`Cupom ${code} aplicado!`);
            } else {
                ACTIVE_COUPON = null;
                showToast("Cupom inv√°lido.");
            }
            updateTotals();
        }

        function showHistory() {
            const hist = JSON.parse(localStorage.getItem('da_history') || '[]');
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            if (hist.length === 0) list.innerHTML = "<p style='text-align:center;color:#999'>Vazio.</p>";
            else hist.reverse().forEach(o => {
                list.innerHTML += `<div style="border:1px solid #eee; padding:10px; margin-bottom:10px; border-radius:4px;">
                    <div>${o.date} - ${o.basketName}</div>
                    <div style="font-weight:bold">${fmt(o.total)}</div>
                    <button style="margin-top:5px; color:blue; font-size:0.8rem;" onclick='reorder(${JSON.stringify(o)})'>REPETIR</button>
                </div>`;
            });
            document.getElementById('modal-history').showModal();
        }

        function reorder(o) {
            const c = DB_CESTAS.find(x => x.nome === o.basketName);
            if (!c) return alert("Cesta n√£o existe mais.");
            if(!confirm("Limpar carrinho atual?")) return;
            CART = o.cart; ORIG_COUNTS = o.orig || {}; CURR_CESTA = c;
            let t=0; for(let k in ORIG_COUNTS) t+=ORIG_COUNTS[k]; ORIG_TOTAL=t;
            saveState(); document.getElementById('modal-history').close(); goToCatalogUI();
        }

        function doSearch(t) {
            t = t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            document.querySelectorAll('.prod-search-item').forEach(el => {
                const n = el.getAttribute('data-name').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                if (n.includes(t)) el.classList.remove('hidden'); else el.classList.add('hidden');
            });
            document.querySelectorAll('.cat-section').forEach(sec => {
                sec.style.display = sec.querySelectorAll('.prod-search-item:not(.hidden)').length > 0 ? 'block' : 'none';
            });
        }

        function scrollToCat(id) {
            const el = document.getElementById(id);
            if(el) { window.scrollTo({top: el.offsetTop - 120, behavior: 'smooth'}); }
        }

        function upd(id, d) {
            const p = DB_PROD.find(x => x.id === id);
            if (p && p.stock <= 0 && d > 0) return showToast("Esgotado.");
            if(!CART[id]) CART[id] = 0;
            const nq = CART[id] + d;
            
            if (d < 0 && ORIG_COUNTS[id]) {
                let co = 0; for(let k in CART) if(ORIG_COUNTS[k]) co += Math.min(k===id ? nq : CART[k], ORIG_COUNTS[k]);
                if (co < Math.ceil(ORIG_TOTAL * (1 - CONFIG.maxRemoval))) return showToast("Limite de remo√ß√£o atingido.");
            }
            if(nq < 0) return;
            CART[id] = nq;
            saveState(); renderCatalog(); updateTotals();
        }

        function updateTotals() {
            let u=0, o=0;
            for(let k in CART) u += (DB_PROD.find(x=>x.id===k)?.price||0) * CART[k];
            for(let k in ORIG_COUNTS) o += (DB_PROD.find(x=>x.id===k)?.price||0) * ORIG_COUNTS[k];
            let t = CURR_CESTA.preco + (u - o);
            window.finalTotal = t;
            document.getElementById('total-display').innerText = fmt(t);
            const btn = document.getElementById('btn-finish');
            if(t < CURR_CESTA.preco) { btn.innerText = `M√≠nimo: ${fmt(CURR_CESTA.preco)}`; btn.disabled = true; }
            else { btn.innerText = "CONCLUIR PEDIDO"; btn.disabled = false; }
        }

        function details(id) {
            window.viewId = id;
            const c = DB_CESTAS.find(x => x.id === id);
            const d = document.getElementById('detail-list'); d.innerHTML = "";
            c.produtos.forEach(s => {
                const parts = s.split('x ');
                if(parts.length>=2) {
                    const p = DB_PROD.find(x => x.id === parts[1].trim());
                    d.innerHTML += `<div style="border-bottom:1px solid #eee; padding:8px 0;">${parts[0]}x ${p?p.name:'Item '+parts[1]}</div>`;
                }
            });
            document.getElementById('modal-details').showModal();
        }

        function openCheckout() {
            ACTIVE_COUPON = null; document.getElementById('coupon-code').value = "";
            document.getElementById('discount-display').style.display='none';
            const t = window.finalTotal;
            document.getElementById('checkout-total').innerText = fmt(t);
            
            const l = document.getElementById('checkout-list'); l.innerHTML = "";
            for(let k in CART) if(CART[k]>0) {
                const p = DB_PROD.find(x=>x.id===k);
                // "2un Arroz..."
                l.innerHTML += `<div style="border-bottom:1px dashed #eee; padding:5px 0;">${CART[k]}un ${p.name}</div>`;
            }
            document.getElementById('modal-checkout').showModal();
        }

        async function sendWhatsapp(e) {
            e.preventDefault();
            const n=document.getElementById('cust-name').value, cpf=document.getElementById('cust-cpf').value,
                  ph=document.getElementById('cust-phone').value, ad=document.getElementById('cust-addr').value,
                  pay=document.getElementById('cust-pay').value;

            let total = window.finalTotal;
            if(ACTIVE_COUPON) total -= (total * ACTIVE_COUPON.percent / 100);

            const itens = [];
            let msg = `*PEDIDO: ${CURR_CESTA.nome}*\nüë§ ${n}\nüìÑ ${cpf}\nüì± ${ph}\nüìç ${ad}\nüí∞ ${pay}\n\n*ITENS:*\n`;
            for(let k in CART) if(CART[k]>0) {
                const p = DB_PROD.find(x=>x.id===k);
                msg += `${CART[k]}x ${p.name}\n`;
                itens.push({id:k, nome:p.name, qtd:CART[k], val:p.price});
            }
            if(ACTIVE_COUPON) msg += `\nCUPOM: ${ACTIVE_COUPON.code}`;
            msg += `\n*TOTAL: ${fmt(total)}*`;

            const hist = JSON.parse(localStorage.getItem('da_history')||'[]');
            hist.push({date:new Date().toLocaleDateString(), total:total, basketName:CURR_CESTA.nome, cart:CART, orig:ORIG_COUNTS});
            localStorage.setItem('da_history', JSON.stringify(hist));
            localStorage.removeItem('da_cesta_id'); localStorage.removeItem('da_cart'); localStorage.removeItem('da_orig');

            try {
                fetch(MAKE_WEBHOOK, { method:"POST", headers:{"Content-Type":"application/json"}, 
                    body:JSON.stringify({cliente:{nome:n,cpf:cpf,cel:ph,end:ad}, pedido:{itens:itens, total:total, cesta:CURR_CESTA.nome}}) 
                });
            } catch(e){}

            setTimeout(() => window.location.href=`https://wa.me/${CONFIG.whatsapp}?text=${encodeURIComponent(msg)}`, 500);
        }

        function orderDirect() {
            const c = DB_CESTAS.find(x => x.id === window.viewId);
            window.location.href = `https://wa.me/${CONFIG.whatsapp}?text=${encodeURIComponent("Quero pedir a " + c.nome + " por " + fmt(c.preco))}`;
        }

        function fmt(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        function showToast(m) { const t=document.getElementById('status-toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
        function svgPlace() { return "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIiBmaWxsPSIjRjZGNkY2Ij48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIvPjwvc3ZnPg=="; }
        function zoom(src) { document.getElementById('zoom-img').src = src; document.getElementById('zoom-modal').showModal(); }
        function mascaraTelefone(o) { let v=o.value.replace(/\D/g,"");v=v.replace(/^(\d{2})(\d)/g,"($1) $2");v=v.replace(/(\d)(\d{4})$/,"$1-$2");o.value=v.substring(0,15); }
        function mascaraCPF(o) { let v=o.value.replace(/\D/g,"");v=v.replace(/(\d{3})(\d)/,"$1.$2");v=v.replace(/(\d{3})(\d)/,"$1.$2");v=v.replace(/(\d{3})(\d{1,2})$/,"$1-$2");o.value=v.substring(0,14); }

        init();
    </script>
</body>
</html>
