<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Super Cestas B√°sicas Dona Ant√¥nia - Cestas de qualidade e pre√ßo justo em Cuiab√° e V√°rzea Grande. Encomende online agora!">
    
    <meta name="geo.region" content="BR-MT" />
    <meta name="geo.placename" content="Cuiab√°" />
    <meta name="theme-color" content="#0F172A"> 
    <title>Super Cestas B√°sicas Dona Ant√¥nia</title>

    <style>
        /* --- DESIGN SYSTEM OTIMIZADO (PERFORMANCE & ACESSIBILIDADE) --- */
        :root {
            --cor-primary: #0F172A;
            --cor-action: #FF6D00;
            --cor-success: #008037; 
            --cor-warning: #FFAB00;
            --cor-danger: #D32F2F; 
            --cor-bg: #F1F5F9;
            --cor-surface: #FFFFFF; 
            --cor-text-main: #1E293B;
            --cor-text-light: #64748B;
            --cor-divider: #E2E8F0;
            
            --font-stack: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            --radius-md: 8px;
            --shadow-soft: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Reset & Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline-color: var(--cor-action); }
        
        body {
            font-family: var(--font-stack);
            background-color: #F1F5F9; 
            color: var(--cor-text-main);
            margin: 0;
            padding-bottom: 100px;
            font-size: 16px; 
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden; 
            width: 100%;
        }

        /* Container Limitador para Desktop */
        .limit-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            width: 100%;
        }

        h1, h2, h3 { margin: 0; font-weight: 700; color: var(--cor-primary); letter-spacing: -0.02em; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; font-weight: 600; }
        
        button:focus-visible, input:focus-visible, select:focus-visible {
            outline: 3px solid var(--cor-action);
            outline-offset: 2px;
        }

        /* --- HEADER --- */
        .header-wrapper {
            position: sticky; top: 0; z-index: 1000;
            background: var(--cor-primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            width: 100%;
        }

        header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 24px; /* Aumentado o padding para n√£o encostar */
            min-height: 70px;
            width: 100%;
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .logo { width: 44px; height: 44px; border-radius: 50%; border: 2px solid white; object-fit: cover; flex-shrink: 0; }
        
        .page-title { 
            font-size: 1rem; font-weight: 700; color: white; 
            white-space: normal; /* Permite quebra de linha */
            line-height: 1.2;
            overflow: visible;
        }
        
        .btn-whatsapp-header {
            background: #25D366; color: white;
            border-radius: 50%; padding: 0; 
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; /* Bot√£o maior */
            font-size: 0.85rem; font-weight: 700;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
            margin-left: 10px;
        }

        /* --- STICKY BARS --- */
        /* Ajustado para colar abaixo do header */
        .sticky-stack { 
            position: sticky; 
            top: 70px; /* Altura aproximada do header */
            z-index: 999; 
            width: 100%; 
            background: var(--cor-bg); 
            padding-top: 10px; /* Espa√ßo visual */
        }

        /* Balance Bar removido daqui para limpar o topo */
        
        .search-container {
            padding: 12px 16px;
            background: var(--cor-bg);
            display: none;
            border-bottom: 1px solid var(--cor-divider);
        }
        .search-box {
            width: 100%; padding: 14px 16px;
            padding-right: 40px; /* Espa√ßo para o bot√£o X */
            border: 1px solid var(--cor-divider); border-radius: var(--radius-md);
            background: white;
            font-size: 1rem; color: var(--cor-text-main);
            box-shadow: var(--shadow-soft);
        }

        .btn-clear-search {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1.1rem;
            padding: 5px;
            display: none; /* Oculto por padr√£o */
            z-index: 10;
        }
        .btn-clear-search:hover { color: var(--cor-danger); }

        /* FILTROS (CHIPS) */
        .filters-container {
            padding: 0 16px 12px;
            background: var(--cor-bg);
            border-bottom: 1px solid var(--cor-divider);
            display: none; 
            gap: 8px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .filters-container::-webkit-scrollbar { display: none; }
        
        .filter-chip {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid #CBD5E1;
            background: white;
            font-size: 0.85rem;
            color: var(--cor-text-light);
            font-weight: 600;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .filter-chip:active { transform: scale(0.95); }
        .filter-chip.active {
            background: var(--cor-primary);
            color: white;
            border-color: var(--cor-primary);
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.2);
        }

        /* --- LAYOUT --- */
        .view { display: none; padding-bottom: 20px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- HOME HERO --- */
        .hero-section {
            background: white; padding: 20px 20px; text-align: center;
            border-bottom: 1px solid var(--cor-divider); margin-bottom: 20px;
        }
        .hero-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .hero-banner-mini {
            background: #E0F2F1;
            color: #00695C;
            padding: 12px 8px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            line-height: 1.2;
            box-shadow: var(--shadow-soft);
        }
        .hero-banner-mini strong { font-size: 0.9rem; font-weight: 800; display: block; margin-bottom: 4px; }
        .hero-banner-mini span { font-size: 0.8rem; }
        
        .hero-title { font-size: 1.4rem; margin-bottom: 8px; color: var(--cor-primary); line-height: 1.2; font-weight: 800; }
        .hero-subtitle { font-size: 0.9rem; color: var(--cor-text-light); margin-bottom: 5px; }
        .hero-tag { 
            display: inline-block; background: #E0F2F1; color: #00695C; 
            padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; margin-top: 5px;
        }

        /* --- CARDS CESTA --- */
        .grid-cestas { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 0 20px 20px; }
        .cesta-card { 
            background: white; border-radius: var(--radius-md); overflow: hidden;
            box-shadow: var(--shadow-soft); border: 1px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex; flex-direction: column;
        }
        .cesta-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .cesta-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
        .cesta-content { padding: 16px; flex: 1; display: flex; flex-direction: column; }
        .cesta-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; color: var(--cor-primary); }
        .cesta-price { font-size: 1.4rem; font-weight: 800; color: var(--cor-action); margin-top: 5px; margin-bottom: 10px; }
        
        .cesta-actions { margin-top: auto; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .btn-choose {
            width: 100%; padding: 10px 5px;
            background: var(--cor-primary); color: white;
            border-radius: 6px; font-size: 0.8rem; text-transform: uppercase;
            font-weight: 700;
        }
        .btn-choose.outline { background: white; border: 1px solid var(--cor-primary); color: var(--cor-primary); }

        /* Card Monte do Zero */
        .card-zero {
            background: linear-gradient(135deg, #0F172A 0%, #1E293B 100%);
            color: white;
            padding: 20px;
            margin: 0 20px 30px;
            border-radius: var(--radius-md);
            text-align: center;
            box-shadow: 0 4px 15px rgba(15, 23, 42, 0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .card-zero:active { transform: scale(0.98); }
        .card-zero h3 { color: white; margin-bottom: 5px; font-size: 1.3rem; }
        .card-zero p { color: #CBD5E1; font-size: 0.9rem; margin-bottom: 15px; }
        .btn-zero-action {
            background: var(--cor-action); color: white; border: none;
            padding: 10px 20px; border-radius: 6px; font-weight: 700;
            text-transform: uppercase; font-size: 0.9rem;
        }

        /* --- TITULOS E LISTA --- */
        .intro-title-custom {
            padding: 20px;
            background: #E0F2F1; color: #00695C;
            border: 2px solid #00695C;
            border-radius: 8px;
            font-size: 1.1rem; font-weight: 700;
            line-height: 1.4;
            margin: 10px 20px 20px;
            text-align: center;
            box-shadow: var(--shadow-soft);
        }
        
        .section-separator {
            margin: 20px 20px 10px;
            padding-top: 15px;
            border-top: 2px dashed #CBD5E1;
        }
        .separator-title {
            font-size: 1.1rem; color: var(--cor-primary); font-weight: 800;
        }
        .separator-sub { font-size: 0.9rem; color: var(--cor-text-light); }

        /* --- LISTA BASE --- */
        .basket-base-list { background: white; padding: 16px; margin-bottom: 20px; box-shadow: var(--shadow-soft); }
        
        .list-header-row {
            display: flex; justify-content: space-between; 
            font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase;
            margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #f1f5f9;
        }

        .base-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--cor-divider);
        }
        .base-item-name { font-size: 0.95rem; font-weight: 600; color: var(--cor-text-main); flex: 1; padding-right: 10px; }
        
        .qty-control {
            display: flex; align-items: center; gap: 8px;
            background: #F1F5F9; padding: 4px; border-radius: 24px;
            border: 1px solid #E2E8F0;
        }
        .btn-q { 
            width: 32px; height: 32px; border-radius: 50%;
            background: white; color: var(--cor-primary); 
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .val-q { font-weight: 700; font-size: 1rem; min-width: 24px; text-align: center; }

        /* --- CARROSSEL --- */
        .carousel-container { margin-bottom: 30px; background: white; padding-bottom: 15px; border-top: 1px solid var(--cor-divider); position: relative; }
        .carousel-header { 
            padding: 15px 20px 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .carousel-title { font-size: 1.1rem; font-weight: 700; color: var(--cor-primary); }
        
        .carousel-track {
            display: flex; overflow-x: auto; padding: 0 20px 10px; gap: 12px;
            scroll-snap-type: x mandatory; 
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }
        .carousel-track::-webkit-scrollbar { display: none; }

        .prod-card {
            flex: 0 0 160px; scroll-snap-align: start;
            background: white; border: 1px solid var(--cor-divider); border-radius: var(--radius-md);
            padding: 10px; display: flex; flex-direction: column;
            position: relative;
        }
        .prod-card.disabled { opacity: 0.8; }

        .prod-img { 
            width: 100%; aspect-ratio: 1; object-fit: contain; 
            margin-bottom: 10px; background: white;
        }
        
        .prod-name { 
            font-size: 0.75rem; 
            line-height: 1.3; height: 3.9em; 
            overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
            color: var(--cor-text-main); margin-bottom: 8px;
            text-transform: uppercase;
        }
        .prod-price { font-size: 1rem; font-weight: 800; color: var(--cor-action); margin-top: auto; }
        
        .carousel-arrow {
            display: none; position: absolute; top: 55%; transform: translateY(-50%);
            width: 40px; height: 40px; background: white; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;
            align-items: center; justify-content: center; font-size: 1.2rem;
            cursor: pointer; color: var(--cor-primary);
            border: 1px solid #eee;
        }
        .carousel-arrow:hover { background: #f8f8f8; }
        .arrow-left { left: 10px; }
        .arrow-right { right: 10px; }

        /* --- BOTOES E A√áOES --- */
        .btn-main-action {
            width: 100%; padding: 12px 16px; border-radius: var(--radius-md);
            background: var(--cor-action); color: white; font-weight: 700;
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.2s;
            height: 48px; display: flex; align-items: center; justify-content: center;
        }
        .btn-main-action:active { background: #E65100; transform: scale(0.98); }
        
        .checkout-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 10px 16px; z-index: 1001; 
            display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 10px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        .btn-scroll-top {
            position: fixed; bottom: 85px; right: 20px;
            width: 40px; height: 40px; background: var(--cor-primary); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 998;
            font-size: 1.5rem; cursor: pointer; border: 2px solid white;
            display: none;
        }
        
        .btn-mini-diff {
             background: white; border: 1px solid #CBD5E1; border-radius: 8px;
             width: 48px; height: 48px; color: var(--cor-text-main); font-size: 1.4rem;
             cursor: pointer; display: flex; align-items: center; justify-content: center;
             box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-mini-diff:active { background: #f1f5f9; transform: scale(0.95); }

        /* --- MODAIS --- */
        dialog { 
            border: none; border-radius: 16px; width: 90%; max-width: 400px; 
            padding: 0; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            background: white;
        }
        dialog:not([open]) { display: none; }
        dialog::backdrop { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); }
        
        .modal-body { padding: 24px; text-align: center; }
        .modal-title { font-size: 1.25rem; margin-bottom: 12px; color: var(--cor-primary); font-weight: 800; }
        .modal-text { color: var(--cor-text-light); margin-bottom: 24px; line-height: 1.5; }
        
        .btn-modal { width: 100%; padding: 14px; border-radius: 8px; font-weight: 700; margin-bottom: 10px; font-size: 0.95rem; }
        .btn-modal.primary { background: var(--cor-success); color: white; }
        .btn-modal.secondary { background: white; border: 2px solid var(--cor-action); color: var(--cor-action); }
        .btn-modal.ghost { color: var(--cor-text-light); font-weight: 400; margin-top: 10px; }

        /* Desktop Adjustments */
        @media (min-width: 900px) {
            .grid-cestas { grid-template-columns: repeat(3, 1fr); }
            .prod-card { flex: 0 0 180px; }
            .checkout-bar { 
                max-width: 1200px; 
                left: 50%; transform: translateX(-50%); 
            }
            .carousel-track::-webkit-scrollbar { 
                display: block; height: 8px; 
            }
            .carousel-track::-webkit-scrollbar-thumb {
                background: #ccc; border-radius: 4px;
            }
            .carousel-arrow { display: flex; }
        }
    </style>
</head>
<body>

    <div class="header-wrapper" id="header-wrapper">
        <header class="limit-container">
            <div class="header-left">
                <button onclick="goHome()" id="btn-back-home" style="color:white; font-size:1.4rem; padding:5px; line-height:1; display:none; margin-right:5px" aria-label="Voltar">‚ùÆ</button>
                
                <img src="img/logo.webp" class="logo" alt="Logo Dona Ant√¥nia" width="44" height="44">
                <div class="page-title">Super Cestas<br>Dona Ant√¥nia</div>
            </div>
            <a href="https://wa.me/5565996813588" target="_blank" class="btn-whatsapp-header" aria-label="Falar no WhatsApp">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.005 2.01C6.533 2.01 2.083 6.46 2.083 11.929C2.083 13.799 2.607 15.617 3.6 17.193L2.83 21.239L6.965 20.465C8.496 21.373 10.232 21.848 12.005 21.848C17.476 21.848 21.926 17.398 21.926 11.929C21.926 9.281 20.894 6.79 19.02 4.916C17.146 3.042 14.655 2.01 12.005 2.01ZM17.472 14.382C17.394 14.77 17.63 14.829 17.718 14.976C17.806 15.123 17.806 15.771 17.536 16.538C17.266 17.304 15.965 17.998 15.334 18.092C14.764 18.177 14.047 18.206 13.266 17.957C12.756 17.795 12.102 17.579 11.264 17.217C7.742 15.696 5.443 12.15 5.267 11.914C5.09 11.678 3.824 9.998 3.824 6.52 4.737 5.665 5.061 5.311C5.385 4.957 5.768 4.869 6.004 4.869C6.239 4.869 6.475 4.869 6.681 4.869C6.887 4.869 7.181 4.78 7.476 5.488C7.77 6.195 8.477 7.934 8.566 8.111C8.654 8.288 8.713 8.494 8.595 8.729C8.478 8.965 8.419 9.112 8.242 9.318C8.065 9.524 7.87 9.779 7.711 9.939C7.534 10.115 7.35 10.306 7.556 10.659C7.762 11.013 8.479 12.182 9.541 13.129C10.89 14.332 12.028 14.706 12.381 14.882C12.734 15.059 12.94 15.03 13.146 14.794C13.352 14.558 14.029 13.763 14.265 13.409C14.501 13.055 14.737 13.114 15.061 13.232C15.385 13.35 17.119 14.205 17.472 14.382Z"/>
                    </svg>
                </a>
            </div>
        </div>

        <main class="limit-container">
        <div id="view-home" class="view active">
            <div class="hero-section">
                <div class="hero-grid">
                    <div class="hero-banner-mini">
                        <strong>Entrega Gr√°tis</strong>
                        <span>em Cuiab√° e VG</span>
                    </div>
                    <div class="hero-banner-mini">
                        <strong>Pague somente</strong>
                        <span>na entrega</span>
                    </div>
                </div>
            </div>
            
            <div id="home-offers-container"></div>

            <div class="card-zero" onclick="startZeroBuild()">
                <h3>Montar Cesta do Zero</h3>
                <p>Escolha item por item livremente</p>
                <button class="btn-zero-action">Come√ßar Vazia</button>
            </div>

            <h3 style="margin: 0 20px 15px; font-size: 1.1rem;">Ou escolha uma Cesta Pronta:</h3>
            <div class="grid-cestas" id="cestas-list">
                <p style="text-align:center; padding: 20px;">Carregando cestas...</p>
            </div>
        </div>

        <div id="view-custom" class="view">
            <div id="custom-intro-text"></div>

            <div class="basket-base-list" id="basket-base-list"></div>
            
            <div class="section-separator">
                <h3 class="separator-title" id="sep-title">Agora fique a vontade para repor o que quiser.</h3>
                <p class="separator-sub">Boas Compras!</p>
            </div>

            <div class="sticky-stack">
                <div id="search-container" class="search-container">
                    <div class="limit-container" style="position:relative">
                        <input type="text" id="search-input" class="search-box" placeholder="üîç Buscar produto (ex: arroz, sab√£o)..." aria-label="Buscar produtos" oninput="renderCatalogo()">
                        <button class="btn-clear-search" id="btn-clear-search" onclick="clearSearch()">‚úï</button>
                    </div>
                </div>
                
                <div id="filters-container" class="filters-container">
                    <div class="limit-container" style="display:flex; gap:8px;">
                        <button class="filter-chip active" onclick="setSort('name')" id="sort-name">A-Z</button>
                        <button class="filter-chip" onclick="setSort('price_asc')" id="sort-price_asc">Menor Pre√ßo</button>
                        <button class="filter-chip" onclick="setSort('price_desc')" id="sort-price_desc">Maior Pre√ßo</button>
                    </div>
                </div>
            </div>

            <div id="catalogo-content"></div>
        </div>
    </main>

    <div id="checkout-bar" class="checkout-bar" style="display:none">
        <div style="display:flex; flex-direction:column; justify-content:center;">
            <div id="chk-status-text" style="font-size:0.8rem; font-weight:700; color:var(--cor-success); line-height:1.2"></div>
            <div class="balance-val" id="chk-total-val" style="color:var(--cor-primary); font-size:1.2rem; font-weight:800">R$ 0,00</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; justify-content:flex-end">
            <button class="btn-mini-diff" onclick="openDiffModal()" aria-label="Ver altera√ß√µes" id="btn-view-diff">üìù</button>
            <button class="btn-main-action" onclick="openCheckoutModal()">
                CONCLUIR
            </button>
        </div>
    </div>
    
    <button class="btn-scroll-top" onclick="window.scrollTo({top:0, behavior:'smooth'})" id="btn-scroll-top">‚¨Ü</button>

    <dialog id="modal-decision">
        <div class="modal-body">
            <h3 class="modal-title" id="decision-title"></h3>
            <p class="modal-text">Deseja Personalizar a sua Cesta?</p>
            
            <button class="btn-modal primary" onclick="startCustomization()">SIM, PERSONALIZAR</button>
            <button class="btn-modal secondary" onclick="prepareStandardCheckout()">N√ÉO, ENCOMENDAR DIRETO</button>
            <button class="btn-modal ghost" onclick="document.getElementById('modal-decision').close()">Cancelar</button>
        </div>
    </dialog>

    <dialog id="modal-items">
        <div class="modal-body" style="text-align:left; padding: 15px 20px;">
            <h3 class="modal-title" style="margin-bottom:15px; text-align:center" id="items-title">Itens da Cesta</h3>
            
            <div id="items-summary" style="margin-bottom:15px; font-size:0.9rem; background:#F8FAFC; padding:10px 15px; border-radius:8px; border:1px solid #eee; max-height: 50vh; overflow-y:auto;"></div>
            
            <button class="btn-modal primary" onclick="document.getElementById('modal-items').close()">FECHAR</button>
        </div>
    </dialog>
    
    <dialog id="modal-diff">
        <div class="modal-body">
            <h3 class="modal-title">Altera√ß√µes na Cesta</h3>
            <div id="diff-content" style="text-align: left; background: #F8FAFC; padding: 15px; border-radius: 8px; font-size: 0.9rem; max-height: 50vh; overflow-y: auto;"></div>
            <button class="btn-modal primary" onclick="document.getElementById('modal-diff').close()" style="margin-top:15px">FECHAR</button>
        </div>
    </dialog>

    <dialog id="modal-checkout">
        <div class="modal-body" style="text-align:left; padding: 15px 20px;">
            <h3 class="modal-title" style="margin-bottom:15px; text-align:center">Finalizar Pedido</h3>
            
            <div id="checkout-summary" style="margin-bottom:15px; font-size:0.9rem; background:#F8FAFC; padding:10px 15px; border-radius:8px; border:1px solid #eee; max-height: 40vh; overflow-y:auto;"></div>
            
            <div style="font-size:1.1rem; font-weight:800; text-align:right; margin-bottom:15px; color:var(--cor-primary)" id="checkout-total-display"></div>
            
            <label style="display:block; font-size:0.8rem; font-weight:700; color:#334155; margin-bottom:2px">Seu Nome:</label>
            <input type="text" id="cust-name" class="search-box" style="margin-bottom:10px; padding:10px; font-size:0.95rem" placeholder="Digite seu nome completo">
            
            <label style="display:block; font-size:0.8rem; font-weight:700; color:#334155; margin-bottom:2px">Forma de Pagamento:</label>
            <select id="cust-pay" class="search-box" style="margin-bottom:20px; padding:10px; font-size:0.95rem">
                <option>PIX (Na entrega)</option>
                <option>Dinheiro</option>
                <option>Cart√£o de Cr√©dito</option>
                <option>Cart√£o de D√©bito</option>
                <option>Cart√£o Alimenta√ß√£o</option>
            </select>
            
            <button class="btn-modal primary" onclick="sendOrder()">ENVIAR PEDIDO</button>
            <button class="btn-modal ghost" onclick="document.getElementById('modal-checkout').close()">Voltar</button>
        </div>
    </dialog>

    <script>
        // --- CONFIG ---
        const CONFIG_WHATSAPP = "5565996813588"; 
        
        // --- STATE ---
        let DB_PROD = [];
        let DB_CESTAS = [];
        let STATE = {
            cesta: null, cart: {}, basePrice: 0, currentTotal: 0, 
            isUnlocked: false, lastScroll: 0, sortType: 'name',
            initialGap: 0, mode: 'custom', // custom, standard, zero
            catMap: {} // Mapeamento Codigo -> Categoria
        };

        // --- INIT ---
        async function init() {
            try {
                const [r1, r2, r3] = await Promise.all([
                    fetch('produtos-cesta-basica.json'), 
                    fetch('produtos.json'),
                    fetch('categorias.json')
                ]);
                
                if (r1.ok) DB_CESTAS = await r1.json();
                
                if (r3.ok) {
                    const catsRaw = await r3.json();
                    catsRaw.forEach(c => {
                        if(c.codigo && c.categoria) {
                            STATE.catMap[c.codigo.trim()] = c.categoria.trim();
                        }
                    });
                }

                if (r2.ok) {
                    let txt = await r2.text();
                    txt = txt.trim().replace(/,(\s+)?$/, "");
                    if (!txt.startsWith('[')) txt = '[' + txt + ']';
                    DB_PROD = JSON.parse(txt).filter(x => x.situacao === "A").map(p => ({
                        id: String(p.id), 
                        code: String(p.codigo || p.id), // Salva o codigo para match de categoria
                        name: p.nome, 
                        price: parseFloat(p.preco),
                        img: `img/produtos/${p.codigo || p.id}.webp`
                    }));
                }
                renderHome();
            } catch (e) { 
                console.error(e);
                document.getElementById('cestas-list').innerHTML = '<p style="text-align:center; color:red">Erro ao carregar sistema. Atualize a p√°gina.</p>';
            }
        }

        // --- NAVIGATION ---
        function goHome() {
            STATE.cart = {}; STATE.isUnlocked = false; STATE.cesta = null; STATE.initialGap = 0; STATE.mode = 'custom';
            document.getElementById('view-home').classList.add('active');
            document.getElementById('view-custom').classList.remove('active');
            
            // Show Header on Home
            document.getElementById('header-wrapper').style.display = 'block';
            document.getElementById('btn-back-home').style.display = 'none';
            
            document.getElementById('search-container').style.display = 'none';
            document.getElementById('filters-container').style.display = 'none';
            document.getElementById('checkout-bar').style.display = 'none';
            document.getElementById('btn-scroll-top').style.display = 'none';
            
            document.getElementById('catalogo-content').innerHTML = "";
            document.getElementById('search-input').value = ""; // Limpa busca
            window.scrollTo(0,0);
        }

        function renderHome() {
            const el = document.getElementById('cestas-list');
            el.innerHTML = DB_CESTAS.map(c => `
                <div class="cesta-card" tabindex="0">
                    <img src="${c.imagem || ''}" class="cesta-img" alt="${c.nome}" loading="lazy" width="300" height="300" onclick="openDecision('${c.id}')">
                    <div class="cesta-content">
                        <div class="cesta-name">${c.nome}</div>
                        <div class="cesta-price">${fmt(c.preco)}</div>
                        
                        <div class="cesta-actions">
                            <button class="btn-choose" onclick="openDecision('${c.id}')">Encomendar</button>
                            <button class="btn-choose outline" onclick="openItems('${c.id}')">Ver Itens</button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            renderHomeOffers();
        }

        function renderHomeOffers() {
            const offers = DB_PROD.filter(p => p.name.toUpperCase().startsWith("OFERTA"));
            if (offers.length === 0) return;
            
            const html = `
            <div class="carousel-container" style="border-top:none; margin-top:10px;">
                <div class="carousel-header">
                    <div class="carousel-title" style="color:var(--cor-danger)">üî• OFERTAS DA SEMANA</div>
                </div>
                <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                <div class="carousel-track">
                    ${offers.map(p => {
                        const displayName = p.name.replace(/(OFERTA)/i, '<span style="color:var(--cor-danger); font-weight:800">$1</span>');
                        return `
                            <div class="prod-card disabled" onclick="alert('Por favor, primeiro escolha uma Cesta Base ou Montar do Zero para come√ßar seu pedido.')">
                                <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                <div class="prod-name">${displayName}</div>
                                <div class="prod-price">${fmt(p.price)}</div>
                                <div style="margin-top:auto; font-size:0.75rem; color:#999; text-align:center;">Comece o pedido</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
            </div>`;
            document.getElementById('home-offers-container').innerHTML = html;
        }

        // --- LOGIC ---
        function openDecision(id) {
            STATE.cesta = DB_CESTAS.find(x => x.id === id);
            document.getElementById('decision-title').innerText = STATE.cesta.nome;
            document.getElementById('modal-decision').showModal();
        }

        function openItems(id) {
            const cesta = DB_CESTAS.find(x => x.id === id);
            if(!cesta) return;
            
            let html = "";
            cesta.produtos.forEach(itemStr => {
                const [q, id] = itemStr.split('x ');
                const pid = id.trim();
                const product = DB_PROD.find(p => p.id === pid);
                if (product) {
                    html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee">
                        <span style="flex:1; padding-right:10px; font-size:0.9rem; font-weight:600">${product.name}</span>
                        <span style="font-weight:700; font-size:1rem; background:#eee; padding:4px 10px; border-radius:4px">${q}x</span>
                    </div>`;
                }
            });
            
            document.getElementById('items-title').innerText = `Itens: ${cesta.nome}`;
            document.getElementById('items-summary').innerHTML = html;
            document.getElementById('modal-items').showModal();
        }

        // Modo 1: Encomendar Normal (Com Checkout Modal)
        function prepareStandardCheckout() {
            document.getElementById('modal-decision').close();
            STATE.mode = 'standard';
            STATE.cart = {}; 
            STATE.basePrice = STATE.cesta.preco;
            
            // Popula o carrinho virtual para o checkout
            let initialSum = 0;
            STATE.cesta.produtos.forEach(itemStr => {
                const [q, id] = itemStr.split('x ');
                const pid = id.trim();
                const product = DB_PROD.find(p => p.id === pid);
                if (product) {
                    STATE.cart[pid] = parseInt(q);
                    initialSum += product.price * parseInt(q);
                }
            });
            
            STATE.initialGap = STATE.cesta.preco - initialSum;
            STATE.currentTotal = STATE.basePrice;

            openCheckoutModal();
        }

        // Modo 2: Personalizar
        function startCustomization() {
            document.getElementById('modal-decision').close();
            STATE.mode = 'custom';
            STATE.basePrice = STATE.cesta.preco;
            STATE.cart = {}; 
            
            // Calculate initial sum to handle drift
            let initialSum = 0;

            STATE.cesta.produtos.forEach(itemStr => {
                const [q, id] = itemStr.split('x ');
                const pid = id.trim();
                const product = DB_PROD.find(p => p.id === pid);
                if (product) {
                    STATE.cart[pid] = parseInt(q);
                    initialSum += product.price * parseInt(q);
                }
            });

            // Adjust gap so total starts at basket price
            STATE.initialGap = STATE.cesta.preco - initialSum;

            activateViewCustom();
            
            // Set Intro Title
            document.getElementById('custom-intro-text').innerHTML = `
                <div class="intro-title-custom">
                    Voc√™ escolheu a <strong>${STATE.cesta.nome}</strong>. <br>Primeiro retire os produtos que n√£o quer.
                </div>`;
            document.getElementById('basket-base-list').style.display = 'block';
            document.getElementById('btn-view-diff').style.display = 'flex';
            document.getElementById('sep-title').innerText = "Agora fique a vontade para repor o que quiser.";

            renderBaseList();
        }

        // Modo 3: Montar do Zero
        function startZeroBuild() {
            STATE.mode = 'zero';
            STATE.cesta = { id: 'zero', nome: 'Cesta Montada do Zero', preco: 0, produtos: [] };
            STATE.basePrice = 0;
            STATE.cart = {};
            STATE.initialGap = 0;
            
            activateViewCustom();
            
            // UI Espec√≠fica
            document.getElementById('custom-intro-text').innerHTML = `
                <div class="intro-title-custom" style="background:#E3F2FD; color:#0D47A1; border-color:#90CAF9">
                    <strong>Montando do Zero</strong><br>Escolha os produtos livremente.
                    <br><small>M√≠nimo R$ 120,00 e 8 itens variados.</small>
                </div>`;
            document.getElementById('basket-base-list').style.display = 'none'; // Esconde lista base
            document.getElementById('btn-view-diff').style.display = 'none'; // Esconde bot√£o de altera√ß√µes
            document.getElementById('sep-title').innerText = "Cat√°logo de Produtos";
        }

        function activateViewCustom() {
            document.getElementById('view-home').classList.remove('active');
            document.getElementById('view-custom').classList.add('active');
            
            document.getElementById('header-wrapper').style.display = 'block';
            document.getElementById('btn-back-home').style.display = 'block';
            
            document.getElementById('search-container').style.display = 'block';
            document.getElementById('filters-container').style.display = 'flex';
            document.getElementById('checkout-bar').style.display = 'grid';
            document.getElementById('btn-scroll-top').style.display = 'flex';
            
            STATE.isUnlocked = true;
            document.getElementById('search-input').value = ""; 
            
            updateUI();
            renderCatalogo();
            window.scrollTo(0,0);
        }

        function updateUI() {
            const sumCart = Object.entries(STATE.cart).reduce((acc, [id, q]) => {
                const p = DB_PROD.find(x => x.id === id);
                return acc + (p ? p.price * q : 0);
            }, 0);
            
            // Apply initial gap (only affects Standard/Custom modes mostly)
            STATE.currentTotal = sumCart + (STATE.initialGap || 0);

            const statusText = document.getElementById('chk-status-text');
            const totalVal = document.getElementById('chk-total-val');
            
            if (STATE.mode === 'zero') {
                statusText.innerText = "TOTAL ACUMULADO";
                statusText.style.color = "var(--cor-primary)";
            } else {
                const diff = STATE.basePrice - STATE.currentTotal;
                if (diff > 0.01) {
                    statusText.innerText = `CR√âDITO: ${fmt(diff)}`;
                    statusText.style.color = "var(--cor-success)";
                } else {
                    if (diff < -0.01) {
                        statusText.innerText = `EXTRA: +${fmt(Math.abs(diff))}`;
                        statusText.style.color = "#D32F2F";
                    } else {
                        statusText.innerText = "CESTA COMPLETA";
                        statusText.style.color = "#64748B";
                    }
                }
            }
            totalVal.innerText = fmt(STATE.currentTotal);
        }

        function upd(pid, d) {
            STATE.cart[pid] = (STATE.cart[pid] || 0) + d;
            if (STATE.cart[pid] <= 0) delete STATE.cart[pid];
            updateUI();
            
            if (STATE.mode === 'custom' || STATE.mode === 'zero') {
                // Atualizar TODOS os contadores com a classe espec√≠fica
                const els = document.querySelectorAll(`.qty-${pid}`);
                if (els.length > 0) {
                    els.forEach(el => el.innerText = STATE.cart[pid] || 0);
                } else {
                    renderCatalogo(); 
                }
                
                // Se estiver no modo custom, atualiza lista base tambem se o item estiver nela
                if(STATE.mode === 'custom') renderBaseList(); 
            }
        }

        function setSort(type) {
            STATE.sortType = type;
            // Atualiza bot√µes
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            document.getElementById(`sort-${type}`).classList.add('active');
            renderCatalogo();
        }

        function clearSearch() {
            document.getElementById('search-input').value = "";
            renderCatalogo();
        }

        // --- RENDERING ---
        function renderBaseList() {
            const el = document.getElementById('basket-base-list');
            
            // Pega as chaves do carrinho atual
            const cartIds = Object.keys(STATE.cart);
            
            // Se estiver vazio
            if(cartIds.length === 0) {
                 el.innerHTML = '<p style="text-align:center; padding:10px; color:#64748B">Sua cesta est√° vazia.</p>';
                 return;
            }

            // Ordena√ß√£o alfab√©tica para consist√™ncia visual
            cartIds.sort((a,b) => {
                const pa = DB_PROD.find(x => x.id === a);
                const pb = DB_PROD.find(x => x.id === b);
                return (pa && pb) ? pa.name.localeCompare(pb.name) : 0;
            });
            
            let itemsHtml = cartIds.map(pid => {
                const p = DB_PROD.find(x => x.id === pid);
                if (!p) return '';
                const qty = STATE.cart[pid];
                
                return `
                <div class="base-item">
                    <span class="base-item-name">${p.name}</span>
                    <div class="qty-control">
                        <button class="btn-q" onclick="upd('${pid}', -1)" aria-label="Remover">-</button>
                        <span class="val-q qty-${pid}">${qty}</span>
                        <button class="btn-q" onclick="upd('${pid}', 1)" aria-label="Adicionar">+</button>
                    </div>
                </div>`;
            }).join('');

            // Adiciona o cabe√ßalho antes dos itens
            el.innerHTML = `
                <div class="list-header-row">
                    <span>Produtos</span>
                    <span>Qtd na cesta</span>
                </div>
                ${itemsHtml}
            `;
        }

        function renderCatalogo() {
            const query = document.getElementById('search-input').value.toUpperCase();
            const btnClear = document.getElementById('btn-clear-search');
            if(btnClear) btnClear.style.display = query ? 'block' : 'none';

            let html = "";
            
            // Define fun√ß√£o de ordena√ß√£o
            let sorter;
            if (STATE.sortType === 'price_asc') sorter = (a, b) => a.price - b.price;
            else if (STATE.sortType === 'price_desc') sorter = (a, b) => b.price - a.price;
            else sorter = (a, b) => a.name.localeCompare(b.name); // Padr√£o A-Z

            if (query) {
                // MODO BUSCA: √önico Carrossel com todos os resultados
                let results = DB_PROD.filter(p => p.name.toUpperCase().includes(query));
                results.sort(sorter);

                if (results.length > 0) {
                    html = `
                    <div class="carousel-container" id="search-results-carousel">
                        <div class="carousel-header"><div class="carousel-title">Resultados da Busca</div></div>
                        <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                        <div class="carousel-track">
                            ${results.map(p => `
                                <div class="prod-card">
                                    <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                    <div class="prod-name">${p.name}</div>
                                    <div class="prod-price">${fmt(p.price)}</div>
                                    <div class="qty-control" style="margin-top:auto; justify-content:space-between; width:100%">
                                        <button class="btn-q" onclick="upd('${p.id}', -1)">-</button>
                                        <span class="val-q qty-${p.id}">${STATE.cart[p.id] || 0}</span>
                                        <button class="btn-q" onclick="upd('${p.id}', 1)">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
                    </div>`;
                    
                    document.getElementById('catalogo-content').innerHTML = html;
                    
                    // Rolar a p√°gina para que os resultados fiquem vis√≠veis logo abaixo dos chips
                    const catalogo = document.getElementById('catalogo-content');
                    const stickyHeight = document.querySelector('.sticky-stack').offsetHeight + document.querySelector('.header-wrapper').offsetHeight;
                    
                    setTimeout(() => {
                        window.scrollTo({
                            top: catalogo.offsetTop - stickyHeight - 20,
                            behavior: 'smooth'
                        });
                    }, 50);

                } else {
                    document.getElementById('catalogo-content').innerHTML = `<p style="text-align:center; padding:30px; color:#666">Nenhum produto encontrado para "${query}".</p>`;
                }
                
                return; // Encerra aqui se houver busca
            }

            // MODO NORMAL (Categorias Din√¢micas via JSON)
            
            // 1. Renderizar OFERTAS (se existirem)
            const offers = DB_PROD.filter(p => p.name.toUpperCase().startsWith("OFERTA"));
            if (offers.length > 0) {
                offers.sort(sorter);
                html += `
                <div class="carousel-container">
                    <div class="carousel-header">
                        <div class="carousel-title" style="color:var(--cor-danger)">üî• SUPER OFERTAS</div>
                    </div>
                    <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                    <div class="carousel-track">
                        ${offers.map(p => {
                            const displayName = p.name.replace(/(OFERTA)/i, '<span style="color:var(--cor-danger); font-weight:800">$1</span>');
                            return `
                                <div class="prod-card">
                                    <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                    <div class="prod-name">${displayName}</div>
                                    <div class="prod-price">${fmt(p.price)}</div>
                                    <div class="qty-control" style="margin-top:auto; justify-content:space-between; width:100%; padding:2px 4px;">
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', -1)">-</button>
                                        <span class="val-q qty-${p.id}" style="font-size:0.9rem">${STATE.cart[p.id] || 0}</span>
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', 1)">+</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
                </div>`;
            }

            // 2. Agrupar produtos por Categoria
            const productsByCategory = {};
            
            DB_PROD.forEach(p => {
                // Tenta achar categoria pelo codigo, depois pelo id, sen√£o vai para "Outros"
                let cat = STATE.catMap[p.code] || "Outros";
                if(!productsByCategory[cat]) productsByCategory[cat] = [];
                productsByCategory[cat].push(p);
            });
            
            // Ordenar Categorias (Alfab√©tica, mas "Outros" no fim)
            let sortedCats = Object.keys(productsByCategory).sort();
            if(sortedCats.includes("Outros")) {
                sortedCats = sortedCats.filter(c => c !== "Outros");
                sortedCats.push("Outros");
            }
            
            // Renderizar cada categoria
            sortedCats.forEach(catName => {
                let catProds = productsByCategory[catName];
                catProds.sort(sorter);

                if (catProds.length > 0) {
                    html += `
                    <div class="carousel-container">
                        <div class="carousel-header">
                            <div class="carousel-title">${catName}</div>
                        </div>
                        <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                        <div class="carousel-track">
                            ${catProds.map(p => `
                                <div class="prod-card">
                                    <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                    <div class="prod-name">${p.name}</div>
                                    <div class="prod-price">${fmt(p.price)}</div>
                                    <div class="qty-control" style="margin-top:auto; justify-content:space-between; width:100%; padding:2px 4px;">
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', -1)">-</button>
                                        <span class="val-q qty-${p.id}" style="font-size:0.9rem">${STATE.cart[p.id] || 0}</span>
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', 1)">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
                    </div>`;
                }
            });
            
            document.getElementById('catalogo-content').innerHTML = html;
        }

        function openDiffModal() {
            let originalMap = {};
            STATE.cesta.produtos.forEach(itemStr => {
                const [q, id] = itemStr.split('x ');
                originalMap[id.trim()] = parseInt(q);
            });

            let removedList = [];
            let addedList = [];

            // Helper de Formata√ß√£o
            const fmtName = (n) => {
                let s = n.toLowerCase().split(' ').map(w => w.length <= 3 ? w : w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                s = s.charAt(0).toUpperCase() + s.slice(1);
                if(s.length > 20) s = s.substring(0, 17) + '...';
                return s;
            };

            for (let [id, origQty] of Object.entries(originalMap)) {
                const currQty = STATE.cart[id] || 0;
                if (currQty < origQty) {
                    const p = DB_PROD.find(x => x.id === id);
                    if (p) removedList.push(`<div style="color:#D32F2F"><strong>- ${origQty - currQty}x</strong> ${fmtName(p.name)}</div>`);
                }
            }

            for (let [id, currQty] of Object.entries(STATE.cart)) {
                const origQty = originalMap[id] || 0;
                if (currQty > origQty) {
                    const p = DB_PROD.find(x => x.id === id);
                    if (p) addedList.push(`<div style="color:#008037"><strong>+ ${currQty - origQty}x</strong> ${fmtName(p.name)}</div>`);
                }
            }

            let content = "";
            if (removedList.length === 0 && addedList.length === 0) {
                content = "<p style='color:#64748B'>Nenhuma altera√ß√£o realizada na cesta original.</p>";
            } else {
                if (removedList.length > 0) {
                    content += `<div style="margin-bottom:15px"><h4 style="margin:0 0 5px 0; color:#D32F2F">Itens Retirados:</h4>${removedList.join('')}</div>`;
                }
                if (addedList.length > 0) {
                    content += `<div><h4 style="margin:0 0 5px 0; color:#008037">Itens Adicionados:</h4>${addedList.join('')}</div>`;
                }
            }
            
            document.getElementById('diff-content').innerHTML = content;
            document.getElementById('modal-diff').showModal();
        }

        // --- CHECKOUT ---
        function openCheckoutModal() {
            // Regras de Valida√ß√£o
            if (STATE.mode === 'custom' || STATE.mode === 'standard') {
                if (STATE.currentTotal < (STATE.basePrice - 0.5)) {
                    alert(`Ainda falta ${fmt(STATE.basePrice - STATE.currentTotal)} para atingir o valor da cesta!`);
                    return;
                }
            } else if (STATE.mode === 'zero') {
                if (STATE.currentTotal < 120) {
                    alert(`O valor m√≠nimo para montar uma cesta do zero √© R$ 120,00. Faltam ${fmt(120 - STATE.currentTotal)}.`);
                    return;
                }
                if (Object.keys(STATE.cart).length < 8) {
                    alert(`Voc√™ precisa escolher pelo menos 8 itens diferentes. Atualmente: ${Object.keys(STATE.cart).length}.`);
                    return;
                }
            }
            
            let html = "";
            Object.entries(STATE.cart).forEach(([id, q]) => {
                const p = DB_PROD.find(x => x.id === id);
                html += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee">
                    <span style="flex:1; padding-right:10px; font-size:0.9rem; font-weight:600">${p.name}</span>
                    <span style="font-weight:700; font-size:1rem; background:#eee; padding:4px 10px; border-radius:4px">${q}x</span>
                </div>`;
            });
            
            document.getElementById('checkout-summary').innerHTML = html;
            document.getElementById('checkout-total-display').innerText = `Total: ${fmt(STATE.currentTotal)}`;
            document.getElementById('modal-checkout').showModal();
        }

        async function sendOrder() {
            const name = document.getElementById('cust-name').value;
            const pay = document.getElementById('cust-pay').value;
            
            if (!name) return alert("Por favor, digite seu nome.");
            
            // Gerar ID de Pedido √önico (Previne erro VALIDATION_ERROR)
            const orderId = new Date().getTime().toString().slice(-6);
            
            // Helper de Formata√ß√£o
            const fmtName = (n) => {
                let s = n.toLowerCase().split(' ').map(w => w.length <= 3 ? w : w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                s = s.charAt(0).toUpperCase() + s.slice(1);
                if(s.length > 20) s = s.substring(0, 17) + '...';
                return s;
            };
            
            // --- C√ÅLCULO DE DIFEREN√áAS E CHECKLIST ---
            let originalMap = {};
            // S√≥ faz sentido calcular removidos se n√£o for do zero
            if (STATE.mode !== 'zero') {
                STATE.cesta.produtos.forEach(itemStr => {
                    const [q, id] = itemStr.split('x ');
                    originalMap[id.trim()] = parseInt(q);
                });
            }

            let removedText = [];
            let addedText = [];

            // Identificar removidos (Apenas se mode != zero)
            if (STATE.mode !== 'zero') {
                for (let [id, origQty] of Object.entries(originalMap)) {
                    const currQty = STATE.cart[id] || 0;
                    if (currQty < origQty) {
                        const p = DB_PROD.find(x => x.id === id);
                        if (p) removedText.push(`- ${origQty - currQty}x ${fmtName(p.name)}`);
                    }
                }
            }

            // Identificar adicionados (Comparar com original ou tudo se for zero)
            for (let [id, currQty] of Object.entries(STATE.cart)) {
                const origQty = originalMap[id] || 0;
                if (currQty > origQty) {
                    const p = DB_PROD.find(x => x.id === id);
                    if (p) addedText.push(`+ ${currQty - origQty}x ${fmtName(p.name)}`);
                }
            }

            // Construir Texto do Checklist para Observa√ß√µes (Com ID para evitar duplica√ß√£o)
            let checklist = `TIPO: ${STATE.mode === 'zero' ? 'MONTADA DO ZERO' : (STATE.mode === 'standard' ? 'PADR√ÉO' : 'PERSONALIZADA')} | CESTA: ${STATE.cesta.nome}`;
            
            if (removedText.length > 0) {
                checklist += ` | RETIRADOS: ${removedText.join(', ')}`;
            } 

            if (addedText.length > 0) {
                checklist += ` | ADICIONADOS: ${addedText.join(', ')}`;
            }
            
            checklist += ` | PROTOCOLO: #${orderId}`; // Garante unicidade

            // 1. DISPARAR WEBHOOK PARA O MAKE
            try {
                // Montar array de itens para o payload e calcular soma real dos produtos
                const itensPayload = [];
                let sumProducts = 0;
                
                Object.entries(STATE.cart).forEach(([id, q]) => {
                     const p = DB_PROD.find(x => x.id === id);
                     if(p) {
                         itensPayload.push({
                             id: p.id,
                             nome: p.name,
                             quantidade: q,
                             preco_unitario: p.price
                         });
                         sumProducts += p.price * q;
                     }
                });

                // Calcular valores finais garantidos
                const finalTotal = STATE.currentTotal;
                const gap = finalTotal - sumProducts;

                // Construir objeto com estrutura exata do Blueprint + Arredondamento
                const payload = {
                    cliente: {
                        nome: name,
                        cpf: "", 
                        celular: "",
                        endereco: ""
                    },
                    pedido: {
                        itens: itensPayload,
                        total_site: Number(finalTotal.toFixed(2)),
                        soma_produtos: Number(sumProducts.toFixed(2)),
                        diferenca_ajuste: Number(gap.toFixed(2)),
                        forma_pagamento: pay,
                        cesta_origem: `${STATE.cesta.nome} (${STATE.mode})`,
                        observacoes: checklist // Envia o checklist formatado
                    }
                };

                // Enviar para o Webhook do Make
                await fetch("https://hook.eu1.make.com/yisqs4w309ogi6fx4969dbsr2q7fu7il", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
            } catch (e) {
                console.error("Erro ao enviar integra√ß√£o:", e);
                // N√£o paramos o fluxo se der erro, o cliente ainda vai pro zap
            }

            // 2. REDIRECIONAR PARA WHATSAPP
            let msg = `*NOVO PEDIDO (${STATE.mode === 'zero' ? 'DO ZERO' : STATE.cesta.nome.toUpperCase()})*\n`;
            msg += `üë§ Cliente: ${name}\n`;
            msg += `üí∞ Pagamento: ${pay}\n`;
            msg += `üì¶ Ref: #${orderId}\n\n`;
            msg += `*ITENS DO PEDIDO:*\n`;
            
            Object.entries(STATE.cart).forEach(([id, q]) => {
                const p = DB_PROD.find(x => x.id === id);
                msg += `${q}x ${fmtName(p.name)}\n`;
            });
            
            msg += `\n*VALOR TOTAL: ${fmt(STATE.currentTotal)}*`;

            msg += `\n________________________________\n`;
            msg += `*Para a sua confer√™ncia*\n`;
            
            if (removedText.length > 0) {
                msg += `\n*-- O que foi retirado:*\n`;
                msg += removedText.join('\n') + `\n`;
            }

            if (addedText.length > 0 && STATE.mode !== 'zero') {
                msg += `\n*-- O que foi acrescentado:*\n`;
                msg += addedText.join('\n');
            }
            
            window.location.href = `https://wa.me/${CONFIG_WHATSAPP}?text=${encodeURIComponent(msg)}`;
        }

        function fmt(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        
        init();
    </script>
</body>
</html>
