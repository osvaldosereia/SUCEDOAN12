<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Super Cestas Dona Ant√¥nia - Encomende online.">
    <meta name="theme-color" content="#D32F2F">
    <title>Super Cestas Dona Ant√¥nia</title>
    <style>
        /* --- CORE: VARI√ÅVEIS & RESET --- */
        :root {
            --cor-primaria: #D32F2F; /* Vermelho Varejo */
            --cor-primaria-dark: #B71C1C;
            --cor-fundo: #f8f9fa; /* Cinza muito leve para contraste */
            --cor-texto: #263238;
            --cor-cinza-claro: #eceff1;
            --cor-borda: #cfd8dc;
            --sombra-card: 0 4px 12px rgba(0,0,0,0.06);
            --sombra-flutuante: 0 -4px 20px rgba(0,0,0,0.1);
            --radio: 8px;
            --fonte-padrao: 14px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            margin: 0;
            padding-bottom: 120px; /* Espa√ßo para footer fixo */
            font-size: var(--fonte-padrao);
            line-height: 1.4;
            overflow-y: scroll; /* Scroll sempre ativo para evitar pulos */
            overscroll-behavior-y: none; /* Previne refresh acidental no mobile */
        }

        h1, h2, h3 { margin: 0; font-weight: 700; color: #000; letter-spacing: -0.3px; }
        button { cursor: pointer; user-select: none; }

        /* --- HEADER --- */
        header {
            background: white;
            padding: 0 16px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            will-change: transform;
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; flex: 1; overflow: hidden; }
        
        .logo { 
            width: 38px; height: 38px; 
            background: var(--cor-primaria); color: white; 
            border-radius: 50%; display: grid; place-items: center; 
            font-weight: 800; font-size: 1.2rem;
            flex-shrink: 0; 
            box-shadow: 0 2px 5px rgba(211, 47, 47, 0.4);
        }
        
        .page-title { 
            font-size: 1.1rem; text-transform: uppercase; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: font-size 0.3s;
        }
        /* Classe utilit√°ria para diminuir fonte na personaliza√ß√£o */
        .page-title.small { font-size: 0.95rem; color: #444; }

        .btn-voltar { 
            background: #f5f5f5; border: none; padding: 8px 12px; 
            border-radius: 6px; font-weight: 600; font-size: 0.85rem; 
            color: #555; display: none; transition: background 0.2s;
        }
        .btn-voltar:active { background: #e0e0e0; }

        .btn-faq {
            background: white; border: 1px solid var(--cor-borda); 
            color: var(--cor-primaria); width: 36px; height: 36px;
            border-radius: 50%; font-weight: bold; font-size: 1.1rem;
            display: grid; place-items: center; margin-left: 10px;
        }

        /* --- LOADING SPINNER --- */
        #global-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 2000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(2px);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #eee;
            border-top: 4px solid var(--cor-primaria); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- LAYOUTS DE P√ÅGINA --- */
        .view { display: none; padding: 16px; max-width: 800px; margin: 0 auto; }
        .view.active { display: block; animation: fadeUp 0.3s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TELA 1: CARDS DE CESTAS --- */
        .grid-cestas { display: grid; grid-template-columns: 1fr; gap: 20px; content-visibility: auto; contain-intrinsic-size: 350px; }
        
        .cesta-card {
            background: white; border-radius: 12px; overflow: hidden; 
            box-shadow: var(--sombra-card); border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column;
            transition: transform 0.2s;
        }
        .cesta-card:active { transform: scale(0.99); }

        .cesta-img-container { 
            width: 100%; height: 200px; background: #eee; position: relative; overflow: hidden;
        }
        .cesta-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
        
        .cesta-body { padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        .cesta-nome { font-size: 1.2rem; font-weight: 700; color: #222; }
        .cesta-info { font-size: 0.9rem; color: #666; background: #f5f5f5; padding: 4px 8px; border-radius: 4px; align-self: flex-start; }
        .cesta-preco { font-size: 1.6rem; font-weight: 800; color: var(--cor-primaria); margin: 6px 0; }
        
        .cesta-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 8px; }
        .btn-cesta { 
            padding: 12px; border: none; border-radius: 8px; 
            font-weight: 700; font-size: 0.9rem; text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        .btn-detalhes { grid-column: span 2; background: #f0f0f0; color: #444; }
        .btn-direct { background: #2e7d32; color: white; box-shadow: 0 4px 10px rgba(46,125,50,0.2); }
        .btn-personalize { background: var(--cor-primaria); color: white; box-shadow: 0 4px 10px rgba(211,47,47,0.2); }

        /* --- TELA 2: PERSONALIZA√á√ÉO --- */
        
        /* -- Se√ß√£o Topo (Itens da Cesta) -- */
        .cesta-header-msg {
            background: #e3f2fd; color: #1565c0; padding: 12px; 
            border-radius: 8px; text-align: center; font-weight: 600; margin-bottom: 20px;
            border: 1px solid #bbdefb;
        }
        
        .cesta-items-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px 12px;
            margin-bottom: 40px; border-bottom: 2px dashed #ddd; padding-bottom: 25px;
            content-visibility: auto;
        }
        
        .item-topo { 
            position: relative; display: flex; flex-direction: column; align-items: center; 
        }
        .item-topo img {
            width: 100%; aspect-ratio: 1/1; object-fit: contain;
            border-radius: 8px; background: white; border: 1px solid #eee;
            padding: 5px;
        }
        
        /* Seletor Flutuante (Overlap) */
        .qty-selector-h {
            position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; justify-content: space-between;
            background: white; border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            padding: 4px; width: 90px; height: 34px; z-index: 2; border: 1px solid #f0f0f0;
        }
        .btn-h { 
            width: 26px; height: 26px; border: none; background: #f9f9f9; border-radius: 50%;
            font-weight: 700; font-size: 1.1rem; color: var(--cor-primaria); 
            display: flex; align-items: center; justify-content: center;
        }
        .btn-h:active { background: #eee; }
        .val-h { font-weight: 700; font-size: 1rem; color: #333; flex: 1; text-align: center; }

        /* -- Se√ß√£o Baixo (Cat√°logo) -- */
        .cat-divisor {
            text-align: center; margin: 30px 0 20px; font-weight: 700; 
            color: #666; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .cat-divisor::before, .cat-divisor::after { content:""; height:1px; background:#ddd; flex:1; }

        .cat-titulo { 
            font-size: 1.1rem; margin: 30px 0 15px 0; color: #222; font-weight: 800;
            border-left: 4px solid var(--cor-primaria); padding-left: 10px;
        }
        .subcat-titulo {
            font-size: 0.85rem; margin: 10px 0 10px 0; color: #555; font-weight: 700; 
            background: #eceff1; display: inline-block; padding: 4px 10px; border-radius: 12px;
        }

        .produto-lista { display: grid; grid-template-columns: 1fr; gap: 12px; }
        
        /* CARD DE PRODUTO REVISADO */
        .produto-card {
            display: flex; align-items: center; gap: 15px;
            background: white; border: 1px solid var(--cor-borda); border-radius: 10px;
            padding: 12px 12px 12px 8px;
            height: 100px; /* Mais alto como pedido */
            contain: content; /* Otimiza√ß√£o */
            transition: border-color 0.2s;
        }
        .produto-card.selected { border: 1px solid var(--cor-primaria); background: #fffde7; }

        .produto-img { 
            width: 80px; height: 80px; /* Imagem maior */
            object-fit: contain; background: #fff; border-radius: 6px; 
            flex-shrink: 0; mix-blend-mode: multiply;
        }
        .produto-info { flex: 1; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .produto-nome { 
            font-size: 0.95rem; font-weight: 600; line-height: 1.3; 
            margin-bottom: 6px; color: #333;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .produto-preco { font-weight: 800; font-size: 1.1rem; color: var(--cor-primaria); }

        /* Controles Verticais (no card de baixo) */
        .controles-v { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; width: 40px; padding-left: 5px; border-left: 1px solid #f0f0f0;
        }
        .btn-v { 
            width: 32px; height: 32px; border-radius: 50%; border: 1px solid #ddd; 
            background: white; font-size: 1.2rem; color: var(--cor-primaria); 
            display: flex; align-items: center; justify-content: center; transition: all 0.1s;
        }
        .btn-v:active { transform: scale(0.9); }
        .btn-add-v { background: var(--cor-primaria); color: white; border: none; box-shadow: 0 2px 5px rgba(211,47,47,0.3); }
        .qty-v { font-weight: 700; font-size: 1rem; color: #333; }

        /* --- FOOTER FIXO (CHECKOUT) --- */
        .carrinho-float {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            box-shadow: var(--sombra-flutuante); padding: 12px 20px;
            display: none; justify-content: space-between; align-items: center; z-index: 95;
            will-change: transform;
            border-top-left-radius: 16px; border-top-right-radius: 16px;
        }
        .total-info { display: flex; flex-direction: column; }
        .total-val { font-size: 1.5rem; font-weight: 900; color: #222; line-height: 1; }
        .total-txt { font-size: 0.75rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }

        .btn-finalizar {
            background: #2e7d32; color: white; border: none; padding: 12px 30px; 
            border-radius: 50px; font-weight: 700; text-transform: uppercase; 
            font-size: 0.95rem; box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4); 
            transition: transform 0.1s;
        }
        .btn-finalizar:active { transform: scale(0.97); }
        .btn-finalizar:disabled { background: #cfd8dc; box-shadow: none; opacity: 0.7; }

        /* --- MODAIS (DIALOG) --- */
        dialog { 
            border: none; border-radius: 16px; padding: 0; width: 92%; max-width: 420px; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            animation: zoomIn 0.2s ease-out;
        }
        dialog::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .modal-header { 
            background: #fff; padding: 16px 20px; display: flex; 
            justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; 
        }
        .modal-title { font-weight: 700; font-size: 1.1rem; color: #222; }
        .btn-close { background: none; border: none; font-size: 1.8rem; color: #999; line-height: 1; }

        .modal-body { padding: 20px; max-height: 65vh; overflow-y: auto; background: #fff; }
        .modal-footer { padding: 20px; background: #fafafa; border-top: 1px solid #eee; text-align: center; }

        /* Visual Lista Checkout/Detalhes */
        .rev-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 1px solid #f5f5f5; 
        }
        .rev-qty { 
            font-weight: 800; font-size: 0.95rem; color: var(--cor-primaria); 
            margin-right: 15px; width: 32px; height: 32px; display: grid; place-items: center;
            background: #ffebee; border-radius: 8px;
        }
        .rev-nome { flex: 1; font-size: 0.95rem; color: #333; line-height: 1.4; }

        /* Formul√°rio */
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; font-weight: 700; margin-bottom: 6px; font-size: 0.85rem; color: #444; }
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; 
            font-size: 1rem; transition: border-color 0.2s;
        }
        .form-group input:focus { border-color: var(--cor-primaria); outline: none; }

        /* --- MODAL FAQ & EMPRESA --- */
        details { 
            background: #f9f9f9; margin-bottom: 10px; border-radius: 8px; 
            overflow: hidden; border: 1px solid #eee;
        }
        details[open] { background: #fff; border-color: var(--cor-primaria); }
        summary { 
            padding: 15px; font-weight: 600; cursor: pointer; list-style: none; 
            display: flex; justify-content: space-between; align-items: center;
        }
        summary::after { content: '+'; font-size: 1.2rem; font-weight: bold; color: #999; }
        details[open] summary::after { content: '-'; color: var(--cor-primaria); }
        .faq-ans { padding: 0 15px 15px; color: #666; font-size: 0.9rem; line-height: 1.5; }

        .company-info { text-align: center; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; }
        .company-logo-area { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-bottom: 15px; }
        .company-name { font-weight: 800; font-size: 1.1rem; color: var(--cor-primaria); }
        .company-data { font-size: 0.85rem; color: #777; margin-bottom: 15px; line-height: 1.6; }
        .company-links { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-social {
            padding: 10px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 0.85rem;
            display: flex; align-items: center; justify-content: center; gap: 5px; color: white;
        }

        /* --- ZOOM --- */
        #zoom-modal { background: transparent; box-shadow: none; text-align: center; }
        #zoom-modal img { max-width: 95vw; max-height: 80vh; border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }

        /* ALERTA DE M√çNIMO */
        .status-bar { display: none; background: #fff3cd; color: #856404; padding: 12px; font-weight: 600; text-align: center; font-size: 0.85rem; }

        @media(min-width: 768px) {
            .grid-cestas { grid-template-columns: 1fr 1fr; }
            .produto-lista { grid-template-columns: 1fr 1fr; }
            .cesta-items-grid { grid-template-columns: repeat(5, 1fr); }
            .modal-footer .company-links { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>

    <div id="global-loader">
        <div class="spinner"></div>
    </div>

    <header>
        <div class="header-left">
            <button class="btn-voltar" id="btn-back" onclick="goHome()">‚ùÆ Voltar</button>
            <div class="logo">M</div>
            <h1 id="page-title" class="page-title">SUPER CESTAS</h1>
        </div>
        <button class="btn-faq" onclick="document.getElementById('modal-faq').showModal()" aria-label="Ajuda">?</button>
    </header>

    <div id="min-msg" class="status-bar"></div>

    <div id="view-cestas" class="view active">
        <div class="grid-cestas" id="cestas-container">
            <p style="padding:20px; text-align:center; color:#999">Carregando cat√°logo...</p>
        </div>
    </div>

    <div id="view-catalogo" class="view">
        <div id="catalogo-container"></div>
    </div>

    <div class="carrinho-float" id="cart-bar">
        <div class="total-info">
            <span class="total-txt">Total do Pedido</span>
            <span class="total-val" id="total-display">R$ 0,00</span>
        </div>
        <button class="btn-finalizar" id="btn-finish" onclick="openCheckout()">
            Avan√ßar ‚ùØ
        </button>
    </div>

    <dialog id="modal-details">
        <div class="modal-header">
            <span class="modal-title">Conte√∫do da Cesta</span>
            <button class="btn-close" onclick="document.getElementById('modal-details').close()">‚úï</button>
        </div>
        <div class="modal-body" id="detail-list"></div>
        <div class="modal-footer">
            <button class="btn-finalizar" style="width:100%" onclick="orderDirectFromModal()">Pedir no WhatsApp</button>
        </div>
    </dialog>

    <dialog id="modal-checkout">
        <div class="modal-header">
            <span class="modal-title">Revisar e Enviar</span>
            <button class="btn-close" onclick="document.getElementById('modal-checkout').close()">‚úï</button>
        </div>
        
        <div class="modal-body">
            <div id="checkout-list"></div>
            
            <div style="margin-top:20px; text-align:right; border-top:2px solid #f0f0f0; padding-top:15px;">
                <span style="font-size:0.9rem; color:#666;">Total Final:</span><br>
                <span id="checkout-total" style="font-size:1.6rem; font-weight:900; color:var(--cor-primaria);"></span>
            </div>

            <form onsubmit="sendWhatsapp(event)" style="margin-top:25px;">
                <div class="form-group">
                    <label>Seu Nome</label>
                    <input type="text" id="cust-name" required placeholder="Digite seu nome">
                </div>
                <div class="form-group">
                    <label>Endere√ßo de Entrega</label>
                    <textarea id="cust-addr" required rows="2" placeholder="Rua, N√∫mero, Bairro, Ponto de Ref."></textarea>
                </div>
                <div class="form-group">
                    <label>Forma de Pagamento</label>
                    <select id="cust-pay">
                        <option>PIX (Chave Celular)</option>
                        <option>Dinheiro (Levar Troco)</option>
                        <option>Cart√£o (Maquininha)</option>
                    </select>
                </div>
                <button type="submit" class="btn-finalizar" style="width:100%;">ENVIAR PEDIDO üì≤</button>
            </form>
        </div>
    </dialog>

    <dialog id="modal-faq">
        <div class="modal-header">
            <span class="modal-title">D√∫vidas & Contato</span>
            <button class="btn-close" onclick="document.getElementById('modal-faq').close()">‚úï</button>
        </div>
        <div class="modal-body">
            <details>
                <summary>Como funciona a entrega?</summary>
                <div class="faq-ans">Entregamos em todos os bairros de Cuiab√° e V√°rzea Grande. O prazo √© combinado via WhatsApp ap√≥s o envio do pedido.</div>
            </details>
            <details>
                <summary>Quais as formas de pagamento?</summary>
                <div class="faq-ans">Aceitamos PIX, Dinheiro (informe se precisar de troco) e Cart√£o de D√©bito/Cr√©dito na entrega.</div>
            </details>
            <details>
                <summary>Posso alterar os itens?</summary>
                <div class="faq-ans">Sim! Clique no bot√£o "Personalizar" na cesta desejada. Voc√™ pode retirar at√© 30% dos itens originais e adicionar quantos quiser.</div>
            </details>
            <details>
                <summary>Qual o pedido m√≠nimo?</summary>
                <div class="faq-ans">Para personaliza√ß√£o, o valor m√≠nimo √© o pre√ßo original da cesta escolhida.</div>
            </details>
            <details>
                <summary>Onde a empresa fica?</summary>
                <div class="faq-ans">Atendemos exclusivamente online com entrega r√°pida para Cuiab√° e regi√£o.</div>
            </details>

            <div class="company-info">
                <div class="company-logo-area">
                    <div class="logo" style="width:50px; height:50px; font-size:1.5rem;">M</div>
                    <div class="company-name">Super Cestas Dona Ant√¥nia</div>
                </div>
                <div class="company-data">
                    Cuiab√° e V√°rzea Grande - MT<br>
                    CNPJ: 00.000.000/0001-00<br>
                    <strong>üìû (65) 98449-1018</strong><br>
                    <strong>üìû (65) 99815-0975</strong>
                </div>
                <div class="company-links">
                    <a href="https://wa.me/5565984491018" class="btn-social" style="background:#25D366">WhatsApp</a>
                    <a href="#" class="btn-social" style="background:#E1306C">Instagram</a>
                    <a href="https://www.google.com/maps/search/Cuiab%C3%A1" target="_blank" class="btn-social" style="background:#4285F4; grid-column: span 2;">Ver Mapa de Atendimento</a>
                </div>
            </div>
        </div>
    </dialog>

    <dialog id="zoom-modal" onclick="this.close()">
        <img id="zoom-img" src="" alt="Zoom">
    </dialog>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const CONFIG = {
            whatsapp: "5565984491018", // Telefone Principal
            maxRemovalRatio: 0.3
        };

        // --- ESTADO ---
        let DB_PRODUCTS = [];
        let DB_CESTAS = [];
        let CART = {};
        let CURRENT_CESTA = null;
        let ORIGINAL_CART_COUNTS = {};
        let ORIGINAL_TOTAL_ITEMS = 0;

        // --- INICIALIZA√á√ÉO OTIMIZADA ---
        async function init() {
            try {
                const [pRes, cRes] = await Promise.all([
                    fetch('produtos.json'),
                    fetch('produtos-cesta-basica.json')
                ]);
                const pData = await pRes.json();
                const cData = await cRes.json();

                DB_PRODUCTS = pData.filter(p => p.Situa√ß√£o === "Ativo").map(p => ({
                    id: String(p.ID),
                    name: p.Descri√ß√£o,
                    price: parseFloat(String(p.Pre√ßo).replace('R$','').trim().replace(/\./g,'').replace(',', '.')),
                    cat: p["Categoria do produto"] || "Outros",
                    img: p.imagem ? "img/" + p.imagem.split('/').pop() : null
                }));

                DB_CESTAS = cData;
                renderCestas();
            } catch (e) { 
                document.getElementById('cestas-container').innerHTML = '<p style="text-align:center; padding:20px; color:red">Erro ao carregar produtos. Verifique os arquivos JSON.</p>';
            }
        }

        function showLoader(cb) {
            const loader = document.getElementById('global-loader');
            loader.style.display = 'flex';
            // setTimeout for√ßa o browser a renderizar o loader antes de travar no processamento
            setTimeout(() => {
                cb();
                requestAnimationFrame(() => loader.style.display = 'none');
            }, 50);
        }

        // --- NAVEGA√á√ÉO ---
        function goHome() {
            document.getElementById('view-cestas').classList.add('active');
            document.getElementById('view-catalogo').classList.remove('active');
            document.getElementById('btn-back').style.display = 'none';
            document.getElementById('cart-bar').style.display = 'none';
            
            // Restaura t√≠tulo e tamanho
            const titleEl = document.getElementById('page-title');
            titleEl.innerText = "SUPER CESTAS";
            titleEl.classList.remove('small');
            
            document.getElementById('min-msg').style.display = 'none';
            CURRENT_CESTA = null;
        }

        function goCatalog(cesta) {
            showLoader(() => {
                window.scrollTo(0,0);
                document.getElementById('view-cestas').classList.remove('active');
                document.getElementById('view-catalogo').classList.add('active');
                document.getElementById('btn-back').style.display = 'block';
                document.getElementById('cart-bar').style.display = 'flex';
                
                CURRENT_CESTA = cesta;
                
                // T√≠tulo menor na personaliza√ß√£o
                const titleEl = document.getElementById('page-title');
                titleEl.innerText = cesta.nome;
                titleEl.classList.add('small');
                
                populateCartFromCesta(cesta);
                renderCatalog();
                updateCartBar();
            });
        }

        // --- RENDERIZADORES ---
        function renderCestas() {
            const container = document.getElementById('cestas-container');
            container.innerHTML = "";
            
            DB_CESTAS.forEach(c => {
                const el = document.createElement('div');
                el.className = 'cesta-card';
                // Lazy loading nativo e placeholder SVG super leve
                const placeholder = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23eee'%3E%3Crect width='100' height='100'/%3E%3C/svg%3E";
                const imgSrc = c.imagem || placeholder;
                
                el.innerHTML = `
                    <div class="cesta-img-container">
                        <img src="${imgSrc}" class="cesta-img" loading="lazy" decoding="async" alt="${c.nome}" onclick="zoom('${imgSrc}')">
                    </div>
                    <div class="cesta-body">
                        <div class="cesta-nome">${c.nome}</div>
                        <div class="cesta-info">${c.produtos.length} Itens</div>
                        <div class="cesta-preco">${formatMoney(c.preco)}</div>
                        <div class="cesta-actions">
                            <button class="btn-cesta btn-detalhes" onclick="openDetails('${c.id}')">Ver Itens</button>
                            <button class="btn-cesta btn-personalize" onclick="startPersonalize('${c.id}')">Personalizar</button>
                            <button class="btn-cesta btn-direct" onclick="directOrder('${c.id}')">Pedir no Zap</button>
                        </div>
                    </div>`;
                container.appendChild(el);
            });
        }

        function renderCatalog() {
            const container = document.getElementById('catalogo-container');
            container.innerHTML = "";
            const placeholder = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='%23f5f5f5'%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='20' fill='%23ccc'%3EIMG%3C/text%3E%3C/svg%3E";

            // 1. TOPO: ITENS DA CESTA (3 COLUNAS)
            if(CURRENT_CESTA) {
                container.innerHTML += `<div class="cesta-header-msg">Edite os itens da sua cesta abaixo</div>`;
                
                const topGrid = document.createElement('div');
                topGrid.className = 'cesta-items-grid';
                
                Object.keys(ORIGINAL_CART_COUNTS).forEach(id => {
                    const p = DB_PRODUCTS.find(x => x.id === id);
                    if(!p) return;
                    const qty = CART[id] || 0;
                    const imgSrc = p.img || placeholder;
                    
                    topGrid.innerHTML += `
                    <div class="item-topo">
                        <img src="${imgSrc}" loading="lazy" decoding="async" onclick="zoom('${imgSrc}')">
                        <div class="qty-selector-h">
                            <button class="btn-h" onclick="changeQty('${id}', -1)">-</button>
                            <span class="val-h qty-display-${id}">${qty}</span>
                            <button class="btn-h" onclick="changeQty('${id}', 1)">+</button>
                        </div>
                    </div>`;
                });
                container.appendChild(topGrid);
            }

            // 2. BAIXO: CAT√ÅLOGO
            container.innerHTML += `<div class="cat-divisor">ADICIONAR OUTROS PRODUTOS</div>`;

            const grouped = {};
            DB_PRODUCTS.forEach(p => {
                let parts = p.cat.split('>>');
                let m = parts[0].trim() || "Geral";
                let s = parts[1] ? parts[1].trim() : "Diversos";
                if(!grouped[m]) grouped[m] = {};
                if(!grouped[m][s]) grouped[m][s] = [];
                grouped[m][s].push(p);
            });

            for(const m in grouped) {
                const sec = document.createElement('div');
                sec.innerHTML = `<div class="cat-titulo">${m}</div>`;
                for(const s in grouped[m]) {
                    const sub = document.createElement('div');
                    sub.innerHTML = `<div class="subcat-titulo">${s}</div>`;
                    const list = document.createElement('div');
                    list.className = 'produto-lista';
                    
                    grouped[m][s].forEach(p => {
                        const q = CART[p.id] || 0;
                        const cardClass = q > 0 ? 'produto-card selected' : 'produto-card';
                        const imgSrc = p.img || placeholder;
                        
                        list.innerHTML += `
                        <div class="${cardClass}" id="card-${p.id}">
                            <img src="${imgSrc}" class="produto-img" loading="lazy" decoding="async" onclick="zoom('${imgSrc}')">
                            <div class="produto-info">
                                <div class="produto-nome">${p.name}</div>
                                <div class="produto-preco">${formatMoney(p.price)}</div>
                            </div>
                            <div class="controles-v">
                                <button class="btn-v btn-add-v" onclick="changeQty('${p.id}', 1)">+</button>
                                <span class="qty-v qty-display-${p.id}">${q}</span>
                                <button class="btn-v" onclick="changeQty('${p.id}', -1)">-</button>
                            </div>
                        </div>`;
                    });
                    sub.appendChild(list);
                    sec.appendChild(sub);
                }
                container.appendChild(sec);
            }
        }

        // --- L√ìGICA DE NEG√ìCIO ---
        function populateCartFromCesta(cesta) {
            CART = {};
            ORIGINAL_CART_COUNTS = {};
            ORIGINAL_TOTAL_ITEMS = 0;
            cesta.produtos.forEach(str => {
                const [qtd, id] = str.split('x ');
                const cleanId = id.trim();
                const qInt = parseInt(qtd);
                if(DB_PRODUCTS.find(x => x.id === cleanId)) {
                    CART[cleanId] = qInt;
                    ORIGINAL_CART_COUNTS[cleanId] = qInt;
                    ORIGINAL_TOTAL_ITEMS += qInt;
                }
            });
        }

        function changeQty(id, delta) {
            if(!CART[id]) CART[id] = 0;
            const newQty = CART[id] + delta;
            
            // Regra 30%
            if (delta < 0 && ORIGINAL_CART_COUNTS[id]) {
                let currentOriginalsCount = 0;
                for(let key in CART) {
                    if(ORIGINAL_CART_COUNTS[key]) {
                         let q = (key === id) ? newQty : CART[key];
                         let originalCap = ORIGINAL_CART_COUNTS[key];
                         currentOriginalsCount += Math.min(q, originalCap);
                    }
                }
                const minAllowed = Math.ceil(ORIGINAL_TOTAL_ITEMS * (1 - CONFIG.maxRemovalRatio));
                if (currentOriginalsCount < minAllowed) {
                    alert(`‚ö†Ô∏è Voc√™ s√≥ pode retirar at√© 30% dos itens originais da cesta.`);
                    return;
                }
            }

            if(newQty < 0) return;
            CART[id] = newQty;

            // Update UI
            document.querySelectorAll(`.qty-display-${id}`).forEach(e => e.innerText = newQty);
            const card = document.getElementById(`card-${id}`);
            if(card) {
                if(newQty > 0) card.classList.add('selected');
                else card.classList.remove('selected');
            }
            updateCartBar();
        }

        function updateCartBar() {
            let currentSum = 0, originalSum = 0;
            for(let id in CART) {
                const p = DB_PRODUCTS.find(x => x.id === id);
                if(p) currentSum += p.price * CART[id];
            }
            for(let id in ORIGINAL_CART_COUNTS) {
                const p = DB_PRODUCTS.find(x => x.id === id);
                if(p) originalSum += p.price * ORIGINAL_CART_COUNTS[id];
            }
            
            // Valor Cesta + Diferen√ßa (Itens add - Itens rem)
            window.finalPrice = CURRENT_CESTA.preco + (currentSum - originalSum);
            
            // Valida√ß√£o M√≠nimo
            const msg = document.getElementById('min-msg');
            const btn = document.getElementById('btn-finish');
            
            if(window.finalPrice < CURRENT_CESTA.preco) {
                msg.style.display = 'block';
                msg.innerHTML = `Valor m√≠nimo para esta cesta: <b>${formatMoney(CURRENT_CESTA.preco)}</b>`;
                btn.disabled = true;
            } else {
                msg.style.display = 'none';
                btn.disabled = false;
            }

            document.getElementById('total-display').innerText = formatMoney(window.finalPrice);
        }

        // --- INTERA√á√ïES ---
        function openDetails(id) {
            const c = DB_CESTAS.find(x => x.id === id);
            const list = document.getElementById('detail-list');
            list.innerHTML = "";
            window.modalCestaId = id;
            c.produtos.forEach(s => {
                const [q, pid] = s.split('x ');
                const p = DB_PRODUCTS.find(x => x.id === pid.trim());
                if(p) {
                    list.innerHTML += `
                    <div class="rev-item">
                        <span class="rev-qty">${q}</span>
                        <span class="rev-nome">${p.name}</span>
                    </div>`;
                }
            });
            document.getElementById('modal-details').showModal();
        }

        function openCheckout() {
            const list = document.getElementById('checkout-list');
            list.innerHTML = "";
            for(const id in CART) {
                if(CART[id] > 0) {
                    const p = DB_PRODUCTS.find(x => x.id === id);
                    list.innerHTML += `
                        <div class="rev-item">
                            <span class="rev-qty">${CART[id]}</span>
                            <span class="rev-nome">${p.name}</span>
                        </div>`;
                }
            }
            document.getElementById('checkout-total').innerText = formatMoney(window.finalPrice);
            document.getElementById('modal-checkout').showModal();
        }

        function sendWhatsapp(e) {
            e.preventDefault();
            const name = document.getElementById('cust-name').value;
            const addr = document.getElementById('cust-addr').value;
            const pay = document.getElementById('cust-pay').value;

            let msg = `*PEDIDO PERSONALIZADO - ${CURRENT_CESTA.nome}*\n`;
            msg += `------------------------------\n`;
            msg += `üë§ *${name}*\nüìç ${addr}\nüí∞ ${pay}\n`;
            msg += `------------------------------\n\n*ITENS:* \n`;
            
            for(const id in CART) {
                if(CART[id] > 0) {
                    const p = DB_PRODUCTS.find(x => x.id === id);
                    msg += `üîπ ${CART[id]}x ${p.name}\n`;
                }
            }
            msg += `\n------------------------------\n`;
            msg += `*VALOR FINAL: ${formatMoney(window.finalPrice)}*`;

            window.location.href = `https://wa.me/${CONFIG.whatsapp}?text=${encodeURIComponent(msg)}`;
        }

        function directOrder(id) {
            const c = DB_CESTAS.find(x => x.id === id);
            const msg = `Ol√°, gostaria de encomendar a *${c.nome}* pelo valor padr√£o de ${formatMoney(c.preco)}.`;
            window.location.href = `https://wa.me/${CONFIG.whatsapp}?text=${encodeURIComponent(msg)}`;
        }

        function orderDirectFromModal() { if(window.modalCestaId) directOrder(window.modalCestaId); }
        function startPersonalize(id) { goCatalog(DB_CESTAS.find(c => c.id === id)); }
        function formatMoney(v) { return v.toLocaleString('pt-BR', { style:'currency', currency:'BRL'}); }
        function zoom(src) { document.getElementById('zoom-img').src = src; document.getElementById('zoom-modal').showModal(); }

        init();
    </script>
</body>
</html>
