<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="description" content="Cestas B√°sicas Dona Ant√¥nia. Entrega Gr√°tis Cuiab√° e VG.">
    <meta name="theme-color" content="#ffffff">
    <title>Dona Ant√¥nia | Cestas B√°sicas</title>

    <style>
        /* --- CORE: SYSTEM & RESET --- */
        :root {
            --primary: #dc2626; --primary-dark: #b91c1c;
            --text-main: #171717; --text-light: #525252; --text-muted: #737373;
            --bg-body: #ffffff; --bg-surface: #f8fafc; --bg-highlight: #eff6ff;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --nav-height: 60px;
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: var(--font-stack); background: var(--bg-body); color: var(--text-main); line-height: 1.5; padding-bottom: calc(var(--nav-height) + 20px); }
        
        /* --- UTILITIES --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; width: 100%; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .w-full { width: 100%; }
        
        button { cursor: pointer; border: none; background: none; font-family: inherit; padding: 0; }
        img { display: block; max-width: 100%; height: auto; content-visibility: auto; }

        /* --- COMPONENTS --- */
        /* Header */
        header { position: sticky; top: 0; z-index: 50; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border-bottom: 1px solid var(--border); height: 60px; display: flex; align-items: center; }
        .logo { font-size: 1.1rem; font-weight: 800; color: var(--text-main); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        .logo-mark { width: 32px; height: 32px; background: var(--primary); color: white; border-radius: 50%; display: grid; place-items: center; font-size: 0.8rem; }
        .location-badge { font-size: 0.75rem; font-weight: 600; padding: 4px 12px; background: var(--bg-surface); border-radius: 99px; color: var(--text-light); border: 1px solid var(--border); }

        /* Hero */
        .hero { padding: 40px 0; text-align: center; border-bottom: 1px solid var(--bg-surface); }
        .hero h1 { font-size: 2rem; line-height: 1.1; margin: 0 0 16px 0; letter-spacing: -0.03em; }
        .hero span { color: var(--primary); }
        .hero p { color: var(--text-light); max-width: 400px; margin: 0 auto 24px; }
        .btn-cta { background: var(--primary); color: white; font-weight: 700; padding: 14px 32px; border-radius: 99px; font-size: 1rem; box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); transition: transform 0.2s; }
        .btn-cta:active { transform: scale(0.96); }

        /* Grids */
        .grid-home { display: grid; grid-template-columns: 1fr; gap: 24px; padding: 20px 0; }
        @media(min-width: 640px) { .grid-home { grid-template-columns: repeat(2, 1fr); } }
        @media(min-width: 1024px) { .grid-home { grid-template-columns: repeat(4, 1fr); } }

        /* Card: Home */
        .card-home { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: white; transition: transform 0.2s; }
        .card-home:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .ch-img { aspect-ratio: 1/1; width: 100%; object-fit: contain; padding: 16px; background: white; }
        .ch-body { padding: 16px; text-align: center; border-top: 1px solid var(--bg-surface); }
        .ch-price { font-size: 1.5rem; font-weight: 800; color: var(--primary); display: block; margin: 8px 0 16px; }
        .btn-outline { width: 100%; border: 1px solid var(--border); padding: 10px; border-radius: 99px; font-weight: 600; color: var(--text-main); margin-top: 8px; }
        .btn-primary { width: 100%; background: var(--text-main); color: white; padding: 12px; border-radius: 99px; font-weight: 600; }

        /* --- CUSTOMIZER APP MODE --- */
        #view-customizer { position: fixed; inset: 0; background: var(--bg-surface); z-index: 100; overflow-y: auto; padding-bottom: 140px; }
        .app-header { background: white; padding: 12px 16px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-sm); }
        .btn-back { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); display: grid; place-items: center; font-size: 1.2rem; background: white; flex-shrink: 0; }
        
        .search-bar { flex: 1; position: relative; }
        .search-input { width: 100%; height: 44px; padding: 0 40px 0 16px; border-radius: 99px; border: 1px solid var(--border); background: var(--bg-surface); font-size: 1rem; -webkit-appearance: none; }
        .search-input:focus { outline: 2px solid var(--primary); border-color: transparent; }
        
        .app-layout { display: grid; grid-template-columns: 100px 1fr; gap: 12px; max-width: 1200px; margin: 20px auto 0; padding: 0 8px; align-items: start; }
        @media(min-width: 768px) { .app-layout { grid-template-columns: 240px 1fr; padding: 0 16px; gap: 24px; } }

        /* Sidebar Nav */
        .side-nav { position: sticky; top: 80px; display: flex; flex-direction: column; gap: 8px; max-height: 80vh; overflow-y: auto; padding-bottom: 20px; }
        .sn-item { font-size: 0.7rem; font-weight: 600; padding: 10px 4px; text-align: center; border: 1px solid var(--border); background: white; border-radius: 8px; color: var(--text-light); transition: all 0.2s; word-break: break-word; }
        .sn-item.active { background: var(--text-main); color: white; border-color: var(--text-main); transform: scale(1.05); }
        @media(min-width: 768px) { .sn-item { text-align: left; padding: 12px 16px; font-size: 0.9rem; } }

        /* Product Grid */
        .section-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); margin: 24px 0 12px; font-weight: 700; padding-left: 4px; }
        .grid-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; content-visibility: auto; contain-intrinsic-size: 1px 300px; }
        
        .card-prod { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 10px; display: flex; flex-direction: column; position: relative; }
        .cp-tag { position: absolute; top: 0; left: 0; background: #16a34a; color: white; font-size: 0.6rem; font-weight: 700; padding: 2px 8px; border-radius: 8px 0 8px 0; z-index: 1; }
        .cp-img-box { width: 100%; aspect-ratio: 1/1; display: grid; place-items: center; margin-bottom: 8px; }
        .cp-img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
        .cp-title { font-size: 0.8rem; font-weight: 600; line-height: 1.3; color: var(--text-main); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.6em; }
        .cp-meta { margin-top: auto; }
        .cp-price { font-size: 1rem; font-weight: 800; color: var(--text-main); }
        .cp-old { font-size: 0.75rem; text-decoration: line-through; color: #a1a1aa; margin-right: 4px; }
        .cp-offer { color: var(--primary); }
        
        /* Qty Controls */
        .btn-add { width: 100%; background: var(--primary); color: white; font-weight: 700; font-size: 0.8rem; height: 32px; border-radius: 99px; margin-top: 8px; }
        .qty-ctrl { display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--primary); border-radius: 99px; height: 32px; margin-top: 8px; background: white; }
        .qc-btn { width: 32px; height: 100%; font-size: 1.2rem; display: grid; place-items: center; color: var(--primary); }
        .qc-val { font-weight: 700; font-size: 0.9rem; }

        /* Top Horizontal List (Included) */
        .h-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 4px 4px 16px; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
        .h-scroll::-webkit-scrollbar { display: none; }
        .h-scroll .card-prod { min-width: 140px; scroll-snap-align: start; border-color: #bfdbfe; background: #eff6ff; }

        /* Bottom Bars */
        .bar-checkout { position: fixed; bottom: 61px; left: 0; right: 0; background: white; padding: 12px 16px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 40; box-shadow: 0 -4px 12px rgba(0,0,0,0.05); }
        .bc-total { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; display: flex; flex-direction: column; }
        .bc-val { font-size: 1.25rem; font-weight: 800; color: var(--text-main); }
        .btn-check { background: #16a34a; color: white; padding: 0 24px; height: 44px; border-radius: 99px; font-weight: 700; font-size: 1rem; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(22, 163, 74, 0.3); }

        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: rgba(255,255,255,0.98); border-top: 1px solid var(--border); display: grid; grid-template-columns: repeat(4, 1fr); z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nb-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.65rem; color: var(--text-muted); gap: 4px; font-weight: 600; }
        .nb-item svg { width: 22px; height: 22px; stroke-width: 2px; }
        .nb-item.active { color: var(--primary); }

        /* Toasts & Modals */
        .toast-float { position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%) translateY(20px); background: #1f2937; color: white; padding: 10px 20px; border-radius: 99px; font-size: 0.85rem; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 60; white-space: nowrap; }
        .toast-float.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        dialog { border: none; border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.25); width: 90%; max-width: 400px; padding: 0; background: white; }
        dialog::backdrop { background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); }
        .d-head { padding: 16px; border-bottom: 1px solid var(--border); font-weight: 700; display: flex; justify-content: space-between; }
        .d-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .d-foot { padding: 16px; background: var(--bg-surface); border-top: 1px solid var(--border); }

        /* Loader */
        .loader { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 40px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- VIEW: HOME -->
    <div id="view-home">
        <header>
            <div class="container flex justify-between">
                <a href="#" class="logo"><span class="logo-mark">DA</span> Dona Ant√¥nia</a>
                <span class="location-badge">üìç Cuiab√° & VG</span>
            </div>
        </header>

        <section class="hero">
            <div class="container">
                <h1>A Cesta B√°sica<br><span>Ideal para Voc√™</span></h1>
                <p>Personalize com marcas l√≠deres e pague na entrega.</p>
                <button class="btn-cta" onclick="document.getElementById('products-anchor').scrollIntoView({behavior:'smooth'})">Escolher Cesta</button>
            </div>
        </section>

        <main class="container" id="products-anchor">
            <div id="home-grid" class="grid-home">
                <div class="loader"></div>
            </div>
        </main>
        
        <footer class="text-center" style="padding: 40px; color: var(--text-muted); font-size: 0.8rem;">
            &copy; 2024 Dona Ant√¥nia Alimentos
        </footer>
    </div>

    <!-- VIEW: CUSTOMIZER (APP) -->
    <div id="view-customizer" class="hidden">
        <div class="app-header">
            <button class="btn-back" onclick="App.goHome()">‚ùÆ</button>
            <div class="search-bar">
                <input type="text" id="search" class="search-input" placeholder="Buscar produto..." oninput="App.handleSearch(this.value)">
            </div>
        </div>

        <div class="app-layout">
            <nav id="side-nav" class="side-nav"></nav>
            
            <main id="app-main">
                <div class="section-title">üì¶ Sua Cesta (Inclusos)</div>
                <div id="list-included" class="h-scroll"></div>
                
                <div id="list-extras"></div>
            </main>
        </div>

        <!-- Checkout Bar -->
        <div class="bar-checkout">
            <div class="bc-total">Total Estimado<span class="bc-val" id="total-display">R$ 0,00</span></div>
            <button class="btn-check" onclick="App.openCheckout()">
                Encomendar <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h14M12 5l7 7-7 7"/></svg>
            </button>
        </div>

        <!-- Bottom Nav -->
        <nav class="nav-bottom">
            <button class="nb-item active" onclick="App.filterMode('all', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/></svg>
                Tudo
            </button>
            <button class="nb-item" onclick="App.filterMode('offers', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Ofertas
            </button>
            <button class="nb-item" onclick="App.filterMode('top', this)">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                Top
            </button>
            <button class="nb-item" onclick="document.getElementById('modal-faq').showModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Ajuda
            </button>
        </nav>
    </div>

    <!-- UI: Toasts & Dialogs -->
    <div id="toast" class="toast-float">Atualizado</div>

    <!-- Dialog: Checkout -->
    <dialog id="modal-checkout">
        <div class="d-head"><span>Resumo</span> <button onclick="this.closest('dialog').close()">‚úï</button></div>
        <div class="d-body">
            <ul id="co-list" style="list-style:none; padding:0; margin-bottom:20px; border:1px solid var(--border); border-radius:8px; overflow:hidden;"></ul>
            <div class="flex justify-between font-bold text-xl" style="color:var(--primary)">
                <span>Total</span> <span id="co-total-val">R$ 0,00</span>
            </div>
            <label style="display:block; margin-top:20px; font-weight:600; font-size:0.9rem;">Pagamento:</label>
            <select id="pay-method" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; margin-top:5px; background:white;">
                <option>Pix (Na entrega)</option><option>Dinheiro</option><option>Cart√£o Cr√©dito/D√©bito</option><option>Vale Alimenta√ß√£o</option>
            </select>
        </div>
        <div class="d-foot">
            <button class="btn-check w-full justify-center" onclick="App.sendWhatsApp()">Enviar Pedido</button>
        </div>
    </dialog>

    <!-- Dialog: FAQ -->
    <dialog id="modal-faq">
        <div class="d-head"><span>D√∫vidas</span> <button onclick="this.closest('dialog').close()">‚úï</button></div>
        <div class="d-body">
            <details class="mb-4"><summary class="font-bold cursor-pointer py-2">Entrega Gr√°tis?</summary><p class="text-sm text-gray-600 mt-1">Sim, para compras acima de R$ 85,00 em Cuiab√° e V√°rzea Grande.</p></details>
            <details class="mb-4"><summary class="font-bold cursor-pointer py-2">Formas de Pagamento</summary><p class="text-sm text-gray-600 mt-1">Aceitamos Pix, Dinheiro, Cart√µes e Vale Alimenta√ß√£o na entrega.</p></details>
            <details><summary class="font-bold cursor-pointer py-2">Prazo de Entrega</summary><p class="text-sm text-gray-600 mt-1">Entregamos no dia seguinte ao pedido (Seg-S√°b).</p></details>
        </div>
    </dialog>

    <script>
        const CONSTANTS = { PHONE: "5565996813588" };
        
        const App = {
            data: [], cart: {}, currentBasket: null,
            
            async init() {
                try {
                    const res = await fetch('produtos/produtos.json');
                    const raw = await res.json();
                    // Otimiza√ß√£o: Mapeamento √∫nico na inicializa√ß√£o
                    this.data = raw.map(p => ({
                        ...p,
                        id: String(p.id),
                        valor: parseFloat(p.valor || 0),
                        offerPrice: parseFloat(p.Valor_Oferta || 0),
                        isOffer: p.Oferta?.toLowerCase() === 'sim',
                        isTop: p.Mais_Vendido?.toLowerCase() === 'sim',
                        cat: (p.categoria || 'OUTROS').split('>')[0].trim().toUpperCase(),
                        sub: (p.categoria || '').split('>')[1]?.trim() || (p.categoria || '').split('>')[0].trim(),
                        img: p.imagem ? (p.imagem.includes('/') ? `img/produtos/${p.imagem.split('/').pop()}` : `img/produtos/${p.imagem}`) : 'https://placehold.co/150?text=IMG'
                    }));
                    this.renderHome();
                } catch(e) { console.error(e); document.getElementById('home-grid').innerHTML = '<p class="text-center w-full">Erro ao carregar.</p>'; }
            },

            renderHome() {
                const baskets = this.data.filter(p => p.cat.includes('CESTA'));
                document.getElementById('home-grid').innerHTML = baskets.map(p => {
                    const price = p.isOffer ? p.offerPrice : p.valor;
                    return `
                    <div class="card-home">
                        <img src="${p.img}" class="ch-img" alt="${p.nome}" loading="lazy">
                        <div class="ch-body">
                            <h3 style="font-size:1.1rem; margin:0; line-height:1.2;">${p.nome}</h3>
                            <span class="ch-price">R$ ${price.toFixed(2).replace('.',',')}</span>
                            <button class="btn-primary" onclick="App.openApp('${p.id}')">Personalizar</button>
                        </div>
                    </div>`;
                }).join('');
            },

            openApp(id) {
                this.currentBasket = this.data.find(x => x.id === id);
                this.cart = {}; // Reset logic simpler
                
                // Pre-fill logic based on JSON structure
                if(this.currentBasket.items) {
                    this.currentBasket.items.forEach(i => {
                        const match = this.data.find(p => !p.cat.includes('CESTA') && p.nome.toLowerCase().includes(i.nome.toLowerCase()));
                        if(match) this.cart[match.id] = (this.cart[match.id]||0) + (parseInt(i.qtd)||1);
                    });
                }
                
                document.getElementById('view-home').classList.add('hidden');
                document.getElementById('view-customizer').classList.remove('hidden');
                window.scrollTo(0,0);
                
                this.renderSidebar();
                this.renderLists();
            },

            goHome() {
                document.getElementById('view-customizer').classList.add('hidden');
                document.getElementById('view-home').classList.remove('hidden');
            },

            renderSidebar() {
                // Unique categories logic
                const cats = [...new Set(this.data.filter(p => !p.cat.includes('CESTA')).map(p => p.cat))];
                document.getElementById('side-nav').innerHTML = cats.map(c => 
                    `<button class="sn-item" onclick="App.scrollToCat('${c}', this)">${c}</button>`
                ).join('');
            },

            renderLists(filterFn = null) {
                const extrasBox = document.getElementById('list-extras');
                const incBox = document.getElementById('list-included');
                
                // 1. Included Items (Top)
                const incIds = Object.keys(this.cart);
                incBox.innerHTML = incIds.length ? incIds.map(id => {
                    return this.cardHTML(this.data.find(x => x.id === id));
                }).join('') : '<div class="text-center w-full p-4 text-sm text-gray-400">Cesta vazia</div>';

                // 2. Extras (Bottom) - Using DocumentFragment for performance
                const products = this.data.filter(p => !p.cat.includes('CESTA'));
                const filtered = filterFn ? products.filter(filterFn) : products;
                
                // Group by Category
                const groups = filtered.reduce((acc, p) => {
                    if(!acc[p.cat]) acc[p.cat] = [];
                    acc[p.cat].push(p);
                    return acc;
                }, {});

                let html = '';
                for (const [cat, items] of Object.entries(groups)) {
                    html += `<div id="cat-${cat}" class="section-title">${cat}</div>
                             <div class="grid-products">${items.map(p => this.cardHTML(p)).join('')}</div>`;
                }
                extrasBox.innerHTML = html || '<div class="text-center p-8">Nada encontrado.</div>';
                
                this.updateTotal();
            },

            cardHTML(p) {
                if(!p) return '';
                const qty = this.cart[p.id] || 0;
                const price = p.isOffer ? p.offerPrice : p.valor;
                
                return `
                <div class="card-prod">
                    ${p.isOffer ? '<span class="cp-tag">OFERTA</span>' : ''}
                    <div class="cp-img-box"><img src="${p.img}" class="cp-img" loading="lazy"></div>
                    <div class="cp-title">${p.nome}</div>
                    <div class="cp-meta">
                        <div class="cp-price">
                            ${p.isOffer ? `<span class="cp-old">R$${p.valor.toFixed(0)}</span>` : ''}
                            <span class="${p.isOffer?'cp-offer':''}">${price.toFixed(2).replace('.',',')}</span>
                        </div>
                        ${qty === 0 
                            ? `<button class="btn-add" onclick="App.mod('${p.id}', 1)">ADICIONAR</button>`
                            : `<div class="qty-ctrl">
                                <button class="qc-btn" onclick="App.mod('${p.id}', -1)">‚àí</button>
                                <span class="qc-val">${qty}</span>
                                <button class="qc-btn" onclick="App.mod('${p.id}', 1)">+</button>
                               </div>`
                        }
                    </div>
                </div>`;
            },

            mod(id, delta) {
                const cur = this.cart[id] || 0;
                const next = cur + delta;
                if(next <= 0) delete this.cart[id];
                else this.cart[id] = next;
                
                // Smart Re-render: Only refresh if 0->1 or 1->0 (layout change), else simpler DOM update is possible but full render is safer/easier in vanilla for now without Virtual DOM
                this.renderLists(this.currentFilter); 
                this.updateTotal();
            },

            updateTotal() {
                let sum = 0;
                for(let id in this.cart) {
                    const p = this.data.find(x => x.id === id);
                    if(p) sum += (p.isOffer ? p.offerPrice : p.valor) * this.cart[id];
                }
                // Logic: Base price of Basket implies some pre-included value. 
                // Maintaining simplified logic: Just sum of items vs Basket Base Price logic from original?
                // Original logic: max(calculated, basket_price). Keeping it.
                const total = Math.max(sum, this.currentBasket.valor);
                
                const fmt = `R$ ${total.toFixed(2).replace('.',',')}`;
                document.getElementById('total-display').innerText = fmt;
                document.getElementById('co-total-val').innerText = fmt;
            },

            // --- Navigation & Filters ---
            currentFilter: null,
            
            filterMode(mode, btn) {
                document.querySelectorAll('.nb-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                if(mode === 'all') this.currentFilter = null;
                else if(mode === 'offers') this.currentFilter = p => p.isOffer;
                else if(mode === 'top') this.currentFilter = p => p.isTop;
                
                this.renderLists(this.currentFilter);
                window.scrollTo({top:0, behavior:'smooth'});
            },

            scrollToCat(cat, btn) {
                document.querySelectorAll('.sn-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                const el = document.getElementById(`cat-${cat}`);
                if(el) el.scrollIntoView({behavior: 'smooth', block: 'start'});
            },

            handleSearch(val) {
                const term = val.toLowerCase();
                this.renderLists(term ? p => p.nome.toLowerCase().includes(term) : null);
            },

            // --- Checkout ---
            openCheckout() {
                const list = document.getElementById('co-list');
                list.innerHTML = Object.keys(this.cart).map(id => {
                    const p = this.data.find(x => x.id === id);
                    return `<li style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; font-size:0.85rem;">
                        <span>${this.cart[id]}x ${p.nome}</span>
                    </li>`;
                }).join('');
                document.getElementById('modal-checkout').showModal();
            },

            sendWhatsApp() {
                const method = document.getElementById('pay-method').value;
                const total = document.getElementById('co-total-val').innerText;
                let msg = `*PEDIDO: ${this.currentBasket.nome}*\n\n`;
                for(let id in this.cart) {
                    const p = this.data.find(x => x.id === id);
                    msg += `[${this.cart[id]}] ${p.nome}\n`;
                }
                msg += `\n*TOTAL: ${total}*\nPgto: ${method}`;
                window.open(`https://api.whatsapp.com/send?phone=${CONSTANTS.PHONE}&text=${encodeURIComponent(msg)}`, '_blank');
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
