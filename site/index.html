<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Super Cestas B√°sicas Dona Ant√¥nia">
    <meta name="theme-color" content="#ffffff">
    <title>Super Cestas B√°sicas Dona Ant√¥nia</title>
    <style>
        /* --- VARI√ÅVEIS --- */
        :root {
            --c-p: #0f172a;       /* Prim√°ria */
            --c-s: #334155;       /* Secund√°ria */
            --c-t: #64748b;       /* Terci√°ria */
            --c-a: #ea580c;       /* Acento */
            --c-ok: #15803d;      /* Sucesso */
            --c-err: #b91c1c;     /* Erro */
            --c-bg: #f8fafc;      /* Fundo */
            --c-bd: #cbd5e1;      /* Bordas */
            --font: 'Inter', system-ui, -apple-system, sans-serif;
            --rad: 16px;
            --sh-card: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: var(--font);
            background: var(--c-bg);
            color: var(--c-p);
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            overflow: hidden;
            /* LAYOUT GRID FIXO: Header | Main (Expans√≠vel) | Controles | Checkout */
            display: grid;
            grid-template-rows: auto 1fr auto auto; 
        }

        /* --- 1. HEADER --- */
        .header-wrapper {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            border-bottom: 1px solid var(--c-bd);
            z-index: 100;
        }
        header { display: flex; align-items: center; justify-content: space-between; padding: 10px 15px; height: 60px; }
        .logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--c-bd); }
        .page-title { font-size: 0.95rem; font-weight: 800; line-height: 1.1; color: var(--c-p); margin-left: 10px; }
        .header-left { display: flex; align-items: center; }
        .btn-header { width: 38px; height: 38px; border-radius: 50%; background: #fff; border: 1px solid var(--c-bd); display: flex; align-items: center; justify-content: center; color: var(--c-s); margin-left: 8px; }

        /* --- 2. MAIN (CARROSSEL) --- */
        main {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Centraliza carrossel verticalmente */
            overflow: hidden;
        }

        /* T√çTULO DA SE√á√ÉO ATIVA */
        .active-section-title {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--c-p);
            text-transform: uppercase;
            margin-bottom: 10px;
            padding: 0 20px;
        }

        /* CONTAINER DO CARROSSEL */
        .carousel-container { width: 100%; }
        .carousel-track {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 25px 30px; /* Padding extra embaixo para sombra */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            align-items: stretch; /* Cards esticam para mesma altura */
        }
        .carousel-track::-webkit-scrollbar { display: none; }

        /* --- CARDS --- */
        
        /* CARD PRODUTO (Verticalmente espa√ßado) */
        .prod-card {
            flex: 0 0 42vw; /* ~2.3 cards na tela */
            max-width: 200px;
            background: #fff;
            border-radius: var(--rad);
            border: 1px solid var(--c-bd);
            box-shadow: var(--sh-card);
            padding: 12px;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Distribui espa√ßo */
            height: auto;
            min-height: 280px; /* Garante altura boa */
        }
        
        .prod-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            mix-blend-mode: multiply;
            margin-bottom: 10px;
        }

        .prod-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .prod-name {
            font-size: 0.85rem;
            font-weight: 600;
            line-height: 1.3;
            color: var(--c-p);
            /* Limite 4 linhas */
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .prod-price {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--c-a);
            margin-top: auto; /* Empurra para baixo */
            margin-bottom: 10px;
        }

        /* CARD CESTA (Imagem 1:1, Largo) */
        .cesta-card {
            flex: 0 0 75vw; /* 75% da tela */
            max-width: 400px;
            background: #fff;
            border-radius: var(--rad);
            border: 1px solid var(--c-bd);
            box-shadow: var(--sh-card);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .cesta-img {
            width: 100%;
            aspect-ratio: 1/1; /* QUADRADO 1:1 */
            object-fit: cover;
            background: #e2e8f0;
        }
        .cesta-body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
            justify-content: center;
        }
        .cesta-name { font-size: 1.1rem; font-weight: 800; color: var(--c-p); }
        .cesta-price { font-size: 1.3rem; font-weight: 900; color: var(--c-a); }
        .btn-ver-cesta {
            background: var(--c-p); color: #fff;
            border-radius: 8px; font-weight: 700;
            padding: 10px; margin-top: 5px; font-size: 0.9rem;
        }

        /* CONTROLES DE QUANTIDADE (FIXED) */
        .btn-add-big {
            width: 100%; height: 40px;
            background: #fff; border: 1px solid var(--c-bd);
            border-radius: 8px; font-size: 1.5rem; color: var(--c-s);
            display: flex; align-items: center; justify-content: center;
            transition: 0.1s;
        }
        .btn-add-big:active { background: var(--c-p); color: #fff; }

        .qty-control {
            display: flex; align-items: center; justify-content: space-between;
            background: #f1f5f9; border: 1px solid var(--c-bd);
            border-radius: 8px; height: 40px; padding: 2px;
        }
        .btn-qty {
            width: 34px; height: 100%;
            background: #fff; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.2rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .qty-val { font-weight: 700; flex-grow: 1; text-align: center; font-size: 1rem; }

        /* --- 3. CONTROLES INFERIORES (CATEGORIAS + BUSCA) --- */
        .bottom-controls {
            background: rgba(255,255,255,0.98);
            border-top: 1px solid var(--c-bd);
            padding: 12px 0;
            display: flex; flex-direction: column; gap: 12px;
            z-index: 90;
        }
        
        /* STORIES CATEGORIAS */
        .stories-track {
            display: flex; gap: 10px; overflow-x: auto;
            padding: 0 15px; scrollbar-width: none;
        }
        .story-item {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            width: 70px; flex-shrink: 0; cursor: pointer;
            opacity: 0.6; transition: 0.2s;
        }
        .story-item.active { opacity: 1; transform: scale(1.05); }
        
        .story-circle {
            width: 56px; height: 56px; border-radius: 50%;
            background: #fff; border: 2px solid var(--c-bd);
            padding: 2px; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .story-item.active .story-circle { border-color: var(--c-a); box-shadow: 0 0 0 2px rgba(234,88,12,0.15); }
        .story-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .story-icon-fixed { font-size: 1.5rem; }
        .story-name { font-size: 0.65rem; font-weight: 700; text-align: center; line-height: 1.1; }

        /* BUSCA */
        .search-wrapper { padding: 0 15px; }
        .search-input {
            width: 100%; padding: 10px 40px 10px 15px;
            border-radius: 10px; border: 1px solid var(--c-bd);
            background: #f8fafc url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E") no-repeat right 12px center;
        }

        /* --- 4. CHECKOUT BAR --- */
        .checkout-bar {
            background: #fff;
            border-top: 1px solid var(--c-bd);
            padding: 10px 15px;
            display: flex; align-items: center; gap: 10px;
            z-index: 100;
        }
        .info-col { display: flex; flex-direction: column; }
        .lbl-total { font-size: 0.65rem; font-weight: 800; color: var(--c-s); text-transform: uppercase; }
        .val-total { font-size: 1.2rem; font-weight: 900; color: var(--c-p); }
        .btn-checkout {
            flex-grow: 1; background: #16a34a; color: #fff;
            border-radius: 10px; padding: 12px;
            font-weight: 800; font-size: 1rem;
            box-shadow: 0 4px 10px rgba(22,163,74,0.25);
        }
        .btn-trash {
            width: 44px; height: 44px; border-radius: 50%;
            background: #fef2f2; border: 1px solid #fecaca;
            color: var(--c-err); font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- MODAIS & EXTRAS --- */
        dialog { border: none; border-radius: 20px; width: 90%; max-width: 400px; padding: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        dialog::backdrop { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        
        #modal-image-zoom { background: transparent; box-shadow: none; padding: 0; width: 100%; height: 100%; max-width: none; max-height: none; z-index: 5000; }
        #modal-image-zoom img { width: 100%; height: 100%; object-fit: contain; }
        .close-zoom { position: absolute; top: 20px; right: 20px; background: #fff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; z-index: 5001; cursor: pointer; }

        .btn-modal { width: 100%; padding: 12px; border-radius: 10px; margin-bottom: 8px; font-weight: 700; cursor: pointer; }
        .btn-pri { background: var(--c-p); color: #fff; }
        .btn-sec { background: #fff; border: 1px solid var(--c-bd); color: var(--c-s); }
        
        #toast-container { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; pointer-events: none; text-align: center; }
        .toast { display: inline-block; background: var(--c-p); color: #fff; padding: 10px 20px; border-radius: 30px; margin-top: 10px; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="header-wrapper">
        <header>
            <div class="header-left">
                <img src="img/produtos/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" class="logo">
                <div class="page-title">Super Cestas<br>Dona Ant√¥nia</div>
            </div>
            <div class="header-left">
                <button class="btn-header" onclick="$('modal-faq').showModal()">?</button>
                <a href="https://wa.me/5565996813588" target="_blank" class="btn-header" style="background:#dcfce7; color:#15803d; border-color:#bbf7d0">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                </a>
            </div>
        </header>
    </div>

    <main>
        <div id="section-title" class="active-section-title">Carregando...</div>
        <div class="carousel-container">
            <div class="carousel-track" id="dynamic-track">
                </div>
        </div>
    </main>

    <div class="bottom-controls">
        <div class="stories-track" id="stories-container">
            </div>
        <div class="search-wrapper">
            <input type="text" id="search-input" class="search-input" placeholder="Buscar produto..." oninput="renderCatalogo(true)">
        </div>
    </div>

    <div class="checkout-bar">
        <button class="btn-trash" onclick="clearCart()">üóëÔ∏è</button>
        <div class="info-col">
            <div class="lbl-total" id="status-label">Total</div>
            <div class="val-total" id="total-display">R$ 0,00</div>
        </div>
        <button class="btn-checkout" onclick="openCheckout()">VER CESTA</button>
    </div>

    <div id="toast-container"></div>
    
    <dialog id="modal-image-zoom" onclick="this.close()">
        <div class="close-zoom">‚úï</div>
        <img id="zoom-img" src="">
    </dialog>

    <dialog id="modal-basket-preview">
        <h3 id="preview-title" style="text-align:center; margin-top:0"></h3>
        <p id="preview-desc" style="text-align:center; color:#64748b; font-size:0.9rem"></p>
        <div id="preview-items" style="display:flex; gap:10px; overflow-x:auto; padding:10px 0; margin-bottom:15px"></div>
        <div id="preview-total" style="text-align:center; font-size:1.5rem; font-weight:900; color:var(--c-a); margin-bottom:15px"></div>
        <button class="btn-modal btn-pri" onclick="confirmBasket()">QUERO ESTA CESTA</button>
        <button class="btn-modal btn-sec" onclick="$('modal-basket-preview').close()">VOLTAR</button>
    </dialog>

    <dialog id="modal-faq">
        <h3 style="margin-top:0">Informa√ß√µes</h3>
        <p><strong>Entrega:</strong> Gr√°tis para Cuiab√° e VG.</p>
        <p><strong>Pagamento:</strong> Na entrega (Pix/Card/Din).</p>
        <button class="btn-modal btn-pri" onclick="this.closest('dialog').close()">OK</button>
    </dialog>
    
    <dialog id="modal-checkout-final">
        <h3 style="text-align:center; margin-top:0">Finalizar Pedido</h3>
        <div id="checkout-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; padding:10px; margin-bottom:10px; font-size:0.85rem"></div>
        <div style="font-weight:bold; text-align:right; margin-bottom:10px" id="final-total"></div>
        
        <input id="cust-name" type="text" placeholder="Seu Nome" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px">
        <select id="cust-pay" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:15px">
            <option>PIX</option><option>Dinheiro</option><option>Cart√£o</option>
        </select>
        <button class="btn-modal btn-pri" onclick="sendOrder()">ENVIAR PEDIDO</button>
        <button class="btn-modal btn-sec" onclick="this.closest('dialog').close()">VOLTAR</button>
    </dialog>

<script>
const CONFIG_WHATSAPP = "5565996813588";
const $ = i => document.getElementById(i);

let DB_PROD=[], DB_CESTAS=[];
let STATE = {
    cesta: null, cart: {}, mode: 'zero', 
    basePrice: 0, currentTotal: 0, 
    activeCat: 'Minha Cesta', // Come√ßa na Minha Cesta
    cats: {}, previewId: null
};

async function init(){
    try {
        const [r1, r2] = await Promise.all([
            fetch('produtos-cesta-basica.json?v='+Date.now()),
            fetch('produtos.json?v='+Date.now())
        ]);
        if(r1.ok) DB_CESTAS = await r1.json();
        if(r2.ok) {
            let t = (await r2.text()).trim().replace(/,(\s+)?$/, "");
            DB_PROD = JSON.parse(t.startsWith('[')?t:'['+t+']').filter(x=>x.situacao==="A").map(p=>({
                id: String(p.id), name: p.nome, price: parseFloat(p.preco),
                stock: parseInt(p.estoque)||0, category: (p.categoria||"Outros").trim(),
                img: `img/produtos/${p.codigo||p.id}.webp`
            }));
        }
        prepareCats();
        // Inicializa
        renderCatalogo(); 
        updateUI();
    } catch(e) { 
        $('dynamic-track').innerHTML = '<div style="padding:20px">Erro ao carregar dados.</div>';
    }
}

function prepareCats(){
    const map = {};
    DB_PROD.forEach(p => {
        if(!map[p.category]) map[p.category] = [];
        map[p.category].push(p);
    });
    
    // Ordena√ß√£o Personalizada
    let keys = Object.keys(map).sort();
    const offers = DB_PROD.filter(p => p.name.toUpperCase().includes("OFERTA"));
    
    // Constru√ß√£o dos Bot√µes: [Minha Cesta] [Cestas B√°sicas] [Ofertas] ...
    const finalCats = ["Minha Cesta", "Cestas B√°sicas"];
    if(offers.length) {
        map["Ofertas"] = offers;
        finalCats.push("Ofertas");
    }
    keys.forEach(k => { if(k!=="Ofertas") finalCats.push(k); });
    
    STATE.cats = map;
    
    $('stories-container').innerHTML = finalCats.map(c => {
        let icon = '';
        let img = '';
        let label = c;
        
        if(c === "Minha Cesta") {
            icon = '<span style="font-size:1.5rem">üõí</span>'; 
            label = "Minha Cesta";
        } else if (c === "Cestas B√°sicas") {
            img = DB_CESTAS[0]?.imagem || '';
        } else {
            img = map[c]?.[0]?.img || '';
        }

        const safeCat = c.replace(/'/g,"\\'");
        return `
        <div class="story-item ${c===STATE.activeCat?'active':''}" onclick="selectCat('${safeCat}')" id="btn-cat-${c.replace(/\W/g,'')}">
            <div class="story-circle">
                ${img ? `<img src="${img}" class="story-img">` : icon}
            </div>
            <div class="story-name">${label}</div>
        </div>`;
    }).join('');
}

function selectCat(c){
    STATE.activeCat = c;
    // Atualiza visual dos botoes
    document.querySelectorAll('.story-item').forEach(el => el.classList.remove('active'));
    const btn = document.getElementById(`btn-cat-${c.replace(/\W/g,'')}`);
    if(btn) btn.classList.add('active');
    
    renderCatalogo();
}

function renderCatalogo(isSearch=false){
    const track = $('dynamic-track');
    const title = $('section-title');
    const q = $('search-input').value.toUpperCase();
    
    // MODO BUSCA
    if(q && isSearch){
        title.innerText = "Busca";
        const r = DB_PROD.filter(p=>p.name.toUpperCase().includes(q));
        if(!r.length) { track.innerHTML = '<div style="padding:20px;width:100%;text-align:center">Nada encontrado.</div>'; return; }
        track.innerHTML = r.map(p => renderCard(p)).join('');
        return;
    }

    const cat = STATE.activeCat;
    title.innerText = cat;

    // 1. MINHA CESTA
    if(cat === "Minha Cesta") {
        const ids = Object.keys(STATE.cart);
        if(ids.length === 0) {
            track.innerHTML = `
            <div style="width:100%; text-align:center; padding:40px 20px; color:var(--c-t)">
                <div style="font-size:3rem; margin-bottom:10px">üõçÔ∏è</div>
                <div>Sua cesta est√° vazia.</div>
                <div style="font-size:0.8rem; margin-top:5px">Escolha uma categoria abaixo para come√ßar.</div>
            </div>`;
        } else {
            // Renderiza produtos do carrinho como carrossel padr√£o
            track.innerHTML = ids.map(id => {
                const p = DB_PROD.find(x=>x.id===id);
                return p ? renderCard(p) : '';
            }).join('');
        }
        return;
    }

    // 2. CESTAS B√ÅSICAS
    if(cat === "Cestas B√°sicas") {
        track.innerHTML = DB_CESTAS.map(c => `
            <div class="cesta-card">
                <img src="${c.imagem}" class="cesta-img" onclick="previewBasket('${c.id}')">
                <div class="cesta-body">
                    <div class="cesta-name">${c.nome}</div>
                    <div class="cesta-price">${fmt(c.preco)}</div>
                    <button class="btn-ver-cesta" onclick="previewBasket('${c.id}')">VER DETALHES</button>
                </div>
            </div>
        `).join('');
        return;
    }

    // 3. PRODUTOS GERAIS
    const list = STATE.cats[cat] || [];
    if(!list.length) { track.innerHTML = '<div style="padding:20px">Vazio.</div>'; return; }
    track.innerHTML = list.map(p => renderCard(p)).join('');
}

function renderCard(p){
    const qty = STATE.cart[p.id] || 0;
    
    // Layout do bot√£o de a√ß√£o
    let action = '';
    if(qty === 0) {
        action = `<button class="btn-add-big" onclick="upd('${p.id}',1)">+</button>`;
    } else {
        action = `
        <div class="qty-control">
            <button class="btn-qty" onclick="upd('${p.id}',-1)">-</button>
            <span class="qty-val">${qty}</span>
            <button class="btn-qty" onclick="upd('${p.id}',1)" style="color:var(--c-ok)">+</button>
        </div>`;
    }

    return `
    <div class="prod-card">
        <img src="${p.img}" class="prod-img" onclick="openZoom('${p.img}')">
        <div class="prod-info">
            <div class="prod-name">${p.name}</div>
            <div class="prod-price">${fmt(p.price)}</div>
            ${action}
        </div>
    </div>`;
}

// --- LOGICA CARRINHO ---
function upd(id, d){
    const p = DB_PROD.find(x=>x.id===id);
    if(!p) return;
    const cur = STATE.cart[id] || 0;
    const n = cur + d;
    
    if(n <= 0) delete STATE.cart[id];
    else STATE.cart[id] = n;
    
    updateUI();
    
    // Re-renderizar apenas se estivermos na vis√£o "Minha Cesta" para remover item visualmente se zerar
    // OU se estivermos no carrossel normal para atualizar o bot√£o
    renderCatalogo(!!$('search-input').value); 
}

function updateUI(){
    let total = 0;
    for(let id in STATE.cart){
        const p = DB_PROD.find(x=>x.id===id);
        if(p) total += p.price * STATE.cart[id];
    }
    STATE.currentTotal = total; // Ajustar logica de credito/debito se necessario
    
    // Se modo for custom (cesta pronta), ajustar total com base
    if(STATE.mode === 'custom') {
        const diff = STATE.basePrice - total; // Simplificado para este exemplo
        // Mantendo logica simples: soma itens
    }

    $('total-display').innerText = fmt(total);
}

// --- CESTAS ---
function previewBasket(id){
    const c = DB_CESTAS.find(x=>String(x.id)===String(id));
    if(!c) return;
    STATE.previewId = id;
    $('preview-title').innerText = c.nome;
    $('preview-desc').innerText = `${c.produtos.length} itens`;
    $('preview-total').innerText = fmt(c.preco);
    
    $('preview-items').innerHTML = c.produtos.map(s => {
        const [q, pid] = s.split('x');
        const p = DB_PROD.find(x=>x.id===pid.trim()||x.id===pid.trim()); 
        // Nota: Assumindo ID simples. No JSON real pode ser codigo.
        // Simulando busca simplificada:
        const pr = DB_PROD.find(z => z.id === pid.trim() || z.name.includes(pid.trim()));
        if(!pr) return '';
        return `
        <div style="flex:0 0 80px; border:1px solid #eee; border-radius:8px; padding:5px; font-size:0.7rem; text-align:center">
            <img src="${pr.img}" style="width:100%; height:50px; object-fit:contain">
            <div style="height:2.4em; overflow:hidden">${pr.name}</div>
            <strong>${q.trim()}x</strong>
        </div>`;
    }).join('');
    
    $('modal-basket-preview').showModal();
}

function confirmBasket(){
    const c = DB_CESTAS.find(x=>String(x.id)===String(STATE.previewId));
    if(!c) return;
    
    STATE.cart = {};
    STATE.mode = 'custom';
    STATE.basePrice = c.preco;
    STATE.cesta = c;
    
    c.produtos.forEach(s => {
        const [q, pid] = s.split('x');
        const pr = DB_PROD.find(z => z.id === pid.trim() || z.name.includes(pid.trim())); // Match simplificado
        if(pr) STATE.cart[pr.id] = parseInt(q);
    });
    
    $('modal-basket-preview').close();
    updateUI();
    showToast("Cesta carregada!");
    
    // MUDAR PARA ABA MINHA CESTA
    selectCat('Minha Cesta');
}

// --- UTILS ---
function clearCart(){
    if(!confirm("Limpar carrinho?")) return;
    STATE.cart = {};
    STATE.mode = 'zero';
    STATE.cesta = null;
    updateUI();
    renderCatalogo();
}

function openCheckout(){
    if(Object.keys(STATE.cart).length === 0) return alert("Carrinho vazio.");
    let html = '';
    for(let id in STATE.cart){
        const p = DB_PROD.find(x=>x.id===id);
        if(p) html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px"><span>${STATE.cart[id]}x ${p.name.substring(0,20)}</span><span>${fmt(p.price*STATE.cart[id])}</span></div>`;
    }
    $('checkout-list').innerHTML = html;
    $('final-total').innerText = "Total: " + fmt(STATE.currentTotal);
    $('modal-checkout-final').showModal();
}

function sendOrder(){
    const n = $('cust-name').value;
    const p = $('cust-pay').value;
    if(!n) return alert("Digite seu nome");
    
    let msg = `*PEDIDO NOVO*\nüë§ ${n}\nüí∞ ${p}\n\n`;
    for(let id in STATE.cart){
        const pr = DB_PROD.find(x=>x.id===id);
        msg += `${STATE.cart[id]}x ${pr.name}\n`;
    }
    msg += `\n*TOTAL: ${fmt(STATE.currentTotal)}*`;
    
    window.location.href = `https://wa.me/${CONFIG_WHATSAPP}?text=${encodeURIComponent(msg)}`;
}

function openZoom(src){ $('zoom-img').src = src; $('modal-image-zoom').showModal(); }
function fmt(v){ return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
function showToast(m){ 
    const t = document.createElement('div'); t.className='toast'; t.innerText=m; 
    $('toast-container').appendChild(t); 
    setTimeout(()=>t.remove(), 2000); 
}

init();
</script>
</body>
</html>
