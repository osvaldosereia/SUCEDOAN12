<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="Super Cestas B√°sicas Dona Ant√¥nia - Qualidade e pre√ßo justo.">
<meta name="theme-color" content="#ffffff">
<title>Super Cestas B√°sicas Dona Ant√¥nia</title>
<style>
:root {
    --c-p: #0f172a; --c-s: #334155; --c-t: #64748b;
    --c-a: #ea580c; --c-ok: #15803d; --c-err: #b91c1c;
    --c-bg: #f8fafc; --c-surf: #ffffff; --c-bd: #cbd5e1;
    --font: 'Inter', system-ui, sans-serif;
    --rad: 16px; --sh-sm: 0 1px 3px rgba(0,0,0,0.1);
    --sh-fl: 0 10px 15px -3px rgba(0,0,0,0.1);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
body{font-family:var(--font);background:var(--c-bg);color:var(--c-p);margin:0;padding:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased}
img{user-select:none;pointer-events:none}
button{cursor:pointer;border:none;background:0 0;font-family:inherit;font-weight:600}

/* --- TOPO (HEADER) --- */
.app-header{flex:0 0 auto;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#fff;border-bottom:1px solid var(--c-bd);z-index:20}
.header-brand{display:flex;align-items:center;gap:10px}
.logo{width:42px;height:42px;border-radius:50%;object-fit:cover;border:1px solid var(--c-bd)}
.brand-txt{font-size:.9rem;font-weight:800;line-height:1.1}
.header-actions{display:flex;gap:10px}
.btn-icon{width:40px;height:40px;border-radius:50%;background:#f1f5f9;color:var(--c-s);display:flex;align-items:center;justify-content:center;transition:.2s}
.btn-icon:hover{background:#e2e8f0;color:var(--c-p)}

/* --- PALCO CENTRAL (CARROUSEL) --- */
.main-stage{
    flex:1;
    position:relative;
    display:flex;
    flex-direction:column;
    justify-content:center;
    overflow:hidden;
    background:var(--c-bg);
}

.carousel-wrapper{
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    overflow-x:auto;
    overflow-y:hidden;
    scroll-behavior:smooth;
    padding:10px 20px; /* Reduzido respiro vertical */
    gap:15px;
    scroll-snap-type:x mandatory;
}
.carousel-wrapper::-webkit-scrollbar{display:none}
.carousel-wrapper{-ms-overflow-style:none;scrollbar-width:none}

/* DESKTOP LIMIT */
@media(min-width:1024px){
    .carousel-wrapper{justify-content:center;max-width:1200px;margin:0 auto;gap:25px}
}

/* CARDS UNIFICADOS */
.u-card{
    flex:0 0 200px;
    scroll-snap-align:center;
    background:#fff;border-radius:20px;
    border:1px solid var(--c-bd);
    box-shadow:var(--sh-sm);
    display:flex;flex-direction:column;
    overflow:hidden;
    position:relative;
    height:auto;
    max-height:100%;
    transition:transform .2s;
}
.u-card:active{transform:scale(0.98)}

@media(max-width:600px){
    .u-card{flex:0 0 65%;}
    .carousel-wrapper{padding:10px 10%;}
}

.u-img-area{width:100%;aspect-ratio:1;background:#f8fafc;position:relative;overflow:hidden;border-bottom:1px solid #f1f5f9}
.u-img{width:100%;height:100%;object-fit:contain;mix-blend-mode:multiply;padding:8px}
.u-img-cesta{object-fit:cover;padding:0;mix-blend-mode:normal}

.u-info{padding:10px;display:flex;flex-direction:column;gap:6px;flex:1}
.u-tag{position:absolute;top:8px;left:8px;background:#fff;padding:2px 6px;border-radius:6px;font-size:0.65rem;font-weight:700;box-shadow:0 2px 5px rgba(0,0,0,0.1);z-index:2}
.u-name{
    font-size:0.85rem;font-weight:700;color:var(--c-p);line-height:1.2;
    display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden;
    min-height:3.6em;
}
.u-price{font-size:1.1rem;font-weight:900;color:var(--c-a)}

.u-action-row{margin-top:auto;padding-top:8px}
.btn-big-action{width:100%;background:var(--c-p);color:#fff;padding:10px;border-radius:10px;font-weight:700;font-size:0.85rem;display:flex;align-items:center;justify-content:center;gap:4px}
.btn-big-action.added{background:#fff;border:2px solid var(--c-ok);color:var(--c-ok)}

/* Controles de QTD */
.qty-row{display:flex;align-items:center;justify-content:space-between;background:#f1f5f9;border-radius:10px;padding:3px}
.btn-qty{width:32px;height:32px;border-radius:8px;background:#fff;font-size:1.1rem;font-weight:800;box-shadow:var(--sh-sm);color:var(--c-p)}
.qty-val{font-size:1rem;font-weight:800;flex:1;text-align:center}

/* SETAS DESKTOP */
.nav-arrow{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:50%;background:#fff;border:1px solid var(--c-bd);box-shadow:var(--sh-fl);z-index:20;cursor:pointer;display:none;align-items:center;justify-content:center;font-size:1.2rem;color:var(--c-p)}
.nav-arrow:hover{background:var(--c-p);color:#fff}
.nav-left{left:10px} .nav-right{right:10px}
@media(min-width:1024px){.nav-arrow{display:flex}}


/* --- BASE (CONTROLES) --- */
.bottom-stack{
    flex:0 0 auto;
    background:#fff;
    border-top:1px solid var(--c-bd);
    box-shadow:0 -5px 25px rgba(0,0,0,0.05);
    z-index:30;
    display:flex;flex-direction:column;
}

/* 1. Menu Circular */
.menu-scroll-area{
    width:100%; overflow-x:auto;
    padding:12px 20px 6px;
    border-bottom:1px solid #f1f5f9;
    display:flex; gap:15px;
    align-items: flex-start;
}
.menu-scroll-area::-webkit-scrollbar{display:none}

.cat-bubble{display:flex;flex-direction:column;align-items:center;gap:6px;cursor:pointer;min-width:75px;opacity:1;transition:.3s}
.cat-bubble.active{transform:scale(1.05)}
.cat-bubble.active .cat-img-ring{border-color:var(--c-a);box-shadow:0 0 0 3px rgba(234,88,12,0.2)}
.cat-bubble.active .cat-name{color:var(--c-a);font-weight:800}

/* Anel da imagem aumentado */
.cat-img-ring{width:64px;height:64px;border-radius:50%;padding:2px;border:2px solid var(--c-bd);background:#fff;display:flex;align-items:center;justify-content:center}
.cat-img{width:100%;height:100%;border-radius:50%;object-fit:cover;background:#f1f5f9}
.cat-name{font-size:0.7rem;font-weight:600;color:var(--c-s);text-align:center;line-height:1.1;max-width:80px}

/* Cart Icon Color */
.cat-bubble[id*="__CART__"] .cat-img-ring { background: var(--c-p); border-color: var(--c-p); color:#fff; }

/* 2. Busca */
.search-bar-area{padding:6px 20px 10px;background:#fff;position:relative}
.search-inp{width:100%;background:#f8fafc;border:1px solid var(--c-bd);padding:10px 12px 10px 40px;border-radius:10px;font-weight:600;color:var(--c-p)}
.search-icon{position:absolute;left:32px;top:50%;transform:translateY(-50%);color:var(--c-t);pointer-events:none}
.clear-search{position:absolute;right:30px;top:50%;transform:translateY(-50%);background:#cbd5e1;color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;display:none;align-items:center;justify-content:center}

/* 3. Checkout Bar */
.checkout-bar{padding:15px 20px 20px;display:flex;align-items:center;justify-content:space-between;gap:15px}
.total-info{display:flex;flex-direction:column}
.lbl-total{font-size:0.7rem;text-transform:uppercase;font-weight:800;color:var(--c-s)}
.val-total{font-size:1.3rem;font-weight:900;color:var(--c-p)}
.btn-checkout{flex:1;background:#16a34a;color:#fff;padding:14px;border-radius:12px;font-weight:800;font-size:1rem;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 12px rgba(22,163,74,0.3)}

/* MODAIS & TOAST */
dialog{border:none;border-radius:24px;width:92%;max-width:420px;padding:0;box-shadow:0 25px 50px -12px rgba(0,0,0,0.4);background:#fff;animation:modalPop .3s}
dialog::backdrop{background:rgba(15,23,42,0.8);backdrop-filter:blur(4px)}
@keyframes modalPop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
.modal-body{padding:25px 20px;text-align:center}
.btn-modal{width:100%;padding:14px;border-radius:12px;font-weight:800;margin-bottom:10px;font-size:1rem}
.btn-modal.primary{background:var(--c-p);color:#fff}
.btn-modal.secondary{background:#fff;border:2px solid var(--c-bd);color:var(--c-s)}

/* Modal Carousels */
.modal-carousel-track {
    display: flex;
    overflow-x: auto;
    gap: 12px;
    padding: 10px 5px;
    scroll-snap-type: x mandatory;
    justify-content: flex-start;
}
.modal-carousel-track::-webkit-scrollbar{height:4px;background:transparent}
.modal-carousel-track::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}

.modal-card {
    flex: 0 0 140px;
    scroll-snap-align: start;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 8px;
    background: #fff;
    display: flex;
    flex-direction: column;
    text-align: left;
}
.modal-card img { width: 100%; aspect-ratio: 1; object-fit: contain; mix-blend-mode: multiply; margin-bottom: 6px; }
.modal-card .mc-name { font-size: 0.75rem; font-weight: 700; color: var(--c-p); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.5em; }
.modal-card .mc-price { font-size: 0.9rem; font-weight: 800; color: var(--c-a); margin-top: auto; }
.modal-card .mc-qty { font-size: 0.75rem; font-weight: 600; color: var(--c-s); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 4px; }


#toast-container{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:2000;pointer-events:none}
.toast{background:var(--c-p);color:#fff;padding:12px 24px;border-radius:50px;box-shadow:0 10px 30px rgba(0,0,0,0.3);font-size:.9rem;font-weight:600;animation:slideInTop .4s;margin-bottom:10px;text-align:center}
@keyframes slideInTop{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}

/* Image Zoom Modal */
#modal-image-zoom{background:transparent;box-shadow:none;max-width:100vw;max-height:100vh}
#modal-image-zoom .modal-body{padding:0;display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;background:rgba(0,0,0,0.8)}
#zoom-img{max-width:95%;max-height:85%;border-radius:12px}

</style>
</head>
<body>

<header class="app-header">
    <div class="header-brand">
        <img src="img/produtos/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" class="logo" alt="Logo">
        <div class="brand-txt">Super Cestas<br>Dona Ant√¥nia</div>
    </div>
    <div class="header-actions">
        <button class="btn-icon" onclick="window.open('https://wa.me/5565996813588','_blank')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" color="#16a34a"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
        </button>
        <button class="btn-icon" onclick="$('modal-faq').showModal()">?</button>
    </div>
</header>

<main class="main-stage">
    <div class="nav-arrow nav-left" onclick="$('main-carousel').scrollBy({left:-300,behavior:'smooth'})">‚ùÆ</div>
    <div class="carousel-wrapper" id="main-carousel">
        </div>
    <div class="nav-arrow nav-right" onclick="$('main-carousel').scrollBy({left:300,behavior:'smooth'})">‚ùØ</div>
</main>

<div class="bottom-stack">
    <div class="menu-scroll-area" id="menu-bubbles">
        </div>

    <div class="search-bar-area">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="search-inp" class="search-inp" placeholder="Busque por nome..." oninput="handleSearch(this.value)">
        <button class="clear-search" id="btn-clr-search" onclick="clearSearch()">‚úï</button>
    </div>

    <div class="checkout-bar">
        <div class="total-info">
            <span class="lbl-total" id="lbl-total-type">Total Estimado</span>
            <span class="val-total" id="val-total">R$ 0,00</span>
        </div>
        <button class="btn-checkout" onclick="openCheckout()">
            VER CARRINHO <span id="badge-count" style="background:rgba(255,255,255,0.2);padding:2px 8px;border-radius:10px;font-size:0.8rem">0</span>
        </button>
    </div>
</div>

<div id="toast-container"></div>

<dialog id="modal-basket-preview">
    <div class="modal-body">
        <h3 class="stage-title" style="color:var(--c-p);font-size:1.4rem" id="prev-title"></h3>
        <p style="color:var(--c-s);margin-bottom:15px" id="prev-desc"></p>
        
        <div style="background:#f8fafc;padding:5px;border-radius:12px;border:1px solid var(--c-bd);margin-bottom:15px">
            <div class="modal-carousel-track" id="prev-list"></div>
        </div>
        
        <div style="margin-top:20px">
            <div style="font-size:1.8rem;font-weight:900;color:var(--c-a);margin-bottom:15px" id="prev-price"></div>
            <button class="btn-modal primary" onclick="confirmBasket()">QUERO ESTA CESTA</button>
            <button class="btn-modal secondary" onclick="$('modal-basket-preview').close()">Voltar</button>
        </div>
    </div>
</dialog>

<dialog id="modal-checkout">
    <div class="modal-body" style="text-align:left">
        <h3 style="text-align:center;text-transform:uppercase;font-weight:900">Finalizar Pedido</h3>
        
        <div style="background:#f8fafc;padding:5px;border-radius:12px;border:1px solid var(--c-bd);margin:15px 0">
            <div class="modal-carousel-track" id="chk-list"></div>
        </div>
        
        <div style="text-align:right;margin-bottom:15px">
            <div style="font-size:1.4rem;font-weight:900" id="chk-total"></div>
        </div>

        <label style="font-size:.75rem;font-weight:800;color:var(--c-s)">CUPOM:</label>
        <div style="display:flex;gap:5px;margin-bottom:15px">
            <input id="cupom-code" style="flex:1;padding:10px;border:1px solid var(--c-bd);border-radius:8px;text-transform:uppercase" placeholder="C√ìDIGO">
            <button onclick="applyCupom()" style="background:var(--c-p);color:#fff;padding:0 15px;border-radius:8px;font-weight:700">OK</button>
        </div>
        <div id="cupom-msg" style="font-size:.8rem;font-weight:700;margin-bottom:10px;display:none"></div>

        <input id="cli-nome" style="width:100%;padding:12px;margin-bottom:10px;border:1px solid var(--c-bd);border-radius:8px;font-weight:600" placeholder="Seu Nome Completo">
        <select id="cli-pgto" style="width:100%;padding:12px;margin-bottom:20px;border:1px solid var(--c-bd);border-radius:8px;font-weight:600;background:#fff">
            <option>PIX na Entrega</option>
            <option>Dinheiro</option>
            <option>Cart√£o de Cr√©dito</option>
            <option>Cart√£o de D√©bito</option>
            <option>Cart√£o Alimenta√ß√£o</option>
        </select>

        <button class="btn-modal primary" onclick="sendOrder()">ENVIAR PEDIDO (WHATSAPP)</button>
        <button class="btn-modal secondary" onclick="$('modal-checkout').close()">Continuar Comprando</button>
        <button class="btn-modal" style="color:var(--c-err);font-size:0.8rem" onclick="clearCart()">Esvaziar Carrinho</button>
    </div>
</dialog>

<dialog id="modal-image-zoom" onclick="this.close()"><div class="modal-body"><img id="zoom-img" src=""></div></dialog>
<dialog id="modal-faq" onclick="if(event.target===this)this.close()"><div class="modal-body"><h3>D√∫vidas?</h3><p>Entregamos em Cuiab√° e VG.<br>Pagamento na entrega.</p><button class="btn-modal primary" onclick="this.closest('dialog').close()">OK</button></div></dialog>

<script>
const $=i=>document.getElementById(i);
const STATE={
    baskets:[], prods:[], coupons:[],
    cart:{}, cartOrder:[], 
    activeCat:'__CESTAS__', 
    mode:'zero', 
    baseBasket:null,
    coupon:null,
    initialGap: 0
};

async function init(){
    try{
        const[r1,r2,r3]=await Promise.all([
            fetch('produtos-cesta-basica.json?v='+Date.now()),
            fetch('produtos.json?v='+Date.now()),
            fetch('cupons.json?v='+Date.now()).catch(()=>({ok:false}))
        ]);
        if(r1.ok) STATE.baskets = await r1.json();
        if(r2.ok){
            let t=(await r2.text()).trim().replace(/,(\s+)?$/,"");
            let raw = JSON.parse(t.startsWith('[')?t:'['+t+']');
            STATE.prods = raw.filter(x=>x.situacao==="A").map(p=>({
                id:String(p.id), code:String(p.codigo||p.id),
                name:p.nome, price:parseFloat(p.preco),
                stock:parseInt(p.estoque)||0,
                cat:(p.categoria||p.Categoria||"Outros").trim(),
                val:p.validade, img:`img/produtos/${p.codigo||p.id}.webp`
            }));
        }
        if(r3&&r3.ok) STATE.coupons = await r3.json();

        renderMenu();
        loadCategory('__CESTAS__');
    }catch(e){$('main-carousel').innerHTML='<p style="padding:20px;text-align:center">Erro ao carregar dados.</p>';console.error(e)}
}

/* --- MENU LOGIC --- */
function renderMenu(){
    const cats = {};
    STATE.prods.forEach(p=>{ if(!cats[p.cat])cats[p.cat]=[]; cats[p.cat].push(p) });
    let catKeys = Object.keys(cats).sort();
    
    const offers = STATE.prods.filter(p=>p.name.toUpperCase().includes("OFERTA"));
    if(offers.length){ cats["üî• OFERTAS"]=offers; catKeys = ["üî• OFERTAS", ...catKeys.filter(c=>c!=="üî• OFERTAS")]; }

    // Lista unificada rol√°vel
    const menuItems = [
        {key:'__CART__', name:'Minha Cesta', img:null}, // Img null usa o icone SVG via CSS
        {key:'__CESTAS__', name:'Cestas B√°sicas', img:'img/produtos/cesta.webp'},
        ...catKeys.map(k=>({key:k, name:k, img:cats[k][0]?.img}))
    ];

    $('menu-bubbles').innerHTML = menuItems.map(m=>{
        const idKey = m.key.replace(/\s/g,'-');
        // Se for CART, usa SVG, sen√£o usa IMG
        let content;
        if(m.key === '__CART__'){
            content = `<div class="cat-img-ring"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg></div>`;
        } else {
            const img = m.img || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cbd5e1"><circle cx="12" cy="12" r="10"/></svg>';
            content = `<div class="cat-img-ring"><img src="${img}" class="cat-img" onerror="this.src='data:image/svg+xml,<svg...'"></div>`;
        }
        
        return `
        <div class="cat-bubble ${STATE.activeCat===m.key?'active':''}" onclick="loadCategory('${m.key.replace(/'/g,"\\'")}')" id="bubble-${idKey}">
            ${content}
            <div class="cat-name">${formatName(m.name)}</div>
        </div>`
    }).join('');
}

function loadCategory(key){
    if(key === '__CART__'){
        if(Object.keys(STATE.cart).length === 0){
            return showToast("Seu carrinho est√° vazio!", "r");
        }
    }

    document.querySelectorAll('.cat-bubble').forEach(el=>el.classList.remove('active'));
    const bub = document.getElementById(`bubble-${key.replace(/\s/g,'-')}`);
    if(bub) bub.classList.add('active');

    STATE.activeCat = key;
    const carousel = $('main-carousel');
    carousel.innerHTML = '';
    
    if(key === '__CESTAS__'){
        renderCards(STATE.baskets, 'BASKET');
    } 
    else if(key === '__CART__'){
        const items = STATE.cartOrder.map(id=>STATE.prods.find(p=>p.id===id)).filter(Boolean);
        renderCards(items, 'PROD');
    }
    else {
        const items = STATE.prods.filter(p=> (key==="üî• OFERTAS" ? p.name.toUpperCase().includes("OFERTA") : p.cat === key));
        items.sort((a,b)=>{
            const fa=a.name.includes('***'), fb=b.name.includes('***');
            return fa===fb ? 0 : fa ? -1 : 1;
        });
        renderCards(items, 'PROD');
    }
    carousel.scrollTo({left:0});
}

function renderCards(list, type){
    const h = list.map(item => {
        if(type === 'BASKET'){
            return `
            <div class="u-card">
                <div class="u-img-area"><img src="${item.imagem}" class="u-img u-img-cesta" loading="lazy"></div>
                <div class="u-info">
                    <div class="u-name">${formatName(item.nome)}</div>
                    <div class="u-price">${fmt(item.preco)}</div>
                    <div class="u-action-row">
                        <button class="btn-big-action" onclick="previewBasket('${item.id}')">
                            VER ITENS
                        </button>
                    </div>
                </div>
            </div>`;
        } else {
            const q = STATE.cart[item.id] || 0;
            const btn = q > 0 
                ? `<div class="qty-row"><button class="btn-qty" onclick="upd('${item.id}',-1)">-</button><span class="qty-val qty-${item.id}">${q}</span><button class="btn-qty" onclick="upd('${item.id}',1)" style="color:var(--c-ok)">+</button></div>`
                : `<button class="btn-big-action ${item.stock<=0?'disabled':''}" onclick="upd('${item.id}',1)" ${item.stock<=0?'disabled':''}>${item.stock<=0?'ESGOTADO':'ADICIONAR'}</button>`;
            
            return `
            <div class="u-card">
                <div class="u-img-area">
                    <img src="${item.img}" class="u-img" loading="lazy" onclick="zoom('${item.img}')">
                    ${item.val ? `<div class="u-tag">Val: ${item.val}</div>` : ''}
                </div>
                <div class="u-info">
                    <div class="u-name">${formatName(item.name)}</div>
                    <div class="u-price">${fmt(item.price)}</div>
                    <div class="u-action-row ctrl-wrap-${item.id}">
                        ${btn}
                    </div>
                </div>
            </div>`;
        }
    }).join('');
    
    $('main-carousel').innerHTML = h || '<p style="margin:auto;color:#94a3b8">Nenhum item encontrado.</p>';
}

/* --- BASKET LOGIC --- */
function previewBasket(id){
    const c = STATE.baskets.find(x=>String(x.id)===String(id));
    if(!c) return;
    STATE.tempBasket = c;
    $('prev-title').innerHTML = formatName(c.nome);
    $('prev-desc').innerHTML = `${c.produtos.length} itens inclusos`;
    $('prev-price').innerHTML = fmt(c.preco);
    
    // Render Modal Carousel
    $('prev-list').innerHTML = c.produtos.map(s=>{
        const [qtd, ref] = s.split('x');
        if(!ref) return '';
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(!p) return '';
        return `
        <div class="modal-card">
            <img src="${p.img}" loading="lazy">
            <div class="mc-name">${formatName(p.name)}</div>
            <div class="mc-qty">${qtd}x unidade(s)</div>
        </div>`;
    }).join('');
    
    $('modal-basket-preview').showModal();
}

function confirmBasket(){
    const c = STATE.tempBasket;
    STATE.mode = 'custom';
    STATE.baseBasket = c;
    STATE.cart = {}; STATE.cartOrder = [];
    
    let itemsSum = 0;
    c.produtos.forEach(s=>{
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p){
            const q = Math.min(parseInt(qStr), p.stock || 999);
            STATE.cart[p.id] = q;
            STATE.cartOrder.push(p.id);
            itemsSum += (p.price * q);
        }
    });

    // Calcula diferen√ßa para enviar ao Make
    STATE.initialGap = c.preco - itemsSum;
    
    $('modal-basket-preview').close();
    showToast(`Cesta ${c.nome} carregada!`, 's');
    loadCategory('__CART__');
    updateTotals();
}

/* --- CART LOGIC --- */
function upd(id, delta){
    const p = STATE.prods.find(x=>x.id===id);
    if(!p) return;
    const cur = STATE.cart[id] || 0;
    const next = cur + delta;
    
    if(next > p.stock) return showToast("Estoque limite atingido", "r");
    if(next < 0) return;
    
    if(cur === 0 && next > 0) STATE.cartOrder.push(id);
    STATE.cart[id] = next;
    if(next === 0){
        delete STATE.cart[id];
        STATE.cartOrder = STATE.cartOrder.filter(x=>x!==id);
        if(STATE.activeCat === '__CART__') loadCategory('__CART__');
    }
    
    document.querySelectorAll(`.qty-${id}`).forEach(e=>e.innerText = next);
    
    if((cur===0 && next>0) || (cur>0 && next===0)){
        const btn = next > 0 
             ? `<div class="qty-row"><button class="btn-qty" onclick="upd('${id}',-1)">-</button><span class="qty-val qty-${id}">${next}</span><button class="btn-qty" onclick="upd('${id}',1)" style="color:var(--c-ok)">+</button></div>`
             : `<button class="btn-big-action" onclick="upd('${id}',1)">ADICIONAR</button>`;
        document.querySelectorAll(`.ctrl-wrap-${id}`).forEach(el=>el.innerHTML=btn);
    }
    
    if(delta>0) showToast(`+1 ${p.name.substring(0,10)}...`, 's');
    updateTotals();
}

function updateTotals(){
    let total = 0, count = 0;
    Object.entries(STATE.cart).forEach(([id,q])=>{
        const p = STATE.prods.find(x=>x.id===id);
        if(p){ total += p.price * q; count += q; }
    });
    
    // Adiciona o gap original da cesta se existir
    total += (STATE.initialGap || 0);

    if(STATE.coupon && total >= STATE.coupon.minimo){
        total -= STATE.coupon.desconto;
    } else if(STATE.coupon){
        STATE.coupon = null; showToast("Cupom removido (m√≠nimo n√£o atingido)", "r");
    }
    
    $('val-total').innerText = fmt(total);
    $('badge-count').innerText = count;
    $('chk-total').innerText = fmt(total);
}

function clearCart(){
    if(!confirm("Esvaziar tudo?")) return;
    STATE.cart = {}; STATE.cartOrder = []; STATE.mode = 'zero'; STATE.coupon=null; STATE.initialGap=0;
    updateTotals();
    $('modal-checkout').close();
    loadCategory('__CESTAS__');
    showToast("Carrinho limpo", "r");
}

/* --- SEARCH & UTILS --- */
function handleSearch(q){
    const btn = $('btn-clr-search');
    btn.style.display = q ? 'flex' : 'none';
    if(!q) return loadCategory(STATE.activeCat);
    
    const res = STATE.prods.filter(p => p.name.toUpperCase().includes(q.toUpperCase()));
    renderCards(res, 'PROD');
}
function clearSearch(){ $('search-inp').value=''; handleSearch(''); }

function openCheckout(){
    const unique = Object.keys(STATE.cart).length;
    if(unique === 0) return showToast("Carrinho vazio!", "r");
    
    // Valida√ß√µes de Pedido M√≠nimo
    const totalRaw = parseMoney($('val-total').innerText);
    if(totalRaw < 85) return showToast("M√≠nimo R$ 85,00 para fechar pedido", "r");
    if(unique < 8) return showToast("M√≠nimo 8 itens diferentes", "r");

    // Render Modal Carousel
    $('chk-list').innerHTML = STATE.cartOrder.map(id=>{
        const p = STATE.prods.find(x=>x.id===id);
        const q = STATE.cart[id];
        return `
        <div class="modal-card">
            <img src="${p.img}" loading="lazy">
            <div class="mc-name">${formatName(p.name)}</div>
            <div class="mc-price">${fmt(p.price)}</div>
            <div class="mc-qty">${q} unidade(s)</div>
        </div>`;
    }).join('');
    
    $('modal-checkout').showModal();
}

function applyCupom(){
    const code = $('cupom-code').value.toUpperCase().trim();
    const c = STATE.coupons.find(x=>x.codigo === code);
    let rawTotal = 0;
    Object.entries(STATE.cart).forEach(([id,q])=>{
        const p=STATE.prods.find(x=>x.id===id); if(p) rawTotal+=p.price*q;
    });
    rawTotal += (STATE.initialGap || 0);

    if(!c) return showToast("Cupom inv√°lido", "r");
    if(rawTotal < c.minimo) return showToast(`M√≠nimo R$ ${c.minimo}`, "r");
    
    STATE.coupon = c;
    updateTotals();
    $('cupom-msg').innerText = `DESCONTO R$ ${c.desconto} APLICADO!`;
    $('cupom-msg').style.display='block'; $('cupom-msg').style.color='var(--c-ok)';
}

async function sendOrder(){
    const nome = $('cli-nome').value;
    if(!nome) return alert("Por favor, digite seu nome.");
    
    // Valida√ß√£o extra
    const unique = Object.keys(STATE.cart).length;
    const totalCurrent = parseMoney($('val-total').innerText);
    if(totalCurrent < 85 || unique < 8) return alert("Regras: Min R$ 85,00 e 8 itens diferentes.");
    
    let itemsTxt = "";
    const itensApi = [];
    let total = 0;
    
    Object.entries(STATE.cart).forEach(([id,q])=>{
        const p = STATE.prods.find(x=>x.id===id);
        if(p){
            total += p.price * q;
            itemsTxt += `${q}x ${p.name}\n`;
            itensApi.push({id:p.id, nome:p.name, quantidade:q, preco_unitario:p.price});
        }
    });
    
    // Injeta o GAP no envio
    if(STATE.initialGap && STATE.initialGap !== 0){
        total += STATE.initialGap;
        itemsTxt += `1x Ajuste/Embalagem Cesta\n`;
        itensApi.push({id:'GAP', nome:'Ajuste/Embalagem Cesta', quantidade:1, preco_unitario:STATE.initialGap});
    }

    let finalTotal = total;
    let cupomTxt = "";
    if(STATE.coupon){
        finalTotal -= STATE.coupon.desconto;
        cupomTxt = `\nüè∑Ô∏è CUPOM: ${STATE.coupon.codigo} (-R$ ${STATE.coupon.desconto})`;
    }

    const pgto = $('cli-pgto').value;
    const msg = `*NOVO PEDIDO*\nüë§ ${nome}\nüí∞ Pagamento: ${pgto}\n\n*ITENS:*\n${itemsTxt}${cupomTxt}\n\n*TOTAL: ${fmt(finalTotal)}*`;
    
    try{
        fetch("https://hook.eu1.make.com/yisqs4w309ogi6fx4969dbsr2q7fu7il", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                cliente:{nome:nome},
                pedido:{itens:itensApi, total:finalTotal, pgto:pgto, obs:"App V2"}
            })
        });
    }catch(e){}

    window.location.href = `https://wa.me/5565996813588?text=${encodeURIComponent(msg)}`;
}

function formatName(s){
    if(!s) return '';
    return s.replace(/\*\*\*(.*?)\*\*\*/g, '$1')
            .toLowerCase().replace(/(?:^|\s)\S/g, a=>a.toUpperCase());
}
function parseMoney(s){ return parseFloat(s.replace('R$','').replace('.','').replace(',','.').trim()); }
function fmt(v){ return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function showToast(m,t){
    const d=document.createElement('div'); d.className='toast';
    d.style.background= t==='r'?'var(--c-err)':'var(--c-ok)';
    d.innerText=m; $('toast-container').appendChild(d);
    setTimeout(()=>d.remove(), 2500);
}
function zoom(s){ $('zoom-img').src=s; $('modal-image-zoom').showModal(); }

init();
</script>
</body>
</html>
