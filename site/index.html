<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Super Cestas B√°sicas Dona Ant√¥nia - Cestas de qualidade e pre√ßo justo em Cuiab√° e V√°rzea Grande. Encomende online agora!">
    
    <meta name="geo.region" content="BR-MT" />
    <meta name="geo.placename" content="Cuiab√°" />
    <meta name="theme-color" content="#0F172A"> 
    <title>Super Cestas B√°sicas Dona Ant√¥nia</title>

    <style>
        /* --- DESIGN SYSTEM OTIMIZADO (PERFORMANCE & ACESSIBILIDADE) --- */
        :root {
            --cor-primary: #0F172A;
            --cor-action: #FF6D00;
            --cor-success: #008037; 
            --cor-warning: #FFAB00;
            --cor-danger: #D32F2F; 
            --cor-bg: #F1F5F9;
            --cor-surface: #FFFFFF; 
            --cor-text-main: #1E293B;
            --cor-text-light: #64748B;
            --cor-divider: #E2E8F0;
            
            --font-stack: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            
            --radius-md: 8px;
            --shadow-soft: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Reset & Base */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline-color: var(--cor-action); }
        
        body {
            font-family: var(--font-stack);
            background-color: #F1F5F9; 
            color: var(--cor-text-main);
            margin: 0;
            padding-bottom: 100px;
            font-size: 16px; 
            line-height: 1.5;
            min-height: 100vh;
            overflow-x: hidden; 
            width: 100%;
        }

        /* Container Limitador para Desktop */
        .limit-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
            width: 100%;
        }

        h1, h2, h3 { margin: 0; font-weight: 700; color: var(--cor-primary); letter-spacing: -0.02em; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; font-weight: 600; }
        
        button:focus-visible, input:focus-visible, select:focus-visible {
            outline: 3px solid var(--cor-action);
            outline-offset: 2px;
        }

        /* --- HEADER --- */
        .header-wrapper {
            position: sticky; top: 0; z-index: 1000;
            background: var(--cor-primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            width: 100%;
        }

        header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 24px; /* Aumentado o padding para n√£o encostar */
            min-height: 70px;
            width: 100%;
        }
        
        .header-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .logo { width: 44px; height: 44px; border-radius: 50%; border: 2px solid white; object-fit: cover; flex-shrink: 0; }
        
        .page-title { 
            font-size: 1rem; font-weight: 700; color: white; 
            white-space: normal; /* Permite quebra de linha */
            line-height: 1.2;
            overflow: visible;
        }
        
        .btn-whatsapp-header {
            background: #25D366; color: white;
            border-radius: 50%; padding: 0; 
            display: flex; align-items: center; justify-content: center;
            width: 44px; height: 44px; /* Bot√£o maior */
            font-size: 0.85rem; font-weight: 700;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
            margin-left: 10px;
        }

        /* --- STICKY BARS --- */
        .sticky-stack { position: sticky; top: 0; z-index: 999; width: 100%; background: var(--cor-bg); }

        .balance-bar {
            background: var(--cor-primary); color: white;
            padding: 8px 16px; 
            display: none; 
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .balance-bar.credit { background: var(--cor-warning); color: #1a1a1a; }
        .balance-bar.success { background: var(--cor-success); }
        
        .balance-info { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .balance-val { font-size: 1.1rem; font-weight: 800; line-height: 1.1; }
        .balance-label { font-size: 0.65rem; text-transform: uppercase; font-weight: 700; opacity: 0.9; line-height: 1.2; }

        .search-container {
            padding: 12px 16px;
            background: var(--cor-bg);
            display: none;
            border-bottom: 1px solid var(--cor-divider);
        }
        .search-box {
            width: 100%; padding: 14px 16px;
            padding-right: 40px; /* Espa√ßo para o bot√£o X */
            border: 1px solid var(--cor-divider); border-radius: var(--radius-md);
            background: white;
            font-size: 1rem; color: var(--cor-text-main);
            box-shadow: var(--shadow-soft);
        }

        .btn-clear-search {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1.1rem;
            padding: 5px;
            display: none; /* Oculto por padr√£o */
            z-index: 10;
        }
        .btn-clear-search:hover { color: var(--cor-danger); }

        /* FILTROS (CHIPS) */
        .filters-container {
            padding: 0 16px 12px;
            background: var(--cor-bg);
            border-bottom: 1px solid var(--cor-divider);
            display: none; 
            gap: 8px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .filters-container::-webkit-scrollbar { display: none; }
        
        .filter-chip {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid #CBD5E1;
            background: white;
            font-size: 0.85rem;
            color: var(--cor-text-light);
            font-weight: 600;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .filter-chip:active { transform: scale(0.95); }
        .filter-chip.active {
            background: var(--cor-primary);
            color: white;
            border-color: var(--cor-primary);
            box-shadow: 0 2px 4px rgba(15, 23, 42, 0.2);
        }

        /* --- LAYOUT --- */
        .view { display: none; padding-bottom: 20px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- HOME HERO --- */
        .hero-section {
            background: white; padding: 30px 20px; text-align: center;
            border-bottom: 1px solid var(--cor-divider); margin-bottom: 20px;
        }
        .hero-title { font-size: 1.4rem; margin-bottom: 8px; color: var(--cor-primary); line-height: 1.2; font-weight: 800; }
        .hero-subtitle { font-size: 0.9rem; color: var(--cor-text-light); margin-bottom: 5px; }
        .hero-tag { 
            display: inline-block; background: #E0F2F1; color: #00695C; 
            padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; margin-top: 5px;
        }

        /* --- CARDS CESTA --- */
        .grid-cestas { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 0 20px 20px; }
        .cesta-card { 
            background: white; border-radius: var(--radius-md); overflow: hidden;
            box-shadow: var(--shadow-soft); cursor: pointer; border: 1px solid transparent;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .cesta-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .cesta-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #eee; }
        .cesta-content { padding: 16px; }
        .cesta-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 4px; color: var(--cor-primary); }
        .cesta-price { font-size: 1.4rem; font-weight: 800; color: var(--cor-action); margin-top: 8px; }
        
        .btn-choose {
            width: 100%; padding: 12px; margin-top: 12px;
            background: var(--cor-primary); color: white;
            border-radius: 6px; font-size: 0.9rem; text-transform: uppercase;
        }

        /* --- LISTA BASE --- */
        .basket-base-list { background: white; padding: 16px; margin-bottom: 20px; box-shadow: var(--shadow-soft); }
        .base-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--cor-divider);
        }
        .base-item-name { font-size: 0.95rem; font-weight: 600; color: var(--cor-text-main); flex: 1; padding-right: 10px; }
        
        .qty-control {
            display: flex; align-items: center; gap: 8px;
            background: #F1F5F9; padding: 4px; border-radius: 24px;
            border: 1px solid #E2E8F0;
        }
        .btn-q { 
            width: 32px; height: 32px; border-radius: 50%;
            background: white; color: var(--cor-primary); 
            font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .val-q { font-weight: 700; font-size: 1rem; min-width: 24px; text-align: center; }

        /* --- CARROSSEL --- */
        .carousel-container { margin-bottom: 30px; background: white; padding-bottom: 15px; border-top: 1px solid var(--cor-divider); position: relative; }
        .carousel-header { 
            padding: 15px 20px 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .carousel-title { font-size: 1.1rem; font-weight: 700; color: var(--cor-primary); }
        
        .carousel-track {
            display: flex; overflow-x: auto; padding: 0 20px 10px; gap: 12px;
            scroll-snap-type: x mandatory; 
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            scroll-behavior: smooth;
        }
        .carousel-track::-webkit-scrollbar { display: none; }

        /* ALTERA√á√ÉO: Tamanho diminu√≠do 15% (190px -> 160px) */
        .prod-card {
            flex: 0 0 160px; scroll-snap-align: start;
            background: white; border: 1px solid var(--cor-divider); border-radius: var(--radius-md);
            padding: 10px; display: flex; flex-direction: column;
            position: relative;
        }
        /* Bloqueio visual para ofertas na home */
        .prod-card.disabled { opacity: 0.8; }

        .prod-img { 
            width: 100%; aspect-ratio: 1; object-fit: contain; 
            margin-bottom: 10px; background: white;
        }
        
        .prod-name { 
            font-size: 0.75rem; 
            line-height: 1.3; height: 3.9em; 
            overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
            color: var(--cor-text-main); margin-bottom: 8px;
            text-transform: uppercase;
        }
        .prod-price { font-size: 1rem; font-weight: 800; color: var(--cor-action); margin-top: auto; }
        
        /* SETAS CARROSSEL DESKTOP */
        .carousel-arrow {
            display: none; position: absolute; top: 55%; transform: translateY(-50%);
            width: 40px; height: 40px; background: white; border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 10;
            align-items: center; justify-content: center; font-size: 1.2rem;
            cursor: pointer; color: var(--cor-primary);
            border: 1px solid #eee;
        }
        .carousel-arrow:hover { background: #f8f8f8; }
        .arrow-left { left: 10px; }
        .arrow-right { right: 10px; }

        /* --- BOTOES E A√áOES --- */
        .btn-main-action {
            width: 100%; padding: 16px; border-radius: var(--radius-md);
            background: var(--cor-action); color: white; font-weight: 700;
            font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: background 0.2s;
        }
        .btn-main-action:active { background: #E65100; transform: scale(0.98); }
        
        .checkout-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 15px 20px; z-index: 1001; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
        }

        /* --- MODAIS --- */
        dialog { 
            border: none; border-radius: 16px; width: 90%; max-width: 400px; 
            padding: 0; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            background: white;
        }
        dialog:not([open]) { display: none; }
        dialog::backdrop { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); }
        
        .modal-body { padding: 24px; text-align: center; }
        .modal-title { font-size: 1.25rem; margin-bottom: 12px; color: var(--cor-primary); font-weight: 800; }
        .modal-text { color: var(--cor-text-light); margin-bottom: 24px; line-height: 1.5; }
        
        .btn-modal { width: 100%; padding: 14px; border-radius: 8px; font-weight: 700; margin-bottom: 10px; font-size: 0.95rem; }
        .btn-modal.primary { background: var(--cor-success); color: white; }
        .btn-modal.secondary { background: white; border: 2px solid var(--cor-action); color: var(--cor-action); }
        .btn-modal.ghost { color: var(--cor-text-light); font-weight: 400; margin-top: 10px; }

        /* Desktop Adjustments */
        @media (min-width: 900px) {
            .grid-cestas { grid-template-columns: repeat(3, 1fr); }
            .prod-card { flex: 0 0 180px; }
            .checkout-bar { 
                max-width: 1200px; 
                left: 50%; transform: translateX(-50%); 
            }
            .carousel-track::-webkit-scrollbar { 
                display: block; height: 8px; 
            }
            .carousel-track::-webkit-scrollbar-thumb {
                background: #ccc; border-radius: 4px;
            }
            .carousel-arrow { display: flex; }
        }
    </style>
</head>
<body>

    <div class="header-wrapper" id="header-wrapper">
        <header class="limit-container">
            <div class="header-left">
                <img src="img/logo.webp" class="logo" alt="Logo Dona Ant√¥nia" width="44" height="44">
                <div class="page-title">Super Cestas<br>Dona Ant√¥nia</div>
            </div>
            <a href="https://wa.me/5565996813588" target="_blank" class="btn-whatsapp-header" aria-label="Falar no WhatsApp">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.005 2.01C6.533 2.01 2.083 6.46 2.083 11.929C2.083 13.799 2.607 15.617 3.6 17.193L2.83 21.239L6.965 20.465C8.496 21.373 10.232 21.848 12.005 21.848C17.476 21.848 21.926 17.398 21.926 11.929C21.926 9.281 20.894 6.79 19.02 4.916C17.146 3.042 14.655 2.01 12.005 2.01ZM17.472 14.382C17.394 14.77 17.63 14.829 17.718 14.976C17.806 15.123 17.806 15.771 17.536 16.538C17.266 17.304 15.965 17.998 15.334 18.092C14.764 18.177 14.047 18.206 13.266 17.957C12.756 17.795 12.102 17.579 11.264 17.217C7.742 15.696 5.443 12.15 5.267 11.914C5.09 11.678 3.824 9.998 3.824 8.259C3.824 6.52 4.737 5.665 5.061 5.311C5.385 4.957 5.768 4.869 6.004 4.869C6.239 4.869 6.475 4.869 6.681 4.869C6.887 4.869 7.181 4.78 7.476 5.488C7.77 6.195 8.477 7.934 8.566 8.111C8.654 8.288 8.713 8.494 8.595 8.729C8.478 8.965 8.419 9.112 8.242 9.318C8.065 9.524 7.87 9.779 7.711 9.939C7.534 10.115 7.35 10.306 7.556 10.659C7.762 11.013 8.479 12.182 9.541 13.129C10.89 14.332 12.028 14.706 12.381 14.882C12.734 15.059 12.94 15.03 13.146 14.794C13.352 14.558 14.029 13.763 14.265 13.409C14.501 13.055 14.737 13.114 15.061 13.232C15.385 13.35 17.119 14.205 17.472 14.382Z"/>
                    </svg>
                </a>
            </div>
        </div>

        <div class="sticky-stack">
        <div id="balance-bar" class="balance-bar">
            <div class="limit-container" style="display:grid; grid-template-columns: auto 1fr auto; align-items:center; gap:10px; width:100%;">
                
                <div style="display:flex; align-items:center; gap:10px;">
                    <button onclick="goHome()" style="color:white; font-size:1.4rem; padding:5px; line-height:1;" aria-label="Voltar">‚ùÆ</button>
                    <img src="img/logo.webp" style="width:36px; height:36px; border-radius:50%; border:2px solid white; object-fit:cover;">
                </div>

                <div class="balance-info">
                    <span class="balance-label" id="balance-label">Seu Cofre</span>
                    <div class="balance-val" id="balance-val">R$ 0,00</div>
                    <div id="balance-sub" style="font-size:0.7rem; font-weight:400; opacity:0.9; text-align:center; line-height:1.1"></div>
                </div>

                <a href="https://wa.me/5565996813588" target="_blank" class="btn-whatsapp-header" aria-label="Falar no WhatsApp" style="width:36px; height:36px; padding:0;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.005 2.01C6.533 2.01 2.083 6.46 2.083 11.929C2.083 13.799 2.607 15.617 3.6 17.193L2.83 21.239L6.965 20.465C8.496 21.373 10.232 21.848 12.005 21.848C17.476 21.848 21.926 17.398 21.926 11.929C21.926 9.281 20.894 6.79 19.02 4.916C17.146 3.042 14.655 2.01 12.005 2.01ZM17.472 14.382C17.394 14.77 17.63 14.829 17.718 14.976C17.806 15.123 17.806 15.771 17.536 16.538C17.266 17.304 15.965 17.998 15.334 18.092C14.764 18.177 14.047 18.206 13.266 17.957C12.756 17.795 12.102 17.579 11.264 17.217C7.742 15.696 5.443 12.15 5.267 11.914C5.09 11.678 3.824 9.998 3.824 8.259C3.824 6.52 4.737 5.665 5.061 5.311C5.385 4.957 5.768 4.869 6.004 4.869C6.239 4.869 6.475 4.869 6.681 4.869C6.887 4.869 7.181 4.78 7.476 5.488C7.77 6.195 8.477 7.934 8.566 8.111C8.654 8.288 8.713 8.494 8.595 8.729C8.478 8.965 8.419 9.112 8.242 9.318C8.065 9.524 7.87 9.779 7.711 9.939C7.534 10.115 7.35 10.306 7.556 10.659C7.762 11.013 8.479 12.182 9.541 13.129C10.89 14.332 12.028 14.706 12.381 14.882C12.734 15.059 12.94 15.03 13.146 14.794C13.352 14.558 14.029 13.763 14.265 13.409C14.501 13.055 14.737 13.114 15.061 13.232C15.385 13.35 17.119 14.205 17.472 14.382Z"/>
                    </svg>
                </a>
            </div>
        </div>

        <div id="search-container" class="search-container">
            <div class="limit-container" style="position:relative">
                <input type="text" id="search-input" class="search-box" placeholder="üîç Buscar produto (ex: arroz, sab√£o)..." aria-label="Buscar produtos" oninput="renderCatalogo()">
                <button class="btn-clear-search" id="btn-clear-search" onclick="clearSearch()">‚úï</button>
            </div>
        </div>
        
        <div id="filters-container" class="filters-container">
            <div class="limit-container" style="display:flex; gap:8px;">
                <button class="filter-chip active" onclick="setSort('name')" id="sort-name">A-Z</button>
                <button class="filter-chip" onclick="setSort('price_asc')" id="sort-price_asc">Menor Pre√ßo</button>
                <button class="filter-chip" onclick="setSort('price_desc')" id="sort-price_desc">Maior Pre√ßo</button>
            </div>
        </div>
    </div>

    <main class="limit-container">
        <div id="view-home" class="view active">
            <div class="hero-section">
                <h2 class="hero-title">Mercado Online<br>Dona Ant√¥nia</h2>
                <p class="hero-subtitle">Encomendou, Chegou! üööüí®</p>
                <div class="hero-tag">PAGUE S√ì NA ENTREGA</div>
            </div>
            
            <div id="home-offers-container"></div>

            <h3 style="margin: 0 20px 15px; font-size: 1.1rem;">Escolha sua Cesta Base:</h3>
            <div class="grid-cestas" id="cestas-list">
                <p style="text-align:center; padding: 20px;">Carregando cestas...</p>
            </div>
        </div>

        <div id="view-custom" class="view">
            <div class="basket-base-list" id="basket-base-list"></div>
            
            <div id="catalogo-content"></div>
        </div>
    </main>

    <div id="checkout-bar" class="checkout-bar" style="display:none">
        <div>
            <div class="balance-label" style="color:#64748B">Total do Pedido</div>
            <div class="balance-val" id="chk-total-val" style="color:var(--cor-primary)">R$ 0,00</div>
        </div>
        <button class="btn-main-action" style="width:auto; padding: 12px 24px; font-size:0.9rem" onclick="openCheckoutModal()">
            CONCLUIR PEDIDO
        </button>
    </div>

    <dialog id="modal-decision">
        <div class="modal-body">
            <h3 class="modal-title" id="decision-title"></h3>
            <p class="modal-text">Voc√™ pode pedir a cesta original agora ou personalizar trocando itens.</p>
            
            <button class="btn-modal primary" onclick="orderFast()">PEDIR AGORA NO WHATSAPP</button>
            <button class="btn-modal secondary" onclick="startCustomization()">PERSONALIZAR CESTA</button>
            <button class="btn-modal ghost" onclick="document.getElementById('modal-decision').close()">Cancelar</button>
        </div>
    </dialog>

    <dialog id="modal-checkout">
        <div class="modal-body" style="text-align:left; padding: 15px 20px;">
            <h3 class="modal-title" style="margin-bottom:15px; text-align:center">Finalizar Pedido</h3>
            
            <div id="checkout-summary" style="margin-bottom:15px; font-size:0.9rem; background:#F8FAFC; padding:10px 15px; border-radius:8px; border:1px solid #eee; max-height: 40vh; overflow-y:auto;"></div>
            
            <div style="font-size:1.1rem; font-weight:800; text-align:right; margin-bottom:15px; color:var(--cor-primary)" id="checkout-total-display"></div>
            
            <label style="display:block; font-size:0.8rem; font-weight:700; color:#334155; margin-bottom:2px">Seu Nome:</label>
            <input type="text" id="cust-name" class="search-box" style="margin-bottom:10px; padding:10px; font-size:0.95rem" placeholder="Digite seu nome completo">
            
            <label style="display:block; font-size:0.8rem; font-weight:700; color:#334155; margin-bottom:2px">Forma de Pagamento:</label>
            <select id="cust-pay" class="search-box" style="margin-bottom:20px; padding:10px; font-size:0.95rem">
                <option>PIX (Na entrega)</option>
                <option>Dinheiro</option>
                <option>Cart√£o de Cr√©dito</option>
                <option>Cart√£o de D√©bito</option>
                <option>Cart√£o Alimenta√ß√£o</option>
            </select>
            
            <button class="btn-modal primary" onclick="sendOrder()">ENVIAR PEDIDO</button>
            <button class="btn-modal ghost" onclick="document.getElementById('modal-checkout').close()">Voltar</button>
        </div>
    </dialog>

    <script>
        // --- CONFIG ---
        const CONFIG_WHATSAPP = "5565996813588"; 
        
        const CONFIG_CATEGORIAS = {
            "Mercearia B√°sica": ["AMIDO", "SARDINHA", "ARROZ", "FEIJAO", "ACUCAR", "OLEO", "MILHARINA", "CUZ CUZ", "FARINHA", "FUBA", "MILHO VERDE", "SAL", "TRIGO"],
            "Beb√™ e Infantil": ["FRALDA", "LENCO UMEDECIDO", "HUGGIES", "POMADA", "MUCILON"],
            "Cabelo, Unha, Corpo e Maquiagem": ["LOCAO", "LO√á√ÉO", "ELASTICO DE CABELO", "Necessaire", "PIN√áA", "AGUA OXIGENADA", "ACETONA", "PIRANHA", "PRESILHA", "XUXINHA", "LA√áO", "RABICO", "ESPONJA DE MAQUIAGEM", "LIXA DE UNHA", "CORTADOR DE UNHA", "SHAMPOO", "CONDICIONADOR", "PENTE", "ESCOVA DE CABELO", "CREME DE PENTEAR"],
            "Higiene Pessoal": ["TALCO", "APARELHO BARBEAR", "LAMINAS DE BARBEAR", "ESPONJA DE BANHO", "SABONETE", "DESODORANTE", "ABSORVENTE", "ALGODAO", "COTONETE", "GILETTE"],
            "Higiene Bucal": ["CREME DENTAL", "ESCOVA DENTAL", "FIO DENTAL"],
            "Lavanderia": ["LAVA ROUPA", "ESCOVA LAVANDERIA", "SABAO", "OMO", "YPE", "AMACIANTE", "AGUA SANITARIA", "VARAL", "PREGADOR", "PRENDEDOR"],
            "Limpeza da Casa": ["PEDRA SAINARIA", "ESCOVA DE LIMPEZA", "ESPONJA MAGICA", "DESINFETANTE", "VEJA", "DETERGENTE", "ESPONJA DE A√áO", "BUCHA DE LAVAR LOU√áA", "PANO DE CH√ÉO", "INSETICIDA", "VASSOURA", "SACO DE LIXO", "RODO"],
            "Massas e Molhos": ["KETCHUP", "MAIONESE", "MOSTARDA", "MACARRAO", "EXTRATO DE TOMATE", "MOLHO DE TOMATE", "QUEIJO RALADO"],
            "Caf√© da Manh√£": ["CAFE", "FILTRO DE CAFE", "LEITE INTEGRAL", "LEITE DESNATADO", "ACHOCOLATADO", "CEREAL", "AVEIA", "SUCO", "CHA", "ERVA DE TERERE"],
            "Biscoitos e Lanches": ["BATATA PRINGLES", "BOLACHA WAFER", "BOLACHA SHOW", "BISCOITO", "BOLACHA", "WAFER", "TORRADA", "ROSQUINHA"],
            "Doces e Sobremesas": ["COCO RALADO", "DROPS", "TRIDENT", "LEITE CONDENSADO", "GELATINA", "BOLO", "MISTURA PRA BOLO", "CREME DE LEITE"],
            "Temperos": ["AZEITE", "CALDO", "TEMPERO", "PIMENTA", "VINAGRE", "CONDIMENTO"],
            "Cozinha": ["PALITO DENTAL", "ABRIDOR DE GARRAFA", "BALDE DE PIPOCA", "FORMA DE GELO", "JOGO AMERICANO", "PROCESSADOR", "TABUA DE CORTE", "CAPA PARA BOTIJAO", "CORTINA", "LUVA TERMICA", "PRATINHO", "LAVA LOU√áA", "ISQUEIRO", "COPO", "PANELA", "DESCANSO DE PANELA", "PRATO", "GARFO", "FACA", "COLHER", "TABUA DE CARNE", "TALHER", "PAPEL ALUMINIO", "TIGELA", "TRAVESSA", "CANECA", "PETISQUEIRA", "JARRA", "POTE", "CUMBUCA", "SOCADOR", "DESCASCADOR", "PENEIRA"],
            "Utilidades": ["BALAO", "ABRACADEIRA", "CANTONEIRA", "FITA ADESIVA", "PORTA COMPRIMIDOS", "PORTA OBJETOS", "PROTETOR VEDA", "RELOGIO", "LACRE", "CESTO", "AGULHEIRO", "ALFINETE", "LINHA", "CHAVEIRO", "LAMPADA", "PILHA", "FOSFORO", "RALO", "SUPORTE", "PREGO", "PARAFUSO", "PROTETOR DE RALO"],
            "Papelaria": ["ESTILETE", "CANETA", "LAPIS", "CADERNO", "BORRACHA", "APONTADOR", "CLIPS", "REGUA", "GRAMPEADOR", "GRAFITE", "LAPISEIRA", "LIVRO"],
            "Cal√ßados": ["CHINELO"]
        };

        // --- STATE ---
        let DB_PROD = [];
        let DB_CESTAS = [];
        let STATE = {
            cesta: null, cart: {}, basePrice: 0, currentTotal: 0, 
            isUnlocked: false, lastScroll: 0, sortType: 'name',
            initialGap: 0
        };

        // --- INIT ---
        async function init() {
            try {
                const [r1, r2] = await Promise.all([fetch('produtos-cesta-basica.json'), fetch('produtos.json')]);
                if (r1.ok) DB_CESTAS = await r1.json();
                if (r2.ok) {
                    let txt = await r2.text();
                    txt = txt.trim().replace(/,(\s+)?$/, "");
                    if (!txt.startsWith('[')) txt = '[' + txt + ']';
                    DB_PROD = JSON.parse(txt).filter(x => x.situacao === "A").map(p => ({
                        id: String(p.id), name: p.nome, price: parseFloat(p.preco),
                        img: `img/produtos/${p.codigo || p.id}.webp`
                    }));
                }
                renderHome();
            } catch (e) { 
                console.error(e);
                document.getElementById('cestas-list').innerHTML = '<p style="text-align:center; color:red">Erro ao carregar sistema. Atualize a p√°gina.</p>';
            }
        }

        // --- NAVIGATION ---
        function goHome() {
            STATE.cart = {}; STATE.isUnlocked = false; STATE.cesta = null; STATE.initialGap = 0;
            document.getElementById('view-home').classList.add('active');
            document.getElementById('view-custom').classList.remove('active');
            
            // Show Header on Home
            document.getElementById('header-wrapper').style.display = 'block';
            
            document.getElementById('balance-bar').style.display = 'none';
            document.getElementById('search-container').style.display = 'none';
            document.getElementById('filters-container').style.display = 'none';
            document.getElementById('checkout-bar').style.display = 'none';
            
            document.getElementById('catalogo-content').innerHTML = "";
            document.getElementById('search-input').value = ""; // Limpa busca
            window.scrollTo(0,0);
        }

        function renderHome() {
            const el = document.getElementById('cestas-list');
            el.innerHTML = DB_CESTAS.map(c => `
                <div class="cesta-card" onclick="openDecision('${c.id}')" tabindex="0" role="button" aria-label="Escolher ${c.nome}">
                    <img src="${c.imagem || ''}" class="cesta-img" alt="${c.nome}" loading="lazy" width="300" height="300">
                    <div class="cesta-content">
                        <div class="cesta-name">${c.nome}</div>
                        <div class="cesta-price">${fmt(c.preco)}</div>
                        <button class="btn-choose">VER DETALHES</button>
                    </div>
                </div>
            `).join('');
            
            renderHomeOffers();
        }

        function renderHomeOffers() {
            const offers = DB_PROD.filter(p => p.name.toUpperCase().startsWith("OFERTA"));
            if (offers.length === 0) return;
            
            const html = `
            <div class="carousel-container" style="border-top:none; margin-top:10px;">
                <div class="carousel-header">
                    <div class="carousel-title" style="color:var(--cor-danger)">üî• OFERTAS DA SEMANA</div>
                </div>
                <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                <div class="carousel-track">
                    ${offers.map(p => {
                        const displayName = p.name.replace(/(OFERTA)/i, '<span style="color:var(--cor-danger); font-weight:800">$1</span>');
                        return `
                            <div class="prod-card disabled" onclick="alert('Por favor, primeiro escolha uma Cesta Base acima para come√ßar seu pedido.')">
                                <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                <div class="prod-name">${displayName}</div>
                                <div class="prod-price">${fmt(p.price)}</div>
                                <div style="margin-top:auto; font-size:0.75rem; color:#999; text-align:center;">Escolha uma cesta</div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
            </div>`;
            document.getElementById('home-offers-container').innerHTML = html;
        }

        // --- LOGIC ---
        function openDecision(id) {
            STATE.cesta = DB_CESTAS.find(x => x.id === id);
            document.getElementById('decision-title').innerText = STATE.cesta.nome;
            document.getElementById('modal-decision').showModal();
        }

        function orderFast() {
            const msg = `Ol√°! Quero encomendar a *${STATE.cesta.nome}* no valor de *${fmt(STATE.cesta.preco)}*, sem altera√ß√µes.`;
            window.location.href = `https://wa.me/${CONFIG_WHATSAPP}?text=${encodeURIComponent(msg)}`;
        }

        function startCustomization() {
            document.getElementById('modal-decision').close();
            STATE.basePrice = STATE.cesta.preco;
            STATE.cart = {}; 
            
            // Calculate initial sum to handle drift
            let initialSum = 0;

            STATE.cesta.produtos.forEach(itemStr => {
                const [q, id] = itemStr.split('x ');
                const pid = id.trim();
                const product = DB_PROD.find(p => p.id === pid);
                if (product) {
                    STATE.cart[pid] = parseInt(q);
                    initialSum += product.price * parseInt(q);
                }
            });

            // Adjust gap so total starts at basket price
            STATE.initialGap = STATE.cesta.preco - initialSum;

            document.getElementById('view-home').classList.remove('active');
            document.getElementById('view-custom').classList.add('active');
            
            // Hide Header on Customization
            document.getElementById('header-wrapper').style.display = 'none';
            
            // Show Balance Bar (which now contains navigation)
            document.getElementById('balance-bar').style.display = 'block'; 
            document.getElementById('search-container').style.display = 'block';
            document.getElementById('filters-container').style.display = 'flex'; // Usamos flex pelo layout interno
            document.getElementById('checkout-bar').style.display = 'flex';
            
            STATE.isUnlocked = true;
            document.getElementById('search-input').value = ""; // Limpa busca
            
            updateUI();
            renderBaseList();
            renderCatalogo();
            window.scrollTo(0,0);
        }

        function updateUI() {
            const sumCart = Object.entries(STATE.cart).reduce((acc, [id, q]) => {
                const p = DB_PROD.find(x => x.id === id);
                return acc + (p ? p.price * q : 0);
            }, 0);
            
            // Apply initial gap
            STATE.currentTotal = sumCart + (STATE.initialGap || 0);

            const diff = STATE.basePrice - STATE.currentTotal;
            const bar = document.getElementById('balance-bar');
            const lbl = document.getElementById('balance-label');
            const val = document.getElementById('balance-val');
            const sub = document.getElementById('balance-sub');

            if (diff > 0.01) {
                bar.className = 'balance-bar credit';
                lbl.innerText = "VOC√ä AINDA TEM";
                val.innerText = fmt(diff);
                sub.innerText = "em cr√©dito para gastar";
            } else {
                bar.className = 'balance-bar success';
                lbl.innerText = "TOTAL DA CESTA";
                val.innerText = fmt(STATE.currentTotal);
                sub.innerText = diff < -0.01 ? `Voc√™ excedeu ${fmt(Math.abs(diff))}` : "Valor exato atingido";
            }
            document.getElementById('chk-total-val').innerText = fmt(STATE.currentTotal);
        }

        function upd(pid, d) {
            STATE.cart[pid] = (STATE.cart[pid] || 0) + d;
            if (STATE.cart[pid] <= 0) delete STATE.cart[pid];
            updateUI();
            
            if (STATE.isUnlocked) {
                // Atualizar TODOS os contadores com a classe espec√≠fica
                const els = document.querySelectorAll(`.qty-${pid}`);
                if (els.length > 0) {
                    els.forEach(el => el.innerText = STATE.cart[pid] || 0);
                } else {
                    renderCatalogo(); 
                }
            } else {
                renderBaseList(); 
            }
        }

        function setSort(type) {
            STATE.sortType = type;
            // Atualiza bot√µes
            document.querySelectorAll('.filter-chip').forEach(b => b.classList.remove('active'));
            document.getElementById(`sort-${type}`).classList.add('active');
            renderCatalogo();
        }

        function clearSearch() {
            document.getElementById('search-input').value = "";
            renderCatalogo();
        }

        // --- RENDERING ---
        function renderBaseList() {
            const el = document.getElementById('basket-base-list');
            el.innerHTML = `<h3 style="font-size:1rem; margin-bottom:15px; color:var(--cor-text-light)">Itens da Cesta Base</h3>` + 
            STATE.cesta.produtos.map(itemStr => {
                const pid = itemStr.split('x ')[1].trim();
                const p = DB_PROD.find(x => x.id === pid);
                if (!p) return '';
                const qty = STATE.cart[pid] || 0;
                if(qty === 0 && STATE.isUnlocked) return ''; 
                
                return `
                <div class="base-item">
                    <span class="base-item-name">${p.name}</span>
                    <div class="qty-control">
                        <button class="btn-q" onclick="upd('${pid}', -1)" aria-label="Remover">-</button>
                        <span class="val-q qty-${pid}">${qty}</span>
                        <button class="btn-q" onclick="upd('${pid}', 1)" aria-label="Adicionar">+</button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderCatalogo() {
            const query = document.getElementById('search-input').value.toUpperCase();
            const btnClear = document.getElementById('btn-clear-search');
            if(btnClear) btnClear.style.display = query ? 'block' : 'none';

            let html = "";
            
            // Define fun√ß√£o de ordena√ß√£o
            let sorter;
            if (STATE.sortType === 'price_asc') sorter = (a, b) => a.price - b.price;
            else if (STATE.sortType === 'price_desc') sorter = (a, b) => b.price - a.price;
            else sorter = (a, b) => a.name.localeCompare(b.name); // Padr√£o A-Z

            if (query) {
                // MODO BUSCA: √önico Carrossel com todos os resultados
                let results = DB_PROD.filter(p => p.name.toUpperCase().includes(query));
                results.sort(sorter);

                if (results.length > 0) {
                    html = `
                    <div class="carousel-container" id="search-results-carousel">
                        <div class="carousel-header"><div class="carousel-title">Resultados da Busca</div></div>
                        <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                        <div class="carousel-track">
                            ${results.map(p => `
                                <div class="prod-card">
                                    <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                    <div class="prod-name">${p.name}</div>
                                    <div class="prod-price">${fmt(p.price)}</div>
                                    <div class="qty-control" style="margin-top:auto; justify-content:space-between; width:100%">
                                        <button class="btn-q" onclick="upd('${p.id}', -1)">-</button>
                                        <span class="val-q qty-${p.id}">${STATE.cart[p.id] || 0}</span>
                                        <button class="btn-q" onclick="upd('${p.id}', 1)">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
                    </div>`;
                    
                    document.getElementById('catalogo-content').innerHTML = html;
                    
                    // Rolar a p√°gina para que os resultados fiquem vis√≠veis logo abaixo dos chips
                    const catalogo = document.getElementById('catalogo-content');
                    const stickyHeight = document.querySelector('.sticky-stack').offsetHeight + document.querySelector('.header-wrapper').offsetHeight;
                    
                    // Usa setTimeout para garantir que a renderiza√ß√£o ocorreu antes do scroll
                    setTimeout(() => {
                        window.scrollTo({
                            top: catalogo.offsetTop - stickyHeight - 20,
                            behavior: 'smooth'
                        });
                    }, 50);

                } else {
                    document.getElementById('catalogo-content').innerHTML = `<p style="text-align:center; padding:30px; color:#666">Nenhum produto encontrado para "${query}".</p>`;
                }
                
                return; // Encerra aqui se houver busca
            }

            // MODO NORMAL (Categorias)
            // 1. Renderizar OFERTAS (se existirem)
            const offers = DB_PROD.filter(p => p.name.toUpperCase().startsWith("OFERTA"));
            if (offers.length > 0) {
                offers.sort(sorter);
                html += `
                <div class="carousel-container">
                    <div class="carousel-header">
                        <div class="carousel-title" style="color:var(--cor-danger)">üî• SUPER OFERTAS</div>
                    </div>
                    <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                    <div class="carousel-track">
                        ${offers.map(p => {
                            const displayName = p.name.replace(/(OFERTA)/i, '<span style="color:var(--cor-danger); font-weight:800">$1</span>');
                            return `
                                <div class="prod-card">
                                    <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                    <div class="prod-name">${displayName}</div>
                                    <div class="prod-price">${fmt(p.price)}</div>
                                    <div class="qty-control" style="margin-top:auto; justify-content:space-between; width:100%; padding:2px 4px;">
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', -1)">-</button>
                                        <span class="val-q qty-${p.id}" style="font-size:0.9rem">${STATE.cart[p.id] || 0}</span>
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', 1)">+</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
                </div>`;
            }

            // 2. Renderizar Categorias Normais
            Object.keys(CONFIG_CATEGORIAS).forEach(catName => {
                let catProds = DB_PROD.filter(p => {
                    const first3 = p.name.toUpperCase().split(' ').slice(0, 3).join(' ');
                    return CONFIG_CATEGORIAS[catName].some(key => first3.includes(key));
                });
                
                catProds.sort(sorter);

                if (catProds.length > 0) {
                    html += `
                    <div class="carousel-container">
                        <div class="carousel-header">
                            <div class="carousel-title">${catName}</div>
                        </div>
                        <button class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-200, behavior:'smooth'})">‚ùÆ</button>
                        <div class="carousel-track">
                            ${catProds.map(p => `
                                <div class="prod-card">
                                    <img src="${p.img}" class="prod-img" loading="lazy" alt="${p.name}" width="150" height="150">
                                    <div class="prod-name">${p.name}</div>
                                    <div class="prod-price">${fmt(p.price)}</div>
                                    <div class="qty-control" style="margin-top:auto; justify-content:space-between; width:100%; padding:2px 4px;">
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', -1)">-</button>
                                        <span class="val-q qty-${p.id}" style="font-size:0.9rem">${STATE.cart[p.id] || 0}</span>
                                        <button class="btn-q" style="width:28px; height:28px" onclick="upd('${p.id}', 1)">+</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <button class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:200, behavior:'smooth'})">‚ùØ</button>
                    </div>`;
                }
            });
            
            document.getElementById('catalogo-content').innerHTML = html;
        }

        // --- CHECKOUT ---
        function openCheckoutModal() {
            if (STATE.currentTotal < (STATE.basePrice - 0.5)) {
                alert(`Ainda falta ${fmt(STATE.basePrice - STATE.currentTotal)} para atingir o valor da cesta!`);
                return;
            }
            
            let html = "";
            Object.entries(STATE.cart).forEach(([id, q]) => {
                const p = DB_PROD.find(x => x.id === id);
                html += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee">
                    <span style="flex:1; padding-right:10px; font-size:0.9rem; font-weight:600">${p.name}</span>
                    <span style="font-weight:700; font-size:1rem; background:#eee; padding:4px 10px; border-radius:4px">${q}x</span>
                </div>`;
            });
            
            document.getElementById('checkout-summary').innerHTML = html;
            document.getElementById('checkout-total-display').innerText = `Total: ${fmt(STATE.currentTotal)}`;
            document.getElementById('modal-checkout').showModal();
        }

        function sendOrder() {
            const name = document.getElementById('cust-name').value;
            const pay = document.getElementById('cust-pay').value;
            
            if (!name) return alert("Por favor, digite seu nome.");
            
            let msg = `*NOVO PEDIDO (PERSONALIZADO)*\n`;
            msg += `üë§ Cliente: ${name}\n`;
            msg += `üí∞ Pagamento: ${pay}\n`;
            msg += `üì¶ Cesta Base: ${STATE.cesta.nome}\n\n`;
            msg += `*ITENS DO PEDIDO:*\n`;
            
            Object.entries(STATE.cart).forEach(([id, q]) => {
                const p = DB_PROD.find(x => x.id === id);
                msg += `${q}x ${p.name}\n`;
            });
            
            msg += `\n*VALOR TOTAL: ${fmt(STATE.currentTotal)}*`;
            
            window.location.href = `https://wa.me/${CONFIG_WHATSAPP}?text=${encodeURIComponent(msg)}`;
        }

        function fmt(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
        
        init();
    </script>
</body>
</html>
