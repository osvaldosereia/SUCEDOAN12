<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
<head>
    <!-- 
        ================================================================
        ARCHITECT: SEO Code Architect (SCA)
        VERSION: 9.43 - Mobile Layout Re-Architecture
        CHANGELOG:
        - LAYOUT (Mobile): "Minha Cesta" agora ocupa largura total (grid-column: 1/-1) no topo.
        - LAYOUT (Mobile): Sidebar e Extras dividem o espa√ßo abaixo da cesta.
        - LAYOUT (Desktop): Mantida estrutura cl√°ssica (Sidebar Esquerda | Conte√∫do Direita).
        - UI: Adicionado separador visual explicativo "Personalize sua cesta abaixo".
        ================================================================
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <meta name="color-scheme" content="light only">
    <meta name="theme-color" content="#ffffff">
    
    <title>Cestas B√°sicas em Cuiab√° e V√°rzea Grande | Dona Ant√¥nia</title>
    <meta name="description" content="Compre Cesta B√°sica em Cuiab√° e V√°rzea Grande com entrega gr√°tis*. Personalize sua cesta com Arroz Tio Alvino. Pagamento na entrega.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="produtos/produtos.json" as="fetch" crossorigin="anonymous">

    <style>
        /* --- 1. RESET & VARIABLES --- */
        :root { 
            color-scheme: light;
            --primary: #dc2626; 
            --primary-dark: #b91c1c; 
            --secondary: #1e293b; 
            --text-main: #334155; 
            --text-light: #475569; 
            --bg-body: #ffffff;
            --border-color: #e2e8f0;
            --header-height: 60px;
            --app-bar-height: 0px; 
            --checkout-bar-height: 80px; 
            --radius-lg: 16px;
            --shadow-float: 0 10px 30px -5px rgba(0, 0, 0, 0.15);
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-body: #ffffff !important;
                --text-main: #334155 !important;
                --text-light: #475569 !important;
                --border-color: #e2e8f0 !important;
            }
            body, html {
                background-color: #ffffff !important;
                color: #334155 !important;
            }
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        html { scroll-behavior: smooth; background-color: #ffffff; }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-body); color: var(--text-main); line-height: 1.5; 
            padding-bottom: var(--app-bar-height); -webkit-font-smoothing: antialiased; 
            width: 100%;
        }

        @media (min-width: 1024px) { body { padding-bottom: 0; } }
        
        .container { max-width: 1320px; margin: 0 auto; padding: 0 16px; width: 100%; }
        img { display: block; max-width: 100%; height: auto; }
        button { cursor: pointer; border: none; font-family: inherit; background: none; }
        .hidden { display: none !important; }
        
        .visually-hidden {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0;
        }

        /* --- 2. HEADER --- */
        header { 
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); 
            background: rgba(255,255,255,0.98); border-bottom: 1px solid var(--border-color); z-index: 1000; 
            display: flex; align-items: center; backdrop-filter: blur(8px); 
            transition: transform 0.3s ease;
        }
        
        /* Rule to Hide Header completely when in Customizer Mode */
        body.customizer-mode header { display: none !important; }

        /* Legacy Scroll Hide (still useful for Home) */
        body.header-hidden header { transform: translateY(-100%); }

        @media (min-width: 1024px) {
            header { position: relative; } 
            body.header-hidden header { transform: none; } 
            body.customizer-mode header { display: flex !important; } /* Keep visible on Desktop */
        }

        .header-inner { display: flex; justify-content: space-between; align-items: center; height: 100%; }
        
        .logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1.2rem; color: var(--secondary); text-decoration: none; }
        .logo-circle { width: 36px; height: 36px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #b91c1c; font-weight: 800; font-size: 0.9rem; }
        
        .location-pill { 
            font-size: 0.8rem; font-weight: 600; color: var(--secondary); background: #f8fafc; 
            padding: 6px 14px; border-radius: 50px; border: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 6px;
        }

        /* --- 4. MOBILE CHECKOUT BAR --- */
        .mobile-checkout-bar {
            position: fixed; 
            bottom: 0; 
            left: 0; right: 0; height: var(--checkout-bar-height);
            background: #ffffff; border-top: 1px solid var(--border-color);
            z-index: 9998; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 -4px 25px rgba(0,0,0,0.1);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @media (min-width: 1024px) { .mobile-checkout-bar { display: none !important; } }

        .mcb-total { display: flex; flex-direction: column; line-height: 1.2; }
        .mcb-label { font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; font-weight: 600; }
        .mcb-value { font-size: 1.3rem; font-weight: 800; color: var(--primary); }
        
        .mcb-btn {
            background: #16a34a; color: white; border-radius: 50px; 
            padding: 12px 24px; font-weight: 700; font-size: 1rem;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(22, 163, 74, 0.25);
        }

        /* --- 5. HERO --- */
        #home-view { padding-top: var(--header-height); }
        @media (min-width: 1024px) { #home-view { padding-top: 0; } }
        
        .hero { background: #ffffff; padding: 40px 0 60px; text-align: center; border-bottom: 1px solid #f1f5f9; position: relative; overflow: hidden; }
        .hero-title { font-size: 2rem; font-weight: 800; color: var(--secondary); margin-bottom: 16px; line-height: 1.1; letter-spacing: -0.5px; }
        .hero-title span { color: var(--primary); }
        .hero-text { color: var(--text-light); font-size: 1.1rem; max-width: 500px; margin: 0 auto 30px; font-weight: 400; }
        
        .btn-cta-primary {
            background: var(--primary); color: white; font-weight: 700; padding: 14px 36px; 
            border-radius: 50px; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.3);
            display: inline-flex; align-items: center; gap: 8px; transition: transform 0.2s;
        }
        .btn-cta-primary:hover { transform: scale(1.03); background: var(--primary-dark); }
        
        .trust-badges { display: flex; justify-content: center; gap: 12px; margin-top: 30px; margin-bottom: 24px; flex-wrap: wrap; }
        
        .badge-item { display: flex; align-items: center; gap: 6px; background: #fff; padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 50px; font-size: 0.85rem; font-weight: 600; color: var(--secondary); }
        
        @media (min-width: 768px) { .hero { padding: 80px 0; } .hero-title { font-size: 3.5rem; } }

        /* --- 6. HOME GRID --- */
        .home-grid-container { padding: 40px 16px 80px; }
        .baskets-grid { display: grid; grid-template-columns: 1fr; gap: 24px; max-width: 1280px; margin: 0 auto; }
        @media (min-width: 600px) { .baskets-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .baskets-grid { grid-template-columns: repeat(4, 1fr); gap: 30px; } }

        .home-card { 
            background: white; border-radius: var(--radius-lg); border: 1px solid var(--border-color);
            overflow: hidden; display: flex; flex-direction: column; transition: transform 0.2s, box-shadow 0.2s;
        }
        .home-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-float); border-color: #cbd5e1; }
        .hc-image-wrap { width: 100%; aspect-ratio: 1/1; position: relative; background: #fff; display: flex; align-items: center; justify-content: center; padding: 20px; border-bottom: 1px solid #f8fafc; }
        .hc-image { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
        .hc-content { padding: 20px; flex: 1; display: flex; flex-direction: column; text-align: center; }
        .hc-title { font-size: 1.35rem; font-weight: 700; color: var(--secondary); margin-bottom: 8px; line-height: 1.2; }
        .hc-price { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 20px; }
        .hc-actions { margin-top: auto; display: grid; gap: 10px; }
        .btn-outline { border: 1px solid var(--border-color); background: white; color: var(--secondary); font-weight: 600; padding: 10px; border-radius: 50px; width: 100%; }
        .btn-fill { background: var(--secondary); color: white; border: none; font-weight: 600; padding: 12px; border-radius: 50px; width: 100%; }

        /* --- 7. CUSTOMIZER --- */
        #customizer-view { background: #f8fafc; min-height: 100vh; padding-bottom: 150px; padding-top: 0; }
        @media(min-width: 1024px) { #customizer-view { padding-bottom: 0; } }

        .cust-header-bar { 
            background: rgba(255,255,255,0.98); border-bottom: 1px solid var(--border-color);
            position: sticky; top: 0; z-index: 900; backdrop-filter: blur(10px);
            padding: 12px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        /* Mobile Quick Nav Bar */
        .mobile-quick-nav {
            position: sticky; top: 73px; z-index: 890;
            background: white; display: flex; border-bottom: 1px solid #e2e8f0;
            height: 42px; align-items: stretch; box-shadow: 0 4px 6px -4px rgba(0,0,0,0.05);
        }
        @media (min-width: 1024px) { .mobile-quick-nav { display: none; } }

        .mqn-btn {
            flex: 1; font-size: 0.7rem; font-weight: 600; color: var(--text-light);
            background: transparent; border: none; border-bottom: 3px solid transparent;
            transition: all 0.2s; text-transform: uppercase; padding: 0 4px; white-space: nowrap;
        }
        .mqn-btn.active { color: var(--primary); border-bottom-color: var(--primary); background: #fff1f2; }
        
        @media(min-width: 1024px) { .cust-header-bar { top: 0; z-index: 1050; } }

        .ch-container { display: flex; align-items: center; justify-content: space-between; gap: 16px; }
        .ch-back-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border-color); background: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
        .ch-info { display: flex; flex-direction: column; min-width: 80px; }
        .ch-info h2 { font-size: 0.85rem; font-weight: 700; color: var(--secondary); margin: 0; line-height: 1.2; }
        .limit-badge { font-size: 0.65rem; color: #b45309; background: #fffbeb; border: 1px solid #fde68a; padding: 2px 6px; border-radius: 4px; margin-top: 2px; display: inline-block; width: fit-content; }
        .limit-badge.error { color: #b91c1c; background: #fee2e2; border-color: #fca5a5; }
        .ch-search-box { flex: 1; position: relative; margin-left: 10px; }
        .ch-input { width: 100%; height: 48px; border-radius: 50px; border: 1px solid var(--border-color); padding: 0 45px 0 20px; font-size: 1rem; background: #f1f5f9; }
        .ch-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-light); pointer-events: none; }
        .ch-clear-btn { position: absolute; right: 40px; top: 50%; transform: translateY(-50%); background: #cbd5e1; color: #fff; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; cursor: pointer; border: none; z-index: 2; transition: all 0.2s; }
        .ch-desktop-cart { display: none; }

        /* === APP GRID LAYOUT RE-ARCHITECTURE === */
        .app-grid { 
            display: grid; 
            /* Mobile: Sidebar Left (115px) | Content Right (auto) */
            grid-template-columns: 115px 1fr; 
            gap: 10px; 
            margin-top: 24px; 
            padding-bottom: 40px; 
            padding-right: 0; 
        }

        /* 1. BASKET SECTION (Mobile: Full Width Top) */
        .basket-section {
            grid-column: 1 / -1; /* Spans full width on mobile */
            width: 100%;
            margin-bottom: 20px;
            scroll-margin-top: 120px;
        }

        /* 2. SIDEBAR (Mobile: Left Column below basket) */
        .mobile-nav-sidebar {
            display: block;
            position: sticky;
            /* Top accounts for QuickNav + Header + Basket scroll */
            /* Note: Sticky behavior inside grid rows can be tricky. */
            top: 115px; 
            height: calc(100vh - 115px); 
            overflow-y: auto;
            padding-right: 4px;
            padding-bottom: 120px; 
            scrollbar-width: thin;
            grid-column: 1; /* Left col */
        }

        /* 3. EXTRAS CONTENT (Mobile: Right Column below basket) */
        .products-section { 
            width: 100%; 
            min-width: 0; 
            grid-column: 2; /* Right col */
        }

        /* DESKTOP LAYOUT OVERRIDE */
        @media (min-width: 1024px) {
            .app-grid { 
                grid-template-columns: 380px 1fr; 
                gap: 30px; 
                align-items: start; 
                padding-right: 16px; 
            }
            
            /* Desktop: Sidebar Left, Content Right */
            .sidebar-desktop { 
                display: block; 
                grid-column: 1; 
                grid-row: 1 / span 10; /* Sidebar spans full height */
            }
            
            .mobile-nav-sidebar { display: none; }
            
            /* Desktop: Basket moves to Right Column, Top */
            .basket-section {
                grid-column: 2;
                margin-bottom: 30px;
            }
            
            /* Desktop: Extras below Basket in Right Column */
            .products-section {
                grid-column: 2;
            }

            .ch-desktop-cart { display: flex; align-items: center; gap: 16px; }
            .desk-price { text-align: right; line-height: 1.2; }
            .desk-price small { display: block; font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); }
            .desk-price strong { font-size: 1.2rem; color: var(--primary); }
            .btn-desk-checkout { background: #16a34a; color: white; padding: 0 24px; height: 42px; border-radius: 6px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        }

        /* Nav Buttons */
        .nav-side-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding: 10px 4px; margin-bottom: 8px; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; text-align: center; font-size: 0.65rem; color: var(--text-light); font-weight: 600; cursor: pointer; transition: all 0.2s; line-height: 1.2; word-break: break-word; }
        .nav-side-btn.active { background: var(--secondary); color: white; border-color: var(--secondary); transform: scale(1.05); }
        .nav-side-btn.nav-ofertas { color: #b45309; border-color: #fcd34d; background: #fffbeb; }
        .nav-side-btn.nav-ofertas.active { background: #b45309; color: white; border-color: #b45309; }
        .nav-side-btn.nav-cesta { color: var(--secondary); border-color: var(--secondary); background: #f8fafc; }
        .nav-side-btn.nav-cesta.active { background: var(--secondary); color: white; }
        .nav-side-btn:hover { border-color: #cbd5e1; }
        .nav-arrow-indicator { text-align: center; color: var(--text-light); font-size: 0.8rem; padding: 10px 0; opacity: 0.7; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 40% {transform: translateY(-5px);} 60% {transform: translateY(-3px);} }
        
        .nav-section-title { width: 100%; text-align: center; font-size: 0.75rem; font-weight: 600; color: var(--text-light); margin: 24px 0 10px 0; text-transform: uppercase; letter-spacing: 0.8px; padding: 6px 0; background: #f8fafc; border-radius: 6px; }
        .nav-section-title:first-of-type { margin-top: 10px; }
        @media (min-width: 1024px) { .nav-section-title { font-size: 0.85rem; margin-top: 24px; text-align: left; padding-left: 10px; } }

        .sidebar-desktop { display: none; }
        @media (min-width: 1024px) { .sidebar-desktop { display: block; position: sticky; top: 80px; background: white; border: 1px solid var(--border-color); border-radius: 12px; padding: 16px; max-height: calc(100vh - 100px); overflow-y: auto; align-self: start; } 
        .sidebar-title { font-size: 0.9rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin-bottom: 12px; }
        .sidebar-nav-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 24px; }
        .sidebar-chip { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 0.7rem; font-weight: 600; color: var(--secondary); text-align: center; padding: 8px 4px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .sidebar-chip:hover { border-color: var(--secondary); background: #e2e8f0; } }

        .section-header { background: #fff; padding: 16px 20px; border-radius: 12px 12px 0 0; border: 1px solid var(--border-color); border-bottom: none; margin-top: 20px; display:flex; justify-content: space-between; align-items: center; scroll-margin-top: 140px; }
        .section-header h3 { font-size: 1.1rem; font-weight: 700; color: var(--secondary); margin: 0; }
        
        .product-box { background: #fff; border: 1px solid var(--border-color); border-radius: 0 0 12px 12px; padding: 0; }
        @media (min-width: 600px) { .product-box { padding: 12px; } }
        
        .extras-separator-banner { text-align: center; padding: 30px 20px 10px; margin-bottom: 10px; }
        .extras-separator-banner h3 { font-size: 1.4rem; font-weight: 300; color: var(--secondary); margin-bottom: 5px; }
        .extras-separator-banner p { color: var(--text-light); font-size: 0.9rem; }

        .grid-products { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; align-items: stretch; padding: 8px; }
        @media (min-width: 600px) { .grid-products { grid-template-columns: repeat(3, 1fr); gap: 12px; } }
        @media (min-width: 1024px) { .grid-products { grid-template-columns: repeat(4, 1fr) !important; gap: 20px; } }

        /* Mobile Slider Customization */
        @media (max-width: 1023px) {
            #included-list.slider-mode { display: flex; flex-wrap: nowrap; overflow-x: auto; gap: 16px; padding: 10px 16px; scroll-snap-type: x mandatory; scrollbar-width: none; scroll-behavior: smooth; }
            #included-list.slider-mode::-webkit-scrollbar { display: none; }
            #included-list.slider-mode .mini-card { min-width: 100%; scroll-snap-align: center; background-color: #f8fafc; border-color: #e2e8f0; } /* Grey Bg */
            .slider-controls { display: flex; justify-content: center; gap: 30px; padding: 10px 0 20px; border-bottom: 1px solid #f1f5f9; margin-bottom: 10px; }
            .sc-btn { background: white; border: 1px solid #e2e8f0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 1.2rem; }
            .sc-btn:active { background: #f8fafc; transform: scale(0.95); }
        }
        @media (min-width: 1024px) { .slider-controls { display: none; } }

        .mini-card { display: flex; flex-direction: column; text-align: center; height: 100%; background: #fff; border: 1px solid #f1f5f9; border-radius: 8px; padding: 10px; position: relative; transition: background 0.2s, box-shadow 0.2s; }
        .mini-card:last-child { border-bottom: 1px solid #f1f5f9; }
        .mini-card:hover { background: #fff; border-color: var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .tag-offer { position: absolute; top: 0; left: 0; background: #16a34a; color: white; font-size: 0.6rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; z-index: 2; }
        .mc-img-box { width: 100%; height: auto; aspect-ratio: 1/1; position: relative; display: flex; align-items: center; justify-content: center; cursor: zoom-in; background-color: transparent; border-radius: 8px; margin-bottom: 8px; }
        .mc-img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
        .mc-info-col { display: flex; flex-direction: column; justify-content: center; width: 100%; align-items: center; text-align: center; flex: 1; }
        .mc-action-col { display: flex; align-items: center; justify-content: center; width: 100%; margin-top: auto; padding-top: 8px;}
        .btn-feat-row { display: flex; gap: 4px; flex-wrap: wrap; margin-bottom: 4px; width: 100%; min-height: 0; justify-content: center; }
        .btn-feat { font-size: 0.65rem; padding: 2px 8px; border-radius: 50px; font-weight: 600; border: 1px solid; cursor: pointer; white-space: nowrap; }
        .btn-feat.info { background: #f1f5f9; border-color: #cbd5e1; color: var(--secondary); }
        .pc-validity { font-size: 0.65rem; color: #15803d; font-weight: 600; background: #f0fdf4; padding: 1px 6px; border-radius: 4px; margin-bottom: 4px; width: fit-content; }
        .mc-title { font-size: 0.75rem; font-weight: 600; color: var(--secondary); margin-bottom: 4px; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; height: auto; text-align: center; width: 100%; }
        .mc-price { font-size: 0.95rem; font-weight: 800; color: var(--text-main); }
        .mc-price-old { font-size: 0.75rem; text-decoration: line-through; color: #94a3b8; margin-right: 4px; }
        .mc-price-new { color: var(--primary); }
        .btn-add-mini { width: 100%; padding: 0 16px; height: 32px; background: var(--primary); color: white; border-radius: 50px; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; box-shadow: 0 2px 5px rgba(220, 38, 38, 0.2); }
        .qty-mini { width: 100%; height: 32px; display: flex; align-items: center; justify-content: space-between; border: 1px solid var(--primary); border-radius: 50px; background: white; }
        .qm-btn { width: 30px; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--secondary); font-size: 1.1rem; }
        .qm-val { font-weight: 700; font-size: 0.9rem; }

        .suggestion-toast { position: fixed; bottom: 90px; left: 20px; right: 20px; background: white; border: 1px solid #bfdbfe; border-left: 4px solid #3b82f6; border-radius: 12px; padding: 16px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; transform: translateY(150%); transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 9995; }
        .suggestion-toast.visible { transform: translateY(0); }
        .st-img { width: 70px; height: 70px; border-radius: 6px; object-fit: contain; mix-blend-mode: multiply; }
        .st-content { flex: 1; display: flex; flex-direction: column; }
        .st-title { font-size: 0.8rem; font-weight: 700; color: var(--secondary); line-height: 1.2; margin-bottom: 2px; }
        .st-text { font-size: 0.7rem; color: var(--text-light); }
        .st-btn { background: #3b82f6; color: white; border-radius: 6px; padding: 8px 12px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
        @media(min-width: 1024px) { .suggestion-toast { bottom: 40px; max-width: 400px; left: auto; right: 20px; } }

        /* SEPARATOR BANNER */
        .basket-separator {
            width: 100%;
            background: #fffbeb;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0 20px 0;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .basket-separator span { color: #b45309; font-weight: 700; font-size: 0.9rem; }
        .basket-separator svg { color: #b45309; }
    </style>
</head>
<body>
    <header>
        <div class="container header-inner">
            <a href="#" class="logo" onclick="location.reload()" aria-label="Voltar para a p√°gina inicial">
                <div class="logo-circle" aria-hidden="true">DA</div> <span>Dona Ant√¥nia</span>
            </a>
            <div class="location-pill">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Cuiab√° & VG
            </div>
        </div>
    </header>

    <button id="btn-scroll-top" class="btn-scroll-top" onclick="window.scrollTo(0,0)" aria-label="Voltar ao topo">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>
    </button>

    <!-- HOME -->
    <main id="home-view">
        <section class="hero">
            <div class="container">
                <div class="trust-badges"><div class="badge-item">üîí Pagamento na Entrega</div><div class="badge-item">üöÄ Entrega em 24h</div></div>
                <h1 class="hero-title">A Melhor Cesta B√°sica <br> na Porta da <span>Sua Casa</span></h1>
                <p class="hero-text">Personalize com marcas l√≠deres e receba sem filas.</p>
                <button class="btn-cta-primary" onclick="document.getElementById('baskets-anchor').scrollIntoView({behavior:'smooth'})">Escolher Minha Cesta</button>
            </div>
        </section>
        <section class="home-grid-container" id="baskets-anchor">
            <h2 class="visually-hidden">Nossas Cestas</h2>
            <div id="home-list" class="baskets-grid"><div class="loader"></div></div>
        </section>
        <footer style="text-align:center; padding: 40px 20px; color: var(--text-light); font-size:0.9rem;"><p>&copy; 2024 Dona Ant√¥nia Alimentos</p></footer>
    </main>

    <!-- CUSTOMIZER -->
    <div id="customizer-view" class="hidden">
        <div class="cust-header-bar">
            <div class="container ch-container">
                <button class="ch-back-btn" onclick="App.goHome()" aria-label="Voltar">‚ùÆ</button>
                <div class="ch-info">
                    <h2 id="cust-title">Minha Cesta</h2>
                    <span id="changes-badge" class="limit-badge">Altera√ß√µes: 0/0</span>
                </div>
                <div class="ch-search-box">
                    <input type="text" id="main-search" class="ch-input" placeholder="Buscar produto...">
                    <button id="desk-clear-btn" class="ch-clear-btn hidden" onclick="App.clearSearch()">‚úï</button>
                    <span class="ch-icon">üîç</span>
                </div>
                <div class="ch-desktop-cart">
                    <div class="desk-price"><small>Total Estimado</small><strong id="desk-total-val">R$ 0,00</strong></div>
                    <button class="btn-desk-checkout" onclick="App.openCheckout()">WhatsApp <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.008-.57-.008-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg></button>
                </div>
            </div>
        </div>
        
        <!-- NEW: Mobile Quick Nav Bar -->
        <div class="mobile-quick-nav">
            <button class="mqn-btn active" onclick="App.clearSearch(); App.setActiveQuick(this)">Minha Cesta</button>
            <button class="mqn-btn" onclick="App.showOffers(); App.setActiveQuick(this)">Ofertas</button>
            <button class="mqn-btn" onclick="App.showBestSellers(); App.setActiveQuick(this)">Mais Vendidos</button>
        </div>

        <div class="container app-grid">
            <!-- BASKET SECTION (Spans Full Width on Mobile) -->
            <div class="basket-section">
                <div class="section-header" style="border-top: 4px solid var(--secondary);"><h3>üì¶ Itens da Sua Cesta (J√° Inclusos)</h3></div>
                <div class="product-box">
                    <div id="included-list" class="grid-products"></div>
                    <div id="inc-nav-controls" class="slider-controls hidden">
                        <button class="sc-btn" onclick="App.scrollIncluded(-1)">‚ùÆ</button>
                        <button class="sc-btn" onclick="App.scrollIncluded(1)">‚ùØ</button>
                    </div>
                </div>
                <!-- SEPARATOR -->
                <div class="basket-separator">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7"></path></svg>
                    <span>Agora, personalize sua cesta abaixo</span>
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 13l-7 7-7-7m14-8l-7 7-7-7"></path></svg>
                </div>
            </div>

            <!-- SIDEBAR (Left Column on Mobile) -->
            <aside id="mobile-nav-sidebar" class="mobile-nav-sidebar">
                <!-- Injected via JS -->
            </aside>
            
            <!-- DESKTOP SIDEBAR -->
            <aside class="sidebar-desktop">
                <!-- Content Injected via JS -->
            </aside>

            <!-- EXTRAS CONTENT (Right Column on Mobile) -->
            <div class="products-section">
                <div id="extras-container"></div>
            </div>
        </div>
        
        <!-- MOBILE CHECKOUT BAR -->
        <div class="mobile-checkout-bar" id="mobile-checkout-bar">
            <div class="mcb-total"><span class="mcb-label">Total Estimado</span><span class="mcb-value" id="mcb-total-val">R$ 0,00</span></div>
            <button class="mcb-btn" onclick="App.openCheckout()">Encomendar <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg></button>
        </div>
    </div>

    <div id="toast" class="toast"><svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span id="toast-msg">Cr√©dito atualizado</span></div>

    <!-- NEW SUGGESTION TOAST -->
    <div id="suggestion-toast" class="suggestion-toast">
        <img id="st-img" class="st-img" src="" alt="">
        <div class="st-content">
            <div class="st-title">Leve tamb√©m!</div>
            <div class="st-text" id="st-text">Sugest√£o de compra.</div>
        </div>
        <button id="st-btn" class="st-btn">Adicionar</button>
        <button style="font-size:1.2rem; color:#999; padding:0 5px;" onclick="document.getElementById('suggestion-toast').classList.remove('visible')">√ó</button>
    </div>

    <!-- GALLERY -->
    <div id="gallery" class="gallery-wrap">
        <button class="gallery-close-chip" onclick="Gallery.close()" aria-label="Fechar Galeria">FECHAR</button>
        <div class="gallery-stage">
            <button class="gallery-nav prev" onclick="Gallery.prev()">‚ùÆ</button>
            <img id="gallery-img" class="gallery-img" src="">
            <video id="gallery-video" class="gallery-video hidden" controls></video>
            <button class="gallery-nav next" onclick="Gallery.next()">‚ùØ</button>
        </div>
        <div id="gallery-thumbs" class="gallery-thumbs"></div>
    </div>

    <!-- MODALS -->
    <dialog id="checkout-modal" class="modal-checkout">
        <div class="co-header"><span>Resumo do Pedido</span><button onclick="document.getElementById('checkout-modal').close()" aria-label="Fechar">‚úï</button></div>
        <div class="co-body">
            <ul id="checkout-items" class="co-list"></ul>
            <div class="co-total-row"><span>Total</span><span id="co-total" class="co-total-val">R$ 0,00</span></div>
            <div>
                <label style="display:block; font-weight:600; margin-bottom:10px; font-size:0.9rem;">Forma de Pagamento:</label>
                <select id="payment-method" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:0.9rem;">
                    <option value="Pix">Pix (Instant√¢neo)</option><option value="Dinheiro">Dinheiro</option><option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                    <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option><option value="Vale Alimenta√ß√£o">Vale Alimenta√ß√£o</option>
                </select>
            </div>
        </div>
        <div class="co-footer"><button class="co-btn" onclick="App.sendWhatsApp()">Confirmar Pedido no WhatsApp</button></div>
    </dialog>

    <!-- INFO SHEET (Features + Media) -->
    <div id="info-sheet" class="sheet-overlay" onclick="if(event.target===this) App.closeSheet('info-sheet')">
        <div class="sheet-content">
            <div class="sheet-header"><h3 class="sheet-title" id="info-sheet-title">Informa√ß√µes</h3><span class="sheet-close" onclick="App.closeSheet('info-sheet')" aria-label="Fechar">‚úï</span></div>
            <div style="padding-bottom: 20px;">
                <div id="info-sheet-body" class="info-text-body"></div>
                <!-- Dynamic media container -->
                <div id="info-media-container" class="info-media-grid"></div>
            </div>
        </div>
    </div>

    <div id="cat-sheet" class="sheet-overlay" onclick="if(event.target===this) App.closeSheet('cat-sheet')"><div class="sheet-content"><div class="sheet-header"><h3 class="sheet-title">Categorias</h3><span class="sheet-close" onclick="App.closeSheet('cat-sheet')" aria-label="Fechar">‚úï</span></div><div id="mob-cat-grid" class="mobile-cat-grid"></div></div></div>
    
    <div id="faq-sheet" class="sheet-overlay" onclick="if(event.target===this) App.closeSheet('faq-sheet')">
        <div class="sheet-content">
            <div class="sheet-header"><h3 class="sheet-title">D√∫vidas Frequentes</h3><span class="sheet-close" onclick="App.closeSheet('faq-sheet')" aria-label="Fechar">‚úï</span></div>
            <div style="padding-bottom:20px;">
                <details class="faq-box"><summary>Formas de Pagamento</summary><div class="faq-text">Aceitamos Dinheiro, Pix, Cart√£o de D√©bito, Cr√©dito (at√© 3x sem juros) e Vales Alimenta√ß√£o/Refei√ß√£o (Pluxee, Alelo, Flash, etc).</div></details>
                <details class="faq-box"><summary>Eu pago s√≥ na entrega?</summary><div class="faq-text">Sim! Para sua total seguran√ßa, o pagamento √© realizado somente no momento em que voc√™ recebe o pedido na sua casa.</div></details>
                <details class="faq-box"><summary>A entrega √© gr√°tis?</summary><div class="faq-text">Sim, o frete √© totalmente Gr√°tis para compras acima de R$ 85,00 em toda a nossa √°rea de cobertura (Cuiab√° e VG).</div></details>
                <details class="faq-box"><summary>Posso trocar itens da cesta?</summary><div class="faq-text">Com certeza! Utilize o bot√£o "Personalizar" para adicionar ou remover itens, ou fale diretamente com a gente no WhatsApp.</div></details>
                <details class="faq-box"><summary>De onde voc√™s s√£o?</summary><div class="faq-text">Somos de Cuiab√° - MT, localizados no bairro Jardim Nossa Senhora Aparecida. Atendemos com frota pr√≥pria.</div></details>
                <details class="faq-box"><summary>Qual o prazo de entrega?</summary><div class="faq-text">Nossas entregas s√£o r√°pidas e realizadas no dia seguinte ao pedido, de segunda a s√°bado.</div></details>
            </div>
        </div>
    </div>

    <script>
        const CONSTANTS = {
            THEMES: { 'DEFAULT': '#f1f5f9', 'ALIMENTOS': '#ffedd5', 'LIMPEZA': '#dbeafe', 'HIGIENE': '#dcfce7', 'BEBIDAS': '#fae8ff', 'CARNES': '#fee2e2' },
            PHONE: "5565996813588",
            LIMITS: { 'econ√¥mica': 5, 'economica': 5, 'mini': 7, 'pequena': 9, 'm√©dia': 11, 'media': 11, 'grande': 13 },
            SHOW_INFO_BUTTON: true // CONFIG: Master Toggle for Info Button
        };

        const Gallery = {
            touchStartX: 0,
            touchEndX: 0,

            open(mainSrc, productName, startWith=null) {
                const el = document.getElementById('gallery');
                const img = document.getElementById('gallery-img');
                const vid = document.getElementById('gallery-video');
                const thumbs = document.getElementById('gallery-thumbs');
                thumbs.innerHTML = '';
                
                let isVideo = false;
                if(startWith && (startWith.toLowerCase().indexOf('.mp4') !== -1)) isVideo = true;

                if(isVideo) {
                    img.classList.add('hidden');
                    vid.src = startWith;
                    vid.classList.remove('hidden');
                    vid.play();
                } else {
                    vid.pause();
                    vid.classList.add('hidden');
                    img.src = startWith || mainSrc;
                    img.alt = productName;
                    img.classList.remove('hidden');
                }

                this.addThumb(mainSrc, 'img', !startWith); 
                this.checkSuffixes(mainSrc, startWith);
                this.checkVideo(mainSrc, startWith); 
                
                el.classList.add('active');

                // Initialize swipe listeners
                const stage = document.querySelector('.gallery-stage');
                stage.ontouchstart = (e) => { this.touchStartX = e.changedTouches[0].screenX; };
                stage.ontouchend = (e) => {
                    this.touchEndX = e.changedTouches[0].screenX;
                    if(this.touchStartX - this.touchEndX > 50) this.next();
                    if(this.touchEndX - this.touchStartX > 50) this.prev();
                };
            },
            
            swap(src, type, el) {
                document.querySelectorAll('.g-thumb').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                const img = document.getElementById('gallery-img');
                const vid = document.getElementById('gallery-video');
                
                if(type === 'video') {
                    img.classList.add('hidden');
                    vid.src = src;
                    vid.classList.remove('hidden');
                    vid.play();
                } else {
                    vid.pause();
                    vid.classList.add('hidden');
                    img.src = src;
                    img.classList.remove('hidden');
                }
            },

            addThumb(src, type, isActive) {
                const t = document.createElement('img');
                t.className = `g-thumb ${isActive?'active':''}`;
                t.src = type === 'video' ? 'img/video-placeholder.png' : src;
                t.onerror = () => t.src = 'https://placehold.co/50x50?text=VID';
                t.onclick = () => this.swap(src, type, t);
                t.dataset.src = src; // Store src for next/prev logic
                t.dataset.type = type;
                document.getElementById('gallery-thumbs').appendChild(t);
            },

            checkSuffixes(baseSrc, startWith) {
                const suffixes = ['A', 'B', 'C'];
                const dot = baseSrc.lastIndexOf('.');
                if(dot === -1) return;
                const root = baseSrc.substring(0, dot);
                const ext = baseSrc.substring(dot);
                suffixes.forEach(s => {
                    const url = root + s + ext;
                    const i = new Image();
                    i.onload = () => this.addThumb(url, 'img', url === startWith);
                    i.src = url;
                });
            },

            checkVideo(baseSrc, startWith) {
                const dot = baseSrc.lastIndexOf('.');
                if(dot === -1) return;
                const root = baseSrc.substring(0, dot);
                
                const tryVid = (url) => {
                     const v = document.createElement('video');
                     const isActive = (url === startWith);
                     v.onloadedmetadata = () => {
                         this.addThumb(url, 'video', isActive);
                     };
                     v.src = url;
                }
                tryVid(root + '.mp4');
                tryVid(root + 'E.mp4');
            },

            next() {
                const active = document.querySelector('.g-thumb.active');
                if(active && active.nextElementSibling) {
                    active.nextElementSibling.click();
                }
            },

            prev() {
                const active = document.querySelector('.g-thumb.active');
                if(active && active.previousElementSibling) {
                    active.previousElementSibling.click();
                }
            },

            close() { 
                document.getElementById('gallery').classList.remove('active'); 
                document.getElementById('gallery-video').pause();
            }
        };

        const App = {
            data: [], cart: {}, currentBasket: null, originalCart: {}, currentLimit: 99,

            async init() {
                try {
                    const res = await fetch('produtos/produtos.json?v=' + Date.now());
                    const raw = await res.json();
                    
                    this.data = raw.map(p => {
                        const rawCat = (p.categoria || 'OUTROS').trim().toUpperCase();
                        const parts = rawCat.split('>');
                        const mainCat = parts[0].trim();
                        const subCat = parts.length > 1 ? parts[1].trim() : parts[0].trim();

                        return {
                            ...p,
                            id: String(p.id),
                            code: p.codigo,
                            nome: p.nome.trim(),
                            valor: parseFloat(p.valor || 0),
                            offerPrice: parseFloat(p.Valor_Oferta || 0),
                            isOffer: (p.Oferta && p.Oferta.toLowerCase() === 'sim'),
                            // NEW FIELDS MAPPING
                            isBestSeller: (p.Mais_Vendido && p.Mais_Vendido.toLowerCase() === 'sim'),
                            hasLink: (p.Tem_Ligacao && p.Tem_Ligacao.toLowerCase() === 'sim'),
                            linkedCode: p.Codigo_Produto_Ligado || "",
                            
                            categoria: rawCat, 
                            mainCategory: mainCat,
                            subCategory: subCat,
                            imagem: this.fixImgPath(p.imagem),
                            limit: parseInt(p.Limit || p.limit || 0),
                            estoque: parseInt(p.estoque || 0),
                            validade: p.Validade || p.validade || "",
                            caracteristicas: p.Caracteristicas || p.caracteristicas || ""
                        };
                    });

                    this.renderHome();
                    this.renderSidebar();
                    this.setupSearch();

                } catch (e) {
                    console.error("Erro Fatal:", e);
                    document.getElementById('home-list').innerHTML = `<p style="text-align:center;">Erro ao carregar.</p>`;
                }
            },

            fixImgPath(path) {
                if (!path) return 'img/placeholder.jpg';
                return path.includes('/') ? `img/produtos/${path.split('/').pop()}` : `img/produtos/${path}`;
            },

            renderHome() {
                const list = document.getElementById('home-list');
                const baskets = this.data.filter(p => p.categoria.includes('CESTA') && (p.categoria.includes('B√ÅSICA') || p.categoria.includes('BASICA')));
                
                if(baskets.length === 0) { list.innerHTML = '<p>Nenhuma cesta.</p>'; return; }

                list.innerHTML = baskets.map(p => {
                    const price = (p.isOffer && p.offerPrice > 0) ? p.offerPrice : p.valor;
                    return `
                    <article class="home-card">
                        <div class="hc-image-wrap" onclick="Gallery.open('${p.imagem}', '${p.nome}')">
                            <img src="${p.imagem}" class="hc-image" loading="lazy" alt="${p.nome}" onerror="this.onerror=null;this.src='https://placehold.co/500?text=Imagem+Indispon√≠vel';">
                        </div>
                        <div class="hc-content">
                            <h3 class="hc-title">${p.nome}</h3>
                            <div class="hc-price">R$ ${price.toFixed(2).replace('.', ',')}</div>
                            <div class="hc-actions">
                                <button class="btn-fill" onclick="App.openCustomizer('${p.id}')">Personalizar Cesta</button>
                                <button class="btn-outline" onclick="App.directLink('${p.nome}')">Pedir Direto</button>
                            </div>
                        </div>
                    </article>`;
                }).join('');
            },

            renderSidebar() {
                // Filter out Cestas and get structure
                const relevantProducts = this.data.filter(p => !p.categoria.includes('CESTA'));
                
                // Group Subcats by Maincats
                const structure = {};
                const mainOrder = []; 

                relevantProducts.forEach(p => {
                    if (!structure[p.mainCategory]) {
                        structure[p.mainCategory] = new Set();
                        mainOrder.push(p.mainCategory); // Preserve approximate JSON order
                    }
                    structure[p.mainCategory].add(p.categoria); // Store full key for filtering
                });

                // --- BUILD HTML ---
                let deskHTML = `<div class="sidebar-title">Menu R√°pido</div>
                    <div class="sidebar-nav-grid" style="grid-template-columns: repeat(2, 1fr);">
                        <button class="sidebar-chip minha-cesta" onclick="App.clearSearch()">Minha Cesta</button>
                        <button class="sidebar-chip ofertas-btn" onclick="App.showOffers()">üî• Ofertas</button>
                    </div>`;
                
                // Note: Top buttons moved to .mobile-quick-nav, removed here
                let mobHTML = ``;

                // Deduplicate mainOrder
                const uniqueMain = [...new Set(mainOrder)];

                uniqueMain.forEach(main => {
                    // Determine Color
                    const colorKey = Object.keys(CONSTANTS.THEMES).find(k => main.includes(k)) || 'DEFAULT';
                    const bgColor = CONSTANTS.THEMES[colorKey];
                    const textColor = 'var(--secondary)'; // Ensure good contrast

                    // DESKTOP
                    deskHTML += `<div class="nav-section-title" style="background-color: ${bgColor}; color: ${textColor};">${main}</div>`;
                    deskHTML += `<div class="sidebar-nav-grid" style="margin-bottom:10px;">`;
                    
                    // MOBILE
                    mobHTML += `<div class="nav-section-title" style="background-color: ${bgColor}; color: ${textColor};">${main}</div>`;

                    // Sort subcategories logic? Or keep JSON order?
                    // Set iteration follows insertion order usually.
                    const subKeys = Array.from(structure[main]);
                    
                    subKeys.forEach(fullKey => {
                        // Find a representative product to get the nice sub name
                        const sample = this.data.find(p => p.categoria === fullKey);
                        const label = sample ? sample.subCategory : fullKey;

                        deskHTML += `<button class="sidebar-chip" onclick="App.filterCat('${fullKey}')">${label}</button>`;
                        
                        mobHTML += `<div class="nav-side-btn" onclick="App.filterCat('${fullKey}'); App.highlightNav(this);">${label}</div>`;
                    });

                    deskHTML += `</div>`; // Close grid
                });

                // Add footer elements
                deskHTML += `
                <div style="margin-top:30px; background:#f8fafc; padding:15px; border-radius:8px; border:1px solid #e2e8f0;">
                    <strong style="color:var(--secondary);">D√∫vida?</strong>
                    <p style="font-size:0.85rem; color:var(--text-light); margin-bottom:10px;">Fale conosco no WhatsApp ou veja as perguntas frequentes.</p>
                    <button class="btn-outline" onclick="App.openSheet('faq-sheet')">Perguntas Frequentes</button>
                </div>`;

                mobHTML += `<div class="nav-arrow-indicator">‚ñº</div>`;

                document.querySelector('.sidebar-desktop').innerHTML = deskHTML;
                document.getElementById('mobile-nav-sidebar').innerHTML = mobHTML;
            },

            setActiveQuick(el) {
                document.querySelectorAll('.mqn-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            },

            highlightNav(el) {
                document.querySelectorAll('.nav-side-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            },

            openCustomizer(id) {
                const basket = this.data.find(p => p.id === id);
                if(!basket) return;
                this.currentBasket = basket;
                this.cart = {};
                
                if(basket.items && Array.isArray(basket.items)) {
                    basket.items.forEach(item => {
                        let match = this.data.find(p => p.id === String(item.id));
                        if(!match && item.nome) match = this.data.find(p => !p.categoria.includes('CESTA') && p.nome.toLowerCase().includes(item.nome.toLowerCase()));
                        if(match) this.cart[match.id] = (this.cart[match.id] || 0) + (parseInt(item.qtd || 1));
                    });
                }

                this.originalCart = { ...this.cart };
                const nameKey = basket.nome.toLowerCase().replace('cesta', '').trim();
                let limitKey = Object.keys(CONSTANTS.LIMITS).find(k => nameKey.includes(k));
                this.currentLimit = limitKey ? CONSTANTS.LIMITS[limitKey] : 99;

                let itemsSum = 0;
                for(let pid in this.cart) {
                    let p = this.data.find(x => x.id === pid);
                    if(p) itemsSum += (p.isOffer ? p.offerPrice : p.valor) * this.cart[pid];
                }
                this.baseFee = Math.max(0, basket.valor - itemsSum);

                document.getElementById('cust-title').innerText = basket.nome;
                document.getElementById('home-view').classList.add('hidden');
                document.getElementById('customizer-view').classList.remove('hidden');
                document.body.classList.add('customizer-mode'); // CSS trigger to hide header
                
                window.scrollTo(0,0);
                this.renderAllLists();
            },

            goHome() {
                document.getElementById('customizer-view').classList.add('hidden');
                document.getElementById('home-view').classList.remove('hidden');
                document.body.classList.remove('customizer-mode');
                this.currentBasket = null;
            },

            showOffers() {
                this.closeSheet('cat-sheet');
                if(!this.currentBasket) return alert("Selecione uma cesta primeiro.");
                document.getElementById('main-search').value = "";
                this.renderAllLists("", true); 
            },

            showBestSellers() {
                this.closeSheet('cat-sheet');
                if(!this.currentBasket) return alert("Selecione uma cesta primeiro.");
                document.getElementById('main-search').value = "";
                // Logic: Filter using the new 'isBestSeller' flag from JSON
                this.renderAllLists("", false, true); 
            },

            renderAllLists(searchTerm = "", showOffersOnly = false, showBestSellers = false) {
                if(!this.currentBasket) return;
                
                // 1. Render Included Items (Top List)
                this.renderIncluded();

                // 2. Render Extras (Bottom List) - Main Content
                const extContainer = document.getElementById('extras-container');
                // General filter: not a basket
                let extras = this.data.filter(p => !p.categoria.includes('CESTA'));
                
                let titleHtml = '';

                // NEW: Logic to render "Best Sellers" as a special section if we are in Default Mode (not searching/filtering)
                let bestSellersHtml = '';
                const isDefaultMode = !searchTerm && !showOffersOnly && !showBestSellers;
                
                if (isDefaultMode) {
                    const bestSellersList = extras.filter(p => p.isBestSeller);
                    if (bestSellersList.length > 0) {
                        bestSellersHtml = `
                        <div class="extras-separator-banner">
                            <h3 style="color:#2563eb;">üèÜ Mais Vendidos</h3>
                            <p>Os produtos preferidos dos nossos clientes.</p>
                        </div>
                        <div class="product-box" style="margin-bottom:30px;">
                            <div class="grid-products">
                                ${bestSellersList.map(p => this.buildCard(p)).join('')}
                            </div>
                        </div>
                        <div class="extras-separator-banner">
                            <h3>Adicionar Extras</h3>
                            <p>Toque nos produtos abaixo para adicionar mais itens.</p>
                        </div>`;
                    } else {
                        // Fallback title if no best sellers found
                        titleHtml = `
                        <div class="extras-separator-banner">
                            <h3>Adicionar Extras</h3>
                            <p>Toque nos produtos abaixo para adicionar mais itens.</p>
                        </div>`;
                    }
                }

                // --- EXISTING FILTER LOGIC ---
                if(showOffersOnly) {
                    extras = extras.filter(p => p.isOffer);
                    const mobSearch = document.getElementById('main-search');
                    if(mobSearch) mobSearch.value = "";
                    titleHtml = `
                    <div class="extras-separator-banner">
                        <h3 style="color:#b45309;">üî• Ofertas Especiais</h3>
                        <p>Aproveite os descontos exclusivos.</p>
                    </div>`;
                } else if(showBestSellers) {
                    // Logic: Now uses the real JSON flag
                    extras = extras.filter(p => p.isBestSeller);
                    
                    const mobSearch = document.getElementById('main-search');
                    if(mobSearch) mobSearch.value = "";
                    
                    titleHtml = `
                    <div class="extras-separator-banner">
                        <h3 style="color:#2563eb;">üèÜ Mais Vendidos</h3>
                        <p>Os produtos preferidos dos nossos clientes.</p>
                    </div>`;
                } else if(searchTerm) {
                    const lower = searchTerm.toLowerCase();
                    extras = extras.filter(p => p.nome.toLowerCase().includes(lower) || p.categoria.toLowerCase().includes(lower));
                    document.getElementById('main-search').value = searchTerm;
                }

                const showClear = searchTerm.length > 0 || showOffersOnly || showBestSellers;
                const deskBtn = document.getElementById('desk-clear-btn');
                if(deskBtn) showClear ? deskBtn.classList.remove('hidden') : deskBtn.classList.add('hidden');

                const groups = {};
                // Group by full category key to match sidebar filtering
                extras.forEach(p => { if(!groups[p.categoria]) groups[p.categoria] = []; groups[p.categoria].push(p); });
                
                const sortedKeys = Object.keys(groups); 
                
                // If default mode, inject best sellers HTML first
                let html = isDefaultMode ? bestSellersHtml + titleHtml : titleHtml;

                if(sortedKeys.length === 0) {
                     html += '<p style="text-align:center; padding:40px;">Nenhum produto encontrado.</p>';
                } else {
                    sortedKeys.forEach(key => {
                        const sample = groups[key][0];
                        const title = sample.subCategory; 
                        const colorKey = Object.keys(CONSTANTS.THEMES).find(k => key.includes(k)) || 'DEFAULT';
                        
                        html += `<div id="cat-${key}" class="section-header" style="background:${CONSTANTS.THEMES[colorKey]}; margin-top:30px;"><h3>${title}</h3></div>
                        <div class="product-box"><div class="grid-products">${groups[key].map(p => this.buildCard(p)).join('')}</div></div>`;
                    });
                }
                
                extContainer.innerHTML = html;
                
                if((showOffersOnly || showBestSellers) && extContainer) extContainer.scrollIntoView({behavior:'smooth'});
                
                this.updateTotal();
            },

            // New optimized function for just the top list
            renderIncluded() {
                const incContainer = document.getElementById('included-list');
                const incNav = document.getElementById('inc-nav-controls'); // Controls wrapper
                const incIds = Object.keys(this.cart);
                
                // Add class for Mobile Slider Mode
                if(window.innerWidth < 1024) {
                    incContainer.classList.add('slider-mode');
                    incNav.classList.remove('hidden'); // Show nav
                } else {
                    incContainer.classList.remove('slider-mode');
                    incNav.classList.add('hidden'); // Hide nav
                }

                incContainer.innerHTML = incIds.length === 0 ? '<p style="padding:10px; color:#999; width:100%; text-align:center;">Cesta vazia.</p>' : 
                    incIds.map(id => { const p = this.data.find(x => x.id === id); return p ? this.buildCard(p) : ''; }).join('');
                
                // Hide nav if empty
                if(incIds.length === 0 && incNav) incNav.classList.add('hidden');
            },

            scrollIncluded(direction) {
                const container = document.getElementById('included-list');
                if(container) {
                    const scrollAmount = container.offsetWidth; // Scroll one container width roughly
                    container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
                }
            },

            buildCard(p) {
                const qty = this.cart[p.id] || 0;
                const price = p.isOffer && p.offerPrice > 0 ? p.offerPrice : p.valor;
                
                let btnHtml = this.getBtnHtml(p.id, qty); // Extracted for reuse

                let priceHtml = (p.isOffer && p.offerPrice > 0) ? 
                    `<span class="mc-price-old">R$${p.valor.toFixed(2)}</span><span class="mc-price-new">R$${price.toFixed(2)}</span>` : 
                    `R$ ${price.toFixed(2).replace('.', ',')}`;
                
                let infoBtn = '';
                if (CONSTANTS.SHOW_INFO_BUTTON && p.caracteristicas) {
                    infoBtn = `<div class="btn-feat info" onclick="App.openInfo('${p.id}')">Informa√ß√µes</div>`;
                }

                let valHtml = '';
                if(p.validade && p.validade !== '00') {
                    const formattedDate = App.formatDateBr(p.validade);
                    valHtml = `<div class="pc-validity">Val: ${formattedDate}</div>`;
                }

                return `
                <div class="mini-card" id="card-${p.id}">
                    ${(p.isOffer && p.offerPrice > 0) ? '<span class="tag-offer">OFERTA</span>' : ''}
                    <div class="mc-img-box" onclick="Gallery.open('${p.imagem}', '${p.nome}')">
                        <img src="${p.imagem}" class="mc-img" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/300?text=No+Image';">
                    </div>
                    
                    <div class="mc-info-col">
                        <div class="mc-title">${p.nome}</div>
                        ${valHtml}
                        <div class="btn-feat-row">${infoBtn}</div>
                        <div class="mc-price">${priceHtml}</div>
                    </div>
                    
                    <div class="mc-action-col">
                        ${btnHtml}
                    </div>
                </div>`;
            },

            getBtnHtml(id, qty) {
                if (qty === 0) {
                    return `<button class="btn-add-mini" onclick="App.modQty('${id}', 1)">Adicionar</button>`;
                } else {
                    return `<div class="qty-mini"><button class="qm-btn" onclick="App.modQty('${id}', -1)">-</button><span class="qm-val">${qty}</span><button class="qm-btn" onclick="App.modQty('${id}', 1)">+</button></div>`;
                }
            },

            formatDateBr(dateStr) {
                 if (!dateStr) return '';
                 if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                     const [y, m, d] = dateStr.split('-');
                     return `${d} | ${m} | ${y}`;
                 }
                 if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                     return dateStr.replace(/\//g, ' | ');
                 }
                 return dateStr;
            },

            countRemovals() {
                let removals = 0;
                for(let id in this.originalCart) {
                    if (this.originalCart[id] > 0 && (!this.cart[id] || this.cart[id] === 0)) {
                        removals++;
                    }
                }
                return removals;
            },

            // OPTIMIZED modQty - No full re-render
            modQty(id, delta) {
                const p = this.data.find(x => x.id === id);
                if(!this.cart[id]) this.cart[id] = 0;
                const oldQty = this.cart[id];
                const newQty = oldQty + delta;

                if(delta > 0 && p.limit > 0 && newQty > p.limit) return alert(`Limite de ${p.limit} unidades.`);
                
                if (this.originalCart[id] && delta < 0 && newQty === 0) {
                    if (this.countRemovals() >= this.currentLimit) {
                        return alert(`Limite de ${this.currentLimit} trocas/exclus√µes atingido para esta cesta.`);
                    }
                }

                this.cart[id] = newQty;
                if(this.cart[id] <= 0) delete this.cart[id];

                // --- SMART UPDATE DOM ---
                // 1. If an item was added (0->1) or removed (1->0), we MUST re-render the "Included" list at top.
                if ((oldQty === 0 && newQty > 0) || (oldQty > 0 && newQty === 0)) {
                    this.renderIncluded();
                }

                // 2. For the "Extras" list (and existing cards in included), just update the button HTML in-place
                // This prevents the whole list from blinking/reloading images.
                const cards = document.querySelectorAll(`#card-${id}`);
                const newBtnHtml = this.getBtnHtml(id, newQty);
                
                cards.forEach(card => {
                    const actionCol = card.querySelector('.mc-action-col');
                    if (actionCol) actionCol.innerHTML = newBtnHtml;
                });

                // --- CROSS-SELL LOGIC (NEW) ---
                if (delta > 0 && p.hasLink && p.linkedCode) {
                    this.checkSuggestion(p.linkedCode);
                }

                this.updateTotal();
            },

            checkSuggestion(linkedCode) {
                // Find the linked product object
                const linkedP = this.data.find(x => x.code === linkedCode);
                
                // If it exists AND is NOT in the cart yet
                if (linkedP && !this.cart[linkedP.id]) {
                    this.showSuggestion(linkedP);
                }
            },

            showSuggestion(p) {
                const toast = document.getElementById('suggestion-toast');
                const img = document.getElementById('st-img');
                const txt = document.getElementById('st-text');
                const btn = document.getElementById('st-btn');

                img.src = p.imagem;
                txt.innerText = `Leve ${p.nome} por R$ ${p.valor.toFixed(2)}`;
                
                // Remove old listeners to avoid multiple adds
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.onclick = () => {
                    this.modQty(p.id, 1);
                    toast.classList.remove('visible');
                };

                // Delay appearance by 1s
                setTimeout(() => {
                    toast.classList.add('visible');
                    // Auto hide after 8 seconds
                    setTimeout(() => toast.classList.remove('visible'), 8000);
                }, 1000);
            },

            updateTotal() {
                let itemsSum = 0;
                for(let id in this.cart) {
                    const p = this.data.find(x => x.id === id);
                    if(p) itemsSum += (p.isOffer ? p.offerPrice : p.valor) * this.cart[id];
                }
                
                const calculatedTotal = itemsSum + this.baseFee;
                let finalTotal = Math.max(calculatedTotal, this.currentBasket.valor);
                let credit = 0;
                
                if (calculatedTotal < this.currentBasket.valor) {
                    credit = this.currentBasket.valor - calculatedTotal;
                }

                const removals = this.countRemovals();
                const badge = document.getElementById('changes-badge');
                badge.innerText = `Altera√ß√µes: ${removals}/${this.currentLimit}`;
                badge.className = removals >= this.currentLimit ? 'limit-badge error' : 'limit-badge';

                const fmt = 'R$ ' + finalTotal.toFixed(2).replace('.', ',');
                document.getElementById('desk-total-val').innerText = fmt;
                const mobTotal = document.getElementById('mcb-total-val');
                if(mobTotal) mobTotal.innerText = fmt;
                document.getElementById('co-total').innerText = fmt;

                const toast = document.getElementById('toast');
                if (credit > 0) {
                    document.getElementById('toast-msg').innerText = `Voc√™ tem R$ ${credit.toFixed(2).replace('.', ',')} de cr√©dito`;
                    toast.classList.add('visible');
                } else {
                    toast.classList.remove('visible');
                }
            },

            setupSearch() { 
                const deskInput = document.getElementById('main-search');
                
                const handler = (e) => this.renderAllLists(e.target.value);
                
                if(deskInput) {
                    deskInput.addEventListener('input', handler);
                    deskInput.addEventListener('click', () => {
                         const el = document.querySelector('.extras-separator-banner') || document.querySelector('.products-section');
                         if(el) {
                             const y = el.getBoundingClientRect().top + window.scrollY - 100;
                             window.scrollTo({top: y, behavior: 'smooth'});
                         }
                    });
                }

                // SCROLL LISTENER (Only affects Home now, since Customizer has permanent hidden header)
                let lastScroll = 0;
                window.addEventListener('scroll', () => {
                    if (document.body.classList.contains('customizer-mode')) return; // Ignore in customizer
                    
                    const currentScroll = window.pageYOffset;
                    if (currentScroll > lastScroll && currentScroll > 60) {
                        document.body.classList.add('header-hidden');
                    } else {
                        document.body.classList.remove('header-hidden');
                    }
                    lastScroll = currentScroll;
                });
            },

            search(term) {
                if(!this.currentBasket) return alert("Selecione uma cesta primeiro.");
                this.renderAllLists(term);
            },

            clearSearch() {
                document.getElementById('main-search').value = "";
                
                this.closeSheet('cat-sheet');
                
                this.renderAllLists("");
                
                // Reset quick nav active state if needed, or keep 'Minha Cesta' active?
                // Usually clear search resets to full list view (which implies user wants to see everything or basket)
                // Let's set 'Minha Cesta' as active visually
                const mcBtn = document.querySelector('.mqn-btn:first-child');
                if(mcBtn) this.setActiveQuick(mcBtn);

                // Scroll to VERY TOP of the content area (Included List)
                // Use a small timeout to ensure DOM update
                setTimeout(() => {
                    const topEl = document.querySelector('.products-section');
                    if(topEl) {
                        const y = topEl.getBoundingClientRect().top + window.scrollY - 120; // Adjust for sticky header
                        window.scrollTo({top: y > 0 ? y : 0, behavior: 'smooth'});
                    } else {
                        window.scrollTo({top: 0, behavior: 'smooth'});
                    }
                }, 50);
            },

            filterCat(cat) {
                this.closeSheet('cat-sheet');
                if(!this.currentBasket) return alert("Selecione uma cesta primeiro.");
                document.getElementById('main-search').value = "";

                // Reset quick nav active buttons when clicking a specific category
                document.querySelectorAll('.mqn-btn').forEach(b => b.classList.remove('active'));

                this.renderAllLists("");
                setTimeout(() => {
                    const el = document.getElementById(`cat-${cat}`);
                    if(el) { window.scrollTo({top: el.offsetTop - 140, behavior:'smooth'}); }
                }, 100);
            },

            openSheet(id) { 
                document.querySelectorAll('.sheet-overlay.open').forEach(el => el.classList.remove('open'));
                if(id === 'offers-sheet') this.renderOffersInSheet();
                document.getElementById(id).classList.add('open'); 
            },
            closeSheet(id) { document.getElementById(id).classList.remove('open'); },
            
            openInfo(pid) {
                const p = this.data.find(x => x.id === pid);
                if(!p) return;
                
                let text = p.caracteristicas || "Sem informa√ß√µes adicionais.";
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                
                if(text.includes('- ')) {
                    let lines = text.split('\n');
                    let newText = '';
                    let inList = false;
                    
                    lines.forEach(line => {
                        const trimmed = line.trim();
                        if(trimmed.startsWith('- ')) {
                            if(!inList) { newText += '<ul>'; inList = true; }
                            newText += `<li>${trimmed.substring(2)}</li>`;
                        } else {
                            if(inList) { newText += '</ul>'; inList = false; }
                            newText += line + '<br>';
                        }
                    });
                    if(inList) newText += '</ul>';
                    text = newText;
                } else {
                    text = text.replace(/\n/g, '<br>');
                }

                const mediaContainer = document.getElementById('info-media-container');
                mediaContainer.innerHTML = '';
                this.loadInfoMedia(p, mediaContainer);

                document.getElementById('info-sheet-title').innerText = p.nome;
                document.getElementById('info-sheet-body').innerHTML = text;
                this.openSheet('info-sheet');
            },

            loadInfoMedia(p, container) {
                const dot = p.imagem.lastIndexOf('.');
                if(dot === -1) return;
                const root = p.imagem.substring(0, dot);
                const ext = p.imagem.substring(dot);

                ['A', 'B', 'C', 'D', 'E'].forEach(suffix => {
                    const url = root + suffix + ext;
                    const img = new Image();
                    img.onload = () => {
                         const el = document.createElement('img');
                         el.src = url;
                         el.className = 'sheet-media-img';
                         el.loading = 'lazy';
                         container.appendChild(el);
                    };
                    img.src = url;
                });

                const loadVid = (url) => {
                    const v = document.createElement('video');
                    v.onloadedmetadata = () => {
                        const vidEl = document.createElement('video');
                        vidEl.src = url;
                        vidEl.className = 'sheet-media-vid';
                        vidEl.controls = true;
                        container.appendChild(vidEl);
                    };
                    v.src = url;
                };
                
                loadVid(root + '.mp4');
                loadVid(root + 'E.mp4');
            },

            renderOffersInSheet() {
                const grid = document.getElementById('mob-offers-grid');
                if(!grid) return;
                const offers = this.data.filter(p => p.isOffer);
                grid.innerHTML = offers.length ? offers.map(p => this.buildCard(p)).join('') : '<p style="grid-column:1/-1; text-align:center;">Sem ofertas.</p>';
            },
            
            openCheckout() {
                if(Object.keys(this.cart).length === 0) return alert("Cesta vazia.");
                document.getElementById('checkout-items').innerHTML = Object.keys(this.cart).map(id => {
                    const p = this.data.find(x => x.id === id);
                    return `<li class="co-item"><span>${this.cart[id]}x ${p.nome}</span></li>`;
                }).join('');
                document.getElementById('checkout-modal').showModal();
            },

            sendWhatsApp() {
                const method = document.getElementById('payment-method').value;
                const total = document.getElementById('co-total').innerText;
                let msg = `*NOVO PEDIDO: ${this.currentBasket.nome}*\n------------------\n`;
                for(let id in this.cart) {
                    const p = this.data.find(x => x.id === id);
                    if(p) msg += `${this.cart[id]}x ${p.nome}\n`;
                }
                msg += `------------------\n*TOTAL: ${total}*\n*Pagamento:* ${method}`;
                window.open(`https://api.whatsapp.com/send?phone=${CONSTANTS.PHONE}&text=${encodeURIComponent(msg)}`, '_blank');
            },

            directLink(name) { window.open(`https://api.whatsapp.com/send?phone=${CONSTANTS.PHONE}&text=${encodeURIComponent('Quero pedir ' + name)}`, '_blank'); }
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
