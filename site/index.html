<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    <meta name="description" content="Peça sua Cesta Básica em Cuiabá e VG. Monte e personalize sua cesta. Mercadinho online com pagamento na entrega.">
    <meta name="theme-color" content="#ffffff">
    <title>Cestas Básicas em Cuiabá e Várzea Grande | Dona Antônia</title>

    <style>
        /* --- 1. CORE & RESET --- */
        :root { 
            --primary: #d31a28; 
            --secondary: #3e3e3e; 
            --text-main: #222222; 
            --bg-body: #ffffff;
            --header-height: 70px; 
            --app-header-height: 60px; 
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; background: var(--bg-body); }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            color: var(--text-main); width: 100%; margin: 0;
            background-color: var(--bg-body);
            /* Removido opacity inicial para evitar tela branca se travar */
        }
        body.no-scroll { overflow: hidden !important; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 0 16px; width: 100%; }
        img { display: block; max-width: 100%; height: auto; }
        button { cursor: pointer; border: none; font-family: inherit; background: none; }
        .hidden { display: none !important; }

        /* Scrollbar Clean */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }

        /* --- 2. HEADER DA HOME --- */
        #main-header { 
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-height); 
            background: #ffffff; border-bottom: 1px solid #f0f0f0; z-index: 1000; 
            display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        /* Esconde o header principal quando estiver personalizando */
        body.customizer-mode #main-header { display: none !important; }
        
        .header-inner { display: flex; justify-content: space-between; align-items: center; height: 100%; }
        .logo-container { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--secondary); }
        .logo-text-col { display: flex; flex-direction: column; justify-content: center; }
        .logo-name { font-weight: 700; font-size: 1.1rem; line-height: 1.1; }
        .logo-slogan { font-size: 0.65rem; color: #555; font-weight: 500; letter-spacing: 0.5px; } 
        .logo-brand-img { width: 53px; height: 53px; border-radius: 50%; object-fit: cover; }

        .help-btn-visible {
            width: 36px; height: 36px; background: #25D366; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-left: 10px; transition: transform 0.2s, background 0.2s;
        }
        .help-btn-visible:active { transform: scale(0.9); background: #128C7E; }

        /* --- 3. APP HEADER (HEADER DO PERSONALIZADOR) --- */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; 
            z-index: 9999; /* Z-INDEX ALTO PARA FICAR POR CIMA DE TUDO */
            background: #ffffff; height: var(--app-header-height);
            border-bottom: 1px solid #f0f0f0; 
            display: none; /* Começa invisível */
            align-items: center; padding: 0 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        /* Mostra apenas quando a classe customizer-mode estiver no body */
        body.customizer-mode .app-header { display: flex; justify-content: center; }
        
        .app-header-inner {
            width: 100%; max-width: 1200px; height: 100%;
            display: flex; align-items: center; justify-content: space-between; gap: 8px;
        }

        .ah-back-btn { color: var(--primary); display: flex; align-items: center; justify-content: center; padding: 6px; cursor: pointer; margin-right: 5px; }
        .ah-cat-btn { background: #f1f5f9; color: var(--secondary); font-size: 0.9rem; font-weight: 700; padding: 8px 25px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 5px; transition: all 0.2s; }
        .ah-cat-btn.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
        .ah-cat-btn:active { background: #e2e8f0; transform: scale(0.95); }
        .ah-actions { display: flex; align-items: center; gap: 8px; margin-left: auto; }
        .ah-icon-btn { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #555; background: #fff; border: 1px solid #eee; transition: all 0.2s; font-size: 1.1rem; }
        .ah-icon-btn:active { transform: scale(0.9); background: #f8fafc; }
        .ah-icon-btn.danger { color: #dc2626; border-color: #fee2e2; background: #fef2f2; }

        .cat-dropdown {
            position: fixed; top: var(--app-header-height); left: 0; right: 0;
            background: #fff; border-bottom: 1px solid #e2e8f0;
            padding: 15px 15px 30px 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 9900; max-height: 75vh; overflow-y: auto;
            transform: translateY(-150%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: block; 
        }
        .cat-dropdown.active { transform: translateY(0); }

        /* --- 4. HERO BANNER --- */
        #home-view { padding-top: var(--header-height); background: #f7f7f7; min-height: 100vh; }
        
        .hero-banner-section {
            padding: 20px 0; background: #ffffff; border-bottom: 1px solid #f0f0f0;
            margin-bottom: 20px; overflow: hidden;
        }

        .hb-track {
            display: flex; gap: 16px; overflow-x: auto; scroll-behavior: smooth;
            scroll-snap-type: x mandatory; padding: 10px 4px 20px;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        .hb-track::-webkit-scrollbar { display: none; }

        .hb-card {
            flex: 0 0 100%; scroll-snap-align: center;
            background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
            border: 1px solid #e2e8f0; border-radius: 16px; padding: 20px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.04); transition: transform 0.3s ease;
            min-height: 100px;
        }
        .hb-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }

        .hb-icon {
            width: 50px; height: 50px; background: #fef2f2; color: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; flex-shrink: 0;
        }
        
        .hb-text { font-size: 1rem; font-weight: 600; color: #334155; line-height: 1.4; }
        
        .hb-indicators { display: flex; justify-content: center; gap: 6px; margin-top: -10px; padding-bottom: 10px; }
        .hb-dot { width: 8px; height: 8px; border-radius: 50%; background: #cbd5e1; transition: all 0.3s; }
        .hb-dot.active { background: var(--primary); width: 20px; border-radius: 4px; }

        .home-grid-container { padding: 10px 16px 60px; }
        .baskets-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }

        /* --- CARROSSEL DE OFERTAS --- */
        .offers-section { margin-bottom: 40px; position: relative; }
        .offers-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .offers-title { font-size: 1.2rem; font-weight: 800; color: #222B49; display: flex; align-items: center; gap: 6px; }
        
        .carousel-wrapper { position: relative; width: 100%; }
        .carousel-track {
            display: grid; grid-auto-flow: column;
            grid-auto-columns: calc((100% - 20px) / 3);
            gap: 10px; overflow-x: auto; scroll-behavior: smooth;
            padding: 5px 2px 20px 2px;
        }
        .nav-arrow {
            position: absolute; top: 40%; transform: translateY(-50%);
            width: 32px; height: 32px; border-radius: 50%;
            background: rgba(255,255,255,0.9); border: 1px solid #e2e8f0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
            color: #333; cursor: pointer; z-index: 10; opacity: 0; pointer-events: none;
            transition: all 0.2s; font-size: 1.2rem;
        }
        .carousel-wrapper:hover .nav-arrow { opacity: 1; pointer-events: auto; }
        .nav-prev { left: -10px; }
        .nav-next { right: -10px; }
        
        .offer-card-simple { display: flex; flex-direction: column; background: transparent; position: relative; cursor: pointer; gap: 4px; }
        .offer-card-simple .cp-img-box { margin-bottom: 0; }
        .offer-card-simple .cp-price { margin-top: 4px; }
        .offer-card-simple:hover .cp-img-box { transform: translateY(-2px); }

        /* --- ESTILO CARD CESTA (HOME) --- */
       .home-basket-card {
            background: #fff; border-radius: 20px; padding: 20px; 
            border: 1px solid #eee; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s;
            margin: 0 auto; max-width: 400px;
        }
        .home-basket-card:hover { transform: translateY(-5px); }
        .hbc-photo-container {
            width: 100%; aspect-ratio: 1 / 1; border-radius: 15px;
            overflow: hidden; margin-bottom: 12px; border: 1px solid #f0f0f0;
        }
        .hbc-photo-container img { width: 100%; height: 100%; object-fit: cover; }
        .hbc-title-top {
            font-size: 1.3rem; font-weight: 800; color: var(--secondary);
            text-transform: uppercase; margin-bottom: 12px; text-align: center;
        }
        .hbc-price-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .hbc-item-count { font-size: 0.9rem; font-weight: 600; color: #64748b; }
        .hbc-price { font-size: 1.4rem; font-weight: 800; color: var(--primary); margin: 0; }
        .btn-view-list {
            background: #f1f5f9; color: var(--primary); border: 1px solid #e2e8f0;
            padding: 12px 15px; border-radius: 10px; font-size: 0.9rem;
            font-weight: 800; margin-bottom: 15px; width: 100%; cursor: pointer;
            transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-view-list:hover { background: var(--primary); color: white; }
        .hbc-actions-grid { display: flex; flex-direction: column; gap: 10px; }
        .btn-home-cust { 
            width: 100%; padding: 12px; background: #ffffff; color: var(--primary); 
            border: 2px solid var(--primary); border-radius: 50px; font-weight: 800; 
            font-size: 0.9rem; text-transform: uppercase;
        }
        .btn-home-order { 
            width: 100%; padding: 14px; background: var(--secondary); color: white; 
            border: none; border-radius: 50px; font-weight: 800; font-size: 0.95rem; 
            text-transform: uppercase;
        }

        .grid-modal { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        /* --- 5. CUSTOMIZER VIEW --- */
        #customizer-view { padding-top: calc(var(--app-header-height) + 10px); padding-bottom: 100px; min-height: 100vh; background: #ffffff; }
        
        .chat-container { display: flex; flex-direction: column; gap: 20px; padding-bottom: 140px; }
        
        .chat-msg { 
            background: #f1f5f9; padding: 16px; border-radius: 0 16px 16px 16px; 
            max-width: 85%; align-self: flex-start; color: #334155; line-height: 1.5; font-size: 1.1rem;
            opacity: 1; /* Forçado VISÍVEL por padrão */
            position: relative;
        }
        .chat-msg.wide-summary { max-width: 96%; width: 100%; border-radius: 12px; background: #fff; border: 1px solid #e2e8f0; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
        .chat-msg strong { color: var(--primary); }
        .chat-msg.user { align-self: flex-end; margin-left: auto; background: var(--primary); color: white; border-radius: 16px 16px 0 16px; }
        .chat-msg.user strong { color: white; }

        .chat-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: -10px; padding-left: 5px; width: 100%; }
        .btn-chat { padding: 12px 14px; background: #fff; border: 1px solid var(--primary); color: var(--primary); border-radius: 20px; font-weight: 600; font-size: 1rem; transition: all 0.2s; width: 100%; display: flex; justify-content: center; align-items: center; text-align: center; }
        .btn-chat.primary { background: var(--primary); color: white; grid-column: 1 / -1; padding: 14px 20px; font-size: 1rem; }
        .btn-chat.visited { background: #f1f5f9; color: #64748b; border-color: #cbd5e1; font-weight: 500; }
        .btn-chat.visited:after { content: '✓'; margin-left: 5px; font-weight: bold; }
        .btn-chat:active { transform: scale(0.95); }

        .corridor-grid { display: grid; grid-template-columns: 1fr; gap: 16px; width: 100%; margin-top: 10px; }
        .corridor-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; }
        .corridor-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        
        .btn-main-cat { width: 100%; padding: 14px 16px; background: #ffffff; color: #1e293b; font-weight: 700; font-size: 0.95rem; text-transform: capitalize; border: none; border-bottom: 1px solid #f1f5f9; border-left: 4px solid var(--primary); text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .btn-main-cat:after { content: '›'; font-size: 1.4rem; color: #cbd5e1; line-height: 1; }
        .btn-main-cat.visited { background: #f8fafc; color: #64748b; border-left-color: #cbd5e1; }
        .btn-main-cat.visited:after { content: '✓'; color: #22c55e; font-weight: 800; font-size: 1rem; }

        .sub-cat-list { padding: 16px 12px; background: #ffffff; display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; justify-items: center; }
        .btn-sub-cat { display: flex; flex-direction: column; align-items: center; width: 100%; background: transparent; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-sub-cat:active { transform: scale(0.95); opacity: 0.8; }

        .bsc-img-container { width: 95px; height: 95px; border-radius: 50%; overflow: hidden; margin-bottom: 8px; background: #f1f5f9; border: none; box-shadow: none; display: flex; align-items: center; justify-content: center; }
        .bsc-img { width: 100%; height: 100%; object-fit: cover; }
        .bsc-placeholder { font-size: 1.5rem; color: #cbd5e1; }
        .bsc-label { font-size: 0.75rem; color: #64748b; font-weight: 600; text-align: center; line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .btn-sub-cat.visited .bsc-img-container { border: 2px solid #22c55e; }
        .btn-sub-cat.visited .bsc-label { color: #166534; font-weight: 700; }

        .coupon-mini-box { display: flex; gap: 8px; margin-top: 15px; border-top: 1px dashed #e2e8f0; padding-top: 15px; align-items: center; }
        .mini-inp { flex: 1; background: #f8fafc; border: 1px solid #cbd5e1; padding: 8px 12px; border-radius: 6px; font-size: 0.85rem; outline: none; text-transform: uppercase; }
        .mini-btn-ok { background: #333; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 0.8rem; cursor: pointer; }

        .typing-indicator { display: inline-flex; gap: 4px; padding: 12px 16px; background: #f1f5f9; border-radius: 0 16px 16px 16px; width: fit-content; opacity: 1; }
        .typing-indicator span { width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        
        .credit-chip-bar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%); background: #1e293b; color: white; padding: 6px 8px 6px 16px; border-radius: 50px; display: flex; align-items: center; gap: 12px; z-index: 9999; box-shadow: 0 10px 25px rgba(0,0,0,0.2); transition: all 0.4s; width: 90%; max-width: 380px; justify-content: space-between; }
        .credit-chip-bar.visible { transform: translateX(-50%) translateY(0); }
        .ccb-text { font-size: 0.85rem; font-weight: 500; display: flex; flex-direction: column; }
        .ccb-val { font-weight: 700; font-size: 1rem; color: #4ade80; }
        .ccb-btn { background: var(--primary); color: white; border-radius: 40px; padding: 10px 20px; font-weight: 700; font-size: 0.9rem; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .ccb-btn.disabled { background: #64748b; cursor: default; pointer-events: none; opacity: 0.9; box-shadow: none; }

        .subcat-section { margin-bottom: 15px; margin-top: 10px; position: relative; }
        .subcat-title { font-size: 1.1rem; margin: 0 0 12px 16px; letter-spacing: -0.3px; display: flex; }
        .subcat-pill { padding: 6px 16px; border-radius: 20px; font-weight: 700; display: inline-block; }

        .grid-products-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 0 0 16px 0; }
        #chat-stream .grid-products-row { grid-template-columns: repeat(2, 1fr); gap: 8px; }

        .btn-load-more { width: auto; max-width: 250px; padding: 12px 24px; background: var(--primary); color: #ffffff; border: none; border-radius: 50px; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; margin: 15px auto 25px; cursor: pointer; text-align: center; transition: all 0.2s; display: block; box-shadow: 0 4px 12px rgba(211, 26, 40, 0.2); }
        .btn-load-more:hover { background: var(--primary-dark); transform: scale(1.03); }
        .btn-load-more:active { transform: scale(0.97); }
        
        .card-prod { width: 100%; background: transparent; border: none; padding: 0 0 4px 0; display: flex; flex-direction: column; position: relative; gap: 2px; }
        .cp-tag { position: absolute; top: 0px; left: 0px; background: #dc2626; color: #ffffff; font-size: 0.65rem; padding: 3px 8px; font-weight: 700; border-radius: 4px; z-index: 10; }
        .cp-tag-off { position: absolute; top: 0px; right: 0px; left: auto; background: #029939; color: #ffffff; font-size: 0.65rem; padding: 3px 8px; font-weight: 700; border-radius: 4px; z-index: 10; }
        .home-qty-text { text-align: left; font-size: 0.8rem; color: var(--primary); font-weight: 800; margin-top: 8px; margin-bottom: 2px; margin-left: 2px; display: block; }
        
        .cp-img-box { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; margin-bottom: 0px; cursor: pointer; position: relative; background: #f3f4f6; border-radius: 18px; overflow: hidden; }
        .cp-img { width: 105%; height: 105%; object-fit: contain; border-radius: 18px; }
        .grid-products-row .cp-img { width: 100%; height: 100%; object-fit: contain; transform: scale(1.05); }

        .card-action-row { display: flex; justify-content: flex-end; margin-top: -24px; margin-right: 6px; margin-bottom: 2px; position: relative; z-index: 5; height: 32px; }
        .btn-circle-add { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.6rem; font-weight: 300; cursor: pointer; padding-bottom: 3px; line-height: 1; position: relative; }
        .qty-ctrl-float { position: relative; height: 32px; background: white; border: 1px solid #e5e5e5; border-radius: 19px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.15); overflow: hidden; }
        .qcf-btn { width: 34px; height: 100%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem; cursor: pointer; }
        .qcf-val { font-size: 0.9rem; font-weight: 700; padding: 0 4px; min-width: 20px; text-align: center; }

        .cp-price { font-size: 0.95rem; font-weight: 700; color: #1a1a1a; margin: 2px 2px 2px; text-align: left; }
        .cp-price.offer-price { color: #dc2626; }
        .cp-price small { font-size: 0.65rem; text-decoration: line-through; color: #999; font-weight: 400; margin-left: 6px; }
        .cp-title { font-size: 0.75rem; font-weight: 500; color: #333; margin: 0 2px 4px; line-height: 1.35; min-height: 2.4em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-align: left; }
        .card-prod.readonly .cp-price, .card-prod.readonly .card-action-row { display: none !important; }
        .card-prod.readonly .cp-img-box { background: #f3f4f6; aspect-ratio: 1; border-radius: 18px; }
        .card-prod.readonly { pointer-events: none; }

        .sheet-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 11000; opacity: 0; pointer-events: none; transition: opacity 0.3s; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; }
        .sheet-overlay.open { opacity: 1; pointer-events: auto; }
        .sheet-box { background: #fff; width: 100%; border-radius: 20px 20px 0 0; max-height: 85vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.3s; padding: 20px; }
        .sheet-overlay.open .sheet-box { transform: translateY(0); }
        .sheet-box::-webkit-scrollbar { width: 6px; display: block; }
        .sheet-box::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        details.faq-box { margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
        details.faq-box summary { font-weight: 600; cursor: pointer; list-style: none; padding: 15px; background: #f8fafc; }
        .faq-text { padding: 15px; color: var(--text-main); font-size: 0.95rem; line-height: 1.5; border-top: 1px solid #eee; }

        .faq-whatsapp-btn { display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; padding: 16px; margin-top: 10px; border-radius: 12px; background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; text-decoration: none; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3); transition: transform 0.2s; }
        .faq-whatsapp-btn:active { transform: scale(0.98); }

        .main-footer { background: #fff; border-top: 1px solid #e2e8f0; padding: 40px 0 80px; margin-top: 40px; }
        .footer-info { text-align: center; margin-bottom: 30px; }
        .footer-info h3 { font-size: 1.2rem; margin-bottom: 10px; color: var(--secondary); }
        .footer-info p { margin-bottom: 5px; color: #666; font-size: 0.9rem; }
        .footer-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; max-width: 400px; margin: 0 auto 30px; padding: 0 10px; }
        .f-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 6px; padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; background: #ffffff; color: var(--secondary); font-weight: 600; font-size: 0.8rem; text-decoration: none; text-align: center; transition: all 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .f-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: #cbd5e1; }
        .copyright { text-align: center; font-size: 0.8rem; color: #475569; border-top: 1px solid #f1f5f9; padding-top: 20px; margin-top: 10px; }

        @media(min-width: 1024px) { 
            .grid-products-row { grid-template-columns: repeat(3, 1fr) !important; } 
            #chat-stream .grid-products-row { grid-template-columns: repeat(6, 1fr) !important; }
            .baskets-grid { grid-template-columns: repeat(3, 1fr) !important; gap: 30px; } 
            .carousel-track { grid-auto-columns: calc((100% - 60px) / 7); gap: 10px; }
            .nav-arrow { width: 40px; height: 40px; opacity: 1; pointer-events: auto; } 
            .nav-prev { left: -20px; }
            .nav-next { right: -20px; }
            .hb-card { flex: 0 0 32%; }
            #customizer-view:not(.hidden) { max-width: 1200px; margin: 0 auto; padding: 60px 20px 100px; }
            .chat-actions { display: flex; width: auto; }
            .btn-chat { width: auto; }
            .btn-chat.primary { width: auto; }
            .corridor-grid { grid-template-columns: repeat(3, 1fr); }
            .footer-actions { grid-template-columns: repeat(4, 1fr); max-width: 700px; }
            .grid-modal { grid-template-columns: repeat(5, 1fr); }
            @media(min-width: 768px) { .sheet-box { max-width: 500px; margin-bottom: 20px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.25); } }
        }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="container header-inner">
            <a href="#" class="logo-container" onclick="location.reload()">
                <img src="https://donaantonia.com.br/site/img/produtos/logo-cesta-basica-dona-antonia-cesta-basica-cuiaba-varzea-grande.webp" class="logo-brand-img" alt="Logo Dona Antônia" width="53" height="53">
                <div class="logo-text-col">
                    <span class="logo-name">Dona Antônia</span>
                    <span class="logo-slogan">A Melhor Cesta da Cidade</span>
                </div>
            </a>
            
            <div style="display:flex; align-items:center; gap: 8px;">
                <button class="ah-icon-btn" onclick="window.open('https://instagram.com/donaantoniacestas','_blank')" title="Instagram" style="border-color:#e2e8f0;">
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
                </button>
                <button class="ah-icon-btn" onclick="window.open('https://api.whatsapp.com/send?phone=5565996813588','_blank')" title="WhatsApp" style="border-color:#e2e8f0;">
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
                </button>
                <div class="help-btn-visible" onclick="App.openSheet('faq-sheet')" style="margin-left:0;">?</div>
            </div>
        </div>

        <div id="cat-dropdown" class="cat-dropdown"></div>

        <div class="main-content-col">
            <div class="container"><div id="chat-stream" class="chat-container"></div></div>
        </div>

        <div id="credit-chip" class="credit-chip-bar">
            <div class="ccb-text"><span id="ccb-label">Total do Pedido</span><span id="ccb-val" class="ccb-val">R$ 0,00</span></div>
            <button class="ccb-btn" onclick="ChatFlow.startCheckout()">Ver Cesta</button>
        </div>
    </div>

    <div id="info-sheet" class="sheet-overlay" onclick="if(event.target===this) App.closeSheet('info-sheet')">
        <div class="sheet-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:700;">
                <span id="info-title">Detalhes</span><span onclick="App.closeSheet('info-sheet')" style="cursor:pointer">✕</span>
            </div>
            <div id="info-media" style="margin-bottom:15px;"></div>
            <div id="info-body" style="font-size:0.95rem; line-height:1.6; color:var(--text-main);"></div>
        </div>
    </div>

    <div id="faq-sheet" class="sheet-overlay" onclick="if(event.target===this) App.closeSheet('faq-sheet')">
        <div class="sheet-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <h3 style="margin:0; color:var(--secondary);">Dúvidas Frequentes</h3>
                <span onclick="App.closeSheet('faq-sheet')" style="font-size:1.5rem; color:#999; cursor:pointer">✕</span>
            </div>
            <div style="overflow-y:auto; padding-bottom:10px;">
                <details class="faq-box"><summary>Quais as formas de pagamento?</summary><div class="faq-text">Aceitamos pagamento na entrega via Dinheiro, Pix, Cartão de Crédito, Cartão de Débito e Vale Alimentação.</div></details>
                <details class="faq-box"><summary>Qual o prazo de entrega?</summary><div class="faq-text">Entregamos em até 24 horas úteis após a confirmação do pedido para Cuiabá e Várzea Grande.</div></details>
                <details class="faq-box"><summary>A entrega é grátis?</summary><div class="faq-text">O frete é grátis para compras acima de R$ 85,00. Para valores menores, consulte a taxa no checkout.</div></details>
                <details class="faq-box"><summary>Posso alterar os itens da cesta?</summary><div class="faq-text">Sim! Você pode personalizar sua cesta trocando itens ou adicionando produtos extras.</div></details>
                <details class="faq-box"><summary>Vocês têm loja física?</summary><div class="faq-text">Sim, estamos localizados no bairro Jardim Nossa Senhora Aparecida em Cuiabá.</div></details>
            </div>
            <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px; text-align: center;">
                <p style="font-size: 0.85rem; color: #666; margin-bottom: 12px;">Ainda precisa de ajuda?</p>
                <a href="https://api.whatsapp.com/send?phone=5565996813588&text=Olá, tenho uma dúvida sobre as cestas." target="_blank" class="faq-whatsapp-btn">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.592 2.654-.696c1.001.572 2.097.872 3.154.872h.001c3.181 0 5.768-2.586 5.768-5.766.001-3.18-2.585-5.767-5.766-5.767zm6.591 9.473c-.22.616-1.282 1.13-1.756 1.189-.436.054-.925.263-3.136-1.157-2.39-1.536-3.927-4.137-4.047-4.298-.119-.161-.963-1.286-.963-2.453 0-1.166.608-1.742.824-1.981.216-.239.576-.299.768-.299.192 0 .384.001.552.012.18.012.42.067.636.587.228.552.768 1.908.84 2.046.072.138.12.3.024.492-.096.192-.144.312-.288.48-.144.168-.3.234-.432.396-.144.15-.294.312-.126.6.168.288.75 1.224 1.608 1.992 1.104.984 2.04 1.29 2.328 1.428.288.138.456.12.624-.072.168-.192.72-1.05.912-1.41.192-.36.384-.3.648-.198.264.102 1.68.792 1.968.936.288.144.48.216.552.336.072.12.072.696-.144 1.312z"/></svg>
                    Falar com Atendente
                </a>
            </div>
        </div>
    </div>
    
    <script>
        const CONSTANTS = { 
            PHONE: "5565996813588",
            LIMITS: { 'econômica': 5, 'economica': 5, 'mini': 7, 'pequena': 9, 'média': 11, 'media': 11, 'grande': 13 },
            COUPON_CODE: "BEMVINDO",
            COUPON_VAL: 5.00,
            ICONS: {
                TRASH: '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round"/></svg>'
            }
        };

        const ChatFlow = {
            container: null, categories: [], categoryMap: {}, visitedCorridors: [], visitedSubCats: [], catIndex: 0,
            checkoutState: { paymentMethod: '', couponApplied: false },
            
            async start() {
                this.container = document.getElementById('chat-stream'); this.container.innerHTML = '';
                this.visitedCorridors = []; this.visitedSubCats = []; this.categoryMap = {}; 
                
                try {
                    App.data.forEach(p => {
                         // Ignora se não tiver categoria ou se for Cesta
                         if(!p.appCategory || p.appCategory === 'undefined' || p.categoria.includes('CESTA')) return;
                         if(!this.categoryMap[p.appCategory]) this.categoryMap[p.appCategory] = new Set();
                         if(p.subCategory) this.categoryMap[p.appCategory].add(p.subCategory);
                    });
                    this.categories = Object.keys(this.categoryMap).sort((a,b) => {
                        const score = c => c.includes('MERCEARIA')?3:c.includes('LANCHES')?2:c.includes('LIMPEZA')?1:0;
                        return score(b) - score(a) || a.localeCompare(b);
                    });
                } catch(e) { console.error("Erro processando categorias", e); }
                
                const h = new Date().getHours();
                // Adiciona mensagem de boas-vindas
                this.addMessage(`${h<12?'Bom dia':h<18?'Boa tarde':'Boa noite'}! Vi que você escolheu a <strong>${App.currentBasket ? App.currentBasket.nome : 'Cesta'}</strong>, certo?`);
                this.container.insertAdjacentHTML('beforeend', `<div id="act-intro" class="chat-actions" style="margin-top:5px;"><button class="btn-chat primary" onclick="ChatFlow.explainRules('act-intro')">Sim!</button></div>`);
            },
            async explainRules(id) {
                document.getElementById(id)?.remove(); this.addMessage("Sim!", 'user');
                await this.wait(600); this.showTyping(); await this.wait(600);
                this.addMessage("Legal!\n\nPrimeiro retire os produtos que não quer, ok?");
                this.container.insertAdjacentHTML('beforeend', `<div id="act-show-list" class="chat-actions" style="margin-top:5px;"><button class="btn-chat primary" onclick="ChatFlow.showInitialList('act-show-list')">Ok</button></div>`);
            },
            async showInitialList(id) {
                document.getElementById(id)?.remove(); this.addMessage("Ok", 'user'); await this.wait(400);
                this.showBasketGrid(); await this.wait(1500); this.askRemovalConfirmation();
            },
            async showTyping() {
                const id = 't-'+Date.now(); this.container.insertAdjacentHTML('beforeend', `<div id="${id}" class="typing-indicator"><span></span><span></span><span></span></div>`);
                this.scrollToBottom(); await this.wait(1000); document.getElementById(id)?.remove();
            },
            addMessage(text, type='bot') {
                this.container.insertAdjacentHTML('beforeend', `<div class="chat-msg ${type==='user'?'user':''}">${text}</div>`); this.scrollToBottom();
            },
            showBasketGrid() {
                const html = `<div id="basket-grid" class="subcat-section" style="padding-left:5px;"><div class="subcat-title" style="margin-bottom:12px; font-weight:800; color:#333;">PRODUTOS DA SUA CESTA</div><div class="grid-products-row">${App.cartOrder.map(id=>App.buildCard(App.data.find(x=>x.id===id))).join('')}</div></div>`;
                this.container.insertAdjacentHTML('beforeend', html);
                setTimeout(() => document.getElementById('basket-grid')?.scrollIntoView({behavior:'smooth',block:'start'}), 100);
            },
            askRemovalConfirmation() {
                this.addMessage(`Ok, retirou os produtos que não quer?`);
                this.container.insertAdjacentHTML('beforeend', `<div id="act-rem" class="chat-actions"><button class="btn-chat primary" onclick="ChatFlow.handleRemovalYes('act-rem')">Sim, já retirei</button></div>`);
            },
            async handleRemovalYes(id) {
                document.getElementById(id)?.remove(); this.addMessage("Sim, já retirei.", 'user');
                await this.showTyping(); this.addMessage(`Blz! Atualizei sua cesta. Fique a vontade para repor!`);
                document.getElementById('credit-chip').classList.add('visible'); App.updateTotal(); await this.wait(1000);
                this.showAllProductsAuto();
            },
            async showAllProductsAuto() {
                document.querySelectorAll('.subcat-section:not([id^="basket-grid"])').forEach(s => s.remove());
                for (let cat of this.categories) {
                    const subs = Array.from(this.categoryMap[cat]||[]).sort();
                    if(subs.length) for(let sub of subs) await this.showCategoryAuto(cat, sub);
                    else await this.showCategoryAuto(cat, null);
                }
                document.getElementById('btn-cat-menu').classList.remove('disabled');
                this.container.insertAdjacentHTML('beforeend', `<div class="chat-actions" style="margin-top:20px; padding:20px 0;"><button class="btn-chat primary" onclick="ChatFlow.startCheckout()" style="background:#222B49; border-color:#222B49; width:100%;">Ir para o Caixa</button></div>`);
            },
            async showCategoryAuto(cat, sub) {
                const safeId = 'sec-'+(cat+(sub||'')).replace(/[^a-zA-Z0-9]/g,'');
                let prods = App.data.filter(p => p.appCategory===cat && !p.categoria.includes('CESTA'));
                if(sub) prods = prods.filter(p => p.subCategory===sub);
                if(!prods.length) return;
                prods.sort((a,b)=>a.nome.localeCompare(b.nome));
                
                let head = sub ? `<div style="display:flex; align-items:center; gap:12px;"><img src="img/${App.toSlug(sub)}.webp" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:1px solid #e2e8f0;" onerror="this.style.display='none'"><span style="font-size:1.1rem; font-weight:700; color:#333;">${App.toSmartTitleCase(sub)}</span></div>` : `<span class="subcat-pill" style="background:#eee; color:#333;">${App.toSmartTitleCase(cat)}</span>`;
                this.container.insertAdjacentHTML('beforeend', `<div id="${safeId}" class="subcat-section" style="padding-left:5px;"><div class="subcat-title">${head}</div></div>`);
                App.setupPagination(safeId, prods, 'chat');
            },
            showCategory(eid, cat, sub) {
                const safeId = 'sec-'+(cat+(sub||'')).replace(/[^a-zA-Z0-9]/g,'');
                if(document.getElementById(safeId)) { document.getElementById(safeId).scrollIntoView({behavior:'smooth'}); return; }
                document.getElementById(eid)?.remove();
                document.querySelectorAll('.subcat-section').forEach(s=>s.remove());
                this.showCategoryAuto(cat, sub);
                setTimeout(()=>document.getElementById(safeId)?.scrollIntoView({behavior:'smooth'}), 100);
            },
            async startCheckout() {
                let sum = 0; for(let id in App.cart) { const p = App.data.find(x=>x.id===id); if(p) sum += (p.isOffer?p.offerPrice:p.valor)*App.cart[id]; }
                const total = sum + App.baseFee;
                if(total < App.currentBasket.valor - 0.05) { return this.addMessage(`⚠️ Faltam <strong>R$ ${(App.currentBasket.valor-total).toFixed(2)}</strong>.`); }
                document.getElementById('credit-chip').classList.remove('visible');
                this.addMessage("Finalizar", 'user'); await this.showTyping();
                
                let html = `<div style="padding:15px; width:100%;"><div style="border-bottom:1px solid #eee; padding-bottom:8px; font-weight:700;">${App.currentBasket.nome} <span style="float:right;">R$ ${total.toFixed(2).replace('.',',')}</span></div>`;
                if(!App.appliedCoupon) html += `<div id="mini-c" class="coupon-mini-box"><input id="mc-in" class="mini-inp" placeholder="CUPOM"><button class="mini-btn-ok" onclick="ChatFlow.applyCp()">OK</button></div>`;
                else html += `<div style="text-align:center; color:green; font-weight:700; margin-top:10px;">Cupom Aplicado!</div>`;
                html += `</div>`;

                this.container.insertAdjacentHTML('beforeend', `<div class="chat-msg wide-summary">${html}</div>`);
                await this.wait(1000); this.askPayment();
            },
            applyCp() {
                if(document.getElementById('mc-in').value.toUpperCase() === CONSTANTS.COUPON_CODE) {
                    App.appliedCoupon = true; App.updateTotal();
                    document.getElementById('mini-c').innerHTML = `<div style="text-align:center; color:green; font-weight:700;">Cupom Aplicado!</div>`;
                } else alert("Inválido");
            },
            async askPayment() {
                await this.showTyping(); this.addMessage("Forma de pagamento?");
                const btns = ["Pix", "Dinheiro", "Cartão", "Vale Alimentação"].map(m=>`<button class="btn-chat" onclick="ChatFlow.pay('${m}')">${m}</button>`).join('');
                this.container.insertAdjacentHTML('beforeend', `<div id="act-pay" class="chat-actions">${btns}</div>`);
            },
            async pay(m) {
                document.getElementById('act-pay')?.remove(); this.checkoutState.paymentMethod = m;
                this.addMessage(m, 'user'); await this.wait(600);
                this.addMessage(`Fechado! Pagamento em <strong>${m}</strong>.`);
                const btn = `<button class="btn-chat primary" onclick="ChatFlow.sendWA()" style="background:#25D366; color:white; width:100%;">Enviar no WhatsApp</button>`;
                this.container.insertAdjacentHTML('beforeend', `<div class="chat-actions">${btn}</div>`);
            },
            sendWA() {
                let msg = `*PEDIDO: ${App.currentBasket.nome}*\n`;
                for(let id in App.cart) msg += `${App.cart[id]}x ${App.data.find(x=>x.id===id).nome}\n`;
                if(App.appliedCoupon) msg += `\n*CUPOM: ${CONSTANTS.COUPON_CODE}*`;
                msg += `\n*TOTAL: ${document.getElementById('ccb-val').innerText}*\nPagamento: ${this.checkoutState.paymentMethod}`;
                window.open(`https://api.whatsapp.com/send?phone=${CONSTANTS.PHONE}&text=${encodeURIComponent(msg)}`, '_blank');
            },
            scrollToBottom() { },
            wait(ms) { return new Promise(r => setTimeout(r, ms)); }
        };

        const App = {
            data: [], cart: {}, currentBasket: null, baseFee: 0, originalCart: {}, currentLimit: 99, cartOrder: [], appliedCoupon: false,
            paginationStore: {},
            
            async init() {
                document.addEventListener('click', (e) => {
                    const m = document.getElementById('cat-dropdown'), b = document.getElementById('btn-cat-menu');
                    if(m?.classList.contains('active') && !m.contains(e.target) && !b.contains(e.target)) App.toggleCatMenu();
                });
                
                const track = document.getElementById('hero-banner-track');
                if(track) {
                    let idx = 0;
                    setInterval(() => {
                        idx = (idx + (window.innerWidth>=1024?3:1)) % 6;
                        track.scrollTo({left: idx*(track.querySelector('.hb-card').offsetWidth+16), behavior:'smooth'});
                        document.querySelectorAll('.hb-dot').forEach((d,i)=>d.classList.toggle('active',i===idx));
                    }, 3500);
                }

                try {
                    const res = await fetch('produtos_exportados (2).json?v='+Date.now());
                    const content = await res.json();
                    const raw = Array.isArray(content) ? content : (content.produtos || []);
                    const parseBRL = v => (!v?0:typeof v==='number'?v:parseFloat(v.replace(/\./g,'').replace(',','.')));

                    this.data = raw.filter(p => {
                        const estoque = parseBRL(p.Estoque);
                        const cat = (p["Categoria do produto"] || "").toUpperCase();
                        const isCesta = cat.includes("CESTA");
                        const temFoto = p.imagem && p.imagem !== "";
                        
                        // CORREÇÃO DE CESTA: Mostra se for cesta (mesmo com estoque negativo) OU se tiver estoque positivo
                        return (isCesta || estoque > 0) && temFoto;
                    }).map(p => {
                        const parts = (p["Categoria do produto"]||"OUTROS").split('>>').map(s=>s.trim());
                        if(parts[0]?.toUpperCase()==='PRODUTOS') parts.shift();
                        
                        let main = parts[0]?.toUpperCase() || "OUTROS";
                        if(main.includes('ALIMENTOS')||main.includes('MERCEARIA')) main="MERCEARIA E ALIMENTOS";
                        else if(main.includes('CAFÉ')||main.includes('MATINAIS')) main="CAFÉ DA MANHÃ E LANCHES";
                        else if(main.includes('LIMPEZA')) main="LIMPEZA E LAVANDERIA";
                        else if(main.includes('HIGIENE')) main="CUIDADOS PESSOAIS";
                        else if(main.includes('BAZAR')) main="BAZAR E UTILIDADES";

                        return {
                            id: String(p.ID), nome: this.toSmartTitleCase((p.Descrição||"").trim()),
                            valor: parseBRL(p.Preço), offerPrice: parseBRL(p.Preco_Oferta), isOffer: !!p.Em_Oferta,
                            appCategory: main, subCategory: parts[1]||"Geral",
                            imagem: p.imagem ? `img/produtos/${p.imagem.split('/').pop()}` : 'img/placeholder.jpg',
                            estoque: parseBRL(p.Estoque), limit: parseBRL(p.Estoque),
                            categoria: main
                        };
                    }).sort((a,b)=>a.nome.localeCompare(b.nome));

                    const s = JSON.parse(localStorage.getItem('da_state')||'{}');
                    if(s.view==='customizer' && s.basketId) {
                        const b = this.data.find(p=>p.id===s.basketId);
                        if(b) {
                            this.currentBasket = b; this.cart = s.cart||{}; this.cartOrder = s.cartOrder||[];
                            const k = Object.keys(CONSTANTS.LIMITS).find(x=>b.nome.toLowerCase().includes(x));
                            this.currentLimit = k ? CONSTANTS.LIMITS[k] : 99;
                            this.originalCart = {};
                            if(b.items) b.items.forEach(i => {
                                const m = this.data.find(x=>x.id==i.id); if(m) this.originalCart[m.id] = (this.originalCart[m.id]||0) + (parseInt(i.qty||1));
                            });
                            document.getElementById('home-view').classList.add('hidden');
                            document.getElementById('customizer-view').classList.remove('hidden');
                            document.body.classList.add('customizer-mode');
                            setTimeout(()=>ChatFlow.start(),100); document.body.classList.add('loaded');
                            return;
                        }
                    }
                    this.renderHome(); document.body.classList.add('loaded'); this.renderOffers();
                } catch(e) { 
                    console.error(e);
                    document.getElementById('home-list').innerHTML = `<div style="text-align:center; padding:20px;">Erro. <button onclick="location.reload()">Recarregar</button></div>`; 
                }
            },
            toggleCatMenu() {
                const m = document.getElementById('cat-dropdown');
                m.classList.toggle('active');
                if(m.classList.contains('active') && ChatFlow.categories.length) {
                    m.innerHTML = '<div class="corridor-grid" style="margin-top:0;">' + ChatFlow.categories.map(c => {
                        const subs = Array.from(ChatFlow.categoryMap[c]||[]).sort();
                        return `<div class="corridor-card"><button class="btn-main-cat" onclick="App.toggleCatMenu();ChatFlow.showCategory('act-menu','${c}',null)">${this.toSmartTitleCase(c)}</button><div class="sub-cat-list">${subs.map(s=>`<button class="btn-sub-cat" onclick="App.toggleCatMenu();ChatFlow.showCategory('act-menu','${c}','${s}')"><div class="bsc-img-container"><img src="img/${this.toSlug(s)}.webp" class="bsc-img" onerror="this.style.display='none'"></div><span class="bsc-label">${this.toSmartTitleCase(s)}</span></button>`).join('')}</div></div>`;
                    }).join('') + '</div>';
                }
            },
            toSmartTitleCase(s) { return s.toLowerCase().split(' ').map((w,i)=>['de','da','e','com','no'].includes(w)&&i>0?w:w[0].toUpperCase()+w.slice(1)).join(' '); },
            toSlug(t) { return t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\W+/g,'-'); },
            renderHome() {
                const bs = this.data.filter(p=>p.categoria && p.categoria.includes('CESTA'));
                if(bs.length) document.getElementById('home-list').innerHTML = bs.map(p => `
                    <div class="home-basket-card">
                        <h2 class="hbc-title-top">${p.nome}</h2>
                        <div class="hbc-photo-container"><img src="${p.imagem}" loading="lazy"></div>
                        <div class="hbc-price-row"><span class="hbc-item-count">📦 ${p.items?p.items.reduce((a,c)=>a+parseInt(c.qty),0):0} Itens</span><div class="hbc-price">R$ ${p.valor.toFixed(2).replace('.',',')}</div></div>
                        <button class="btn-view-list" onclick="App.openBasketPreview('${p.id}')">🔍 VER LISTA</button>
                        <div class="hbc-actions-grid"><button onclick="App.openCustomizer('${p.id}')" class="btn-home-cust">Personalizar</button><button onclick="window.open('https://api.whatsapp.com/send?phone=${CONSTANTS.PHONE}&text=Quero a ${p.nome}','_blank')" class="btn-home-order">Encomendar Normal</button></div>
                    </div>`).join('');
            },
            renderOffers() {
                const offs = this.data.filter(p=>p.isOffer); if(!offs.length) return;
                document.getElementById('offers-track').innerHTML = offs.map(p => `<div class="card-prod offer-card-simple" onclick="App.openInfo('${p.id}')"><span class="cp-tag-off">OFF</span><div class="cp-img-box"><img src="${p.imagem}" class="cp-img" loading="lazy"></div><div class="cp-price offer-price">R$ ${p.offerPrice.toFixed(2).replace('.',',')}<small>R$${p.valor.toFixed(2).replace('.',',')}</small></div><div class="cp-title">${p.nome}</div></div>`).join('');
                document.getElementById('offers-carousel-container').classList.remove('hidden');
            },
            setupPagination(id, prods, type) {
                const limit = window.innerWidth>=1024?6:3; this.paginationStore[id] = { prods, idx: 0, limit, type };
                this.loadMore(id);
            },
            loadMore(id) {
                const d = this.paginationStore[id]; if(!d) return;
                const batch = d.prods.slice(d.idx, d.idx+d.limit);
                let html = batch.map(item => d.type==='home'?`<div class="card-prod readonly"><div class="cp-img-box"><img src="${item.d.imagem}" class="cp-img"></div><div class="home-qty-text">${item.qty} un</div><div class="cp-title">${item.d.nome}</div></div>`:this.buildCard(item)).join('');
                document.getElementById(id).querySelector('.grid-products-row') ? document.getElementById(id).querySelector('.grid-products-row').insertAdjacentHTML('beforeend', html) : document.getElementById(id).insertAdjacentHTML('beforeend', `<div class="grid-products-row">${html}</div>`);
                d.idx += d.limit; document.getElementById('btn-'+id)?.remove();
                if(d.idx < d.prods.length) document.getElementById(id).insertAdjacentHTML('beforeend', `<button id="btn-${id}" class="btn-load-more" onclick="App.loadMore('${id}')">VER MAIS</button>`);
            },
            buildCard(p) {
                const qty = this.cart[p.id]||0; 
                return `<div class="card-prod" id="card-${p.id}">${p.isOffer?'<span class="cp-tag">OFERTA</span>':''}<div class="cp-img-box" onclick="App.openInfo('${p.id}')"><img src="${p.imagem}" class="cp-img" loading="lazy"></div><div class="card-action-row"><div id="btn-add-${p.id}" class="btn-circle-add ${qty>0?'hidden':''}" onclick="event.stopPropagation();App.modQty('${p.id}',1)">+</div><div id="qty-ctrl-${p.id}" class="qty-ctrl-float ${qty>0?'':'hidden'}" onclick="event.stopPropagation()"><div id="btn-dec-${p.id}" class="qcf-btn" onclick="App.modQty('${p.id}',-1)">${qty===1?CONSTANTS.ICONS.TRASH:'-'}</div><div class="qcf-val" id="qty-val-${p.id}">${qty}</div><div class="qcf-btn" onclick="App.modQty('${p.id}',1)">+</div></div></div><div class="cp-price ${p.isOffer?'offer-price':''}">R$ ${(p.isOffer?p.offerPrice:p.valor).toFixed(2).replace('.',',')}</div><div class="cp-title">${p.nome}</div></div>`;
            },
            modQty(id, delta) {
                const p = this.data.find(x=>x.id===id); if(!this.cart[id]) this.cart[id]=0;
                const n = this.cart[id]+delta;
                if(delta>0 && n>p.estoque) return alert(`Apenas ${p.estoque} unidades disponíveis.`);
                if(delta>0 && n>p.limit) return alert(`Limite de ${p.limit} por item.`);
                let rm = 0; for(let i in this.originalCart) if(this.originalCart[i]>0 && !this.cart[i]) rm++;
                if(this.originalCart[id] && delta<0 && n===0 && rm>=this.currentLimit) return alert(`Limite de ${this.currentLimit} trocas.`);
                
                this.cart[id] = n; if(n<=0) { delete this.cart[id]; this.cartOrder=this.cartOrder.filter(x=>x!==id); } 
                else if(this.cart[id]===delta && delta>0) this.cartOrder.unshift(id);
                
                this.updateCardUI(id,n); this.updateTotal(); localStorage.setItem('da_state',JSON.stringify({view:'customizer',basketId:this.currentBasket.id,cart:this.cart,cartOrder:this.cartOrder}));
            },
            updateCardUI(id, qty) {
                document.querySelectorAll(`[id="btn-add-${id}"]`).forEach(e=>e.classList.toggle('hidden',qty>0));
                document.querySelectorAll(`[id="qty-ctrl-${id}"]`).forEach(e=>e.classList.toggle('hidden',qty<=0));
                document.querySelectorAll(`[id="qty-val-${id}"]`).forEach(e=>e.innerText=qty);
                document.querySelectorAll(`[id="btn-dec-${id}"]`).forEach(e=>e.innerHTML=qty===1?CONSTANTS.ICONS.TRASH:'-');
            },
            updateTotal() {
                let sum=0; for(let i in this.cart) { const p=this.data.find(x=>x.id===i); if(p) sum+=(p.isOffer?p.offerPrice:p.valor)*this.cart[i]; }
                let tot = sum+this.baseFee - (this.appliedCoupon?CONSTANTS.COUPON_VAL:0);
                document.getElementById('ccb-val').innerText = 'R$ '+Math.max(0,tot).toFixed(2).replace('.',',');
                const btn = document.querySelector('.ccb-btn');
                if(sum+this.baseFee < this.currentBasket.valor-0.05) { btn.innerText="Completar"; btn.classList.add('disabled'); btn.onclick=null; }
                else { btn.innerText="Finalizar"; btn.classList.remove('disabled'); btn.onclick=()=>ChatFlow.startCheckout(); }
            },
            openBasketPreview(id) {
                const p = this.data.find(x=>x.id===id); if(!p||!p.items) return;
                let html = p.items.map(i=>{const d=this.data.find(x=>x.id==i.id);return d?`<div style="text-align:center;font-size:0.7rem;"><img src="${d.imagem}" style="width:100%;border-radius:10px;"><div style="font-weight:700;">${i.qty}x</div><div>${d.nome}</div></div>`:''}).join('');
                document.getElementById('info-title').innerText = p.nome; document.getElementById('info-media').innerHTML=''; document.getElementById('info-body').innerHTML=`<div class="grid-modal">${html}</div>`;
                App.openSheet('info-sheet');
            },
            openCustomizer(id) {
                const b = this.data.find(p=>p.id===id); if(!b) return;
                this.currentBasket = b; this.cart={}; this.cartOrder=[]; this.appliedCoupon=false;
                if(b.items) b.items.forEach(i=>{ const m=this.data.find(x=>x.id==i.id); if(m) { this.cart[m.id]=(this.cart[m.id]||0)+parseInt(i.qty); if(!this.cartOrder.includes(m.id)) this.cartOrder.push(m.id); }});
                this.originalCart={...this.cart};
                let s=0; for(let k in this.cart) {let x=this.data.find(z=>z.id==k); if(x) s+=(x.isOffer?x.offerPrice:x.valor)*this.cart[k];}
                this.baseFee=b.valor-s;
                const k = Object.keys(CONSTANTS.LIMITS).find(x=>b.nome.toLowerCase().includes(x)); this.currentLimit = k?CONSTANTS.LIMITS[k]:99;
                document.getElementById('home-view').classList.add('hidden'); document.getElementById('customizer-view').classList.remove('hidden'); document.body.classList.add('customizer-mode');
                this.updateTotal(); window.scrollTo(0,0); ChatFlow.start(); localStorage.setItem('da_state',JSON.stringify({view:'customizer',basketId:id,cart:this.cart,cartOrder:this.cartOrder}));
            },
            openInfo(id) {
                const p = this.data.find(x=>x.id===id); if(!p) return;
                document.getElementById('info-title').innerText=p.nome;
                let html = `<img src="${p.imagem}" style="width:100%; border-radius:8px;">`;
                document.getElementById('info-media').innerHTML=html; document.getElementById('info-body').innerText="Detalhes indisponíveis.";
                App.openSheet('info-sheet');
            },
            openSheet(id) { document.getElementById(id).classList.add('open'); },
            closeSheet(id) { document.getElementById(id).classList.remove('open'); },
            goHome() { document.getElementById('customizer-view').classList.add('hidden'); document.getElementById('home-view').classList.remove('hidden'); document.body.classList.remove('customizer-mode'); document.getElementById('credit-chip').classList.remove('visible'); localStorage.setItem('da_state',JSON.stringify({view:'home'})); },
            resetCart() { if(confirm("Limpar tudo?")) { localStorage.removeItem('da_state'); location.reload(); } }
        };
        
        window.ChatFlow = ChatFlow; window.App = App;
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
