<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="Super Cestas B√°sicas Dona Ant√¥nia - Qualidade e pre√ßo justo.">
<meta name="theme-color" content="#ffffff">
<title>Super Cestas B√°sicas Dona Ant√¥nia</title>
<style>
:root {
    /* PALETA PROFISSIONAL */
    --c-p: #0f172a;      /* Texto Principal */
    --c-s: #1e293b;      /* Texto Secund√°rio */
    --c-t: #64748b;      /* Texto Terci√°rio */
    --c-a: #ea580c;      /* A√ß√£o Principal (Laranja) */
    --c-ok: #15803d;     /* Sucesso */
    --c-err: #b91c1c;    /* Erro */
    --c-bg: #e2e8f0;     /* Fundo Geral */
    --c-surf: #ffffff;   /* Superf√≠cie Cards */
    --c-bd: #cbd5e1;     /* Bordas */
    --font: 'Inter', system-ui, sans-serif;
    
    --sh-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
    --sh-float: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
body{font-family:var(--font);background:var(--c-bg);color:var(--c-p);margin:0;padding:0;height:100dvh;display:flex;flex-direction:column;overflow:hidden;-webkit-font-smoothing:antialiased}
img{user-select:none;} 
button{cursor:pointer;border:none;background:0 0;font-family:inherit;font-weight:600}

/* LAYOUT DESKTOP LIMITER */
.layout-limit { width: 100%; max-width: 1200px; margin: 0 auto; position: relative; }

/* HEADER */
.app-header{flex:0 0 auto;width:100%;background:#fff;border-bottom:1px solid var(--c-bd);z-index:20;display:flex;flex-direction:column;align-items:center}
.header-inner{display:flex;align-items:center;padding:12px 20px 12px 20px;width:100%;gap:15px;}
.header-brand{display:flex;align-items:center;gap:10px;flex-shrink:0;}
.logo{width:65px;height:65px;border-radius:50%;object-fit:cover;border:1px solid var(--c-bd)}

/* SEARCH BAR & FAQ */
.search-bar-area{flex:1; display:flex; gap:10px; align-items:center;}
.search-wrapper{position:relative; flex:1;}
.search-inp{width:100%;background:#f8fafc;border:1px solid var(--c-bd);padding:12px 15px 12px 40px;border-radius:12px;font-weight:600;color:var(--c-p);transition:box-shadow .2s;font-size:0.95rem;}
.search-inp:focus{box-shadow:0 0 0 2px rgba(15, 23, 42, 0.1); border-color:var(--c-p)}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--c-t);pointer-events:none}
.clear-search{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:#cbd5e1;color:#fff;border-radius:50%;width:24px;height:24px;font-size:12px;display:none;align-items:center;justify-content:center;cursor:pointer}
.btn-faq{background:#f1f5f9; color:var(--c-p); width:44px; height:44px; border-radius:12px; display:flex; align-items:center; justify-content:center; flex-shrink:0; border:1px solid var(--c-bd);}

/* CHIPS BAR & STICKY CORREDORES */
.chips-bar {
    width: 100%; max-width: 1200px; padding: 4px 20px 12px 20px; gap: 8px;
    overflow-x: auto; scroll-behavior: smooth; align-items: center;
}
.chips-bar::-webkit-scrollbar { display: none; }
.chip {
    padding: 8px 16px; border-radius: 20px; font-size: 0.75rem; font-weight: 700;
    background: #f1f5f9; color: var(--c-s); white-space: nowrap; border: 1px solid var(--c-bd);
    cursor: pointer; transition: 0.2s;
}
.chip.active { background: var(--c-p); color: #fff; border-color: var(--c-p); }

#chips-corredores {
    position: sticky; top: 0; z-index: 15; background: var(--c-bg); 
    padding-top: 10px; margin-top: -5px; box-shadow: 0 4px 6px -6px rgba(0,0,0,0.1);
}

/* PALCO CENTRAL (GRADE VERTICAL) */
.main-stage{flex:1;position:relative;display:block;overflow-y:auto;overflow-x:hidden;background:var(--c-bg);padding-bottom:120px; scroll-behavior:smooth;}

/* BANNERS */
.banner-wrapper {
    width: 100%; max-width: 1200px; margin: 0 auto;
    padding: 15px 20px 5px; display: none; gap: 12px;
    overflow-x: auto; scroll-snap-type: x mandatory;
    scrollbar-width: none;
}
.banner-wrapper::-webkit-scrollbar { display: none; }
.banner-card {
    flex: 0 0 auto; width: max-content; max-width: 85vw; scroll-snap-align: start;
    border-radius: 16px; padding: 18px 25px;
    display: flex; flex-direction: column; justify-content: center;
    cursor: pointer; transition: transform 0.2s;
    min-height: 90px; box-shadow: var(--sh-card);
}
.banner-card:active { transform: scale(0.98); }
.banner-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 4px; line-height: 1.1; letter-spacing: -0.5px;}
.banner-sub { font-size: 0.8rem; font-weight: 500; opacity: 0.9; line-height: 1.2; }

@media(min-width: 800px) {
    .banner-wrapper { overflow-x: visible; }
    .banner-card { flex: 1; max-width: none; width: auto; }
}

/* SECTIONS P√ÅGINA √öNICA */
.page-section { margin-bottom: 10px; width: 100%; max-width: 1200px; margin-left: auto; margin-right: auto;}
.section-title { font-size: 1.2rem; font-weight: 900; color: var(--c-p); padding: 15px 20px 10px; text-transform: uppercase; letter-spacing: -0.5px;}

.grid-wrapper{
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px; padding: 5px 20px 15px;
    width: 100%; align-content: start;
}
.grid-wrapper.list-view { grid-template-columns: 1fr; gap: 10px; padding: 5px 20px 10px; }

@media(min-width: 600px) {
    .grid-wrapper.list-view { grid-template-columns: 1fr 1fr; }
}
@media(max-width:600px){
    .grid-wrapper{ grid-template-columns: 1fr 1fr; gap: 10px; padding: 5px 15px 15px; }
    .grid-wrapper.list-view { grid-template-columns: 1fr; padding: 5px 15px 10px; }
    .section-title { padding: 15px 15px 10px; }
}

/* CARDS (Cestas e Combos) */
.u-card{
    background:var(--c-surf); border-radius:20px; border:1px solid #fff; box-shadow:var(--sh-card);
    display:flex;flex-direction:column; position:relative; height: 100%; transition:transform .2s, box-shadow .2s;
}
.u-card:hover{box-shadow:var(--sh-float);transform:translateY(-4px);z-index:10}
.u-img-area{width:100%;aspect-ratio:1;background:#fff;position:relative;overflow:hidden;border-bottom:1px solid #f1f5f9;cursor:zoom-in; border-radius: 20px 20px 0 0;}
.u-img{width:100%;height:100%;object-fit:contain;mix-blend-mode:multiply;padding:5px;transition:transform .3s} 
.u-img-area:hover .u-img{transform:scale(1.05)}
.u-img-cesta{object-fit:cover;padding:0;mix-blend-mode:normal}
.offer-tag{position:absolute;bottom:0;left:0;background:#dc2626;color:#fff;font-size:0.7rem;padding:4px 10px;border-top-right-radius:12px;font-weight:800;z-index:5;box-shadow:2px -2px 5px rgba(0,0,0,0.1)}
.combo-strike { text-decoration: line-through; color: var(--c-t); font-size: 0.85rem; font-weight: 600; }
.combo-save { color: var(--c-ok); font-size: 0.75rem; font-weight: 800; background: #dcfce7; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px;}
.u-info{padding:10px;display:flex;flex-direction:column;gap:4px;flex:1; border-radius: 0 0 20px 20px; background: var(--c-surf);}
.u-name{font-size:0.8rem; font-weight:600; color:var(--c-p); line-height:1.3; display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden; min-height:3.9em; flex-grow: 1; }
.u-price{font-size:1.15rem;font-weight:800;color:var(--c-a);letter-spacing:-0.5px;}

/* CARDS HORIZONTAIS (Produtos) - AUMENTADOS */
.u-card-horiz {
    background: var(--c-surf); border-radius: 16px; box-shadow: var(--sh-card); border: 1px solid #fff;
    display: flex; padding: 12px; gap: 14px; align-items: center; position: relative; transition:transform .2s;
}
.u-card-horiz:active { transform: scale(0.98); }
.u-card-horiz .img-horiz-area {
    width: 95px; height: 95px; border-radius: 12px; background: #fff; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; padding: 2px;
}
.u-card-horiz .img-horiz-area img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
.u-card-horiz .info-horiz { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
.u-card-horiz .name-horiz {
    font-size: 0.85rem; font-weight: 700; color: var(--c-p); line-height: 1.2;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 6px;
}
.u-card-horiz .row-price-action { display: flex; justify-content: space-between; align-items: center; margin-top: auto;}
.u-card-horiz .price-horiz { font-size: 1.1rem; font-weight: 900; color: var(--c-a); }
.u-card-horiz .old-price-horiz { font-size: 0.75rem; color: var(--c-t); text-decoration: line-through; margin-right: 5px; font-weight: 600;}

/* BOT√ïES E INPUTS */
.u-action-row{padding-top:8px; padding-bottom: 4px; position: relative;}
.btn-big-action{
    width:100%; background:var(--c-p); color:#fff; padding:10px 8px; border-radius:10px;
    font-weight:700; font-size:0.75rem; display:flex; align-items:center; justify-content:center; gap:4px;
    transition:background .2s, transform .1s;
}
.btn-mini-add {
    background: var(--c-p); color: #fff; width: 34px; height: 34px; border-radius: 10px;
    font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; justify-content: center;
    transition: transform 0.1s, background 0.2s;
}
.btn-mini-add:active:not(:disabled){transform:scale(0.9)}
.btn-big-action:active:not(:disabled){transform:scale(0.95)}
.success-flash{animation:flashGreen 0.5s ease-out}
.btn-big-action:disabled, .btn-mini-add:disabled { background: #cbd5e1 !important; color: var(--c-t) !important; cursor: not-allowed; box-shadow: none; transform: none; }

@keyframes flashGreen { 0% { background: var(--c-p); } 50% { background: var(--c-ok); transform: scale(1.05); } 100% { background: var(--c-p); } }

.qty-row{display:flex;align-items:center;justify-content:space-between;background:#f1f5f9;border-radius:10px;padding:3px;border:1px solid var(--c-bd); height: 34px;}
.btn-qty{width:28px;height:100%;border-radius:6px;background:#fff;font-size:1rem;font-weight:800;box-shadow:0 1px 3px rgba(0,0,0,0.1);color:var(--c-p)}
.qty-inp{
    width:28px; text-align:center; font-size:0.95rem; font-weight:800;
    border:none; background:transparent; color:var(--c-p); -moz-appearance:textfield; padding:0;
}
.qty-inp::-webkit-outer-spin-button,.qty-inp::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}

/* FAB CARRINHO FLUTUANTE OTIMIZADO */
.fab-cart {
    position: fixed; bottom: 30px; right: 20px; z-index: 100;
    height: 60px; border-radius: 30px; padding: 0 20px;
    background: var(--c-p); color: #fff;
    display: none; align-items: center; justify-content: center; gap: 12px;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.4); border: 2px solid #fff;
    cursor: pointer; transition: transform 0.2s, background 0.2s;
}
.fab-cart.blocked { background: #94a3b8; box-shadow: 0 10px 25px rgba(148, 163, 184, 0.4); }
.fab-cart:active { transform: scale(0.95); }
.fab-icon-area { position: relative; font-size: 1.5rem; display: flex; align-items:center;}
.fab-badge {
    position: absolute; top: -8px; right: -12px;
    background: var(--c-err); color: #fff; font-size: 0.75rem; font-weight: 900;
    width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    border: 2px solid #fff;
}
.fab-text-area { display: flex; flex-direction: column; align-items: flex-start; justify-content: center;}
.fab-total { font-size: 1.1rem; font-weight: 900; line-height: 1.1; }
.fab-sub { font-size: 0.65rem; font-weight: 800; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }

/* MODAIS GERAIS */
dialog{border:none;border-radius:24px;width:92%;max-width:420px;padding:0;box-shadow:0 25px 50px -12px rgba(0,0,0,0.4);background:#fff;animation:modalPop .3s}
dialog::backdrop{background:rgba(15,23,42,0.85);backdrop-filter:blur(4px)}
@keyframes modalPop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
.modal-body{padding:25px 20px;text-align:center}
.btn-modal{width:100%;padding:14px;border-radius:12px;font-weight:800;margin-bottom:10px;font-size:1rem; display:flex; align-items:center; justify-content:center; gap:8px;}
.btn-modal.primary{background:var(--c-p);color:#fff}
.btn-modal.secondary{background:#fff;border:2px solid var(--c-bd);color:var(--c-s)}

/* MODAL CHECKOUT (BOTTOM SHEET) */
#modal-checkout {
    margin: auto auto 0 auto; border-radius: 24px 24px 0 0;
    width: 100%; max-width: 600px; height: 85dvh; max-height: 85dvh;
    animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
#modal-checkout .modal-body {
    height: 100%; display: flex; flex-direction: column; padding: 25px 20px max(20px, env(safe-area-inset-bottom)); text-align: left;
}
.chk-list-area { flex: 1; overflow-y: auto; background: #f8fafc; border: 1px solid var(--c-bd); border-radius: 12px; padding: 15px; margin-bottom: 15px; }
.chk-item-simple { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 700; color: var(--c-p); padding: 8px 0; border-bottom: 1px dashed var(--c-bd); }
.chk-item-simple:last-child { border-bottom: none; }
.chk-item-qtd { color: var(--c-a); margin-right: 8px; font-weight: 900; }

/* TOAST */
#toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
.toast { padding: 12px 20px; color: #fff; border-radius: 12px; font-weight: 700; font-size: 0.9rem; box-shadow: var(--sh-float); text-align: center; animation: toastPop 0.3s ease-out; pointer-events: auto; }
@keyframes toastPop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

/* ZOOM */
#modal-image-zoom{background:transparent;box-shadow:none;width:100%;height:100%;max-width:none;max-height:none}
#modal-image-zoom .modal-body{padding:0;display:flex;align-items:center;justify-content:center;height:100vh;width:100vw;position:relative}
#zoom-img{max-width:90%;max-height:85vh;border-radius:12px;background:#fff;box-shadow:0 25px 50px rgba(0,0,0,0.5)}
.btn-close-zoom{position:absolute;top:20px;right:20px;width:44px;height:44px;background:#fff;border-radius:50%;color:var(--c-p);font-weight:800;font-size:1.2rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:2010;display:flex;align-items:center;justify-content:center;cursor:pointer;}

/* MODAL CAROUSEL (Preview Cesta) */
.modal-carousel-track { display: flex; overflow-x: auto; gap: 12px; padding: 10px 5px; scroll-snap-type: x mandatory; justify-content: flex-start; }
.modal-carousel-track::-webkit-scrollbar{height:4px;background:transparent}
.modal-card { flex: 0 0 140px; scroll-snap-align: start; border: 1px solid #eee; border-radius: 12px; padding: 8px; background: #fff; display: flex; flex-direction: column; text-align: left; }
.modal-card img { width: 100%; aspect-ratio: 1; object-fit: contain; mix-blend-mode: multiply; margin-bottom: 6px; }
.modal-card .mc-name { font-size: 0.75rem; font-weight: 700; color: var(--c-p); margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; height: 2.5em; }
.modal-card .mc-price { font-size: 0.9rem; font-weight: 800; color: var(--c-a); margin-top: auto; }
.modal-card .mc-qty { font-size: 0.75rem; font-weight: 600; color: var(--c-s); background: #f1f5f9; padding: 2px 6px; border-radius: 4px; width: fit-content; margin-top: 4px; }

</style>
</head>
<body>

<header class="app-header">
    <div class="layout-limit header-inner">
        <div class="header-brand">
            <img src="img/produtos/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" class="logo" alt="Logo" onclick="clearSearch()">
        </div>
        <div class="search-bar-area">
            <div class="search-wrapper">
                <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="search-inp" class="search-inp" placeholder="Buscar produto..." oninput="handleSearch(this.value)">
                <button class="clear-search" id="btn-clr-search" onclick="clearSearch()">‚úï</button>
            </div>
            <button class="btn-faq" onclick="$('modal-faq').showModal()">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
        </div>
    </div>
</header>

<main class="main-stage" id="scroll-stage">
    
    <div class="banner-wrapper" id="banner-area"></div>

    <div id="section-busca" class="page-section" style="display:none;">
        <div class="section-title">Resultados da Busca</div>
        <div class="grid-wrapper list-view" id="grid-busca"></div>
    </div>

    <div id="wrapper-sections">
        <div id="section-cestas" class="page-section">
            <div class="section-title">Cestas B√°sicas</div>
            <div class="grid-wrapper" id="grid-cestas"></div>
        </div>

        <div id="section-cesta-ativa" class="page-section" style="display:none; background: #f8fafc; padding: 10px 0; border-top: 1px solid var(--c-bd); border-bottom: 1px solid var(--c-bd);">
            <div class="section-title" style="color:var(--c-a); padding-bottom:5px;">Sua Cesta Personalizada</div>
            <div class="layout-limit" style="padding: 0 20px 10px; font-size:0.85rem; color:var(--c-s); font-weight:600;">Estes s√£o os itens da sua base. Role para baixo para adicionar mais itens ou modifique as quantidades abaixo:</div>
            <div class="grid-wrapper list-view" id="grid-cesta-ativa"></div>
        </div>

        <div id="section-ofertas" class="page-section">
            <div class="section-title">üî• Ofertas da Semana</div>
            <div class="grid-wrapper list-view" id="grid-ofertas"></div>
        </div>

        <div id="section-combos" class="page-section">
            <div class="section-title">üéÅ Combos Especiais</div>
            <div class="grid-wrapper" id="grid-combos"></div>
        </div>

        <div id="section-ate2" class="page-section">
            <div class="section-title">ü§ë At√© R$ 2,00</div>
            <div class="grid-wrapper list-view" id="grid-ate2"></div>
        </div>

        <div id="section-corredores" class="page-section">
            <div class="section-title">üóÇÔ∏è Corredores</div>
            <div class="chips-bar" id="chips-corredores" style="display:flex;"></div>
            <div class="grid-wrapper list-view" id="grid-corredores"></div>
        </div>
    </div>
</main>

<div class="fab-cart" id="fab-cart" onclick="openCheckout()">
    <div class="fab-icon-area">
        üõí
        <div class="fab-badge" id="badge-count">0</div>
    </div>
    <div class="fab-text-area">
        <div class="fab-total" id="fab-total">R$ 0,00</div>
        <div class="fab-sub" id="fab-sub">FINALIZAR</div>
    </div>
</div>

<div id="toast-container"></div>

<dialog id="modal-faq" onclick="if(event.target===this)this.close()">
    <div class="modal-body">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 20px; border-bottom:1px solid #eee; padding-bottom:15px">
            <img src="img/produtos/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" style="width: 80px; height: 80px; border-radius: 50%; border:1px solid #cbd5e1;" alt="Logo">
            <h3 style="font-weight:900;color:var(--c-p);text-transform:uppercase;margin:0;">Dona Ant√¥nia</h3>
            <div style="font-size: 0.85rem; color: var(--c-s); line-height: 1.4;">Cuiab√° e V√°rzea Grande - MT<br>Tel: (65) 99681-3588</div>
        </div>
        <div style="text-align: left; margin-bottom: 12px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;"><div style="font-weight: 700; color: var(--c-p); font-size: 0.9rem;">Qual o valor da entrega?</div><div style="font-size: 0.8rem; color: var(--c-s); margin-top: 4px;">A entrega √© totalmente gr√°tis para Cuiab√° e V√°rzea Grande.</div></div>
        <div style="text-align: left; margin-bottom: 12px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;"><div style="font-weight: 700; color: var(--c-p); font-size: 0.9rem;">Quais as formas de pagamento?</div><div style="font-size: 0.8rem; color: var(--c-s); margin-top: 4px;">Aceitamos PIX, Dinheiro, Cart√£o de Cr√©dito e D√©bito na entrega.</div></div>
        <div style="text-align: left; margin-bottom: 12px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;"><div style="font-weight: 700; color: var(--c-p); font-size: 0.9rem;">Qual o prazo de entrega?</div><div style="font-size: 0.8rem; color: var(--c-s); margin-top: 4px;">Entregas em at√© 24 horas √∫teis ap√≥s a confirma√ß√£o do pedido.</div></div>
        <div style="text-align: left; margin-bottom: 12px; border-bottom: 1px dashed #f1f5f9; padding-bottom: 8px;"><div style="font-weight: 700; color: var(--c-p); font-size: 0.9rem;">Posso personalizar a cesta?</div><div style="font-size: 0.8rem; color: var(--c-s); margin-top: 4px;">Sim! Voc√™ pode adicionar ou remover itens conforme sua necessidade.</div></div>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px; margin-bottom: 15px;">
            <button class="btn-modal" style="flex: 1; background:#25D366; color: #fff; padding: 10px; font-size: 0.9rem;" onclick="window.open('https://wa.me/5565996813588','_blank')">WhatsApp</button>
            <button class="btn-modal" style="flex: 1; background:#E1306C; color: #fff; padding: 10px; font-size: 0.9rem;" onclick="alert('Link do Instagram aqui')">Instagram</button>
        </div>
        <button class="btn-modal secondary" onclick="this.closest('dialog').close()">Voltar</button>
    </div>
</dialog>

<dialog id="modal-basket-preview">
    <div class="modal-body">
        <h3 style="color:var(--c-p);font-size:1.4rem; font-weight:900;" id="prev-title"></h3>
        <p style="color:var(--c-s);margin-bottom:15px; font-weight:600;" id="prev-desc"></p>
        <div style="background:#f8fafc;padding:5px;border-radius:12px;border:1px solid var(--c-bd);margin-bottom:15px">
            <div class="modal-carousel-track" id="prev-list"></div>
        </div>
        <div style="margin-top:20px">
            <div style="font-size:1.8rem;font-weight:900;color:var(--c-a);margin-bottom:15px" id="prev-price"></div>
            <button class="btn-modal primary" id="btn-confirm-preview">ENCOMENDAR CESTA PADR√ÉO</button>
            <button class="btn-modal primary" id="btn-customize-preview" style="background:var(--c-a); display:none;">PERSONALIZAR CESTA</button>
            <button class="btn-modal secondary" onclick="$('modal-basket-preview').close()">Voltar</button>
        </div>
    </div>
</dialog>

<dialog id="modal-checkout">
    <div class="modal-body">
        <h3 style="text-align:center;text-transform:uppercase;font-weight:900; margin-bottom:15px;">Seu Pedido</h3>
        
        <div class="chk-list-area" id="chk-list">
            </div>
        
        <div style="text-align:right;margin-bottom:15px">
            <div style="font-size:0.9rem; font-weight:700; color:var(--c-t);" id="chk-info-extra"></div>
            <div style="font-size:1.8rem;font-weight:900; color:var(--c-p);" id="chk-total"></div>
        </div>
        
        <div id="coupon-toggle" onclick="this.style.display='none'; $('coupon-wrap').style.display='flex';" style="color:var(--c-a); font-size:0.85rem; font-weight:800; cursor:pointer; margin-bottom:15px; text-decoration:underline;">Tem um cupom de desconto?</div>
        <div id="coupon-wrap" style="display:none; gap:5px; margin-bottom:15px">
            <input id="cupom-code" style="flex:1;padding:12px;border:1px solid var(--c-bd);border-radius:8px;text-transform:uppercase;font-weight:700;" placeholder="C√ìDIGO">
            <button onclick="applyCupom()" style="background:var(--c-p);color:#fff;padding:0 20px;border-radius:8px;font-weight:800;">OK</button>
        </div>
        <div id="cupom-msg" style="font-size:.85rem;font-weight:800;margin-bottom:15px;color:var(--c-ok);display:none"></div>
        
        <button class="btn-modal primary" id="btn-send-order" style="background:#25D366;" onclick="sendOrder()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
            ENVIAR PEDIDO NO WHATSAPP
        </button>
        <button class="btn-modal secondary" onclick="$('modal-checkout').close()">Continuar Comprando</button>
        <button class="btn-modal" style="color:var(--c-err);font-size:0.85rem;border:none;background:transparent; padding:5px; margin-top:10px;" onclick="clearCart()">Limpar Carrinho</button>
    </div>
</dialog>

<dialog id="modal-image-zoom" onclick="if(event.target===this)this.close()">
    <div class="modal-body">
        <button class="btn-close-zoom" onclick="this.closest('dialog').close()">‚úï</button>
        <img id="zoom-img" src="">
    </div>
</dialog>

<script>
const $=i=>document.getElementById(i);
const STATE={
    baskets:[], prods:[], coupons:[], combos:[], departamentos:{}, banners:[],
    cart:{}, cartOrder:[], 
    mode:'zero', 
    baseBasket:null, minBasketPrice:0, 
    basketExtraFee:0, 
    comboDiscount: 0, 
    coupon:null,
    pageLimits: {},
    activeMacro: null
};

const MIN_ORDER = 85.00; // Pedido M√≠nimo

async function init(){
    try{
        const[r1,r2,r3,r4,r5,r6]=await Promise.all([
            fetch('produtos-cesta-basica.json?v='+Date.now()),
            fetch('produtos.json?v='+Date.now()),
            fetch('cupons.json?v='+Date.now()).catch(()=>({ok:false})),
            fetch('combos.json?v='+Date.now()).catch(()=>({ok:false})),
            fetch('departamento.json?v='+Date.now()).catch(()=>({ok:false})),
            fetch('banner.json?v='+Date.now()).catch(()=>({ok:false}))
        ]);
        if(r1.ok) STATE.baskets = await r1.json();
        if(r2.ok){
            let t=(await r2.text()).trim().replace(/,(\s+)?$/,"");
            let raw = JSON.parse(t.startsWith('[')?t:'['+t+']');
            STATE.prods = raw.filter(x=>x.situacao==="A").map(p=>({
                id:String(p.id), code:String(p.codigo||p.id),
                name:p.nome, price:parseFloat(p.preco),
                oldPrice: p.preco_antigo ? parseFloat(p.preco_antigo) : null,
                stock:parseInt(p.estoque)||0,
                cat:(p.categoria||p.Categoria||"Outros").trim(),
                img:`img/produtos/${p.codigo||p.id}.webp`
            }));
        }
        if(r3&&r3.ok) STATE.coupons = await r3.json();
        if(r4&&r4.ok) STATE.combos = await r4.json();
        if(r5&&r5.ok) STATE.departamentos = await r5.json();
        if(r6&&r6.ok) STATE.banners = await r6.json();

        renderBanners();
        renderHome();
        updateTotals(); 
    }catch(e){
        $('scroll-stage').innerHTML='<p style="padding:20px;text-align:center;color:red;font-weight:bold;">Erro fatal na leitura dos arquivos.</p>';
        console.error("ERRO", e);
    }
}

/* --- RENDERIZA√á√ÉO P√ÅGINA √öNICA E PAGINA√á√ÉO --- */
function renderHome() {
    // 1. Cestas
    $('grid-cestas').innerHTML = STATE.baskets.map(cardBasket).join('') || '<p>Nenhuma cesta.</p>';
    
    // 2. Ofertas
    const ofertas = STATE.prods.filter(p => p.oldPrice && p.oldPrice > p.price);
    if(ofertas.length > 0) {
        $('grid-ofertas').innerHTML = ofertas.map(cardProdHoriz).join('');
    } else {
        $('section-ofertas').style.display = 'none';
    }

    // 3. Combos
    if(STATE.combos && STATE.combos.length > 0) {
        $('grid-combos').innerHTML = STATE.combos.map(cardCombo).join('');
    } else {
        $('section-combos').style.display = 'none';
    }

    // 4. At√© 2 Reais (Paginado)
    const ate2 = STATE.prods.filter(p => p.price <= 2.00);
    if(ate2.length > 0) {
        renderPaginated('grid-ate2', 'ate2', ate2, 10);
    } else {
        $('section-ate2').style.display = 'none';
    }

    // 5. Corredores (Macros) - Inicializa no Primeiro Macro e n√£o em "Tudo"
    let macros = Object.keys(STATE.departamentos).sort();
    let chipsHtml = '';
    macros.forEach(m => {
        chipsHtml += `<div class="chip" id="chip-${m.replace(/\s/g,'-')}" onclick="loadCorredor('${m.replace(/'/g,"\\'")}')">${m}</div>`;
    });
    $('chips-corredores').innerHTML = chipsHtml;
    
    if(macros.length > 0) {
        loadCorredor(macros[0]);
    } else {
        $('section-corredores').style.display = 'none';
    }
}

function loadCorredor(macro) {
    STATE.activeMacro = macro;
    STATE.pageLimits['corredores'] = 10; // Reseta limite a cada troca
    document.querySelectorAll('#chips-corredores .chip').forEach(el=>el.classList.remove('active'));
    let c = document.getElementById(`chip-${macro.replace(/\s/g,'-')}`);
    if(c) {
        c.classList.add('active');
        c.scrollIntoView({behavior: 'smooth', block: 'nearest', inline: 'center'});
    }

    let cats = STATE.departamentos[macro] || [];
    let list = STATE.prods.filter(p => cats.includes(p.cat));
    list.sort((a,b)=>a.name.localeCompare(b.name)); // Ordem A-Z
    
    renderPaginated('grid-corredores', 'corredores', list, 10);
}

function renderPaginated(containerId, listKey, list, step = 10) {
    if(!STATE.pageLimits[listKey]) STATE.pageLimits[listKey] = step;
    let limit = STATE.pageLimits[listKey];
    let visibleList = list.slice(0, limit);
    
    let html = visibleList.map(cardProdHoriz).join('');
    if(limit < list.length) {
        html += `<div style="grid-column: 1/-1; padding: 10px 0;"><button class="btn-big-action" style="background:transparent; color:var(--c-p); border:2px solid var(--c-bd);" onclick="loadMore('${containerId}', '${listKey}', ${step})">MOSTRAR MAIS PRODUTOS ‚¨á</button></div>`;
    }
    $(containerId).innerHTML = html || '<p style="padding:20px; color:var(--c-t); font-weight:600;">Nenhum produto encontrado.</p>';
}

window.loadMore = function(containerId, listKey, step) {
    STATE.pageLimits[listKey] += step;
    if(listKey === 'ate2') {
        renderPaginated(containerId, listKey, STATE.prods.filter(p => p.price <= 2.00), step);
    } else if (listKey === 'corredores') {
        let macro = STATE.activeMacro;
        let cats = STATE.departamentos[macro] || [];
        let list = STATE.prods.filter(p => cats.includes(p.cat)).sort((a,b)=>a.name.localeCompare(b.name));
        renderPaginated(containerId, listKey, list, step);
    }
}

function renderCestaAtiva() {
    if(STATE.mode === 'custom' && STATE.cartOrder.length > 0) {
        $('section-cesta-ativa').style.display = 'block';
        let list = STATE.cartOrder.map(id => STATE.prods.find(p => p.id === id)).filter(Boolean);
        $('grid-cesta-ativa').innerHTML = list.map(cardProdHoriz).join('');
    } else {
        $('section-cesta-ativa').style.display = 'none';
    }
}

/* --- BANNERS --- */
function renderBanners() {
    const wrap = $('banner-area');
    if (!STATE.banners || STATE.banners.length === 0) return;
    wrap.style.display = 'flex';
    wrap.innerHTML = STATE.banners.map(b => `
        <div class="banner-card" style="background:${b.corFundo}; color:${b.corTexto}">
            <div class="banner-title">${b.titulo}</div>
            <div class="banner-sub">${b.subtitulo}</div>
        </div>
    `).join('');
}

/* --- CARDS (COMPACTOS E GRANDES) --- */
function cardBasket(item){
    return `
    <div class="u-card">
        <div class="u-img-area"><img src="${item.imagem}" class="u-img u-img-cesta" loading="lazy"></div>
        <div class="u-info">
            <div class="u-name">${formatName(item.nome)}</div>
            <div class="u-price">${fmt(item.preco)}</div>
            <div class="u-action-row">
                <button class="btn-big-action" onclick="previewBasket('${item.id}')">VER ITENS</button>
            </div>
        </div>
    </div>`;
}

function cardCombo(item){
    let sum = 0;
    item.produtos.forEach(s => {
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x => x.id === ref.trim() || x.code === ref.trim());
        if (p) sum += p.price * parseInt(qStr);
    });
    const econ = sum - item.preco;
    return `
    <div class="u-card">
        <div class="u-img-area">
            <img src="${item.imagem || 'img/produtos/cesta.webp'}" class="u-img u-img-cesta" loading="lazy">
            <div class="offer-tag" style="background:var(--c-ok)">üî• COMBO</div>
        </div>
        <div class="u-info">
            <div class="u-name">${formatName(item.nome)}</div>
            <div style="margin-top:auto">
                <div class="combo-strike">De: ${fmt(sum)}</div>
                <div class="u-price">Por: ${fmt(item.preco)}</div>
                ${econ > 0 ? `<div class="combo-save">Economia: ${fmt(econ)}</div>` : ''}
            </div>
            <div class="u-action-row">
                <button class="btn-big-action" onclick="previewCombo('${item.id}')">VER ITENS</button>
            </div>
        </div>
    </div>`;
}

function cardProdHoriz(item){
    const q = STATE.cart[item.id] || 0;
    const isOffer = item.oldPrice && item.oldPrice > item.price;
    
    let priceHtml = isOffer 
        ? `<span class="old-price-horiz">${fmt(item.oldPrice)}</span><span class="price-horiz">${fmt(item.price)}</span>`
        : `<span class="price-horiz">${fmt(item.price)}</span>`;
    
    const btn = q > 0 
        ? `<div class="qty-row" style="flex-shrink:0;">
             <button class="btn-qty" onclick="upd('${item.id}',-1)">-</button>
             <input class="qty-inp qty-${item.id}" type="number" value="${q}" onchange="upd('${item.id}',this.value-${q})">
             <button class="btn-qty" onclick="upd('${item.id}',1)" style="color:var(--c-ok)">+</button>
           </div>`
        : `<button class="btn-mini-add" id="btn-add-${item.id}" onclick="addAnim('${item.id}');upd('${item.id}',1)" ${item.stock<=0?'disabled':''}>${item.stock<=0?'X':'+'}</button>`;
    
    return `
    <div class="u-card-horiz">
        <div class="img-horiz-area" onclick="openImageZoom('${item.img}')">
            <img src="${item.img}" loading="lazy">
        </div>
        <div class="info-horiz">
            <div class="name-horiz">${formatName(item.name)}</div>
            <div class="row-price-action">
                <div>${priceHtml}</div>
                <div class="ctrl-wrap-${item.id}">${btn}</div>
            </div>
        </div>
    </div>`;
}

function addAnim(id){
    if(navigator.vibrate) navigator.vibrate(50);
    const btn = document.getElementById(`btn-add-${id}`);
    if(btn){
        btn.classList.add('success-flash');
        setTimeout(()=>btn.classList.remove('success-flash'), 400);
    }
}

/* PREVIEWS */
function previewBasket(id){
    const c = STATE.baskets.find(x=>String(x.id)===String(id));
    if(!c) return;
    STATE.tempBasket = c;
    $('prev-title').innerHTML = formatName(c.nome);
    $('prev-desc').innerHTML = `${c.produtos.length} itens inclusos`;
    $('prev-price').innerHTML = fmt(c.preco);
    $('prev-list').innerHTML = c.produtos.map(s=>{
        const [qtd, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        return `<div class="modal-card"><img src="${p?.img}" loading="lazy"><div class="mc-name">${p?formatName(p.name):ref}</div><div class="mc-qty">${qtd}x</div></div>`
    }).join('');
    
    const btn = $('btn-confirm-preview');
    btn.innerText = "ENCOMENDAR CESTA PADR√ÉO";
    btn.onclick = () => { confirmBasket(false); openCheckout(); };
    
    const btnCust = $('btn-customize-preview');
    btnCust.style.display = 'block';
    btnCust.onclick = () => confirmBasket(true);
    
    $('modal-basket-preview').showModal();
}

function previewCombo(id){
    const c = STATE.combos.find(x=>String(x.id)===String(id));
    if(!c) return;
    
    let sum = 0;
    $('prev-title').innerHTML = formatName(c.nome);
    $('prev-list').innerHTML = c.produtos.map(s=>{
        const [qtd, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p) sum += p.price * parseInt(qtd);
        return `<div class="modal-card"><img src="${p?.img}" loading="lazy"><div class="mc-name">${p?formatName(p.name):ref}</div><div class="mc-qty">${qtd}x</div></div>`
    }).join('');
    
    const econ = sum - c.preco;
    $('prev-desc').innerHTML = `<span class="combo-strike">De: ${fmt(sum)}</span> | <span style="color:var(--c-ok);">Economia: ${fmt(econ)}</span>`;
    $('prev-price').innerHTML = fmt(c.preco);
    
    const btn = $('btn-confirm-preview');
    btn.innerText = "ADICIONAR COMBO";
    btn.onclick = () => confirmCombo(id);
    $('btn-customize-preview').style.display = 'none';
    
    $('modal-basket-preview').showModal();
}

/* CONFIRMA√á√ïES */
function confirmBasket(isCustom){
    const c = STATE.tempBasket;
    STATE.mode = 'custom';
    STATE.baseBasket = c;
    STATE.minBasketPrice = c.preco; 
    STATE.cart = {}; STATE.cartOrder = [];
    
    let itemsSum = 0;
    c.produtos.forEach(s=>{
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p){
            let q = Math.min(parseInt(qStr), p.stock);
            if(q > 0) { STATE.cart[p.id] = q; STATE.cartOrder.push(p.id); itemsSum += (p.price * q); }
        }
    });

    STATE.basketExtraFee = STATE.minBasketPrice - itemsSum;
    $('modal-basket-preview').close();
    
    if(isCustom) {
        showToast(`Cesta carregada para personaliza√ß√£o!`, 's');
        renderCestaAtiva();
        setTimeout(()=> { $('section-cesta-ativa').scrollIntoView({behavior:'smooth', block:'start'}); }, 300);
    } else {
        showToast(`Cesta adicionada!`, 's');
    }
    updateTotals();
}

function confirmCombo(id){
    const c = STATE.combos.find(x=>String(x.id)===String(id));
    if(!c) return;
    
    let canAdd = true;
    c.produtos.forEach(s=>{
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p){ if((STATE.cart[p.id] || 0) + parseInt(qStr) > p.stock) canAdd = false; }
    });

    if(!canAdd) return showToast(`Estoque insuficiente para este combo.`, "r");
    
    c.produtos.forEach(s=>{
        const [qStr, ref] = s.split('x');
        const p = STATE.prods.find(x=>x.id===ref.trim()||x.code===ref.trim());
        if(p){
            const q = parseInt(qStr);
            const cur = STATE.cart[p.id] || 0;
            if(cur === 0) STATE.cartOrder.push(p.id);
            STATE.cart[p.id] = cur + q;
        }
    });
    
    $('modal-basket-preview').close();
    showToast(`Combo adicionado!`, 's');
    updateTotals();
}

/* UPDATE CARRINHO */
function upd(id, delta){
    const p = STATE.prods.find(x=>x.id===id);
    if(!p) return;
    const cur = STATE.cart[id] || 0;
    
    let next = Math.max(0, cur + parseInt(delta));
    if(isNaN(next)) next = 0;
    
    if(next > p.stock) {
        showToast(`Apenas ${p.stock} un. dispon√≠veis`, "r");
        document.querySelectorAll(`.qty-${id}`).forEach(e=>e.value = cur);
        return;
    }
    
    if(cur === 0 && next > 0) STATE.cartOrder.push(id);
    STATE.cart[id] = next;
    if(next === 0){
        delete STATE.cart[id];
        STATE.cartOrder = STATE.cartOrder.filter(x=>x!==id);
        // Remove from active basket view if zero
        if($('section-cesta-ativa').style.display === 'block') renderCestaAtiva();
    }
    
    document.querySelectorAll(`.qty-${id}`).forEach(e=>e.value = next);
    
    if((cur===0 && next>0) || (cur>0 && next===0)){
        const btnHtml = next > 0 
             ? `<div class="qty-row" style="flex-shrink:0;"><button class="btn-qty" onclick="upd('${id}',-1)">-</button><input class="qty-inp qty-${id}" type="number" value="${next}" onchange="upd('${id}',this.value-${next})"><button class="btn-qty" onclick="upd('${id}',1)" style="color:var(--c-ok)">+</button></div>`
             : `<button class="btn-mini-add" id="btn-add-${id}" onclick="addAnim('${id}');upd('${id}',1)">+</button>`;
        document.querySelectorAll(`.ctrl-wrap-${id}`).forEach(el=> el.innerHTML = btnHtml);
    }
    updateTotals();
}

function updateTotals(){
    let sumItems = 0, count = 0;
    Object.entries(STATE.cart).forEach(([id,q])=>{
        const p = STATE.prods.find(x=>x.id===id);
        if(p){ sumItems += p.price * q; count += q; }
    });

    STATE.comboDiscount = 0;
    let tempCart = { ...STATE.cart };
    
    if (STATE.combos && STATE.combos.length > 0) {
        STATE.combos.forEach(c => {
            let possibleTimes = 9999;
            let comboSomaProd = 0;
            let reqs = [];
            c.produtos.forEach(s => {
                const parts = s.split('x');
                if (parts.length === 2) {
                    const q = parseInt(parts[0]);
                    const ref = parts[1].trim();
                    const p = STATE.prods.find(x => x.id === ref || x.code === ref);
                    if (p) { reqs.push({ id: p.id, q: q }); comboSomaProd += p.price * q; }
                }
            });
            if (reqs.length === 0) possibleTimes = 0;
            reqs.forEach(r => { let inCart = tempCart[r.id] || 0; possibleTimes = Math.min(possibleTimes, Math.floor(inCart / r.q)); });
            if (possibleTimes > 0) {
                reqs.forEach(r => tempCart[r.id] -= (r.q * possibleTimes));
                let discountPerCombo = comboSomaProd - c.preco;
                if (discountPerCombo > 0) STATE.comboDiscount += discountPerCombo * possibleTimes;
            }
        });
    }

    let displayTotal = sumItems - STATE.comboDiscount;
    let extraInfo = "";
    
    let isBlocked = false;
    let missing = 0;
    let subText = "FINALIZAR";
    
    if(STATE.mode === 'custom' && STATE.minBasketPrice > 0){
        displayTotal += STATE.basketExtraFee;
        if(displayTotal < STATE.minBasketPrice){
            const credit = STATE.minBasketPrice - displayTotal;
            displayTotal = STATE.minBasketPrice; 
            extraInfo = `<span style="color:var(--c-a);">Aproveite ${fmt(credit)} em itens extras</span>`;
            isBlocked = true;
            subText = `USE O CR√âDITO`;
        } else {
            subText = "PEDIDO LIBERADO";
        }
    } else {
        missing = Math.max(0, MIN_ORDER - displayTotal);
        if(missing > 0) {
            isBlocked = true;
            subText = `FALTAM ${fmt(missing)}`;
        } else {
            subText = "PEDIDO LIBERADO";
        }
    }

    if(STATE.coupon){
        if(displayTotal >= STATE.coupon.minimo) displayTotal -= STATE.coupon.desconto;
        else { STATE.coupon=null; showToast("Cupom removido", "r"); $('cupom-msg').style.display='none';}
    }

    // UPDATE UI FAB
    const badge = $('badge-count');
    badge.innerText = count;
    $('fab-cart').style.display = count > 0 ? 'flex' : 'none';
    
    $('fab-total').innerText = fmt(displayTotal);
    $('fab-sub').innerText = subText;
    if(isBlocked) $('fab-cart').classList.add('blocked');
    else $('fab-cart').classList.remove('blocked');

    // UPDATE CHECKOUT
    $('chk-total').innerText = fmt(displayTotal);
    $('chk-info-extra').innerHTML = extraInfo;
    
    let btnChk = $('btn-send-order');
    if(btnChk) {
        if(isBlocked) {
            btnChk.disabled = true;
            btnChk.innerHTML = STATE.mode === 'custom' && displayTotal <= STATE.minBasketPrice ? `ADICIONE MAIS ITENS` : `FALTAM ${fmt(missing)} PARA FINALIZAR`;
            btnChk.style.background = '#94a3b8';
        } else {
            btnChk.disabled = false;
            btnChk.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right:8px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg> ENVIAR PEDIDO NO WHATSAPP`;
            btnChk.style.background = '#25D366';
        }
    }
}

function openCheckout(){
    if(STATE.cartOrder.length === 0) return showToast("Seu carrinho est√° vazio!", "r");
    
    let listHtml = STATE.cartOrder.map(id=>{
        const p = STATE.prods.find(x=>x.id===id);
        return `<div class="chk-item-simple"><span class="chk-item-qtd">${STATE.cart[id]}x</span><span>${formatName(p.name)}</span></div>`
    }).join('');
    
    if(STATE.comboDiscount > 0){
        listHtml += `<div class="chk-item-simple" style="color:var(--c-ok);"><span>üéÅ Desconto Combo</span></div>`;
    }

    $('chk-list').innerHTML = listHtml;
    $('modal-checkout').showModal();
}

/* UTILS */
function clearCart(){ if(confirm("Esvaziar carrinho?")){STATE.cart={};STATE.cartOrder=[];STATE.mode='zero';STATE.minBasketPrice=0;STATE.basketExtraFee=0;STATE.comboDiscount=0;STATE.coupon=null; updateTotals(); $('section-cesta-ativa').style.display='none'; $('modal-checkout').close(); window.scrollTo(0,0); }}

function handleSearch(q){
    const btn=$('btn-clr-search'); btn.style.display=q?'flex':'none';
    if(!q) {
        $('wrapper-sections').style.display = 'block';
        $('section-busca').style.display = 'none';
        return;
    }
    
    $('wrapper-sections').style.display = 'none';
    $('section-busca').style.display = 'block';
    
    let res = STATE.prods.filter(p=>p.name.toUpperCase().includes(q.toUpperCase()));
    $('grid-busca').innerHTML = res.map(cardProdHoriz).join('') || '<p style="padding:20px;">Nenhum produto encontrado.</p>';
}
function clearSearch(){$('search-inp').value='';handleSearch('');}

function applyCupom(){
    const c=STATE.coupons.find(x=>x.codigo===$('cupom-code').value.toUpperCase().trim());
    const tot=parseMoney($('chk-total').innerText);
    
    if(c && tot>=c.minimo){ STATE.coupon=c; updateTotals(); $('cupom-msg').innerText="CUPOM APLICADO!"; $('cupom-msg').style.display='block'; }
    else showToast("Cupom inv√°lido ou m√≠nimo n√£o atingido", "r");
}

async function sendOrder(){
    if($('btn-send-order').disabled) return;
    
    let itemsTxt="", apiItens=[]; let totalBruto=0;
    
    Object.entries(STATE.cart).forEach(([id,q])=>{
        const p=STATE.prods.find(x=>x.id===id);
        if(p){ totalBruto+=p.price*q; itemsTxt+=`${q}x ${p.name}\n`; apiItens.push({id:p.id,nome:p.name,qtd:q,price:p.price}); }
    });

    let final = totalBruto - STATE.comboDiscount;
    
    if(STATE.mode === 'custom' && STATE.minBasketPrice > 0){
        final = Math.max(final + STATE.basketExtraFee, STATE.minBasketPrice);
    }

    if(STATE.coupon){ final-=STATE.coupon.desconto; itemsTxt+=`\nCUPOM: ${STATE.coupon.codigo}`; }
    
    const msg = `*NOVO PEDIDO*\n\n*ITENS:*\n${itemsTxt}\n\n*TOTAL: ${fmt(final)}*`;
    
    try{
        fetch("https://hook.eu1.make.com/yisqs4w309ogi6fx4969dbsr2q7fu7il", {
            method:"POST", headers:{"Content-Type":"application/json"},
            body:JSON.stringify({
                cliente:{nome: "Cliente Recorrente"},
                pedido:{
                    itens:apiItens,
                    total:final,
                    outras_despesas: (STATE.mode === 'custom' ? STATE.basketExtraFee : 0) 
                }
            })
        });
    }catch(e){}
    window.location.href=`https://wa.me/5565996813588?text=${encodeURIComponent(msg)}`;
}

function formatName(s){ return s?s.replace(/\s+/g,' ').trim().toLowerCase().split(' ').map(w=>w.length<=3?w:w[0].toUpperCase()+w.slice(1)).join(' '):''; }
function parseMoney(s){return parseFloat(s.replace('R$','').replace('.','').replace(',','.').trim());}
function fmt(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function showToast(m,t){const d=document.createElement('div');d.className='toast';d.style.background=t==='r'?'var(--c-err)':'var(--c-ok)';d.innerText=m;$('toast-container').appendChild(d);setTimeout(()=>d.remove(),2500);}
function openImageZoom(s){$('zoom-img').src=s;$('modal-image-zoom').showModal();}

init();
</script>
</body>
</html>
