<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
<meta name="description" content="Super Cestas B√°sicas Dona Ant√¥nia - Qualidade e pre√ßo justo.">
<meta name="geo.region" content="BR-MT"><meta name="geo.placename" content="Cuiab√°"><meta name="theme-color" content="#ffffff">
<title>Super Cestas B√°sicas Dona Ant√¥nia</title>
<style>
:root {
    --c-p: #0f172a; --c-s: #334155; --c-t: #64748b; --c-a: #ea580c; --c-ok: #15803d; --c-err: #b91c1c;
    --c-bg: #f1f5f9; --c-surf: #ffffff; --c-bd: #cbd5e1; --font: 'Inter', system-ui, sans-serif;
    --rad: 12px; --pill: 50px; --sh-sm: 0 1px 3px rgba(0,0,0,0.1); 
    --sh-fl: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;outline:none}
body{font-family:var(--font);background:var(--c-bg);color:var(--c-p);margin:0;padding-bottom:280px;font-size:15px;line-height:1.5;min-height:100vh;-webkit-font-smoothing:antialiased}
.limit-container{max-width:1200px;margin:0 auto;width:100%}
h1,h2,h3,h4{margin:0;font-weight:800;color:var(--c-p);letter-spacing:-.02em}
button{cursor:pointer;border:none;background:0 0;font-family:inherit;font-weight:600;padding:0}

/* HEADER */
.header-wrapper{position:sticky;top:0;z-index:1000;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);border-bottom:1px solid var(--c-bd);transition:transform .4s cubic-bezier(.16,1,.3,1);box-shadow:var(--sh-sm)}
.header-wrapper.hidden{transform:translateY(-100%)}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;min-height:60px}
.header-left,.header-actions{display:flex;align-items:center;gap:12px}
.header-actions{gap:8px}
.logo{width:38px;height:38px;border-radius:50%;object-fit:cover;border:1px solid var(--c-bd)}
.page-title{font-size:.95rem;font-weight:800;line-height:1.1;color:var(--c-p)}
.btn-header-icon{width:38px;height:38px;border-radius:50%;background:#f8fafc;color:var(--c-s);border:1px solid var(--c-bd);display:flex;align-items:center;justify-content:center;transition:.2s}
.btn-header-icon:hover{background:var(--c-bd);color:var(--c-p)}
.whatsapp{background:#dcfce7;color:#15803d;border-color:#bbf7d0}

/* BOTTOM PANEL (STORIES + SEARCH) */
.bottom-panel {
    position: fixed; bottom: 70px; left: 0; width: 100%; 
    background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
    z-index: 999; border-top: 1px solid var(--c-bd);
    padding: 10px 0 10px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
}

/* STORIES CAROUSEL */
.stories-track {
    display: flex; gap: 12px; overflow-x: auto; padding: 5px 15px 10px;
    -webkit-overflow-scrolling: touch; scrollbar-width: none;
}
.stories-track::-webkit-scrollbar { display: none; }

.story-item {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    cursor: pointer; flex-shrink: 0; width: 64px;
}
.story-circle {
    width: 60px; height: 60px; border-radius: 50%;
    border: 2px solid var(--c-bd); padding: 2px;
    background: #fff; transition: 0.2s;
    overflow: hidden; display: flex; align-items: center; justify-content: center;
}
.story-img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
    background: #f1f5f9;
}
.story-item.active .story-circle {
    border-color: var(--c-a);
    box-shadow: 0 0 0 2px rgba(234,88,12,0.2);
}
.story-name {
    font-size: 0.65rem; color: var(--c-s); font-weight: 700;
    text-align: center; line-height: 1.1;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    max-width: 100%;
}
.story-item.active .story-name { color: var(--c-a); }

/* SEARCH COMPACT */
.search-row { padding: 5px 15px 0; }
.search-box{width:100%;padding:10px 14px 10px 40px;border:1px solid var(--c-bd);border-radius:var(--rad);background:#f8fafc url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E") no-repeat 12px center;font-size:.9rem;color:var(--c-p);box-shadow:inset 0 1px 2px rgba(0,0,0,0.05);transition:.2s}
.search-box:focus{border-color:var(--c-a);background:#fff;box-shadow:0 0 0 2px rgba(234,88,12,0.15)}
.btn-clear-search{position:absolute;right:25px;bottom:18px;color:var(--c-s);padding:5px;display:none;z-index:1010}

/* LAYOUT & CARDS */
.hero-section{padding:10px 20px} .hero-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.hero-banner-mini{background:#fff;padding:12px;border-radius:var(--rad);border:1px solid var(--c-bd);font-size:.75rem;color:var(--c-s);box-shadow:var(--sh-sm);display:flex;flex-direction:column;justify-content:center}
.hero-banner-mini strong{font-size:.9rem;color:var(--c-p);display:block;margin-bottom:2px}

.section-header{padding:10px 20px 5px;display:flex;justify-content:space-between;align-items:baseline}
.section-title{font-size:1.1rem;font-weight:900;color:var(--c-p);text-transform:uppercase} 
.section-subtitle{font-size:.75rem;color:var(--c-s);font-weight:600}

.carousel-container{margin-bottom:10px;position:relative}
.carousel-container::after{content:'';position:absolute;right:0;top:0;bottom:0;width:30px;background:linear-gradient(to right,transparent,var(--c-bg));pointer-events:none;z-index:5}
.basket-area-carousel::after{background:linear-gradient(to right,transparent,#fff)!important}
.carousel-track{display:flex;overflow-x:auto;padding:0 20px 15px;gap:12px;-webkit-overflow-scrolling:touch}
.carousel-track::-webkit-scrollbar{display:none}
.carousel-arrow{position:absolute;top:50%;transform:translateY(-50%);width:36px;height:36px;border-radius:50%;background:#fff;border:1px solid var(--c-bd);box-shadow:var(--sh-fl);z-index:10;display:none;align-items:center;justify-content:center;font-size:1rem;color:var(--c-p);cursor:pointer}
.arrow-left{left:10px} .arrow-right{right:10px} @media(hover:hover){.carousel-arrow{display:flex}}

.prod-card,.basket-item-card,.cesta-mini-card{background:#fff;border-radius:var(--rad);padding:10px;display:flex;flex-direction:column;box-shadow:0 2px 4px rgba(0,0,0,0.05);position:relative;border:1px solid #e2e8f0;content-visibility:auto}
.prod-card{flex:0 0 231px; min-width: 231px;} 
.basket-item-card{flex:0 0 130px;padding:8px;border:1px solid var(--c-bd)}
.cesta-mini-card{flex:0 0 260px;padding:0;overflow:hidden;box-shadow:var(--sh-sm);transition:transform .2s;border:none}
.cesta-mini-card:active{transform:scale(.98)}
.cesta-mini-img{width:100%;aspect-ratio:1;object-fit:cover;background:#e2e8f0}
.cesta-mini-content{padding:14px;display:flex;flex-direction:column;gap:6px}
.cesta-mini-name{font-weight:800;color:var(--c-p);font-size:1rem}
.cesta-mini-price{font-weight:900;color:var(--c-a);font-size:1.1rem}
.btn-cesta-select{width:100%;background:var(--c-p);color:#fff;padding:8px;border-radius:8px;font-size:.85rem;font-weight:700}

.prod-img{width:100%;aspect-ratio:1;object-fit:contain;margin-bottom:8px;mix-blend-mode:multiply}
.prod-validity{font-size:.7rem;color:var(--c-s);font-weight:600;margin-bottom:4px;background:#f1f5f9;padding:2px 6px;border-radius:4px;width:fit-content}
.prod-name{font-size:.85rem;line-height:1.3;height:3.9em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;color:var(--c-p);margin-bottom:8px;font-weight:600}
.basket-item-card .prod-name{height:2.8em;-webkit-line-clamp:2;font-size:.75rem}
.prod-price{font-size:1.05rem;font-weight:800;color:var(--c-a);margin-top:auto}

.qty-control{display:flex;justify-content:space-between;align-items:center;background:#f8fafc;border-radius:8px;margin-top:8px;padding:2px;height:32px;border:1px solid var(--c-bd)}
.btn-q{width:28px;height:28px;border-radius:6px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 1px 2px rgba(0,0,0,0.1);font-weight:700;color:var(--c-p)}
.val-q{font-weight:700;font-size:.9rem;width:24px;text-align:center;color:var(--c-p)}
.btn-add-big{margin-top:8px;width:100%;height:32px;background:#fff;color:var(--c-s);border-radius:8px;font-size:1.4rem;display:flex;align-items:center;justify-content:center;border:1px solid var(--c-bd);transition:0.1s}
.btn-add-big:active,.btn-add-big:hover{background:var(--c-p);color:#fff;border-color:var(--c-p)}

[class^="ctl-wrapper-"] { min-height: 40px; display: block; }
.prod-card.featured { border: 2px solid var(--c-a); background: #fff7ed; }
.prod-card.sold-out { opacity: 0.7; }
.btn-show-more { width: calc(100% - 40px); padding: 12px; margin: 10px 20px 40px; background: #fff; border: 1px solid var(--c-bd); border-radius: 10px; color: var(--c-p); font-weight: 700; font-size: 0.9rem; cursor: pointer; box-shadow: var(--sh-sm); }
.btn-show-more:hover { background: #f8fafc; border-color: var(--c-p); }

#selected-basket-area{margin:15px 20px;background:#fff;border-radius:var(--rad);box-shadow:var(--sh-fl);animation:fadeIn .3s;border:1px solid var(--c-bd)}
.basket-intro-msg{padding:12px;text-align:center;background:#f0fdf4;color:#15803d;font-size:.85rem;border-bottom:1px dashed #bbf7d0;font-weight:600}
.basket-counter{text-align:center;font-size:.75rem;color:var(--c-s);background:#f1f5f9;padding:4px 12px;border-radius:20px;margin:0 auto 8px;width:fit-content;border:1px solid var(--c-bd);font-weight:700}

.checkout-bar{position:fixed;bottom:0;left:0;width:100%;background:rgba(255,255,255,0.98);backdrop-filter:blur(10px);padding:10px 16px 15px;z-index:1001;border-top:1px solid var(--c-bd);box-shadow:0 -4px 20px rgba(0,0,0,0.08);display:flex;align-items:center;gap:12px}
.checkout-info{display:flex;flex-direction:column}
.checkout-label{font-size:.7rem;color:var(--c-s);text-transform:uppercase;font-weight:800;letter-spacing:0.5px}
.checkout-total{font-size:1.2rem;font-weight:900;letter-spacing:-.5px;color:var(--c-p)}
.btn-main-action{flex-grow:1;padding:12px;border-radius:12px;max-width:200px;background:#16a34a;color:#fff;font-weight:800;font-size:1rem;box-shadow:0 4px 12px rgba(22,163,74,0.3);display:flex;align-items:center;justify-content:center;gap:6px;border:1px solid #15803d}
.btn-trash{width:40px;height:40px;border-radius:50%;background:#fef2f2;color:var(--c-err);border:1px solid #fecaca;display:flex;align-items:center;justify-content:center;flex-shrink:0}

#toast-container{position:fixed;top:80px;left:50%;transform:translateX(-50%);z-index:2000;display:flex;flex-direction:column;gap:10px;width:90%;max-width:400px;pointer-events:none}
.toast{background:var(--c-p);color:#fff;padding:12px 24px;border-radius:50px;box-shadow:0 10px 30px rgba(0,0,0,0.3);font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:10px;justify-content:center;animation:slideInTop .4s}
@keyframes slideInTop{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

dialog{border:none;border-radius:24px;width:92%;max-width:420px;padding:0;box-shadow:0 25px 50px -12px rgba(0,0,0,0.4);background:#fff;animation:modalPop .3s}
@keyframes modalPop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
dialog::backdrop{background:rgba(15,23,42,0.75);backdrop-filter:blur(4px)}
.modal-body{padding:30px 20px;text-align:center}
.modal-title{font-size:1.3rem;margin-bottom:4px;text-transform:uppercase;font-weight:900;color:var(--c-p)}
.btn-modal{width:100%;padding:14px;border-radius:12px;font-weight:800;margin-bottom:12px;font-size:1rem;cursor:pointer}
.btn-modal.primary{background:var(--c-ok);color:#fff;box-shadow:0 4px 12px rgba(21,128,61,0.25);border:1px solid transparent}
.btn-modal.secondary{background:#fff;border:2px solid var(--c-bd);color:var(--c-s)}
.coupon-box{display:flex;gap:8px;margin-bottom:15px} .coupon-input{flex-grow:1;padding:12px;border:1px solid var(--c-bd);border-radius:8px;text-transform:uppercase;font-weight:700;color:var(--c-p)}
.coupon-btn{padding:0 18px;background:var(--c-p);color:#fff;border-radius:8px;font-weight:700;font-size:.85rem}

#modal-image-zoom{background:0 0;box-shadow:none;width:100%;height:100%;max-width:100%}
#modal-image-zoom .modal-body{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;padding:20px;background:0 0;position:relative;}
#zoom-img{max-width:95vw;max-height:80vh;border-radius:12px;background:#fff;box-shadow:0 20px 50px #00000080}
.btn-close-zoom {position:absolute; top:20px; right:20px; background:white; border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center; font-weight:800; color:var(--c-p); box-shadow:var(--sh-fl); z-index:2000; cursor: pointer;}

@media(min-width:900px){
    .bottom-panel { width: 50%; left: 50%; transform: translateX(-50%); border-radius: 20px 20px 0 0; bottom: 80px; }
    .checkout-bar{max-width:900px;width:95%;left:50%;transform:translateX(-50%);border-radius:20px;bottom:20px;padding:15px 30px;justify-content:space-between;gap:20px;border:1px solid var(--c-bd)}
    .checkout-info{flex-direction:row;align-items:center;gap:20px}
    .btn-main-action{max-width:300px}
    .prod-card{flex:0 0 286px} 
}
</style>
</head>
<body>
<div class="header-wrapper">
    <header class="limit-container">
        <div class="header-left">
            <img src="img/produtos/logo-super-cesta-basica-dona-antonia-cuiaba-varzea-grande.avif" class="logo" alt="Logo">
            <div class="page-title">Super Cestas<br>Dona Ant√¥nia</div>
        </div>
        <div class="header-actions">
            <button class="btn-header-icon" onclick="$('modal-faq').showModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
            </button>
            <a href="https://wa.me/5565996813588" target="_blank" class="btn-header-icon whatsapp">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
             Encomendar no Whatszap
        </button>
        <button class="btn-modal secondary" onclick="$('modal-checkout').close()">Continuar Comprando</button>
    </div>
</dialog>
<dialog id="modal-image-zoom" onclick="this.close()"><div class="modal-body"><img id="zoom-img" src="" alt="Zoom"><div class="btn-close-zoom">‚úï</div></div></dialog>
<dialog id="modal-faq" onclick="if(event.target===this)this.close()">
    <div class="modal-body">
        <h3 class="modal-title">D√∫vidas</h3>
        <p><strong>Entrega:</strong> Gr√°tis para Cuiab√° e V√°rzea Grande.</p>
        <p><strong>Pagamento:</strong> Na entrega (Pix, Dinheiro, Cart√£o).</p>
        <button class="btn-modal primary" onclick="this.closest('dialog').close()">OK</button>
    </div>
</dialog>
<dialog id="modal-mini-info" onclick="if(event.target===this)this.close()">
    <div class="modal-body"><h3 class="modal-title" id="mini-info-title"></h3><p id="mini-info-text"></p><button class="btn-modal primary" onclick="this.closest('dialog').close()">OK</button></div>
</dialog>

<script>
const CONFIG_WHATSAPP="5565996813588",$=i=>document.getElementById(i);
let DB_PROD=[],DB_CESTAS=[],DB_COUPONS=[],STATE={cesta:null,cart:{},cartOrder:[],basePrice:0,currentTotal:0,sortType:'name',initialGap:0,mode:'zero',previewBasketId:null,appliedCoupon:null,catMap:{},activeCategory:null};
async function init(){
    try{
        const[r1,r2,r3]=await Promise.all([fetch('produtos-cesta-basica.json?v='+Date.now()),fetch('produtos.json?v='+Date.now()),fetch('cupons.json?v='+Date.now()).catch(()=>({ok:!1}))]);
        if(r1.ok)DB_CESTAS=await r1.json();
        if(r2.ok){
            let t=(await r2.text()).trim().replace(/,(\s+)?$/,"");
            DB_PROD=JSON.parse(t.startsWith('[')?t:'['+t+']').filter(x=>x.situacao==="A").map(p=>({id:String(p.id),code:String(p.codigo||p.id),name:p.nome,price:parseFloat(p.preco),stock:parseInt(p.estoque)||0,category:(p.categoria||p.Categoria||"Outros").trim(),validade:p.validade,img:`img/produtos/${p.codigo||p.id}.webp`}));
        }
        if(r3&&r3.ok)DB_COUPONS=await r3.json();
        prepareCategories();
        renderBasketsTop();renderCatalogo();updateUI();
    }catch(e){$('dynamic-area').innerHTML='<p style="text-align:center;padding:20px;color:#64748B">Carregando...</p>'}
}
function prepareCategories(){
    const cats={};
    DB_PROD.forEach(p=>{if(!cats[p.category])cats[p.category]=[];cats[p.category].push(p)});
    let sc=Object.keys(cats).sort();
    if(sc.includes("Outros")){sc=sc.filter(c=>c!=="Outros");sc.push("Outros")}
    
    // Add logic
    const offers = DB_PROD.filter(p=>p.name.toUpperCase().includes("OFERTA"));
    if(offers.length > 0) {
        cats["üî• OFERTAS"] = offers;
        sc.unshift("üî• OFERTAS");
    }
    sc.unshift("üß∫ CESTAS B√ÅSICAS"); 

    STATE.catMap = {};
    sc.forEach(c => {
        if(c === "üß∫ CESTAS B√ÅSICAS") return;
        STATE.catMap[c] = cats[c].sort((a,b)=>{const fa=a.name.includes('***'),fb=b.name.includes('***');return fa===fb?0:fa?-1:1});
    });
    
    // RENDER STORIES
    const container = document.getElementById('stories-container');
    container.innerHTML = sc.map(cat => {
        let imgUrl = '';
        if(cat === "üß∫ CESTAS B√ÅSICAS") imgUrl = DB_CESTAS[0]?.imagem || '';
        else if(STATE.catMap[cat] && STATE.catMap[cat].length > 0) imgUrl = STATE.catMap[cat][0].img;
        
        return `
        <div class="story-item ${cat === STATE.activeCategory ? 'active' : ''}" onclick="selectCategory('${cat.replace(/'/g,"\\'")}')">
            <div class="story-circle"><img src="${imgUrl}" class="story-img" loading="lazy"></div>
            <div class="story-name">${formatText(cat).replace('üî• ','').replace('üß∫ ','')}</div>
        </div>`;
    }).join('');
    
    STATE.activeCategory = sc[1]; // Default
}
function selectCategory(name){
    // Update active visual
    document.querySelectorAll('.story-item').forEach(el => el.classList.remove('active'));
    // Find the clicked element and add active class based on text matching is tricky, so we rebuild or just rely on re-render. 
    // Ideally we re-render styles. But simple loop is fine.
    
    // SCROLL TO BASKETS
    if (name === "üß∫ CESTAS B√ÅSICAS") {
        const area = $('baskets-top-container');
        window.scrollTo({top:area.getBoundingClientRect().top+window.pageYOffset-70, behavior:'smooth'});
        return;
    }
    
    STATE.activeCategory = name;
    renderCatalogo();
    
    // Update Active State in Stories
    const stories = document.querySelectorAll('.story-item');
    // We need to re-match the clicked one. A simple way is re-rendering the whole prepareCategories or manually finding.
    // For performance, let's just re-render class:
    prepareCategories(); // Re-renders to show active border
    
    // Scroll to Dynamic Area
    const area = $('dynamic-area');
    window.scrollTo({top:area.getBoundingClientRect().top+window.pageYOffset-70, behavior:'smooth'});
}
function renderCatalogo(fromSearch=false){
    const q=$('search-input').value.toUpperCase(),clr=$('btn-clear-search');clr.style.display=q?'block':'none';
    const container = $('dynamic-area');
    
    if(q){
        let r=DB_PROD.filter(p=>p.name.toUpperCase().includes(q));
        container.innerHTML=`
            <div class="section-header"><div class="section-title">Resultados da Busca</div></div>
            <div class="carousel-container">
                <div class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-250,behavior:'smooth'})">‚ùÆ</div>
                <div class="carousel-track">
                    ${r.length ? r.map(p=>renderProdCard(p)).join('') : '<p style="padding:20px;color:#64748B">Nada encontrado.</p>'}
                </div>
                <div class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:250,behavior:'smooth'})">‚ùØ</div>
            </div>`;
        return;
    }

    const currentCat = STATE.activeCategory;
    const prods = STATE.catMap[currentCat] || [];
    
    container.innerHTML = `
        <div class="section-header"><div class="section-title">${formatText(currentCat)}</div></div>
        <div class="carousel-container">
            <div class="carousel-arrow arrow-left" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:-250,behavior:'smooth'})">‚ùÆ</div>
            <div class="carousel-track">
                ${prods.map(p => renderProdCard(p)).join('')}
            </div>
            <div class="carousel-arrow arrow-right" onclick="this.parentElement.querySelector('.carousel-track').scrollBy({left:250,behavior:'smooth'})">‚ùØ</div>
        </div>`;
}
function smartTitleCase(s){
    if(!s)return"";
    return String(s).split(' ').map(w=>{
        let clean = w.replace(/[*]/g, ''); 
        if(clean.length <= 3) return w.toLowerCase();
        return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
    }).join(' ');
}
function formatText(s){
    let c = s.replace(/\*\*\*(.*?)\*\*\*/g, '$1');
    return smartTitleCase(c).replace(/\*\*(.*?)\*\*/g,'<span style="font-weight:800;color:var(--c-err)">$1</span>').replace(/\*(.*?)\*/g,'<b>$1</b>');
}
function renderBasketsTop(){
    $('cestas-scroll-list').innerHTML=DB_CESTAS.map(c=>`<div class="cesta-mini-card" onclick="previewBasket('${c.id}')"><img src="${c.imagem||''}" class="cesta-mini-img" loading="lazy"><div class="cesta-mini-content"><div class="cesta-mini-name">${formatText(c.nome)}</div><div class="cesta-mini-price">${fmt(c.preco)}</div><button class="btn-cesta-select">Ver itens</button></div></div>`).join('');
}
function previewBasket(id){
    const c=DB_CESTAS.find(x=>String(x.id)===String(id));if(!c)return;
    STATE.previewBasketId=String(id);
    $('preview-title').innerHTML=formatText(c.nome);$('preview-price').innerText=fmt(c.preco);$('preview-desc').innerText=`${c.produtos.length} itens:`;
    $('preview-carousel-track').innerHTML=c.produtos.map(i=>{
        const p=i.split('x');if(p.length<2)return'';
        const pr=DB_PROD.find(x=>x.id===p[1].trim()||x.code===p[1].trim());
        return pr?`<div class="prod-card" style="box-shadow:none;border:1px solid #eee"><img src="${pr.img}" class="prod-img" loading="lazy">${pr.validade?`<div class="prod-validity">Val: ${pr.validade}</div>`:''}<div class="prod-name">${formatText(pr.name)}</div><div class="prod-price" style="font-size:.9rem;color:#64748B">${p[0].trim()} UNIDADE(S)</div></div>`:''
    }).join('');
    $('modal-basket-preview').showModal();
}
function confirmBasketSelection(){
    const c=DB_CESTAS.find(x=>String(x.id)===STATE.previewBasketId);if(!c)return;
    STATE.cesta=c;STATE.mode='custom';STATE.basePrice=c.preco;STATE.cart={};STATE.cartOrder=[];
    let is=0;c.produtos.forEach(i=>{
        const p=i.split('x');if(p.length<2)return;
        const pr=DB_PROD.find(x=>x.id===p[1].trim()||x.code===p[1].trim());
        if(pr){let q=Math.min(parseInt(p[0].trim()),pr.stock);STATE.cart[pr.id]=q;STATE.cartOrder.push(pr.id);is+=pr.price*q}
    });
    STATE.initialGap=c.preco-is;STATE.appliedCoupon=null;
    $('modal-basket-preview').close();$('zero-mode-banner').style.display='none';
    const area = $('selected-basket-area');
    area.style.display='block'; area.style.zIndex='900'; 
    $('basket-intro-msg').innerHTML=`Cesta <strong>${formatText(c.nome)}</strong> ativada.`;
    renderActiveBasketList(); updateUI(); renderCatalogo(); $('btn-view-diff-float').style.display='flex';
    showToast(`Cesta carregada!`,'s'); setTimeout(()=>area.scrollIntoView({behavior:'smooth',block:'center'}),100);
}
function renderActiveBasketList(){
    const el=$('basket-list-content'),ids=STATE.cartOrder.filter(id=>STATE.cart[id]);
    if(!ids.length){el.innerHTML='<p style="text-align:center;color:#64748B;padding:10px;width:100%">Vazia.</p>';return}
    el.innerHTML=ids.map(pid=>{
        const p=DB_PROD.find(x=>x.id===pid);if(!p)return'';
        return `<div class="basket-item-card"><img src="${p.img}" class="prod-img" loading="lazy" onclick="openImageZoom('${p.img}')">${p.validade?`<div class="prod-validity">Val: ${p.validade}</div>`:''}<div class="prod-name">${formatText(p.name)}</div><div class="prod-price">${fmt(p.price)}</div><div class="qty-control" style="margin-top:auto"><button class="btn-q" onclick="upd('${pid}',-1)">-</button><span class="val-q qty-${pid}">${STATE.cart[pid]}</span><button class="btn-q" onclick="upd('${pid}',1)" style="color:var(--c-ok)">+</button></div></div>`
    }).join('');
}
function clearCart(){
    if(!Object.keys(STATE.cart).length)return showToast("Vazio.",'r');
    if(!confirm("Limpar carrinho?"))return;
    STATE.cart={};STATE.cartOrder=[];STATE.mode='zero';STATE.cesta=null;STATE.basePrice=0;STATE.initialGap=0;STATE.appliedCoupon=null;
    $('selected-basket-area').style.display='none';$('zero-mode-banner').style.display='block';
    updateUI();renderCatalogo();$('btn-view-diff-float').style.display='none';showToast("Limpo.",'r');
}
function upd(pid,d){
    const p=DB_PROD.find(x=>x.id===pid),cq=STATE.cart[pid]||0;
    if(d>0&&cq>=p.stock)return showToast("Estoque limite!", "r");
    if(d>0&&!cq)STATE.cartOrder.unshift(pid);
    STATE.cart[pid]=cq+d; if(STATE.cart[pid]<=0){delete STATE.cart[pid];STATE.cartOrder=STATE.cartOrder.filter(x=>x!==pid)}
    if(STATE.appliedCoupon){
        let t=Object.entries(STATE.cart).reduce((a,[i,q])=>{const x=DB_PROD.find(z=>z.id===i);return a+(x?x.price*q:0)},0)+(STATE.initialGap||0);
        if(t<STATE.appliedCoupon.minimo){STATE.appliedCoupon=null;showToast("Cupom removido","r")}
    }
    updateUI();if($('selected-basket-area').style.display!=='none')renderActiveBasketList();
    document.querySelectorAll(`.qty-${pid}`).forEach(e=>e.innerText=STATE.cart[pid]||0);
    document.querySelectorAll(`.ctl-wrapper-${pid}`).forEach(w=>{w.innerHTML=STATE.cart[pid]>0?`<div class="qty-control"><button class="btn-q" onclick="upd('${pid}',-1)">-</button><span class="val-q qty-${pid}">${STATE.cart[pid]}</span><button class="btn-q" onclick="upd('${pid}',1)" style="color:var(--c-ok)">+</button></div>`:`<button class="btn-add-big" onclick="upd('${pid}',1)">+</button>`});
    if(d>0)showToast(`+1 ${p.name.substring(0,10)}...`,'s');
}
function updateUI(){
    let c=0,sum=Object.entries(STATE.cart).reduce((a,[i,q])=>{c+=q;const p=DB_PROD.find(x=>x.id===i);return a+(p?p.price*q:0)},0);
    STATE.currentTotal=sum+(STATE.initialGap||0)-(STATE.appliedCoupon?STATE.appliedCoupon.desconto:0);
    $('chk-total-val').innerText=fmt(STATE.currentTotal);
    if($('basket-count-display'))$('basket-count-display').innerText=`${c} itens`;
    const st=$('chk-status-text');
    if(STATE.mode==='zero'){st.innerText="TOTAL";st.style.color="var(--c-s)"}
    else{
        const d=STATE.basePrice-STATE.currentTotal;
        st.innerText=d>.01?`CR√âDITO: ${fmt(d)}`:d<-.01?`ACR√âSCIMO: ${fmt(Math.abs(d))}`:"VALOR ORIGINAL";
        st.style.color=d>.01?"var(--c-ok)":d<-.01?"var(--c-err)":"var(--c-s)";
    }
}
function applyCoupon(){
    const c=DB_COUPONS.find(x=>x.codigo===$('coupon-code').value.trim().toUpperCase());
    if(!c)return showToast("Inv√°lido","r");
    if(STATE.currentTotal<c.minimo)return showToast(`M√≠nimo R$ ${c.minimo}`,"r");
    STATE.appliedCoupon=c;updateUI();
    $('coupon-msg').style.display='block';$('coupon-msg').innerText=`-${fmt(c.desconto)} aplicado!`;$('coupon-msg').style.color='var(--c-ok)';
    $('checkout-total-display').innerText=`Total: ${fmt(STATE.currentTotal)}`;showToast("Aplicado!","s");
}
function renderProdCard(p){
    const q=STATE.cart[p.id]||0;
    const isFeat = p.name.includes('***');
    const isSoldOut = p.stock <= 0;
    let actionBtn;
    if (isSoldOut) {
         actionBtn = `<div class="btn-add-big" style="background:#e2e8f0; color:#94a3b8; border-color:#cbd5e1; pointer-events:none; font-size:0.85rem; font-weight:700">ESGOTADO</div>`;
    } else if (q > 0) {
         actionBtn = `<div class="qty-control"><button class="btn-q" onclick="upd('${p.id}',-1)">-</button><span class="val-q qty-${p.id}">${q}</span><button class="btn-q" onclick="upd('${p.id}',1)" style="color:var(--c-ok)">+</button></div>`;
    } else {
         actionBtn = `<button class="btn-add-big" onclick="upd('${p.id}',1)">+</button>`;
    }
    return `<div class="prod-card ${isFeat?'featured':''} ${isSoldOut?'sold-out':''}"><img src="${p.img}" class="prod-img" loading="lazy" onclick="openImageZoom('${p.img}')">${p.validade?`<div class="prod-validity">Val: ${p.validade}</div>`:''}<div class="prod-name">${formatText(p.name)}</div><div class="prod-price">${fmt(p.price)}</div><div class="ctl-wrapper-${p.id}">${actionBtn}</div></div>`;
}
function showTopInfo(t){
    $('mini-info-title').innerText=t==='pagamento'?"Pagamento":"Entrega";
    $('mini-info-text').innerHTML=t==='pagamento'?"Aceitamos:<br>‚Ä¢ PIX<br>‚Ä¢ Dinheiro<br>‚Ä¢ Cart√µes":"Entregamos Cuiab√° e VG.<br>At√© 24h √∫teis.";
    $('modal-mini-info').showModal();
}
function showToast(m,t){
    const d=document.createElement('div');d.className='toast';d.style.background=t==='r'?'var(--c-p)':'var(--c-ok)';d.innerHTML=t==='r'?`üóëÔ∏è ${m}`:`‚úÖ ${m}`;
    $('toast-container').appendChild(d);setTimeout(()=>{d.style.opacity='0';setTimeout(()=>d.remove(),400)},2000);
}
function openDiffModal(){
    let m={},r=[],a=[];if(STATE.cesta)STATE.cesta.produtos.forEach(i=>{const p=i.split('x');if(p.length>1)m[p[1].trim()]=parseInt(p[0])});
    Object.entries(m).forEach(([id,q])=>{const c=STATE.cart[id]||0;if(c<q){const p=DB_PROD.find(x=>x.id===id);if(p)r.push(`<div><strong>- ${q-c}x</strong> ${formatText(p.name)}</div>`)}});
    Object.entries(STATE.cart).forEach(([id,q])=>{const o=m[id]||0;if(q>o){const p=DB_PROD.find(x=>x.id===id);if(p)a.push(`<div><strong>+ ${q-o}x</strong> ${formatText(p.name)}</div>`)}});
    $('diff-content').innerHTML=(!r.length&&!a.length)?"Sem altera√ß√µes.":((r.length?`<h4 style="color:var(--c-err)">Retirados:</h4>${r.join('')}`:'')+(a.length?`<h4 style="color:var(--c-ok);margin-top:10px">Adicionados:</h4>${a.join('')}`:''));
    $('modal-diff').showModal();
}
function openCheckoutModal(){
    if(STATE.mode==='custom'&&STATE.currentTotal<(STATE.basePrice-.5))return alert(`Faltam ${fmt(STATE.basePrice-STATE.currentTotal)}`);
    if(STATE.mode==='zero'){if(STATE.currentTotal<85)return alert(`M√≠nimo R$ 85,00.`);if(Object.keys(STATE.cart).length<10)return alert(`M√≠nimo 10 itens.`);}
    let tc=0;Object.values(STATE.cart).forEach(q=>tc+=q);$('checkout-subtitle').innerText=`${tc} produtos`;
    $('checkout-carousel-track').innerHTML=Object.entries(STATE.cart).map(([id,q])=>{
        const p=DB_PROD.find(x=>x.id===id);return p?`<div class="prod-card" style="width:130px;flex:0 0 130px;box-shadow:none;border:1px solid #f1f5f9"><img src="${p.img}" class="prod-img" loading="lazy"><div class="prod-name" style="height:auto;-webkit-line-clamp:2;font-size:.75rem">${formatText(p.name)}</div><div style="font-weight:700;color:var(--c-p);margin-top:5px;text-align:center;background:#f1f5f9;border-radius:8px;padding:4px">${q}x</div></div>`:''
    }).join('');
    $('checkout-total-display').innerText=`Total: ${fmt(STATE.currentTotal)}`;$('modal-checkout').showModal();
}
async function sendOrder(){
    const n=$('cust-name').value,p=$('cust-pay').value;if(!n)return alert("Digite seu nome.");
    const oid=new Date().getTime().toString().slice(-6),cl=`TIPO: ${STATE.mode==='zero'?'ZERO':'PERSONAL'} | CESTA: ${STATE.cesta?STATE.cesta.nome:'N/A'}`+(STATE.appliedCoupon?` | CUP: ${STATE.appliedCoupon.codigo}`:'');
    const its=[];Object.entries(STATE.cart).forEach(([id,q])=>{const x=DB_PROD.find(z=>z.id===id);if(x)its.push({id:x.id,nome:x.name,quantidade:q,preco_unitario:x.price})});
    try{await fetch("https://hook.eu1.make.com/yisqs4w309ogi6fx4969dbsr2q7fu7il",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({cliente:{nome:n},pedido:{itens:its,total_site:STATE.currentTotal,forma_pagamento:p,cesta_origem:cl,observacoes:`Ref #${oid}`}})});}catch(e){}
    let m=`*PEDIDO #${oid}*\nüë§ ${n}\nüí∞ ${p}\n\n*ITENS:*\n`+its.map(i=>`${i.quantidade}x ${i.nome}`).join('\n')+(STATE.appliedCoupon?`\nüè∑Ô∏è Cupom: ${STATE.appliedCoupon.codigo}`:'')+`\n*TOTAL: ${fmt(STATE.currentTotal)}*`;
    window.location.href=`https://wa.me/${CONFIG_WHATSAPP}?text=${encodeURIComponent(m)}`;
}
function fmt(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
function clearSearch(){$('search-input').value="";renderCatalogo()}
function openImageZoom(s){$('zoom-img').src=s;$('modal-image-zoom').showModal()}
init();
</script>
</body>
</html>
