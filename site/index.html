<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Dona Ant√¥nia - Cestas B√°sicas Inteligentes">
    <meta name="theme-color" content="#ffffff">
    <title>Dona Ant√¥nia | Personalizar</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <style>
        /* --- 1. DESIGN SYSTEM & RESET --- */
        :root {
            --primary: #d31a28;        /* Vermelho Marca */
            --primary-dark: #b91c1c;
            --accent: #22c55e;         /* Verde Sucesso/Zap */
            --bg-app: #ffffff;
            --bg-sec: #f8f9fa;
            --text-main: #1f2937;
            --text-sec: #6b7280;
            --border: #e5e7eb;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --header-h: 60px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-app); color: var(--text-main);
            font-size: 16px; line-height: 1.5;
            overflow-x: hidden;
        }

        /* Utilit√°rios */
        .hidden { display: none !important; }
        .container { max-width: 600px; margin: 0 auto; padding: 0 16px; position: relative; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }
        img { display: block; max-width: 100%; }

        /* --- 2. COMPONENTES UI --- */

        /* Header Fixo */
        .app-header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            background: rgba(255, 255, 255, 0.96); backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--border); z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; max-width: 600px; margin: 0 auto;
        }
        .logo { font-weight: 800; font-size: 1.1rem; color: var(--text-main); letter-spacing: -0.5px; }
        
        /* Bot√£o Carrinho (P√≠lula) */
        .cart-pill {
            background: var(--bg-sec); border: 1px solid var(--border);
            padding: 6px 12px; border-radius: 20px;
            display: flex; align-items: center; gap: 8px;
            font-size: 0.85rem; font-weight: 700; transition: all 0.2s;
        }
        .cart-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
        .cart-pill span { font-variant-numeric: tabular-nums; }

        /* --- 3. VIEW: HOME (Lista de Cestas) --- */
        #view-home { padding-top: calc(var(--header-h) + 20px); padding-bottom: 60px; }
        
        .hero { text-align: center; margin-bottom: 30px; }
        .hero h1 { font-size: 1.6rem; margin-bottom: 8px; line-height: 1.2; letter-spacing: -0.5px; }
        .hero p { color: var(--text-sec); font-size: 0.95rem; }

        .basket-card {
            background: #fff; border: 1px solid var(--border); border-radius: var(--radius);
            overflow: hidden; margin-bottom: 24px;
            box-shadow: var(--shadow-sm); transition: transform 0.2s;
        }
        .basket-card:active { transform: scale(0.98); }
        .bc-img { width: 100%; aspect-ratio: 16/9; object-fit: cover; background: var(--bg-sec); }
        .bc-content { padding: 20px; }
        .bc-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 4px; }
        .bc-price { font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 16px; }
        
        .bc-actions { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; }
        .btn {
            padding: 14px; border-radius: 10px; font-weight: 700; font-size: 0.95rem;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-sec { background: var(--bg-sec); color: var(--text-main); border: 1px solid var(--border); }
        .btn-pri { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(211, 26, 40, 0.25); }

        /* --- 4. VIEW: FLOW (Chat/Personalizador) --- */
        #view-flow {
            position: fixed; inset: 0; background: #fff; z-index: 2000;
            display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #view-flow.active { transform: translateX(0); }

        .flow-content { flex: 1; overflow-y: auto; padding: 20px 0 100px; scroll-behavior: smooth; }
        
        /* Mensagens do Rob√¥ */
        .msg-bot {
            max-width: 90%; margin: 10px 16px 20px;
            font-size: 1.1rem; color: var(--text-main); line-height: 1.4;
            animation: fadeIn 0.4s ease;
        }
        .msg-bot strong { color: var(--primary); font-weight: 700; }

        /* Typing Indicator */
        .typing { display: flex; gap: 4px; padding: 0 16px; margin-bottom: 15px; }
        .dot { width: 8px; height: 8px; background: #ccc; border-radius: 50%; animation: bounce 1.4s infinite; }
        .dot:nth-child(2) { animation-delay: 0.2s; } .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Grid de Produtos (Minimalista) */
        .prod-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;
            padding: 0 16px 24px; animation: slideUp 0.4s ease;
        }
        .prod-card {
            position: relative; display: flex; flex-direction: column;
        }
        .pc-img-box {
            position: relative; aspect-ratio: 1; background: var(--bg-sec);
            border-radius: var(--radius); overflow: hidden; margin-bottom: 8px;
        }
        .pc-img { width: 100%; height: 100%; object-fit: contain; mix-blend-mode: multiply; }
        .pc-tag {
            position: absolute; top: 6px; left: 6px; background: #fee2e2; color: #991b1b;
            font-size: 0.65rem; font-weight: 700; padding: 2px 6px; border-radius: 4px;
        }

        .pc-info { flex: 1; display: flex; flex-direction: column; }
        .pc-title { font-size: 0.85rem; line-height: 1.25; color: #374151; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .pc-price { font-weight: 700; font-size: 1rem; color: var(--text-main); margin-top: auto; }
        .pc-price s { font-size: 0.75rem; color: #9ca3af; font-weight: 400; margin-right: 4px; }

        /* Bot√µes de Controle (+/-) */
        .pc-action { position: absolute; bottom: 8px; right: 8px; }
        
        .btn-add {
            width: 36px; height: 36px; border-radius: 50%; background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; color: var(--primary); transition: transform 0.1s;
        }
        .btn-add:active { transform: scale(0.9); }

        .qty-ctrl {
            display: flex; align-items: center; background: #fff; border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); height: 36px; border: 1px solid var(--border); overflow: hidden;
        }
        .qc-btn { width: 32px; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary); }
        .qc-val { font-weight: 700; font-size: 0.9rem; min-width: 24px; text-align: center; }

        /* Bot√µes de Resposta (Footer) */
        .flow-actions {
            background: #fff; padding: 16px; border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .btn-opt {
            width: 100%; padding: 16px; background: var(--bg-sec); border: 1px solid var(--border);
            border-radius: var(--radius); text-align: left; font-weight: 600; color: var(--text-main);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-opt.highlight { background: var(--text-main); color: #fff; border-color: var(--text-main); }
        .btn-opt:active { transform: scale(0.98); }

        /* --- 5. MODAL: CARRINHO --- */
        dialog {
            margin: 0; padding: 0; border: none; width: 100%; max-width: 600px;
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
            border-radius: 24px 24px 0 0; background: #fff;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 5000;
        }
        dialog[open] { transform: translateX(-50%) translateY(0); }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }

        .cart-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .cart-title { font-size: 1.2rem; font-weight: 800; }
        
        .cart-body { max-height: 50vh; overflow-y: auto; padding: 20px; }
        .cart-item { display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 0.9rem; border-bottom: 1px dashed var(--border); padding-bottom: 8px; }
        
        .cart-footer { padding: 20px; background: var(--bg-sec); border-top: 1px solid var(--border); }
        .cart-total { display: flex; justify-content: space-between; font-size: 1.3rem; font-weight: 800; margin-bottom: 15px; }
        
        .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; color: var(--text-sec); }
        .form-select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 1rem; margin-bottom: 15px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="view-home">
        <header class="app-header">
            <div class="logo">Dona Ant√¥nia</div>
            <div style="width:24px"></div> </header>

        <div class="container">
            <div class="hero">
                <h1>Cestas B√°sicas<br>Sem Complica√ß√£o</h1>
                <p>Escolha, personalize e receba em casa.</p>
            </div>
            <div id="basket-list">
                <div style="text-align:center; padding:40px; color:#999">Carregando produtos...</div>
            </div>
        </div>
    </div>

    <div id="view-flow">
        <header class="app-header">
            <button onclick="App.closeFlow()" style="font-size:1.5rem; padding:5px;">‚úï</button>
            <div class="logo">Personalizar</div>
            <button class="cart-pill" onclick="App.openCart()">
                üõí <span id="cart-total-display">R$ 0,00</span>
            </button>
        </header>

        <div class="flow-content" id="flow-feed">
            </div>

        </div>

    <dialog id="modal-cart">
        <div class="cart-header">
            <span class="cart-title">Seu Pedido</span>
            <button onclick="document.getElementById('modal-cart').close()" style="font-size:1.5rem">‚úï</button>
        </div>
        <div class="cart-body" id="cart-items"></div>
        <div class="cart-footer">
            <div class="cart-total">
                <span>Total</span>
                <span id="modal-total-val" style="color:var(--primary)">R$ 0,00</span>
            </div>
            <div class="form-group">
                <label>Como prefere pagar na entrega?</label>
                <select class="form-select" id="pay-method">
                    <option value="Pix">Pix (Na hora)</option>
                    <option value="Dinheiro">Dinheiro</option>
                    <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                    <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                    <option value="Vale Alimenta√ß√£o">Vale Alimenta√ß√£o</option>
                </select>
            </div>
            <button class="btn btn-pri" style="width:100%" onclick="App.checkout()">
                Confirmar no WhatsApp ‚û°
            </button>
        </div>
    </dialog>

    <script>
        // CONFIGURA√á√ÉO DO FLUXO (WIZARD)
        // Define exatamente a ordem que o "Rob√¥" vai apresentar as subcategorias
        const FLOW_STEPS = [
            { id: 'start', title: 'Itens da Cesta', type: 'basket_review' },
            // Mercearia
            { id: 'graos', title: 'Arroz, Feij√£o e √ìleo', category: 'MERCEARIA E ALIMENTOS', sub: 'ARROZ, FEIJ√ÉO E √ìLEO' },
            { id: 'massas', title: 'Massas e Molhos', category: 'MERCEARIA E ALIMENTOS', sub: 'MASSAS E MOLHOS' },
            { id: 'temperos', title: 'Culin√°ria e Temperos', category: 'MERCEARIA E ALIMENTOS', sub: 'CULIN√ÅRIA E TEMPEROS' },
            { id: 'conservas', title: 'Conservas e Enlatados', category: 'MERCEARIA E ALIMENTOS', sub: 'CONSERVAS E ENLATADOS' },
            // Caf√© da Manh√£
            { id: 'cafe', title: 'Caf√©, Ch√°s e Sucos', category: 'CAF√â DA MANH√É E LANCHES', sub: 'CAF√â, CH√ÅS E SUCOS' },
            { id: 'leites', title: 'Leites e Achocolatados', category: 'CAF√â DA MANH√É E LANCHES', sub: 'LEITES, CEREAIS E ACHOCOLATADOS' },
            { id: 'biscoitos', title: 'Biscoitos e Snacks', category: 'CAF√â DA MANH√É E LANCHES', sub: 'BISCOITOS E SNACKS' },
            // Limpeza
            { id: 'roupas', title: 'Roupas e Lavanderia', category: 'LIMPEZA E LAVANDERIA', sub: 'ROUPAS E LAVANDERIA' },
            { id: 'cozinha_limp', title: 'Cozinha e Banheiro', category: 'LIMPEZA E LAVANDERIA', sub: 'COZINHA E BANHEIRO' },
            // Higiene
            { id: 'banho', title: 'Banho e Higiene', category: 'CUIDADOS PESSOAIS', sub: 'BANHO E HIGIENE' },
            { id: 'pessoal', title: 'Cuidados Pessoais', category: 'CUIDADOS PESSOAIS', sub: 'CUIDADOS E EST√âTICA' },
            // Fim
            { id: 'end', title: 'Finalizar', type: 'end' }
        ];

        const DonaAntoniaApp = {
            data: [],
            cart: {}, // { id: qtd }
            activeBasket: null,
            currentStepIndex: 0,

            // Inicializa√ß√£o
            async init() {
                try {
                    // Carrega JSON (usando o nome que voc√™ forneceu)
                    const res = await fetch('produtos (10).json');
                    // Fallback se o nome mudar
                    if(!res.ok) throw new Error("Arquivo n√£o encontrado");
                    
                    const json = await res.json();
                    const rawProducts = json.produtos || json;

                    // Tratamento e Limpeza de Dados
                    this.data = rawProducts.map(p => ({
                        id: String(p.id),
                        name: p.nome.trim(),
                        price: parseFloat(p.valor || 0),
                        offerPrice: parseFloat(p.Valor_Oferta || 0),
                        isOffer: p.Oferta === 'Sim',
                        // Separa Categoria > Subcategoria
                        catMain: (p.categoria || "").split('>')[0].trim().toUpperCase(),
                        catSub: (p.categoria || "").split('>')[1] ? (p.categoria || "").split('>')[1].trim().toUpperCase() : "",
                        image: p.imagem ? `img/produtos/${p.imagem.split('/').pop()}` : 'https://via.placeholder.com/300?text=Sem+Foto'
                    }));

                    this.renderHome();
                } catch (err) {
                    console.error(err);
                    // Tenta carregar o arquivo padrao se o (10) falhar
                    fetch('produtos.json').then(r=>r.json()).then(json => {
                        const raw = json.produtos || json;
                        this.data = raw.map(p => ({
                            id: String(p.id),
                            name: p.nome.trim(),
                            price: parseFloat(p.valor || 0),
                            offerPrice: parseFloat(p.Valor_Oferta || 0),
                            isOffer: p.Oferta === 'Sim',
                            catMain: (p.categoria || "").split('>')[0].trim().toUpperCase(),
                            catSub: (p.categoria || "").split('>')[1] ? (p.categoria || "").split('>')[1].trim().toUpperCase() : "",
                            image: p.imagem ? `img/produtos/${p.imagem.split('/').pop()}` : 'https://via.placeholder.com/300?text=Sem+Foto'
                        }));
                        this.renderHome();
                    }).catch(e => alert("Erro ao carregar sistema. Verifique o arquivo produtos.json"));
                }
            },

            // --- RENDERIZA√á√ÉO HOME ---
            renderHome() {
                const listEl = document.getElementById('basket-list');
                const baskets = this.data.filter(p => p.catMain.includes('CESTA'));

                listEl.innerHTML = baskets.map(b => `
                    <div class="basket-card">
                        <img src="${b.image}" class="bc-img" loading="lazy">
                        <div class="bc-content">
                            <div class="bc-title">${b.name}</div>
                            <div class="bc-price">R$ ${b.price.toFixed(2).replace('.',',')}</div>
                            <div class="bc-actions">
                                <button class="btn btn-sec" onclick="App.directOrder('${b.id}')">
                                    <span>‚ö°</span> Pedir J√°
                                </button>
                                <button class="btn btn-pri" onclick="App.startFlow('${b.id}')">
                                    <span>üí¨</span> Personalizar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            },

            // --- L√ìGICA DO CARRINHO ---
            modQty(id, delta) {
                if (!this.cart[id]) this.cart[id] = 0;
                this.cart[id] += delta;
                if (this.cart[id] <= 0) delete this.cart[id];
                
                this.updateCartUI();
                this.refreshActiveGrids(id);
            },

            getCartMetrics() {
                let total = 0, count = 0;
                for (let id in this.cart) {
                    const p = this.data.find(x => x.id === id);
                    if (p) {
                        const finalPrice = p.isOffer ? p.offerPrice : p.price;
                        total += finalPrice * this.cart[id];
                        count += this.cart[id];
                    }
                }
                return { total, count };
            },

            updateCartUI() {
                const { total, count } = this.getCartMetrics();
                const text = `R$ ${total.toFixed(2).replace('.',',')}`;
                
                document.getElementById('cart-total-display').innerText = text;
                document.getElementById('modal-total-val').innerText = text;
                
                const pill = document.querySelector('.cart-pill');
                if (count > 0) pill.classList.add('active'); else pill.classList.remove('active');
            },

            // --- L√ìGICA DO FLUXO (CHAT) ---
            startFlow(basketId) {
                this.activeBasket = this.data.find(x => x.id === basketId);
                this.cart = {};
                this.currentStepIndex = 0;

                // Popula o carrinho inicial com os itens da cesta (se houver items no json)
                // Assumindo que o JSON n√£o tem a propriedade 'items' preenchida para todos,
                // vamos iniciar zerado mas adicionar a pr√≥pria cesta como item base se desejar, 
                // ou apenas iniciar o fluxo. 
                // A l√≥gica anterior tentava ler basket.items. Vamos simplificar:
                // Se a cesta tiver itens definidos no JSON, adiciona.
                if(this.activeBasket.items && Array.isArray(this.activeBasket.items)) {
                    this.activeBasket.items.forEach(i => {
                        this.cart[String(i.id)] = parseInt(i.qty || 1);
                    });
                } else {
                    // Se n√£o tiver items definidos, adiciona a cesta em si como produto
                    // OU assume que o usu√°rio vai montar do zero.
                    // Para este modelo "Personalizar", o ideal √© come√ßar com a cesta.
                    this.cart[basketId] = 1;
                }

                this.updateCartUI();
                
                document.getElementById('view-flow').classList.add('active');
                document.getElementById('flow-feed').innerHTML = ''; // Limpa chat
                
                this.renderStep();
            },

            closeFlow() {
                if(confirm("Sair agora perder√° sua cesta atual. Deseja sair?")) {
                    document.getElementById('view-flow').classList.remove('active');
                }
            },

            nextStep() {
                this.currentStepIndex++;
                if (this.currentStepIndex >= FLOW_STEPS.length) {
                    this.openCart(); // Fim do fluxo
                    return;
                }
                this.renderStep();
            },

            renderStep() {
                const step = FLOW_STEPS[this.currentStepIndex];
                const feed = document.getElementById('flow-feed');

                // 1. Efeito de Digita√ß√£o (Humaniza√ß√£o)
                const typing = document.createElement('div');
                typing.className = 'typing';
                typing.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
                feed.appendChild(typing);
                feed.scrollTo(0, feed.scrollHeight);

                // 2. Processa o passo ap√≥s delay
                setTimeout(() => {
                    typing.remove();
                    
                    // Texto do Rob√¥
                    let msg = "";
                    if (step.type === 'basket_review') {
                        msg = `Oi! Voc√™ escolheu a <strong>${this.activeBasket.name}</strong>. Veja os itens inclusos e adicione mais coisas se quiser.`;
                    } else if (step.type === 'end') {
                        msg = `Prontinho! Vamos revisar seu pedido?`;
                    } else {
                        msg = `Vamos ver op√ß√µes de <strong>${step.title}</strong>?`;
                    }
                    
                    const msgEl = document.createElement('div');
                    msgEl.className = 'msg-bot';
                    msgEl.innerHTML = msg;
                    feed.appendChild(msgEl);

                    // 3. Renderiza Produtos (Se houver categoria)
                    if (step.category) {
                        const products = this.getProducts(step.category, step.sub);
                        if (products.length > 0) {
                            feed.appendChild(this.createProductGrid(products));
                        } else {
                            // Se n√£o tiver produtos nessa categoria, avisa e pula
                            const empty = document.createElement('div');
                            empty.className = 'msg-bot';
                            empty.innerHTML = "<small>N√£o tenho itens desta categoria no momento.</small>";
                            feed.appendChild(empty);
                        }
                    } else if (step.type === 'basket_review') {
                        // Mostra o que j√° est√° no carrinho
                        const ids = Object.keys(this.cart);
                        const items = ids.map(id => this.data.find(x => x.id === id)).filter(x=>x);
                        feed.appendChild(this.createProductGrid(items));
                    }

                    // 4. Renderiza Bot√µes de A√ß√£o
                    this.renderActions(step);
                    
                    feed.scrollTo(0, feed.scrollHeight);

                }, 600); // Delay de 600ms
            },

            renderActions(step) {
                const feed = document.getElementById('flow-feed');
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flow-actions';

                if (step.type === 'end') {
                    actionsDiv.innerHTML = `
                        <button class="btn-opt highlight" onclick="App.openCart()">
                            <span>‚úÖ Ver Resumo e Pedir</span> <span>‚û°</span>
                        </button>
                    `;
                } else {
                    const btnLabel = (step.type === 'basket_review') ? 'Tudo certo, continuar' : 'Pr√≥xima Categoria';
                    actionsDiv.innerHTML = `
                        <button class="btn-opt highlight" onclick="this.parentElement.remove(); App.nextStep()">
                            <span>${btnLabel}</span> <span>‚û°</span>
                        </button>
                    `;
                    // Bot√£o Pular (Opcional, se n√£o for review)
                    if(step.type !== 'basket_review') {
                         /* Pode adicionar um bot√£o "Pular" se quiser */
                    }
                }
                feed.appendChild(actionsDiv);
            },

            // --- HELPER DE DADOS ---
            getProducts(mainCat, subCat) {
                // Filtra por Categoria Principal e Subcategoria (cont√©m)
                return this.data.filter(p => {
                    if (p.catMain !== mainCat) return false;
                    if (subCat && !p.catSub.includes(subCat)) return false;
                    return true;
                }).slice(0, 20); // Limite de seguran√ßa
            },

            // --- COMPONENTE GRID HTML ---
            createProductGrid(products) {
                const grid = document.createElement('div');
                grid.className = 'prod-grid';
                grid.innerHTML = products.map(p => this.getProductCardHTML(p)).join('');
                return grid;
            },

            getProductCardHTML(p) {
                const qty = this.cart[p.id] || 0;
                const price = p.isOffer ? p.offerPrice : p.price;
                
                // Bot√£o Adicionar ou Controle Qtd
                let actionBtn = '';
                if (qty === 0) {
                    actionBtn = `<div class="btn-add" onclick="App.modQty('${p.id}', 1)">+</div>`;
                } else {
                    actionBtn = `
                        <div class="qty-ctrl">
                            <div class="qc-btn" onclick="App.modQty('${p.id}', -1)">-</div>
                            <div class="qc-val">${qty}</div>
                            <div class="qc-btn" onclick="App.modQty('${p.id}', 1)">+</div>
                        </div>
                    `;
                }

                return `
                    <div class="prod-card" data-pid="${p.id}">
                        <div class="pc-img-box">
                            <img src="${p.image}" class="pc-img" loading="lazy">
                            ${p.isOffer ? '<span class="pc-tag">OFERTA</span>' : ''}
                        </div>
                        <div class="pc-info">
                            <div class="pc-title">${p.name}</div>
                            <div class="pc-price">
                                ${p.isOffer ? `<s>R$${p.price.toFixed(2)}</s>` : ''}
                                R$ ${price.toFixed(2).replace('.',',')}
                            </div>
                        </div>
                        <div class="pc-action">
                            ${actionBtn}
                        </div>
                    </div>
                `;
            },

            refreshActiveGrids(pid) {
                // Atualiza cards existentes na tela sem recriar o grid todo
                const product = this.data.find(x => x.id === pid);
                if (!product) return;
                
                const cards = document.querySelectorAll(`.prod-card[data-pid="${pid}"]`);
                cards.forEach(card => {
                    card.outerHTML = this.getProductCardHTML(product);
                });
            },

            // --- CHECKOUT ---
            openCart() {
                const modal = document.getElementById('modal-cart');
                const list = document.getElementById('cart-items');
                
                if (Object.keys(this.cart).length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Sua cesta est√° vazia.</p>';
                } else {
                    list.innerHTML = Object.keys(this.cart).map(id => {
                        const p = this.data.find(x => x.id === id);
                        if(!p) return '';
                        const price = p.isOffer ? p.offerPrice : p.price;
                        return `
                            <div class="cart-item">
                                <div>
                                    <strong>${this.cart[id]}x</strong> ${p.name}
                                </div>
                                <div>R$ ${(price * this.cart[id]).toFixed(2).replace('.',',')}</div>
                            </div>
                        `;
                    }).join('');
                }
                modal.showModal();
            },

            directOrder(basketId) {
                const b = this.data.find(x => x.id === basketId);
                const msg = `Ol√°! Gostaria de pedir a *${b.name}* (Padr√£o) por R$ ${b.price.toFixed(2).replace('.',',')}`;
                window.open(`https://api.whatsapp.com/send?phone=5565996813588&text=${encodeURIComponent(msg)}`, '_blank');
            },

            checkout() {
                const { total } = this.getCartMetrics();
                const payMethod = document.getElementById('pay-method').value;
                
                let msg = `*PEDIDO DONA ANT√îNIA* üõí\n\n`;
                msg += `*ITENS:*\n`;
                
                for (let id in this.cart) {
                    const p = this.data.find(x => x.id === id);
                    if(p) msg += `‚ñ™ ${this.cart[id]}x ${p.name}\n`;
                }
                
                msg += `\n*TOTAL: R$ ${total.toFixed(2).replace('.',',')}*\n`;
                msg += `Pagamento: ${payMethod}\n`;
                msg += `(Cliente aguardando confirma√ß√£o)`;

                window.open(`https://api.whatsapp.com/send?phone=5565996813588&text=${encodeURIComponent(msg)}`, '_blank');
            }
        };

        // Atalho global
        const App = DonaAntoniaApp;
        window.onload = () => App.init();

    </script>
</body>
</html>
