<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA V3 | Enterprise Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #1e293b; }
        .view-content { display: none !important; }
        .view-content.active { display: flex !important; }
        .nav-link.active { background: #2563eb; color: white; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Visualizador de Cupom Lateral */
        #print-area:not(:empty) {
            position: fixed;
            top: 0; right: 0;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -10px 0 30px rgba(0,0,0,0.15);
            z-index: 100;
            overflow-y: auto;
            padding: 20px;
            display: block;
            border-left: 4px solid #2563eb;
        }

        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { 
                position: absolute; left: 0; top: 0; width: 100%; 
                padding: 0; margin: 0; box-shadow: none; border: none;
            }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-slate-900 flex flex-col p-4 gap-2 no-print flex-shrink-0">
        <div class="flex items-center gap-3 px-2 mb-8 text-white">
            <i class="fa-solid fa-rocket text-blue-500 text-2xl"></i>
            <h1 class="font-bold tracking-tight uppercase text-sm">Enterprise Core</h1>
        </div>
        <nav class="flex-1 space-y-1">
            <button onclick="UI.switchView('cliente', this)" class="nav-link active w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-users w-5"></i> <span>Clientes</span>
            </button>
            <button onclick="UI.switchView('produto', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-box w-5"></i> <span>Produtos</span>
            </button>
            <button onclick="UI.switchView('venda', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-cart-shopping w-5"></i> <span>Vendas</span>
            </button>
            <button onclick="UI.switchView('crm', this)" class="nav-link w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-chart-line w-5"></i> <span>CRM</span>
            </button>
        </nav>
        <button onclick="ExportEngine.exportAll()" class="text-left px-4 py-2 text-slate-500 hover:text-emerald-400 text-xs transition">
            <i class="fa-solid fa-database mr-2"></i> Backup Geral (DB)
        </button>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="bg-white border-b border-slate-200 px-8 py-4 flex justify-between items-center no-print flex-shrink-0">
            <h2 id="view-title" class="text-xl font-bold text-slate-800 tracking-tight">Clientes</h2>
            <div class="h-8 w-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs uppercase">AD</div>
        </header>

        <!-- VIEW: CLIENTE -->
        <main id="view-cliente" class="view-content active flex-1 overflow-hidden p-6 gap-6">
            <section class="w-80 lg:w-96 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-shrink-0">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <span id="formLabel-cliente" class="text-[10px] font-bold text-blue-600 uppercase tracking-widest">Novo Cliente</span>
                    <button onclick="UI.resetForm('cliente')" class="text-[10px] text-slate-400 hover:text-red-500 font-bold">LIMPAR</button>
                </div>
                <form id="form-cliente" onsubmit="App.handleSave('cliente', event)" class="p-5 space-y-4 overflow-y-auto custom-scroll">
                    <input type="hidden" id="c-id">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="c-codigo" readonly placeholder="C0001" class="w-full bg-slate-100 border rounded-lg px-3 py-2 text-xs font-mono font-bold text-slate-500">
                        <select id="c-rota" required class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none font-bold text-blue-700">
                            <option value="">ROTA</option>
                            <option value="CX">CX</option>
                            <option value="VG">VG</option>
                            <option value="CBA">CBA</option>
                            <option value="CPA">CPA</option>
                        </select>
                    </div>
                    <input type="text" id="c-nome" required placeholder="Nome do Cliente" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="tel" id="c-tel" required placeholder="WhatsApp" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                        <input type="text" id="c-bairro" placeholder="Bairro" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                    </div>
                    <select id="c-cidade" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="Cuiabá">Cuiabá</option><option value="Várzea Grande">Várzea Grande</option>
                    </select>
                    <textarea id="c-endereco" rows="2" placeholder="Endereço Completo" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none"></textarea>
                    
                    <div class="space-y-1">
                        <label class="text-[9px] font-bold text-slate-400 uppercase ml-1">Dados de Busca Maps</label>
                        <input type="text" id="c-maps" placeholder="Cole coordenadas ou link aqui..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs outline-none focus:border-blue-400">
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg transition uppercase text-xs">Salvar Cliente</button>
                </form>
            </section>
            <section class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <input type="text" oninput="UI.filter('cliente', this.value)" placeholder="Filtrar clientes..." class="pl-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none w-64 focus:border-blue-500">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">TOTAL: <b id="count-cliente" class="text-slate-700">0</b></span>
                </div>
                <div class="flex-1 overflow-auto custom-scroll">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold sticky top-0 z-10">
                            <tr>
                                <th class="p-4">Cliente</th>
                                <th class="p-4">Local/Rota</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="table-cliente" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- VIEW: PRODUTO -->
        <main id="view-produto" class="view-content flex-1 overflow-hidden p-6 gap-6">
            <section class="w-96 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-shrink-0">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <span id="formLabel-produto" class="text-[10px] font-bold text-emerald-600 uppercase">Novo Produto</span>
                    <button onclick="UI.resetForm('produto')" class="text-[10px] text-slate-400 hover:text-red-500 font-bold">LIMPAR</button>
                </div>
                <form id="form-produto" onsubmit="App.handleSave('produto', event)" class="p-5 space-y-3 overflow-y-auto custom-scroll">
                    <input type="hidden" id="p-id">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="p-codigo" readonly placeholder="P001" class="bg-slate-100 border rounded-lg px-3 py-2 text-xs font-bold text-slate-500">
                        <input type="text" id="p-ean" placeholder="EAN" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-xs outline-none">
                    </div>
                    <input type="text" id="p-nome" required placeholder="Nome do Produto" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="p-ncm" placeholder="NCM" class="bg-slate-50 border rounded-lg px-3 py-2 text-xs">
                        <input type="text" id="p-categoria" placeholder="Categoria" class="bg-slate-50 border rounded-lg px-3 py-2 text-xs">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="p-custo" step="0.01" placeholder="Custo" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs">
                        <input type="number" id="p-valor" step="0.01" required placeholder="Venda" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs font-bold text-emerald-600">
                        <input type="number" id="p-estoque" required placeholder="Estoque" class="bg-slate-50 border rounded-lg px-2 py-2 text-xs font-bold">
                    </div>
                    <div class="flex items-center gap-2 px-1">
                        <input type="checkbox" id="p-isTemp" class="rounded border-slate-300" onchange="UI.updateNextProductCode(this.checked)">
                        <label for="p-isTemp" class="text-[11px] font-bold text-slate-500 uppercase tracking-tighter">Temporário (24h)</label>
                    </div>
                    <select id="p-tipo" onchange="UI.toggleKit(this.value)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none">
                        <option value="normal">Normal</option><option value="kit">Kit</option>
                    </select>
                    <div id="p-kit-area" class="hidden space-y-3">
                        <label class="text-[9px] font-bold text-slate-400 uppercase">Colar Lista (CÓDIGO | QUANTIDADE)</label>
                        <textarea id="p-kit-bulk" rows="2" class="w-full p-2 text-[10px] font-mono border rounded outline-none bg-slate-50" placeholder="P001 | 2"></textarea>
                        <div id="p-kit-list" class="max-h-32 overflow-y-auto custom-scroll space-y-1 bg-slate-50 p-2 rounded-lg border"></div>
                    </div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-xl shadow-lg transition text-xs uppercase">Salvar Produto</button>
                </form>
            </section>
            <section class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <input type="text" oninput="UI.filter('produto', this.value)" placeholder="Buscar..." class="pl-4 py-2 bg-white border border-slate-200 rounded-xl text-sm outline-none w-64 focus:border-blue-500">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">TOTAL: <b id="count-produto" class="text-slate-700">0</b></span>
                </div>
                <div class="flex-1 overflow-auto custom-scroll">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                            <tr><th class="p-4">Produto</th><th class="p-4">Estoque</th><th class="p-4">Preço</th><th class="p-4 text-right">Ações</th></tr>
                        </thead>
                        <tbody id="table-produto" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>

        <!-- VIEW: VENDAS -->
        <main id="view-venda" class="view-content flex-1 overflow-hidden p-6 gap-6">
            <section class="w-96 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col flex-shrink-0">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <span id="formLabel-venda" class="text-[10px] font-bold text-orange-600 uppercase">Novo Pedido</span>
                    <button onclick="UI.resetForm('venda')" class="text-[10px] text-slate-400 hover:text-red-500 font-bold">CANCELAR</button>
                </div>
                <form id="form-venda" onsubmit="App.handleSave('venda', event)" class="p-5 space-y-3 overflow-y-auto custom-scroll">
                    <input type="hidden" id="v-id">
                    <select id="v-cliente" required class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none"></select>
                    
                    <div class="space-y-2 bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div class="relative">
                            <i class="fa-solid fa-search absolute left-3 top-2.5 text-slate-400 text-[10px]"></i>
                            <input type="text" id="v-prod-search" oninput="UI.searchProduct(this.value)" placeholder="Buscar produto..." class="w-full pl-8 pr-3 py-2 text-xs border border-slate-200 rounded-lg outline-none focus:border-orange-400">
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <select id="v-produto" required class="col-span-3 bg-white border rounded-lg px-3 py-2 text-sm outline-none"></select>
                            <input type="number" id="v-qty" value="1" min="1" class="bg-white border rounded-lg px-3 py-2 text-sm outline-none font-bold">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <select id="v-pagamento" required class="bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none">
                            <option value="Dinheiro">Dinheiro</option><option value="Cartão">Cartão</option>
                            <option value="Pix">Pix</option><option value="Só Entregar">Só Entregar</option>
                        </select>
                        <select id="v-rota" required class="bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none">
                            <option value="CX">CX</option><option value="VF">VF</option>
                            <option value="CBA">CBA</option><option value="CPA">CPA</option>
                        </select>
                    </div>
                    <input type="number" id="v-desconto" step="0.01" placeholder="Desconto (R$)" class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none">
                    <textarea id="v-obs" rows="2" placeholder="Observações" class="w-full bg-slate-50 border rounded-lg px-3 py-2 text-sm outline-none"></textarea>
                    <div class="p-3 bg-slate-900 rounded-xl text-white flex justify-between items-center">
                        <span class="text-xs uppercase font-bold text-slate-400">Total Líquido</span>
                        <span id="v-total" class="text-xl font-bold">R$ 0,00</span>
                    </div>
                    <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-xl shadow-lg transition text-xs uppercase tracking-widest">Finalizar Pedido</button>
                </form>
            </section>
            
            <section class="flex-1 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <h3 class="text-xs font-bold uppercase text-slate-500 tracking-tighter">Histórico de Vendas</h3>
                        <div class="flex gap-2">
                            <button onclick="ExportEngine.exportSelectedSales()" class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-lg text-[10px] font-bold hover:bg-emerald-200 transition">
                                <i class="fa-solid fa-file-export mr-1"></i> Exportar Selecionados
                            </button>
                            <span class="text-[10px] font-bold text-slate-400 tracking-tighter uppercase self-center">TOTAL: <b id="count-venda" class="text-slate-700">0</b></span>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center no-print">
                        <input type="date" id="v-filter-start" class="text-[10px] p-1.5 border rounded outline-none focus:border-blue-400">
                        <span class="text-[10px] text-slate-400 uppercase font-bold">a</span>
                        <input type="date" id="v-filter-end" class="text-[10px] p-1.5 border rounded outline-none focus:border-blue-400">
                        <button onclick="UI.render('venda')" class="bg-slate-200 hover:bg-slate-300 text-[10px] font-bold px-3 py-1.5 rounded transition uppercase">Filtrar</button>
                    </div>
                </div>
                <div class="flex-1 overflow-auto custom-scroll">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold sticky top-0">
                            <tr>
                                <th class="p-4 w-10"><input type="checkbox" onclick="UI.toggleSelectAllSales(this)"></th>
                                <th class="p-4">Pedido</th>
                                <th class="p-4">Financeiro</th>
                                <th class="p-4 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="table-venda" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>
        </main>
        
        <!-- CRM -->
        <main id="view-crm" class="view-content flex-1 overflow-auto p-6 flex flex-col gap-6">
            <section class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex items-center justify-between flex-shrink-0 no-print">
                <div>
                    <h3 class="text-sm font-bold text-slate-700 uppercase tracking-widest leading-none">Dashboard Analytics</h3>
                    <p class="text-[10px] text-slate-400 mt-1 uppercase">Monitoramento de Performance</p>
                </div>
                <div class="flex gap-2 items-center">
                    <input type="date" id="crm-filter-start" class="text-[10px] p-2 border rounded-lg outline-none">
                    <button onclick="UI.renderCRM()" class="bg-blue-600 text-white text-[10px] font-bold px-4 py-2 rounded-lg hover:bg-blue-700 transition uppercase">Atualizar</button>
                </div>
            </section>
            <section class="grid grid-cols-4 gap-4 flex-shrink-0">
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Receita Bruta</span><h3 id="crm-total-rev" class="text-2xl font-black text-emerald-600 leading-tight">R$ 0,00</h3></div>
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Ticket Médio</span><h3 id="crm-avg-ticket" class="text-2xl font-black text-blue-600 leading-tight">R$ 0,00</h3></div>
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Pedidos</span><h3 id="crm-total-orders" class="text-2xl font-black text-slate-700 leading-tight">0</h3></div>
                <div class="bg-white p-5 rounded-2xl border"><span class="text-[10px] font-bold text-slate-400 uppercase">Clientes</span><h3 id="crm-active-clients" class="text-2xl font-black text-orange-500 leading-tight">0</h3></div>
            </section>
        </main>
    </div>

    <!-- ÁREA DE VISUALIZAÇÃO/IMPRESSÃO -->
    <div id="print-area"></div>

    <script>
        const storageAvailable = (type) => {
            try { var storage = window[type], x = '__storage_test__'; storage.setItem(x, x); storage.removeItem(x); return true; }
            catch (e) { return false; }
        };

        const DB = {
            key: 'enterprise_v5_db',
            load: () => {
                const defaults = {cliente:[], produto:[], venda:[], counters:{cliente:0, produto:0, prodTemp:0, venda:0, lastSaleDate: null}};
                if (!storageAvailable('localStorage')) return defaults;
                const data = JSON.parse(localStorage.getItem(DB.key) || JSON.stringify(defaults));
                if(!data.counters) data.counters = defaults.counters;
                return data;
            },
            saveAll: (data) => {
                if (storageAvailable('localStorage')) localStorage.setItem(DB.key, JSON.stringify(data));
            },
            // Calcula o PRÓXIMO código (Sem incrementar ainda) para exibição na UI
            peekNextCode: (type, options = {}) => {
                const db = DB.load();
                const today = new Date().toLocaleDateString('pt-BR');
                if(type === 'cliente') return `C${String(db.counters.cliente + 1).padStart(4, '0')}`;
                if(type === 'produto') {
                    const count = options.isTemp ? db.counters.prodTemp + 1 : db.counters.produto + 1;
                    const pref = options.isTemp ? 'PT' : 'P';
                    return `${pref}${String(count).padStart(3, '0')}`;
                }
                if(type === 'venda') {
                    const count = (db.counters.lastSaleDate !== today) ? 1 : db.counters.venda + 1;
                    return `V${String(count).padStart(3, '0')}`;
                }
                return "";
            },
            // Gera e INCREMENTA o contador de fato
            consumeCode: (type, options = {}) => {
                const db = DB.load();
                let code = "";
                const today = new Date().toLocaleDateString('pt-BR');

                if(type === 'cliente') { 
                    db.counters.cliente++; 
                    code = `C${String(db.counters.cliente).padStart(4, '0')}`; 
                }
                else if(type === 'produto') {
                    if(options.isTemp) { 
                        db.counters.prodTemp++; 
                        code = `PT${String(db.counters.prodTemp).padStart(3, '0')}`; 
                    } else { 
                        db.counters.produto++; 
                        code = `P${String(db.counters.produto).padStart(3, '0')}`; 
                    }
                }
                else if(type === 'venda') {
                    if(db.counters.lastSaleDate !== today) {
                        db.counters.venda = 0;
                        db.counters.lastSaleDate = today;
                    }
                    db.counters.venda++; 
                    code = `V${String(db.counters.venda).padStart(3, '0')}`; 
                }
                DB.saveAll(db);
                return code;
            },
            save: (type, obj) => {
                const db = DB.load();
                const idx = db[type].findIndex(i => i.id === obj.id);
                if (idx !== -1) { 
                    db[type][idx] = obj; 
                } else {
                    if(!obj.id) obj.id = Date.now().toString();
                    // Se não tiver código (novo cadastro), gera agora
                    if(!obj.codigo) obj.codigo = DB.consumeCode(type, {isTemp: obj.isTemp});
                    db[type].push(obj);
                }
                DB.saveAll(db);
            },
            delete: (type, id) => { const db = DB.load(); db[type] = db[type].filter(i => i.id !== id); DB.saveAll(db); }
        };

        const UI = {
            get: (id) => document.getElementById(id),
            switchView: (view, btn) => {
                document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                UI.get(`view-${view}`).classList.add('active');
                if(btn) btn.classList.add('active');
                UI.get('view-title').innerText = view.charAt(0).toUpperCase() + view.slice(1);
                if(view === 'venda') UI.renderVendaOptions();
                if(view === 'produto') UI.renderKitOptions();
                if(view === 'crm') UI.renderCRM();
                UI.render(view);
                UI.resetForm(view);
            },
            toggleKit: (val) => UI.get('p-kit-area').classList.toggle('hidden', val !== 'kit'),
            renderKitOptions: () => {
                const prods = DB.load().produto.filter(p => p.tipo !== 'kit');
                UI.get('p-kit-list').innerHTML = prods.map(p => `<div class="flex items-center gap-2 p-1 text-[10px]"><input type="checkbox" data-pid="${p.id}" class="kit-check"><span class="flex-1 font-bold">${p.codigo} - ${p.nome}</span><input type="number" data-pid="${p.id}" value="1" class="kit-qty w-10 border rounded outline-none px-1 font-bold"></div>`).join('');
            },
            renderVendaOptions: (filter = '') => {
                const db = DB.load();
                UI.get('v-cliente').innerHTML = '<option value="">Selecionar Cliente</option>' + db.cliente.map(c => `<option value="${c.id}">${c.codigo} - ${c.nome}</option>`).join('');
                UI.get('v-produto').innerHTML = '<option value="">Selecionar Produto</option>' + db.produto
                    .filter(p => p.nome.toLowerCase().includes(filter.toLowerCase()) || p.codigo.toLowerCase().includes(filter.toLowerCase()))
                    .map(p => `<option value="${p.id}" data-price="${p.valor}">${p.codigo} - ${p.nome} (Est: ${p.estoque})</option>`).join('');
            },
            searchProduct: (val) => UI.renderVendaOptions(val),
            toggleSelectAllSales: (master) => {
                document.querySelectorAll('.venda-select').forEach(cb => cb.checked = master.checked);
            },
            render: (type) => {
                if(type === 'crm') return;
                const db = DB.load(); let data = db[type];
                if(type === 'venda') {
                    const s = UI.get('v-filter-start').value; const e = UI.get('v-filter-end').value;
                    if(s) data = data.filter(v => v.date >= new Date(s).getTime());
                    if(e) data = data.filter(v => v.date <= new Date(e).getTime() + 86399999);
                }
                UI.get(`count-${type}`).innerText = data.length;
                UI.get(`table-${type}`).innerHTML = data.map(i => {
                    if(type === 'cliente') {
                        const mapsBtn = i.maps ? `<button onclick="window.open('https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.maps)}', '_blank')" class="text-emerald-500 p-2" title="Abrir no Maps"><i class="fa-solid fa-map-location-dot text-xs"></i></button>` : '';
                        return `<tr class="hover:bg-slate-50 transition"><td class="p-4 font-bold text-xs">${i.codigo}-${i.nome}</td><td class="p-4 text-[10px] font-bold uppercase">${i.cidade}<br><span class="text-blue-600">ROTA: ${i.rota || '-'}</span></td><td class="p-4 text-right flex justify-end gap-1">${mapsBtn}<button onclick="App.edit('cliente','${i.id}')" class="text-blue-600 p-2"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.delete('cliente','${i.id}')" class="text-red-400 p-2"><i class="fa-solid fa-trash text-xs"></i></button></td></tr>`;
                    }
                    if(type === 'produto') {
                        const estColor = i.estoque <= 0 ? 'text-red-600' : 'text-slate-700';
                        return `<tr class="hover:bg-slate-50 transition"><td class="p-4 font-bold text-xs">${i.codigo}-${i.nome}</td><td class="p-4 font-black text-xs ${estColor}">${i.estoque} <span class="text-[8px] opacity-40">un</span></td><td class="p-4 text-[10px] font-bold text-emerald-600">R$ ${Number(i.valor).toFixed(2)}</td><td class="p-4 text-right flex justify-end gap-1"><button onclick="App.edit('produto','${i.id}')" class="text-blue-600 p-2"><i class="fa-solid fa-pen text-xs"></i></button><button onclick="App.delete('produto','${i.id}')" class="text-red-400 p-2"><i class="fa-solid fa-trash text-xs"></i></button></td></tr>`;
                    }
                    if(type === 'venda') {
                        const c = db.cliente.find(x => x.id === i.cliId); 
                        const p = db.produto.find(x => x.id === i.prodId);
                        return `<tr class="hover:bg-slate-50 text-[11px]">
                            <td class="p-4"><input type="checkbox" class="venda-select" data-id="${i.id}"></td>
                            <td class="p-4 font-bold">#${i.codigo} | ${c?.nome||'Excl'}</td>
                            <td class="p-4 font-bold text-emerald-700">R$ ${i.total.toFixed(2)}<br><span class="opacity-50 text-[9px] uppercase">${i.pag} | ${i.rota}</span></td>
                            <td class="p-4 text-right flex justify-end gap-1">
                                <button onclick="App.printVenda('${i.id}')" class="text-slate-500 p-2" title="Imprimir Comanda"><i class="fa-solid fa-print text-xs"></i></button>
                                <button onclick="App.delete('venda','${i.id}')" class="text-red-300 p-2" title="Excluir"><i class="fa-solid fa-times text-xs"></i></button>
                            </td></tr>`;
                    }
                }).join('');
            },
            renderCRM: () => {
                const db = DB.load();
                const totalRev = db.venda.reduce((acc, v) => acc + v.total, 0);
                UI.get('crm-total-rev').innerText = `R$ ${totalRev.toFixed(2)}`;
                UI.get('crm-avg-ticket').innerText = `R$ ${(totalRev / (db.venda.length || 1)).toFixed(2)}`;
                UI.get('crm-total-orders').innerText = db.venda.length;
                UI.get('crm-active-clients').innerText = [...new Set(db.venda.map(v => v.cliId))].length;
            },
            resetForm: (t) => {
                const form = UI.get(`form-${t}`);
                if(!form) return;
                form.reset();
                UI.get(`${t[0]}-id`).value = '';
                UI.get(`formLabel-${t}`).innerText = `Novo ${t}`;
                
                // Popula o código automaticamente ao abrir o formulário novo
                if(t === 'cliente') {
                    UI.get('c-codigo').value = DB.peekNextCode('cliente');
                } else if(t === 'produto') {
                    UI.get('p-isTemp').checked = false;
                    UI.get('p-codigo').value = DB.peekNextCode('produto', {isTemp: false});
                    UI.toggleKit('normal');
                } else if(t === 'venda') {
                    UI.get('v-total').innerText = 'R$ 0,00';
                    UI.renderVendaOptions();
                }
            },
            updateNextProductCode: (isTemp) => {
                UI.get('p-codigo').value = DB.peekNextCode('produto', {isTemp});
            },
            fillForm: (t, i) => {
                const p = t[0]; 
                UI.get(`${p}-id`).value = i.id; 
                UI.get(`${p}-codigo`).value = i.codigo;
                if(t === 'cliente') { 
                    UI.get('c-nome').value = i.nome; 
                    UI.get('c-tel').value = i.tel; 
                    UI.get('c-cidade').value = i.cidade; 
                    UI.get('c-bairro').value = i.bairro || ''; 
                    UI.get('c-endereco').value = i.endereco;
                    UI.get('c-rota').value = i.rota || '';
                    UI.get('c-maps').value = i.maps || '';
                }
                else if(t === 'produto') { 
                    UI.get('p-nome').value = i.nome; 
                    ['ean','ncm','categoria','custo','valor','estoque','tipo'].forEach(k => UI.get(`p-${k}`).value = i[k]); 
                    UI.get('p-isTemp').checked = !!i.isTemp; 
                    UI.toggleKit(i.tipo); 
                }
                UI.get(`formLabel-${t}`).innerText = `Editando ${t}`;
            }
        };

        const App = {
            init: () => {
                const db = DB.load();
                DB.saveAll(db); 
                UI.render('cliente');
                UI.resetForm('cliente');
                ['v-qty', 'v-desconto', 'v-produto'].forEach(id => {
                    const el = UI.get(id);
                    if(el) el.addEventListener('input', App.calcVenda);
                });
            },
            calcVenda: () => {
                const p = UI.get('v-produto'); const price = p.options[p.selectedIndex]?.dataset.price || 0;
                const total = (Number(price) * Number(UI.get('v-qty').value)) - Number(UI.get('v-desconto').value || 0);
                UI.get('v-total').innerText = `R$ ${Math.max(0, total).toFixed(2)}`;
            },
            handleSave: (t, e) => {
                e.preventDefault(); 
                const p = t[0];
                let objId = UI.get(`${p}-id`).value;
                let obj = { id: objId || null }; // null se for novo

                if(t !== 'venda') {
                    obj.nome = UI.get(`${p}-nome`).value;
                    // Se for edição, mantém o código atual. Se for novo, gera no DB.save.
                    if(objId) obj.codigo = UI.get(`${p}-codigo`).value;
                }
                
                if(t === 'cliente') {
                    Object.assign(obj, { tel: UI.get('c-tel').value, cidade: UI.get('c-cidade').value, bairro: UI.get('c-bairro').value, endereco: UI.get('c-endereco').value, rota: UI.get('c-rota').value, maps: UI.get('c-maps').value });
                }
                else if(t === 'produto') {
                    const isTemp = UI.get('p-isTemp').checked;
                    Object.assign(obj, { ean: UI.get('p-ean').value, ncm: UI.get('p-ncm').value, categoria: UI.get('p-categoria').value, custo: UI.get('p-custo').value, valor: UI.get('p-valor').value, estoque: Number(UI.get('p-estoque').value), tipo: UI.get('p-tipo').value, isTemp: isTemp });
                    if(obj.tipo === 'kit') {
                        let kitItems = Array.from(document.querySelectorAll('.kit-check:checked')).map(ck => ({ id: ck.dataset.pid, qty: Number(document.querySelector(`.kit-qty[data-pid="${ck.dataset.pid}"]`).value) }));
                        const bulkText = UI.get('p-kit-bulk').value.trim();
                        if(bulkText) {
                            bulkText.split('\n').forEach(line => {
                                const [code, qty] = line.split('|').map(s => s.trim());
                                const db = DB.load();
                                const found = db.produto.find(x => x.codigo === code);
                                if(found) kitItems.push({ id: found.id, qty: Number(qty) || 1 });
                            });
                        }
                        obj.items = kitItems;
                    }
                } else if(t === 'venda') {
                    const prodSelect = UI.get('v-produto');
                    const prodId = prodSelect.value;
                    const db = DB.load();
                    const prod = db.produto.find(x => x.id === prodId);
                    if(!prod) return alert('Produto não selecionado!');
                    Object.assign(obj, { cliId: UI.get('v-cliente').value, prodId: prod.id, qty: Number(UI.get('v-qty').value), pag: UI.get('v-pagamento').value, rota: UI.get('v-rota').value, total: (prod.valor * Number(UI.get('v-qty').value)) - Number(UI.get('v-desconto').value||0), date: Date.now(), obs: UI.get('v-obs').value });
                    
                    const deduct = (id, q) => {
                        const target = db.produto.find(x => x.id === id);
                        if(target) target.estoque -= q;
                    };
                    if(prod.tipo === 'kit' && prod.items) prod.items.forEach(ki => deduct(ki.id, ki.qty * obj.qty));
                    else deduct(prod.id, obj.qty);
                    DB.saveAll(db);
                }
                
                DB.save(t, obj); 
                UI.render(t);
                UI.resetForm(t);
            },
            printVenda: (id) => {
                const db = DB.load(); 
                const v = db.venda.find(x => x.id === id); 
                const c = db.cliente.find(x => x.id === v.cliId); 
                const p = db.produto.find(x => x.id === v.prodId);
                let kitHtml = ""; 
                if(p && p.tipo === 'kit' && p.items) {
                    kitHtml = `<div style="border-top:1px dashed #000; padding-top:5px; margin-top:5px; font-size:11px;"><b>SEPARAÇÃO (Kits):</b><br>` + 
                        p.items.map(ki => {
                            const sub = db.produto.find(x => x.id === ki.id);
                            return `• ${ki.qty * v.qty}x ${sub?.nome || 'Item Excl'}`;
                        }).join('<br>') + `</div>`;
                }
                UI.get('print-area').innerHTML = `
                    <div class="no-print" style="margin-bottom: 20px; text-align: right;">
                        <button onclick="UI.get('print-area').innerHTML=''" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg text-xs transition uppercase">Fechar Visualização</button>
                    </div>
                    <div style="font-family:monospace; width: 100%; max-width: 320px; padding: 10px; border: 1px solid #eee;">
                        <center>
                            <h1 style="font-size: 24px; margin-bottom: 2px;">PEDIDO #${v.codigo}</h1>
                            <div style="background:#000; color:#fff; padding:10px 0; margin-top:5px; font-size: 38px; font-weight: 900; line-height: 1;">ROTA: ${v.rota}</div>
                        </center>
                        <br>
                        <div style="font-size: 14px; border-bottom: 1px solid #000; padding-bottom: 5px;">
                            <b>CLI:</b> [${c?.codigo || 'N/A'}] - ${c?.nome || 'N/A'}<br>
                            <b>TEL:</b> ${c?.tel || 'N/A'}
                        </div>
                        <div style="margin-top: 5px; font-size: 12px;">
                            <b>CID/BAIRRO:</b> ${c?.cidade || '-'}/${c?.bairro || '-'}<br>
                            <b>ENDEREÇO:</b> ${c?.endereco || '-'}
                        </div>
                        <hr style="border:1px solid #000;margin:10px 0">
                        <div style="font-size:16px;"><b>${v.qty}x ${p?.nome}</b></div>
                        ${kitHtml}
                        <hr style="border:1px solid #000;margin:10px 0">
                        <b>FORMA PGTO:</b> <span style="font-size: 16px;">${v.pag.toUpperCase()}</span><br>
                        <div style="font-size:22px; text-align:right; margin-top: 5px;"><b>TOTAL: R$ ${v.total.toFixed(2)}</b></div>
                        <br><b>OBS:</b> ${v.obs || '-'}<br>
                        <center style="font-size: 10px; margin-top: 20px;">
                            ENTERPRISE CORE - LOGÍSTICA<br>
                            Emissão: ${new Date().toLocaleString('pt-BR')}
                        </center>
                    </div>`;
                window.print();
            },
            edit: (t, id) => { const i = DB.load()[t].find(x => x.id === id); if(i) UI.fillForm(t, i); },
            delete: (t, id) => { if(confirm('Excluir definitivamente?')) { DB.delete(t, id); UI.render(t); } }
        };

        const ExportEngine = {
            exportAll: () => { 
                const a = Object.assign(document.createElement('a'), { 
                    href: URL.createObjectURL(new Blob([JSON.stringify(DB.load())], {type: 'application/json'})), 
                    download: `backup_completo_${Date.now()}.json` 
                }); 
                a.click(); 
            },
            exportSelectedSales: () => {
                const db = DB.load();
                const selectedIds = Array.from(document.querySelectorAll('.venda-select:checked')).map(cb => cb.dataset.id);
                if(!selectedIds.length) return alert('Selecione ao menos uma venda!');
                const report = selectedIds.map(id => {
                    const venda = db.venda.find(v => v.id === id);
                    const cliente = db.cliente.find(c => c.id === venda.cliId);
                    const produto = db.produto.find(p => p.id === venda.prodId);
                    return { ...venda, detalhes_cliente: cliente || "Cliente excluído", detalhes_produto: produto || "Produto excluído" };
                });
                const a = Object.assign(document.createElement('a'), { 
                    href: URL.createObjectURL(new Blob([JSON.stringify(report, null, 2)], {type: 'application/json'})), 
                    download: `relatorio_vendas_${Date.now()}.json` 
                }); 
                a.click();
            }
        };
        window.onload = App.init;
    </script>
</body>
</html>
